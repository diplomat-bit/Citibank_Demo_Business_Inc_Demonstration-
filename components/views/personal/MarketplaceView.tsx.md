# The Agora

This is the Agora. Not a store of goods, but a curated reality of potential tools and alliances. Each item presented is a reflection of your own trajectory, a possibility unearthed by the AI Co-Pilot from the patterns of your life. To enter the marketplace is to be shown not what you might want, but what your journey might require next.

---

### A Fable for the Builder: The Curator

(A traditional marketplace is a noisy, chaotic place. A thousand merchants shouting, each claiming their wares are what you need. It is a game of persuasion, not of truth. We wanted to build a different kind of marketplace. A quiet, thoughtful space. This is the Agora, and its only merchant is a curator who works for you.)

(The AI, Plato, is that curator. It has no wares of its own to sell. Its only goal is to understand you so deeply that it can show you the tools you might need for the next leg of your journey. Its core logic is 'Trajectory-Based Curation.')

(It begins by reading your history, your `transactions`. It sees you have been spending on art supplies, on books about design. It understands that you are on a creative path. It then scours the universe of possible products and services, not for what is popular, not for what is profitable, but for what resonates with the path you are already on. It looks for the tools that a creator might need.)

(The `aiJustification` is the heart of this process. It is the curator, Plato, explaining its reasoning. It is not a sales pitch. It is a quiet conversation. "Because you have shown an interest in visual arts, you might find this high-resolution digital canvas valuable for your work." It is a suggestion born of listening.)

(This turns the act of commerce on its head. It is no longer about being sold to. It is about being understood. The products that appear here are not advertisements. They are possibilities. Echoes of your own expressed interests, reflected back to you in the form of tools that might help you on your way. It is a marketplace where every item on display is, in a sense, a piece of your own unfolding story.)

---
import React, { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext, useReducer, FC, ReactNode, CSSProperties } from 'react';
import { a as animated, useSpring, useTransition } from '@react-spring/web';

//================================================================================================
// 1. TYPE DEFINITIONS & ENUMS
// Defining the data structures for our entire marketplace ecosystem.
//================================================================================================

export type UUID = string;

export enum Currency {
  USD = 'USD',
  EUR = 'EUR',
  GBP = 'GBP',
  JPY = 'JPY',
  ETH = 'ETH',
}

export enum ItemType {
  PhysicalGood = 'PHYSICAL_GOOD',
  DigitalSoftware = 'DIGITAL_SOFTWARE',
  Service = 'SERVICE',
  Subscription = 'SUBSCRIPTION',
  Educational = 'EDUCATIONAL',
  CommunityAccess = 'COMMUNITY_ACCESS',
}

export enum TrajectoryType {
  Creative = 'CREATIVE',
  Entrepreneurial = 'ENTREPRENEURIAL',
  Wellness = 'WELLNESS',
  Technical = 'TECHNICAL',
  Academic = 'ACADEMIC',
  Social = 'SOCIAL',
}

export interface Price {
  amount: number;
  currency: Currency;
  isRecurring: boolean;
  recurringInterval?: 'monthly' | 'yearly';
}

export interface Vendor {
  id: UUID;
  name: string;
  logoUrl: string;
  rating: number; // 1-5 scale
  bio: string;
}

export interface AIJustification {
  short: string;
  detailed: string;
  basedOn: string[]; // e.g., ["Transaction history", "Recent project 'Odyssey'", "Stated interest in 'philosophy'"]
  confidenceScore: number; // 0-1
}

export interface Review {
  id: UUID;
  author: string;
  rating: number; // 1-5 scale
  comment: string;
  createdAt: string; // ISO 8601
}

export interface MarketplaceItem {
  id: UUID;
  name: string;
  tagline: string;
  description: string;
  imageUrl: string;
  type: ItemType;
  category: string;
  tags: string[];
  price: Price;
  vendor: Vendor;
  aiJustification: AIJustification;
  userReviews: Review[];
  relatedItems: UUID[];
  stock?: number;
  isFeatured: boolean;
  relevanceScore: number; // Calculated by AI for sorting
}

export interface UserTransaction {
  id: UUID;
  date: string; // ISO 8601
  description: string;
  amount: number;
  currency: Currency;
  category: string;
}

export interface UserProject {
  id: UUID;
  name: string;
  description: string;
  relatedTransactions: UUID[];
  startDate: string; // ISO 8601
}

export interface UserTrajectory {
  primaryType: TrajectoryType;
  secondaryTypes: TrajectoryType[];
  narrative: string; // A short story about the user's path, generated by the AI
  confidence: number; // 0-1
  evidence: string[];
}

export interface UserProfile {
  id: UUID;
  name: string;
  email: string;
  avatarUrl: string;
  joinedDate: string; // ISO 8601
  transactions: UserTransaction[];
  projects: UserProject[];
}

export interface CurationSettings {
  allowTransactionAnalysis: boolean;
  allowProjectAnalysis: boolean;
  preferredItemTypes: ItemType[];
  excludedTags: string[];
  curationAggressiveness: 'conservative' | 'balanced' | 'exploratory';
}

export type SortOption = 'relevance' | 'price_asc' | 'price_desc' | 'newest' | 'rating';

export interface FilterState {
  searchQuery: string;
  categories: Set<string>;
  itemTypes: Set<ItemType>;
  priceRange: [number, number];
  showFeaturedOnly: boolean;
}

export type MarketplaceState = {
  isLoading: boolean;
  error: Error | null;
  items: MarketplaceItem[];
  filteredItems: MarketplaceItem[];
  userProfile: UserProfile | null;
  userTrajectory: UserTrajectory | null;
  curationSettings: CurationSettings;
  filters: FilterState;
  sortBy: SortOption;
  selectedItemId: UUID | null;
  isDetailViewOpen: boolean;
  isPlatoConsultationOpen: boolean;
};

export type MarketplaceAction =
  | { type: 'FETCH_START' }
  | { type: 'FETCH_SUCCESS'; payload: { items: MarketplaceItem[]; userProfile: UserProfile; userTrajectory: UserTrajectory; } }
  | { type: 'FETCH_ERROR'; payload: Error }
  | { type: 'SET_FILTERS'; payload: Partial<FilterState> }
  | { type: 'SET_SORT'; payload: SortOption }
  | { type: 'SELECT_ITEM'; payload: UUID | null }
  | { type: 'OPEN_PLATO_CONSULTATION' }
  | { type: 'CLOSE_MODALS' }
  | { type: 'UPDATE_CURATION_SETTINGS'; payload: Partial<CurationSettings> }
  | { type: 'SUBMIT_FEEDBACK'; payload: { itemId: UUID; feedback: 'helpful' | 'not_relevant' } };

//================================================================================================
// 2. MOCK DATA & API SERVICE LAYER
// Simulating a real-world backend to provide data for the Agora.
//================================================================================================

const MOCK_DB_DELAY = 800; // Simulate network latency

const generateUUID = (): UUID => crypto.randomUUID();

const createMockVendor = (name: string, logo: string, bio: string): Vendor => ({
  id: generateUUID(),
  name,
  logoUrl: `https://cdn.example.com/logos/${logo}.svg`,
  rating: 4.5 + Math.random() * 0.5,
  bio,
});

const VENDORS = {
  artisanInk: createMockVendor('Artisan Ink', 'artisan-ink', 'Creators of fine digital and physical art tools.'),
  codeWeavers: createMockVendor('CodeWeavers', 'codeweavers', 'Building the next generation of development software.'),
  mindfulFlow: createMockVendor('Mindful Flow', 'mindfulflow', 'Guiding you towards a balanced life with tools for wellness.'),
  symposium: createMockVendor('Symposium', 'symposium', 'A collective for deep learning and knowledge sharing.'),
};

const createMockReview = (author: string, rating: number, comment: string): Review => ({
  id: generateUUID(),
  author,
  rating,
  comment,
  createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
});

const createMockItem = (
  name: string,
  tagline: string,
  type: ItemType,
  category: string,
  price: Price,
  vendor: Vendor,
  imageUrl: string,
  tags: string[] = []
): MarketplaceItem => ({
  id: generateUUID(),
  name,
  tagline,
  description: 'This is a detailed description that would elaborate on the product\'s features, benefits, and specifications. It is designed to give the user a complete understanding of what they are considering, allowing for an informed decision based on their curated trajectory. '.repeat(5),
  imageUrl: `https://cdn.example.com/products/${imageUrl}.jpg`,
  type,
  category,
  tags: [category.toLowerCase(), ...tags],
  price,
  vendor,
  aiJustification: {
    short: 'Based on your recent activities, this seems like a logical next step.',
    detailed: 'Our analysis of your project \'Odyssey\' and recent transactions related to digital art suggests a deep dive into high-fidelity illustration. This tool, known for its powerful brush engine and non-destructive workflow, directly aligns with the techniques you appear to be exploring. It could significantly accelerate your progress on the path of a digital artist.',
    basedOn: ['Project \'Odyssey\'', 'Transactions in \'Art Supplies\''],
    confidenceScore: 0.92,
  },
  userReviews: [
    createMockReview('Alex', 5, 'Absolutely changed my workflow for the better!'),
    createMockReview('Sam', 4, 'Great product, though there is a bit of a learning curve.'),
  ],
  relatedItems: [],
  isFeatured: Math.random() > 0.8,
  relevanceScore: Math.random(),
});

const MOCK_ITEMS: MarketplaceItem[] = [
  createMockItem('Visionary Pro Canvas', 'The ultimate digital drawing tablet.', ItemType.PhysicalGood, 'Digital Art', { amount: 799, currency: Currency.USD, isRecurring: false }, VENDORS.artisanInk, 'tablet_pro', ['drawing', 'illustration']),
  createMockItem('CodeScribe AI', 'Your AI-powered pair programmer.', ItemType.DigitalSoftware, 'Development', { amount: 20, currency: Currency.USD, isRecurring: true, recurringInterval: 'monthly' }, VENDORS.codeWeavers, 'codescribe_ai', ['ai', 'coding', 'productivity']),
  createMockItem('Zenith Meditation Pod', 'A subscription to guided mindfulness.', ItemType.Service, 'Wellness', { amount: 15, currency: Currency.USD, isRecurring: true, recurringInterval: 'monthly' }, VENDORS.mindfulFlow, 'zenith_pod', ['meditation', 'mental health']),
  createMockItem('The Philosophy of Systems', 'Deep-dive course on complex systems.', ItemType.Educational, 'Learning', { amount: 250, currency: Currency.USD, isRecurring: false }, VENDORS.symposium, 'systems_course', ['philosophy', 'thinking models']),
  createMockItem('Creator\'s Guild Access', 'Join a private community of artists.', ItemType.CommunityAccess, 'Community', { amount: 49, currency: Currency.USD, isRecurring: true, recurringInterval: 'yearly' }, VENDORS.artisanInk, 'creators_guild', ['networking', 'art']),
  createMockItem('Quantum IDE', 'Next-gen integrated development environment.', ItemType.DigitalSoftware, 'Development', { amount: 120, currency: Currency.USD, isRecurring: false }, VENDORS.codeWeavers, 'quantum_ide', ['software', 'development']),
  createMockItem('BioHarmonize Tracker', 'Wearable for deep wellness analytics.', ItemType.PhysicalGood, 'Wellness', { amount: 299, currency: Currency.USD, isRecurring: false }, VENDORS.mindfulFlow, 'bio_tracker', ['health', 'quantified self']),
  createMockItem('Socratic Dialogues Course', 'Master the art of critical thinking.', ItemType.Educational, 'Learning', { amount: 150, currency: Currency.USD, isRecurring: false }, VENDORS.symposium, 'socratic_course', ['philosophy', 'communication']),
];

// Populate related items
MOCK_ITEMS.forEach(item => {
  item.relatedItems = MOCK_ITEMS
    .filter(other => other.id !== item.id && other.category === item.category)
    .map(other => other.id)
    .slice(0, 2);
});

const MOCK_USER_PROFILE: UserProfile = {
  id: 'user-001',
  name: 'Alexandria',
  email: 'alex@example.com',
  avatarUrl: 'https://cdn.example.com/avatars/alex.png',
  joinedDate: new Date('2022-01-15T09:30:00Z').toISOString(),
  transactions: [
    { id: generateUUID(), date: new Date().toISOString(), description: 'Artisan Ink Supplies', amount: 85, currency: Currency.USD, category: 'Art Supplies' },
    { id: generateUUID(), date: new Date().toISOString(), description: 'Symposium: Design Theory', amount: 120, currency: Currency.USD, category: 'Education' },
  ],
  projects: [
    { id: 'proj-odyssey', name: 'Odyssey', description: 'A series of digital illustrations exploring ancient myths.', relatedTransactions: [], startDate: new Date('2023-05-01T10:00:00Z').toISOString() }
  ],
};

const MOCK_USER_TRAJECTORY: UserTrajectory = {
  primaryType: TrajectoryType.Creative,
  secondaryTypes: [TrajectoryType.Academic],
  narrative: 'You are on the path of a modern storyteller, blending classical themes with digital artistry. Your journey is about mastering new mediums to express timeless ideas.',
  confidence: 0.88,
  evidence: ['Purchase history of art supplies', 'Enrollment in design theory courses', 'Active project \'Odyssey\' focusing on mythology'],
};

export class MockApiService {
  static async fetchMarketplaceData(userId: UUID): Promise<{ items: MarketplaceItem[]; userProfile: UserProfile; userTrajectory: UserTrajectory; }> {
    console.log(`Fetching all marketplace data for user ${userId}...`);
    return new Promise(resolve => {
      setTimeout(() => {
        // In a real app, the items would be dynamically curated on the backend based on the user's trajectory.
        // Here, we just return the full mock set and simulate the relevance score.
        const personalizedItems = MOCK_ITEMS.map(item => ({
          ...item,
          relevanceScore: this.calculateRelevance(item, MOCK_USER_TRAJECTORY),
        })).sort((a, b) => b.relevanceScore - a.relevanceScore);
        
        resolve({
          items: personalizedItems,
          userProfile: MOCK_USER_PROFILE,
          userTrajectory: MOCK_USER_TRAJECTORY,
        });
      }, MOCK_DB_DELAY);
    });
  }

  private static calculateRelevance(item: MarketplaceItem, trajectory: UserTrajectory): number {
    let score = 0.5; // Base score
    if(trajectory.primaryType === TrajectoryType.Creative && (item.category === 'Digital Art' || item.category === 'Community')) {
      score += 0.4;
    }
    if(trajectory.secondaryTypes.includes(TrajectoryType.Academic) && item.type === ItemType.Educational) {
      score += 0.3;
    }
    if (item.isFeatured) {
      score += 0.1;
    }
    return Math.min(1, score * (0.8 + Math.random() * 0.4)); // Add some randomness
  }

  static async submitFeedback(userId: UUID, itemId: UUID, feedback: 'helpful' | 'not_relevant'): Promise<{success: boolean}> {
     console.log(`User ${userId} submitted feedback for item ${itemId}: ${feedback}`);
     return new Promise(resolve => {
       setTimeout(() => {
         // Here, the backend would update the user's model based on this feedback.
         resolve({ success: true });
       }, 500);
     });
  }

  static async askPlato(userId: UUID, query: string): Promise<string> {
    console.log(`User ${userId} is consulting Plato with query: "${query}"`);
    return new Promise(resolve => {
      setTimeout(() => {
        const response = `Based on my understanding of your trajectory as a '${MOCK_USER_TRAJECTORY.primaryType.toLowerCase()}', and your question about "${query}", I would suggest focusing on tools that enhance collaboration. For example, have you considered the 'Creator's Guild Access'? It would connect you with peers who share your passion for digital art and mythology, potentially opening new avenues for your 'Odyssey' project.`;
        resolve(response);
      }, 1200);
    });
  }
}

//================================================================================================
// 3. STATE MANAGEMENT (Context & Reducer)
// Centralizing the logic for the marketplace state.
//================================================================================================

export const initialState: MarketplaceState = {
  isLoading: true,
  error: null,
  items: [],
  filteredItems: [],
  userProfile: null,
  userTrajectory: null,
  curationSettings: {
    allowTransactionAnalysis: true,
    allowProjectAnalysis: true,
    preferredItemTypes: [],
    excludedTags: [],
    curationAggressiveness: 'balanced',
  },
  filters: {
    searchQuery: '',
    categories: new Set(),
    itemTypes: new Set(),
    priceRange: [0, 1000],
    showFeaturedOnly: false,
  },
  sortBy: 'relevance',
  selectedItemId: null,
  isDetailViewOpen: false,
  isPlatoConsultationOpen: false,
};

export function marketplaceReducer(state: MarketplaceState, action: MarketplaceAction): MarketplaceState {
  switch (action.type) {
    case 'FETCH_START':
      return { ...state, isLoading: true, error: null };
    case 'FETCH_SUCCESS':
      return {
        ...state,
        isLoading: false,
        items: action.payload.items,
        filteredItems: action.payload.items, // Initially, all items are shown
        userProfile: action.payload.userProfile,
        userTrajectory: action.payload.userTrajectory,
      };
    case 'FETCH_ERROR':
      return { ...state, isLoading: false, error: action.payload };
    case 'SET_FILTERS': {
      const newFilters = { ...state.filters, ...action.payload };
      const filteredItems = applyFiltersAndSort(state.items, newFilters, state.sortBy);
      return { ...state, filters: newFilters, filteredItems };
    }
    case 'SET_SORT': {
      const newSortBy = action.payload;
      const filteredItems = applyFiltersAndSort(state.filteredItems, state.filters, newSortBy);
      return { ...state, sortBy: newSortBy, filteredItems };
    }
    case 'SELECT_ITEM':
      return { ...state, selectedItemId: action.payload, isDetailViewOpen: action.payload !== null };
    case 'OPEN_PLATO_CONSULTATION':
      return { ...state, isPlatoConsultationOpen: true };
    case 'CLOSE_MODALS':
      return { ...state, selectedItemId: null, isDetailViewOpen: false, isPlatoConsultationOpen: false };
    case 'UPDATE_CURATION_SETTINGS':
        return { ...state, curationSettings: { ...state.curationSettings, ...action.payload } };
    case 'SUBMIT_FEEDBACK':
      // Optimistically update or just log, backend handles logic
      console.log(`Feedback submitted for ${action.payload.itemId}: ${action.payload.feedback}`);
      return state; // No state change needed on frontend for this
    default:
      return state;
  }
}

export const MarketplaceContext = createContext<{
  state: MarketplaceState;
  dispatch: React.Dispatch<MarketplaceAction>;
} | undefined>(undefined);

export const useMarketplace = () => {
  const context = useContext(MarketplaceContext);
  if (!context) {
    throw new Error('useMarketplace must be used within a MarketplaceProvider');
  }
  return context;
};

//================================================================================================
// 4. UTILITY FUNCTIONS
// Helper functions for filtering, sorting, and formatting.
//================================================================================================

export function applyFiltersAndSort(items: MarketplaceItem[], filters: FilterState, sortBy: SortOption): MarketplaceItem[] {
  let result = items
    .filter(item => {
      // Search Query
      const query = filters.searchQuery.toLowerCase();
      if (query && !(item.name.toLowerCase().includes(query) || item.description.toLowerCase().includes(query) || item.tags.some(t => t.toLowerCase().includes(query)))) {
        return false;
      }
      // Categories
      if (filters.categories.size > 0 && !filters.categories.has(item.category)) {
        return false;
      }
      // Item Types
      if (filters.itemTypes.size > 0 && !filters.itemTypes.has(item.type)) {
        return false;
      }
      // Price Range
      if (item.price.amount < filters.priceRange[0] || item.price.amount > filters.priceRange[1]) {
        return false;
      }
      // Featured Only
      if (filters.showFeaturedOnly && !item.isFeatured) {
        return false;
      }
      return true;
    });

  // Sorting
  switch (sortBy) {
    case 'price_asc':
      result.sort((a, b) => a.price.amount - b.price.amount);
      break;
    case 'price_desc':
      result.sort((a, b) => b.price.amount - a.price.amount);
      break;
    case 'newest':
      // This would need a `createdAt` field on the item. We'll simulate it.
      result.sort((a, b) => b.id.localeCompare(a.id));
      break;
    case 'rating':
      result.sort((a, b) => (b.vendor.rating) - (a.vendor.rating));
      break;
    case 'relevance':
    default:
      result.sort((a, b) => b.relevanceScore - a.relevanceScore);
      break;
  }

  return result;
}

export const formatCurrency = (price: Price): string => {
  const formatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: price.currency,
  });
  let formatted = formatter.format(price.amount);
  if (price.isRecurring) {
    formatted += `/${price.recurringInterval === 'monthly' ? 'mo' : 'yr'}`;
  }
  return formatted;
};

//================================================================================================
// 5. UI COMPONENTS
// Building blocks for the Marketplace view, from small atoms to complex organisms.
//================================================================================================

// --- SVG Icons ---
export const IconSearch: FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
);

export const IconX: FC = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
);

export const IconThumbsUp: FC = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88Z"/></svg>
);
export const IconThumbsDown: FC = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a2 2 0 0 1-1.79-1.11L9 18.12Z"/></svg>
);

// --- Style Objects ---
export const STYLES = {
  // A mini design system
  pageContainer: { fontFamily: 'sans-serif', backgroundColor: '#f9f9f9', color: '#333', minHeight: '100vh' },
  header: { padding: '20px 40px', backgroundColor: 'white', borderBottom: '1px solid #eee', display: 'flex', justifyContent: 'space-between', alignItems: 'center' },
  headerTitle: { fontSize: '24px', fontWeight: 'bold' },
  mainContent: { padding: '40px', display: 'grid', gridTemplateColumns: '280px 1fr', gap: '40px' },
  sidebar: { backgroundColor: 'white', padding: '20px', borderRadius: '8px', border: '1px solid #eee', alignSelf: 'start' },
  itemGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '30px' },
  card: { backgroundColor: 'white', borderRadius: '8px', overflow: 'hidden', border: '1px solid #eee', cursor: 'pointer', transition: 'transform 0.2s ease, box-shadow 0.2s ease' },
  cardHover: { transform: 'translateY(-5px)', boxShadow: '0 10px 20px rgba(0,0,0,0.05)' },
  modalBackdrop: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.6)', display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: 1000 },
  modalContent: { backgroundColor: 'white', padding: '40px', borderRadius: '8px', width: '90%', maxWidth: '800px', maxHeight: '90vh', overflowY: 'auto' },
  button: { padding: '10px 20px', border: 'none', borderRadius: '6px', cursor: 'pointer', backgroundColor: '#333', color: 'white', fontSize: '16px' },
  input: { width: '100%', padding: '10px', border: '1px solid #ccc', borderRadius: '6px', fontSize: '16px' },
  h2: { marginTop: 0, marginBottom: '20px' },
  h3: { marginTop: '30px', marginBottom: '15px', borderBottom: '1px solid #eee', paddingBottom: '10px' },
};

// --- General Purpose Components ---
export const Spinner: FC = () => (
  <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '200px' }}>
    <style>{`
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `}</style>
    <div style={{
      border: '4px solid rgba(0, 0, 0, 0.1)',
      borderLeftColor: '#333',
      borderRadius: '50%',
      width: '40px',
      height: '40px',
      animation: 'spin 1s linear infinite',
    }} />
  </div>
);

export const TrajectoryVisualizer: FC<{ trajectory: UserTrajectory | null }> = ({ trajectory }) => {
  if (!trajectory) return null;

  const springProps = useSpring({ from: { opacity: 0, transform: 'scale(0.8)' }, to: { opacity: 1, transform: 'scale(1)' } });

  return (
    <animated.div style={{ ...springProps, padding: '20px', backgroundColor: '#eef2f5', borderRadius: '8px', marginBottom: '20px' }}>
      <h3 style={{ ...STYLES.h3, marginTop: 0 }}>Your Trajectory</h3>
      <p style={{ fontStyle: 'italic', fontSize: '18px', color: '#005a9c' }}>{trajectory.primaryType}</p>
      <p>{trajectory.narrative}</p>
      <div style={{ fontSize: '12px', color: '#666', marginTop: '10px' }}>
        <strong>Evidence:</strong> {trajectory.evidence.join(', ')}.
      </div>
    </animated.div>
  );
};

// --- Marketplace Specific Components ---
export const ItemCard: FC<{ item: MarketplaceItem; onSelect: (id: UUID) => void }> = ({ item, onSelect }) => {
  const [isHovered, setIsHovered] = useState(false);
  const springProps = useSpring({ transform: `scale(${isHovered ? 1.03 : 1})` });

  return (
    <animated.div
      style={{ ...STYLES.card, ...springProps }}
      onClick={() => onSelect(item.id)}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <img src={item.imageUrl} alt={item.name} style={{ width: '100%', height: '180px', objectFit: 'cover' }} />
      <div style={{ padding: '20px' }}>
        <h4 style={{ margin: '0 0 10px 0', fontSize: '18px' }}>{item.name}</h4>
        <p style={{ margin: '0 0 15px 0', fontSize: '14px', color: '#666' }}>{item.tagline}</p>
        <p style={{ margin: '0 0 15px 0', fontStyle: 'italic', fontSize: '13px', borderLeft: '3px solid #007acc', paddingLeft: '10px', color: '#555' }}>
          "{item.aiJustification.short}"
        </p>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <span style={{ fontWeight: 'bold', fontSize: '16px' }}>{formatCurrency(item.price)}</span>
          <span style={{ fontSize: '12px', color: '#666' }}>By {item.vendor.name}</span>
        </div>
      </div>
    </animated.div>
  );
};

export const ItemDetailModal: FC<{ item: MarketplaceItem | undefined; onClose: () => void; }> = ({ item, onClose }) => {
  const { dispatch } = useMarketplace();

  const handleFeedback = (feedback: 'helpful' | 'not_relevant') => {
    if(!item) return;
    MockApiService.submitFeedback('user-001', item.id, feedback);
    dispatch({type: 'SUBMIT_FEEDBACK', payload: { itemId: item.id, feedback }});
    // Maybe show a "thank you" message
  };

  const transitions = useTransition(item, {
    from: { opacity: 0, transform: 'scale(0.9)' },
    enter: { opacity: 1, transform: 'scale(1)' },
    leave: { opacity: 0, transform: 'scale(0.9)' },
  });

  return transitions((style, anItem) => anItem ? (
    <div style={STYLES.modalBackdrop} onClick={onClose}>
      <animated.div style={{ ...STYLES.modalContent, ...style }} onClick={e => e.stopPropagation()}>
        <button onClick={onClose} style={{ ...STYLES.button, position: 'absolute', top: '20px', right: '20px', background: 'none', color: '#333' }}><IconX /></button>
        <div style={{ display: 'grid', gridTemplateColumns: '300px 1fr', gap: '30px' }}>
          <div>
            <img src={anItem.imageUrl} alt={anItem.name} style={{ width: '100%', borderRadius: '8px' }} />
            <h2 style={{ ...STYLES.h2, fontSize: '28px', marginTop: '20px' }}>{anItem.name}</h2>
            <p style={{ fontSize: '18px', color: '#666' }}>{anItem.tagline}</p>
            <div style={{ fontSize: '24px', fontWeight: 'bold', margin: '20px 0' }}>{formatCurrency(anItem.price)}</div>
            <button style={{ ...STYLES.button, width: '100%', padding: '15px' }}>Acquire Tool</button>
          </div>
          <div>
            <div style={{ backgroundColor: '#f0f7ff', padding: '20px', borderRadius: '8px', border: '1px solid #cce4ff' }}>
              <h3 style={{ ...STYLES.h3, marginTop: 0 }}>Plato's Justification</h3>
              <p>{anItem.aiJustification.detailed}</p>
              <div style={{ fontSize: '12px', color: '#555', marginTop: '15px' }}>
                <strong>Based on:</strong> {anItem.aiJustification.basedOn.join(', ')}<br />
                <strong>Confidence:</strong> {Math.round(anItem.aiJustification.confidenceScore * 100)}%
              </div>
              <div style={{ marginTop: '20px', borderTop: '1px solid #cce4ff', paddingTop: '15px' }}>
                <p style={{ margin: 0, fontSize: '14px', fontWeight: 'bold' }}>Was this recommendation helpful?</p>
                <button onClick={() => handleFeedback('helpful')} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '5px', color: '#007acc'}}><IconThumbsUp/></button>
                <button onClick={() => handleFeedback('not_relevant')} style={{background: 'none', border: 'none', cursor: 'pointer', padding: '5px', color: '#888'}}><IconThumbsDown/></button>
              </div>
            </div>

            <h3 style={STYLES.h3}>Description</h3>
            <p>{anItem.description}</p>

            <h3 style={STYLES.h3}>From the Maker: {anItem.vendor.name}</h3>
            <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
              <img src={anItem.vendor.logoUrl} alt={anItem.vendor.name} style={{ width: '50px', height: '50px' }}/>
              <p>{anItem.vendor.bio}</p>
            </div>
            
            <h3 style={STYLES.h3}>Reviews</h3>
            {anItem.userReviews.map(review => (
                <div key={review.id} style={{ borderBottom: '1px solid #eee', paddingBottom: '10px', marginBottom: '10px' }}>
                    <strong>{review.author}</strong> - {'‚≠ê'.repeat(review.rating)}
                    <p style={{margin: '5px 0 0 0'}}>{review.comment}</p>
                </div>
            ))}
          </div>
        </div>
      </animated.div>
    </div>
  ) : null);
};

export const PlatoConsultationModal: FC<{ isOpen: boolean; onClose: () => void; }> = ({ isOpen, onClose }) => {
    const [query, setQuery] = useState('');
    const [history, setHistory] = useState<{q: string, a: string}[]>([]);
    const [isThinking, setIsThinking] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if(!query.trim() || isThinking) return;
        setIsThinking(true);
        const userQuery = query;
        setQuery('');
        const answer = await MockApiService.askPlato('user-001', userQuery);
        setHistory(prev => [...prev, { q: userQuery, a: answer }]);
        setIsThinking(false);
    };

    if (!isOpen) return null;

    return (
        <div style={STYLES.modalBackdrop} onClick={onClose}>
            <div style={{ ...STYLES.modalContent, maxWidth: '600px', display: 'flex', flexDirection: 'column' }} onClick={e => e.stopPropagation()}>
                <button onClick={onClose} style={{ ...STYLES.button, position: 'absolute', top: '20px', right: '20px', background: 'none', color: '#333' }}><IconX /></button>
                <h2 style={STYLES.h2}>Consult Plato</h2>
                <div style={{ flex: 1, overflowY: 'auto', marginBottom: '20px', paddingRight: '10px' }}>
                    {history.length === 0 && <p>You may ask for guidance. For example: "What should I learn next to improve my digital art?"</p>}
                    {history.map((entry, index) => (
                        <div key={index}>
                            <p style={{textAlign: 'right', fontWeight: 'bold'}}>You: {entry.q}</p>
                            <p style={{backgroundColor: '#f0f7ff', padding: '10px', borderRadius: '8px'}}>Plato: {entry.a}</p>
                        </div>
                    ))}
                    {isThinking && <Spinner />}
                </div>
                <form onSubmit={handleSubmit} style={{display: 'flex', gap: '10px'}}>
                    <input 
                        type="text" 
                        value={query} 
                        onChange={e => setQuery(e.target.value)} 
                        placeholder="Ask for a recommendation..."
                        style={STYLES.input}
                        disabled={isThinking}
                    />
                    <button type="submit" style={STYLES.button} disabled={isThinking}>Send</button>
                </form>
            </div>
        </div>
    );
};


export const Sidebar: FC = () => {
  const { state, dispatch } = useMarketplace();
  const { filters, items } = state;

  const categories = useMemo(() => {
    const catSet = new Set(items.map(i => i.category));
    return Array.from(catSet);
  }, [items]);
  
  const itemTypes = useMemo(() => {
    const typeSet = new Set(items.map(i => i.type));
    return Array.from(typeSet);
  }, [items]);

  const handleCategoryChange = (category: string) => {
    const newCategories = new Set(filters.categories);
    if (newCategories.has(category)) {
      newCategories.delete(category);
    } else {
      newCategories.add(category);
    }
    dispatch({ type: 'SET_FILTERS', payload: { categories: newCategories } });
  };
  
  const handleItemTypeChange = (type: ItemType) => {
    const newItemTypes = new Set(filters.itemTypes);
    if (newItemTypes.has(type)) {
      newItemTypes.delete(type);
    } else {
      newItemTypes.add(type);
    }
    dispatch({ type: 'SET_FILTERS', payload: { itemTypes: newItemTypes } });
  };

  return (
    <aside style={STYLES.sidebar}>
      <TrajectoryVisualizer trajectory={state.userTrajectory} />
      
      <h3 style={STYLES.h3}>Filter</h3>

      <div>
        <label>Category</label>
        {categories.map(cat => (
          <div key={cat}>
            <input type="checkbox" id={`cat-${cat}`} checked={filters.categories.has(cat)} onChange={() => handleCategoryChange(cat)} />
            <label htmlFor={`cat-${cat}`}>{cat}</label>
          </div>
        ))}
      </div>
      
      <div style={{marginTop: '20px'}}>
        <label>Item Type</label>
        {itemTypes.map(type => (
          <div key={type}>
            <input type="checkbox" id={`type-${type}`} checked={filters.itemTypes.has(type)} onChange={() => handleItemTypeChange(type)} />
            <label htmlFor={`type-${type}`}>{type.replace(/_/g, ' ').toLocaleLowerCase()}</label>
          </div>
        ))}
      </div>

      {/* More filters like price range could be added here */}
    </aside>
  );
};


//================================================================================================
// 6. MAIN VIEW COMPONENT
// The orchestrator that brings all the pieces together into the Agora.
//================================================================================================

export const MarketplaceViewContent: FC = () => {
  const { state, dispatch } = useMarketplace();
  const { isLoading, error, filteredItems, selectedItemId, items } = state;

  useEffect(() => {
    const fetchData = async () => {
      dispatch({ type: 'FETCH_START' });
      try {
        const data = await MockApiService.fetchMarketplaceData('user-001');
        dispatch({ type: 'FETCH_SUCCESS', payload: data });
      } catch (e) {
        dispatch({ type: 'FETCH_ERROR', payload: e as Error });
      }
    };
    fetchData();
  }, [dispatch]);

  const selectedItem = useMemo(() => items.find(item => item.id === selectedItemId), [items, selectedItemId]);
  
  const handleSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      dispatch({ type: 'SET_FILTERS', payload: { searchQuery: e.target.value } });
  };

  return (
    <div style={STYLES.pageContainer}>
      <header style={STYLES.header}>
        <div>
          <h1 style={STYLES.headerTitle}>The Agora</h1>
          <p style={{margin: 0, color: '#666'}}>A curated reality of potential, by Plato</p>
        </div>
        <div>
          <button style={{ ...STYLES.button, marginRight: '10px' }} onClick={() => dispatch({ type: 'OPEN_PLATO_CONSULTATION' })}>Consult Plato</button>
          <img src={state.userProfile?.avatarUrl} alt="User Avatar" style={{width: '40px', height: '40px', borderRadius: '50%'}} />
        </div>
      </header>
      
      <main style={STYLES.mainContent}>
        <Sidebar />
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
            <div style={{ position: 'relative', width: '50%' }}>
              <span style={{position: 'absolute', top: '50%', left: '10px', transform: 'translateY(-50%)', color: '#999'}}><IconSearch/></span>
              <input 
                type="text" 
                placeholder="Search for tools, services, ideas..." 
                value={state.filters.searchQuery}
                onChange={handleSearchChange}
                style={{...STYLES.input, paddingLeft: '40px'}} 
              />
            </div>
            <div>
              <label htmlFor="sort-by">Sort by: </label>
              <select 
                id="sort-by" 
                value={state.sortBy} 
                onChange={e => dispatch({type: 'SET_SORT', payload: e.target.value as SortOption})}
                style={{...STYLES.input, width: 'auto'}}
              >
                <option value="relevance">Relevance</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="price_desc">Price: High to Low</option>
                <option value="newest">Newest</option>
                <option value="rating">Highest Rated</option>
              </select>
            </div>
          </div>
          
          {isLoading && <Spinner />}
          {error && <p>There was an error loading the Agora: {error.message}</p>}
          {!isLoading && !error && (
            <div style={STYLES.itemGrid}>
              {filteredItems.map(item => (
                <ItemCard key={item.id} item={item} onSelect={() => dispatch({ type: 'SELECT_ITEM', payload: item.id })} />
              ))}
            </div>
          )}
          {filteredItems.length === 0 && !isLoading && <p>No items match your current filters.</p>}
        </div>
      </main>
      
      <ItemDetailModal item={selectedItem} onClose={() => dispatch({ type: 'CLOSE_MODALS' })} />
      <PlatoConsultationModal isOpen={state.isPlatoConsultationOpen} onClose={() => dispatch({ type: 'CLOSE_MODALS' })}/>
    </div>
  );
};

export const MarketplaceView: FC = () => {
    const [state, dispatch] = useReducer(marketplaceReducer, initialState);
  
    return (
      <MarketplaceContext.Provider value={{ state, dispatch }}>
        <MarketplaceViewContent />
      </MarketplaceContext.Provider>
    );
};

export default MarketplaceView;