import React, { useState, useEffect, useCallback } from 'react';
import {
  Box,
  Heading,
  Text,
  FormControl,
  FormLabel,
  Switch,
  VStack,
  HStack,
  Button,
  useToast,
  Spinner,
  Alert,
  AlertIcon,
  Collapse,
  IconButton,
  Tooltip,
} from '@chakra-ui/react';
import { ChevronDownIcon, ChevronUpIcon, SettingsIcon } from '@chakra-ui/icons';
import { useAuth } from '../../context/AuthContext'; // Assuming an AuthContext for user data
import {
  fetchNotificationSettings,
  updateNotificationSettings,
  NotificationSettings as NotificationSettingsType,
  NotificationChannel,
  NotificationCategory,
} from '../../services/notificationService'; // Assuming a notification service
import { useGeminiAIAssistant } from '../../hooks/useGeminiAIAssistant'; // For AI-powered suggestions

// Define default settings to ensure all categories and channels are represented
const defaultNotificationSettings: NotificationSettingsType = {
  email: {
    securityAlerts: true,
    transactionUpdates: true,
    marketingPromotions: true,
    systemUpdates: true,
    aiRecommendations: true,
    newFeatureAnnouncements: true,
    communityActivity: true,
    corporateReports: true,
  },
  push: {
    securityAlerts: true,
    transactionUpdates: true,
    marketingPromotions: false,
    systemUpdates: true,
    aiRecommendations: true,
    newFeatureAnnouncements: true,
    communityActivity: false,
    corporateReports: true,
  },
  sms: {
    securityAlerts: true,
    transactionUpdates: true,
    marketingPromotions: false,
    systemUpdates: false,
    aiRecommendations: false,
    newFeatureAnnouncements: false,
    communityActivity: false,
    corporateReports: false,
  },
};

const NotificationSettings: React.FC = () => {
  const { user } = useAuth();
  const toast = useToast();
  const [settings, setSettings] = useState<NotificationSettingsType>(defaultNotificationSettings);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [expandedCategories, setExpandedCategories] = useState<{ [key: string]: boolean }>({});

  const { generateAISuggestion, loading: aiLoading, error: aiError } = useGeminiAIAssistant();
  const [aiSuggestion, setAiSuggestion] = useState<string | null>(null);

  const notificationCategories: NotificationCategory[] = [
    'securityAlerts',
    'transactionUpdates',
    'marketingPromotions',
    'systemUpdates',
    'aiRecommendations',
    'newFeatureAnnouncements',
    'communityActivity',
    'corporateReports',
  ];

  const categoryLabels: Record<NotificationCategory, string> = {
    securityAlerts: 'Security Alerts',
    transactionUpdates: 'Transaction Updates',
    marketingPromotions: 'Marketing & Promotions',
    systemUpdates: 'System Updates & Maintenance',
    aiRecommendations: 'AI-Powered Recommendations',
    newFeatureAnnouncements: 'New Feature Announcements',
    communityActivity: 'Community & Social Activity',
    corporateReports: 'Corporate & Financial Reports',
  };

  const categoryDescriptions: Record<NotificationCategory, string> = {
    securityAlerts: 'Receive immediate alerts for suspicious activity, login attempts, or password changes.',
    transactionUpdates: 'Get real-time notifications for deposits, withdrawals, and payment confirmations.',
    marketingPromotions: 'Stay informed about our latest offers, discounts, and promotional campaigns.',
    systemUpdates: 'Important updates regarding service outages, new features, or planned maintenance.',
    aiRecommendations: 'Personalized insights and suggestions generated by our AI financial advisor.',
    newFeatureAnnouncements: 'Be the first to know about exciting new features and product enhancements.',
    communityActivity: 'Updates on community forums, events, or interactions related to your profile.',
    corporateReports: 'Receive summaries of quarterly earnings, annual reports, and other corporate communications.',
  };

  const notificationChannels: NotificationChannel[] = ['email', 'push', 'sms'];
  const channelLabels: Record<NotificationChannel, string> = {
    email: 'Email',
    push: 'Push Notifications',
    sms: 'SMS',
  };

  const fetchSettings = useCallback(async () => {
    if (!user?.userId) {
      setLoading(false);
      setError('User not authenticated.');
      return;
    }
    setLoading(true);
    setError(null);
    try {
      const fetchedSettings = await fetchNotificationSettings(user.userId);
      setSettings(fetchedSettings || defaultNotificationSettings);
      notificationCategories.forEach(category => {
        setExpandedCategories(prev => ({ ...prev, [category]: false }));
      });
    } catch (err) {
      setError('Failed to fetch notification settings. Please try again.');
      console.error('Error fetching notification settings:', err);
      setSettings(defaultNotificationSettings); // Fallback to defaults
    } finally {
      setLoading(false);
    }
  }, [user?.userId, notificationCategories]);

  useEffect(() => {
    fetchSettings();
  }, [fetchSettings]);

  const handleToggle = (
    channel: NotificationChannel,
    category: NotificationCategory,
    isChecked: boolean
  ) => {
    setSettings(prevSettings => ({
      ...prevSettings,
      [channel]: {
        ...prevSettings[channel],
        [category]: isChecked,
      },
    }));
  };

  const handleSave = async () => {
    if (!user?.userId) {
      toast({
        title: 'Authentication Error',
        description: 'You must be logged in to save settings.',
        status: 'error',
        duration: 5000,
        isClosable: true,
      });
      return;
    }

    setSaving(true);
    setError(null);
    try {
      await updateNotificationSettings(user.userId, settings);
      toast({
        title: 'Settings Saved',
        description: 'Your notification preferences have been updated.',
        status: 'success',
        duration: 3000,
        isClosable: true,
      });
    } catch (err) {
      setError('Failed to save notification settings. Please try again.');
      toast({
        title: 'Save Error',
        description: 'Failed to save notification settings. Please try again.',
        status: 'error',
        duration: 5000,
        isClosable: true,
      });
      console.error('Error saving notification settings:', err);
    } finally {
      setSaving(false);
    }
  };

  const toggleCategoryExpansion = (category: NotificationCategory) => {
    setExpandedCategories(prev => ({
      ...prev,
      [category]: !prev[category],
    }));
  };

  const requestAISuggestion = async () => {
    const prompt = `Based on the following user notification settings, provide a concise, actionable recommendation for optimizing their preferences. Focus on balancing important alerts with minimizing notification fatigue.
Current Settings: ${JSON.stringify(settings, null, 2)}
Suggest improvements for better user experience.`;
    const suggestion = await generateAISuggestion(prompt);
    if (suggestion) {
      setAiSuggestion(suggestion);
    }
  };

  if (loading) {
    return (
      <Box p={6} display="flex" justifyContent="center" alignItems="center" minHeight="200px">
        <Spinner size="xl" color="teal.500" />
        <Text ml={4}>Loading notification settings...</Text>
      </Box>
    );
  }

  return (
    <Box p={6} bg="white" borderRadius="lg" shadow="base" maxWidth="900px" mx="auto">
      <HStack justifyContent="space-between" mb={6}>
        <VStack align="flex-start" spacing={0}>
          <Heading as="h2" size="xl" color="teal.700">
            Notification Settings
          </Heading>
          <Text fontSize="md" color="gray.600">
            Manage how you receive updates and alerts for different activities.
          </Text>
        </VStack>
        <Tooltip label="Get AI-powered suggestions for your notification settings">
          <IconButton
            icon={<SettingsIcon />}
            aria-label="Get AI Suggestions"
            onClick={requestAISuggestion}
            isLoading={aiLoading}
            isDisabled={aiLoading}
            colorScheme="blue"
            variant="outline"
          />
        </Tooltip>
      </HStack>

      {error && (
        <Alert status="error" mb={4} borderRadius="md">
          <AlertIcon />
          {error}
        </Alert>
      )}

      {aiError && (
        <Alert status="warning" mb={4} borderRadius="md">
          <AlertIcon />
          Failed to load AI suggestions: {aiError}
        </Alert>
      )}

      {aiSuggestion && (
        <Alert status="info" mb={4} borderRadius="md">
          <AlertIcon />
          <Box>
            <Text fontWeight="bold">AI Suggestion:</Text>
            <Text>{aiSuggestion}</Text>
          </Box>
        </Alert>
      )}

      <VStack spacing={8} align="stretch">
        {notificationCategories.map(category => (
          <Box key={category} border="1px" borderColor="gray.200" borderRadius="md" p={4}>
            <HStack justifyContent="space-between" onClick={() => toggleCategoryExpansion(category)} cursor="pointer">
              <VStack align="flex-start" spacing={0}>
                <Heading as="h3" size="md" color="teal.600">
                  {categoryLabels[category]}
                </Heading>
                <Text fontSize="sm" color="gray.500">
                  {categoryDescriptions[category]}
                </Text>
              </VStack>
              <IconButton
                aria-label={expandedCategories[category] ? 'Collapse' : 'Expand'}
                icon={expandedCategories[category] ? <ChevronUpIcon /> : <ChevronDownIcon />}
                variant="ghost"
                size="sm"
              />
            </HStack>
            <Collapse in={expandedCategories[category]} animateOpacity>
              <VStack mt={4} spacing={3} pl={4} borderLeft="2px solid" borderColor="teal.100">
                {notificationChannels.map(channel => (
                  <FormControl key={channel} display="flex" alignItems="center" justifyContent="space-between">
                    <FormLabel htmlFor={`${category}-${channel}-toggle`} mb="0" flex="1">
                      {channelLabels[channel]}
                    </FormLabel>
                    <Switch
                      id={`${category}-${channel}-toggle`}
                      colorScheme="teal"
                      isChecked={settings[channel][category]}
                      onChange={e => handleToggle(channel, category, e.target.checked)}
                    />
                  </FormControl>
                ))}
              </VStack>
            </Collapse>
          </Box>
        ))}
      </VStack>

      <Button
        mt={10}
        colorScheme="teal"
        size="lg"
        width="full"
        onClick={handleSave}
        isLoading={saving}
        loadingText="Saving..."
      >
        Save Preferences
      </Button>
    </Box>
  );
};

export default NotificationSettings;