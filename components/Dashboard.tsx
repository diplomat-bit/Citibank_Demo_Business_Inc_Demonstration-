import React, { useState, useEffect, useRef, createContext, useContext, useReducer, useCallback, useMemo } from 'react';

// --- Core Data Models and Types (The Universe's Building Blocks) ---
export type UserRole = 'admin' | 'power_user' | 'standard' | 'guest' | 'developer' | 'ai_assistant' | 'quantum_engineer' | 'bio_specialist' | 'metaverse_architect' | 'dao_member';

export interface UserProfile {
  id: string;
  username: string;
  email: string;
  role: UserRole;
  preferences: Record<string, any>;
  lastLogin: Date;
  twoFactorEnabled: boolean;
  avatarUrl?: string;
  bio?: string;
  organizationId?: string;
  teamIds?: string[];
  permissions: string[]; // Granular permissions
  securityScore: number; // A score indicating user's security posture
  healthMetrics: HealthMetrics; // Integrated health data
  learningPaths: string[]; // IDs of active learning paths
  digitalAssets: string[]; // IDs of owned digital assets (NFTs, crypto, metaverse land)
  reputationScore: number; // For DAO governance and collaboration
  neuralLinkStatus: 'active' | 'inactive' | 'calibrating' | 'error'; // Future bio-neural interface
}

export interface WidgetConfig {
  id: string;
  type: string; // e.g., 'LineChart', 'AIRecommendationPanel', 'HolographicMap'
  title: string;
  layout: { x: number; y: number; w: number; h: number; static?: boolean };
  dataSources: string[]; // API endpoints, real-time streams, internal models
  refreshInterval: number; // seconds
  filters: Record<string, any>;
  visualizationType: string; // e.g., 'barChart', 'lineGraph', '3dScatter', 'hologram', 'quantumCircuit'
  displayOptions: Record<string, any>; // Colors, labels, interactivity settings
  permissions: UserRole[]; // Who can see/interact with this widget
  aiConfig?: Record<string, any>; // AI-specific configurations
  versionHistory?: { timestamp: Date; config: WidgetConfig }[]; // Version control for widgets
  telemetryEnabled: boolean; // For performance monitoring
}

export interface DashboardLayout {
  id: string;
  name: string;
  widgets: WidgetConfig[];
  ownerId: string;
  sharedWith: string[]; // User IDs or Role IDs
  version: number;
  isPublic: boolean;
  theme: 'light' | 'dark' | 'holographic' | 'neon' | 'cyberpunk' | 'quantum_matrix' | 'bio_lumina';
  globalFilters: Record<string, any>; // Filters applied across all widgets
  aiGenerated: boolean; // Was this layout generated by AI?
  lastModified: Date;
  changeLog: { userId: string; timestamp: Date; description: string }[];
  performanceMetrics: { loadTime: number; apiCalls: number; renderErrors: number };
  accessControlList: { entityId: string; permissionLevel: 'view' | 'edit' | 'manage' }[];
  spatialConfig?: { mode: '2D' | '3D' | 'VR' | 'AR'; environment: string }; // For metaverse/spatial dashboards
}

export interface MetricDataPoint {
  timestamp: Date;
  value: number;
  unit: string;
  metadata?: Record<string, any>; // e.g., sensor_id, anomaly_score
}

export interface SensorData {
  sensorId: string;
  type: string; // e.g., 'temperature', 'humidity', 'pressure', 'bio_signal', 'quantum_flux', 'cosmic_radiation'
  location: { lat: number; lon: number; altitude?: number; zone?: string; planet?: string; galaxy?: string };
  readings: MetricDataPoint[];
  status: 'active' | 'inactive' | 'error' | 'calibrating' | 'offline';
  calibrationDate?: Date;
  batteryLevel?: number; // %
  lastCommunication: Date;
  firmwareVersion: string;
  anomalyDetected: boolean;
  dataSignature: string; // For blockchain integrity
}

export interface TaskItem {
  id: string;
  title: string;
  description: string;
  dueDate: Date;
  priority: 'low' | 'medium' | 'high' | 'critical' | 'urgent';
  status: 'pending' | 'in_progress' | 'completed' | 'blocked' | 'on_hold' | 'awaiting_review';
  assignedTo: string[]; // User IDs
  tags: string[];
  projectId?: string;
  dependencies: string[]; // Other Task IDs
  progress: number; // 0-100%
  attachments: { fileName: string; url: string; type: string; ipfsHash?: string }[];
  comments: Comment[];
  recurrence?: string; // e.g., 'daily', 'weekly', 'monthly', 'every_2_weeks'
  timeSpentMinutes: number;
  estimatedTimeMinutes: number;
  automatedSteps: string[]; // For AI-driven task automation
  sentimentAnalysis?: { score: number; magnitude: number }; // AI analysis of task description/comments
}

export interface Project {
  id: string;
  name: string;
  description: string;
  startDate: Date;
  endDate: Date;
  status: 'active' | 'on_hold' | 'completed' | 'archived' | 'critical';
  ownerId: string;
  teamIds: string[];
  budget: { allocated: number; spent: number; currency: string; forecast: number };
  milestones: { id: string; name: string; dueDate: Date; completed: boolean; completionDate?: Date }[];
  risks: { id: string; description: string; severity: 'low' | 'medium' | 'high' | 'critical'; mitigationPlan: string }[];
  documents: { title: string; url: string; type: string; blockchainHash?: string }[];
  tasks: TaskItem[]; // Nested tasks or references
  aiGeneratedInsights: string[]; // From AI Project Manager
  healthScore: number; // Overall project health
  dependencies: string[]; // Other project IDs
  governanceModel: 'centralized' | 'decentralized'; // For DAO-managed projects
}

export interface Notification {
  id: string;
  type: 'alert' | 'info' | 'warning' | 'success' | 'system' | 'ai_suggestion' | 'dao_vote';
  message: string;
  timestamp: Date;
  read: boolean;
  userId: string;
  actionUrl?: string;
  priority: number; // 1-10, 10 being highest
  sourceService: string;
  tags: string[];
  isVisible: boolean; // For dynamic display
  snoozeOptions?: number[]; // Minutes to snooze
}

export interface CommunicationChannel {
  id: string;
  name: string;
  type: 'chat' | 'video' | 'forum' | 'broadcast' | 'neural_link';
  participants: string[]; // User IDs
  messages: Message[];
  isEncrypted: boolean; // Quantum-safe encryption
  settings: Record<string, any>; // E.g., moderation rules, language filters
  moderators: string[];
  historyRetentionDays: number;
  aiSummarizationEnabled: boolean;
}

export interface Message {
  id: string;
  senderId: string;
  timestamp: Date;
  content: string;
  readBy: string[]; // User IDs
  attachments?: { fileName: string; url: string; ipfsHash?: string }[];
  sentimentScore?: number; // AI-analyzed sentiment
  isEdited?: boolean;
  reactionEmojis?: { emoji: string; userId: string }[];
  threadId?: string; // For threaded conversations
  blockchainTxHash?: string; // For immutable communication logs
}

export interface FinancialTransaction {
  id: string;
  userId: string;
  type: 'income' | 'expense' | 'transfer' | 'investment' | 'payroll' | 'ai_service_fee';
  amount: number;
  currency: string;
  description: string;
  date: Date;
  category: string;
  tags: string[];
  projectId?: string;
  status: 'pending' | 'completed' | 'failed' | 'reversed';
  receiptUrl?: string;
  isRecurring: boolean;
  blockchainTxHash?: string; // For crypto transactions
  metadata: Record<string, any>; // e.g., 'contractId', 'vendor'
}

export interface Asset {
  id: string;
  name: string;
  type: 'software' | 'hardware' | 'license' | 'data' | 'digital_art' | 'crypto' | 'metaverse_land' | 'quantum_compute_credits' | 'biomaterial';
  ownerId: string;
  currentValue: number;
  acquisitionDate: Date;
  status: 'active' | 'retired' | 'maintenance' | 'deployed' | 'in_storage';
  location?: string; // Physical location or digital path/URL
  metadata: Record<string, any>;
  depreciationSchedule?: { year: number; value: number }[];
  blockchainRef?: string; // For NFTs, crypto assets, immutable record of physical assets
  environmentalImpactScore?: number;
}

export interface LearningModule {
  id: string;
  title: string;
  description: string;
  category: string;
  difficulty: 'beginner' | 'intermediate' | 'advanced' | 'expert' | 'master';
  durationMinutes: number;
  contentUrl: string; // Link to video, document, interactive lesson, VR simulation
  progress: number; // For user, 0-100%
  completedDate?: Date;
  tags: string[];
  recommendedSkills: string[];
  prerequisites: string[];
  quizzes: { id: string; score: number; attempts: number }[];
  certificationLevel?: string;
  aiPersonalizedPath: boolean; // Was this module recommended by AI?
  adaptiveLearningEnabled: boolean;
}

export interface HealthMetrics {
  heartRate: MetricDataPoint[];
  bloodPressure: MetricDataPoint[];
  sleepHours: MetricDataPoint[];
  steps: MetricDataPoint[];
  caloriesBurned: MetricDataPoint[];
  mood: MetricDataPoint[]; // e.g., 1-5 scale
  stressLevel: MetricDataPoint[]; // e.g., 1-10 scale, based on bio-feedback
  hydrationLevel: MetricDataPoint[];
  oxygenSaturation: MetricDataPoint[];
  meditationMinutes: MetricDataPoint[];
  biomarkerReadings: { type: string; data: MetricDataPoint[] }[]; // e.g., glucose, cholesterol, genetic markers
  neuralActivity: MetricDataPoint[]; // For brain-computer interfaces
  immunologicalResponse: MetricDataPoint[]; // Future integration with bio-scanners
  dietaryIntake: { timestamp: Date; food: string; calories: number; macroNutrients: Record<string, number> }[];
}

export interface GeolocationData {
  lat: number;
  lon: number;
  altitude?: number;
  timestamp: Date;
  accuracy?: number;
  speed?: number;
  heading?: number;
  celestialCoordinates?: { rightAscension: number; declination: number }; // For space exploration dashboards
  planetaryBody?: string;
}

export interface EnvironmentalData {
  airQualityIndex: MetricDataPoint;
  temperature: MetricDataPoint;
  humidity: MetricDataPoint;
  uvIndex: MetricDataPoint;
  windSpeed: MetricDataPoint;
  precipitation: MetricDataPoint;
  noiseLevel: MetricDataPoint;
  radiationLevel: MetricDataPoint; // for sci-fi future, cosmic radiation
  ozoneConcentration: MetricDataPoint;
  seismicActivity: MetricDataPoint[];
  oceanAcidity?: MetricDataPoint; // For planetary environmental monitoring
}

export interface AiModel {
  id: string;
  name: string;
  version: string;
  type: 'NLP' | 'Vision' | 'Predictive' | 'Generative' | 'ReinforcementLearning' | 'QuantumAI';
  status: 'training' | 'deployed' | 'retired' | 'error';
  trainingDataSizeGB: number;
  performanceMetrics: { accuracy: number; precision: number; recall: number; f1Score: number; inferenceLatencyMs: number };
  ownerId: string;
  accessControl: { userId: string; permission: 'view' | 'use' | 'fine_tune' }[];
  costPerInferenceUnit: number; // For AI-as-a-service
  quantumOptimized: boolean; // Indicates quantum speedup capability
}

// --- Universal Contexts and Providers ---

interface UserContextType {
  currentUser: UserProfile | null;
  isAuthenticated: boolean;
  login: (credentials: any) => Promise<UserProfile>;
  logout: () => void;
  updateProfile: (updates: Partial<UserProfile>) => Promise<UserProfile>;
  hasPermission: (permission: string) => boolean;
}
export const UserContext = createContext<UserContextType | undefined>(undefined);

export const UserProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [currentUser, setCurrentUser] = useState<UserProfile | null>(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  // Simulate authentication
  useEffect(() => {
    const storedUser = localStorage.getItem('userProfile');
    if (storedUser) {
      setCurrentUser(JSON.parse(storedUser));
      setIsAuthenticated(true);
    }
  }, []);

  const login = async (credentials: any) => {
    // API call simulation
    return new Promise<UserProfile>((resolve) => {
      setTimeout(() => {
        const user: UserProfile = {
          id: 'user-123',
          username: 'ai_expert',
          email: 'ai@universe.com',
          role: 'admin',
          preferences: {},
          lastLogin: new Date(),
          twoFactorEnabled: true,
          permissions: ['dashboard:view', 'dashboard:edit', 'admin:manage_users', 'ai:access_models', 'quantum:run_jobs', 'bio:access_data', 'metaverse:manage_assets', 'dao:vote'],
          securityScore: 95,
          healthMetrics: {
            heartRate: [{ timestamp: new Date(), value: 72, unit: 'bpm' }],
            bloodPressure: [], sleepHours: [], steps: [], caloriesBurned: [], mood: [{ timestamp: new Date(), value: 4, unit: 'scale' }], stressLevel: [], hydrationLevel: [], oxygenSaturation: [], meditationMinutes: [], biomarkerReadings: [], neuralActivity: [], immunologicalResponse: [], dietaryIntake: []
          },
          learningPaths: ['quantum_dev_101', 'ai_ethics_advanced'],
          digitalAssets: ['nft-star-map', 'meta-land-01'],
          reputationScore: 850,
          neuralLinkStatus: 'inactive',
        };
        setCurrentUser(user);
        setIsAuthenticated(true);
        localStorage.setItem('userProfile', JSON.stringify(user));
        resolve(user);
      }, 1000);
    });
  };

  const logout = () => {
    setCurrentUser(null);
    setIsAuthenticated(false);
    localStorage.removeItem('userProfile');
  };

  const updateProfile = async (updates: Partial<UserProfile>) => {
    if (!currentUser) throw new Error('No user logged in.');
    const updated = { ...currentUser, ...updates };
    setCurrentUser(updated);
    localStorage.setItem('userProfile', JSON.stringify(updated));
    return updated;
  };

  const hasPermission = useCallback((permission: string) => {
    return currentUser?.permissions.includes(permission) || currentUser?.role === 'admin';
  }, [currentUser]);

  const value = useMemo(() => ({ currentUser, isAuthenticated, login, logout, updateProfile, hasPermission }), [currentUser, isAuthenticated, hasPermission]);

  return <UserContext.Provider value={value}>{children}</UserContext.Provider>;
};

interface ThemeContextType {
  theme: 'light' | 'dark' | 'holographic' | 'neon' | 'cyberpunk' | 'quantum_matrix' | 'bio_lumina';
  setTheme: (theme: 'light' | 'dark' | 'holographic' | 'neon' | 'cyberpunk' | 'quantum_matrix' | 'bio_lumina') => void;
  generateTheme: (keywords: string[]) => Promise<Record<string, string>>; // AI-driven dynamic theme generation
}
export const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

export const ThemeProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [theme, setTheme] = useState<'light' | 'dark' | 'holographic' | 'neon' | 'cyberpunk' | 'quantum_matrix' | 'bio_lumina'>('dark');

  const generateTheme = async (keywords: string[]) => {
    console.log("Generating dynamic theme based on keywords:", keywords);
    // Simulate AI theme generation API call
    return new Promise<Record<string, string>>((resolve) => {
      setTimeout(() => {
        resolve({
          primaryColor: '#007bff',
          secondaryColor: '#6c757d',
          backgroundColor: '#1a1a1a',
          textColor: '#f8f9fa',
          accentColor: '#00ffff',
          // ... more dynamic CSS variables
        });
      }, 1500);
    });
  };

  const value = useMemo(() => ({ theme, setTheme, generateTheme }), [theme]);

  return (
    <ThemeContext.Provider value={value}>
      <div className={`theme-${theme}`}> {/* Apply theme class for global styling */}
        {children}
      </div>
    </ThemeContext.Provider>
  );
};

interface GlobalConfigContextType {
  config: Record<string, any>;
  updateConfig: (key: string, value: any) => void;
  getFeatureFlag: (flag: string) => boolean;
  getSetting: (setting: string, defaultValue?: any) => any;
  subscribeToConfigUpdates: (callback: (config: Record<string, any>) => void) => () => void;
}
export const GlobalConfigContext = createContext<GlobalConfigContextType | undefined>(undefined);

export const GlobalConfigProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [config, setConfig] = useState<Record<string, any>>({
    dashboardVersion: '10.5.2',
    enableAIRecommendationEngine: true,
    enableRealtimeDataStreams: true,
    defaultLanguage: 'en-US',
    dataRetentionPolicy: '5_years_galactic_standard',
    quantumSecurityEnabled: false, // Default to false for a feature flag
    holographicModeAvailable: true,
    blockchainLedgerIntegration: true,
    neuralInterfaceEnabled: false,
    metaversePortalActive: true,
    aiModelTrainingCapacity: 'high',
    environmentalMonitoringLevel: 'planetary',
    gravitationalStabilizerActive: true, // Just for fun, cosmic scale
    // ... many more configurations
  });

  useEffect(() => {
    const storedConfig = localStorage.getItem('globalConfig');
    if (storedConfig) {
      setConfig(JSON.parse(storedConfig));
    }

    // Simulate websocket subscription for live updates
    const ws = new WebSocket('wss://api.universe.com/config');
    ws.onmessage = (event) => {
      const newConfig = JSON.parse(event.data);
      setConfig((prev) => ({ ...prev, ...newConfig }));
    };
    return () => ws.close();
  }, []);

  const updateConfig = (key: string, value: any) => {
    setConfig((prev) => {
      const newConfig = { ...prev, [key]: value };
      localStorage.setItem('globalConfig', JSON.stringify(newConfig));
      return newConfig;
    });
  };

  const getFeatureFlag = useCallback((flag: string) => !!config[`feature_${flag}`] || !!config[flag], [config]);
  const getSetting = useCallback((setting: string, defaultValue: any = null) => config[setting] ?? defaultValue, [config]);

  const subscribeToConfigUpdates = (callback: (config: Record<string, any>) => void) => {
    console.log("Subscribing to config updates...");
    const interval = setInterval(() => {
      const mockUpdate = { lastUpdated: new Date().toISOString() };
      callback(mockUpdate);
    }, 30000);
    return () => clearInterval(interval);
  };

  const value = useMemo(() => ({ config, updateConfig, getFeatureFlag, getSetting, subscribeToConfigUpdates }), [config, getFeatureFlag, getSetting]);

  return <GlobalConfigContext.Provider value={value}>{children}</GlobalConfigContext.Provider>;
};

// --- API Service Layer (Interacting with the Universe's Backend) ---
export const APIService = {
  fetchDashboardLayouts: async (userId: string): Promise<DashboardLayout[]> => {
    console.log(`Fetching layouts for ${userId}...`);
    return new Promise((resolve) => setTimeout(() => resolve([
      {
        id: 'layout-1', name: 'My Primary Universal Dashboard', widgets: [], ownerId: userId, sharedWith: [], version: 1, isPublic: false, theme: 'dark', globalFilters: {}, aiGenerated: false, lastModified: new Date(), changeLog: [],
        performanceMetrics: { loadTime: 500, apiCalls: 10, renderErrors: 0 }, accessControlList: [], spatialConfig: { mode: '2D', environment: 'default' }
      },
      {
        id: 'layout-2', name: 'Project Omega Overview', widgets: [], ownerId: userId, sharedWith: ['team-alpha'], version: 1, isPublic: false, theme: 'dark', globalFilters: { projectId: 'proj-omega' }, aiGenerated: false, lastModified: new Date(), changeLog: [],
        performanceMetrics: { loadTime: 600, apiCalls: 12, renderErrors: 0 }, accessControlList: [], spatialConfig: { mode: '2D', environment: 'default' }
      },
      {
        id: 'layout-3', name: 'Quantum Ops Center (Holographic)', widgets: [], ownerId: userId, sharedWith: [], version: 1, isPublic: false, theme: 'holographic', globalFilters: { system: 'quantum_core' }, aiGenerated: true, lastModified: new Date(), changeLog: [],
        performanceMetrics: { loadTime: 1200, apiCalls: 20, renderErrors: 0 }, accessControlList: [], spatialConfig: { mode: '3D', environment: 'quantum_grid' }
      },
    ]), 500));
  },
  saveDashboardLayout: async (layout: DashboardLayout): Promise<DashboardLayout> => {
    console.log(`Saving layout ${layout.id}...`);
    return new Promise((resolve) => setTimeout(() => resolve({ ...layout, lastModified: new Date() }), 300));
  },
  fetchWidgetData: async (widgetId: string, sources: string[], filters: Record<string, any>): Promise<any> => {
    console.log(`Fetching data for widget ${widgetId} from sources ${sources.join(', ')} with filters`, filters);
    return new Promise((resolve) => setTimeout(() => resolve({
      widgetId,
      data: Array.from({ length: 10 }, (_, i) => ({ x: i, y: Math.random() * 100 + filters.offset || 0, z: Math.random() * 50 })), // Added Z for 3D potential
      lastUpdated: new Date().toISOString()
    }), 700));
  },
  fetchNotifications: async (userId: string): Promise<Notification[]> => {
    console.log(`Fetching notifications for ${userId}...`);
    return new Promise((resolve) => setTimeout(() => resolve([
      { id: 'notif-1', type: 'alert', message: 'High CPU usage detected on server Alpha-1!', timestamp: new Date(), read: false, userId, priority: 9, sourceService: 'Monitoring', isVisible: true },
      { id: 'notif-2', type: 'info', message: 'Your weekly report is ready.', timestamp: new Date(), read: true, userId, priority: 5, sourceService: 'Reporting', isVisible: true },
      { id: 'notif-3', type: 'ai_suggestion', message: 'AI suggests optimizing query for Project Alpha.', timestamp: new Date(), read: false, userId, priority: 7, sourceService: 'AI Insights', isVisible: true, actionUrl: '/ai-suggestions/123' },
      { id: 'notif-4', type: 'dao_vote', message: 'New DAO proposal for quantum funding is open for vote.', timestamp: new Date(), read: false, userId, priority: 8, sourceService: 'DAO Governance', isVisible: true, actionUrl: '/governance/prop-001' },
    ]), 400));
  },
  // --- AI/ML specific endpoints ---
  getAIRecommendations: async (context: Record<string, any>): Promise<string[]> => {
    console.log("Getting AI recommendations...", context);
    return new Promise((resolve) => setTimeout(() => resolve([
      'Optimize query performance on galactic data streams.',
      'Review security logs for anomalous quantum fluctuations.',
      'Suggest new dashboard layout for Project Omega to enhance task visibility.',
      'Propose a new learning module for advanced bio-neural interface protocols.',
      'Forecast market volatility for digital assets in Q3.'
    ]), 1200));
  },
  runPredictiveAnalytics: async (dataType: string, inputData: any): Promise<any> => {
    console.log(`Running predictive analytics for ${dataType}...`);
    return new Promise((resolve) => setTimeout(() => resolve({ prediction: Math.random() > 0.5 ? 'Positive Trend' : 'Negative Trend', confidence: 0.85, forecastData: [{ x: 1, y: 100 }, { x: 2, y: 110 }] }), 1500));
  },
  generateContent: async (prompt: string, context: Record<string, any>): Promise<string> => {
    console.log(`Generating content for prompt: ${prompt}...`);
    return new Promise((resolve) => setTimeout(() => resolve(`AI-generated content based on "${prompt}". It's highly optimized and insightful, suggesting a new paradigm shift in data presentation. This content leverages advanced neural networks and context-aware generation, resulting in a comprehensive and coherent narrative.`), 2000));
  },
  submitAIModelForTraining: async (modelConfig: any, trainingData: any): Promise<{ jobId: string; status: string }> => {
    console.log("Submitting AI model for training:", modelConfig);
    return new Promise((resolve) => setTimeout(() => resolve({ jobId: `ai-train-${Date.now()}`, status: 'queued' }), 3000));
  },
  deployAIModel: async (modelId: string, targetEnvironment: string): Promise<{ status: string; endpoint: string }> => {
    console.log(`Deploying AI model ${modelId} to ${targetEnvironment}...`);
    return new Promise((resolve) => setTimeout(() => resolve({ status: 'deployed', endpoint: `https://api.universe.com/ai/${modelId}` }), 2000));
  },
  // --- Blockchain/Web3 endpoints ---
  getBlockchainLedgerStatus: async (): Promise<any> => {
    console.log("Fetching blockchain ledger status...");
    return new Promise((resolve) => setTimeout(() => resolve({ lastBlock: '0xabc123...', blockHeight: 12345678, status: 'synced', network: 'Ethereum-Enterprise-v2', validatorCount: 256, transactionRate: '1200 TPS' }), 600));
  },
  mintNFT: async (assetData: any): Promise<string> => {
    console.log("Minting NFT for asset:", assetData);
    return new Promise((resolve) => setTimeout(() => resolve(`nft-token-${Date.now()}-0x${Math.random().toString(16).substring(2, 8)}`), 2500));
  },
  submitDAOProposal: async (proposal: any): Promise<{ proposalId: string; status: string }> => {
    console.log("Submitting DAO proposal:", proposal);
    return new Promise((resolve) => setTimeout(() => resolve({ proposalId: `dao-prop-${Date.now()}`, status: 'pending_review' }), 1800));
  },
  // --- Bio-integration endpoints ---
  fetchBioSignals: async (userId: string, type: string, timeframe: string): Promise<MetricDataPoint[]> => {
    console.log(`Fetching bio signals (${type}) for ${userId} for ${timeframe}...`);
    return new Promise((resolve) => setTimeout(() => resolve(
      Array.from({ length: 24 }, (_, i) => ({ timestamp: new Date(Date.now() - (24 - i) * 3600 * 1000), value: type === 'heartRate' ? (60 + Math.random() * 20) : (Math.random() * 10), unit: type === 'heartRate' ? 'bpm' : 'value' }))
    ), 1000));
  },
  activateNeuralLink: async (userId: string): Promise<{ status: 'active' | 'inactive' | 'error' }> => {
    console.log(`Activating neural link for ${userId}...`);
    return new Promise((resolve) => setTimeout(() => resolve({ status: 'active' }), 3000));
  },
  // --- Quantum Computing Integration ---
  submitQuantumJob: async (circuitConfig: any): Promise<{ jobId: string; status: string }> => {
    console.log("Submitting quantum job:", circuitConfig);
    return new Promise((resolve) => setTimeout(() => resolve({ jobId: `quantum-job-${Date.now()}`, status: 'queued' }), 3000));
  },
  getQuantumJobResult: async (jobId: string): Promise<any> => {
    console.log("Fetching quantum job result:", jobId);
    return new Promise((resolve) => setTimeout(() => resolve({ jobId, status: 'completed', result: { qubits: 1024, entanglement_probability: 0.98, data: Math.random() * 1000, runtime_ms: 5000 } }), 5000));
  },
  monitorQuantumField: async (): Promise<any> => {
    console.log("Monitoring quantum field stability...");
    return new Promise((resolve) => setTimeout(() => resolve({ fieldStability: Math.random() * 100, cosmicRadiation: Math.random() * 0.1, anomalyDetected: Math.random() > 0.9 }), 2000));
  },
  // --- Metaverse Endpoints ---
  fetchMetaverseAssets: async (userId: string): Promise<Asset[]> => {
    console.log(`Fetching Metaverse assets for ${userId}...`);
    return new Promise((resolve) => setTimeout(() => resolve([
      { id: 'meta-land-01', name: 'Digital Estate "Nexus Prime"', type: 'metaverse_land', ownerId: userId, currentValue: 500000, acquisitionDate: new Date('2023-08-01'), status: 'active', location: 'Metaverse:TerraPrime', metadata: { coordinates: '100,200', size: '100x100m' }, blockchainRef: '0xMeta_Land_NFT' },
      { id: 'meta-avatar-02', name: 'Elite Guardian Avatar', type: 'digital_art', ownerId: userId, currentValue: 50000, acquisitionDate: new Date('2023-10-15'), status: 'active', location: 'Inventory', metadata: { rarity: 'legendary', creator: 'Synthetica Corp.' }, blockchainRef: '0xMeta_Avatar_NFT' },
    ]), 1000));
  }
};

// --- Utility Hooks & Functions (The Universe's Physics) ---

export const useNotifications = (userId: string) => {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);

  useEffect(() => {
    if (!userId) return;
    const fetchAndSetNotifications = async () => {
      const data = await APIService.fetchNotifications(userId);
      setNotifications(data);
      setUnreadCount(data.filter(n => !n.read && n.isVisible).length);
    };
    fetchAndSetNotifications();

    const interval = setInterval(fetchAndSetNotifications, 60000); // Refresh every minute
    return () => clearInterval(interval);
  }, [userId]);

  const markAsRead = (notificationId: string) => {
    setNotifications(prev => prev.map(n => n.id === notificationId ? { ...n, read: true } : n));
    setUnreadCount(prev => Math.max(0, prev - 1));
    // API call to mark as read
  };

  const clearNotification = (notificationId: string) => {
    setNotifications(prev => prev.filter(n => n.id !== notificationId));
    // API call to delete
  };

  const clearAllNotifications = () => {
    setNotifications([]);
    setUnreadCount(0);
    // API call to clear all
  };

  return { notifications, unreadCount, markAsRead, clearNotification, clearAllNotifications };
};

export const useRealtimeDataStream = <T>(dataSourceUrl: string, initialData: T[] = []) => {
  const [data, setData] = useState<T[]>(initialData);
  const socketRef = useRef<WebSocket | null>(null);

  useEffect(() => {
    socketRef.current = new WebSocket(dataSourceUrl);

    socketRef.current.onopen = () => console.log(`WebSocket opened for ${dataSourceUrl}`);
    socketRef.current.onmessage = (event) => {
      try {
        const newDataPoint: T = JSON.parse(event.data);
        setData((prevData) => [...prevData, newDataPoint]);
        if (prevData.length > 500) { // Keep data size manageable
          setData(prevData.slice(prevData.length - 500));
        }
      } catch (error) {
        console.error("Failed to parse real-time data:", error);
      }
    };
    socketRef.current.onclose = () => console.log(`WebSocket closed for ${dataSourceUrl}`);
    socketRef.current.onerror = (error) => console.error(`WebSocket error for ${dataSourceUrl}:`, error);

    return () => {
      socketRef.current?.close();
    };
  }, [dataSourceUrl]);

  return data;
};

// Custom hook for clicking outside an element
export const useOutsideClick = (ref: React.RefObject<HTMLElement>, handler: () => void) => {
  useEffect(() => {
    const listener = (event: MouseEvent) => {
      if (!ref.current || ref.current.contains(event.target as Node)) {
        return;
      }
      handler();
    };
    document.addEventListener('mousedown', listener);
    return () => {
      document.removeEventListener('mousedown', listener);
    };
  }, [ref, handler]);
};

// --- Advanced AI Components (The Universe's Intelligence) ---

interface AIInsightsEngineProps {
  dashboardId: string;
  currentFilters: Record<string, any>;
  onApplySuggestion: (suggestion: string) => void;
  confidenceThreshold?: number; // E.g., only show suggestions above 0.7 confidence
  modelVersion?: string; // Specify AI model to use
}
export const AIInsightsEngine: React.FC<AIInsightsEngineProps> = ({ dashboardId, currentFilters, onApplySuggestion, confidenceThreshold = 0.7, modelVersion = 'v3.7' }) => {
  const [insights, setInsights] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);
  const { currentUser } = useContext(UserContext)!;
  const { config } = useContext(GlobalConfigContext)!;

  useEffect(() => {
    if (!currentUser || !config.enableAIRecommendationEngine) return;

    setLoading(true);
    const fetchInsights = async () => {
      try {
        const context = { userId: currentUser.id, dashboardId, currentFilters, userPreferences: currentUser.preferences, confidenceThreshold, modelVersion };
        const recommendations = await APIService.getAIRecommendations(context);
        setInsights(recommendations);
      } catch (error) {
        console.error("Error fetching AI insights:", error);
      } finally {
        setLoading(false);
      }
    };
    fetchInsights();
    const interval = setInterval(fetchInsights, 5 * 60 * 1000); // Refresh every 5 minutes
    return () => clearInterval(interval);
  }, [currentUser, dashboardId, currentFilters, config.enableAIRecommendationEngine, confidenceThreshold, modelVersion]);

  if (loading) return <div className="p-4 text-blue-400">Generating AI Cognitive Core Insights...</div>;
  if (insights.length === 0) return <div className="p-4 text-gray-400">No new AI insights currently available.</div>;

  return (
    <div className="ai-insights-engine p-4 bg-gradient-to-br from-indigo-900 to-purple-900 text-white rounded-lg shadow-xl border border-blue-700">
      <h3 className="text-xl font-bold mb-3 text-cyan-400">AI Cognitive Core Insights <span className="text-sm opacity-75">(Model: {modelVersion} Quantum-Optimized)</span></h3>
      <ul className="list-disc pl-5">
        {insights.map((insight, index) => (
          <li key={index} className="mb-2 flex justify-between items-center group">
            <span className="text-lg">{insight}</span>
            <button
              onClick={() => onApplySuggestion(insight)}
              className="ml-3 px-3 py-1 bg-cyan-600 hover:bg-cyan-700 text-white rounded-full text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200"
            >
              Apply
            </button>
          </li>
        ))}
      </ul>
      <p className="text-xs text-right mt-3 opacity-60">Powered by Neuro-Adaptive Predictive Algorithms</p>
    </div>
  );
};

interface AIContentGeneratorProps {
  contentType: 'report' | 'summary' | 'action_plan' | 'creative_text' | 'code_snippet' | 'design_spec' | 'marketing_copy';
  contextData: Record<string, any>;
  onContentGenerated: (content: string) => void;
  tone?: 'formal' | 'informal' | 'optimistic' | 'critical';
  length?: 'short' | 'medium' | 'long';
  style?: 'technical' | 'narrative' | 'poetic';
  targetAudience?: string;
}
export const AIContentGenerator: React.FC<AIContentGeneratorProps> = ({ contentType, contextData, onContentGenerated, tone = 'formal', length = 'medium', style = 'technical', targetAudience = 'experts' }) => {
  const [prompt, setPrompt] = useState('');
  const [generatedContent, setGeneratedContent] = useState('');
  const [loading, setLoading] = useState(false);

  const generate = async () => {
    if (!prompt) return;
    setLoading(true);
    try {
      const fullPrompt = `Generate a ${length} ${tone} ${style} ${contentType} for ${targetAudience} based on the following context: ${JSON.stringify(contextData)}. Specific instruction: ${prompt}`;
      const content = await APIService.generateContent(fullPrompt, contextData);
      setGeneratedContent(content);
      onContentGenerated(content);
    } catch (error) {
      console.error("Error generating content:", error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="ai-content-generator p-4 border border-gray-700 rounded-lg bg-gray-800 text-white shadow-lg">
      <h4 className="text-lg font-semibold mb-2 text-green-400">AI Content Forge</h4>
      <textarea
        className="w-full p-2 bg-gray-700 border border-gray-600 rounded text-white resize-y min-h-[80px] focus:outline-none focus:ring-2 focus:ring-green-500"
        placeholder={`Enter specific instructions for your ${contentType} (e.g., 'focus on Q3 performance')...`}
        value={prompt}
        onChange={(e) => setPrompt(e.target.value)}
      />
      <div className="flex items-center space-x-2 mt-2 text-sm text-gray-400">
        <span>Tone: {tone}</span>
        <span>Length: {length}</span>
        <span>Style: {style}</span>
      </div>
      <button
        onClick={generate}
        disabled={loading}
        className="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
      >
        {loading ? 'Generating...' : `Generate ${contentType}`}
      </button>
      {generatedContent && (
        <div className="mt-4 p-3 bg-gray-700 border border-gray-600 rounded">
          <h5 className="font-medium mb-1 text-green-300">Generated Content:</h5>
          <pre className="whitespace-pre-wrap text-sm">{generatedContent}</pre>
        </div>
      )}
    </div>
  );
};

interface AIFinancialForecasterProps {
  portfolioId: string;
  timeHorizon: 'short' | 'medium' | 'long' | 'interstellar';
  riskTolerance: 'low' | 'medium' | 'high' | 'aggressive';
  onForecastResult: (result: any) => void;
  // Params for scenario analysis, stress testing, quantum optimization
}
export const AIFinancialForecaster: React.FC<AIFinancialForecasterProps> = ({ portfolioId, timeHorizon, riskTolerance, onForecastResult }) => {
  const [forecast, setForecast] = useState<any>(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    setLoading(true);
    const fetchForecast = async () => {
      try {
        const data = await APIService.runPredictiveAnalytics('financial_market', { portfolioId, timeHorizon, riskTolerance });
        setForecast(data);
        onForecastResult(data);
      } catch (error) {
        console.error("Error fetching financial forecast:", error);
      } finally {
        setLoading(false);
      }
    };
    fetchForecast();
  }, [portfolioId, timeHorizon, riskTolerance, onForecastResult]);

  if (loading) return <div className="p-4 text-blue-400">AI Financial Quantum Forecasting...</div>;
  if (!forecast) return <div className="p-4 text-gray-400">No forecast available.</div>;

  return (
    <div className="ai-financial-forecaster p-4 bg-blue-900 text-white rounded-lg shadow-md border border-blue-700">
      <h4 className="text-lg font-semibold mb-2 text-blue-300">AI Financial Quantum Forecaster</h4>
      <p><strong>Prediction:</strong> <span className="font-bold text-green-400">{forecast.prediction}</span></p>
      <p><strong>Confidence:</strong> <span className="text-yellow-300">{(forecast.confidence * 100).toFixed(2)}%</span></p>
      <p className="text-sm opacity-80 mt-2">Time Horizon: {timeHorizon}, Risk Tolerance: {riskTolerance}</p>
      {/* More detailed visualization of the forecast */}
      <div className="mt-4 p-2 bg-blue-800 rounded">
        <h5 className="text-sm font-semibold text-blue-200">Key Data Points:</h5>
        {forecast.forecastData?.map((point: any, index: number) => (
          <p key={index} className="text-xs text-blue-100">Point {point.x}: Value {point.y}</p>
        ))}
      </div>
      <button className="mt-4 px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">Run Scenario Analysis</button>
    </div>
  );
};

// --- Advanced Visualization & Interaction Components (The Universe's UI/UX) ---

interface DataVisualizationProps {
  data: any[];
  config: WidgetConfig;
  height?: string;
  width?: string;
  interactivityEnabled?: boolean;
  onDataPointClick?: (point: any) => void;
  // Further props for custom models, confidence thresholds, etc.
}
export const DataVisualization: React.FC<DataVisualizationProps> = ({ data, config, height = '300px', width = '100%', interactivityEnabled = true, onDataPointClick }) => {
  const chartRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!chartRef.current) return;
    console.log(`Rendering ${config.visualizationType} for widget ${config.id} with data:`, data);

    // In a real app, this would integrate with a charting library (e.g., D3.js, Highcharts, Three.js for 3D)
    // For now, we'll just show a placeholder message.
    chartRef.current.innerHTML = `<div style="padding: 20px; text-align: center; background-color: rgba(255,255,255,0.05); border-radius: 8px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <p class="text-gray-300 text-lg">üöÄ Advanced ${config.visualizationType} (Widget ID: ${config.id})</p>
      <p class="text-sm text-gray-400 mt-1">Simulated data for ${data.length} points. Interactivity: ${interactivityEnabled ? 'On' : 'Off'}</p>
      <p class="text-xs text-gray-500 mt-2">Visualizing: ${JSON.stringify(config.dataSources)}</p>
    </div>`;
  }, [data, config, interactivityEnabled]);

  return (
    <div ref={chartRef} style={{ height: height, width: width }} className="data-visualization flex items-center justify-center bg-gray-900 rounded-lg shadow-inner overflow-hidden">
      {/* Actual chart/3D canvas would render here */}
    </div>
  );
};

interface HolographicProjectionProps {
  modelUrl: string; // URL to a 3D model (GLTF, OBJ, custom volumetric data)
  interactionMode: 'view' | 'manipulate' | 'annotate' | 'simulate';
  onInteraction: (event: any) => void;
  realtimeDataOverlay?: any[]; // Data to overlay dynamically in 3D space
  spatialAudioConfig?: { source: string; coordinates: { x: number; y: number; z: number } };
  // Further props for real-time data overlays, spatial audio, VR/AR integration
}
export const HolographicProjection: React.FC<HolographicProjectionProps> = ({ modelUrl, interactionMode, onInteraction, realtimeDataOverlay, spatialAudioConfig }) => {
  const containerRef = useRef<HTMLDivElement>(null);
  // This would integrate with a WebGL/WebXR library (e.g., Three.js, Babylon.js)
  // to render interactive 3D content, potentially with augmented reality overlays.

  useEffect(() => {
    if (containerRef.current) {
      // Simulate 3D rendering initialization
      containerRef.current.innerHTML = `<div style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(0,255,255,0.1) 0%, rgba(0,0,0,0.8) 100%); border-radius: 12px; border: 1px dashed cyan;">
        <p class="text-cyan-300 text-lg font-light animate-pulse">‚ú® Holographic Projection of ${modelUrl.split('/').pop() || 'Untitled Model'}</p>
        <p class="absolute bottom-4 text-xs text-gray-400">Interaction Mode: ${interactionMode}. Data Overlays: ${realtimeDataOverlay?.length || 0}</p>
      </div>`;
      // Simulate event listener for interaction
      const handler = (e: MouseEvent) => onInteraction(e);
      containerRef.current.addEventListener('click', handler);
      return () => containerRef.current?.removeEventListener('click', handler);
    }
  }, [modelUrl, interactionMode, realtimeDataOverlay, onInteraction]);

  return (
    <div ref={containerRef} className="holographic-projection w-full h-full min-h-[400px] relative">
      {spatialAudioConfig && <SpatialAudioControl audioSource={spatialAudioConfig.source} spatialCoordinates={spatialAudioConfig.coordinates} volume={0.5} play={true} />}
      {/* WebGL/Canvas for 3D rendering */}
    </div>
  );
};

interface SpatialAudioControlProps {
  audioSource: string; // URL for background ambient sound, alerts, etc.
  spatialCoordinates: { x: number; y: number; z: number };
  volume: number;
  play: boolean;
  loop?: boolean;
  // Dynamic audio mixing, AI-driven soundscapes, directional audio
}
export const SpatialAudioControl: React.FC<SpatialAudioControlProps> = ({ audioSource, spatialCoordinates, volume, play, loop = true }) => {
  const audioRef = useRef<HTMLAudioElement>(null);

  useEffect(() => {
    if (audioRef.current) {
      audioRef.current.volume = volume;
      audioRef.current.loop = loop;
      if (play) {
        audioRef.current.play().catch(e => console.warn("Audio play failed (user gesture required?):", e));
      } else {
        audioRef.current.pause();
      }
      // In a real system, you'd use Web Audio API for true spatial audio
      console.log(`Playing spatial audio from ${audioSource} at coords ${JSON.stringify(spatialCoordinates)}`);
    }
  }, [audioSource, spatialCoordinates, volume, play, loop]);

  return (
    <audio ref={audioRef} src={audioSource} loop={true} preload="auto" className="hidden" />
  );
};

// --- Core Dashboard Components (The Universe's Command Center) ---

interface DraggableWidgetProps {
  widget: WidgetConfig;
  onRemove: (id: string) => void;
  onEdit: (widget: WidgetConfig) => void;
  onDataRefresh: (id: string) => void;
}
export const DraggableWidget: React.FC<DraggableWidgetProps> = ({ widget, onRemove, onEdit, onDataRefresh }) => {
  const [data, setData] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const { currentUser } = useContext(UserContext)!;
  const { hasPermission } = useContext(UserContext)!;

  useEffect(() => {
    if (!currentUser || !widget.permissions.some(role => currentUser.role === role || currentUser.permissions.includes('dashboard:override_permissions'))) {
      setData([]); // User doesn't have permission
      return;
    }

    const fetchData = async () => {
      setLoading(true);
      try {
        const response = await APIService.fetchWidgetData(widget.id, widget.dataSources, { ...widget.filters, userId: currentUser?.id });
        setData(response.data);
      } catch (error) {
        console.error(`Error fetching data for widget ${widget.id}:`, error);
        // Implement robust error reporting/retry mechanisms
      } finally {
        setLoading(false);
      }
    };
    fetchData(); // Initial fetch
    const interval = setInterval(fetchData, widget.refreshInterval * 1000); // Periodic refresh
    return () => clearInterval(interval);
  }, [widget, currentUser, hasPermission]);

  const canEdit = hasPermission('dashboard:edit');
  const canView = widget.permissions.some(role => currentUser?.role === role) || hasPermission('dashboard:override_permissions');

  if (!canView) {
    return (
      <div className="draggable-widget bg-gray-900 border border-red-700 rounded-lg shadow-xl p-4 flex flex-col text-red-400">
        <h3 className="text-xl font-semibold mb-3">{widget.title}</h3>
        <p>Access Denied: You do not have permissions to view this widget.</p>
      </div>
    );
  }

  const renderWidgetContent = () => {
    if (loading) {
      return <div className="flex items-center justify-center h-full text-gray-400">Loading Data...</div>;
    }

    // Dynamic rendering based on widget type
    switch (widget.type) {
      case 'AIRecommendationPanel':
        return <AIInsightsEngine dashboardId="current-dashboard" currentFilters={widget.filters} onApplySuggestion={(s) => console.log(s)} />;
      case 'HolographicMap':
        return <HolographicProjection modelUrl="/models/map.gltf" interactionMode="view" onInteraction={() => {}} realtimeDataOverlay={data} />;
      case 'BlockchainStatus':
        return <BlockchainLedgerStatusWidget />;
      case 'QuantumStatusMonitor':
        return <QuantumComputingStatusWidget minimal={true} />;
      case 'CommunicationFeed':
        return <CommunicationFeedWidget channelId={widget.filters?.channelId || 'global_channel'} />;
      case 'TaskTracker':
        return <TaskTrackerWidget projectId={widget.filters?.projectId} />;
      case 'BioSignalGraph':
        return <DataVisualization data={data} config={{ ...widget, visualizationType: 'lineGraph' }} height="100%" />;
      // ... many more specialized widget types
      default:
        return <DataVisualization data={data} config={widget} height="100%" />;
    }
  };

  return (
    <div
      className="draggable-widget bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-4 flex flex-col transition-all duration-300 hover:shadow-2xl hover:border-blue-500"
      style={{
        gridColumn: `span ${widget.layout.w}`,
        gridRow: `span ${widget.layout.h}`,
      }}
    >
      <div className="flex justify-between items-center mb-3">
        <h3 className="text-xl font-semibold text-white">{widget.title}</h3>
        <div className="flex space-x-2">
          {canEdit && (
            <>
              <button onClick={() => onEdit(widget)} className="text-gray-400 hover:text-blue-400 text-sm">
                ‚öôÔ∏è Edit
              </button>
              <button onClick={() => onRemove(widget.id)} className="text-gray-400 hover:text-red-400 text-sm">
                ‚ùå Remove
              </button>
            </>
          )}
          <button onClick={() => onDataRefresh(widget.id)} className="text-gray-400 hover:text-green-400 text-sm">
            üîÑ Refresh
          </button>
        </div>
      </div>
      <div className="flex-grow min-h-0"> {/* min-h-0 to allow flex-grow to shrink */}
        {renderWidgetContent()}
      </div>
      <p className="text-xs text-right text-gray-500 mt-2">Last Updated: {new Date().toLocaleTimeString()}</p>
    </div>
  );
};

interface WidgetCatalogProps {
  onAddWidget: (widgetType: string) => void;
}
export const WidgetCatalog: React.FC<WidgetCatalogProps> = ({ onAddWidget }) => {
  const availableWidgetTypes = [
    'LineChart', 'BarChart', 'PieChart', 'Table', 'Gauge', 'Heatmap', 'ScatterPlot', 'AreaChart',
    '3DModelView', 'TextPanel', 'MetricCard', 'Map', 'Timeline', 'Calendar', 'RichTextEditor',
    'AIRecommendationPanel', 'AIContentGenerator', 'AIFinancialForecaster', 'QuantumStatusMonitor', 'QuantumJobCreator', 'BioSignalGraph', 'NeuralLinkMonitor',
    'BlockchainLedgerStatus', 'NFTViewer', 'DAOProposalFeed', 'CommunicationFeed', 'TaskTracker', 'ProjectOverview',
    'EnvironmentalSensor', 'FinancialOverview', 'LearningProgress', 'ResourceOverview', 'SecurityLogAnalyzer', 'GravitationalFieldStatus',
    'MetaverseAssetDisplay', 'CelestialMap', 'EnergyConsumptionMonitor', 'TrafficFlowPredictor', 'SentimentAnalyzer', 'CodeReviewAssistant',
    'VirtualAssistantInterface', 'WeatherForecast', 'GlobalNewsFeed', 'MarketSentimentGauge', 'SupplyChainTracker', 'ComplianceAuditor',
    'VRSceneViewer', 'ARInteractiveOverlay', 'SpatialAudioController', 'MultiverseNavigationPad', 'TemporalAnomalyDetector'
  ]; // A vastly expanded list of widget types

  return (
    <div className="widget-catalog p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg">
      <h3 className="text-xl font-bold mb-4 text-white">Widget Universe Catalog</h3>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto pr-2">
        {availableWidgetTypes.map((type) => (
          <button
            key={type}
            onClick={() => onAddWidget(type)}
            className="p-3 bg-gray-700 hover:bg-blue-600 text-white rounded-md text-sm transition-colors duration-200"
          >
            ‚ûï {type}
          </button>
        ))}
      </div>
    </div>
  );
};

interface DashboardHeaderProps {
  currentLayout: DashboardLayout;
  onLayoutChange: (layoutId: string) => void;
  onSaveLayout: () => void;
  onShareLayout: () => void;
  onAddWidgetClick: () => void;
  onCustomizeTheme: () => void;
  onOpenGlobalSettings: () => void;
}
export const DashboardHeader: React.FC<DashboardHeaderProps> = ({
  currentLayout, onLayoutChange, onSaveLayout, onShareLayout, onAddWidgetClick, onCustomizeTheme, onOpenGlobalSettings
}) => {
  const { currentUser } = useContext(UserContext)!;
  const [availableLayouts, setLayouts] = useState<DashboardLayout[]>([]);
  const { hasPermission } = useContext(UserContext)!;

  useEffect(() => {
    if (currentUser) {
      APIService.fetchDashboardLayouts(currentUser.id).then(setLayouts);
    }
  }, [currentUser]);

  const canEdit = hasPermission('dashboard:edit');
  const canShare = hasPermission('dashboard:share');
  const canManageSettings = hasPermission('admin:manage_settings');

  return (
    <header className="dashboard-header bg-gray-900 text-white p-4 border-b border-gray-700 flex flex-wrap justify-between items-center sticky top-0 z-50 shadow-lg">
      <div className="flex items-center flex-grow">
        <h1 className="text-3xl font-extrabold text-blue-400 mr-4">Universe Control Panel</h1>
        <span className="text-sm text-gray-400 mr-4 hidden md:inline">Layout: <span className="font-semibold">{currentLayout.name}</span></span>
        <GlobalSearch />
      </div>

      <div className="flex items-center space-x-4 mt-2 md:mt-0 ml-auto">
        <select
          onChange={(e) => onLayoutChange(e.target.value)}
          value={currentLayout.id}
          className="p-2 bg-gray-700 border border-gray-600 rounded text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          {availableLayouts.map(layout => (
            <option key={layout.id} value={layout.id}>{layout.name}</option>
          ))}
          <option value="new">‚ûï Create New Layout</option>
        </select>

        {canEdit && (
          <button onClick={onAddWidgetClick} className="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded text-white text-sm transition-colors duration-200">
            ‚ûï Widget
          </button>
        )}
        {canEdit && (
          <button onClick={onSaveLayout} className="px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-white text-sm transition-colors duration-200">
            üíæ Save
          </button>
        )}
        {canShare && (
          <button onClick={onShareLayout} className="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm transition-colors duration-200">
            üîó Share
          </button>
        )}
        <button onClick={onCustomizeTheme} className="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-white text-sm transition-colors duration-200">
          üé® Theme
        </button>
        {canManageSettings && (
          <button onClick={onOpenGlobalSettings} className="px-3 py-2 bg-red-600 hover:bg-red-700 rounded text-white text-sm transition-colors duration-200">
            ‚öôÔ∏è Global Settings
          </button>
        )}
        <NotificationCenter />
        <UserProfileMenu />
      </div>
    </header>
  );
};

export const UserProfileMenu: React.FC = () => {
  const { currentUser, logout, updateProfile } = useContext(UserContext)!;
  const [isOpen, setIsOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);

  useOutsideClick(menuRef, () => setIsOpen(false));

  if (!currentUser) return null;

  return (
    <div className="relative" ref={menuRef}>
      <button onClick={() => setIsOpen(!isOpen)} className="flex items-center space-x-2 text-white hover:text-blue-300 transition-colors duration-200 p-1 rounded-full bg-gray-800">
        <img src={currentUser.avatarUrl || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${currentUser.username}`} alt="User Avatar" className="w-8 h-8 rounded-full border border-gray-600" />
        <span className="hidden lg:inline text-sm">{currentUser.username} ({currentUser.role})</span>
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-64 bg-gray-800 border border-gray-700 rounded-md shadow-lg py-2 z-50">
          <div className="px-4 py-2 border-b border-gray-700">
            <p className="font-semibold text-white">{currentUser.username}</p>
            <p className="text-xs text-gray-400">{currentUser.email}</p>
          </div>
          <button onClick={() => { /* Open profile settings modal */ setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">
            ‚öôÔ∏è Profile Settings
          </button>
          <button onClick={() => { /* Open security center */ setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">
            üîí Security Center ({currentUser.securityScore}/100)
          </button>
          <button onClick={() => { /* Open health dashboard */ setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">
            ‚ù§Ô∏è Bio-Integrated Health
          </button>
          <button onClick={() => { /* Open learning path */ setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">
            üìö Learning Path
          </button>
          <button onClick={() => { /* Open digital asset wallet */ setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">
            üí∞ Digital Asset Wallet
          </button>
          {currentUser.neuralLinkStatus === 'active' && (
            <button onClick={() => { /* Manage neural link */ setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700">
              üß† Neural Interface
            </button>
          )}
          <hr className="border-gray-700 my-1" />
          <button onClick={() => { logout(); setIsOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-700">
            üö™ Logout
          </button>
        </div>
      )}
    </div>
  );
};

export const NotificationCenter: React.FC = () => {
  const { currentUser } = useContext(UserContext)!;
  const { notifications, unreadCount, markAsRead, clearNotification, clearAllNotifications } = useNotifications(currentUser?.id || '');
  const [isOpen, setIsOpen] = useState(false);
  const notifRef = useRef<HTMLDivElement>(null);

  useOutsideClick(notifRef, () => setIsOpen(false));

  if (!currentUser) return null;

  return (
    <div className="relative" ref={notifRef}>
      <button onClick={() => setIsOpen(!isOpen)} className="p-2 relative text-white hover:text-blue-300">
        üîî
        {unreadCount > 0 && (
          <span className="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
            {unreadCount}
          </span>
        )}
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-md shadow-lg py-2 z-50 max-h-96 overflow-y-auto">
          <h3 className="text-lg font-semibold px-4 pb-2 border-b border-gray-700 text-white">Notifications ({unreadCount} unread)</h3>
          {notifications.filter(n => n.isVisible).length === 0 ? (
            <p className="p-4 text-gray-400 text-sm">No new notifications.</p>
          ) : (
            notifications.filter(n => n.isVisible).map(notif => (
              <div key={notif.id} className={`px-4 py-3 border-b border-gray-700 ${!notif.read ? 'bg-indigo-900/20' : ''}`}>
                <div className="flex justify-between items-start">
                  <p className={`text-sm ${!notif.read ? 'font-bold text-white' : 'text-gray-300'}`}>{notif.message}</p>
                  <button onClick={() => clearNotification(notif.id)} className="text-gray-500 hover:text-red-400 text-xs ml-2">‚úñ</button>
                </div>
                <p className="text-xs text-gray-500 mt-1">{new Date(notif.timestamp).toLocaleString()} - {notif.sourceService}</p>
                {!notif.read && (
                  <button onClick={() => markAsRead(notif.id)} className="mt-2 text-xs text-blue-400 hover:underline">Mark as Read</button>
                )}
                {notif.actionUrl && (
                  <a href={notif.actionUrl} className="mt-2 text-xs text-purple-400 hover:underline block" target="_blank" rel="noopener noreferrer">View Details</a>
                )}
              </div>
            ))
          )}
          <div className="px-4 pt-2 border-t border-gray-700 flex justify-between">
            <button onClick={clearAllNotifications} className="text-xs text-gray-400 hover:text-white">Clear All</button>
            <button onClick={() => {/* Open notification preferences */}} className="text-xs text-gray-400 hover:text-white">Preferences</button>
          </div>
        </div>
      )}
    </div>
  );
};

export const GlobalSearch: React.FC = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const searchRef = useRef<HTMLDivElement>(null);
  const [isOpen, setIsOpen] = useState(false);

  useOutsideClick(searchRef, () => setIsOpen(false));

  const handleSearch = useCallback(async (term: string) => {
    if (term.length < 3) {
      setSearchResults([]);
      setLoading(false);
      return;
    }
    setLoading(true);
    setIsOpen(true);
    // Simulate a deep, federated search across all modules (projects, tasks, users, data, documents, code, etc.)
    return new Promise((resolve) => setTimeout(() => {
      const results = [
        { id: 'proj-xyz', type: 'Project', title: `Cosmic Nexus Project for "${term}"`, url: '/projects/xyz' },
        { id: 'doc-123', type: 'Document', title: `Analysis Report on "${term}"`, url: '/docs/123' },
        { id: 'task-abc', type: 'Task', title: `Implement "${term}" feature`, url: '/tasks/abc' },
        { id: 'user-456', type: 'User', title: `Profile of "${term}" (AI Expert)`, url: '/users/456' },
        { id: 'data-789', type: 'Dataset', title: `Real-time "${term}" Stream`, url: '/data/789' },
        { id: 'comp-101', type: 'AI Model', title: `Quantum NLP Model for "${term}"`, url: '/ai/models/101' },
        { id: 'asset-x1', type: 'Metaverse Asset', title: `Digital Land Plot for "${term}"`, url: '/metaverse/assets/x1' },
        { id: 'quantum-job-q4', type: 'Quantum Job', title: `Quantum Simulation for "${term}"`, url: '/quantum/jobs/q4' },
      ].filter(r => r.title.toLowerCase().includes(term.toLowerCase()));
      setSearchResults(results);
      setLoading(false);
      resolve(results);
    }, 800));
  }, []);

  const debouncedSearch = useMemo(() => {
    let timeoutId: NodeJS.Timeout;
    return (term: string) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => handleSearch(term), 300);
    };
  }, [handleSearch]);

  return (
    <div className="global-search relative flex-grow max-w-md mx-4" ref={searchRef}>
      <input
        type="text"
        placeholder="Search the Universe (projects, data, users, AI models, code...)"
        className="w-full p-2 pl-10 bg-gray-700 border border-gray-600 rounded-full text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
        value={searchTerm}
        onChange={(e) => {
          setSearchTerm(e.target.value);
          debouncedSearch(e.target.value);
        }}
        onFocus={() => setIsOpen(searchTerm.length > 0 || searchResults.length > 0)}
      />
      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>

      {isOpen && (searchTerm.length > 0 || searchResults.length > 0 || loading) && (
        <div className="absolute left-0 right-0 mt-2 bg-gray-800 border border-gray-700 rounded-md shadow-lg z-50 max-h-80 overflow-y-auto">
          {loading && <div className="p-3 text-center text-blue-400">Searching the cosmos...</div>}
          {!loading && searchResults.length === 0 && searchTerm.length > 0 && (
            <div className="p-3 text-gray-400">No results found for "{searchTerm}".</div>
          )}
          {!loading && searchResults.length > 0 && (
            <ul>
              {searchResults.map((result) => (
                <li key={result.id} className="border-b border-gray-700 last:border-b-0">
                  <a href={result.url} onClick={() => setIsOpen(false)} className="block p-3 hover:bg-gray-700 flex items-center space-x-2">
                    <span className="text-blue-400 font-medium text-sm">{result.type}:</span>
                    <span className="text-white text-sm">{result.title}</span>
                  </a>
                </li>
              ))}
            </ul>
          )}
        </div>
      )}
    </div>
  );
};


// --- Advanced Modules and Panels (The Universe's Specialized Systems) ---

interface CommunicationFeedWidgetProps {
  channelId: string;
}
export const CommunicationFeedWidget: React.FC<CommunicationFeedWidgetProps> = ({ channelId }) => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const { currentUser } = useContext(UserContext)!;

  useEffect(() => {
    // Simulate fetching messages for the channel
    if (currentUser && channelId) {
      setTimeout(() => {
        setMessages([
          { id: 'msg-1', senderId: 'user-2', timestamp: new Date(Date.now() - 3600000), content: 'Hello team, any updates on Project Omega?', readBy: [currentUser.id] },
          { id: 'msg-2', senderId: currentUser.id, timestamp: new Date(Date.now() - 1800000), content: 'Working on the quantum integration, almost done.', readBy: ['user-2'] },
          { id: 'msg-3', senderId: 'user-3', timestamp: new Date(Date.now() - 600000), content: 'AI insights show a potential bottleneck in data parsing.', readBy: [currentUser.id, 'user-2'], sentimentScore: -0.6 },
        ]);
      }, 500);
    }
  }, [currentUser, channelId]);

  const handleSendMessage = () => {
    if (newMessage.trim() && currentUser) {
      const message: Message = {
        id: `msg-${Date.now()}`,
        senderId: currentUser.id,
        timestamp: new Date(),
        content: newMessage,
        readBy: [],
      };
      setMessages((prev) => [...prev, message]);
      setNewMessage('');
      // Simulate API call to send message
    }
  };

  return (
    <div className="collaboration-feed bg-gray-900 rounded p-3 h-full flex flex-col border border-gray-700">
      <h4 className="font-semibold text-gray-300 mb-2">Channel: {channelId}</h4>
      <div className="flex-grow overflow-y-auto mb-3 space-y-2">
        {messages.length === 0 ? (
          <p className="text-gray-400">No messages yet. Start a conversation!</p>
        ) : (
          messages.map((msg) => (
            <div key={msg.id} className={`flex ${msg.senderId === currentUser?.id ? 'justify-end' : 'justify-start'}`}>
              <div className={`p-2 rounded-lg ${msg.senderId === currentUser?.id ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-100'}`}>
                <p className="text-xs font-semibold">{msg.senderId === currentUser?.id ? 'You' : msg.senderId}</p>
                <p className="text-sm">{msg.content}</p>
                <p className="text-xs text-gray-400 text-right">{new Date(msg.timestamp).toLocaleTimeString()}</p>
                {msg.sentimentScore && <span className="text-xs opacity-75">{msg.sentimentScore > 0 ? 'üòä' : 'üòû'}</span>}
              </div>
            </div>
          ))
        )}
      </div>
      <div className="flex">
        <input
          type="text"
          placeholder="Type your message..."
          className="flex-grow p-2 bg-gray-700 border border-gray-600 rounded-l text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
        />
        <button onClick={handleSendMessage} className="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-r transition-colors duration-200">Send</button>
      </div>
    </div>
  );
};

interface TaskTrackerWidgetProps {
  projectId?: string;
  userId?: string;
}
export const TaskTrackerWidget: React.FC<TaskTrackerWidgetProps> = ({ projectId, userId }) => {
  const [tasks, setTasks] = useState<TaskItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    setIsLoading(true);
    // Simulate fetching tasks based on projectId or userId
    setTimeout(() => {
      setTasks([
        { id: 'task-101', title: 'Refactor Quantum Entanglement Module', description: '', dueDate: new Date('2024-08-15'), priority: 'critical', status: 'in_progress', assignedTo: ['user-123'], tags: ['quantum', 'code'], progress: 75, attachments: [], comments: [], estimatedTimeMinutes: 240, timeSpentMinutes: 180, automatedSteps: [] },
        { id: 'task-102', title: 'Analyze Bio-Signal Anomaly Report', description: '', dueDate: new Date('2024-07-30'), priority: 'high', status: 'pending', assignedTo: ['user-123'], tags: ['bio-integration', 'research'], progress: 0, attachments: [], comments: [], estimatedTimeMinutes: 120, timeSpentMinutes: 0, automatedSteps: [] },
        { id: 'task-103', title: 'Prepare Metaverse Asset Audit', description: '', dueDate: new Date('2024-09-01'), priority: 'medium', status: 'completed', assignedTo: ['user-123'], tags: ['metaverse', 'audit'], progress: 100, attachments: [], comments: [], estimatedTimeMinutes: 360, timeSpentMinutes: 300, automatedSteps: [] },
      ]);
      setIsLoading(false);
    }, 800);
  }, [projectId, userId]);

  if (isLoading) return <div className="p-4 text-gray-400">Loading Tasks...</div>;
  if (tasks.length === 0) return <div className="p-4 text-gray-400">No tasks found for this context.</div>;

  return (
    <div className="task-tracker bg-gray-900 rounded p-3 h-full flex flex-col border border-gray-700">
      <h4 className="font-semibold text-gray-300 mb-2">My Active Tasks</h4>
      <div className="flex-grow overflow-y-auto space-y-3">
        {tasks.map(task => (
          <div key={task.id} className="bg-gray-800 p-3 rounded-lg border border-gray-700">
            <div className="flex justify-between items-center mb-1">
              <h5 className="font-semibold text-white">{task.title}</h5>
              <span className={`text-xs px-2 py-1 rounded-full ${task.status === 'in_progress' ? 'bg-blue-600' : task.status === 'pending' ? 'bg-yellow-600' : 'bg-green-600'}`}>
                {task.status.replace('_', ' ')}
              </span>
            </div>
            <p className="text-xs text-gray-400 mb-2">Due: {task.dueDate.toLocaleDateString()}</p>
            <div className="w-full bg-gray-600 rounded-full h-2.5">
              <div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${task.progress}%` }}></div>
            </div>
            <p className="text-xs text-right text-gray-400 mt-1">{task.progress}% Complete</p>
          </div>
        ))}
      </div>
      <button className="mt-4 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">View All Tasks</button>
    </div>
  );
};

export const CollaborationPanel: React.FC = () => {
  const [channels, setChannels] = useState<CommunicationChannel[]>([]);
  const [activeChannelId, setActiveChannelId] = useState<string | null>(null);
  const { currentUser } = useContext(UserContext)!;

  useEffect(() => {
    if (currentUser) {
      setChannels([
        { id: 'chat-1', name: 'Project Alpha Team', type: 'chat', participants: [currentUser.id, 'user-2', 'user-3'], messages: [], isEncrypted: true, settings: {}, moderators: [], historyRetentionDays: 365, aiSummarizationEnabled: true },
        { id: 'video-2', name: 'Daily Standup', type: 'video', participants: [currentUser.id, 'user-4'], messages: [], isEncrypted: true, settings: {}, moderators: [], historyRetentionDays: 90, aiSummarizationEnabled: false },
        { id: 'neural-3', name: 'Neural Consensus Link', type: 'neural_link', participants: [currentUser.id, 'ai_assistant_1'], messages: [], isEncrypted: true, settings: {}, moderators: [], historyRetentionDays: 7, aiSummarizationEnabled: true },
      ]);
    }
  }, [currentUser]);

  const activeChannel = channels.find(c => c.id === activeChannelId);

  return (
    <div className="collaboration-panel bg-gray-800 border border-gray-700 rounded-lg p-4 h-full flex flex-col shadow-xl">
      <h3 className="text-xl font-bold mb-4 text-white">Quantum Comms Nexus</h3>
      <div className="flex-grow flex space-x-4">
        <div className="w-1/4 border-r border-gray-700 pr-4">
          <h4 className="font-semibold text-gray-300 mb-2">Channels</h4>
          <ul>
            {channels.map(channel => (
              <li key={channel.id} className="mb-1">
                <button
                  onClick={() => setActiveChannelId(channel.id)}
                  className={`block w-full text-left p-2 rounded ${activeChannelId === channel.id ? 'bg-blue-700 text-white' : 'hover:bg-gray-700 text-gray-300'}`}
                >
                  {channel.name} ({channel.type === 'neural_link' ? 'üß† Neural' : channel.type === 'video' ? 'üìπ Video' : 'üí¨ Chat'})
                </button>
              </li>
            ))}
            <li className="mt-2"><button className="block w-full text-left p-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">‚ûï New Channel</button></li>
          </ul>
        </div>
        <div className="flex-grow flex flex-col">
          {activeChannel ? (
            <>
              <h4 className="font-semibold text-gray-300 mb-2">{activeChannel.name}</h4>
              <CommunicationFeedWidget channelId={activeChannel.id} />
              {activeChannel.aiSummarizationEnabled && (
                <div className="mt-2 text-xs text-gray-500">
                  <AIContentGenerator contentType="summary" contextData={{ channelId: activeChannel.id }} onContentGenerated={(c) => console.log('Channel summary:', c)} />
                </div>
              )}
            </>
          ) : (
            <p className="text-gray-400">Select a channel to view communications.</p>
          )}
        </div>
      </div>
    </div>
  );
};

export const ProjectManagementModule: React.FC = () => {
  const [projects, setProjects] = useState<Project[]>([]);
  const [selectedProjectId, setSelectedProjectId] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const { currentUser } = useContext(UserContext)!;

  useEffect(() => {
    if (currentUser) {
      setIsLoading(true);
      setTimeout(() => {
        setProjects([
          {
            id: 'proj-omega', name: 'Project Omega Rebirth', description: 'Rebuilding the core system with sentient AI and quantum infrastructure.', startDate: new Date('2023-01-01'), endDate: new Date('2024-12-31'),
            status: 'in_progress', ownerId: currentUser.id, teamIds: ['team-alpha'], budget: { allocated: 10000000, spent: 5000000, currency: 'USD', forecast: 12000000 }, milestones: [{ id: 'm1', name: 'Quantum Core Online', dueDate: new Date('2024-09-01'), completed: false }], risks: [], documents: [], tasks: [], aiGeneratedInsights: [],
            healthScore: 75, dependencies: [], governanceModel: 'centralized'
          },
          {
            id: 'proj-galore', name: 'Galactic Data Harvesting & Analysis', description: 'Expanding data ingestion from exoplanetary sensors and applying AI analysis.', startDate: new Date('2024-03-15'), endDate: new Date('2025-03-15'),
            status: 'pending', ownerId: currentUser.id, teamIds: ['team-beta'], budget: { allocated: 5000000, spent: 500000, currency: 'USD', forecast: 6000000 }, milestones: [], risks: [], documents: [], tasks: [], aiGeneratedInsights: [],
            healthScore: 90, dependencies: [], governanceModel: 'centralized'
          }
        ]);
        setIsLoading(false);
      }, 1000);
    }
  }, [currentUser]);

  const selectedProject = projects.find(p => p.id === selectedProjectId);

  if (isLoading) return <div className="p-4 text-gray-400">Loading Project Continuum...</div>;

  return (
    <div className="project-management-module bg-gray-800 border border-gray-700 rounded-lg p-4 h-full flex flex-col shadow-xl">
      <h3 className="text-xl font-bold mb-4 text-white">Project Continuum Navigator</h3>
      <div className="flex-grow flex space-x-4">
        <div className="w-1/3 border-r border-gray-700 pr-4">
          <h4 className="font-semibold text-gray-300 mb-2">Active Projects</h4>
          <ul>
            {projects.map(project => (
              <li key={project.id} className="mb-1">
                <button
                  onClick={() => setSelectedProjectId(project.id)}
                  className={`block w-full text-left p-2 rounded ${selectedProjectId === project.id ? 'bg-purple-700 text-white' : 'hover:bg-gray-700 text-gray-300'}`}
                >
                  {project.name} ({project.status}) <span className="float-right text-xs text-gray-400">Health: {project.healthScore}%</span>
                </button>
              </li>
            ))}
            <li className="mt-2"><button className="block w-full text-left p-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">‚ûï Create New Project</button></li>
          </ul>
        </div>
        <div className="flex-grow flex flex-col">
          {selectedProject ? (
            <div className="flex flex-col h-full">
              <h4 className="text-xl font-bold text-blue-400 mb-2">{selectedProject.name}</h4>
              <p className="text-sm text-gray-400 mb-4">{selectedProject.description}</p>

              <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div><strong className="text-gray-300">Status:</strong> <span className="text-green-400">{selectedProject.status}</span></div>
                <div><strong className="text-gray-300">Budget:</strong> ${selectedProject.budget.spent.toLocaleString()} / ${selectedProject.budget.allocated.toLocaleString()}</div>
                <div><strong className="text-gray-300">Start:</strong> {selectedProject.startDate.toLocaleDateString()}</div>
                <div><strong className="text-gray-300">End:</strong> {selectedProject.endDate.toLocaleDateString()}</div>
                <div className="col-span-2"><strong className="text-gray-300">Project Health:</strong> <span className="font-bold text-green-400">{selectedProject.healthScore}%</span></div>
              </div>

              <div className="flex-grow bg-gray-900 rounded p-3 overflow-y-auto border border-gray-700">
                <h5 className="font-semibold text-gray-300 mb-2">Tasks & Milestones</h5>
                <TaskTrackerWidget projectId={selectedProject.id} />

                <h5 className="font-semibold text-gray-300 mt-4 mb-2">AI Project Insights</h5>
                <AIInsightsEngine dashboardId={selectedProject.id} currentFilters={{ projectId: selectedProject.id }} onApplySuggestion={(s) => console.log('Applied:', s)} />
                <AIContentGenerator contentType="action_plan" contextData={{ projectId: selectedProject.id, description: selectedProject.description, currentStatus: selectedProject.status }} onContentGenerated={(c) => console.log('Generated action plan:', c)} />
              </div>

              <div className="mt-4 flex justify-end space-x-2">
                <button className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">View Full Project</button>
                <button className="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm">Edit Project</button>
              </div>
            </div>
          ) : (
            <p className="text-gray-400">Select a project to view its details and quantum-optimized insights.</p>
          )}
        </div>
      </div>
    </div>
  );
};

export const ResourceManagementSystem: React.FC = () => {
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    setIsLoading(true);
    setTimeout(() => {
      setAssets([
        { id: 'hw-001', name: 'Quantum CPU Cluster', type: 'hardware', ownerId: 'admin', currentValue: 1200000, acquisitionDate: new Date('2022-05-01'), status: 'active', location: 'Data Center Alpha-7', metadata: { cores: 128, qbits: 1024, cooling: 'cryogenic' }, environmentalImpactScore: 8 },
        { id: 'lic-007', name: 'AI Model License (Gen. 5)', type: 'license', ownerId: 'user-123', currentValue: 50000, acquisitionDate: new Date('2023-11-01'), status: 'active', metadata: { users: 1000, expiration: '2025-11-01' } },
        { id: 'nft-star', name: 'Digital Star Map NFT', type: 'digital_art', ownerId: 'user-123', currentValue: 15000, acquisitionDate: new Date('2024-01-20'), status: 'active', metadata: { artist: 'Cosmic Artist X', blockchain: 'MetaverseChain' }, blockchainRef: '0xNFT_Star_Map_Hash' },
        { id: 'data-lake-01', name: 'Galactic Sensor Data Lake', type: 'data', ownerId: 'admin', currentValue: 200000, acquisitionDate: new Date('2023-03-01'), status: 'active', location: 'Cloud Region Delta', metadata: { size_tb: 500, retention_policy: 'infinite' } },
        { id: 'biomaterial-x', name: 'Self-repairing Nanosubstrate', type: 'biomaterial', ownerId: 'bio_specialist_1', currentValue: 5000, acquisitionDate: new Date('2024-06-01'), status: 'in_storage', location: 'Bio-Lab Gamma', metadata: { composition: 'graphene_bio_polymer' } },
      ]);
      setIsLoading(false);
    }, 1200);
  }, []);

  if (isLoading) return <div className="p-4 text-gray-400">Loading Universal Resources...</div>;

  return (
    <div className="resource-management-system bg-gray-800 border border-gray-700 rounded-lg p-4 h-full flex flex-col shadow-xl">
      <h3 className="text-xl font-bold mb-4 text-white">Universal Resource Nexus</h3>
      <div className="flex-grow overflow-y-auto">
        {assets.length === 0 ? (
          <p className="text-gray-400">No assets managed.</p>
        ) : (
          <table className="min-w-full text-white table-auto">
            <thead>
              <tr className="border-b border-gray-700 text-left text-gray-400">
                <th className="p-2">Name</th>
                <th className="p-2">Type</th>
                <th className="p-2">Value</th>
                <th className="p-2">Status</th>
                <th className="p-2">Location/Ref</th>
                <th className="p-2">Impact</th>
              </tr>
            </thead>
            <tbody>
              {assets.map(asset => (
                <tr key={asset.id} className="border-b border-gray-700 hover:bg-gray-700">
                  <td className="p-2">{asset.name}</td>
                  <td className="p-2">{asset.type}</td>
                  <td className="p-2">${asset.currentValue.toLocaleString()}</td>
                  <td className="p-2">
                    <span className={`px-2 py-1 rounded-full text-xs ${asset.status === 'active' ? 'bg-green-600' : asset.status === 'maintenance' ? 'bg-yellow-600' : 'bg-red-600'}`}>
                      {asset.status}
                    </span>
                  </td>
                  <td className="p-2 text-sm">{asset.location || asset.blockchainRef || 'N/A'}</td>
                  <td className="p-2 text-sm">{asset.environmentalImpactScore ? `${asset.environmentalImpactScore}/10` : 'N/A'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
      <div className="mt-4 flex justify-end space-x-2">
        <button className="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm">‚ûï Add New Asset</button>
        <button className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">View Full Inventory</button>
        <button className="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">üåå Manage Interstellar Assets</button>
      </div>
    </div>
  );
};

interface QuantumComputingStatusWidgetProps {
  minimal?: boolean;
}
export const QuantumComputingStatusWidget: React.FC<QuantumComputingStatusWidgetProps> = ({ minimal = false }) => {
  const [status, setStatus] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [jobHistory, setJobHistory] = useState<any[]>([]);
  const { config } = useContext(GlobalConfigContext)!;

  useEffect(() => {
    if (!config.quantumSecurityEnabled) {
      setLoading(false);
      return;
    }
    const fetchStatus = async () => {
      setLoading(true);
      try {
        const result = await APIService.getQuantumJobResult('mock-quantum-job'); // Or a real ID
        setStatus(result);
        setJobHistory(prev => [{ timestamp: new Date(), ...result }, ...prev.slice(0, 4)]); // Keep last 5 jobs
      } catch (error) {
        console.error("Error fetching quantum status:", error);
        setStatus({ status: 'error', message: 'Failed to connect to quantum grid.' });
      } finally {
        setLoading(false);
      }
    };
    fetchStatus();
    const interval = setInterval(fetchStatus, 10000); // Refresh every 10 seconds
    return () => clearInterval(interval);
  }, [config.quantumSecurityEnabled]);

  if (!config.quantumSecurityEnabled) {
    return (
      <div className="quantum-status bg-gray-900 border border-red-700 rounded-lg p-4 text-red-400">
        <h3 className="text-xl font-bold mb-4">Quantum Grid Offline</h3>
        <p>Quantum computing features are currently disabled by global configuration.</p>
        <button className="mt-3 px-3 py-1 bg-red-700 hover:bg-red-800 rounded text-white text-sm" onClick={() => console.log('Request enable quantum')}>Request Activation</button>
      </div>
    );
  }

  if (loading) return <div className="p-4 text-blue-400">Establishing Quantum Link...</div>;

  if (minimal) {
    return (
      <div className="quantum-status-minimal bg-gray-900 border border-indigo-800 rounded-lg p-3 text-white text-sm">
        <p><strong className="text-indigo-300">Quantum Core:</strong> <span className={status?.status === 'completed' ? 'text-green-400' : 'text-yellow-400'}>{status?.status || 'N/A'}</span></p>
        <p><strong className="text-indigo-300">Qubits:</strong> {status?.result?.qubits || 'N/A'} | <strong className="text-indigo-300">Entanglement:</strong> {(status?.result?.entanglement_probability * 100).toFixed(1) || 'N/A'}%</p>
      </div>
    );
  }

  return (
    <div className="quantum-status bg-gradient-to-br from-gray-900 to-indigo-900 border border-indigo-700 rounded-lg p-4 shadow-2xl h-full flex flex-col">
      <h3 className="text-xl font-bold mb-4 text-cyan-400">Quantum Computing Nexus Status</h3>
      {status ? (
        <>
          <div className="grid grid-cols-2 gap-4 text-white">
            <div><strong className="text-indigo-300">Last Job ID:</strong> {status.jobId || 'N/A'}</div>
            <div><strong className="text-indigo-300">Status:</strong> <span className={`font-bold ${status.status === 'completed' ? 'text-green-400' : 'text-yellow-400'}`}>{status.status}</span></div>
            <div><strong className="text-indigo-300">Qubits Processed:</strong> {status.result?.qubits || 'N/A'}</div>
            <div><strong className="text-indigo-300">Entanglement P.:</strong> {(status.result?.entanglement_probability * 100).toFixed(2) || 'N/A'}%</div>
          </div>
          <div className="mt-4 flex-grow bg-gray-800 rounded p-3 overflow-y-auto border border-indigo-800">
            <h4 className="font-semibold text-indigo-300 mb-2">Recent Quantum Jobs</h4>
            {jobHistory.length > 0 ? (
              <ul>
                {jobHistory.map((job, index) => (
                  <li key={index} className="text-sm text-gray-400 mb-1 border-b border-gray-700 last:border-b-0 py-1">
                    [{new Date(job.timestamp).toLocaleTimeString()}] Job {job.jobId?.substring(0, 8)}... - Status: <span className={job.status === 'completed' ? 'text-green-400' : 'text-yellow-400'}>{job.status}</span>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-gray-500">No recent quantum jobs.</p>
            )}
          </div>
          <div className="mt-4 flex justify-end space-x-2">
            <button className="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded text-sm">‚¨ÜÔ∏è Submit Quantum Task</button>
            <button className="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">üî≠ Monitor Quantum Field</button>
          </div>
        </>
      ) : (
        <p className="text-gray-400">Quantum computing status unavailable. Attempting reconnection...</p>
      )}
    </div>
  );
};

interface BlockchainLedgerStatusWidgetProps {
  minimal?: boolean;
}
export const BlockchainLedgerStatusWidget: React.FC<BlockchainLedgerStatusWidgetProps> = ({ minimal = false }) => {
  const [status, setStatus] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchStatus = async () => {
      setLoading(true);
      try {
        const result = await APIService.getBlockchainLedgerStatus();
        setStatus(result);
      } catch (error) {
        console.error("Error fetching blockchain status:", error);
        setStatus({ status: 'error', message: 'Failed to connect to blockchain.' });
      } finally {
        setLoading(false);
      }
    };
    fetchStatus();
    const interval = setInterval(fetchStatus, 30000); // Refresh every 30 seconds
    return () => clearInterval(interval);
  }, []);

  if (loading) return <div className="p-4 text-gray-400">Syncing Universal Ledger...</div>;

  if (minimal) {
    return (
      <div className="blockchain-status-minimal bg-gray-900 border border-green-800 rounded-lg p-3 text-white text-sm">
        <p><strong className="text-green-300">Blockchain:</strong> <span className={status?.status === 'synced' ? 'text-green-400' : 'text-red-400'}>{status?.status || 'N/A'}</span></p>
        <p><strong className="text-green-300">Block Height:</strong> {status?.blockHeight || 'N/A'} | <strong className="text-green-300">TPS:</strong> {status?.transactionRate || 'N/A'}</p>
      </div>
    );
  }

  return (
    <div className="blockchain-ledger-status bg-gradient-to-br from-gray-900 to-green-900 border border-green-700 rounded-lg p-4 shadow-xl h-full flex flex-col">
      <h3 className="text-xl font-bold mb-4 text-lime-400">Universal Blockchain Ledger Status</h3>
      {status ? (
        <>
          <div className="grid grid-cols-2 gap-4 text-white">
            <div><strong className="text-green-300">Network:</strong> {status.network || 'N/A'}</div>
            <div><strong className="text-green-300">Status:</strong> <span className={`font-bold ${status.status === 'synced' ? 'text-green-400' : 'text-red-400'}`}>{status.status}</span></div>
            <div><strong className="text-green-300">Last Block:</strong> {status.lastBlock?.substring(0, 10) || 'N/A'}...</div>
            <div><strong className="text-green-300">Block Height:</strong> {status.blockHeight?.toLocaleString() || 'N/A'}</div>
            <div><strong className="text-green-300">Validator Count:</strong> {status.validatorCount?.toLocaleString() || 'N/A'}</div>
            <div><strong className="text-green-300">Transaction Rate:</strong> {status.transactionRate || 'N/A'}</div>
          </div>
          <div className="mt-4 flex justify-end space-x-2">
            <button className="px-3 py-2 bg-lime-600 hover:bg-lime-700 text-white rounded text-sm">View Transactions</button>
            <button className="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm">Mint NFT</button>
          </div>
        </>
      ) : (
        <p className="text-gray-400">Blockchain ledger status unavailable. Attempting connection...</p>
      )}
    </div>
  );
};


export const BioIntegrationHub: React.FC = () => {
  const { currentUser } = useContext(UserContext)!;
  const [heartRateData, setHeartRateData] = useState<MetricDataPoint[]>([]);
  const [sleepData, setSleepData] = useState<MetricDataPoint[]>([]);
  const [neuralActivity, setNeuralActivity] = useState<MetricDataPoint[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    if (!currentUser) return;
    setIsLoading(true);
    const fetchBioData = async () => {
      try {
        const hr = await APIService.fetchBioSignals(currentUser.id, 'heartRate', '24h');
        const sleep = await APIService.fetchBioSignals(currentUser.id, 'sleep', '7d');
        const neural = await APIService.fetchBioSignals(currentUser.id, 'neuralActivity', '1h');
        setHeartRateData(hr);
        setSleepData(sleep);
        setNeuralActivity(neural);
      } catch (error) {
        console.error("Error fetching bio signals:", error);
      } finally {
        setIsLoading(false);
      }
    };
    fetchBioData();
    const interval = setInterval(fetchBioData, 300000); // Refresh every 5 minutes
    return () => clearInterval(interval);
  }, [currentUser]);

  const handleNeuralLinkActivation = async () => {
    if (!currentUser) return;
    try {
      const response = await APIService.activateNeuralLink(currentUser.id);
      if (response.status === 'active') {
        alert('Neural Link Activated!');
        // Update user profile status
        useContext(UserContext)?.updateProfile({ neuralLinkStatus: 'active' });
      }
    } catch (error) {
      console.error("Failed to activate neural link:", error);
      alert('Failed to activate Neural Link.');
    }
  };


  if (!currentUser) return <div className="p-4 text-gray-400">Login to access Bio-Integration Hub.</div>;
  if (isLoading) return <div className="p-4 text-gray-400">Syncing Bio-Signatures...</div>;

  const currentHeartRate = heartRateData.length > 0 ? heartRateData[heartRateData.length - 1].value : 'N/A';
  const averageSleep = sleepData.length > 0 ? (sleepData.reduce((acc, curr) => acc + curr.value, 0) / sleepData.length).toFixed(1) : 'N/A';
  const currentMood = currentUser.healthMetrics?.mood?.[0]?.value || 3.5;
  const neuralLinkStatus = currentUser.neuralLinkStatus || 'inactive';

  return (
    <div className="bio-integration-hub bg-gradient-to-br from-green-900 to-teal-900 border border-teal-700 rounded-lg p-4 shadow-xl h-full flex flex-col">
      <h3 className="text-xl font-bold mb-4 text-green-300">Bio-Integrated Health & Wellness Core</h3>
      <div className="grid grid-cols-2 gap-4 text-white mb-4">
        <div className="bg-green-800 p-3 rounded-lg"><strong className="text-green-300">Current Heart Rate:</strong> {currentHeartRate} BPM</div>
        <div className="bg-green-800 p-3 rounded-lg"><strong className="text-green-300">Avg. Sleep (7D):</strong> {averageSleep} hours</div>
        <div className="bg-green-800 p-3 rounded-lg"><strong className="text-green-300">AI Mood Score:</strong> {currentMood.toFixed(1)}/5</div>
        <div className="bg-green-800 p-3 rounded-lg"><strong className="text-green-300">Neural Link:</strong> <span className={neuralLinkStatus === 'active' ? 'text-cyan-400' : 'text-yellow-400'}>{neuralLinkStatus.toUpperCase()}</span></div>
      </div>
      <div className="flex-grow bg-gray-900 rounded p-3 overflow-y-auto border border-teal-800">
        <h4 className="font-semibold text-green-300 mb-2">Detailed Bio-Signal Visualizations</h4>
        <DataVisualization
          data={heartRateData.map(d => ({ x: d.timestamp.getTime(), y: d.value }))}
          config={{ id: 'hr-viz', type: 'LineChart', title: 'Heart Rate', dataSources: ['biometrics'], refreshInterval: 60, filters: {}, visualizationType: 'lineGraph', layout: { x: 0, y: 0, w: 1, h: 1 }, permissions: ['standard'], telemetryEnabled: true }}
          height="150px"
        />
        <h4 className="font-semibold text-green-300 mt-4 mb-2">Neural Activity Patterns</h4>
        <DataVisualization
          data={neuralActivity.map(d => ({ x: d.timestamp.getTime(), y: d.value }))}
          config={{ id: 'neural-viz', type: 'AreaChart', title: 'Neural Activity', dataSources: ['biometrics'], refreshInterval: 10, filters: { metric: 'neuralActivity' }, visualizationType: 'areaChart', layout: { x: 0, y: 0, w: 1, h: 1 }, permissions: ['standard'], telemetryEnabled: true }}
          height="150px"
        />
      </div>
      <div className="mt-4 flex justify-end space-x-2">
        <button className="px-3 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded text-sm">üìà Full Health Report</button>
        {neuralLinkStatus === 'inactive' && (
          <button onClick={handleNeuralLinkActivation} className="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded text-sm">üß† Activate Neural Link</button>
        )}
        <button className="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">üßò AI Wellness Coach</button>
      </div>
    </div>
  );
};

export const MetaverseAssetViewer: React.FC = () => {
  const [assets, setAssets] = useState<Asset[]>([]);
  const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const { currentUser } = useContext(UserContext)!;

  useEffect(() => {
    if (currentUser) {
      setIsLoading(true);
      APIService.fetchMetaverseAssets(currentUser.id).then(fetchedAssets => {
        setAssets(fetchedAssets);
        if (fetchedAssets.length > 0) {
          setSelectedAsset(fetchedAssets[0]);
        }
        setIsLoading(false);
      });
    }
  }, [currentUser]);

  if (!currentUser) return <div className="p-4 text-gray-400">Login to access Metaverse Assets.</div>;
  if (isLoading) return <div className="p-4 text-gray-400">Loading Metaverse Assets...</div>;

  return (
    <div className="metaverse-asset-viewer bg-gradient-to-br from-blue-900 to-indigo-900 border border-blue-700 rounded-lg p-4 shadow-xl h-full flex flex-col">
      <h3 className="text-xl font-bold mb-4 text-cyan-300">Metaverse Asset Gateway</h3>
      {assets.length === 0 ? (
        <p className="text-gray-400">No Metaverse assets found. Begin your journey into the digital realm!</p>
      ) : (
        <div className="flex-grow flex space-x-4">
          <div className="w-1/4 border-r border-gray-700 pr-4">
            <h4 className="font-semibold text-gray-300 mb-2">My Assets</h4>
            <ul>
              {assets.map(asset => (
                <li key={asset.id} className="mb-1">
                  <button
                    onClick={() => setSelectedAsset(asset)}
                    className={`block w-full text-left p-2 rounded ${selectedAsset?.id === asset.id ? 'bg-blue-700 text-white' : 'hover:bg-gray-700 text-gray-300'}`}
                  >
                    {asset.name} ({asset.type === 'metaverse_land' ? 'üåé Land' : 'üñºÔ∏è NFT'})
                  </button>
                </li>
              ))}
              <li className="mt-2"><button className="block w-full text-left p-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white">‚ûï Acquire New Asset</button></li>
            </ul>
          </div>
          <div className="flex-grow flex flex-col">
            {selectedAsset ? (
              <>
                <p className="text-gray-300 mb-2">Viewing: <span className="font-semibold text-white">{selectedAsset.name}</span></p>
                <div className="flex-grow min-h-[300px] mb-4">
                  <HolographicProjection
                    modelUrl={`/models/${selectedAsset.id}.gltf`} // Assuming a model for each asset
                    interactionMode="manipulate"
                    onInteraction={(e) => console.log('Hologram interacted:', e)}
                  />
                </div>
                <div className="text-white text-sm">
                  <p><strong className="text-blue-300">Type:</strong> {selectedAsset.type}</p>
                  <p><strong className="text-blue-300">Current Value:</strong> ${selectedAsset.currentValue.toLocaleString()} (Fluctuating)</p>
                  <p><strong className="text-blue-300">Location:</strong> {selectedAsset.location || 'N/A'}</p>
                  <p><strong className="text-blue-300">Blockchain Ref:</strong> {selectedAsset.blockchainRef || 'N/A'}</p>
                  <p><strong className="text-blue-300">Status:</strong> {selectedAsset.status}</p>
                </div>
                <div className="mt-4 flex justify-end space-x-2">
                  <button className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">üåê Enter Metaverse</button>
                  <button className="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">üí∞ List for Sale</button>
                </div>
              </>
            ) : (
              <p className="text-gray-400">Select an asset to view its holographic projection.</p>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

export const DecentralizedGovernancePanel: React.FC = () => {
  const [proposals, setProposals] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const { currentUser } = useContext(UserContext)!;

  useEffect(() => {
    setIsLoading(true);
    setTimeout(() => {
      setProposals([
        { id: 'prop-001', title: 'Fund Interstellar Research Initiative', status: 'voting', eta: '3 days', votes: { yes: 1200, no: 300 }, description: 'Proposing allocation of 100M Universal Credits for deep space exploration and scientific breakthroughs.', type: 'funding' },
        { id: 'prop-002', title: 'Allocate compute for AI singularity defense', status: 'passed', eta: 'N/A', votes: { yes: 5000, no: 50 }, description: 'Passed proposal to establish a decentralized AI monitoring and defense grid.', type: 'security' },
        { id: 'prop-003', title: 'Upgrade core quantum infrastructure', status: 'pending', eta: '7 days', votes: { yes: 100, no: 10 }, description: 'Awaiting review: Proposal to invest in the next generation of quantum processors for the Universal Grid.', type: 'infrastructure' },
        { id: 'prop-004', title: 'Implement universal basic digital income', status: 'voting', eta: '5 days', votes: { yes: 800, no: 600 }, description: 'Proposal for a token-based universal basic income system for all registered users.', type: 'social' },
      ]);
      setIsLoading(false);
    }, 800);
  }, []);

  if (!currentUser) return <div className="p-4 text-gray-400">Login to participate in Decentralized Governance.</div>;
  if (isLoading) return <div className="p-4 text-gray-400">Loading DAO Proposals from the Universal Ledger...</div>;

  const handleVote = async (proposalId: string, vote: 'yes' | 'no') => {
    alert(`Voting ${vote} on proposal ${proposalId}. This would interact with a blockchain wallet.`);
    // Simulate API call to record vote
    // await APIService.submitDAOVote(proposalId, currentUser.id, vote);
  };

  const handleCreateProposal = async () => {
    const title = prompt('Enter new proposal title:');
    if (title) {
      const newProposal = {
        title,
        description: 'AI-generated description based on user input for a new governance proposal.',
        status: 'pending',
        type: 'general',
        ownerId: currentUser.id,
      };
      const result = await APIService.submitDAOProposal(newProposal);
      alert(`Proposal "${title}" submitted with ID: ${result.proposalId}`);
      // Refresh proposals
    }
  };

  return (
    <div className="decentralized-governance-panel bg-gradient-to-br from-purple-900 to-red-900 border border-purple-700 rounded-lg p-4 shadow-xl h-full flex flex-col">
      <h3 className="text-xl font-bold mb-4 text-pink-300">Decentralized Governance Nexus (DAO)</h3>
      <p className="text-gray-300 mb-4">Participate in the self-organization of the entire ecosystem.</p>
      <div className="flex-grow overflow-y-auto">
        {proposals.length === 0 ? (
          <p className="text-gray-400">No active governance proposals.</p>
        ) : (
          <ul className="space-y-4">
            {proposals.map(proposal => (
              <li key={proposal.id} className="bg-gray-800 p-4 rounded-lg border border-purple-800">
                <h4 className="font-semibold text-lg text-white mb-1">{proposal.title}</h4>
                <p className="text-sm text-gray-400">{proposal.description}</p>
                <p className="text-sm text-gray-400 mt-2">Status: <span className={proposal.status === 'voting' ? 'text-yellow-400' : 'text-green-400'}>{proposal.status}</span></p>
                <p className="text-sm text-gray-400">Votes: Yes <span className="text-green-300 font-bold">{proposal.votes.yes}</span> / No <span className="text-red-300 font-bold">{proposal.votes.no}</span></p>
                <p className="text-sm text-gray-400">ETA: {proposal.eta}</p>
                {proposal.status === 'voting' && (
                  <div className="mt-3 flex space-x-2">
                    <button onClick={() => handleVote(proposal.id, 'yes')} className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs">Vote Yes</button>
                    <button onClick={() => handleVote(proposal.id, 'no')} className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">Vote No</button>
                    <button className="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-xs">View Details</button>
                  </div>
                )}
              </li>
            ))}
          </ul>
        )}
      </div>
      <div className="mt-4 flex justify-end">
        <button onClick={handleCreateProposal} className="px-3 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded text-sm">‚ûï Create New Proposal</button>
      </div>
    </div>
  );
};

export const AIServiceStudio: React.FC = () => {
  const [models, setModels] = useState<AiModel[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const { currentUser } = useContext(UserContext)!;

  useEffect(() => {
    setIsLoading(true);
    setTimeout(() => {
      setModels([
        { id: 'nlp-v1', name: 'Universal NLP Processor', version: '1.0', type: 'NLP', status: 'deployed', trainingDataSizeGB: 5000, performanceMetrics: { accuracy: 0.92, precision: 0.9, recall: 0.91, f1Score: 0.91, inferenceLatencyMs: 50 }, ownerId: 'admin', accessControl: [], costPerInferenceUnit: 0.001, quantumOptimized: false },
        { id: 'pred-v2', name: 'Galactic Trend Predictor', version: '2.1', type: 'Predictive', status: 'training', trainingDataSizeGB: 10000, performanceMetrics: { accuracy: 0.88, precision: 0.85, recall: 0.87, f1Score: 0.86, inferenceLatencyMs: 120 }, ownerId: currentUser?.id || 'user-123', accessControl: [], costPerInferenceUnit: 0.005, quantumOptimized: true },
      ]);
      setIsLoading(false);
    }, 1000);
  }, [currentUser]);

  const handleTrainModel = async (modelId: string) => {
    alert(`Initiating training for model: ${modelId}`);
    const result = await APIService.submitAIModelForTraining({ modelId, config: {} }, { data: 'new_dataset' });
    console.log(result);
  };

  const handleDeployModel = async (modelId: string) => {
    alert(`Deploying model: ${modelId}`);
    const result = await APIService.deployAIModel(modelId, 'production');
    console.log(result);
  };

  if (!currentUser) return <div className="p-4 text-gray-400">Login to access AI Studio.</div>;
  if (isLoading) return <div className="p-4 text-gray-400">Loading AI Model Registry...</div>;

  return (
    <div className="ai-service-studio bg-gray-800 border border-gray-700 rounded-lg p-4 h-full flex flex-col shadow-xl">
      <h3 className="text-xl font-bold mb-4 text-white">AI Model Training & Deployment Studio</h3>
      <p className="text-gray-300 mb-4">Manage your custom AI models, retrain existing ones with new data streams from the universe, and deploy them across various modules. Integrate with quantum hardware for accelerated training.</p>

      <div className="flex-grow overflow-y-auto space-y-4">
        {models.length === 0 ? (
          <p className="text-gray-400">No AI models registered.</p>
        ) : (
          models.map(model => (
            <div key={model.id} className="bg-gray-900 p-4 rounded-lg border border-blue-700">
              <div className="flex justify-between items-center mb-2">
                <h4 className="font-semibold text-lg text-blue-300">{model.name} ({model.version})</h4>
                <span className={`px-2 py-1 rounded-full text-xs ${model.status === 'deployed' ? 'bg-green-600' : model.status === 'training' ? 'bg-yellow-600' : 'bg-red-600'}`}>
                  {model.status.replace('_', ' ')}
                </span>
              </div>
              <p className="text-sm text-gray-400 mb-2">Type: {model.type} | Quantum Optimized: {model.quantumOptimized ? 'Yes' : 'No'}</p>
              <p className="text-sm text-gray-400">Accuracy: {(model.performanceMetrics.accuracy * 100).toFixed(1)}% | Latency: {model.performanceMetrics.inferenceLatencyMs}ms</p>
              <div className="mt-3 flex space-x-2">
                <button onClick={() => handleTrainModel(model.id)} disabled={model.status === 'training'} className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-xs disabled:opacity-50">üß™ Retrain Model</button>
                <button onClick={() => handleDeployModel(model.id)} disabled={model.status !== 'training'} className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs disabled:opacity-50">üöÄ Deploy Model</button>
                <button className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs">üåå Quantum AI Sandbox</button>
              </div>
            </div>
          ))
        )}
      </div>
      <div className="mt-4 flex justify-end">
        <button className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">‚ûï Register New Model</button>
      </div>
    </div>
  );
};


// --- The Dashboard Component (The Universe Itself) ---

export const Dashboard: React.FC = () => {
  const { currentUser, isAuthenticated } = useContext(UserContext)!;
  const { theme, setTheme, generateTheme } = useContext(ThemeContext)!;
  const { config, updateConfig, getFeatureFlag, getSetting } = useContext(GlobalConfigContext)!;

  const [currentLayout, setCurrentLayout] = useState<DashboardLayout | null>(null);
  const [isWidgetCatalogOpen, setIsWidgetCatalogOpen] = useState(false);
  const [isGlobalSettingsOpen, setIsGlobalSettingsOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<'overview' | 'projects' | 'resources' | 'quantum' | 'bio' | 'metaverse' | 'governance' | 'ai_studio' | 'security' | 'learning'>('overview');
  const [layoutNeedsSaving, setLayoutNeedsSaving] = useState(false);

  // Initialize a default layout if none exists
  useEffect(() => {
    if (isAuthenticated && !currentLayout && currentUser) {
      APIService.fetchDashboardLayouts(currentUser.id).then(layouts => {
        if (layouts.length > 0) {
          setCurrentLayout(layouts[0]);
        } else {
          // Create a default initial layout
          const defaultLayout: DashboardLayout = {
            id: 'default-user-layout',
            name: 'My Universal Dashboard',
            ownerId: currentUser.id,
            sharedWith: [],
            version: 1,
            isPublic: false,
            theme: theme,
            globalFilters: {},
            aiGenerated: false,
            lastModified: new Date(),
            changeLog: [],
            performanceMetrics: { loadTime: 0, apiCalls: 0, renderErrors: 0 },
            accessControlList: [],
            spatialConfig: { mode: '2D', environment: 'default' },
            widgets: [
              { id: 'widget-ai-1', type: 'AIRecommendationPanel', title: 'AI Cognitive Insights', layout: { x: 0, y: 0, w: 4, h: 2 }, dataSources: ['internal_data', 'external_feeds'], refreshInterval: 300, filters: {}, visualizationType: 'textList', permissions: ['standard'], telemetryEnabled: true },
              { id: 'widget-hr-1', type: 'BioSignalGraph', title: 'Real-time Heart Rate', layout: { x: 4, y: 0, w: 4, h: 2 }, dataSources: ['bio_signals'], refreshInterval: 10, filters: { metric: 'heartRate' }, visualizationType: 'lineGraph', permissions: ['standard'], telemetryEnabled: true },
              { id: 'widget-block-1', type: 'BlockchainStatus', title: 'Blockchain Ledger Status', layout: { x: 8, y: 0, w: 4, h: 2 }, dataSources: ['blockchain'], refreshInterval: 60, filters: {}, visualizationType: 'textPanel', permissions: ['developer'], telemetryEnabled: true },
              { id: 'widget-tasks-1', type: 'TaskTracker', title: 'My Active Tasks', layout: { x: 0, y: 2, w: 6, h: 3 }, dataSources: ['project_tasks'], refreshInterval: 120, filters: { assignedTo: currentUser.id, status: 'in_progress' }, visualizationType: 'table', permissions: ['standard'], telemetryEnabled: true },
              { id: 'widget-comm-1', type: 'CommunicationFeed', title: 'Team Comms', layout: { x: 6, y: 2, w: 6, h: 3 }, dataSources: ['communication'], refreshInterval: 5, filters: { channelId: 'proj-alpha' }, visualizationType: 'chatFeed', permissions: ['standard'], telemetryEnabled: true },
            ]
          };
          setCurrentLayout(defaultLayout);
          APIService.saveDashboardLayout(defaultLayout);
        }
      });
    }
  }, [isAuthenticated, currentLayout, currentUser, theme]);

  const handleLayoutChange = (layoutId: string) => {
    if (layoutId === 'new') {
      const newLayout: DashboardLayout = {
        id: `layout-${Date.now()}`,
        name: `New Custom Layout ${Date.now()}`,
        ownerId: currentUser?.id || 'anonymous',
        sharedWith: [],
        version: 1,
        isPublic: false,
        theme: theme,
        globalFilters: {},
        aiGenerated: false,
        lastModified: new Date(),
        changeLog: [],
        performanceMetrics: { loadTime: 0, apiCalls: 0, renderErrors: 0 },
        accessControlList: [],
        spatialConfig: { mode: '2D', environment: 'default' },
        widgets: []
      };
      setCurrentLayout(newLayout);
      setLayoutNeedsSaving(true);
    } else {
      if (currentUser) {
        APIService.fetchDashboardLayouts(currentUser.id).then(layouts => {
          const selected = layouts.find(l => l.id === layoutId);
          if (selected) setCurrentLayout(selected);
        });
      }
    }
  };

  const handleSaveLayout = async () => {
    if (currentLayout) {
      await APIService.saveDashboardLayout(currentLayout);
      setLayoutNeedsSaving(false);
      alert('Layout saved successfully!');
    }
  };

  const handleShareLayout = () => {
    alert('Advanced layout sharing (user groups, public links, permission levels) coming soon!');
  };

  const handleAddWidget = (widgetType: string) => {
    if (!currentLayout) return;

    const newWidget: WidgetConfig = {
      id: `widget-${Date.now()}`,
      type: widgetType,
      title: `${widgetType} Widget`,
      layout: { x: (currentLayout.widgets.length % 3) * 4, y: Math.floor(currentLayout.widgets.length / 3) * 2, w: 4, h: 2 }, // Simple auto-layout
      dataSources: ['dynamic_source'],
      refreshInterval: 60,
      filters: {},
      visualizationType: 'defaultChart',
      permissions: ['standard'],
      telemetryEnabled: true,
    };

    setCurrentLayout(prev => prev ? { ...prev, widgets: [...prev.widgets, newWidget] } : null);
    setIsWidgetCatalogOpen(false);
    setLayoutNeedsSaving(true);
  };

  const handleRemoveWidget = (widgetId: string) => {
    if (currentLayout) {
      setCurrentLayout(prev => prev ? { ...prev, widgets: prev.widgets.filter(w => w.id !== widgetId) } : null);
      setLayoutNeedsSaving(true);
    }
  };

  const handleEditWidget = (editedWidget: WidgetConfig) => {
    if (currentLayout) {
      setCurrentLayout(prev => prev ? { ...prev, widgets: prev.widgets.map(w => w.id === editedWidget.id ? editedWidget : w) } : null);
      setLayoutNeedsSaving(true);
    }
  };

  const handleDataRefresh = (widgetId: string) => {
    // This could trigger an individual widget data fetch or just re-render
    console.log(`Manually refreshing data for widget ${widgetId}`);
  };

  const handleCustomizeTheme = () => {
    const themes: DashboardLayout['theme'][] = ['light', 'dark', 'holographic', 'neon', 'cyberpunk', 'quantum_matrix', 'bio_lumina'];
    const currentIndex = themes.indexOf(theme);
    const nextIndex = (currentIndex + 1) % themes.length;
    setTheme(themes[nextIndex]);
    if (currentLayout) { // Update layout theme as well
      setCurrentLayout(prev => prev ? { ...prev, theme: themes[nextIndex] } : null);
      setLayoutNeedsSaving(true);
    }
    alert(`Theme changed to ${themes[nextIndex]}!`);
  };

  if (!isAuthenticated) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
        <div className="text-center">
          <h2 className="text-4xl font-bold mb-4">Welcome to the Universe Dashboard</h2>
          <p className="text-xl mb-6">Please log in to access your cosmic control panel.</p>
          <button className="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-lg font-semibold"
            onClick={() => useContext(UserContext)!.login({ username: 'test', password: 'password' })}>
            Access the Universe
          </button>
        </div>
      </div>
    );
  }

  if (!currentLayout) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
        <div className="text-center">
          <h2 className="text-3xl font-bold mb-4 animate-pulse">Initializing Universal Dashboard...</h2>
          <p className="text-lg">Preparing your personalized cosmos interface.</p>
        </div>
      </div>
    );
  }

  const gridClass = `grid grid-cols-12 gap-6 p-6 min-h-[calc(100vh-64px)] overflow-auto`;

  return (
    <div className={`universe-dashboard-container bg-gradient-to-br from-gray-950 to-black text-white min-h-screen ${theme}`}>
      <DashboardHeader
        currentLayout={currentLayout}
        onLayoutChange={handleLayoutChange}
        onSaveLayout={handleSaveLayout}
        onShareLayout={handleShareLayout}
        onAddWidgetClick={() => setIsWidgetCatalogOpen(true)}
        onCustomizeTheme={handleCustomizeTheme}
        onOpenGlobalSettings={() => setIsGlobalSettingsOpen(true)}
      />

      <div className="dashboard-content flex">
        <aside className="w-16 hover:w-64 transition-all duration-300 bg-gray-900 border-r border-gray-700 flex flex-col py-4 px-2 sticky top-16 h-[calc(100vh-64px)] overflow-y-auto z-40 group">
          <nav>
            <ul>
              <li className="mb-2">
                <button onClick={() => setActiveTab('overview')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'overview' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üè†</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Overview</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('projects')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'projects' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üìä</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Projects & Tasks</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('resources')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'resources' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üì¶</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Resource Management</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('quantum')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'quantum' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">‚öõÔ∏è</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Quantum Computing</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('bio')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'bio' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üß¨</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Bio-Integration Hub</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('metaverse')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'metaverse' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üåê</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Metaverse Gateway</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('governance')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'governance' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üèõÔ∏è</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Decentralized Governance</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('ai_studio')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'ai_studio' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üß†</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">AI Studio</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('security')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'security' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üö®</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Security Operations</span>
                </button>
              </li>
              <li className="mb-2">
                <button onClick={() => setActiveTab('learning')} className={`flex items-center w-full p-2 rounded group-hover:justify-start ${activeTab === 'learning' ? 'bg-blue-700 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                  <span className="text-2xl">üéì</span>
                  <span className="ml-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap">Learning & Development</span>
                </button>
              </li>
            </ul>
          </nav>
          <div className="mt-auto pt-4 border-t border-gray-700">
            {/* <GlobalConfigControls /> */} {/* Moved to a modal for better UX */}
          </div>
        </aside>

        <main className="flex-grow">
          {layoutNeedsSaving && (
            <div className="bg-yellow-800 text-yellow-100 p-2 text-center text-sm">
              You have unsaved changes to your layout. <button onClick={handleSaveLayout} className="underline font-bold ml-2">Save Now</button>
            </div>
          )}

          {activeTab === 'overview' && (
            <div className={gridClass}>
              {getFeatureFlag('enableAIRecommendationEngine') && (
                <div className="col-span-12">
                  <AIInsightsEngine dashboardId={currentLayout.id} currentFilters={currentLayout.globalFilters} onApplySuggestion={(s) => console.log('AI Suggested:', s)} />
                </div>
              )}

              {currentLayout.widgets.length === 0 ? (
                <div className="col-span-12 text-center py-10 text-gray-400 text-xl">
                  Your dashboard is empty! Click "‚ûï Widget" in the header to populate your universe.
                </div>
              ) : (
                currentLayout.widgets.map(widget => (
                  <DraggableWidget
                    key={widget.id}
                    widget={widget}
                    onRemove={handleRemoveWidget}
                    onEdit={handleEditWidget}
                    onDataRefresh={handleDataRefresh}
                  />
                ))
              )}

              {getSetting('holographicModeAvailable') && (
                <div className="col-span-12 mt-8">
                  <h3 className="text-xl font-bold mb-3 text-cyan-400">Advanced Visualizations</h3>
                  <HolographicProjection modelUrl="/models/universe_model.gltf" interactionMode="view" onInteraction={() => {}} />
                  {/* SpatialAudioControl is embedded within HolographicProjection for better context */}
                </div>
              )}
            </div>
          )}

          {activeTab === 'projects' && (
            <div className="p-6 h-full">
              <ProjectManagementModule />
            </div>
          )}

          {activeTab === 'resources' && (
            <div className="p-6 h-full">
              <ResourceManagementSystem />
            </div>
          )}

          {activeTab === 'quantum' && (
            <div className="p-6 h-full">
              <QuantumComputingStatusWidget />
            </div>
          )}

          {activeTab === 'bio' && (
            <div className="p-6 h-full">
              <BioIntegrationHub />
            </div>
          )}

          {activeTab === 'metaverse' && (
            <div className="p-6 h-full">
              <MetaverseAssetViewer />
            </div>
          )}

          {activeTab === 'governance' && (
            <div className="p-6 h-full">
              <DecentralizedGovernancePanel />
            </div>
          )}

          {activeTab === 'ai_studio' && (
            <div className="p-6 h-full">
              <AIServiceStudio />
            </div>
          )}

          {activeTab === 'security' && (
            <div className="p-6 h-full bg-gray-800 border border-red-700 rounded-lg shadow-xl text-white">
              <h3 className="text-2xl font-bold mb-4 text-red-400">Universal Security Operations Center (USOC)</h3>
              <p className="mb-4 text-gray-300">
                Real-time threat detection, anomaly analysis (powered by Quantum AI), compliance monitoring, and incident response across the entire ecosystem.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-gray-900 p-4 rounded-lg border border-red-800">
                  <h4 className="text-xl font-semibold mb-2 text-red-300">Threat Alerts</h4>
                  <p className="text-sm text-gray-400">Latest threat intelligence feed and high-priority alerts.</p>
                  <ul className="mt-3 space-y-2 text-sm">
                    <li>üö® High Severity: Unauthorized Quantum Entanglement Attempt (Sector Gamma-5)</li>
                    <li>‚ö†Ô∏è Medium Severity: Anomalous Data Ingress (Exoplanet Sensor Net)</li>
                    <li>‚úÖ Low Severity: Routine Security Patch Applied (Dashboard Core)</li>
                  </ul>
                  <button className="mt-4 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm">View Full Threat Log</button>
                </div>
                <div className="bg-gray-900 p-4 rounded-lg border border-yellow-800">
                  <h4 className="text-xl font-semibold mb-2 text-yellow-300">Compliance & Audit</h4>
                  <p className="text-sm text-gray-400">Ensure adherence to Universal Data Sovereignty and Ethical AI Guidelines.</p>
                  <ul className="mt-3 space-y-2 text-sm">
                    <li>‚úîÔ∏è Universal Data Privacy Standard (UDPS) - Compliant</li>
                    <li>‚úîÔ∏è Ethical AI Framework (EAIF) - Audit Pending (Q4)</li>
                    <li>‚ùå Quantum Computing Usage Policy (QCUP) - Review Needed</li>
                  </ul>
                  <button className="mt-4 px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm">Run Compliance Scan</button>
                </div>
                <div className="col-span-full">
                  <AIContentGenerator contentType="action_plan" contextData={{ securityIncident: true }} onContentGenerated={(c) => alert('AI Generated Incident Response Plan!')} />
                </div>
              </div>
            </div>
          )}

          {activeTab === 'learning' && (
            <div className="p-6 h-full bg-gray-800 border border-purple-700 rounded-lg shadow-xl text-white">
              <h3 className="text-2xl font-bold mb-4 text-purple-400">Universal Learning & Development Nexus</h3>
              <p className="mb-4 text-gray-300">
                Access personalized learning paths, interactive simulations, and expert-led modules to master new skills for the evolving universe.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-gray-900 p-4 rounded-lg border border-purple-800">
                  <h4 className="text-xl font-semibold mb-2 text-purple-300">My Learning Paths</h4>
                  <p className="text-sm text-gray-400">Continue your journey through recommended skill development.</p>
                  <ul className="mt-3 space-y-2 text-sm">
                    <li>üìö Quantum Computing 101 (80% Complete)</li>
                    <li>üìö Advanced AI Ethics & Governance (30% Complete)</li>
                    <li>üìö Metaverse Architecture Principles (New!)</li>
                  </ul>
                  <button className="mt-4 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm">View All Paths</button>
                </div>
                <div className="bg-gray-900 p-4 rounded-lg border border-pink-800">
                  <h4 className="text-xl font-semibold mb-2 text-pink-300">Skill Gap Analysis (AI Powered)</h4>
                  <p className="text-sm text-gray-400">Your profile suggests you need to develop in:</p>
                  <ul className="mt-3 space-y-2 text-sm">
                    <li>‚≠ê Neuro-Linguistic Programming (NLP)</li>
                    <li>‚≠ê Decentralized Autonomous Organization (DAO) Management</li>
                    <li>‚≠ê Bio-Neural Interface Engineering</li>
                  </ul>
                  <button className="mt-4 px-3 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded text-sm">Generate Custom Path</button>
                </div>
                <div className="col-span-full">
                  <AIInsightsEngine dashboardId="learning-nexus" currentFilters={{ userId: currentUser?.id }} onApplySuggestion={(s) => alert(`AI suggested: ${s}`)} />
                </div>
              </div>
            </div>
          )}
        </main>
      </div>

      {isWidgetCatalogOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]"> {/* Higher z-index for modals */}
          <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-11/12 md:w-3/4 lg:w-1/2 relative">
            <button onClick={() => setIsWidgetCatalogOpen(false)} className="absolute top-3 right-3 text-gray-400 hover:text-white text-xl">
              ‚úñ
            </button>
            <WidgetCatalog onAddWidget={handleAddWidget} />
          </div>
        </div>
      )}

      {isGlobalSettingsOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100]">
          <div className="bg-gray-900 border border-gray-700 rounded-lg p-6 w-11/12 md:w-1/2 lg:w-1/3 relative">
            <button onClick={() => setIsGlobalSettingsOpen(false)} className="absolute top-3 right-3 text-gray-400 hover:text-white text-xl">
              ‚úñ
            </button>
            <GlobalConfigControls />
          </div>
        </div>
      )}

      <footer className="bg-gray-900 text-gray-500 text-xs p-2 text-center border-t border-gray-700 fixed bottom-0 w-full z-50">
        Universe OS v{config.dashboardVersion} | Status: <span className="text-green-500">All Systems Nominal</span> | Quantum Security: {config.quantumSecurityEnabled ? <span className="text-green-500">ACTIVE</span> : <span className="text-yellow