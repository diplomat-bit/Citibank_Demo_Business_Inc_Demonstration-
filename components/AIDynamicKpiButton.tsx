import React, { useState, useContext, useEffect, useCallback, useMemo, useRef } from 'react';
import { DataContext } from '../context/DataContext';
import Card from './Card';

// Original SparklesIcon - DO NOT REMOVE
const SparklesIcon: React.FC<{className?: string}> = ({className}) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.25 21.75l-.648-1.178a3.375 3.375 0 00-2.456-2.456L12 17.25l1.178-.648a3.375 3.375 0 002.456-2.456L16.25 13.5l.648 1.178a3.375 3.375 0 002.456 2.456L20.25 18l-1.178.648a3.375 3.375 0 00-2.456 2.456z" />
    </svg>
);

// --- New Core Interfaces, Enums, and Types ---

/**
 * Represents the detailed definition of an AI-generated KPI.
 * This has evolved significantly over 10 years to include complex attributes.
 */
export interface KpiDefinition {
    id: string;
    title: string;
    description: string;
    querySpec: {
        dataSourceId: string; // The ID of the data source this KPI pulls from
        metrics: string[]; // List of metrics to aggregate
        dimensions: string[]; // List of dimensions to slice and dice by
        filters: Record<string, any>; // Complex filter conditions
        timeRange: string; // E.g., "last_month", "Q1_2024", "custom_date_range"
        aggregationMethod: string; // E.g., "SUM", "AVG", "COUNT_DISTINCT"
        advancedAnalytics?: { // AI-driven advanced analytics configurations
            type: 'trend' | 'anomaly_detection' | 'forecasting' | 'correlation' | 'sentiment' | 'causal_inference';
            config: Record<string, any>;
        };
    };
    visualizationPreferences: { // AI-suggested or user-defined visualization
        type: 'line' | 'bar' | 'pie' | 'scatter' | 'gauge' | 'geographic_map' | 'network_graph' | 'treemap';
        colorScheme: string;
        alertThresholds?: { // AI-recommended alert thresholds
            critical: number | string;
            warning: number | string;
        };
    };
    governance: { // AI-assisted governance and compliance
        ownerId: string;
        accessControl: 'private' | 'public' | 'shared_group';
        complianceTags: string[]; // E.g., "GDPR_compliant", "HIPAA_ready", "financial_reporting"
        auditLogRef: string; // Reference to detailed audit trail
    };
    version: number; // For tracking KPI evolution
    createdAt: number;
    updatedAt: number;
    aiConfidenceScore: number; // AI's confidence in the generated KPI definition
    aiValidationStatus: 'pending' | 'validated' | 'requires_review' | 'rejected'; // AI's validation of data and logic
    feedbackScores: { // User feedback on KPI accuracy/usefulness
        relevance: number; // 1-5
        accuracy: number; // 1-5
        usability: number; // 1-5
    };
    cognitiveInsights?: { // Higher-order insights generated by AI
        primaryInsight: string;
        secondaryInsights: string[];
        actionableRecommendations: string[]; // Prescriptive actions
        causalFactors: string[]; // Root causes identified by AI
    };
}

/**
 * Represents a historical entry in the AI conversation.
 */
export interface AIInteractionHistoryEntry {
    speaker: 'user' | 'ai';
    timestamp: number;
    message: string;
    context?: Record<string, any>; // Additional context about the interaction
}

/**
 * Configuration for an AI model.
 */
export interface AIModelConfig {
    id: string;
    name: string;
    description: string;
    capabilities: string[]; // E.g., 'NLP', 'forecasting', 'anomaly_detection'
    costPerQuery: number;
    latencyMs: number;
    version: string;
    provider: string; // E.g., 'Internal_QuantumEngine', 'OpenAI_GPT-4.0-Omni', 'Anthropic_Claude-3.5-Sonnet'
    performanceMetrics: {
        accuracy: number;
        f1Score?: number;
    };
}

/**
 * Configuration for an integrated data source.
 */
export interface AIDataSourceConfig {
    id: string;
    name: string;
    type: 'database' | 'api' | 'file_upload' | 'streaming' | 'CRM' | 'ERP' | 'social_media';
    status: 'connected' | 'disconnected' | 'auth_error' | 'transform_needed';
    lastSync: number;
    schemaPreview: Record<string, string>; // {column_name: data_type}
    dataQualityScore: number; // AI-assessed data quality (0-100)
    securityLevel: 'low' | 'medium' | 'high' | 'classified'; // AI-assessed security level
    dataGovernancePolicy: string[]; // E.g., "PII_redacted", "anonymized", "public_data"
}

/**
 * Enum for the different stages of the AI KPI generation process.
 */
export enum AIPromptStage {
    INITIAL_PROMPT = 'INITIAL_PROMPT',
    DATA_SOURCE_SELECTION = 'DATA_SOURCE_SELECTION',
    MODEL_SELECTION = 'MODEL_SELECTION',
    KPI_REFINEMENT = 'KPI_REFINEMENT',
    VISUALIZATION_PREVIEW = 'VISUALIZATION_PREVIEW',
    GOVERNANCE_SETTINGS = 'GOVERNANCE_SETTINGS',
    CONFIRMATION = 'CONFIRMATION',
    PROCESSING = 'PROCESSING',
    COMPLETED = 'COMPLETED',
    ERROR = 'ERROR',
    AI_ASSISTED_TRANSFORMATION = 'AI_ASSISTED_TRANSFORMATION',
    PREDICTIVE_CONFIG = 'PREDICTIVE_CONFIG',
    PRESCRIPTIVE_CONFIG = 'PRESCRIPTIVE_CONFIG',
    COGNITIVE_INSIGHTS = 'COGNITIVE_INSIGHTS',
}

/**
 * Interface for AI-generated suggestions, used across various stages.
 */
export interface AISuggestion {
    type: 'kpi_definition' | 'data_source' | 'model' | 'metric' | 'dimension' | 'filter' | 'visualization';
    value: string | KpiDefinition | AIDataSourceConfig | AIModelConfig;
    rationale: string;
    confidence: number;
}

// --- Mock API & AI Service Utilities ---

const mockAIDataSources: AIDataSourceConfig[] = [
    { id: 'ds-101', name: 'Financial Ledger DB', type: 'database', status: 'connected', lastSync: Date.now() - 3600000, schemaPreview: { 'transactions': 'json', 'accounts': 'json' }, dataQualityScore: 95, securityLevel: 'classified', dataGovernancePolicy: ['PII_redacted', 'financial_reporting'] },
    { id: 'ds-102', name: 'CRM Sales Data', type: 'api', status: 'connected', lastSync: Date.now() - 100000, schemaPreview: { 'leads': 'object', 'opportunities': 'object' }, dataQualityScore: 88, securityLevel: 'high', dataGovernancePolicy: ['GDPR_compliant'] },
    { id: 'ds-103', name: 'Web Analytics Log', type: 'streaming', status: 'connected', lastSync: Date.now(), schemaPreview: { 'page_views': 'number', 'users': 'number' }, dataQualityScore: 78, securityLevel: 'medium', dataGovernancePolicy: ['anonymized'] },
    { id: 'ds-104', name: 'External Market Trends API', type: 'api', status: 'disconnected', lastSync: Date.now() - 86400000 * 7, schemaPreview: { 'market_index': 'number', 'sentiment_score': 'number' }, dataQualityScore: 60, securityLevel: 'low', dataGovernancePolicy: ['public_data'] },
    { id: 'ds-105', name: 'HR Payroll System', type: 'database', status: 'auth_error', lastSync: Date.now() - 86400000, schemaPreview: { 'salaries': 'number', 'employees': 'object' }, dataQualityScore: 92, securityLevel: 'classified', dataGovernancePolicy: ['PII_redacted', 'HIPAA_ready'] },
];

const mockAIModels: AIModelConfig[] = [
    { id: 'model-g4o', name: 'QuantumGenie 4-Omni', description: 'Advanced general-purpose AI for complex KPI generation and multi-modal analysis.', capabilities: ['NLP', 'data_synthesis', 'forecasting', 'anomaly_detection', 'causal_inference'], costPerQuery: 0.05, latencyMs: 300, version: '4.0.1', provider: 'Internal_QuantumEngine', performanceMetrics: { accuracy: 0.98 } },
    { id: 'model-finance-opt', name: 'Financial Optimization Engine', description: 'Specialized model for financial KPIs, risk assessment, and investment insights.', capabilities: ['financial_modeling', 'risk_analysis', 'compliance_checking', 'predictive_modeling'], costPerQuery: 0.08, latencyMs: 200, version: '2.1.0', provider: 'QuantSense Labs', performanceMetrics: { accuracy: 0.99 } },
    { id: 'model-viz-auto', name: 'AutoViz Engine', description: 'Generates optimal visualization configurations based on data types and insights.', capabilities: ['visualization_recommendation', 'dashboard_layout', 'infographic_design'], costPerQuery: 0.01, latencyMs: 150, version: '1.5.0', provider: 'InsightGen', performanceMetrics: { accuracy: 0.95 } },
    { id: 'model-gov-risk', name: 'Governance & Risk AI', description: 'Assesses compliance, privacy, and security risks for KPI data and definitions.', capabilities: ['risk_assessment', 'compliance_auditing', 'access_control_recommendation'], costPerQuery: 0.03, latencyMs: 400, version: '1.8.0', provider: 'SecureMetrics', performanceMetrics: { accuracy: 0.97 } },
    { id: 'model-data-trans', name: 'Data Transformer AI', description: 'Suggests and performs data cleaning, transformation, and enrichment operations.', capabilities: ['data_wrangling', 'schema_mapping', 'feature_engineering'], costPerQuery: 0.04, latencyMs: 250, version: '3.0.0', provider: 'DataForge AI', performanceMetrics: { accuracy: 0.96 } },
];

/**
 * Simulates a complex AI backend interaction.
 * This function orchestrates various AI "microservices" based on the stage.
 * @param stage Current stage of KPI generation.
 * @param prompt User's initial prompt.
 * @param currentKpiDef Current working KPI definition.
 * @param selectedDataSourceId Currently selected data source.
 * @param selectedModelIds Currently selected AI models.
 * @param refinementInput User input for refining KPI.
 * @param transformationActions User-confirmed data transformation actions.
 * @param predictiveConfig Predictive analytics configuration.
 * @param prescriptiveConfig Prescriptive actions configuration.
 * @returns A promise resolving to the next stage and relevant AI outputs.
 */
export async function simulateAIGenerationPipeline(
    stage: AIPromptStage,
    prompt: string,
    currentKpiDef: Partial<KpiDefinition> = {},
    selectedDataSourceId: string | null = null,
    selectedModelIds: string[] = [],
    refinementInput: string = '',
    transformationActions: string[] = [],
    predictiveConfig: Record<string, any> = {},
    prescriptiveConfig: Record<string, any> = {},
): Promise<{ nextStage: AIPromptStage; output: any; aiInsights?: AIInteractionHistoryEntry[] }> {
    console.log(`AI Pipeline: Processing stage ${stage} with prompt "${prompt}"...`);
    await new Promise(resolve => setTimeout(resolve, Math.random() * 1500 + 500)); // Simulate AI processing time

    let aiInsights: AIInteractionHistoryEntry[] = [];
    let nextStage = stage;
    let output: any = {};

    switch (stage) {
        case AIPromptStage.INITIAL_PROMPT:
            // AI analyzes prompt and suggests relevant data sources
            const suggestedSources = mockAIDataSources
                .filter(ds => ds.status === 'connected' && (prompt.toLowerCase().includes('finance') && ds.name.includes('Financial') || prompt.toLowerCase().includes('sales') && ds.name.includes('CRM')))
                .slice(0, 3);

            if (suggestedSources.length === 0) {
                aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "I couldn't find an immediate data source match. Please select from available sources or connect a new one." });
            } else {
                aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Based on your prompt, I recommend these data sources: ${suggestedSources.map(s => s.name).join(', ')}.` });
            }

            output = {
                kpiDraft: {
                    title: prompt.length > 50 ? prompt.substring(0, 47) + '...' : prompt,
                    description: `AI initial draft based on: "${prompt}"`,
                    querySpec: {
                        metrics: [], dimensions: [], filters: {}, timeRange: 'last_month', aggregationMethod: 'SUM'
                    }
                },
                suggestedDataSources: suggestedSources,
                allDataSources: mockAIDataSources, // Offer all for manual selection
                suggestedModels: mockAIModels.filter(m => m.capabilities.includes('NLP') || m.capabilities.includes('data_synthesis'))
            };
            nextStage = AIPromptStage.DATA_SOURCE_SELECTION;
            break;

        case AIPromptStage.DATA_SOURCE_SELECTION:
            if (!selectedDataSourceId) {
                aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "Please select a data source to proceed." });
                output = { error: "No data source selected." };
                nextStage = AIPromptStage.ERROR;
                break;
            }
            const selectedDS = mockAIDataSources.find(ds => ds.id === selectedDataSourceId);
            if (!selectedDS || selectedDS.status !== 'connected') {
                aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Data source '${selectedDS?.name}' is not fully available or connected. Please check its status or select another.` });
                output = { error: "Selected data source not ready." };
                nextStage = AIPromptStage.ERROR; // Or back to selection
                break;
            }

            // AI analyzes selected data source schema and prompt to suggest metrics/dimensions
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Data source "${selectedDS.name}" selected. Analyzing schema for relevant fields...` });
            const aiGeneratedQuerySpec = {
                dataSourceId: selectedDataSourceId,
                metrics: ['value', 'amount'], // Mock AI inference
                dimensions: ['date', 'category', 'region'],
                filters: {},
                timeRange: 'last_quarter',
                aggregationMethod: 'SUM'
            };

            output = {
                kpiDraft: {
                    ...currentKpiDef,
                    querySpec: aiGeneratedQuerySpec,
                    governance: { ownerId: 'ai_system', accessControl: 'private', complianceTags: selectedDS.dataGovernancePolicy, auditLogRef: `log-${Date.now()}` }
                },
                suggestedModels: mockAIModels.filter(m => m.capabilities.includes('forecasting') || m.capabilities.includes('anomaly_detection'))
            };
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Initial metrics and dimensions identified from ${selectedDS.name}.` });
            if (selectedDS.dataQualityScore < 80) {
                 aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Warning: Data quality for ${selectedDS.name} is moderate (${selectedDS.dataQualityScore}/100). Consider AI-assisted data transformation.`, context: { suggestion: 'data_transformation' } });
                 nextStage = AIPromptStage.AI_ASSISTED_TRANSFORMATION; // Suggest transformation
            } else {
                 nextStage = AIPromptStage.MODEL_SELECTION;
            }

            break;

        case AIPromptStage.AI_ASSISTED_TRANSFORMATION:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Analyzing data transformation needs for ${selectedDataSourceId}. Suggested actions based on schema anomalies and data quality: 'Handle Missing Values', 'Standardize Date Formats', 'Redact PII (if applicable)'.` });
            output = {
                kpiDraft: currentKpiDef,
                suggestedTransformations: [
                    'Standardize `date` column to ISO 8601',
                    'Impute `amount` nulls with median',
                    'Categorize `transaction_type` into `income`, `expense`, `transfer`'
                ],
                recommendedModel: mockAIModels.find(m => m.id === 'model-data-trans')
            };
            nextStage = AIPromptStage.MODEL_SELECTION; // After suggesting transformations, move to model selection
            break;

        case AIPromptStage.MODEL_SELECTION:
            if (!selectedModelIds || selectedModelIds.length === 0) {
                aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "Please select one or more AI models for enhanced insights." });
                output = { error: "No AI model selected." };
                nextStage = AIPromptStage.ERROR;
                break;
            }
            const models = mockAIModels.filter(m => selectedModelIds.includes(m.id));
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Selected AI models: ${models.map(m => m.name).join(', ')}. Now, let's refine the KPI details.` });
            output = {
                kpiDraft: {
                    ...currentKpiDef,
                    aiConfidenceScore: 0.75, // Initial AI confidence
                    aiValidationStatus: 'pending',
                }
            };
            nextStage = AIPromptStage.KPI_REFINEMENT;
            break;

        case AIPromptStage.KPI_REFINEMENT:
            // AI refines KPI based on user input and selected models
            const refinedTitle = refinementInput ? `${currentKpiDef.title} (${refinementInput})` : currentKpiDef.title;
            const refinedDescription = refinementInput ? `${currentKpiDef.description} - Refined: ${refinementInput}` : currentKpiDef.description;
            const aiRefinedQuerySpec = {
                ...currentKpiDef.querySpec,
                filters: refinementInput.includes('high value') ? { amount: { '$gt': 1000 } } : currentKpiDef.querySpec?.filters
            };
            const aiAdvancedAnalytics = selectedModelIds.includes('model-g4o') ? { type: 'forecasting', config: { horizon: 'next_3_months' } } : undefined;

            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `KPI details refined. Detected potential for predictive analysis.` });
            output = {
                kpiDraft: {
                    ...currentKpiDef,
                    title: refinedTitle,
                    description: refinedDescription,
                    querySpec: aiRefinedQuerySpec,
                    aiConfidenceScore: 0.85,
                    queryRecommendations: ['Add a variance analysis dimension.', 'Segment by customer loyalty score.'], // AI suggestions
                    anomaliesDetected: Math.random() > 0.7 ? ['Potential data anomaly in Q3 transactions.'] : [],
                    advancedAnalytics: aiAdvancedAnalytics
                }
            };
            nextStage = AIPromptStage.PREDICTIVE_CONFIG; // Move to predictive config
            break;

        case AIPromptStage.PREDICTIVE_CONFIG:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Predictive analysis configured. Now considering prescriptive actions.` });
            output = {
                kpiDraft: {
                    ...currentKpiDef,
                    querySpec: {
                        ...currentKpiDef.querySpec,
                        advancedAnalytics: {
                            type: predictiveConfig.type || 'forecasting',
                            config: predictiveConfig.config || { horizon: 'next_6_months', algorithm: 'LSTM_NeuralNet' }
                        }
                    },
                    aiConfidenceScore: 0.90,
                },
                prescriptiveSuggestions: ['Increase marketing spend in underperforming regions', 'Reallocate budget based on forecast', 'Investigate anomaly in Q3 spending']
            };
            nextStage = AIPromptStage.PRESCRIPTIVE_CONFIG;
            break;

        case AIPromptStage.PRESCRIPTIVE_CONFIG:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Prescriptive actions reviewed. Proceeding to visualization and cognitive insights.` });
            output = {
                kpiDraft: {
                    ...currentKpiDef,
                    cognitiveInsights: {
                        primaryInsight: "Overall trend shows moderate growth, but Q3 anomaly needs attention. Forecast predicts continued growth if anomaly is resolved.",
                        secondaryInsights: ["Regional performance varies significantly.", "Specific product categories are underperforming."],
                        actionableRecommendations: prescriptiveConfig.actions || ['Review Q3 transaction logs', 'Engage regional managers', 'Optimize product pricing for underperformers'],
                        causalFactors: ["Seasonal demand shift", "Competitor promotion", "Supply chain disruption in Q3"]
                    },
                    aiConfidenceScore: 0.92,
                }
            };
            nextStage = AIPromptStage.COGNITIVE_INSIGHTS;
            break;

        case AIPromptStage.COGNITIVE_INSIGHTS:
            // AI generates visualization preferences based on KPI type and insights
            const suggestedVizType = (currentKpiDef.querySpec?.advancedAnalytics?.type === 'forecasting' || currentKpiDef.querySpec?.dimensions?.includes('date')) ? 'line' : 'bar';
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `Cognitive insights generated. Recommending '${suggestedVizType}' chart for optimal data representation.` });
            output = {
                kpiDraft: {
                    ...currentKpiDef,
                    visualizationPreferences: {
                        type: suggestedVizType,
                        colorScheme: 'vibrant_blue_green',
                        alertThresholds: { critical: 0.1, warning: 0.05 } // Example percentage change
                    },
                    aiConfidenceScore: 0.95,
                    aiValidationStatus: 'validated',
                }
            };
            nextStage = AIPromptStage.VISUALIZATION_PREVIEW;
            break;


        case AIPromptStage.VISUALIZATION_PREVIEW:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "Preview generated. Please review and confirm governance settings." });
            output = { kpiDraft: currentKpiDef }; // No change to KPI def, just moving state
            nextStage = AIPromptStage.GOVERNANCE_SETTINGS;
            break;

        case AIPromptStage.GOVERNANCE_SETTINGS:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "Governance settings applied. Ready for final confirmation." });
            output = { kpiDraft: currentKpiDef }; // Assume settings were applied to currentKpiDef
            nextStage = AIPromptStage.CONFIRMATION;
            break;

        case AIPromptStage.CONFIRMATION:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "KPI generation process completed and validated. Adding to your dashboard." });
            output = { finalKpi: { ...currentKpiDef, id: `kpi-ai-${Date.now()}`, version: 1, createdAt: Date.now(), updatedAt: Date.now(), feedbackScores: { relevance: 0, accuracy: 0, usability: 0 } } };
            nextStage = AIPromptStage.COMPLETED;
            break;

        case AIPromptStage.ERROR:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `An error occurred: ${output.error || "Unknown error"}. Please try again or review your inputs.` });
            break; // Stays in ERROR state

        default:
            aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: "Invalid stage detected. Resetting." });
            nextStage = AIPromptStage.ERROR;
            break;
    }

    // AI self-monitoring and adaptation
    const monitoringReport = await simulateAISystemMonitoring();
    if (monitoringReport.overallStatus !== 'optimal') {
        aiInsights.push({ speaker: 'ai', timestamp: Date.now(), message: `System Alert: AI infrastructure detected '${monitoringReport.issues.join(', ')}'. Performance might be slightly degraded.`, context: monitoringReport });
    }

    return { nextStage, output, aiInsights };
}


/**
 * Simulates AI system performance monitoring.
 */
export async function simulateAISystemMonitoring(): Promise<{ overallStatus: string; issues: string[]; metrics: Record<string, any> }> {
    await new Promise(resolve => setTimeout(resolve, 100)); // Quick check
    const statusOptions = ['optimal', 'degraded_latency', 'resource_contention', 'model_drift_warning'];
    const randomStatus = statusOptions[Math.floor(Math.random() * statusOptions.length)];

    return {
        overallStatus: randomStatus,
        issues: randomStatus !== 'optimal' ? [randomStatus.replace(/_/g, ' ')] : [],
        metrics: {
            cpu_usage_avg: Math.random() * 50 + 20,
            memory_usage_avg: Math.random() * 60 + 30,
            model_query_latency_p95: Math.random() * 200 + 100, // ms
            successful_queries_rate: Math.random() * 5 + 90, // percent
            ai_model_drift_score: Math.random() * 0.1
        }
    };
}

/**
 * Simulates AI-driven security and compliance auditing.
 */
export async function useAISecurityAuditor(kpiDefinition: KpiDefinition | null): Promise<{ riskScore: number; complianceIssues: string[]; privacyViolations: string[] }> {
    const [auditResult, setAuditResult] = useState<{ riskScore: number; complianceIssues: string[]; privacyViolations: string[] }>({
        riskScore: 0, complianceIssues: [], privacyViolations: []
    });

    useEffect(() => {
        if (!kpiDefinition) return;

        const runAudit = async () => {
            await new Promise(resolve => setTimeout(resolve, 700)); // Simulate audit time

            let riskScore = 0;
            const complianceIssues: string[] = [];
            const privacyViolations: string[] = [];

            // Mock AI logic for auditing
            if (kpiDefinition.governance.accessControl === 'public' && kpiDefinition.governance.complianceTags.includes('PII_redacted')) {
                // Should have been redacted, but need to check if it actually was. Mocking detection.
                riskScore += 20;
                complianceIssues.push('Public access on PII-sensitive data source without AI verification of redaction.');
                privacyViolations.push('Potential PII exposure if redaction failed.');
            }
            if (!kpiDefinition.governance.complianceTags.includes('GDPR_compliant') && kpiDefinition.querySpec.dataSourceId === 'ds-102') {
                riskScore += 15;
                complianceIssues.push('CRM data (ds-102) requires GDPR compliance tag.');
            }
            if (kpiDefinition.aiConfidenceScore < 0.7) {
                riskScore += 10;
                complianceIssues.push('Low AI confidence score suggests potential data interpretation risks.');
            }

            setAuditResult({
                riskScore: Math.min(riskScore + Math.floor(Math.random() * 10), 100), // Add some randomness
                complianceIssues,
                privacyViolations
            });
        };

        runAudit();
    }, [kpiDefinition]);

    return auditResult;
}

// --- New Exported Helper Components ---

/**
 * Component for AI-assisted data source selection.
 */
export const AIDataSourceSelector: React.FC<{
    selectedDataSourceId: string | null;
    onSelect: (id: string) => void;
    dataSources: AIDataSourceConfig[];
    aiSuggestions: AISuggestion[];
    isLoading: boolean;
    onConnectNew: () => void;
}> = ({ selectedDataSourceId, onSelect, dataSources, aiSuggestions, isLoading, onConnectNew }) => (
    <div className="space-y-4">
        <p className="text-gray-300 font-semibold">AI Recommendation:</p>
        {aiSuggestions.length > 0 ? (
            <div className="flex flex-wrap gap-2 mb-4">
                {aiSuggestions.filter(s => s.type === 'data_source' && typeof s.value !== 'string').map((s, i) => {
                    const ds = s.value as AIDataSourceConfig;
                    return (
                        <button
                            key={ds.id}
                            className={`px-3 py-1 text-sm rounded-full ${selectedDataSourceId === ds.id ? 'bg-cyan-500 text-white' : 'bg-gray-600 hover:bg-cyan-700/50 text-gray-200'} transition-colors`}
                            onClick={() => onSelect(ds.id)}
                            disabled={isLoading}
                        >
                            {ds.name} <span className="text-xs opacity-70">({(s.confidence * 100).toFixed(0)}% AI Match)</span>
                        </button>
                    );
                })}
            </div>
        ) : (
            <p className="text-gray-400 text-sm">No specific data source recommendations at this moment.</p>
        )}
        <p className="text-gray-300 font-semibold">Available Data Sources:</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {dataSources.map(ds => (
                <button
                    key={ds.id}
                    className={`p-3 border rounded-lg text-left transition-all duration-200 ${selectedDataSourceId === ds.id ? 'bg-cyan-800/30 border-cyan-500 shadow-lg' : 'bg-gray-700/50 border-gray-600 hover:bg-gray-600/70'} ${ds.status !== 'connected' ? 'opacity-50 cursor-not-allowed' : ''}`}
                    onClick={() => ds.status === 'connected' && onSelect(ds.id)}
                    disabled={isLoading || ds.status !== 'connected'}
                >
                    <h4 className="font-medium text-white flex items-center gap-2">
                        {ds.name}
                        <span className={`text-xs px-2 py-0.5 rounded-full ${ds.status === 'connected' ? 'bg-green-600/30 text-green-300' : ds.status === 'auth_error' ? 'bg-red-600/30 text-red-300' : 'bg-yellow-600/30 text-yellow-300'}`}>
                            {ds.status.replace('_', ' ')}
                        </span>
                    </h4>
                    <p className="text-xs text-gray-400 mt-1">{ds.type} â€¢ DQ: {ds.dataQualityScore}%</p>
                    {ds.status === 'auth_error' && <p className="text-red-400 text-xs mt-1">Authentication required.</p>}
                </button>
            ))}
            <button
                onClick={onConnectNew}
                className="p-3 border border-dashed border-gray-500 rounded-lg text-center text-gray-400 hover:border-cyan-500 hover:text-cyan-300 transition-colors"
                disabled={isLoading}
            >
                + Connect New Data Source (AI-Guided)
            </button>
        </div>
    </div>
);

/**
 * Component for AI model selection, supporting multi-select for composite AI intelligence.
 */
export const AIModelSelector: React.FC<{
    selectedModelIds: string[];
    onSelect: (id: string) => void;
    models: AIModelConfig[];
    aiSuggestions: AISuggestion[];
    isLoading: boolean;
}> = ({ selectedModelIds, onSelect, models, aiSuggestions, isLoading }) => (
    <div className="space-y-4">
        <p className="text-gray-300 font-semibold">AI Recommended Models:</p>
        <div className="flex flex-wrap gap-2 mb-4">
            {aiSuggestions.filter(s => s.type === 'model' && typeof s.value !== 'string').map((s, i) => {
                const model = s.value as AIModelConfig;
                return (
                    <button
                        key={model.id}
                        className={`px-3 py-1 text-sm rounded-full ${selectedModelIds.includes(model.id) ? 'bg-cyan-500 text-white' : 'bg-gray-600 hover:bg-cyan-700/50 text-gray-200'} transition-colors`}
                        onClick={() => onSelect(model.id)}
                        disabled={isLoading}
                    >
                        {model.name} <span className="text-xs opacity-70">({(s.confidence * 100).toFixed(0)}% AI Match)</span>
                    </button>
                );
            })}
        </div>
        <p className="text-gray-300 font-semibold">All Available AI Models:</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {models.map(model => (
                <button
                    key={model.id}
                    className={`p-3 border rounded-lg text-left transition-all duration-200 ${selectedModelIds.includes(model.id) ? 'bg-cyan-800/30 border-cyan-500 shadow-lg' : 'bg-gray-700/50 border-gray-600 hover:bg-gray-600/70'}`}
                    onClick={() => onSelect(model.id)}
                    disabled={isLoading}
                >
                    <h4 className="font-medium text-white">{model.name} <span className="text-xs text-gray-400">({model.provider})</span></h4>
                    <p className="text-xs text-gray-400 mt-1">{model.description.substring(0, 70)}...</p>
                    <p className="text-xs text-gray-500 mt-1">Capabilities: {model.capabilities.slice(0, 2).join(', ')}{model.capabilities.length > 2 ? '...' : ''}</p>
                </button>
            ))}
        </div>
    </div>
);

/**
 * Component for refining KPI definitions with AI suggestions.
 */
export const KpiRefinementAssistant: React.FC<{
    kpiDraft: Partial<KpiDefinition>;
    onUpdateKpiDraft: (update: Partial<KpiDefinition>) => void;
    refinementInput: string;
    onRefinementInputChange: (input: string) => void;
    queryRecommendations: string[];
    anomaliesDetected: string[];
    isLoading: boolean;
}> = ({ kpiDraft, onUpdateKpiDraft, refinementInput, onRefinementInputChange, queryRecommendations, anomaliesDetected, isLoading }) => (
    <div className="space-y-4">
        <p className="text-gray-300">Review and refine the AI-generated KPI details. Your input helps the AI learn!</p>

        <label className="block text-gray-400 text-sm font-bold mb-2" htmlFor="kpiTitle">
            KPI Title
        </label>
        <input
            id="kpiTitle"
            type="text"
            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:ring-cyan-500 focus:border-cyan-500"
            value={kpiDraft.title || ''}
            onChange={(e) => onUpdateKpiDraft({ title: e.target.value })}
            disabled={isLoading}
        />

        <label className="block text-gray-400 text-sm font-bold mb-2 mt-4" htmlFor="kpiDescription">
            KPI Description
        </label>
        <textarea
            id="kpiDescription"
            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:ring-cyan-500 focus:border-cyan-500"
            rows={3}
            value={kpiDraft.description || ''}
            onChange={(e) => onUpdateKpiDraft({ description: e.target.value })}
            disabled={isLoading}
        ></textarea>

        <label className="block text-gray-400 text-sm font-bold mb-2 mt-4" htmlFor="refinementInput">
            Further Refinement / Questions for AI
        </label>
        <textarea
            id="refinementInput"
            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:ring-cyan-500 focus:border-cyan-500"
            rows={2}
            placeholder="E.g., 'Focus on last 6 months', 'Exclude transactions under $50', 'Analyze by customer segment'."
            value={refinementInput}
            onChange={(e) => onRefinementInputChange(e.target.value)}
            disabled={isLoading}
        ></textarea>

        {queryRecommendations.length > 0 && (
            <div className="mt-4 p-3 bg-blue-900/20 border border-blue-700 rounded-md">
                <p className="text-blue-300 font-semibold text-sm">AI Query Recommendations:</p>
                <ul className="list-disc list-inside text-blue-200 text-sm mt-1">
                    {queryRecommendations.map((rec, i) => <li key={i}>{rec}</li>)}
                </ul>
            </div>
        )}

        {anomaliesDetected.length > 0 && (
            <div className="mt-4 p-3 bg-red-900/20 border border-red-700 rounded-md">
                <p className="text-red-300 font-semibold text-sm">AI Anomaly Detection Alert:</p>
                <ul className="list-disc list-inside text-red-200 text-sm mt-1">
                    {anomaliesDetected.map((anomaly, i) => <li key={i}>{anomaly}</li>)}
                </ul>
            </div>
        )}

        <div className="mt-4 text-gray-400 text-sm">
            AI Confidence: <span className={`font-semibold ${kpiDraft.aiConfidenceScore && kpiDraft.aiConfidenceScore > 0.8 ? 'text-green-400' : kpiDraft.aiConfidenceScore && kpiDraft.aiConfidenceScore > 0.6 ? 'text-yellow-400' : 'text-red-400'}`}>
                {(kpiDraft.aiConfidenceScore ? kpiDraft.aiConfidenceScore * 100 : 0).toFixed(0)}%
            </span>
            <span className="ml-4">Validation Status: <span className="font-semibold text-cyan-400">{kpiDraft.aiValidationStatus || 'pending'}</span></span>
        </div>
    </div>
);

/**
 * Component to display a mock KPI visualization preview.
 */
export const KpiPreviewGenerator: React.FC<{
    kpiDefinition: Partial<KpiDefinition>;
    isLoading: boolean;
}> = ({ kpiDefinition, isLoading }) => {
    const vizType = kpiDefinition.visualizationPreferences?.type || 'line';
    const color = kpiDefinition.visualizationPreferences?.colorScheme || 'bg-cyan-500';

    return (
        <div className="space-y-4">
            <p className="text-gray-300">AI-generated Visualization Preview:</p>
            <div className={`w-full h-48 flex items-center justify-center rounded-lg border border-gray-600 bg-gray-800 relative overflow-hidden ${isLoading ? 'animate-pulse' : ''}`}>
                {isLoading ? (
                    <span className="text-gray-400">Generating preview...</span>
                ) : (
                    <div className="text-white text-center p-4">
                        <p className="text-xl font-bold">{kpiDefinition.title || 'Untitled KPI'}</p>
                        <p className="text-sm text-gray-400 mt-1">Visualization Type: {vizType.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</p>
                        <p className="text-sm text-gray-400 mt-1">Color Scheme: {color}</p>
                        <div className={`mt-4 h-20 w-48 mx-auto rounded-md ${color} flex items-end overflow-hidden`}>
                            {/* Mock chart bars/lines */}
                            {vizType === 'bar' && Array.from({ length: 5 }).map((_, i) => (
                                <div key={i} className="flex-1 bg-white/50 mx-0.5" style={{ height: `${Math.random() * 80 + 20}%` }}></div>
                            ))}
                            {vizType === 'line' && (
                                <svg viewBox="0 0 100 100" className="w-full h-full" preserveAspectRatio="none">
                                    <polyline fill="none" stroke="white" strokeWidth="2" points="0,70 20,40 40,60 60,30 80,50 100,20" />
                                </svg>
                            )}
                            {vizType === 'pie' && (
                                <div className="rounded-full w-20 h-20 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 animate-spin-slow"></div>
                            )}
                        </div>
                        {kpiDefinition.visualizationPreferences?.alertThresholds && (
                            <p className="text-xs text-yellow-300 mt-2">Alert Thresholds: Critical {kpiDefinition.visualizationPreferences.alertThresholds.critical}, Warning {kpiDefinition.visualizationPreferences.alertThresholds.warning}</p>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
};

/**
 * Component for AI-assisted governance and collaboration settings.
 */
export const KpiGovernancePanel: React.FC<{
    kpiGovernance: KpiDefinition['governance'];
    onUpdateGovernance: (update: Partial<KpiDefinition['governance']>) => void;
    isLoading: boolean;
    auditResult: { riskScore: number; complianceIssues: string[]; privacyViolations: string[] };
}> = ({ kpiGovernance, onUpdateGovernance, isLoading, auditResult }) => (
    <div className="space-y-4">
        <p className="text-gray-300">Configure access, ownership, and compliance for this KPI. AI provides risk assessment:</p>

        <div className="flex items-center space-x-4">
            <label className="text-gray-400 text-sm font-bold" htmlFor="accessControl">Access:</label>
            <select
                id="accessControl"
                className="p-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500"
                value={kpiGovernance.accessControl}
                onChange={(e) => onUpdateGovernance({ accessControl: e.target.value as KpiDefinition['governance']['accessControl'] })}
                disabled={isLoading}
            >
                <option value="private">Private (Owner only)</option>
                <option value="shared_group">Shared with Team</option>
                <option value="public">Public (Org-wide View)</option>
            </select>
        </div>

        <label className="block text-gray-400 text-sm font-bold mb-2 mt-4" htmlFor="complianceTags">
            Compliance Tags (AI-suggested & editable)
        </label>
        <div className="flex flex-wrap gap-2">
            {['GDPR_compliant', 'HIPAA_ready', 'financial_reporting', 'PII_redacted', 'anonymized', 'public_data'].map(tag => (
                <button
                    key={tag}
                    className={`px-3 py-1 text-xs rounded-full ${kpiGovernance.complianceTags.includes(tag) ? 'bg-purple-600/50 text-purple-200' : 'bg-gray-600 hover:bg-gray-500 text-gray-300'} transition-colors`}
                    onClick={() => onUpdateGovernance({ complianceTags: kpiGovernance.complianceTags.includes(tag) ? kpiGovernance.complianceTags.filter(t => t !== tag) : [...kpiGovernance.complianceTags, tag] })}
                    disabled={isLoading}
                >
                    {tag.replace(/_/g, ' ')}
                </button>
            ))}
        </div>

        {auditResult.riskScore > 0 && (
            <div className="mt-4 p-3 bg-red-900/20 border border-red-700 rounded-md">
                <p className="text-red-300 font-semibold text-sm">AI Security & Compliance Audit Results (Risk Score: {auditResult.riskScore}/100):</p>
                {auditResult.complianceIssues.length > 0 && (
                    <ul className="list-disc list-inside text-red-200 text-sm mt-1">
                        <li className="font-medium">Compliance Issues:</li>
                        {auditResult.complianceIssues.map((issue, i) => <li key={`ci-${i}`} className="ml-4">{issue}</li>)}
                    </ul>
                )}
                {auditResult.privacyViolations.length > 0 && (
                    <ul className="list-disc list-inside text-red-900 text-sm mt-1">
                        <li className="font-medium">Privacy Violations:</li>
                        {auditResult.privacyViolations.map((issue, i) => <li key={`pv-${i}`} className="ml-4">{issue}</li>)}
                    </ul>
                )}
                <p className="text-red-300 text-xs mt-2">Adjust settings or consult a security expert before publishing.</p>
            </div>
        )}
    </div>
);

/**
 * Represents an AI-guided data transformation step.
 */
export interface AIDataTransformationStep {
    id: string;
    description: string;
    suggestedAction: 'clean' | 'impute' | 'normalize' | 'aggregate' | 'redact' | 'enrich';
    targetColumn: string;
    status: 'pending' | 'applied' | 'skipped';
    aiConfidence: number;
    parameters?: Record<string, any>; // e.g., { method: 'median' }
}

/**
 * Component for AI-guided data transformation.
 */
export const AIDataTransformationEngine: React.FC<{
    selectedDataSourceId: string | null;
    kpiDraft: Partial<KpiDefinition>;
    isLoading: boolean;
    onTransformationsApplied: (transformations: AIDataTransformationStep[]) => void;
    initialTransformations?: AIDataTransformationStep[];
}> = ({ selectedDataSourceId, kpiDraft, isLoading, onTransformationsApplied, initialTransformations }) => {
    const [transformations, setTransformations] = useState<AIDataTransformationStep[]>(initialTransformations || []);

    useEffect(() => {
        if (!selectedDataSourceId || isLoading || initialTransformations?.length) return;
        // Mock AI suggesting transformations based on data source and prompt
        const generateMockTransformations = async () => {
            await new Promise(r => setTimeout(r, 800));
            setTransformations([
                { id: 't-1', description: 'Impute missing values in "amount" column using median.', suggestedAction: 'impute', targetColumn: 'amount', status: 'pending', aiConfidence: 0.90, parameters: { method: 'median' } },
                { id: 't-2', description: 'Standardize "transaction_date" format to YYYY-MM-DD.', suggestedAction: 'normalize', targetColumn: 'transaction_date', status: 'pending', aiConfidence: 0.95, parameters: { format: 'YYYY-MM-DD' } },
                { id: 't-3', description: 'Redact PII from "customer_notes" column.', suggestedAction: 'redact', targetColumn: 'customer_notes', status: 'pending', aiConfidence: 0.88, parameters: { sensitive_tags: ['PII', 'customer_name'] } },
            ]);
        };
        generateMockTransformations();
    }, [selectedDataSourceId, isLoading, initialTransformations]);

    const handleToggleTransformation = (id: string) => {
        setTransformations(prev => prev.map(t =>
            t.id === id ? { ...t, status: t.status === 'applied' ? 'pending' : 'applied' } : t
        ));
    };

    const handleApplyAll = () => {
        setTransformations(prev => prev.map(t => ({ ...t, status: 'applied' })));
        onTransformationsApplied(transformations.filter(t => t.status === 'applied'));
    };

    const handleSkipAll = () => {
        setTransformations(prev => prev.map(t => ({ ...t, status: 'skipped' })));
        onTransformationsApplied([]);
    };

    return (
        <div className="space-y-4">
            <p className="text-gray-300 font-semibold">AI-Guided Data Transformation (for {mockAIDataSources.find(ds => ds.id === selectedDataSourceId)?.name || 'selected source'}):</p>
            {transformations.length === 0 && !isLoading ? (
                <p className="text-gray-400 text-sm">AI found no critical transformation needs or is still analyzing.</p>
            ) : (
                <div className="space-y-3">
                    {transformations.map(t => (
                        <div key={t.id} className="p-3 bg-gray-700/70 border border-gray-600 rounded-md flex items-center justify-between">
                            <div>
                                <p className="text-white text-sm">{t.description}</p>
                                <p className="text-gray-400 text-xs">Target: <span className="font-mono">{t.targetColumn}</span> | AI Confidence: {(t.aiConfidence * 100).toFixed(0)}%</p>
                            </div>
                            <button
                                onClick={() => handleToggleTransformation(t.id)}
                                className={`px-3 py-1 text-xs rounded-full transition-colors ${t.status === 'applied' ? 'bg-green-600/50 hover:bg-green-700/70 text-green-100' : 'bg-gray-500 hover:bg-gray-600/70 text-gray-200'}`}
                                disabled={isLoading}
                            >
                                {t.status === 'applied' ? 'Applied' : 'Apply'}
                            </button>
                        </div>
                    ))}
                </div>
            )}
            <div className="flex justify-end gap-3 mt-4">
                <button
                    onClick={handleSkipAll}
                    className="px-4 py-2 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors"
                    disabled={isLoading || transformations.length === 0}
                >
                    Skip All
                </button>
                <button
                    onClick={handleApplyAll}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg disabled:opacity-50"
                    disabled={isLoading || transformations.length === 0 || transformations.every(t => t.status === 'applied')}
                >
                    Apply Selected Transformations
                </button>
            </div>
        </div>
    );
};

/**
 * Component for configuring AI predictive analytics.
 */
export const AIPredictiveAnalyticsConfigurator: React.FC<{
    kpiDraft: Partial<KpiDefinition>;
    onUpdateKpiDraft: (update: Partial<KpiDefinition>) => void;
    isLoading: boolean;
}> = ({ kpiDraft, onUpdateKpiDraft, isLoading }) => {
    const [predictiveType, setPredictiveType] = useState(kpiDraft.querySpec?.advancedAnalytics?.type === 'forecasting' ? 'forecasting' : 'none');
    const [forecastHorizon, setForecastHorizon] = useState(kpiDraft.querySpec?.advancedAnalytics?.config?.horizon || 'next_3_months');

    useEffect(() => {
        if (kpiDraft.querySpec?.advancedAnalytics?.type) {
            setPredictiveType(kpiDraft.querySpec.advancedAnalytics.type);
            setForecastHorizon(kpiDraft.querySpec.advancedAnalytics.config?.horizon || 'next_3_months');
        }
    }, [kpiDraft.querySpec?.advancedAnalytics]);

    const handleUpdate = () => {
        onUpdateKpiDraft({
            querySpec: {
                ...kpiDraft.querySpec,
                advancedAnalytics: predictiveType === 'forecasting' ? {
                    type: 'forecasting',
                    config: { horizon: forecastHorizon, algorithm: 'AI_OPTIMIZED_ENSEMBLE' }
                } : undefined,
            }
        });
    };

    return (
        <div className="space-y-4">
            <p className="text-gray-300 font-semibold">AI Predictive Analytics Configuration:</p>
            <div className="flex items-center space-x-4">
                <label className="text-gray-400 text-sm font-bold" htmlFor="predictiveType">Type:</label>
                <select
                    id="predictiveType"
                    className="p-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500"
                    value={predictiveType}
                    onChange={(e) => { setPredictiveType(e.target.value); handleUpdate(); }}
                    disabled={isLoading}
                >
                    <option value="none">No Predictive Analytics</option>
                    <option value="forecasting">Forecasting (AI-Optimized)</option>
                    <option value="anomaly_detection">Anomaly Detection</option>
                    <option value="causal_inference">Causal Inference</option>
                </select>
            </div>

            {predictiveType === 'forecasting' && (
                <div className="flex items-center space-x-4 mt-3">
                    <label className="text-gray-400 text-sm font-bold" htmlFor="forecastHorizon">Forecast Horizon:</label>
                    <select
                        id="forecastHorizon"
                        className="p-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-cyan-500 focus:border-cyan-500"
                        value={forecastHorizon}
                        onChange={(e) => { setForecastHorizon(e.target.value); handleUpdate(); }}
                        disabled={isLoading}
                    >
                        <option value="next_month">Next Month</option>
                        <option value="next_3_months">Next 3 Months</option>
                        <option value="next_6_months">Next 6 Months</option>
                        <option value="next_year">Next Year</option>
                    </select>
                </div>
            )}
            <p className="text-gray-500 text-xs">AI will dynamically select and fine-tune algorithms (e.g., LSTM, ARIMA, Prophet) based on data characteristics and chosen horizon.</p>
        </div>
    );
};

/**
 * Component for AI-recommended prescriptive actions.
 */
export const AIPrescriptiveActionsRecommender: React.FC<{
    kpiDraft: Partial<KpiDefinition>;
    onUpdateKpiDraft: (update: Partial<KpiDefinition>) => void;
    isLoading: boolean;
    prescriptiveSuggestions: string[];
}> = ({ kpiDraft, onUpdateKpiDraft, isLoading, prescriptiveSuggestions }) => {
    const [selectedActions, setSelectedActions] = useState<string[]>(kpiDraft.cognitiveInsights?.actionableRecommendations || []);

    useEffect(() => {
        setSelectedActions(kpiDraft.cognitiveInsights?.actionableRecommendations || []);
    }, [kpiDraft.cognitiveInsights?.actionableRecommendations]);

    const handleToggleAction = (action: string) => {
        const newActions = selectedActions.includes(action)
            ? selectedActions.filter(a => a !== action)
            : [...selectedActions, action];
        setSelectedActions(newActions);
        onUpdateKpiDraft({
            cognitiveInsights: {
                ...kpiDraft.cognitiveInsights,
                actionableRecommendations: newActions
            } as KpiDefinition['cognitiveInsights']
        });
    };

    return (
        <div className="space-y-4">
            <p className="text-gray-300 font-semibold">AI Prescriptive Actions (Recommendations for what to do next):</p>
            {prescriptiveSuggestions.length === 0 && !isLoading ? (
                <p className="text-gray-400 text-sm">AI found no specific actionable recommendations at this time.</p>
            ) : (
                <div className="space-y-3">
                    {prescriptiveSuggestions.map((action, i) => (
                        <div key={i} className="p-3 bg-gray-700/70 border border-gray-600 rounded-md flex items-center justify-between">
                            <p className="text-white text-sm">{action}</p>
                            <button
                                onClick={() => handleToggleAction(action)}
                                className={`px-3 py-1 text-xs rounded-full transition-colors ${selectedActions.includes(action) ? 'bg-indigo-600/50 hover:bg-indigo-700/70 text-indigo-100' : 'bg-gray-500 hover:bg-gray-600/70 text-gray-200'}`}
                                disabled={isLoading}
                            >
                                {selectedActions.includes(action) ? 'Accepted' : 'Accept'}
                            </button>
                        </div>
                    ))}
                </div>
            )}
            <p className="text-gray-500 text-xs">AI continuously learns from accepted actions to improve future recommendations.</p>
        </div>
    );
};

/**
 * Component to display AI-generated cognitive insights.
 */
export const AICognitiveKPIAnalyzer: React.FC<{
    kpiDraft: Partial<KpiDefinition>;
    isLoading: boolean;
}> = ({ kpiDraft, isLoading }) => (
    <div className="space-y-4">
        <p className="text-gray-300 font-semibold">AI Cognitive Insights (Deep Understanding):</p>
        {isLoading ? (
            <p className="text-gray-400 text-sm animate-pulse">Analyzing higher-order patterns...</p>
        ) : kpiDraft.cognitiveInsights ? (
            <div className="space-y-2">
                <div className="p-3 bg-blue-900/20 border border-blue-700 rounded-md">
                    <p className="text-blue-300 font-semibold text-sm">Primary Insight:</p>
                    <p className="text-blue-200 text-sm mt-1">{kpiDraft.cognitiveInsights.primaryInsight}</p>
                </div>
                {kpiDraft.cognitiveInsights.secondaryInsights?.length > 0 && (
                    <div className="p-3 bg-indigo-900/20 border border-indigo-700 rounded-md">
                        <p className="text-indigo-300 font-semibold text-sm">Secondary Insights:</p>
                        <ul className="list-disc list-inside text-indigo-200 text-sm mt-1">
                            {kpiDraft.cognitiveInsights.secondaryInsights.map((insight, i) => <li key={i}>{insight}</li>)}
                        </ul>
                    </div>
                )}
                {kpiDraft.cognitiveInsights.causalFactors?.length > 0 && (
                    <div className="p-3 bg-purple-900/20 border border-purple-700 rounded-md">
                        <p className="text-purple-300 font-semibold text-sm">AI-Identified Causal Factors:</p>
                        <ul className="list-disc list-inside text-purple-200 text-sm mt-1">
                            {kpiDraft.cognitiveInsights.causalFactors.map((factor, i) => <li key={i}>{factor}</li>)}
                        </ul>
                    </div>
                )}
            </div>
        ) : (
            <p className="text-gray-400 text-sm">AI is still generating cognitive insights or none are available for this KPI yet.</p>
        )}
        <p className="text-gray-500 text-xs">These insights go beyond raw data to explain 'why' things are happening, leveraging a decade of AI research.</p>
    </div>
);

/**
 * Component for AI system monitoring dashboard (within the modal for context).
 */
export const AISystemMonitoringDashboard: React.FC<{
    monitoringStatus: ReturnType<typeof simulateAISystemMonitoring> extends Promise<infer U> ? U : never;
    isLoading: boolean;
}> = ({ monitoringStatus, isLoading }) => (
    <div className="mt-8 p-4 bg-gray-900 rounded-lg border border-gray-700">
        <h4 className="text-lg font-semibold text-white mb-3">AI Infrastructure Health</h4>
        {isLoading ? (
            <p className="text-gray-500 text-sm">Monitoring AI system health...</p>
        ) : (
            <div className="grid grid-cols-2 gap-3 text-sm">
                <div className="flex flex-col">
                    <span className="text-gray-400">Overall Status:</span>
                    <span className={`font-medium ${monitoringStatus.overallStatus === 'optimal' ? 'text-green-400' : 'text-orange-400'}`}>
                        {monitoringStatus.overallStatus.replace(/_/g, ' ')}
                    </span>
                </div>
                <div className="flex flex-col">
                    <span className="text-gray-400">P95 Latency:</span>
                    <span className="text-white">{monitoringStatus.metrics.model_query_latency_p95.toFixed(0)} ms</span>
                </div>
                <div className="flex flex-col">
                    <span className="text-gray-400">CPU Usage:</span>
                    <span className="text-white">{monitoringStatus.metrics.cpu_usage_avg.toFixed(1)}%</span>
                </div>
                <div className="flex flex-col">
                    <span className="text-gray-400">Model Drift:</span>
                    <span className="text-white">{(monitoringStatus.metrics.ai_model_drift_score * 100).toFixed(2)}%</span>
                </div>
                {monitoringStatus.issues.length > 0 && (
                    <div className="col-span-2 mt-2">
                        <span className="text-orange-400 font-medium">Alerts:</span>
                        <ul className="list-disc list-inside text-orange-300 text-xs">
                            {monitoringStatus.issues.map((issue, i) => <li key={i}>{issue}</li>)}
                        </ul>
                    </div>
                )}
            </div>
        )}
    </div>
);

/**
 * Component for AI Feedback Mechanism.
 */
export const AIFeedbackMechanism: React.FC<{
    kpiId: string;
    onFeedbackSubmit: (kpiId: string, relevance: number, accuracy: number, usability: number, comment?: string) => void;
    isLoading: boolean;
}> = ({ kpiId, onFeedbackSubmit, isLoading }) => {
    const [relevance, setRelevance] = useState(3);
    const [accuracy, setAccuracy] = useState(3);
    const [usability, setUsability] = useState(3);
    const [comment, setComment] = useState('');

    const handleSubmit = () => {
        onFeedbackSubmit(kpiId, relevance, accuracy, usability, comment);
        // Reset form or show confirmation
    };

    return (
        <div className="space-y-3 p-4 bg-gray-900 rounded-lg border border-gray-700">
            <h4 className="text-lg font-semibold text-white mb-2">Help AI Improve: Provide Feedback</h4>
            <div className="flex flex-col">
                <label className="text-gray-400 text-sm">Relevance:</label>
                <input type="range" min="1" max="5" value={relevance} onChange={(e) => setRelevance(parseInt(e.target.value))} className="w-full mt-1" disabled={isLoading} />
                <span className="text-xs text-gray-500">{relevance} out of 5</span>
            </div>
            <div className="flex flex-col">
                <label className="text-gray-400 text-sm">Accuracy:</label>
                <input type="range" min="1" max="5" value={accuracy} onChange={(e) => setAccuracy(parseInt(e.target.value))} className="w-full mt-1" disabled={isLoading} />
                <span className="text-xs text-gray-500">{accuracy} out of 5</span>
            </div>
            <div className="flex flex-col">
                <label className="text-gray-400 text-sm">Usability:</label>
                <input type="range" min="1" max="5" value={usability} onChange={(e) => setUsability(parseInt(e.target.value))} className="w-full mt-1" disabled={isLoading} />
                <span className="text-xs text-gray-500">{usability} out of 5</span>
            </div>
            <textarea
                className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:ring-cyan-500 focus:border-cyan-500 text-sm"
                rows={2}
                placeholder="Optional: Add specific comments for AI improvement..."
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                disabled={isLoading}
            ></textarea>
            <button
                onClick={handleSubmit}
                className="w-full py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg disabled:opacity-50 mt-2"
                disabled={isLoading}
            >
                Submit Feedback
            </button>
            <p className="text-gray-500 text-xs mt-2">Your feedback directly trains our Reinforcement Learning from Human Feedback (RLHF) models.</p>
        </div>
    );
};

/**
 * Component for AI Contextual Help.
 */
export const AIContextualHelp: React.FC<{
    currentStage: AIPromptStage;
    aiHelpSuggestions: string[];
}> = ({ currentStage, aiHelpSuggestions }) => {
    const stageToHelp: Record<AIPromptStage, string> = {
        [AIPromptStage.INITIAL_PROMPT]: "Start by describing your desired KPI in natural language. The more detail, the better!",
        [AIPromptStage.DATA_SOURCE_SELECTION]: "Choose the data source(s) relevant to your KPI. AI suggests sources based on your prompt and data metadata.",
        [AIPromptStage.AI_ASSISTED_TRANSFORMATION]: "AI has identified potential data quality issues or recommended transformations. Review and apply as needed.",
        [AIPromptStage.MODEL_SELECTION]: "Select specialized AI models to enhance your KPI (e.g., for forecasting, anomaly detection, deep analysis).",
        [AIPromptStage.KPI_REFINEMENT]: "Refine the KPI's title, description, metrics, and dimensions. Provide more details to guide the AI.",
        [AIPromptStage.PREDICTIVE_CONFIG]: "Configure advanced predictive analytics like forecasting horizon or anomaly detection sensitivity.",
        [AIPromptStage.PRESCRIPTIVE_CONFIG]: "Review AI's recommendations for actionable steps based on the KPI insights.",
        [AIPromptStage.COGNITIVE_INSIGHTS]: "Explore the AI's deep understanding of underlying factors and relationships related to your KPI.",
        [AIPromptStage.VISUALIZATION_PREVIEW]: "Review the AI-generated visualization. You can modify preferences later in the dashboard.",
        [AIPromptStage.GOVERNANCE_SETTINGS]: "Set access controls, ownership, and compliance tags. AI provides a real-time risk assessment.",
        [AIPromptStage.CONFIRMATION]: "Confirm all settings before generating the final KPI and adding it to your system.",
        [AIPromptStage.PROCESSING]: "AI is actively generating and validating your KPI. This may take a moment...",
        [AIPromptStage.COMPLETED]: "Your KPI is ready! View it on your dashboard.",
        [AIPromptStage.ERROR]: "An error occurred. Check the messages above for details or try restarting the process.",
    };

    return (
        <div className="mt-8 p-4 bg-blue-900/20 rounded-lg border border-blue-700">
            <h4 className="text-lg font-semibold text-blue-300 mb-2">AI Contextual Help</h4>
            <p className="text-blue-200 text-sm">{stageToHelp[currentStage]}</p>
            {aiHelpSuggestions.length > 0 && (
                <div className="mt-3">
                    <p className="text-blue-300 font-semibold text-sm">AI Dynamic Tips:</p>
                    <ul className="list-disc list-inside text-blue-100 text-xs mt-1">
                        {aiHelpSuggestions.map((tip, i) => <li key={i}>{tip}</li>)}
                    </ul>
                </div>
            )}
        </div>
    );
};

/**
 * Component for exploring the AI Ecosystem/Marketplace.
 */
export const AIEcosystemMarketplace: React.FC<{
    onDiscoverPlugin: (pluginId: string) => void;
}> = ({ onDiscoverPlugin }) => {
    const [plugins] = useState([
        { id: 'plugin-hr-sentiment', name: 'HR Sentiment Analyzer', description: 'Analyzes HR data for employee sentiment trends.', cost: 'Premium' },
        { id: 'plugin-supply-chain-opt', name: 'Supply Chain Optimizer', description: 'Predicts supply chain disruptions and suggests optimizations.', cost: 'Enterprise' },
        { id: 'plugin-geospatial-viz', name: 'Geospatial Visualizer', description: 'Advanced mapping capabilities for location-based KPIs.', cost: 'Free' },
    ]);

    return (
        <div className="p-4 bg-gray-900 rounded-lg border border-gray-700 mt-8">
            <h4 className="text-lg font-semibold text-white mb-3">AI Ecosystem & Marketplace</h4>
            <p className="text-gray-400 text-sm mb-4">Discover and integrate specialized AI plugins to unlock even more advanced KPI capabilities.</p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {plugins.map(plugin => (
                    <div key={plugin.id} className="bg-gray-800 p-3 rounded-md border border-gray-700">
                        <h5 className="text-white font-medium">{plugin.name}</h5>
                        <p className="text-gray-400 text-xs mt-1">{plugin.description}</p>
                        <div className="flex justify-between items-center mt-2">
                            <span className="text-cyan-400 text-xs font-semibold">{plugin.cost}</span>
                            <button
                                onClick={() => onDiscoverPlugin(plugin.id)}
                                className="px-3 py-1 bg-cyan-600/50 hover:bg-cyan-700/70 text-white text-xs rounded-md"
                            >
                                Learn More
                            </button>
                        </div>
                    </div>
                ))}
            </div>
            <p className="text-gray-500 text-xs mt-4">New plugins are added weekly by AI community and partners.</p>
        </div>
    );
};

/**
 * Component to show AI continuous learning status.
 */
export const AIContinuousLearningModule: React.FC<{
    lastLearningCycle: number;
    feedbackProcessed: number;
    modelUpdates: number;
}> = ({ lastLearningCycle, feedbackProcessed, modelUpdates }) => (
    <div className="p-4 bg-green-900/20 rounded-lg border border-green-700 mt-8">
        <h4 className="text-lg font-semibold text-green-300 mb-2">AI Continuous Learning Status</h4>
        <p className="text-green-200 text-sm">Our AI is always improving:</p>
        <ul className="list-disc list-inside text-green-100 text-sm mt-2">
            <li>Last learning cycle completed: {new Date(lastLearningCycle).toLocaleString()}</li>
            <li>User feedback processed: {feedbackProcessed} entries</li>
            <li>Core model updates applied: {modelUpdates}</li>
        </ul>
        <p className="text-green-400 text-xs mt-3">This system has undergone 10 years of constant upgrades and refinement, learning from billions of data points and user interactions.</p>
    </div>
);


// --- Main AIDynamicKpiButton Component (Expanded) ---

export const AIDynamicKpiButton: React.FC = () => {
    const [isPromptModalOpen, setIsPromptModalOpen] = useState(false);
    const [promptInput, setPromptInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [currentStage, setCurrentStage] = useState<AIPromptStage>(AIPromptStage.INITIAL_PROMPT);
    const [aiConversationHistory, setAiConversationHistory] = useState<AIInteractionHistoryEntry[]>([]);
    const [kpiDraft, setKpiDraft] = useState<Partial<KpiDefinition>>({});
    const [selectedDataSourceId, setSelectedDataSourceId] = useState<string | null>(null);
    const [allDataSources, setAllDataSources] = useState<AIDataSourceConfig[]>(mockAIDataSources);
    const [selectedModelIds, setSelectedModelIds] = useState<string[]>([]);
    const [allAIModels, setAllAIModels] = useState<AIModelConfig[]>(mockAIModels);
    const [aiSuggestions, setAiSuggestions] = useState<AISuggestion[]>([]); // Dynamic AI suggestions
    const [refinementInput, setRefinementInput] = useState('');
    const [queryRecommendations, setQueryRecommendations] = useState<string[]>([]); // From AI refinement
    const [anomaliesDetected, setAnomaliesDetected] = useState<string[]>([]); // From AI anomaly detection
    const [prescriptiveSuggestions, setPrescriptiveSuggestions] = useState<string[]>([]); // From AI prescriptive actions
    const [monitoringStatus, setMonitoringStatus] = useState<ReturnType<typeof simulateAISystemMonitoring> extends Promise<infer U> ? U : never>({ overallStatus: 'optimal', issues: [], metrics: {} as any });
    const [aiHelpSuggestions, setAiHelpSuggestions] = useState<string[]>([]); // Contextual AI help

    const context = useContext(DataContext);
    if (!context) throw new Error("AIDynamicKpiButton must be used within a DataProvider");
    const { addDynamicKpi, updateKpiFeedback } = context;

    // AI-driven security audit for the current KPI draft
    const auditResult = useAISecurityAuditor(kpiDraft.id ? kpiDraft as KpiDefinition : null);

    const modalRef = useRef<HTMLDivElement>(null);

    // Initial load for monitoring and continuous learning status
    useEffect(() => {
        const fetchMonitoring = async () => {
            setMonitoringStatus(await simulateAISystemMonitoring());
        };
        fetchMonitoring();
        const interval = setInterval(fetchMonitoring, 30000); // Update every 30 seconds
        return () => clearInterval(interval);
    }, []);

    const addAiMessage = useCallback((message: string, context?: Record<string, any>) => {
        setAiConversationHistory(prev => [...prev, { speaker: 'ai', timestamp: Date.now(), message, context }]);
    }, []);

    const addUserMessage = useCallback((message: string) => {
        setAiConversationHistory(prev => [...prev, { speaker: 'user', timestamp: Date.now(), message }]);
    }, []);

    const handlePromptModalClose = useCallback(() => {
        setIsPromptModalOpen(false);
        setPromptInput('');
        setIsLoading(false);
        setError(null);
        setCurrentStage(AIPromptStage.INITIAL_PROMPT);
        setAiConversationHistory([]);
        setKpiDraft({});
        setSelectedDataSourceId(null);
        setSelectedModelIds([]);
        setAiSuggestions([]);
        setRefinementInput('');
        setQueryRecommendations([]);
        setAnomaliesDetected([]);
        setPrescriptiveSuggestions([]);
        setAiHelpSuggestions([]);
    }, []);

    const handleNextStage = useCallback(async () => {
        setError(null);
        setIsLoading(true);

        try {
            const result = await simulateAIGenerationPipeline(
                currentStage,
                promptInput,
                kpiDraft,
                selectedDataSourceId,
                selectedModelIds,
                refinementInput,
                [], // Mock transformation actions for now
                kpiDraft.querySpec?.advancedAnalytics?.type === 'forecasting' ? kpiDraft.querySpec.advancedAnalytics.config : {},
                kpiDraft.cognitiveInsights?.actionableRecommendations ? { actions: kpiDraft.cognitiveInsights.actionableRecommendations } : {}
            );

            setCurrentStage(result.nextStage);
            if (result.aiInsights) {
                setAiConversationHistory(prev => [...prev, ...result.aiInsights]);
                const helpTips = result.aiInsights.filter(insight => insight.context?.suggestion === 'data_transformation').map(insight => insight.message);
                setAiHelpSuggestions(helpTips.length > 0 ? helpTips : []);
            }

            switch (result.nextStage) {
                case AIPromptStage.DATA_SOURCE_SELECTION:
                    setKpiDraft(result.output.kpiDraft);
                    setAllDataSources(result.output.allDataSources);
                    setAiSuggestions(result.output.suggestedDataSources.map((ds: AIDataSourceConfig) => ({
                        type: 'data_source', value: ds, rationale: `Relevant to '${promptInput}'`, confidence: 0.8
                    })));
                    setAllAIModels(result.output.suggestedModels); // Initial model suggestions
                    break;
                case AIPromptStage.AI_ASSISTED_TRANSFORMATION:
                    setKpiDraft(result.output.kpiDraft);
                    setAllAIModels(prev => { // Add suggested data transformation model
                        const model = result.output.recommendedModel;
                        if (model && !prev.some(m => m.id === model.id)) return [...prev, model];
                        return prev;
                    });
                    // For AIDataTransformationEngine, we would pass result.output.suggestedTransformations as initialTransformations
                    break;
                case AIPromptStage.MODEL_SELECTION:
                    setKpiDraft(result.output.kpiDraft);
                    break;
                case AIPromptStage.KPI_REFINEMENT:
                    setKpiDraft(result.output.kpiDraft);
                    setQueryRecommendations(result.output.queryRecommendations || []);
                    setAnomaliesDetected(result.output.anomaliesDetected || []);
                    break;
                case AIPromptStage.PREDICTIVE_CONFIG:
                    setKpiDraft(result.output.kpiDraft);
                    setPrescriptiveSuggestions(result.output.prescriptiveSuggestions || []);
                    break;
                case AIPromptStage.PRESCRIPTIVE_CONFIG:
                    setKpiDraft(result.output.kpiDraft);
                    break;
                case AIPromptStage.COGNITIVE_INSIGHTS:
                    setKpiDraft(result.output.kpiDraft);
                    break;
                case AIPromptStage.VISUALIZATION_PREVIEW:
                    setKpiDraft(result.output.kpiDraft);
                    break;
                case AIPromptStage.GOVERNANCE_SETTINGS:
                    setKpiDraft(result.output.kpiDraft);
                    break;
                case AIPromptStage.CONFIRMATION:
                    setKpiDraft(result.output.kpiDraft);
                    break;
                case AIPromptStage.COMPLETED:
                    const finalKpi = result.output.finalKpi as KpiDefinition;
                    addDynamicKpi(finalKpi);
                    break;
                case AIPromptStage.ERROR:
                    setError(result.output.error || "An unknown error occurred during AI processing.");
                    break;
            }
        } catch (err: any) {
            setError(err.message || "An unexpected error occurred.");
            setCurrentStage(AIPromptStage.ERROR);
            addAiMessage(`An error occurred: ${err.message}`);
        } finally {
            setIsLoading(false);
            if (modalRef.current) {
                modalRef.current.scrollTop = modalRef.current.scrollHeight; // Scroll to bottom of chat
            }
        }
    }, [currentStage, promptInput, kpiDraft, selectedDataSourceId, selectedModelIds, refinementInput, addDynamicKpi, addAiMessage]);

    const handleBackStage = useCallback(() => {
        setError(null); // Clear errors when going back
        let previousStage: AIPromptStage = AIPromptStage.INITIAL_PROMPT; // Default fallback
        const stageOrder = Object.values(AIPromptStage).filter(s => typeof s === 'string') as AIPromptStage[];
        const currentIndex = stageOrder.indexOf(currentStage);
        if (currentIndex > 0) {
            previousStage = stageOrder[currentIndex - 1];
        }

        // Handle specific back transitions for multi-step AI process
        if (currentStage === AIPromptStage.AI_ASSISTED_TRANSFORMATION) previousStage = AIPromptStage.DATA_SOURCE_SELECTION;
        else if (currentStage === AIPromptStage.MODEL_SELECTION && kpiDraft.querySpec?.dataSourceId) {
            const selectedDS = mockAIDataSources.find(ds => ds.id === kpiDraft.querySpec?.dataSourceId);
            if (selectedDS && selectedDS.dataQualityScore < 80) { // If it came from transformation suggestion
                previousStage = AIPromptStage.AI_ASSISTED_TRANSFORMATION;
            } else {
                previousStage = AIPromptStage.DATA_SOURCE_SELECTION;
            }
        }
        else if (currentStage === AIPromptStage.PREDICTIVE_CONFIG) previousStage = AIPromptStage.KPI_REFINEMENT;
        else if (currentStage === AIPromptStage.PRESCRIPTIVE_CONFIG) previousStage = AIPromptStage.PREDICTIVE_CONFIG;
        else if (currentStage === AIPromptStage.COGNITIVE_INSIGHTS) previousStage = AIPromptStage.PRESCRIPTIVE_CONFIG;
        else if (currentStage === AIPromptStage.VISUALIZATION_PREVIEW) previousStage = AIPromptStage.COGNITIVE_INSIGHTS;


        setCurrentStage(previousStage);
        // Potentially revert kpiDraft to a previous state if history was managed,
        // but for this expansion, we'll keep the draft as is, allowing re-refinement.
    }, [currentStage, kpiDraft]);

    const handleSubmitInitialPrompt = async () => {
        if (!promptInput.trim()) {
            setError("Please enter a prompt.");
            return;
        }
        addUserMessage(promptInput);
        await handleNextStage();
    };

    const handleDataSourceSelect = useCallback((id: string) => {
        setSelectedDataSourceId(id);
        setKpiDraft(prev => ({ ...prev, querySpec: { ...prev.querySpec, dataSourceId: id } }));
        addAiMessage(`You selected: ${mockAIDataSources.find(ds => ds.id === id)?.name}`);
    }, [addAiMessage]);

    const handleModelSelect = useCallback((id: string) => {
        setSelectedModelIds(prev => prev.includes(id) ? prev.filter(mid => mid !== id) : [...prev, id]);
        addAiMessage(`AI Model selection updated.`);
    }, [addAiMessage]);

    const handleKpiFeedback = useCallback(async (kpiId: string, relevance: number, accuracy: number, usability: number, comment?: string) => {
        await updateKpiFeedback(kpiId, relevance, accuracy, usability, comment);
        addAiMessage("Thank you for your valuable feedback! This helps our AI learn and improve.");
        // Close modal or show confirmation
    }, [addAiMessage, updateKpiFeedback]);

    const handleConnectNewDataSource = useCallback(() => {
        addAiMessage("AI assistant guiding you through new data source connection. What type of source are you connecting? (e.g., 'SQL Database', 'Cloud Storage', 'Real-time API')");
        // In a real app, this would open a new flow/modal for data source connection.
        // For this example, we just simulate the AI acknowledging.
    }, [addAiMessage]);

    const handleDiscoverPlugin = useCallback((pluginId: string) => {
        addAiMessage(`Exploring details for plugin: ${pluginId}. AI will assess its compatibility and value for your current workflows.`);
        // In a real app, this would navigate to a marketplace detail page or initiate plugin installation.
    }, [addAiMessage]);

    const renderStageContent = useMemo(() => {
        switch (currentStage) {
            case AIPromptStage.INITIAL_PROMPT:
                return (
                    <>
                        <p className="text-gray-300">Describe the financial insight you want to see:</p>
                        <textarea
                            className="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-500 focus:ring-cyan-500 focus:border-cyan-500"
                            rows={4}
                            placeholder="E.g., 'Show my monthly investment gains versus losses for the past year', or 'Compare my utility spending with local average prices over the last quarter.' The AI has 10 years of upgrades, be as detailed as possible."
                            value={promptInput}
                            onChange={(e) => setPromptInput(e.target.value)}
                            disabled={isLoading}
                        ></textarea>
                    </>
                );
            case AIPromptStage.DATA_SOURCE_SELECTION:
                return (
                    <AIDataSourceSelector
                        selectedDataSourceId={selectedDataSourceId}
                        onSelect={handleDataSourceSelect}
                        dataSources={allDataSources}
                        aiSuggestions={aiSuggestions}
                        isLoading={isLoading}
                        onConnectNew={handleConnectNewDataSource}
                    />
                );
            case AIPromptStage.AI_ASSISTED_TRANSFORMATION:
                 return (
                    <AIDataTransformationEngine
                        selectedDataSourceId={selectedDataSourceId}
                        kpiDraft={kpiDraft}
                        isLoading={isLoading}
                        onTransformationsApplied={(applied) => {
                            addAiMessage(`Applied ${applied.length} data transformations.`);
                            // Optionally update kpiDraft with transformation metadata
                        }}
                    />
                 );
            case AIPromptStage.MODEL_SELECTION:
                return (
                    <AIModelSelector
                        selectedModelIds={selectedModelIds}
                        onSelect={handleModelSelect}
                        models={allAIModels}
                        aiSuggestions={aiSuggestions} // Potentially update AI suggestions based on prompt and data
                        isLoading={isLoading}
                    />
                );
            case AIPromptStage.KPI_REFINEMENT:
                return (
                    <KpiRefinementAssistant
                        kpiDraft={kpiDraft}
                        onUpdateKpiDraft={setKpiDraft}
                        refinementInput={refinementInput}
                        onRefinementInputChange={setRefinementInput}
                        queryRecommendations={queryRecommendations}
                        anomaliesDetected={anomaliesDetected}
                        isLoading={isLoading}
                    />
                );
            case AIPromptStage.PREDICTIVE_CONFIG:
                return (
                    <AIPredictiveAnalyticsConfigurator
                        kpiDraft={kpiDraft}
                        onUpdateKpiDraft={setKpiDraft}
                        isLoading={isLoading}
                    />
                );
            case AIPromptStage.PRESCRIPTIVE_CONFIG:
                return (
                    <AIPrescriptiveActionsRecommender
                        kpiDraft={kpiDraft}
                        onUpdateKpiDraft={setKpiDraft}
                        isLoading={isLoading}
                        prescriptiveSuggestions={prescriptiveSuggestions}
                    />
                );
            case AIPromptStage.COGNITIVE_INSIGHTS:
                return (
                    <AICognitiveKPIAnalyzer
                        kpiDraft={kpiDraft}
                        isLoading={isLoading}
                    />
                );
            case AIPromptStage.VISUALIZATION_PREVIEW:
                return (
                    <KpiPreviewGenerator
                        kpiDefinition={kpiDraft}
                        isLoading={isLoading}
                    />
                );
            case AIPromptStage.GOVERNANCE_SETTINGS:
                return (
                    <KpiGovernancePanel
                        kpiGovernance={kpiDraft.governance || { ownerId: 'current_user', accessControl: 'private', complianceTags: [], auditLogRef: '' }}
                        onUpdateGovernance={(update) => setKpiDraft(prev => ({ ...prev, governance: { ...prev.governance, ...update } as KpiDefinition['governance'] }))}
                        isLoading={isLoading}
                        auditResult={auditResult}
                    />
                );
            case AIPromptStage.CONFIRMATION:
                return (
                    <div className="space-y-4">
                        <p className="text-gray-300 font-semibold">Final Review: Confirm KPI Details</p>
                        <div className="bg-gray-700 p-4 rounded-md border border-gray-600">
                            <h4 className="text-xl font-bold text-white">{kpiDraft.title}</h4>
                            <p className="text-gray-300 mt-2">{kpiDraft.description}</p>
                            <p className="text-gray-400 text-sm mt-3">Source: {allDataSources.find(ds => ds.id === kpiDraft.querySpec?.dataSourceId)?.name || 'N/A'}</p>
                            <p className="text-gray-400 text-sm">Models: {selectedModelIds.map(id => allAIModels.find(m => m.id === id)?.name).join(', ') || 'N/A'}</p>
                            <p className="text-gray-400 text-sm">AI Confidence: {(kpiDraft.aiConfidenceScore ? kpiDraft.aiConfidenceScore * 100 : 0).toFixed(0)}%</p>
                            <p className={`text-sm mt-2 ${auditResult.riskScore > 0 ? 'text-red-400' : 'text-green-400'}`}>Security Risk Score: {auditResult.riskScore}/100</p>
                            {auditResult.riskScore > 0 && <p className="text-xs text-red-500">Review security audit before finalizing.</p>}
                        </div>
                    </div>
                );
            case AIPromptStage.COMPLETED:
                return (
                    <div className="text-center p-6 space-y-4">
                        <SparklesIcon className="w-16 h-16 text-green-400 mx-auto" />
                        <h3 className="text-2xl font-bold text-white">KPI Generated Successfully!</h3>
                        <p className="text-gray-300">Your AI-powered KPI "{kpiDraft.title}" has been added to your dashboard.</p>
                        <p className="text-gray-400 text-sm">Now with advanced predictive, prescriptive, and cognitive insights!</p>
                        {kpiDraft.id && (
                            <AIFeedbackMechanism kpiId={kpiDraft.id} onFeedbackSubmit={handleKpiFeedback} isLoading={isLoading} />
                        )}
                    </div>
                );
            case AIPromptStage.PROCESSING:
                return (
                    <div className="text-center p-6 space-y-4">
                        <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-cyan-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <h3 className="text-xl font-bold text-white">AI Processing...</h3>
                        <p className="text-gray-300">Generating and validating your KPI with advanced models.</p>
                    </div>
                );
            case AIPromptStage.ERROR:
                return (
                    <div className="text-center p-6 space-y-4">
                        <svg className="w-16 h-16 text-red-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 className="text-2xl font-bold text-red-400">Error!</h3>
                        <p className="text-red-300">{error || "Something went wrong during AI processing."}</p>
                        <button onClick={handlePromptModalClose} className="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg">Close</button>
                    </div>
                );
            default:
                return null;
        }
    }, [currentStage, promptInput, isLoading, kpiDraft, selectedDataSourceId, allDataSources, aiSuggestions, selectedModelIds, allAIModels, refinementInput, queryRecommendations, anomaliesDetected, prescriptiveSuggestions, auditResult, error, handleDataSourceSelect, handleModelSelect, handleConnectNewDataSource, handleKpiFeedback, handlePromptModalClose]);

    const isFirstStage = currentStage === AIPromptStage.INITIAL_PROMPT;
    const isLastConfigStage = currentStage === AIPromptStage.CONFIRMATION;
    const isCompletedOrError = currentStage === AIPromptStage.COMPLETED || currentStage === AIPromptStage.ERROR;
    const isProcessing = currentStage === AIPromptStage.PROCESSING;

    const actionButtonText = useMemo(() => {
        if (isLoading) return `AI Thinking...`;
        switch (currentStage) {
            case AIPromptStage.INITIAL_PROMPT: return "Start AI Generation";
            case AIPromptStage.DATA_SOURCE_SELECTION: return "Confirm Data Source & Analyze";
            case AIPromptStage.AI_ASSISTED_TRANSFORMATION: return "Proceed to Model Selection"; // Transformations are applied in their component
            case AIPromptStage.MODEL_SELECTION: return "Apply Models & Refine KPI";
            case AIPromptStage.KPI_REFINEMENT: return "Continue to Predictive Config";
            case AIPromptStage.PREDICTIVE_CONFIG: return "Setup Prescriptive Actions";
            case AIPromptStage.PRESCRIPTIVE_CONFIG: return "Generate Cognitive Insights";
            case AIPromptStage.COGNITIVE_INSIGHTS: return "Generate Visualization Preview";
            case AIPromptStage.VISUALIZATION_PREVIEW: return "Proceed to Governance";
            case AIPromptStage.GOVERNANCE_SETTINGS: return "Review & Confirm KPI";
            case AIPromptStage.CONFIRMATION: return "Finalize & Add KPI to Dashboard";
            case AIPromptStage.COMPLETED: return "Close";
            case AIPromptStage.ERROR: return "Try Again / Close";
            case AIPromptStage.PROCESSING: return "Processing...";
            default: return "Next";
        }
    }, [currentStage, isLoading]);

    const handleActionButtonClick = async () => {
        if (isCompletedOrError) {
            handlePromptModalClose();
        } else if (currentStage === AIPromptStage.INITIAL_PROMPT) {
            await handleSubmitInitialPrompt();
        } else {
            // Logic to move to the next logical stage based on currentStage and internal component state
            // For complex stages, `handleNextStage` already encapsulates this.
            // For some specific stages, a local submit handler might be needed before calling handleNextStage.
            // For now, `handleNextStage` handles the full pipeline progression.
            await handleNextStage();
        }
    };

    return (
        <>
            <Card variant="interactive" className="h-full flex flex-col justify-center items-center text-center p-4">
                <button
                    onClick={() => setIsPromptModalOpen(true)}
                    className="flex flex-col items-center justify-center p-4 rounded-lg bg-cyan-600/50 hover:bg-cyan-700/70 transition-colors duration-200 text-white w-full h-full"
                >
                    <SparklesIcon className="w-12 h-12 mb-3 text-cyan-300" />
                    <p className="text-lg font-semibold">Generate Custom KPI (AI-Powered)</p>
                    <p className="text-sm text-gray-300 mt-1">"AI, show me my spending trends, with predictions!"</p>
                    <p className="text-xs text-cyan-200 mt-2">Enhanced with v10.5 Quantum-Cognitive Engine</p>
                </button>
            </Card>

            {isPromptModalOpen && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm p-4">
                    <div ref={modalRef} className="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full h-[90vh] flex flex-col border border-gray-700 overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800 z-10">
                            <h3 className="text-xl font-semibold text-white">AI KPI Generation Hub - v10.5</h3>
                            <div className="flex items-center space-x-3">
                                <span className="text-gray-400 text-sm">Stage: <span className="text-cyan-400">{currentStage.replace(/_/g, ' ')}</span></span>
                                <button onClick={handlePromptModalClose} className="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                            </div>
                        </div>
                        <div className="flex flex-1 overflow-hidden">
                            {/* Left Panel: AI Conversation & Context */}
                            <div className="w-1/3 bg-gray-900 border-r border-gray-700 p-4 flex flex-col overflow-y-auto">
                                <h4 className="text-lg font-semibold text-white mb-3">AI Assistant Log</h4>
                                <div className="flex-1 space-y-3 overflow-y-auto pb-4">
                                    {aiConversationHistory.map((entry, index) => (
                                        <div key={index} className={`flex ${entry.speaker === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-2 rounded-lg max-w-[80%] ${entry.speaker === 'user' ? 'bg-cyan-800/50 text-white' : 'bg-gray-700 text-gray-200'}`}>
                                                <p className="text-xs font-semibold">{entry.speaker === 'user' ? 'You' : 'AI Assistant'}:</p>
                                                <p className="text-sm">{entry.message}</p>
                                                <span className="text-xs text-gray-500 block text-right mt-1">{new Date(entry.timestamp).toLocaleTimeString()}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <AIContextualHelp currentStage={currentStage} aiHelpSuggestions={aiHelpSuggestions} />
                                <AISystemMonitoringDashboard monitoringStatus={monitoringStatus} isLoading={isLoading} />
                                <AIEcosystemMarketplace onDiscoverPlugin={handleDiscoverPlugin} />
                                <AIContinuousLearningModule lastLearningCycle={Date.now() - 86400000} feedbackProcessed={123456} modelUpdates={789} />
                            </div>

                            {/* Right Panel: Main Interaction Area */}
                            <div className="flex-1 p-6 space-y-6 overflow-y-auto">
                                {renderStageContent}

                                {error && <p className="text-red-400 text-sm">{error}</p>}

                                <div className="flex justify-between items-center mt-6 sticky bottom-0 bg-gray-800 p-4 -mx-6 border-t border-gray-700">
                                    {!isFirstStage && !isCompletedOrError && !isProcessing && (
                                        <button
                                            onClick={handleBackStage}
                                            className="px-4 py-2 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors"
                                            disabled={isLoading}
                                        >
                                            Back
                                        </button>
                                    )}

                                    <div className={`${isFirstStage ? 'w-full' : ''} flex justify-end`}>
                                        <button
                                            onClick={handleActionButtonClick}
                                            className="min-w-[150px] py-2 px-4 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg flex items-center justify-center disabled:opacity-50"
                                            disabled={isLoading || (currentStage === AIPromptStage.DATA_SOURCE_SELECTION && !selectedDataSourceId) || (currentStage === AIPromptStage.MODEL_SELECTION && selectedModelIds.length === 0)}
                                        >
                                            {isLoading && currentStage !== AIPromptStage.COMPLETED && currentStage !== AIPromptStage.ERROR ? (
                                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            ) : (
                                                <SparklesIcon className="w-5 h-5 mr-2" />
                                            )}
                                            {actionButtonText}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
};

export default AIDynamicKpiButton;