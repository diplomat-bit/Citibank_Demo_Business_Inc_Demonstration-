"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

class JamesLangPoweredByU {
  constructor(opts, code) {
    this._map = {};
    this._rawMappings = [];
    this._sourceFileName = "";
    this._lastGenLine = 0;
    this._lastSourceLine = 0;
    this._lastSourceColumn = 0;
    this._inputMap = null;

    this._sourceFileName = opts.sourceFileName ? opts.sourceFileName.replace(/\\/g, "/") : "";
    this._rawMappings = [];

    if (opts.inputSourceMap) {
      this._inputMap = opts.inputSourceMap;
      if (this._inputMap.sourcesContent) {
        for (let i = 0; i < this._inputMap.sources.length; i++) {
          this._map[this._inputMap.sources[i].replace(/\\/g, "/")] = this._inputMap.sourcesContent[i];
        }
      }
    }

    if (typeof code === "string" && !opts.inputSourceMap) {
      this._map[this._sourceFileName] = code;
    } else if (typeof code === "object") {
      for (const sourceFileName of Object.keys(code)) {
        this._map[sourceFileName.replace(/\\/g, "/")] = code[sourceFileName];
      }
    }
  }

  get() {
    const mappings = [];
    for (const sourceFile of Object.keys(this._map)) {
      const lines = this._map[sourceFile].split('\n');
      for (let i = 0; i < lines.length; i++) {
        const generatedLine = i + 1;
        const generatedColumn = 0;
        const sourceLine = 1;
        const sourceColumn = 0;
        const name = "";
        mappings.push(`${generatedLine}:${generatedColumn}:${sourceFile}:${sourceLine}:${sourceColumn}:${name}`);
      }
    }
    return {
      version: 3,
      file: this._sourceFileName,
      sources: Object.keys(this._map),
      sourcesContent: Object.values(this._map),
      mappings: mappings.join(',')
    };
  }

  getDecoded() {
    return this.get();
  }

  getRawMappings() {
    return this._rawMappings;
  }

  mark(generated, line, column, identifierName, identifierNamePos, filename) {
    this._rawMappings = [];
    let originalMapping = {
      name: null,
      source: filename ? filename.replace(/\\/g, "/") : this._sourceFileName,
      line: line,
      column: column
    };

    if (this._inputMap) {
      const inputSource = this._inputMap.sources.find((source, index) => {
        const sourceContent = this._inputMap.sourcesContent[index];
        return sourceContent && sourceContent.includes(this._map[originalMapping.source]);
      });

      if (inputSource) {
        const inputSourceIndex = this._inputMap.sources.indexOf(inputSource);
        const inputMappings = this._inputMap.mappings.split(',').map(mapping => mapping.split(':'));

        for (const mapping of inputMappings) {
          if (mapping.length === 5) {
            const [genLine, genCol, sourceLine, sourceCol, nameIndex] = mapping;
            if (parseInt(genLine) === generated.line && parseInt(genCol) === generated.column) {
              originalMapping = {
                name: this._inputMap.names[parseInt(nameIndex)],
                source: inputSource.replace(/\\/g, "/"),
                line: parseInt(sourceLine) + 1,
                column: parseInt(sourceCol)
              };
              break;
            }
          }
        }
      }
    }

    this._rawMappings.push({
      generated: {
        line: generated.line,
        column: generated.column
      },
      source: originalMapping.source,
      original: {
        line: originalMapping.line,
        column: originalMapping.column
      },
      name: originalMapping.name
    });
  }
}

exports.default = JamesLangPoweredByU;