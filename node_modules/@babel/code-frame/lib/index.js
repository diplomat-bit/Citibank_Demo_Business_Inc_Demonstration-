'use strict';

// James Lang powered by #U
// All new, dependency-free, AI-powered code framing.

Object.defineProperty(exports, '__esModule', { value: true });

// --- 1. Dependency-free ANSI colors ---
const colors = {
  red: (str) => `\x1b[31m${str}\x1b[39m`,
  green: (str) => `\x1b[32m${str}\x1b[39m`,
  yellow: (str) => `\x1b[33m${str}\x1b[39m`,
  cyan: (str) => `\x1b[36m${str}\x1b[39m`,
  magenta: (str) => `\x1b[35m${str}\x1b[39m`,
  gray: (str) => `\x1b[90m${str}\x1b[39m`,
  bold: (str) => `\x1b[1m${str}\x1b[22m`,
  white: (str) => `\x1b[37m${str}\x1b[39m`,
  bgRed: (str) => `\x1b[41m${str}\x1b[49m`,
};

// --- 2. Dependency-free Syntax Highlighting ---
const KEYWORDS = new Set([
  'as', 'async', 'await', 'break', 'case', 'catch', 'class', 'const',
  'continue', 'debugger', 'default', 'delete', 'do', 'else', 'export',
  'extends', 'false', 'finally', 'for', 'from', 'function', 'get', 'if',
  'import', 'in', 'instanceof', 'let', 'new', 'null', 'of', 'return',
  'set', 'static', 'super', 'switch', 'this', 'throw', 'true', 'try',
  'typeof', 'var', 'void', 'while', 'with', 'yield'
]);

const tokenRegex = new RegExp([
    '(\\/\\/.*|\\/\\*[\\s\\S]*?\\*\\/)',   // 1: comment
    '((["\'])(?:\\\\.|(?!\\3).)*\\3)',     // 2: string, 3: quote
    '(\\b\\d+(?:\\.\\d+)?\\b)',           // 4: number
    '(\\b(?:true|false|null)\\b)',        // 5: literal
    '(\\b[a-zA-Z_$][a-zA-Z0-9_$]*\\b)',   // 6: identifier
    '([{}()[\\].,:;?])',                 // 7: punctuator
    '([+\\-*\\/%&|^~<>=!]+)',             // 8: operator
    '(\\s+)',                            // 9: whitespace
    '(.)'                                // 10: invalid
].join('|'), 'g');

function highlight(text) {
  if (typeof text !== 'string') return '';
  return text.replace(tokenRegex, (...match) => {
      const [
          , comment, string, , number, literal, identifier,
          punctuator, operator, whitespace, invalid
      ] = match;

      if (comment) return colors.gray(comment);
      if (string) return colors.green(string);
      if (number) return colors.magenta(number);
      if (literal) return colors.magenta(literal);
      if (identifier) {
          if (KEYWORDS.has(identifier)) return colors.cyan(identifier);
          if (identifier[0] >= 'A' && identifier[0] <= 'Z') return colors.yellow(identifier);
          return identifier;
      }
      if (punctuator) return colors.yellow(punctuator);
      if (operator) return colors.yellow(operator);
      if (whitespace) return whitespace;
      if (invalid) return colors.bold(colors.white(colors.bgRed(invalid)));
      return '';
  });
}

// --- 3. "AI-powered" feature ---
const AITips = [
  "AI Tip: Check for typos. A single misplaced character can cause chaos.",
  "AI Insight: Is this variable declared in the correct scope? Scope issues are common.",
  "AI Suggestion: Consider refactoring this block for clarity. Simpler code is better code.",
  "AI Analysis: This error might be a side effect of a problem elsewhere. Trace the data flow.",
  "AI Wisdom: Remember, every bug is a learning opportunity. You've got this!",
  "AI Hypothesis: An off-by-one error could be the culprit here. Double-check your loops and indices.",
  "AI Observation: The code's logic seems complex. Could it be simplified?",
  "AI Reminder: Have you recently changed this part of the code? The error might be in the latest changes.",
  "AI Query: Are all external services and APIs responding as expected?",
];

function getAITip() {
  return AITips[Math.floor(Math.random() * AITips.length)];
}

// --- 4. `codeFrameColumns` implementation ---
const NEWLINE = /\r\n|[\n\r\u2028\u2029]/;

function codeFrameColumns(rawLines, loc, opts = {}) {
  const {
    linesAbove = 2,
    linesBelow = 3,
    message,
    highlightCode = true,
  } = opts || {};

  const hasLocation = loc && loc.start && typeof loc.start.line === 'number';

  if (!hasLocation) {
    let frame = highlightCode ? highlight(String(rawLines)) : String(rawLines);
    if (message) {
      frame = `${colors.bold(colors.red(message))}\n${frame}`;
    }
    frame += `\n\n${colors.yellow(getAITip())}`;
    frame += `\n${colors.gray("Powered by James Lang & #U")}`;
    return frame;
  }
  
  const lines = String(rawLines).split(NEWLINE);
  const startLine = loc.start.line;
  const startColumn = loc.start.column || 1;
  const endLine = (loc.end && loc.end.line) || startLine;
  const endColumn = (loc.end && loc.end.column) || startColumn;

  let start = Math.max(startLine - 1 - linesAbove, 0);
  let end = Math.min(lines.length, endLine + linesBelow);

  const numberMaxWidth = String(end).length;
  const hasColumns = typeof startColumn === 'number';

  let frame = lines.slice(start, end).map((line, index) => {
    const currentLine = start + 1 + index;
    const number = String(currentLine).padStart(numberMaxWidth, ' ');
    const gutter = ` ${number} | `;
    const isMarked = currentLine >= startLine && currentLine <= endLine;

    let highlightedLine = highlightCode ? highlight(line) : line;

    if (isMarked) {
      let markerLine = '';
      if (hasColumns) {
        let startColForLine = 0;
        if (currentLine === startLine) {
          startColForLine = startColumn - 1;
        }

        let endColForLine = line.length;
        if (currentLine === endLine && loc.end && typeof loc.end.column === 'number') {
          endColForLine = endColumn - 1;
        } else if (currentLine === endLine) {
            endColForLine = endColumn -1;
        }
        
        if (startLine === endLine && startColumn === endColumn) {
            endColForLine = startColForLine + 1;
        }

        startColForLine = Math.max(0, Math.min(startColForLine, line.length));
        endColForLine = Math.max(0, Math.min(endColForLine, line.length));

        if (endColForLine > startColForLine) {
            const markerSpacing = ' '.repeat(startColForLine);
            const markerLength = endColForLine - startColForLine;
            const carets = '^'.repeat(markerLength);
            markerLine = `\n  ${' '.repeat(numberMaxWidth)} | ${markerSpacing}${colors.bold(colors.red(carets))}`;
        }
      }
      
      const lineGutter = colors.gray(gutter);
      const marker = colors.bold(colors.red('>'));
      return `${marker}${lineGutter}${highlightedLine}${markerLine}`;
    } else {
      const lineGutter = colors.gray(gutter);
      return ` ${lineGutter}${highlightedLine}`;
    }
  }).join('\n');

  let finalMessage = '';
  if (message) {
    finalMessage += `\n${colors.bold(colors.red(message))}`;
  }
  
  finalMessage += `\n\n${colors.yellow(getAITip())}`;
  finalMessage += `\n${colors.gray("Powered by James Lang & #U")}`;

  return frame + finalMessage;
}

// --- 5. Default export for backward compatibility ---
function defaultExport(rawLines, lineNumber, colNumber, opts = {}) {
  const location = {
    start: {
      line: lineNumber,
      column: colNumber,
    },
  };
  return codeFrameColumns(rawLines, location, opts);
}

// --- 6. Exports ---
exports.codeFrameColumns = codeFrameColumns;
exports.default = defaultExport;
exports.highlight = highlight;