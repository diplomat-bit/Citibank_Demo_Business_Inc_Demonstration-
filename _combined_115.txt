
--- FILE: ClientOnboardingView.tsx ---

import React, { useState, useEffect, useCallback, ChangeEvent } from 'react';
import Card from '../../../Card';

// ================================================================================================
// TYPE DEFINITIONS
// ================================================================================================

/**
 * @description Represents a generic address structure.
 */
export interface Address {
    street1: string;
    street2?: string;
    city: string;
    state: string;
    zipCode: string;
    country: string;
}

/**
 * @description Defines the structure for a principal officer's personal information.
 */
export interface PrincipalOfficerInfo {
    fullName: string;
    email: string;
    dateOfBirth: string; // YYYY-MM-DD
    phoneNumber: string;
    ssnLast4: string; // Last 4 digits of SSN for verification
    address: Address;
}

/**
 * @description Defines the structure for business information.
 */
export interface BusinessInfo {
    businessName: string;
    businessType: 'sole_proprietorship' | 'llc' | 'c_corp' | 's_corp' | 'partnership' | 'non_profit';
    ein: string; // Employer Identification Number
    industry: string;
    website?: string;
    businessAddress: Address;
    formationDate: string; // YYYY-MM-DD
    annualRevenue: string; // Projected annual revenue
    employeesCount: string; // Number of employees
}

/**
 * @description Defines the structure for a beneficial owner.
 */
export interface BeneficialOwner {
    id: string; // Unique ID for each owner
    fullName: string;
    email: string;
    dateOfBirth: string;
    phoneNumber: string;
    ssnLast4: string;
    ownershipPercentage: number; // 0-100
    address: Address;
    identityDocument?: File | null;
}

/**
 * @description Represents the state of a file being uploaded.
 */
export interface FileUploadState {
    file: File | null;
    progress: number;
    status: 'idle' | 'uploading' | 'success' | 'error';
    errorMessage?: string;
}

/**
 * @description Defines the types of documents required for onboarding.
 */
export interface OnboardingDocuments {
    identityProof: FileUploadState; // Principal Officer's ID
    addressProof: FileUploadState; // Principal Officer's address proof
    businessRegistration?: FileUploadState; // Business registration document
    articlesOfIncorporation?: FileUploadState; // For Corps/LLCs
    operatingAgreement?: FileUploadState; // For LLCs/Partnerships
    einLetter?: FileUploadState; // IRS EIN confirmation letter
    financialStatements?: FileUploadState; // Optional: last 2 years financial statements
}

/**
 * @description Defines the available account types.
 */
export interface AccountType {
    id: string;
    name: string;
    description: string;
    features: string[];
    monthlyFee: number;
}

/**
 * @description Defines available additional services.
 */
export interface AdditionalService {
    id: string;
    name: string;
    description: string;
    monthlyCost: number;
    isOptional: boolean;
}

/**
 * @description Represents the state of the bank account linking process.
 */
export interface BankAccountLinkState {
    bankName: string;
    accountHolderName: string;
    accountNumber: string;
    routingNumber: string;
    status: 'idle' | 'linking' | 'success' | 'error';
    errorMessage?: string;
}

/**
 * @description Defines the structure for compliance declarations.
 */
export interface ComplianceDeclaration {
    agreedToTerms: boolean;
    agreedToPrivacyPolicy: boolean;
    fatcaStatus: 'us_person' | 'non_us_person' | 'n_a';
    crsStatus: 'tax_resident' | 'not_tax_resident' | 'n_a';
    politicallyExposedPerson: boolean;
    sanctionedCountriesInvolvement: boolean;
}

/**
 * @description Defines the structure for user preferences.
 */
export interface UserPreferences {
    emailNotifications: boolean;
    smsNotifications: boolean;
    marketingOptIn: boolean;
    dashboardTheme: 'light' | 'dark' | 'system';
    language: 'en' | 'es' | 'fr';
}

/**
 * @description Defines a team member with access to the dashboard.
 */
export interface TeamMember {
    id: string;
    fullName: string;
    email: string;
    role: 'admin' | 'finance' | 'operations' | 'viewer';
    status: 'invited' | 'active' | 'inactive';
}

/**
 * @description Defines an API Key configuration.
 */
export interface APIKey {
    id: string;
    name: string;
    key: string; // Masked for display
    permissions: string[];
    isActive: boolean;
    createdAt: string; // ISO date string
    lastUsedAt?: string; // ISO date string
}

/**
 * @description Defines a hardware product available for order.
 */
export interface HardwareProduct {
    id: string;
    name: string;
    description: string;
    price: number;
    imageUrl: string;
    quantity: number; // For the order form
}

/**
 * @description Represents a simulated API response.
 */
export interface ApiResponse<T> {
    success: boolean;
    data?: T;
    message?: string;
    errors?: Record<string, string>;
}

/**
 * @description Defines the complete onboarding form data structure.
 */
export interface OnboardingFormData {
    principalOfficer: PrincipalOfficerInfo;
    business: BusinessInfo;
    beneficialOwners: BeneficialOwner[];
    documents: OnboardingDocuments;
    selectedAccountTypeId: string;
    selectedServiceIds: string[];
    bankAccountLink: BankAccountLinkState;
    compliance: ComplianceDeclaration;
    userPreferences: UserPreferences;
    teamMembers: TeamMember[];
    apiKeys: APIKey[];
    hardwareOrder: HardwareProduct[];
    eSignatureAgreement: boolean;
    eSignatureText: string;
}

/**
 * @description Defines structure for validation errors.
 */
export type FormErrors<T> = {
    [K in keyof T]?: T[K] extends object ? FormErrors<T[K]> | string : string;
};

// ================================================================================================
// UTILITY FUNCTIONS (Exported for modularity)
// ================================================================================================

/**
 * @description Generic function to simulate an API call with a delay.
 * @param data - The data to be "sent" to the API.
 * @param delayMs - The delay in milliseconds.
 * @param successRate - Probability of success (0.0 to 1.0).
 * @returns A Promise that resolves with an ApiResponse.
 */
export const simulateApiCall = <T, U = any>(
    data: U,
    delayMs: number = 1000,
    successRate: number = 0.9
): Promise<ApiResponse<T>> => {
    return new Promise(resolve => {
        setTimeout(() => {
            if (Math.random() < successRate) {
                console.log("API Call Successful:", data);
                resolve({ success: true, data: data as unknown as T, message: "Operation successful" });
            } else {
                console.error("API Call Failed:", data);
                resolve({ success: false, message: "An unexpected error occurred. Please try again." });
            }
        }, delayMs);
    });
};

/**
 * @description Validates a given email address format.
 * @param email - The email string to validate.
 * @returns True if valid, false otherwise.
 */
export const isValidEmail = (email: string): boolean => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
};

/**
 * @description Validates if a string is not empty.
 * @param value - The string to validate.
 * @returns True if not empty, false otherwise.
 */
export const isNotEmpty = (value: string): boolean => {
    return value.trim().length > 0;
};

/**
 * @description Validates a date string in YYYY-MM-DD format.
 * @param dateString - The date string to validate.
 * @returns True if valid, false otherwise.
 */
export const isValidDate = (dateString: string): boolean => {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return false;
    const date = new Date(dateString);
    return date.toISOString().slice(0, 10) === dateString;
};

/**
 * @description Validates if a string represents a positive number.
 * @param value - The string to validate.
 * @returns True if valid, false otherwise.
 */
export const isPositiveNumber = (value: string): boolean => {
    const num = parseFloat(value);
    return !isNaN(num) && num > 0;
};

/**
 * @description Validates a US ZIP code format.
 * @param zipCode - The ZIP code string to validate.
 * @returns True if valid, false otherwise.
 */
export const isValidZipCode = (zipCode: string): boolean => {
    return /^\d{5}(?:[-\s]\d{4})?$/.test(zipCode);
};

/**
 * @description Validates a 10-digit phone number.
 * @param phoneNumber - The phone number string to validate.
 * @returns True if valid, false otherwise.
 */
export const isValidPhoneNumber = (phoneNumber: string): boolean => {
    return /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(phoneNumber);
};

/**
 * @description Formats a number to currency string.
 * @param amount - The number to format.
 * @param currency - The currency code (e.g., 'USD').
 * @param locale - The locale string (e.g., 'en-US').
 * @returns Formatted currency string.
 */
export const formatCurrency = (amount: number, currency: string = 'USD', locale: string = 'en-US'): string => {
    return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(amount);
};

/**
 * @description Masks a string, showing only the last N characters.
 * @param input - The string to mask.
 * @param visibleLength - The number of characters to show at the end.
 * @param maskChar - The character to use for masking.
 * @returns Masked string.
 */
export const maskString = (input: string, visibleLength: number, maskChar: string = '*'): string => {
    if (input.length <= visibleLength) {
        return input;
    }
    return maskChar.repeat(input.length - visibleLength) + input.slice(-visibleLength);
};

/**
 * @description Generates a unique ID (simple UUID-like string).
 * @returns A unique ID string.
 */
export const generateUniqueId = (): string => {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0,
            v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
};

/**
 * @description Calculates age from a date of birth string.
 * @param dobString - Date of birth in YYYY-MM-DD format.
 * @returns The age in years.
 */
export const calculateAge = (dobString: string): number => {
    const dob = new Date(dobString);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    return age;
};

// ================================================================================================
// SUB-COMPONENTS
// ================================================================================================

/**
 * @description A progress bar to visually indicate the user's position in the onboarding flow.
 */
export const OnboardingProgress: React.FC<{ currentStep: number; totalSteps: number; stepNames: string[] }> = ({ currentStep, totalSteps, stepNames }) => {
    const progressPercentage = ((currentStep) / (totalSteps - 1)) * 100;
    return (
        <div className="mb-8">
            <div className="relative pt-1">
                 <div className="flex mb-2 items-center justify-between">
                    <div><span className="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-cyan-600 bg-cyan-200">{stepNames[currentStep]}</span></div>
                    <div className="text-right"><span className="text-xs font-semibold inline-block text-cyan-300">{currentStep + 1} of {totalSteps}</span></div>
                </div>
                <div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-cyan-200/20">
                    <div style={{ width: `${progressPercentage}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-cyan-500 transition-all duration-500"></div>
                </div>
            </div>
        </div>
    );
};

/**
 * @description Displays validation errors for a form field.
 */
export const FieldError: React.FC<{ message?: string }> = ({ message }) => {
    if (!message) return null;
    return <p className="text-red-400 text-xs mt-1">{message}</p>;
};

/**
 * @description A reusable file dropzone component for the document upload step.
 * Manages its own internal state for file handling and progress simulation.
 */
export const DocumentDropzone: React.FC<{
    title: string;
    description?: string;
    allowedFileTypes?: string[];
    maxFileSizeMb?: number;
    uploadState: FileUploadState;
    onFileChange: (file: File | null) => void;
    onFileUploadStart: () => void;
    onFileUploadComplete: (state: FileUploadState) => void;
}> = ({ title, description, allowedFileTypes = ['image/*', 'application/pdf'], maxFileSizeMb = 10, uploadState, onFileChange, onFileUploadStart, onFileUploadComplete }) => {

    const handleFileSelect = (files: FileList | null) => {
        if (files && files[0]) {
            const file = files[0];
            const maxSizeBytes = maxFileSizeMb * 1024 * 1024;

            if (file.size > maxSizeBytes) {
                onFileUploadComplete({ file: null, progress: 0, status: 'error', errorMessage: `File size exceeds ${maxFileSizeMb}MB limit.` });
                return;
            }

            const fileTypeValid = allowedFileTypes.some(type => {
                if (type.endsWith('/*')) { // e.g., 'image/*'
                    return file.type.startsWith(type.slice(0, -1));
                }
                return file.type === type;
            });

            if (!fileTypeValid) {
                onFileUploadComplete({ file: null, progress: 0, status: 'error', errorMessage: `Invalid file type. Allowed: ${allowedFileTypes.map(t => t.split('/')[1] || t).join(', ')}` });
                return;
            }

            onFileUploadStart(); // Notify parent that upload is starting
            onFileChange(file); // Update parent form data with selected file

            // Simulate upload progress
            let currentProgress = 0;
            const interval = setInterval(() => {
                currentProgress += 10;
                if (currentProgress >= 100) {
                    clearInterval(interval);
                    onFileUploadComplete({ file, progress: 100, status: 'success' });
                } else {
                    onFileUploadComplete({ file, progress: currentProgress, status: 'uploading' });
                }
            }, 200);
        }
    };

    const handleRemoveFile = () => {
        onFileChange(null);
        onFileUploadComplete({ file: null, progress: 0, status: 'idle' });
    }

    const dropzoneClassName = `border-2 border-dashed rounded-lg p-6 text-center transition-colors duration-200 ${
        uploadState.status === 'error' ? 'border-red-500 bg-red-900/10' :
        uploadState.status === 'success' ? 'border-green-500 bg-green-900/10' :
        'border-gray-600 hover:border-cyan-500'
    }`;

    return (
        <div className={dropzoneClassName}>
            <h4 className="text-gray-300 font-semibold">{title}</h4>
            {description && <p className="text-sm text-gray-500 mt-1 mb-3">{description}</p>}

            {uploadState.status === 'idle' && (
                <div className="mt-4">
                    <p className="text-sm text-gray-500">Drag & drop your file here or</p>
                    <input type="file" id={`file-upload-${title.replace(/\s/g, '-')}`} className="hidden" onChange={e => handleFileSelect(e.target.files)} accept={allowedFileTypes.join(',')} />
                    <label htmlFor={`file-upload-${title.replace(/\s/g, '-')}`} className="cursor-pointer text-cyan-400 hover:text-cyan-300 font-medium">browse to upload.</label>
                    <p className="text-xs text-gray-600 mt-1">Max {maxFileSizeMb}MB. {allowedFileTypes.map(t => t.split('/')[1] || t).join(', ').toUpperCase()} files.</p>
                </div>
            )}
            {(uploadState.status === 'uploading' || uploadState.status === 'success') && uploadState.file && (
                <div className="mt-4">
                    <p className="text-sm text-white truncate">{uploadState.file.name}</p>
                    <div className="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div className="bg-cyan-500 h-2.5 rounded-full" style={{ width: `${uploadState.progress}%` }}></div>
                    </div>
                    {uploadState.status === 'success' && (
                        <div className="mt-2 text-green-400 text-sm font-semibold">
                            <span className="mr-1">✓</span> Uploaded successfully.
                            <button onClick={handleRemoveFile} className="text-xs text-gray-400 hover:underline ml-2">Remove</button>
                        </div>
                    )}
                </div>
            )}
            {uploadState.status === 'error' && (
                 <div className="mt-4 text-red-400">
                    <p className="text-sm font-semibold">✗ Upload failed: {uploadState.errorMessage || 'Unknown error.'}</p>
                    <button onClick={handleRemoveFile} className="text-xs text-gray-400 hover:underline mt-1">Retry</button>
                </div>
            )}
        </div>
    );
};

/**
 * @description A controlled input field with label and error display.
 */
export const ControlledInput: React.FC<{
    label: string;
    name: string;
    value: string;
    onChange: (e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => void;
    type?: string;
    error?: string;
    placeholder?: string;
    className?: string;
    readOnly?: boolean;
    textarea?: boolean;
    required?: boolean;
}> = ({ label, name, value, onChange, type = 'text', error, placeholder, className, readOnly, textarea, required }) => {
    const InputComponent = textarea ? 'textarea' : 'input';
    return (
        <div>
            <label className="block text-sm font-medium text-gray-300 mb-1">
                {label} {required && <span className="text-red-400">*</span>}
            </label>
            <InputComponent
                type={type}
                name={name}
                value={value}
                onChange={onChange}
                className={`mt-1 w-full bg-gray-700/50 border ${error ? 'border-red-500' : 'border-gray-600'} rounded-md p-2 text-white placeholder-gray-500 focus:ring-cyan-500 focus:border-cyan-500 ${className || ''} ${readOnly ? 'opacity-70 cursor-not-allowed' : ''}`}
                placeholder={placeholder}
                readOnly={readOnly}
                rows={textarea ? 4 : undefined}
            />
            <FieldError message={error} />
        </div>
    );
};

/**
 * @description A controlled select field with label and error display.
 */
export const ControlledSelect: React.FC<{
    label: string;
    name: string;
    value: string;
    onChange: (e: ChangeEvent<HTMLSelectElement>) => void;
    options: { value: string; label: string; disabled?: boolean }[];
    error?: string;
    className?: string;
    required?: boolean;
}> = ({ label, name, value, onChange, options, error, className, required }) => {
    return (
        <div>
            <label className="block text-sm font-medium text-gray-300 mb-1">
                {label} {required && <span className="text-red-400">*</span>}
            </label>
            <select
                name={name}
                value={value}
                onChange={onChange}
                className={`mt-1 w-full bg-gray-700/50 border ${error ? 'border-red-500' : 'border-gray-600'} rounded-md p-2 text-white focus:ring-cyan-500 focus:border-cyan-500 ${className || ''}`}
            >
                {options.map(option => (
                    <option key={option.value} value={option.value} disabled={option.disabled}>
                        {option.label}
                    </option>
                ))}
            </select>
            <FieldError message={error} />
        </div>
    );
};

/**
 * @description A controlled checkbox field with label and error display.
 */
export const ControlledCheckbox: React.FC<{
    label: React.ReactNode;
    name: string;
    checked: boolean;
    onChange: (e: ChangeEvent<HTMLInputElement>) => void;
    error?: string;
    className?: string;
    required?: boolean;
}> = ({ label, name, checked, onChange, error, className, required }) => {
    return (
        <div className={`flex items-start ${className || ''}`}>
            <input
                type="checkbox"
                name={name}
                checked={checked}
                onChange={onChange}
                className="mt-1 h-4 w-4 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500"
                required={required}
            />
            <label htmlFor={name} className="ml-2 text-sm text-gray-300 cursor-pointer">
                {label} {required && <span className="text-red-400">*</span>}
            </label>
            <FieldError message={error} />
        </div>
    );
};

/**
 * @description Renders a generic address form.
 */
export const AddressForm: React.FC<{
    address: Address;
    onChange: (field: keyof Address, value: string) => void;
    errors: FormErrors<Address>;
    prefix: string; // To differentiate field names if multiple addresses are on one page
    title?: string;
}> = ({ address, onChange, errors, prefix, title }) => {
    const handleFieldChange = (e: ChangeEvent<HTMLInputElement>) => {
        onChange(e.target.name.replace(`${prefix}.`, '') as keyof Address, e.target.value);
    };

    const countryOptions = [
        { value: 'USA', label: 'United States' },
        { value: 'CAN', label: 'Canada' },
        { value: 'MEX', label: 'Mexico' },
        { value: 'GBR', label: 'United Kingdom' },
        { value: 'AUS', label: 'Australia' },
        { value: 'OTH', label: 'Other' },
    ];

    const usStates = [
        { value: '', label: 'Select State', disabled: true },
        { value: 'AL', label: 'Alabama' }, { value: 'AK', label: 'Alaska' }, { value: 'AZ', label: 'Arizona' },
        { value: 'AR', label: 'Arkansas' }, { value: 'CA', label: 'California' }, { value: 'CO', label: 'Colorado' },
        { value: 'CT', label: 'Connecticut' }, { value: 'DE', label: 'Delaware' }, { value: 'FL', label: 'Florida' },
        { value: 'GA', label: 'Georgia' }, { value: 'HI', label: 'Hawaii' }, { value: 'ID', label: 'Idaho' },
        { value: 'IL', label: 'Illinois' }, { value: 'IN', label: 'Indiana' }, { value: 'IA', label: 'Iowa' },
        { value: 'KS', label: 'Kansas' }, { value: 'KY', label: 'Kentucky' }, { value: 'LA', label: 'Louisiana' },
        { value: 'ME', label: 'Maine' }, { value: 'MD

--- FILE: FeedbackHubView.tsx ---

import React, { useState, useMemo, useCallback, useRef, useEffect } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// ================================================================================================
// TYPE DEFINITIONS & MOCK DATA
// ================================================================================================

export type FeedbackStatus = 'New' | 'Under Review' | 'Planned' | 'Shipped' | 'Archived' | 'Rejected';
export type FeedbackPriority = 'Low' | 'Medium' | 'High' | 'Critical';
export type UserRole = 'Admin' | 'Moderator' | 'Member' | 'Guest';

export interface User {
    id: string;
    name: string;
    email: string;
    avatarUrl: string;
    role: UserRole;
    lastActive: string; // ISO date string
}

export interface Tag {
    id: string;
    name: string;
    color: string; // Tailwind color class or hex
    description?: string;
}

export interface Comment {
    id: string;
    userId: string;
    text: string;
    timestamp: string; // ISO date string
    parentId?: string; // For replies
    mentions?: string[]; // User IDs mentioned
    reactions?: { emoji: string; userId: string[] }[];
}

export interface Attachment {
    id: string;
    filename: string;
    filetype: string;
    url: string;
    uploadedBy: string;
    uploadedAt: string; // ISO date string
    thumbnailUrl?: string;
}

export type ActivityType = 'created' | 'status_changed' | 'assigned' | 'priority_changed' | 'commented' | 'voted' | 'tag_added' | 'tag_removed' | 'attachment_added' | 'edited';

export interface ActivityLogEntry {
    id: string;
    feedbackId: string;
    userId: string;
    timestamp: string; // ISO date string
    type: ActivityType;
    details: string; // e.g., "changed status from New to Under Review"
    oldValue?: string;
    newValue?: string;
}

export interface RoadmapItem {
    id: string;
    title: string;
    description: string;
    startDate: string; // ISO date string
    endDate: string; // ISO date string
    feedbackIds: string[]; // Link to related feedback items
    status: 'Upcoming' | 'In Progress' | 'Completed' | 'On Hold';
    ownerId: string; // User ID
    productArea: string;
    keyMetrics?: string[]; // e.g., "Increased user engagement by 15%"
}

export interface FeedbackItem {
    id: string;
    title: string;
    description: string;
    submitterId: string;
    votes: number;
    status: FeedbackStatus;
    priority: FeedbackPriority;
    tags: string[]; // Tag IDs
    assignedToId?: string; // User ID of assignee
    comments: Comment[];
    attachments: Attachment[];
    createdAt: string; // ISO date string
    updatedAt: string; // ISO date string
    lastActivityAt: string; // ISO date string
    resolutionNotes?: string; // For Shipped/Rejected/Archived
}

export interface AnalyticsData {
    feedbackByStatus: { [key: string]: number };
    topTags: { tagId: string; count: number }[];
    feedbackVelocity: { date: string; new: number; shipped: number }[];
    sentimentDistribution: { positive: number; negative: number; neutral: number };
}

// --- MOCK USERS ---
export const MOCK_USERS: User[] = [
    { id: 'user123', name: 'Alice Smith', email: 'alice@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=1', role: 'Member', lastActive: '2023-10-26T10:00:00Z' },
    { id: 'user456', name: 'Bob Johnson', email: 'bob@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=2', role: 'Member', lastActive: '2023-10-26T10:05:00Z' },
    { id: 'user789', name: 'Charlie Brown', email: 'charlie@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=3', role: 'Member', lastActive: '2023-10-26T09:45:00Z' },
    { id: 'dev_team_lead', name: 'Dev Lead', email: 'dev.lead@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=4', role: 'Admin', lastActive: '2023-10-26T10:30:00Z' },
    { id: 'prod_manager', name: 'Product Manager', email: 'pm@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=5', role: 'Moderator', lastActive: '2023-10-26T11:00:00Z' },
    { id: 'user321', name: 'Diana Prince', email: 'diana@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=6', role: 'Member', lastActive: '2023-10-26T08:30:00Z' },
    { id: 'user654', name: 'Eve Adams', email: 'eve@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=7', role: 'Member', lastActive: '2023-10-26T07:00:00Z' },
    { id: 'corp_user_1', name: 'Corporate User', email: 'corp@example.com', avatarUrl: 'https://i.pravatar.cc/150?img=8', role: 'Guest', lastActive: '2023-10-25T17:00:00Z' },
];

// --- MOCK TAGS ---
export const MOCK_TAGS: Tag[] = [
    { id: 'tag-uiux', name: 'UI/UX', color: 'bg-indigo-500/20 text-indigo-200' },
    { id: 'tag-mobile', name: 'Mobile', color: 'bg-green-500/20 text-green-200' },
    { id: 'tag-integration', name: 'Integration', color: 'bg-yellow-500/20 text-yellow-200' },
    { id: 'tag-taxes', name: 'Taxes', color: 'bg-red-500/20 text-red-200' },
    { id: 'tag-budgets', name: 'Budgets', color: 'bg-purple-500/20 text-purple-200' },
    { id: 'tag-feature', name: 'Feature Request', color: 'bg-blue-500/20 text-blue-200' },
    { id: 'tag-ai', name: 'AI', color: 'bg-pink-500/20 text-pink-200' },
    { id: 'tag-gamification', name: 'Gamification', color: 'bg-teal-500/20 text-teal-200' },
    { id: 'tag-goals', name: 'Goals', color: 'bg-orange-500/20 text-orange-200' },
    { id: 'tag-performance', name: 'Performance', color: 'bg-cyan-500/20 text-cyan-200' },
    { id: 'tag-bug', name: 'Bug', color: 'bg-red-700/20 text-red-300' },
    { id: 'tag-security', name: 'Security', color: 'bg-gray-600/20 text-gray-300' },
];

// Helper to get user and tag details by ID
export const getUserById = (id: string) => MOCK_USERS.find(u => u.id === id);
export const getTagById = (id: string) => MOCK_TAGS.find(t => t.id === id);

// --- MOCK FEEDBACK ITEMS ---
export const MOCK_FEEDBACK_ITEMS: FeedbackItem[] = [
    {
        id: 'FB-1', title: 'Dark Mode for Mobile App', description: 'The web app has a great dark mode, but the mobile app is still light. It would be great to have consistency and reduce eye strain, especially at night.', submitterId: 'user123', votes: 152, status: 'Planned', tags: ['tag-uiux', 'tag-mobile', 'tag-feature'], assignedToId: 'prod_manager', priority: 'High',
        comments: [
            { id: 'c1', userId: 'dev_team_lead', text: 'Good suggestion. Slated for Q4 release. We need to define design specs for both iOS and Android.', timestamp: '2023-10-20T10:00:00Z' },
            { id: 'c2', userId: 'user123', text: 'Awesome! Glad to hear this is coming.', timestamp: '2023-10-20T11:00:00Z', parentId: 'c1' },
        ],
        attachments: [], createdAt: '2023-10-15T09:00:00Z', updatedAt: '2023-10-20T11:00:00Z', lastActivityAt: '2023-10-20T11:00:00Z'
    },
    {
        id: 'FB-2', title: 'Integrate with TaxBot Pro', description: 'I use TaxBot Pro for my taxes, and a direct integration would save me hours of manual data entry. CSV export is clunky for complex portfolios.', submitterId: 'user456', votes: 98, status: 'Under Review', tags: ['tag-integration', 'tag-taxes', 'tag-feature'], assignedToId: 'dev_team_lead', priority: 'Medium',
        comments: [
            { id: 'c3', userId: 'prod_manager', text: 'We\'re exploring partner APIs for this. TaxBot Pro is a common request.', timestamp: '2023-10-22T14:30:00Z' }
        ],
        attachments: [{ id: 'a1', filename: 'taxbot-export-example.csv', filetype: 'text/csv', url: '/mock-attachments/taxbot.csv', uploadedBy: 'user456', uploadedAt: '2023-10-18T16:00:00Z' }], createdAt: '2023-10-18T10:00:00Z', updatedAt: '2023-10-22T14:30:00Z', lastActivityAt: '2023-10-22T14:30:00Z'
    },
    {
        id: 'FB-3', title: 'More granular budget categories', description: 'I would like to create sub-categories for my budgets, like "Groceries > Farmer\'s Market" or "Dining Out > Fast Food". This helps me track spending more precisely.', submitterId: 'user789', votes: 210, status: 'New', tags: ['tag-budgets', 'tag-feature', 'tag-uiux'], priority: 'High',
        comments: [], attachments: [], createdAt: '2023-10-25T11:00:00Z', updatedAt: '2023-10-25T11:00:00Z', lastActivityAt: '2023-10-25T11:00:00Z'
    },
    {
        id: 'FB-4', title: 'AI Ad Studio Video Length', description: 'Can we have options for longer videos? Currently limited to 15s. 30 seconds would be great for platform ads like YouTube pre-rolls or longer Instagram stories.', submitterId: 'corp_user_1', votes: 75, status: 'New', tags: ['tag-ai', 'tag-feature'], assignedToId: 'prod_manager', priority: 'Medium',
        comments: [
            { id: 'c4', userId: 'prod_manager', text: '@dev_team_lead - feasibility check on extending video generation for AI Studio?', timestamp: '2023-10-26T09:00:00Z', mentions: ['dev_team_lead'] }
        ],
        attachments: [], createdAt: '2023-10-24T14:00:00Z', updatedAt: '2023-10-26T09:00:00Z', lastActivityAt: '2023-10-26T09:00:00Z'
    },
    {
        id: 'FB-5', title: 'Gamify savings goals', description: 'It would be cool to get badges or achievements for hitting savings milestones, like "First $1000 Saved" or "Consistent Saver for 3 Months".', submitterId: 'user321', votes: 180, status: 'Planned', tags: ['tag-gamification', 'tag-goals', 'tag-feature'], assignedToId: 'prod_manager', priority: 'High',
        comments: [{ id: 'c5', userId: 'prod_manager', text: 'Great idea for engagement! Looking into design concepts for this. ✨', timestamp: '2023-10-23T10:00:00Z' }],
        attachments: [], createdAt: '2023-10-21T08:00:00Z', updatedAt: '2023-10-23T10:00:00Z', lastActivityAt: '2023-10-23T10:00:00Z'
    },
    {
        id: 'FB-6', title: 'CSV Transaction Export', description: 'The transaction view is great, but I need to export my data to CSV for my accountant. The current PDF export is not machine-readable.', submitterId: 'user654', votes: 120, status: 'Shipped', tags: ['tag-feature', 'tag-taxes'], priority: 'Medium',
        comments: [{ id: 'c6', userId: 'dev_team_lead', text: 'This was shipped in v2.10.1! You can find the option under "Settings -> Data Export".', timestamp: '2023-10-10T15:00:00Z' }],
        attachments: [], createdAt: '2023-10-01T09:00:00Z', updatedAt: '2023-10-10T15:00:00Z', lastActivityAt: '2023-10-10T15:00:00Z', resolutionNotes: 'Implemented in version 2.10.1. Users can now export transactions directly to CSV.'
    },
    {
        id: 'FB-7', title: 'Performance Degradation on Dashboard', description: 'My dashboard is very slow to load when I have many widgets. It takes upwards of 10-15 seconds.', submitterId: 'user123', votes: 85, status: 'Under Review', tags: ['tag-performance', 'tag-bug'], assignedToId: 'dev_team_lead', priority: 'Critical',
        comments: [{ id: 'c7', userId: 'dev_team_lead', text: 'Thanks for reporting. We\'re investigating. Can you provide browser/OS details?', timestamp: '2023-10-26T10:00:00Z' }],
        attachments: [], createdAt: '2023-10-25T16:00:00Z', updatedAt: '2023-10-26T10:00:00Z', lastActivityAt: '2023-10-26T10:00:00Z'
    },
    {
        id: 'FB-8', title: 'Add QR Code Scanner for Receipts', description: 'It would be amazing to scan physical receipts directly into the app and have it parse the transaction details.', submitterId: 'user789', votes: 190, status: 'New', tags: ['tag-feature', 'tag-mobile', 'tag-ai'], priority: 'High',
        comments: [], attachments: [], createdAt: '2023-10-26T08:00:00Z', updatedAt: '2023-10-26T08:00:00Z', lastActivityAt: '2023-10-26T08:00:00Z'
    },
    {
        id: 'FB-9', title: 'Two-Factor Authentication (2FA) for Login', description: 'For better security, please implement 2FA using TOTP apps like Authy or Google Authenticator.', submitterId: 'user321', votes: 250, status: 'Planned', tags: ['tag-security', 'tag-feature'], assignedToId: 'dev_team_lead', priority: 'Critical',
        comments: [{ id: 'c8', userId: 'dev_team_lead', text: 'This is a high priority item on our security roadmap for Q1 next year.', timestamp: '2023-10-24T12:00:00Z' }],
        attachments: [], createdAt: '2023-10-20T10:00:00Z', updatedAt: '2023-10-24T12:00:00Z', lastActivityAt: '2023-10-24T12:00:00Z'
    },
    {
        id: 'FB-10', title: 'Refactor UI to use new component library', description: 'The current UI is inconsistent. We need to refactor it to use the new internal component library across all views.', submitterId: 'prod_manager', votes: 50, status: 'Archived', tags: ['tag-uiux', 'tag-performance'], assignedToId: 'dev_team_lead', priority: 'High',
        comments: [{ id: 'c9', userId: 'dev_team_lead', text: 'This has been completed as part of Project Phoenix.', timestamp: '2023-09-30T17:00:00Z' }],
        attachments: [], createdAt: '2023-09-01T09:00:00Z', updatedAt: '2023-09-30T17:00:00Z', lastActivityAt: '2023-09-30T17:00:00Z', resolutionNotes: 'UI refactor completed. Archiving this feedback item.'
    },
];

// --- MOCK ACTIVITY LOGS ---
export const MOCK_ACTIVITY_LOGS: ActivityLogEntry[] = [
    { id: 'al-1', feedbackId: 'FB-1', userId: 'user123', timestamp: '2023-10-15T09:00:00Z', type: 'created', details: 'Feedback item created' },
    { id: 'al-2', feedbackId: 'FB-1', userId: 'dev_team_lead', timestamp: '2023-10-20T10:00:00Z', type: 'commented', details: 'Added comment: "Good suggestion. Slated for Q4 release. We need to define design specs for both iOS and Android."' },
    { id: 'al-3', feedbackId: 'FB-1', userId: 'prod_manager', timestamp: '2023-10-20T10:30:00Z', type: 'status_changed', details: 'Changed status from New to Planned', oldValue: 'New', newValue: 'Planned' },
    { id: 'al-4', feedbackId: 'FB-1', userId: 'prod_manager', timestamp: '2023-10-20T10:35:00Z', type: 'assigned', details: 'Assigned to Product Manager', newValue: 'prod_manager' },
    { id: 'al-5', feedbackId: 'FB-1', userId: 'user123', timestamp: '2023-10-20T11:00:00Z', type: 'commented', details: 'Added comment: "Awesome! Glad to hear this is coming."' },

    { id: 'al-6', feedbackId: 'FB-2', userId: 'user456', timestamp: '2023-10-18T10:00:00Z', type: 'created', details: 'Feedback item created' },
    { id: 'al-7', feedbackId: 'FB-2', userId: 'user456', timestamp: '2023-10-18T16:00:00Z', type: 'attachment_added', details: 'Added attachment: taxbot-export-example.csv' },
    { id: 'al-8', feedbackId: 'FB-2', userId: 'prod_manager', timestamp: '2023-10-22T14:00:00Z', type: 'status_changed', details: 'Changed status from New to Under Review', oldValue: 'New', newValue: 'Under Review' },
    { id: 'al-9', feedbackId: 'FB-2', userId: 'prod_manager', timestamp: '2023-10-22T14:30:00Z', type: 'commented', details: 'Added comment: "We\'re exploring partner APIs for this. TaxBot Pro is a common request."' },

    { id: 'al-10', feedbackId: 'FB-3', userId: 'user789', timestamp: '2023-10-25T11:00:00Z', type: 'created', details: 'Feedback item created' },
    { id: 'al-11', feedbackId: 'FB-3', userId: 'user789', timestamp: '2023-10-25T11:05:00Z', type: 'voted', details: 'Voted on item' },
    { id: 'al-12', feedbackId: 'FB-3', userId: 'user123', timestamp: '2023-10-25T12:00:00Z', type: 'voted', details: 'Voted on item' },

    { id: 'al-13', feedbackId: 'FB-4', userId: 'corp_user_1', timestamp: '2023-10-24T14:00:00Z', type: 'created', details: 'Feedback item created' },
    { id: 'al-14', feedbackId: 'FB-4', userId: 'prod_manager', timestamp: '2023-10-26T09:00:00Z', type: 'commented', details: 'Added comment: "@dev_team_lead - feasibility check on extending video generation for AI Studio?"' },

    { id: 'al-15', feedbackId: 'FB-6', userId: 'user654', timestamp: '2023-10-01T09:00:00Z', type: 'created', details: 'Feedback item created' },
    { id: 'al-16', feedbackId: 'FB-6', userId: 'dev_team_lead', timestamp: '2023-10-10T15:00:00Z', type: 'status_changed', details: 'Changed status from New to Shipped', oldValue: 'New', newValue: 'Shipped' },
    { id: 'al-17', feedbackId: 'FB-6', userId: 'dev_team_lead', timestamp: '2023-10-10T15:05:00Z', type: 'commented', details: 'Added comment: "This was shipped in v2.10.1! You can find the option under \'Settings -> Data Export\'."' },

    { id: 'al-18', feedbackId: 'FB-7', userId: 'user123', timestamp: '2023-10-25T16:00:00Z', type: 'created', details: 'Feedback item created' },
    { id: 'al-19', feedbackId: 'FB-7', userId: 'dev_team_lead', timestamp: '2023-10-26T10:00:00Z', type: 'commented', details: 'Added comment: "Thanks for reporting. We\'re investigating. Can you provide browser/OS details?"' },
    { id: 'al-20', feedbackId: 'FB-7', userId: 'dev_team_lead', timestamp: '2023-10-26T10:05:00Z', type: 'status_changed', details: 'Changed status from New to Under Review', oldValue: 'New', newValue: 'Under Review' },
];

// --- MOCK ROADMAP ITEMS ---
export const MOCK_ROADMAP_ITEMS: RoadmapItem[] = [
    {
        id: 'RM-1', title: 'Mobile Dark Mode Release', description: 'Rollout of a consistent dark mode theme for both iOS and Android applications to enhance user experience during low-light conditions.',
        startDate: '2023-11-01T00:00:00Z', endDate: '2023-11-30T23:59:59Z', feedbackIds: ['FB-1'], status: 'In Progress', ownerId: 'prod_manager', productArea: 'Mobile App', keyMetrics: ['95% design consistency compliance', '20% increase in evening session duration']
    },
    {
        id: 'RM-2', title: 'Tax Integration with TaxBot Pro', description: 'Develop and deploy a direct API integration with TaxBot Pro for seamless data synchronization.',
        startDate: '2024-01-15T00:00:00Z', endDate: '2024-03-31T23:59:59Z', feedbackIds: ['FB-2'], status: 'Upcoming', ownerId: 'dev_team_lead', productArea: 'Integrations', keyMetrics: ['Reduce manual data entry support tickets by 30%', 'Achieve 4-star average user rating for integration']
    },
    {
        id: 'RM-3', title: 'Gamified Savings System', description: 'Introduce a badge and achievement system to encourage users to meet their financial savings goals.',
        startDate: '2023-12-01T00:00:00Z', endDate: '2024-01-15T23:59:59Z', feedbackIds: ['FB-5'], status: 'Planned', ownerId: 'prod_manager', productArea: 'Engagement', keyMetrics: ['10% increase in active savings goals', '5% increase in retention rate for new users']
    },
    {
        id: 'RM-4', title: 'Core Dashboard Performance Boost', description: 'Optimize database queries, frontend rendering, and API response times to improve dashboard loading speed significantly.',
        startDate: '2023-11-15T00:00:00Z', endDate: '2024-01-31T23:59:59Z', feedbackIds: ['FB-7'], status: 'In Progress', ownerId: 'dev_team_lead', productArea: 'Platform Core', keyMetrics: ['Dashboard load time < 3 seconds', 'Reduce average API response time by 50ms']
    },
];

export const COLUMNS: FeedbackStatus[] = ['New', 'Under Review', 'Planned', 'Shipped', 'Archived', 'Rejected'];
export const PRIORITIES: FeedbackPriority[] = ['Critical', 'High', 'Medium', 'Low'];

// ================================================================================================
// UTILITY FUNCTIONS & HOOKS
// ================================================================================================

export const formatDate = (isoString: string) => {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

export const timeAgo = (isoString: string) => {
    if (!isoString) return 'N/A';
    const seconds = Math.floor((new Date().getTime() - new Date(isoString).getTime()) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
};

export const useUniqueId = (prefix: string = 'id-') => {
    const [id] = useState(() => `${prefix}${Math.random().toString(36).substr(2, 9)}`);
    return id;
};

export const useAIIntegration = () => {
    const [aiClient] = useState(() => new GoogleGenAI({ apiKey: process.env.API_KEY as string }));

    const analyzeSentiment = useCallback(async (title: string, description: string) => {
        try {
            const prompt = `Analyze the sentiment of this user feedback. Is it Positive, Negative, or Neutral? Provide a confidence score from 0 to 1. ONLY respond with JSON in the format: {"sentiment": "SentimentValue", "confidence": 0.X}. Feedback: "${title}. ${description}"`;
            const model = aiClient.getGenerativeModel({ model: 'gemini-pro' });
            const result = await model.generateContent(prompt);
            const responseText = result.response.text();
            const parsed = JSON.parse(responseText.replace(/```json|```/g, '').trim()); // Clean markdown code blocks
            return { sentiment: parsed.sentiment, confidence: parseFloat(parsed.confidence) * 100 };
        } catch (err) {
            console.error("AI Sentiment analysis failed:", err);
            return { sentiment: 'Neutral', confidence: 50 };
        }
    }, [aiClient]);

    const generateResponse = useCallback(async (feedback: FeedbackItem, context: string) => {
        try {
            const prompt = `Given the user feedback and current context, generate a helpful and empathetic response from a product team member. The response should be concise and address the user's main point.
Feedback Title: ${feedback.title}
Feedback Description: ${feedback.description}
Current Status: ${feedback.status}
Context: ${context}
Proposed Response:`;
            const model = aiClient.getGenerativeModel({ model: 'gemini-pro' });
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (err) {
            console.error("AI Response generation failed:", err);
            return "Apologies, I'm having trouble generating a response right now. Please try again later.";
        }
    }, [aiClient]);

    const suggestTags = useCallback(async (title: string, description: string) => {
        try {
            const currentTags = MOCK_TAGS.map(t => t.name).join(', ');
            const prompt = `Based on the following feedback, suggest up to 3 relevant tags from this list: ${currentTags}. Return tags as a comma-separated string, e.g., "UI/UX, Mobile".
Feedback Title: ${title}
Feedback Description: ${description}
Suggested Tags:`;
            const model = aiClient.getGenerativeModel({ model: 'gemini-pro' });
            const result = await model.generateContent(prompt);
            const text = result.response.text();
            return text.split(',').map(tag => tag.trim()).filter(tag => MOCK_TAGS.some(t => t.name === tag));
        } catch (err) {
            console.error("AI Tag suggestion failed:", err);
            return [];
        }
    }, [aiClient]);

    const summarizeFeedback = useCallback(async (feedback: FeedbackItem) => {
        try {
            const prompt = `Summarize the following feedback item, including its title, description, and the main points from its comments. Keep the summary under 100 words.
Feedback Title: ${feedback.title}
Description: ${feedback.description}
Comments: ${feedback.comments.map(c => `${getUserById(c.userId)?.name}: ${c.text}`).join('; ')}
Summary:`;
            const model = aiClient.getGenerativeModel({ model: 'gemini-pro' });
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (err) {
            console.error("AI Summarization failed:", err);
            return "Could not generate summary.";
        }
    }, [aiClient]);

    return { analyzeSentiment, generateResponse, suggestTags, summarizeFeedback };
};

// ================================================================================================
// SHARED UI COMPONENTS (e.g., Avatar, TagPill, Button)
// ================================================================================================

export const Avatar: React.FC<{ user: User; size?: 'sm' | 'md' | 'lg' }> = ({ user, size = 'md' }) => {
    const sizeClasses = {
        sm: 'w-6 h-6 text-xs',
        md: 'w-8 h-8 text-sm',
        lg: 'w-10 h-10 text-base',
    };
    return (
        <img
            src={user.avatarUrl}
            alt={user.name}
            title={user.name}
            className={`rounded-full object-cover ${sizeClasses[size]}`}
            onError={(e) => {
                const target = e.target as HTMLImageElement;
                target.onerror = null; // Prevent infinite loop
                target.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=334155&color=fff&size=128`;
            }}
        />
    );
};

export const TagPill: React.FC<{ tagId: string; onRemove?: (tagId: string) => void; interactive?: boolean }> = ({ tagId, onRemove, interactive = false }) => {
    const tag = getTagById(tagId);
    if (!tag) return null;
    return (
        <span className={`${tag.color} px-2 py-0.5 rounded-full text-xs font-medium flex items-center gap-1`}>
            {tag.name}
            {interactive && onRemove && (
                <button onClick={() => onRemove(tagId)} className="ml-1 -mr-1 text-white/70 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            )}
        </span>
    );
};

export const Button: React.FC<React.ButtonHTMLAttributes<HTMLButtonElement> & { variant?: 'primary' | 'secondary' | 'danger' | 'ghost'; size?: 'sm' | 'md' | 'lg'; loading?: boolean }> = ({
    children, variant = 'primary', size = 'md', loading = false, className = '', ...props
}) => {
    const baseClasses = "font-semibold rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800";
    const variantClasses = {
        primary: "bg-cyan-600 text-white hover:bg-cyan-700 focus:ring-cyan-500",
        secondary: "bg-gray-700 text-gray-200 hover:bg-gray-600 focus:ring-gray-500",
        danger: "bg-red-600 text-white hover:bg-red-700 focus:ring-red-500",
        ghost: "text-gray-400 hover:bg-gray-700 hover:text-white focus:ring-gray-500"
    };
    const sizeClasses = {
        sm: "px-3 py-1.5 text-sm",
        md: "px-4 py-2 text-base",
        lg: "px-5 py-2.5 text-lg"
    };

    return (
        <button
            className={`${baseClasses} ${variantClasses[variant]} ${sizeClasses[size]} ${loading ? 'opacity-70 cursor-not-allowed' : ''} ${className}`}
            disabled={loading || props.disabled}
            {...props}
        >
            {loading ? (
                <svg className="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            ) : children}
        </button>
    );
};

export const Input: React.FC<React.InputHTMLAttributes<HTMLInputElement>> = (props) => (
    <input className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500" {...props} />
);

export const Select: React.FC<React.SelectHTMLAttributes<HTMLSelectElement>> = (props) => (
    <select className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500" {...props} />
);

export const Textarea: React.FC<React.TextareaHTMLAttributes<HTMLTextAreaElement>> = (props) => (
    <textarea className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 min-h-[80px]" {...props} />
);

export const Modal: React.FC<{ isOpen: boolean; onClose: () => void; title: string; children: React.ReactNode; size?: 'sm' | 'md' | 'lg' | 'xl' }> = ({ isOpen, onClose, title, children, size = 'md' }) => {
    if (!isOpen) return null;
    const sizeClasses = {
        sm: 'max-w-md',
        md: 'max-w-2xl',
        lg: 'max-w-4xl',
        xl: 'max-w-6xl',
    };
    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className={`bg-gray-800 rounded-lg shadow-2xl ${sizeClasses[size]} w-full border border-gray-700`} onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">{title}</h3>
                    <Button variant="ghost" size="sm" onClick={onClose}>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </Button>
                </div>
                <div className="p-6 max-h-[80vh] overflow-y-auto">
                    {children}
                </div>
            </div>
        </div>
    );
};

// ================================================================================================
// SUB-COMPONENTS (Detailed)
// ================================================================================================

export const CommentSection: React.FC<{ comments: Comment[]; feedbackId: string; currentUserId: string; onAddComment: (feedbackId: string, userId: string, text: string, parentId?: string) => void }> = ({ comments, feedbackId, currentUserId, onAddComment }) => {
    const [newCommentText, setNewCommentText] = useState('');
    const [replyTo, setReplyTo] = useState<string | null>(null); // Comment ID being replied to

    const handleAddComment = () => {
        if (newCommentText.trim()) {
            onAddComment(feedbackId, currentUserId, newCommentText, replyTo || undefined);
            setNewCommentText('');
            setReplyTo(null);
        }
    };

    const rootComments = comments.filter(c => !c.parentId);

    const renderComment = (comment: Comment) => {
        const user = getUserById(comment.userId);
        const replies = comments.filter(c => c.parentId === comment.id);

        return (
            <div key={comment.id} className={`flex gap-3 ${comment.parentId ? 'ml-8 mt-4' : 'mt-4'}`}>
                {user && <Avatar user={user} size="sm" />}
                <div className="flex-1 bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div className="flex justify-between items-center mb-1">
                        <span className="font-semibold text-gray-200">{user?.name || 'Unknown User'}</span>
                        <span className="text-xs text-gray-500">{timeAgo(comment.timestamp)}</span>
                    </div>
                    <p className="text-sm text-gray-300 whitespace-pre-wrap">
                        {comment.text.split(' ').map((word, index) => {
                            if (word.startsWith('@') && MOCK_USERS.some(u => u.name.toLowerCase().replace(/\s/g, '') === word.substring(1).toLowerCase())) {
                                const mentionedUser = MOCK_USERS.find(u => u.name.toLowerCase().replace(/\s/g, '') === word.substring(1).toLowerCase());
                                return <span key={index} className="text-cyan-400 font-medium cursor-pointer hover:underline">@{mentionedUser?.name || word.substring(1)} </span>;
                            }
                            return <span key={index}>{word} </span>;
                        })}
                    </p>
                    <div className="mt-2 text-xs text-gray-500">
                        <Button variant="ghost" size="sm" onClick={() => setReplyTo(comment.id)} className="p-1">Reply</Button>
                    </div>
                    {replies.map(renderComment)}
                </div>
            </div>
        );
    };

    return (
        <div>
            <h4 className="font-semibold text-gray-200 border-t border-gray-700 pt-4 mt-6">Comments ({comments.length})</h4>
            <div className="max-h-60 overflow-y-auto pr-2">
                {rootComments.length > 0 ? (
                    rootComments.map(renderComment)
                ) : (
                    <p className="text-sm text-gray-500 mt-4">No comments yet. Be the first to add one!</p>
                )}
            </div>
            <div className="mt-4 border-t border-gray-700 pt-4">
                {replyTo && (
                    <div className="flex items-center gap-2 mb-2 text-sm text-gray-400">
                        Replying to {getUserById(comments.find(c => c.id === replyTo)?.userId || '')?.name}
                        <Button variant="ghost" size="sm" onClick={() => setReplyTo(null)} className="p-1 text-red-400">Cancel</Button>
                    </div>
                )}
                <Textarea
                    placeholder={replyTo ? 'Add a reply...' : 'Add a new comment...'}
                    value={newCommentText}
                    onChange={(e) => setNewCommentText(e.target.value)}
                    className="mb-2"
                />
                <Button onClick={handleAddComment} disabled={!newCommentText.trim()}>Add Comment</Button>
            </div>
        </div>
    );
};

export const ActivityLog: React.FC<{ logs: ActivityLogEntry[] }> = ({ logs }) => {
    return (
        <div>
            <h4 className="font-semibold text-gray-200 border-t border-gray-700 pt-4 mt-6">Activity Log ({logs.length})</h4>
            <div className="max-h-60 overflow-y-auto pr-2 mt-4 space-y-3">
                {logs.length > 0 ? (
                    logs.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()).map(log => {
                        const user = getUserById(log.userId);
                        return (
                            <div key={log.id} className="flex items-start gap-3 text-sm text-gray-400">
                                {user && <Avatar user={user} size="sm" />}
                                <div className="flex-1">
                                    <span className="font-medium text-gray-200">{user?.name || 'Unknown'}</span> {' '}
                                    <span className="text-gray-300">{log.details}</span>
                                    <span className="text-gray-500 block text-xs">{formatDate(log.timestamp)}</span>
                                </div>
                            </div>
                        );
                    })
                ) : (
                    <p className="text-sm text-gray-500">No activity yet.</p>
                )}
            </div>
        </div>
    );
};

export const AttachmentDisplay: React.FC<{ attachments: Attachment[]; onRemove?: (attachmentId: string) => void }> = ({ attachments, onRemove }) => {
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [uploading, setUploading] = useState(false);

    const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
        if (event.target.files && event.target.files.length > 0) {
            setUploading(true);
            const file = event.target.files[0];
            // Simulate upload
            await new Promise(resolve => setTimeout(resolve, 1500));
            console.log(`Mock uploaded: ${file.name}`);
            setUploading(false);
            if (fileInputRef.current) fileInputRef.current.value = ''; // Clear input
            // In a real app, you'd add this to feedback item state
        }
    };

    return (
        <div>
            <h4 className="font-semibold text-gray-200 border-t border-gray-700 pt-4 mt-6">Attachments ({attachments.length})</h4>
            <div className="mt-4 space-y-3">
                {attachments.length > 0 ? (
                    attachments.map(att => (
                        <div key={att.id} className="flex items-center justify-between bg-gray-900/50 p-2 rounded-lg border border-gray-700">
                            <a href={att.url} target="_blank" rel="noopener noreferrer" className="text-sm text-cyan-400 hover:underline flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                                {att.filename} ({Math.round(Math.random() * 1000) / 100} MB)
                            </a>
                            {onRemove && (
                                <Button variant="ghost" size="sm" onClick={() => onRemove(att.id)} className="text-red-400 p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H9a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </Button>
                            )}
                        </div>
                    ))
                ) : (
                    <p className="text-sm text-gray-500">No attachments.</p>
                )}
            </div>
            <div className="mt-4">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    id="attachment-upload-input"
                    disabled={uploading}
                />
                <Button variant="secondary" onClick={() => fileInputRef.current?.click()} loading={uploading}>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                    Add Attachment
                </Button>
            </div>
        </div>
    );
};

export const AICoPilotPanel: React.FC<{ feedback: FeedbackItem }> = ({ feedback }) => {
    const { analyzeSentiment, generateResponse, suggestTags, summarizeFeedback } = useAIIntegration();
    const [aiSentiment, setAiSentiment] = useState<{ sentiment: string; confidence: number } | null>(null);
    const [responsePrompt, setResponsePrompt] = useState('');
    const [generatedResponse, setGeneratedResponse] = useState<string | null>(null);
    const [suggestedTags, setSuggestedTags] = useState<string[]>([]);
    const [summary, setSummary] = useState<string | null>(null);

    const [isLoadingSentiment, setIsLoadingSentiment] = useState(false);
    const [isLoadingResponse, setIsLoadingResponse] = useState(false);
    const [isLoadingTags, setIsLoadingTags] = useState(false);
    const [isLoadingSummary, setIsLoadingSummary] = useState(false);

    const handleAnalyzeSentiment = useCallback(async () => {
        setIsLoadingSentiment(true);
        const result = await analyzeSentiment(feedback.title, feedback.description);
        setAiSentiment(result);
        setIsLoadingSentiment(false);
    }, [analyzeSentiment, feedback.title, feedback.description]);

    const handleGenerateResponse = useCallback(async () => {
        setIsLoadingResponse(true);
        const result = await generateResponse(feedback, responsePrompt);
        setGeneratedResponse(result);
        setIsLoadingResponse(false);
    }, [generateResponse, feedback, responsePrompt]);

    const handleSuggestTags = useCallback(async () => {
        setIsLoadingTags(true);
        const result = await suggestTags(feedback.title, feedback.description);
        setSuggestedTags(result);
        setIsLoadingTags(false);
    }, [suggestTags, feedback.title, feedback.description]);

    const handleSummarizeFeedback = useCallback(async () => {
        setIsLoadingSummary(true);
        const result = await summarizeFeedback(feedback);
        setSummary(result);
        setIsLoadingSummary(false);
    }, [summarizeFeedback, feedback]);

    useEffect(() => {
        // Reset AI states when feedback changes
        setAiSentiment(null);
        setGeneratedResponse(null);
        setSuggestedTags([]);
        setSummary(null);
        setResponsePrompt('');
    }, [feedback.id]);

    return (
        <Card title="AI Co-pilot" className="space-y-4">
            <div className="space-y-2">
                <h5 className="text-sm font-medium text-gray-200">Sentiment Analysis</h5>
                {!aiSentiment && !isLoadingSentiment && <Button size="sm" variant="secondary" onClick={handleAnalyzeSentiment}>Analyze Sentiment</Button>}
                {isLoadingSentiment && <p className="text-sm text-gray-400">Analyzing...</p>}
                {aiSentiment && <p className="text-sm font-semibold" style={{ color: aiSentiment.sentiment === 'Positive' ? '#22c55e' : aiSentiment.sentiment === 'Negative' ? '#ef4444' : '#e5e7eb' }}>{aiSentiment.sentiment} ({aiSentiment.confidence.toFixed(0)}%)</p>}
            </div>

            <div className="space-y-2 border-t border-gray-700 pt-4">
                <h5 className="text-sm font-medium text-gray-200">Suggested Response</h5>
                <Textarea
                    placeholder="Provide context for the AI, e.g., 'User is asking for an ETA'"
                    value={responsePrompt}
                    onChange={(e) => setResponsePrompt(e.target.value)}
                    rows={2}
                />
                <Button size="sm" variant="secondary" onClick={handleGenerateResponse} loading={isLoadingResponse} disabled={!responsePrompt.trim()}>Generate Response</Button>
                {generatedResponse && (
                    <div className="bg-gray-700/50 p-3 rounded-md text-sm text-gray-300 whitespace-pre-wrap">
                        {generatedResponse}
                    </div>
                )}
            </div>

            <div className="space-y-2 border-t border-gray-700 pt-4">
                <h5 className="text-sm font-medium text-gray-200">Tag Suggestions</h5>
                {!suggestedTags.length && !isLoadingTags && <Button size="sm" variant="secondary" onClick={handleSuggestTags}>Suggest Tags</Button>}
                {isLoadingTags && <p className="text-sm text-gray-400">Suggesting...</p>}
                {suggestedTags.length > 0 && (
                    <div className="flex flex-wrap gap-1">
                        {suggestedTags.map(tagName => {
                            const tag = MOCK_TAGS.find(t => t.name === tagName);
                            return tag ? <TagPill key={tag.id} tagId={tag.id} /> : null;
                        })}
                    </div>
                )}
            </div>

            <div className="space-y-2 border-t border-gray-700 pt-4">
                <h5 className="text-sm font-medium text-gray-200">Feedback Summary</h5>
                {!summary && !isLoadingSummary && <Button size="sm" variant="secondary" onClick={handleSummarizeFeedback}>Summarize Feedback</Button>}
                {isLoadingSummary && <p className="text-sm text-gray-400">Summarizing...</p>}
                {summary && (
                    <div className="bg-gray-700/50 p-3 rounded-md text-sm text-gray-300 whitespace-pre-wrap">
                        {summary}
                    </div>
                )}
            </div>
        </Card>
    );
};

export const FeedbackDetailModal: React.FC<{ item: FeedbackItem | null; onClose: () => void; onUpdateItem: (updatedItem: FeedbackItem, activityLog: ActivityLogEntry) => void; onAddComment: (feedbackId: string, userId: string, text: string, parentId?: string) => void }> = ({ item, onClose, onUpdateItem, onAddComment }) => {
    const [activeTab, setActiveTab] = useState<'details' | 'comments' | 'activity' | 'ai-copilot'>('details');
    const [editMode, setEditMode] = useState(false);
    const [editedTitle, setEditedTitle] = useState('');
    const [editedDescription, setEditedDescription] = useState('');
    const [editedStatus, setEditedStatus] = useState<FeedbackStatus>('New');
    const [editedPriority, setEditedPriority] = useState<FeedbackPriority>('Medium');
    const [editedAssignee, setEditedAssignee] = useState<string | undefined>(undefined);
    const [editedTags, setEditedTags] = useState<string[]>([]);

    useEffect(() => {
        if (item) {
            setEditedTitle(item.title);
            setEditedDescription(item.description);
            setEditedStatus(item.status);
            setEditedPriority(item.priority);
            setEditedAssignee(item.assignedToId);
            setEditedTags(item.tags);
        }
    }, [item]);

    if (!item) return null;

    const allLogsForThisItem = MOCK_ACTIVITY_LOGS.filter(log => log.feedbackId === item.id);
    const submitter = getUserById(item.submitterId);
    const assignee = item.assignedToId ? getUserById(item.assignedToId) : null;

    const handleSaveEdits = () => {
        const updatedItem = { ...item, title: editedTitle, description: editedDescription, status: editedStatus, priority: editedPriority, assignedToId: editedAssignee, tags: editedTags, updatedAt: new Date().toISOString(), lastActivityAt: new Date().toISOString() };
        let activityDetails = '';
        let activityType: ActivityType = 'edited';
        if (item.status !== editedStatus) {
            activityDetails = `Changed status from ${item.status} to ${editedStatus}`;
            activityType = 'status_changed';
        } else if (item.priority !== editedPriority) {
            activityDetails = `Changed priority from ${item.priority} to ${editedPriority}`;
            activityType = 'priority_changed';
        } else if (item.assignedToId !== editedAssignee) {
            activityDetails = `Assigned to ${getUserById(editedAssignee || '')?.name || 'Unassigned'}`;
            activityType = 'assigned';
        } else if (item.tags.join(',') !== editedTags.join(',')) {
            activityDetails = `Tags updated: ${item.tags.map(t => getTagById(t)?.name).join(', ')} -> ${editedTags.map(t => getTagById(t)?.name).join(', ')}`;
            activityType = 'tag_added'; // or removed
        } else {
            activityDetails = 'Edited feedback details';
        }

        const newLog: ActivityLogEntry = {
            id: useUniqueId('al-'), feedbackId: item.id, userId: 'dev_team_lead', // Assume a current user for action
            timestamp: new Date().toISOString(), type: activityType, details: activityDetails
        };
        onUpdateItem(updatedItem, newLog);
        setEditMode(false);
    };

    const handleAddTag = (tagId: string) => {
        if (!editedTags.includes(tagId)) {
            setEditedTags(prev => [...prev, tagId]);
        }
    };

    const handleRemoveTag = (tagId: string) => {
        setEditedTags(prev => prev.filter(t => t !== tagId));
    };

    const handleVote = () => {
        const newVotes = item.votes + 1; // Simplified, in real app, track user votes
        const updatedItem = { ...item, votes: newVotes, lastActivityAt: new Date().toISOString() };
        const newLog: ActivityLogEntry = {
            id: useUniqueId('al-'), feedbackId: item.id, userId: 'user123', // Mock voter
            timestamp: new Date().toISOString(), type: 'voted', details: 'Voted on item'
        };
        onUpdateItem(updatedItem, newLog);
    };


    return (
        <Modal isOpen={item !== null} onClose={onClose} title={editMode ? `Edit: ${item.title}` : item.title} size="lg">
            <div className="grid grid-cols-4 gap-6">
                <div className="col-span-3">
                    <div className="flex items-center gap-4 mb-4">
                        <h3 className="text-2xl font-bold text-white">{editMode ? <Input value={editedTitle} onChange={(e) => setEditedTitle(e.target.value)} /> : item.title}</h3>
                        {submitter && <p className="text-sm text-gray-400">Submitted by <span className="font-semibold text-gray-300">{submitter.name}</span></p>}
                    </div>

                    <div className="border-b border-gray-700 mb-4">
                        <nav className="flex space-x-4">
                            {['details', 'comments', 'activity', 'ai-copilot'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab as any)}
                                    className={`py-2 px-3 text-sm font-medium border-b-2 ${activeTab === tab ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-white hover:border-gray-500'}`}
                                >
                                    {tab.charAt(0).toUpperCase() + tab.slice(1).replace('-', ' ')}
                                </button>
                            ))}
                        </nav>
                    </div>

                    {activeTab === 'details' && (
                        <div className="space-y-4">
                            <p className="text-sm text-gray-300 mb-4">{editMode ? <Textarea value={editedDescription} onChange={(e) => setEditedDescription(e.target.value)} /> : item.description}</p>
                            <AttachmentDisplay attachments={item.attachments} onRemove={editMode ? (id) => console.log('Remove attachment', id) : undefined} />
                        </div>
                    )}

                    {activeTab === 'comments' && (
                        <CommentSection comments={item.comments} feedbackId={item.id} currentUserId={'dev_team_lead'} onAddComment={onAddComment} />
                    )}

                    {activeTab === 'activity' && (
                        <ActivityLog logs={allLogsForThisItem} />
                    )}

                    {activeTab === 'ai-copilot' && (
                        <AICoPilotPanel feedback={item} />
                    )}
                </div>

                <div className="col-span-1 space-y-4">
                    <Card title="Details">
                        <div className="text-xs space-y-2">
                            <p><strong className="text-gray-400">Votes:</strong> {item.votes} <Button variant="ghost" size="sm" onClick={handleVote} className="ml-2 p-1"><svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg> Vote</Button></p>
                            <p><strong className="text-gray-400">Status:</strong> {editMode ? (
                                <Select value={editedStatus} onChange={(e) => setEditedStatus(e.target.value as FeedbackStatus)}>
                                    {COLUMNS.map(s => <option key={s} value={s}>{s}</option>)}
                                </Select>
                            ) : item.status}</p>
                            <p><strong className="text-gray-400">Priority:</strong> {editMode ? (
                                <Select value={editedPriority} onChange={(e) => setEditedPriority(e.target.value as FeedbackPriority)}>
                                    {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                                </Select>
                            ) : item.priority}</p>
                            <p className="flex items-center gap-2"><strong className="text-gray-400">Assigned To:</strong>
                                {editMode ? (
                                    <Select value={editedAssignee || ''} onChange={(e) => setEditedAssignee(e.target.value || undefined)}>
                                        <option value="">Unassigned</option>
                                        {MOCK_USERS.filter(u => ['Admin', 'Moderator'].includes(u.role)).map(u => (
                                            <option key={u.id} value={u.id}>{u.name}</option>
                                        ))}
                                    </Select>
                                ) : (assignee ? <div className="flex items-center gap-1"><Avatar user={assignee} size="sm" /> {assignee.name}</div> : 'Unassigned')}</p>
                            <p><strong className="text-gray-400">Submitted:</strong> {formatDate(item.createdAt)}</p>
                            <p><strong className="text-gray-400">Last Activity:</strong> {timeAgo(item.lastActivityAt)}</p>
                            <div>
                                <strong className="text-gray-400">Tags:</strong>
                                <div className="flex flex-wrap gap-1 mt-2">
                                    {editedTags.map(tId => <TagPill key={tId} tagId={tId} interactive={editMode} onRemove={handleRemoveTag} />)}
                                    {editMode && (
                                        <Select className="text-xs p-1 h-fit" onChange={(e) => handleAddTag(e.target.value)} value="">
                                            <option value="" disabled>Add Tag...</option>
                                            {MOCK_TAGS.filter(t => !editedTags.includes(t.id)).map(t => (
                                                <option key={t.id} value={t.id}>{t.name}</option>
                                            ))}
                                        </Select>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end mt-4 gap-2">
                            {!editMode ? (
                                <Button variant="secondary" onClick={() => setEditMode(true)}>Edit</Button>
                            ) : (
                                <>
                                    <Button variant="ghost" onClick={() => { setEditMode(false); }} className="text-gray-400">Cancel</Button>
                                    <Button onClick={handleSaveEdits}>Save Changes</Button>
                                </>
                            )}
                        </div>
                    </Card>
                    {item.resolutionNotes && (
                        <Card title="Resolution Notes">
                            <p className="text-sm text-gray-300 italic">{item.resolutionNotes}</p>
                        </Card>
                    )}
                </div>
            </div>
        </Modal>
    );
};

export const FeedbackCardComponent: React.FC<{ item: FeedbackItem; onClick: (item: FeedbackItem) => void }> = React.memo(({ item, onClick }) => {
    const submitter = getUserById(item.submitterId);
    const assignee = item.assignedToId ? getUserById(item.assignedToId) : null;

    return (
        <div key={item.id} onClick={() => onClick(item)} className="p-3 bg-gray-800/80 rounded-lg cursor-pointer border border-gray-700 hover:border-cyan-500 transition-all duration-200 shadow-md">
            <p className="text-sm font-semibold text-gray-200 mb-2">{item.title}</p>
            <p className="text-xs text-gray-400 mb-2 truncate">{item.description}</p>
            <div className="flex flex-wrap gap-1 mb-2">
                {item.tags.slice(0, 2).map(tId => <TagPill key={tId} tagId={tId} />)}
            </div>
            <div className="flex justify-between items-center mt-3 text-xs text-gray-400">
                <div className="flex items-center gap-2">
                    <span className="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>
                        {item.votes}
                    </span>
                    <span className="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                        {item.comments.length}
                    </span>
                    {item.attachments.length > 0 && (
                        <span className="flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13.5" /></svg>
                            {item.attachments.length}
                        </span>
                    )}
                </div>
                {assignee && <Avatar user={assignee} size="sm" />}
                {!assignee && submitter && <Avatar user={submitter} size="sm" />}
            </div>
        </div>
    );
});

export const FeedbackSubmissionForm: React.FC<{ onSubmit: (item: Omit<FeedbackItem, 'id' | 'votes' | 'comments' | 'attachments' | 'createdAt' | 'updatedAt' | 'lastActivityAt'>) => void; onClose: () => void }> = ({ onSubmit, onClose }) => {
    const [title, setTitle] = useState('');
    const [description, setDescription] = useState('');
    const [selectedTags, setSelectedTags] = useState<string[]>([]);
    const [priority, setPriority] = useState<FeedbackPriority>('Medium');
    const [submitting, setSubmitting] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!title.trim() || !description.trim()) {
            alert('Title and Description are required!');
            return;
        }
        setSubmitting(true);
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        onSubmit({
            title, description, submitterId: 'user123', // Mock current user
            status: 'New', priority, tags: selectedTags
        });
        setSubmitting(false);
        onClose();
    };

    const handleAddTag = (tagId: string) => {
        if (!selectedTags.includes(tagId)) {
            setSelectedTags(prev => [...prev, tagId]);
        }
    };

    const handleRemoveTag = (tagId: string) => {
        setSelectedTags(prev => prev.filter(t => t !== tagId));
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div>
                <label htmlFor="title" className="block text-sm font-medium text-gray-300 mb-1">Title</label>
                <Input id="title" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Summarize your feedback" required />
            </div>
            <div>
                <label htmlFor="description" className="block text-sm font-medium text-gray-300 mb-1">Description</label>
                <Textarea id="description" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Provide detailed information, screenshots, use cases, etc." rows={5} required />
            </div>
            <div>
                <label htmlFor="priority" className="block text-sm font-medium text-gray-300 mb-1">Priority</label>
                <Select id="priority" value={priority} onChange={(e) => setPriority(e.target.value as FeedbackPriority)}>
                    {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                </Select>
            </div>
            <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Tags</label>
                <div className="flex flex-wrap gap-2 mb-2">
                    {selectedTags.map(tId => <TagPill key={tId} tagId={tId} interactive onRemove={handleRemoveTag} />)}
                    <Select className="text-xs p-1 h-fit" onChange={(e) => handleAddTag(e.target.value)} value="">
                        <option value="" disabled>Add Tag...</option>
                        {MOCK_TAGS.filter(t => !selectedTags.includes(t.id)).map(t => (
                            <option key={t.id} value={t.id}>{t.name}</option>
                        ))}
                    </Select>
                </div>
            </div>
            {/* <AttachmentUpload /> // Could add a dedicated attachment upload component here */}
            <div className="flex justify-end gap-2 mt-6">
                <Button variant="ghost" onClick={onClose} type="button">Cancel</Button>
                <Button type="submit" loading={submitting}>Submit Feedback</Button>
            </div>
        </form>
    );
};

export const KanbanBoard: React.FC<{ columnsData: { status: FeedbackStatus; items: FeedbackItem[] }[]; onCardClick: (item: FeedbackItem) => void }> = ({ columnsData, onCardClick }) => {
    // This component would ideally handle drag-and-drop, but for simplicity here we just render columns and cards.
    return (
        <div className="flex gap-6 overflow-x-auto p-2">
            {columnsData.map(column => (
                <div key={column.status} className="w-80 flex-shrink-0 bg-gray-900/50 rounded-lg p-3 shadow-xl">
                    <h3 className="font-semibold text-white mb-4 px-2 text-lg border-b border-gray-700 pb-2">{column.status} ({column.items.length})</h3>
                    <div className="space-y-3 h-[65vh] overflow-y-auto pr-2">
                        {column.items.length > 0 ? (
                            column.items.map(item => (
                                <FeedbackCardComponent key={item.id} item={item} onClick={onCardClick} />
                            ))
                        ) : (
                            <div className="text-center text-gray-500 py-10">No feedback items in this column.</div>
                        )}
                    </div>
                </div>
            ))}
        </div>
    );
};

export const RoadmapView: React.FC<{ roadmapItems: RoadmapItem[]; feedbackItems: FeedbackItem[] }> = ({ roadmapItems, feedbackItems }) => {
    const [selectedRoadmapItem, setSelectedRoadmapItem] = useState<RoadmapItem | null>(null);

    const getFeedbackTitles = (ids: string[]) => {
        return ids.map(id => feedbackItems.find(f => f.id === id)?.title).filter(Boolean).join(', ');
    };

    return (
        <div className="space-y-6">
            <h3 className="text-xl font-bold text-white mb-4">Product Roadmap</h3>
            <div className="bg-gray-900/50 p-6 rounded-lg shadow-xl">
                {roadmapItems.length === 0 ? (
                    <div className="text-center text-gray-500 py-10">No roadmap items defined.</div>
                ) : (
                    <div className="relative border-l-2 border-cyan-700 pl-6 space-y-8">
                        {roadmapItems.sort((a,b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime()).map(item => {
                            const owner = getUserById(item.ownerId);
                            return (
                                <div key={item.id} className="relative group cursor-pointer" onClick={() => setSelectedRoadmapItem(item)}>
                                    <span className="absolute -left-8 top-1 w-4 h-4 bg-cyan-500 rounded-full border-2 border-gray-900 group-hover:scale-125 transition-transform duration-200"></span>
                                    <div className="bg-gray-800 p-4 rounded-lg shadow-md hover:shadow-lg hover:border-cyan-500 border border-gray-700 transition-all duration-200">
                                        <div className="flex justify-between items-start mb-2">
                                            <h4 className="font-semibold text-lg text-white">{item.title}</h4>
                                            <span className={`text-xs px-2 py-0.5 rounded-full ${item.status === 'Completed' ? 'bg-green-500/20 text-green-200' : item.status === 'In Progress' ? 'bg-yellow-500/20 text-yellow-200' : 'bg-blue-500/20 text-blue-200'}`}>
                                                {item.status}
                                            </span>
                                        </div>
                                        <p className="text-sm text-gray-300 mb-2">{item.description}</p>
                                        <div className="flex items-center gap-2 text-xs text-gray-400">
                                            <span>{formatDate(item.startDate).split(',')[0]} - {formatDate(item.endDate).split(',')[0]}</span>
                                            {owner && <div className="flex items-center gap-1"><Avatar user={owner} size="sm" /> {owner.name}</div>}
                                        </div>
                                        {item.feedbackIds.length > 0 && (
                                            <p className="text-xs text-gray-500 mt-2">Related Feedback: {getFeedbackTitles(item.feedbackIds)}</p>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>

            <Modal isOpen={selectedRoadmapItem !== null} onClose={() => setSelectedRoadmapItem(null)} title={selectedRoadmapItem?.title || ''} size="md">
                {selectedRoadmapItem && (
                    <div className="space-y-4 text-sm text-gray-300">
                        <p><strong className="text-gray-400">Description:</strong> {selectedRoadmapItem.description}</p>
                        <p><strong className="text-gray-400">Status:</strong> {selectedRoadmapItem.status}</p>
                        <p><strong className="text-gray-400">Timeline:</strong> {formatDate(selectedRoadmapItem.startDate)} - {formatDate(selectedRoadmapItem.endDate)}</p>
                        <p className="flex items-center gap-2"><strong className="text-gray-400">Owner:</strong>
                            {getUserById(selectedRoadmapItem.ownerId) && <Avatar user={getUserById(selectedRoadmapItem.ownerId)!} size="sm" />}
                            {getUserById(selectedRoadmapItem.ownerId)?.name || 'N/A'}
                        </p>
                        <p><strong className="text-gray-400">Product Area:</strong> {selectedRoadmapItem.productArea}</p>
                        {selectedRoadmapItem.keyMetrics && selectedRoadmapItem.keyMetrics.length > 0 && (
                            <div>
                                <strong className="text-gray-400">Key Metrics:</strong>
                                <ul className="list-disc list-inside ml-2">
                                    {selectedRoadmapItem.keyMetrics.map((metric, i) => <li key={i}>{metric}</li>)}
                                </ul>
                            </div>
                        )}
                        {selectedRoadmapItem.feedbackIds.length > 0 && (
                            <div>
                                <strong className="text-gray-400">Related Feedback Items:</strong>
                                <ul className="list-disc list-inside ml-2">
                                    {selectedRoadmapItem.feedbackIds.map(fbId => {
                                        const fb = feedbackItems.find(f => f.id === fbId);
                                        return fb ? <li key={fb.id} className="text-cyan-400 hover:underline cursor-pointer">{fb.title}</li> : null;
                                    })}
                                </ul>
                            </div>
                        )}
                    </div>
                )}
            </Modal>
        </div>
    );
};

export const AnalyticsDashboard: React.FC<{ feedbackItems: FeedbackItem[]; allUsers: User[]; allTags: Tag[] }> = ({ feedbackItems, allUsers, allTags }) => {
    const [analytics, setAnalytics] = useState<AnalyticsData | null>(null);

    useEffect(() => {
        // Mock data aggregation
        const feedbackByStatus: { [key: string]: number } = {};
        COLUMNS.forEach(status => feedbackByStatus[status] = 0);
        feedbackItems.forEach(item => {
            if (feedbackByStatus[item.status] !== undefined) {
                feedbackByStatus[item.status]++;
            }
        });

        const tagCounts: { [tagId: string]: number } = {};
        feedbackItems.forEach(item => {
            item.tags.forEach(tagId => {
                tagCounts[tagId] = (tagCounts[tagId] || 0) + 1;
            });
        });
        const topTags = Object.entries(tagCounts)
            .sort(([, countA], [, countB]) => countB - countA)
            .map(([tagId, count]) => ({ tagId, count }));

        // Simplified sentiment distribution (will just mock based on general perception)
        let positiveCount = 0;
        let negativeCount = 0;
        let neutralCount = 0;
        feedbackItems.forEach(() => { // random assignment for mock purposes
            const rand = Math.random();
            if (rand < 0.4) positiveCount++;
            else if (rand < 0.7) neutralCount++;
            else negativeCount++;
        });

        setAnalytics({
            feedbackByStatus,
            topTags,
            feedbackVelocity: [ // Mock velocity data for last 3 months
                { date: '2023-08', new: 10, shipped: 5 },
                { date: '2023-09', new: 15, shipped: 8 },
                { date: '2023-10', new: 20, shipped: 10 },
            ],
            sentimentDistribution: { positive: positiveCount, negative: negativeCount, neutral: neutralCount }
        });
    }, [feedbackItems]);

    if (!analytics) return <div className="text-center text-gray-500 py-10">Loading analytics...</div>;

    const totalFeedback = feedbackItems.length;

    return (
        <div className="space-y-6">
            <h3 className="text-xl font-bold text-white mb-4">Feedback Analytics</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <Card title="Feedback by Status">
                    <ul className="space-y-2 text-sm">
                        {Object.entries(analytics.feedbackByStatus).map(([status, count]) => (
                            <li key={status} className="flex justify-between items-center text-gray-300">
                                <span className="font-medium">{status}</span>
                                <span className="bg-gray-700 px-2 py-0.5 rounded-full text-xs">{count}</span>
                            </li>
                        ))}
                    </ul>
                </Card>

                <Card title="Top 5 Tags">
                    <ul className="space-y-2 text-sm">
                        {analytics.topTags.slice(0, 5).map(({ tagId, count }) => {
                            const tag = allTags.find(t => t.id === tagId);
                            return tag ? (
                                <li key={tagId} className="flex justify-between items-center text-gray-300">
                                    <TagPill tagId={tagId} />
                                    <span className="bg-gray-700 px-2 py-0.5 rounded-full text-xs">{count}</span>
                                </li>
                            ) : null;
                        })}
                    </ul>
                </Card>

                <Card title="Sentiment Distribution">
                    <div className="flex items-center justify-around h-24">
                        <div className="text-center">
                            <span className="block text-green-500 text-2xl font-bold">{((analytics.sentimentDistribution.positive / totalFeedback) * 100).toFixed(0)}%</span>
                            <span className="text-sm text-gray-400">Positive</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-gray-400 text-2xl font-bold">{((analytics.sentimentDistribution.neutral / totalFeedback) * 100).toFixed(0)}%</span>
                            <span className="text-sm text-gray-400">Neutral</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-red-500 text-2xl font-bold">{((analytics.sentimentDistribution.negative / totalFeedback) * 100).toFixed(0)}%</span>
                            <span className="text-sm text-gray-400">Negative</span>
                        </div>
                    </div>
                    <p className="text-xs text-gray-500 mt-4 text-center">Based on AI Sentiment Analysis of feedback descriptions.</p>
                </Card>

                <Card title="Feedback Velocity (Last 3 Months)" className="lg:col-span-3">
                    <div className="flex justify-around items-end h-32 px-4">
                        {analytics.feedbackVelocity.map(entry => (
                            <div key={entry.date} className="flex-1 text-center relative">
                                <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-4 bg-cyan-600 rounded-t-md" style={{ height: `${entry.new * 3}px`, maxHeight: '100%' }}></div>
                                <div className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-x-4 w-4 bg-green-600 rounded-t-md" style={{ height: `${entry.shipped * 3}px`, maxHeight: '100%' }}></div>
                                <span className="absolute -bottom-6 text-xs text-gray-400 w-full left-0">{entry.date}</span>
                            </div>
                        ))}
                    </div>
                    <div className="flex justify-center gap-4 mt-8 text-sm text-gray-400">
                        <span className="flex items-center gap-1"><span className="w-3 h-3 bg-cyan-600 rounded-full"></span> New</span>
                        <span className="flex items-center gap-1"><span className="w-3 h-3 bg-green-600 rounded-full"></span> Shipped</span>
                    </div>
                </Card>
            </div>
        </div>
    );
};

export const GlobalSearch: React.FC<{ onSearch: (query: string) => void }> = ({ onSearch }) => {
    const [searchQuery, setSearchQuery] = useState('');
    const handleSearch = useCallback(() => {
        onSearch(searchQuery);
    }, [onSearch, searchQuery]);

    const handleKeyPress = useCallback((e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Enter') {
            handleSearch();
        }
    }, [handleSearch]);

    return (
        <div className="flex items-center gap-2 max-w-lg w-full">
            <Input
                type="text"
                placeholder="Search feedback items, users, or tags..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyPress={handleKeyPress}
                className="flex-1"
            />
            <Button onClick={handleSearch} disabled={!searchQuery.trim()}>Search</Button>
        </div>
    );
};

export const FilterPanel: React.FC<{
    currentFilters: { status?: FeedbackStatus; assigneeId?: string; tagIds?: string[]; priority?: FeedbackPriority; submitterId?: string };
    onFilterChange: (filters: { status?: FeedbackStatus; assigneeId?: string; tagIds?: string[]; priority?: FeedbackPriority; submitterId?: string }) => void;
    onResetFilters: () => void;
}> = ({ currentFilters, onFilterChange, onResetFilters }) => {
    const [showFilters, setShowFilters] = useState(false);

    const handleSelectChange = (key: keyof typeof currentFilters, value: string | string[] | undefined) => {
        onFilterChange({ ...currentFilters, [key]: value === '' ? undefined : value });
    };

    return (
        <div className="relative">
            <Button variant="secondary" onClick={() => setShowFilters(!showFilters)} className="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                Filters {Object.keys(currentFilters).filter(k => (currentFilters as any)[k]).length > 0 && `(${Object.keys(currentFilters).filter(k => (currentFilters as any)[k]).length})`}
            </Button>

            {showFilters && (
                <Card className="absolute top-full left-0 mt-2 z-10 w-80 shadow-lg p-4 space-y-3">
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <Select value={currentFilters.status || ''} onChange={(e) => handleSelectChange('status', e.target.value as FeedbackStatus)}>
                            <option value="">All Statuses</option>
                            {COLUMNS.map(s => <option key={s} value={s}>{s}</option>)}
                        </Select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">Assignee</label>
                        <Select value={currentFilters.assigneeId || ''} onChange={(e) => handleSelectChange('assigneeId', e.target.value)}>
                            <option value="">Any Assignee</option>
                            {MOCK_USERS.filter(u => ['Admin', 'Moderator'].includes(u.role)).map(u => (
                                <option key={u.id} value={u.id}>{u.name}</option>
                            ))}
                        </Select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">Priority</label>
                        <Select value={currentFilters.priority || ''} onChange={(e) => handleSelectChange('priority', e.target.value as FeedbackPriority)}>
                            <option value="">Any Priority</option>
                            {PRIORITIES.map(p => <option key={p} value={p}>{p}</option>)}
                        </Select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-1">Tags</label>
                        <Select
                            multiple
                            value={currentFilters.tagIds || []}
                            onChange={(e) => {
                                const options = Array.from(e.target.selectedOptions, (option) => option.value);
                                handleSelectChange('tagIds', options);
                            }}
                            className="h-24"
                        >
                            {MOCK_TAGS.map(t => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                            ))}
                        </Select>
                    </div>
                    <div className="flex justify-end gap-2 border-t border-gray-700 pt-3">
                        <Button variant="ghost" size="sm" onClick={onResetFilters}>Reset</Button>
                        <Button size="sm" onClick={() => setShowFilters(false)}>Apply</Button>
                    </div>
                </Card>
            )}
        </div>
    );
};

export const AdminPanel: React.FC<{ allUsers: User[]; allTags: Tag[]; onAddTag: (name: string, color: string) => void; onRemoveTag: (tagId: string) => void }> = ({ allUsers, allTags, onAddTag, onRemoveTag }) => {
    const [newTagName, setNewTagName] = useState('');
    const [newTagColor, setNewTagColor] = useState('bg-gray-500/20 text-gray-200');

    const handleAddTag = () => {
        if (newTagName.trim()) {
            onAddTag(newTagName.trim(), newTagColor);
            setNewTagName('');
        }
    };

    return (
        <div className="space-y-8">
            <h3 className="text-xl font-bold text-white">Admin Panel</h3>

            <Card title="User Management">
                <p className="text-sm text-gray-400 mb-4">Manage user roles and permissions. (Mocked: changes are not persistent)</p>
                <div className="max-h-60 overflow-y-auto pr-2">
                    <ul className="space-y-3">
                        {allUsers.map(user => (
                            <li key={user.id} className="flex items-center justify-between bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                                <div className="flex items-center gap-3">
                                    <Avatar user={user} size="sm" />
                                    <span className="text-gray-200 font-medium">{user.name}</span>
                                    <span className="text-xs text-gray-500">{user.email}</span>
                                </div>
                                <Select value={user.role} onChange={(e) => console.log(`Changed ${user.name}'s role to ${e.target.value}`)} className="w-32 text-xs p-1">
                                    {['Admin', 'Moderator', 'Member', 'Guest'].map(role => (
                                        <option key={role} value={role}>{role}</option>
                                    ))}
                                </Select>
                            </li>
                        ))}
                    </ul>
                </div>
            </Card>

            <Card title="Tag Management">
                <div className="mb-4">
                    <h4 className="font-semibold text-gray-200 mb-2">Create New Tag</h4>
                    <div className="flex gap-2">
                        <Input placeholder="New tag name" value={newTagName} onChange={(e) => setNewTagName(e.target.value)} className="flex-1" />
                        <Select value={newTagColor} onChange={(e) => setNewTagColor(e.target.value)} className="w-40">
                            <option value="bg-gray-500/20 text-gray-200">Gray</option>
                            <option value="bg-cyan-500/20 text-cyan-200">Cyan</option>
                            <option value="bg-indigo-500/20 text-indigo-200">Indigo</option>
                            <option value="bg-green-500/20 text-green-200">Green</option>
                            <option value="bg-yellow-500/20 text-yellow-200">Yellow</option>
                            <option value="bg-red-500/20 text-red-200">Red</option>
                            <option value="bg-purple-500/20 text-purple-200">Purple</option>
                        </Select>
                        <Button onClick={handleAddTag} disabled={!newTagName.trim()}>Add Tag</Button>
                    </div>
                </div>

                <h4 className="font-semibold text-gray-200 mb-2 border-t border-gray-700 pt-4">Existing Tags</h4>
                <div className="flex flex-wrap gap-2">
                    {allTags.map(tag => (
                        <TagPill key={tag.id} tagId={tag.id} interactive onRemove={onRemoveTag} />
                    ))}
                </div>
            </Card>
        </div>
    );
};


// ================================================================================================
// MAIN VIEW COMPONENT
// ================================================================================================

export type FeedbackViewMode = 'kanban' | 'roadmap' | 'analytics' | 'admin';

const FeedbackHubView: React.FC = () => {
    const [feedbackItems, setFeedbackItems] = useState<FeedbackItem[]>(MOCK_FEEDBACK_ITEMS);
    const [allActivityLogs, setAllActivityLogs] = useState<ActivityLogEntry[]>(MOCK_ACTIVITY_LOGS);
    const [allRoadmapItems, setAllRoadmapItems] = useState<RoadmapItem[]>(MOCK_ROADMAP_ITEMS);
    const [allUsers, setAllUsers] = useState<User[]>(MOCK_USERS);
    const [allTags, setAllTags] = useState<Tag[]>(MOCK_TAGS);

    const [selectedItem, setSelectedItem] = useState<FeedbackItem | null>(null);
    const [showSubmitForm, setShowSubmitForm] = useState(false);
    const [currentView, setCurrentView] = useState<FeedbackViewMode>('kanban');

    const [filters, setFilters] = useState<{
        status?: FeedbackStatus;
        assigneeId?: string;
        tagIds?: string[];
        priority?: FeedbackPriority;
        submitterId?: string;
        searchQuery?: string;
    }>({});
    const [sortBy, setSortBy] = useState<'votes' | 'recency' | 'priority'>('recency');
    const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');

    const filteredAndSortedFeedback = useMemo(() => {
        let items = [...feedbackItems];

        // Apply search
        if (filters.searchQuery) {
            const query = filters.searchQuery.toLowerCase();
            items = items.filter(item =>
                item.title.toLowerCase().includes(query) ||
                item.description.toLowerCase().includes(query) ||
                MOCK_USERS.find(u => u.id === item.submitterId)?.name.toLowerCase().includes(query) ||
                item.tags.some(tagId => getTagById(tagId)?.name.toLowerCase().includes(query))
            );
        }

        // Apply filters
        if (filters.status) {
            items = items.filter(item => item.status === filters.status);
        }
        if (filters.assigneeId) {
            items = items.filter(item => item.assignedToId === filters.assigneeId);
        }
        if (filters.tagIds && filters.tagIds.length > 0) {
            items = items.filter(item => item.tags.some(tagId => filters.tagIds?.includes(tagId)));
        }
        if (filters.priority) {
            items = items.filter(item => item.priority === filters.priority);
        }
        if (filters.submitterId) {
            items = items.filter(item => item.submitterId === filters.submitterId);
        }

        // Apply sorting
        items.sort((a, b) => {
            let valA: any;
            let valB: any;

            switch (sortBy) {
                case 'votes':
                    valA = a.votes;
                    valB = b.votes;
                    break;
                case 'recency':
                    valA = new Date(a.lastActivityAt || a.createdAt).getTime();
                    valB = new Date(b.lastActivityAt || b.createdAt).getTime();
                    break;
                case 'priority':
                    const priorityOrder = PRIORITIES.reduce((acc, p, i) => ({ ...acc, [p]: i }), {} as { [key in FeedbackPriority]: number });
                    valA = priorityOrder[a.priority];
                    valB = priorityOrder[b.priority];
                    break;
                default:
                    valA = 0;
                    valB = 0;
            }

            if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
            if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });

        return items;
    }, [feedbackItems, filters, sortBy, sortOrder]);

    const columns = useMemo(() => {
        return COLUMNS.map(status => ({
            status,
            items: filteredAndSortedFeedback.filter(item => item.status === status)
        }));
    }, [filteredAndSortedFeedback]);

    const handleUpdateFeedbackItem = useCallback((updatedItem: FeedbackItem, activityLog: ActivityLogEntry) => {
        setFeedbackItems(prevItems => prevItems.map(item => item.id === updatedItem.id ? updatedItem : item));
        setAllActivityLogs(prevLogs => [...prevLogs, activityLog]);
    }, []);

    const handleAddComment = useCallback((feedbackId: string, userId: string, text: string, parentId?: string) => {
        const newComment: Comment = {
            id: useUniqueId('c-'), userId, text, timestamp: new Date().toISOString(), parentId
        };
        setFeedbackItems(prevItems =>
            prevItems.map(item =>
                item.id === feedbackId
                    ? { ...item, comments: [...item.comments, newComment], lastActivityAt: new Date().toISOString() }
                    : item
            )
        );
        const newLog: ActivityLogEntry = {
            id: useUniqueId('al-'), feedbackId, userId, timestamp: new Date().toISOString(), type: 'commented', details: `Added comment: "${text.substring(0, 50)}..."`
        };
        setAllActivityLogs(prevLogs => [...prevLogs, newLog]);
    }, []);

    const handleSubmitNewFeedback = useCallback((newFeedback: Omit<FeedbackItem, 'id' | 'votes' | 'comments' | 'attachments' | 'createdAt' | 'updatedAt' | 'lastActivityAt'>) => {
        const id = useUniqueId('FB-');
        const now = new Date().toISOString();
        const fullNewItem: FeedbackItem = {
            ...newFeedback,
            id,
            votes: 1, // Auto-vote by submitter
            comments: [],
            attachments: [],
            createdAt: now,
            updatedAt: now,
            lastActivityAt: now,
        };
        setFeedbackItems(prevItems => [...prevItems, fullNewItem]);
        const newLog: ActivityLogEntry = {
            id: useUniqueId('al-'), feedbackId: id, userId: fullNewItem.submitterId, timestamp: now, type: 'created', details: 'Feedback item created'
        };
        setAllActivityLogs(prevLogs => [...prevLogs, newLog]);
    }, []);

    const handleSearch = useCallback((query: string) => {
        setFilters(prev => ({ ...prev, searchQuery: query }));
    }, []);

    const handleFilterChange = useCallback((newFilters: typeof filters) => {
        setFilters(prev => ({ ...prev, ...newFilters }));
    }, []);

    const handleResetFilters = useCallback(() => {
        setFilters({});
    }, []);

    const handleAddTag = useCallback((name: string, color: string) => {
        const newTag: Tag = { id: useUniqueId('tag-'), name, color };
        setAllTags(prev => [...prev, newTag]);
    }, []);

    const handleRemoveTag = useCallback((tagId: string) => {
        setAllTags(prev => prev.filter(t => t.id !== tagId));
        // Also remove tag from any feedback items that use it
        setFeedbackItems(prevItems => prevItems.map(item => ({
            ...item,
            tags: item.tags.filter(t => t !== tagId)
        })));
    }, []);

    return (
        <>
            <div className="space-y-6">
                <div className="flex justify-between items-center flex-wrap gap-4">
                    <h2 className="text-3xl font-bold text-white tracking-wider">Feedback Hub</h2>
                    <div className="flex items-center gap-4">
                        <GlobalSearch onSearch={handleSearch} />
                        <FilterPanel currentFilters={filters} onFilterChange={handleFilterChange} onResetFilters={handleResetFilters} />
                        <Select value={sortBy} onChange={(e) => setSortBy(e.target.value as any)} className="w-32 text-sm p-2">
                            <option value="recency">Sort by Recency</option>
                            <option value="votes">Sort by Votes</option>
                            <option value="priority">Sort by Priority</option>
                        </Select>
                        <Button variant="secondary" onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')} size="sm">
                            {sortOrder === 'asc' ? (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>
                            ) : (
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4 4m0-4l-4-4m4 4v12" /></svg>
                            )}
                        </Button>
                        <Button onClick={() => setShowSubmitForm(true)}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                            Submit Feedback
                        </Button>
                    </div>
                </div>

                <div className="border-b border-gray-700 mb-6">
                    <nav className="flex space-x-6">
                        {['kanban', 'roadmap', 'analytics', 'admin'].map(view => (
                            <button
                                key={view}
                                onClick={() => setCurrentView(view as FeedbackViewMode)}
                                className={`py-2 px-1 text-base font-medium border-b-2 ${currentView === view ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-white hover:border-gray-500'}`}
                            >
                                {view.charAt(0).toUpperCase() + view.slice(1)}
                            </button>
                        ))}
                    </nav>
                </div>

                {currentView === 'kanban' && (
                    <KanbanBoard columnsData={columns} onCardClick={setSelectedItem} />
                )}

                {currentView === 'roadmap' && (
                    <RoadmapView roadmapItems={allRoadmapItems} feedbackItems={feedbackItems} />
                )}

                {currentView === 'analytics' && (
                    <AnalyticsDashboard feedbackItems={feedbackItems} allUsers={allUsers} allTags={allTags} />
                )}

                {currentView === 'admin' && (
                    <AdminPanel allUsers={allUsers} allTags={allTags} onAddTag={handleAddTag} onRemoveTag={handleRemoveTag} />
                )}
            </div>

            <FeedbackDetailModal
                item={selectedItem}
                onClose={() => setSelectedItem(null)}
                onUpdateItem={handleUpdateFeedbackItem}
                onAddComment={handleAddComment}
            />
            <Modal isOpen={showSubmitForm} onClose={() => setShowSubmitForm(false)} title="Submit New Feedback" size="sm">
                <FeedbackSubmissionForm onSubmit={handleSubmitNewFeedback} onClose={() => setShowSubmitForm(false)} />
            </Modal>
        </>
    );
};

export default FeedbackHubView;

--- FILE: KycAmlView.tsx ---

// components/views/megadashboard/userclient/KycAmlView.tsx
// This component has been architected as a complete Know Your Customer (KYC) and
// Anti-Money Laundering (AML) dashboard. It includes KPIs, a filterable case review
// table, and a detailed modal with an integrated AI summary feature.
// The complexity and line count reflect a production-grade enterprise tool.

import React, { useState, useMemo, useEffect, useCallback, useRef } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// ================================================================================================
// TYPE DEFINITIONS & MOCK DATA
// ================================================================================================

export type CaseStatus = 'New' | 'Under Review' | 'Cleared' | 'Escalated' | 'Pending Docs' | 'Awaiting Approval' | 'Closed';
export type CaseRisk = 'Low' | 'Medium' | 'High' | 'Critical';
export type EntityType = 'Individual' | 'Business' | 'Trust' | 'Government';
export type CaseType = 'KYC Verification' | 'AML Transaction Monitoring' | 'Adverse Media' | 'Sanctions Screening';
export type DocumentStatus = 'Uploaded' | 'Processing' | 'Under Review' | 'Verified' | 'Rejected' | 'Expired';
export type TransactionStatus = 'Pending' | 'Processed' | 'Failed' | 'Flagged';
export type TransactionType = 'Wire Transfer' | 'ACH' | 'Credit Card' | 'Crypto' | 'Cash Deposit' | 'Cash Withdrawal';
export type SanctionList = 'OFAC' | 'EU' | 'UN' | 'HMT' | 'FATF';
export type AdverseMediaCategory = 'Fraud' | 'Bribery' | 'Money Laundering' | 'Terrorism Financing' | 'Sanctions Violation' | 'Political Exposure' | 'Other';
export type RiskFactorCategory = 'Jurisdiction' | 'Transaction Volume' | 'Entity Type' | 'Business Activity' | 'PEP Status' | 'Adverse Media' | 'Sanctions';
export type UserRole = 'Analyst' | 'Senior Analyst' | 'Compliance Officer' | 'Admin';

export interface User {
    id: string;
    name: string;
    email: string;
    role: UserRole;
    lastActive: string;
}

export interface Document {
    id: string;
    caseId: string;
    documentType: string; // e.g., 'Passport', 'Utility Bill', 'Company Registration'
    fileName: string;
    uploadDate: string;
    status: DocumentStatus;
    reviewerId?: string;
    reviewDate?: string;
    rejectionReason?: string;
    fileUrl?: string; // In a real app, this would be a secure URL
    metadata?: Record<string, any>; // OCR data, extracted fields
    version: number;
    history: { date: string; action: string; userId: string; }[];
}

export interface Transaction {
    id: string;
    caseId: string;
    transactionDate: string;
    amount: number;
    currency: string;
    type: TransactionType;
    senderId: string;
    receiverId: string;
    senderName: string;
    receiverName: string;
    status: TransactionStatus;
    description: string;
    riskScore: number;
    flags: string[]; // e.g., 'High Value', 'High Risk Jurisdiction', 'Unusual Pattern'
    relatedCaseId?: string; // If this transaction triggered a new case
}

export interface AuditLogEntry {
    id: string;
    caseId: string;
    timestamp: string;
    userId: string;
    userName: string;
    action: string; // e.g., 'Case Opened', 'Status Changed', 'Document Verified', 'Note Added'
    details: string;
    oldValue?: string;
    newValue?: string;
}

export interface SanctionScreeningResult {
    id: string;
    entityId: string;
    list: SanctionList;
    matchType: 'Exact' | 'Partial' | 'Alias' | 'None';
    matchScore?: number;
    matchedName?: string;
    matchedDOB?: string;
    matchedAddress?: string;
    status: 'Cleared' | 'Match' | 'False Positive' | 'Under Review';
    screenDate: string;
    reviewerId?: string;
    notes?: string;
    linkedCaseId?: string;
}

export interface AdverseMediaResult {
    id: string;
    entityId: string;
    source: string; // e.g., 'Google News', 'Dow Jones Risk & Compliance'
    headline: string;
    summary: string;
    url: string;
    category: AdverseMediaCategory[];
    sentiment: 'Positive' | 'Negative' | 'Neutral';
    publishDate: string;
    status: 'Cleared' | 'Relevant' | 'False Positive' | 'Under Review';
    screenDate: string;
    reviewerId?: string;
    notes?: string;
    linkedCaseId?: string;
}

export interface RiskFactor {
    id: string;
    category: RiskFactorCategory;
    description: string;
    scoreImpact: number; // e.g., +10 for high risk factor
    isMitigated: boolean;
    mitigationDetails?: string;
}

export interface KycAmlCase {
    id: string;
    entityId: string; // New: Link to a separate Entity record
    entityName: string;
    entityType: EntityType;
    caseType: CaseType;
    riskLevel: CaseRisk;
    status: CaseStatus;
    dateOpened: string;
    dateUpdated: string;
    assigneeId: string; // Use assigneeId to link to User
    assigneeName: string; // Denormalized for display
    summary: string;
    description: string;
    documents: Document[];
    transactions: Transaction[];
    auditLog: AuditLogEntry[];
    sanctionScreeningResults: SanctionScreeningResult[];
    adverseMediaResults: AdverseMediaResult[];
    riskFactors: RiskFactor[];
    comments: { id: string; userId: string; userName: string; timestamp: string; text: string; }[];
    relatedCases: string[]; // IDs of related cases
    priority: 'Low' | 'Medium' | 'High' | 'Urgent';
    dueDate?: string;
    decision?: 'Approved' | 'Rejected' | 'Further Review';
    decisionReason?: string;
    decisionByUserId?: string;
    decisionDate?: string;
    sourceSystem: string; // e.g., 'Onboarding Portal', 'Transaction Monitoring System'
}

export interface KpiSnapshot {
    date: string;
    newCases: number;
    underReview: number;
    escalated: number;
    cleared: number;
    avgResolutionTime: number; // in hours
    highRiskCases: number;
    criticalRiskCases: number;
}

export interface DashboardSettings {
    theme: 'dark' | 'light';
    notificationsEnabled: boolean;
    autoRefreshInterval: number; // in seconds
    defaultCaseFilter: CaseStatus | 'all';
    alertThresholds: {
        newHighRiskCases: number;
        escalatedCases: number;
    };
}

// ================================================================================================
// MOCK DATA GENERATION UTILITIES (EXPANDED)
// ================================================================================================

const generateId = (prefix: string = '') => prefix + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
const getRandomItem = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)];
const getRandomDate = (start: Date, end: Date) => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
const formatIsoDate = (date: Date) => date.toISOString().split('T')[0];

export const MOCK_USERS: User[] = [
    { id: 'usr-001', name: 'Analyst Jane', email: 'jane@example.com', role: 'Analyst', lastActive: '2024-07-25T10:00:00Z' },
    { id: 'usr-002', name: 'Analyst John', email: 'john@example.com', role: 'Analyst', lastActive: '2024-07-25T09:30:00Z' },
    { id: 'usr-003', name: 'Senior Alice', email: 'alice@example.com', role: 'Senior Analyst', lastActive: '2024-07-25T11:15:00Z' },
    { id: 'usr-004', name: 'Compliance Officer Bob', email: 'bob@example.com', role: 'Compliance Officer', lastActive: '2024-07-25T10:45:00Z' },
    { id: 'usr-005', name: 'Admin Charlie', email: 'charlie@example.com', role: 'Admin', lastActive: '2024-07-25T09:00:00Z' },
    { id: 'usr-unassigned', name: 'Unassigned', email: 'unassigned@example.com', role: 'Analyst', lastActive: '' },
];

const mockEntityNames = {
    'Individual': ['John Doe', 'Jane Smith', 'Peter Jones', 'Anna Lee', 'Michael Brown', 'Sarah Johnson', 'David Miller', 'Jessica Garcia'],
    'Business': ['QuantumLeap Marketing', 'Global Innovations Inc.', 'FutureTech Solutions', 'Synergy Enterprises', 'Apex Dynamics', 'Visionary Solutions', 'NeoCorp', 'DataStream Labs'],
    'Trust': ['The Evergreen Trust', 'Guardian Family Trust', 'Prosperity Charitable Trust'],
    'Government': ['City of Metropolis', 'State Treasury Department'],
};

const mockDocumentTypes = ['Passport', 'National ID', 'Driver License', 'Utility Bill', 'Bank Statement', 'Company Registration', 'Articles of Incorporation', 'Proof of Address'];
const mockTransactionDescriptions = [
    'International funds transfer', 'Purchase of goods', 'Payroll deposit', 'Investment contribution', 'Loan repayment', 'Consulting fees', 'Subscription payment', 'Property rental', 'E-commerce transaction'
];
const mockAmlFlags = ['High Value', 'High Risk Jurisdiction', 'Unusual Pattern', 'Layering', 'Structuring', 'Sanctioned Entity Link'];
const mockRiskFactors = [
    { category: 'Jurisdiction', description: 'Country X is high-risk.', scoreImpact: 15 },
    { category: 'Transaction Volume', description: 'Unusually high transaction volume for entity.', scoreImpact: 20 },
    { category: 'Entity Type', description: 'Complex corporate structure.', scoreImpact: 10 },
    { category: 'PEP Status', description: 'Entity is a Politically Exposed Person.', scoreImpact: 25 },
    { category: 'Adverse Media', description: 'Negative news article detected.', scoreImpact: 30 },
    { category: 'Sanctions', description: 'Potential sanctions match.', scoreImpact: 50 },
];
const mockSummarySnippets = [
    'ID document appears slightly blurry, requiring re-submission.',
    'Large wire transfer to a high-risk jurisdiction, further review needed.',
    'Pending proof of address verification from client.',
    'Unusual pattern of multiple small, outgoing international payments.',
    'All documents verified successfully, case ready for closure.',
    'Transaction matches a known money laundering typology, immediate escalation.',
    'Company registration documents are inconsistent with public records.',
    'Source of wealth documentation is insufficient.',
    'Sanctions screening resulted in a potential partial match.',
    'Adverse media found regarding a previous fraud investigation.',
    'Client has requested an expedited review due to business urgency.',
    'Initial review indicates low risk, proceeding with standard verification.',
    'Multiple related parties flagged in different cases, potential network detected.',
];

export const generateMockDocument = (caseId: string): Document => {
    const uploadDate = getRandomDate(new Date('2024-01-01'), new Date());
    return {
        id: generateId('DOC'),
        caseId,
        documentType: getRandomItem(mockDocumentTypes),
        fileName: `${generateId('file')}.pdf`,
        uploadDate: formatIsoDate(uploadDate),
        status: getRandomItem(['Uploaded', 'Processing', 'Under Review', 'Verified', 'Rejected']),
        reviewerId: Math.random() > 0.3 ? getRandomItem(MOCK_USERS.filter(u => u.role === 'Analyst')).id : undefined,
        reviewDate: Math.random() > 0.3 ? formatIsoDate(getRandomDate(uploadDate, new Date())) : undefined,
        rejectionReason: Math.random() > 0.8 ? 'Document expired' : undefined,
        fileUrl: `/api/documents/${generateId('doc_url')}`,
        metadata: { pages: Math.floor(Math.random() * 5) + 1, sizeKB: Math.floor(Math.random() * 500) + 50 },
        version: 1,
        history: [{ date: formatIsoDate(uploadDate), action: 'Uploaded', userId: getRandomItem(MOCK_USERS).id }],
    };
};

export const generateMockTransaction = (caseId: string, entityId: string): Transaction => {
    const transactionDate = getRandomDate(new Date('2024-01-01'), new Date());
    const sender = getRandomItem(MOCK_USERS);
    const receiver = getRandomItem(MOCK_USERS);
    return {
        id: generateId('TRN'),
        caseId,
        transactionDate: formatIsoDate(transactionDate),
        amount: parseFloat((Math.random() * 100000 + 500).toFixed(2)),
        currency: getRandomItem(['USD', 'EUR', 'GBP']),
        type: getRandomItem(['Wire Transfer', 'ACH', 'Credit Card', 'Crypto']),
        senderId: sender.id,
        receiverId: receiver.id,
        senderName: sender.name,
        receiverName: receiver.name,
        status: getRandomItem(['Pending', 'Processed', 'Flagged']),
        description: getRandomItem(mockTransactionDescriptions),
        riskScore: Math.floor(Math.random() * 100),
        flags: Math.random() > 0.6 ? [getRandomItem(mockAmlFlags)] : [],
        relatedCaseId: Math.random() > 0.9 ? generateId('AML') : undefined,
    };
};

export const generateMockAuditLogEntry = (caseId: string, userId: string, userName: string, action: string, details: string): AuditLogEntry => ({
    id: generateId('AUDIT'),
    caseId,
    timestamp: new Date().toISOString(),
    userId,
    userName,
    action,
    details,
});

export const generateMockSanctionScreeningResult = (entityId: string): SanctionScreeningResult => {
    const isMatch = Math.random() > 0.7;
    const screenDate = getRandomDate(new Date('2024-01-01'), new Date());
    const matchedName = isMatch ? getRandomItem(mockEntityNames.Individual) : undefined;
    return {
        id: generateId('SNC'),
        entityId,
        list: getRandomItem(Object.values(SanctionList)),
        matchType: isMatch ? getRandomItem(['Exact', 'Partial', 'Alias']) : 'None',
        matchScore: isMatch ? Math.floor(Math.random() * 50) + 50 : undefined,
        matchedName: matchedName,
        matchedDOB: isMatch && Math.random() > 0.5 ? formatIsoDate(getRandomDate(new Date('1950-01-01'), new Date('2000-01-01'))) : undefined,
        matchedAddress: isMatch && Math.random() > 0.5 ? '123 Fake St, Anytown' : undefined,
        status: isMatch ? getRandomItem(['Match', 'False Positive', 'Under Review']) : 'Cleared',
        screenDate: formatIsoDate(screenDate),
        reviewerId: isMatch ? getRandomItem(MOCK_USERS).id : undefined,
        notes: isMatch ? 'Manual review required for potential match.' : undefined,
    };
};

export const generateMockAdverseMediaResult = (entityId: string): AdverseMediaResult => {
    const isRelevant = Math.random() > 0.7;
    const publishDate = getRandomDate(new Date('2023-01-01'), new Date());
    const screenDate = getRandomDate(publishDate, new Date());
    return {
        id: generateId('ADM'),
        entityId,
        source: getRandomItem(['Google News', 'Bing News', 'Dow Jones Risk & Compliance', 'LexisNexis']),
        headline: isRelevant ? `Headline about ${getRandomItem(mockEntityNames.Individual)} and a recent scandal.` : `Positive news about ${getRandomItem(mockEntityNames.Business)}`,
        summary: isRelevant ? `Detailed summary of the adverse event regarding ${getRandomItem(mockEntityNames.Individual)}.` : `Summary of a routine business announcement.`,
        url: `https://example.com/news/${generateId('article')}`,
        category: isRelevant ? [getRandomItem(Object.values(AdverseMediaCategory))] : [],
        sentiment: isRelevant ? 'Negative' : 'Positive',
        publishDate: formatIsoDate(publishDate),
        status: isRelevant ? getRandomItem(['Relevant', 'False Positive', 'Under Review']) : 'Cleared',
        screenDate: formatIsoDate(screenDate),
        reviewerId: isRelevant ? getRandomItem(MOCK_USERS).id : undefined,
        notes: isRelevant ? 'Further investigation needed on this article.' : undefined,
    };
};

export const generateMockRiskFactor = (caseId: string): RiskFactor => {
    const factor = getRandomItem(mockRiskFactors);
    const isMitigated = Math.random() > 0.6;
    return {
        id: generateId('RF'),
        category: factor.category,
        description: factor.description,
        scoreImpact: factor.scoreImpact,
        isMitigated: isMitigated,
        mitigationDetails: isMitigated ? 'Client provided additional documentation.' : undefined,
    };
};

export const generateMockKycAmlCase = (index: number): KycAmlCase => {
    const entityType = getRandomItem(Object.values(EntityType));
    const entityName = getRandomItem(mockEntityNames[entityType]);
    const caseType = getRandomItem(Object.values(CaseType));
    const riskLevel = getRandomItem(Object.values(CaseRisk));
    const status = getRandomItem(Object.values(CaseStatus));
    const openedDate = getRandomDate(new Date('2024-01-01'), new Date());
    const updatedDate = getRandomDate(openedDate, new Date());
    const assignee = status === 'New' ? MOCK_USERS.find(u => u.id === 'usr-unassigned')! : getRandomItem(MOCK_USERS.filter(u => u.role === 'Analyst'));

    const caseId = (caseType === 'KYC Verification' ? 'KYC' : caseType === 'AML Transaction Monitoring' ? 'AML' : 'CMP') + '-' + String(index + 1).padStart(4, '0');
    const entityId = generateId('ENT');

    const numDocs = Math.floor(Math.random() * 5) + 1;
    const documents = Array.from({ length: numDocs }, () => generateMockDocument(caseId));

    const numTransactions = Math.floor(Math.random() * 10) + 2;
    const transactions = Array.from({ length: numTransactions }, () => generateMockTransaction(caseId, entityId));

    const numAuditLogs = Math.floor(Math.random() * 8) + 3;
    const auditLog: AuditLogEntry[] = [
        generateMockAuditLogEntry(caseId, getRandomItem(MOCK_USERS).id, getRandomItem(MOCK_USERS).name, 'Case Opened', `Case ${caseId} opened for ${entityName}.`),
    ];
    for (let i = 1; i < numAuditLogs; i++) {
        auditLog.push(generateMockAuditLogEntry(caseId, getRandomItem(MOCK_USERS).id, getRandomItem(MOCK_USERS).name, getRandomItem(['Status Changed', 'Document Verified', 'Note Added']), `Action detail for ${caseId}.`));
    }

    const numSanctions = Math.random() > 0.5 ? Math.floor(Math.random() * 3) : 0;
    const sanctionScreeningResults = Array.from({ length: numSanctions }, () => generateMockSanctionScreeningResult(entityId));

    const numAdverseMedia = Math.random() > 0.5 ? Math.floor(Math.random() * 3) : 0;
    const adverseMediaResults = Array.from({ length: numAdverseMedia }, () => generateMockAdverseMediaResult(entityId));

    const numRiskFactors = Math.random() > 0.4 ? Math.floor(Math.random() * 4) : 0;
    const riskFactors = Array.from({ length: numRiskFactors }, () => generateMockRiskFactor(caseId));

    const numComments = Math.floor(Math.random() * 3);
    const comments = Array.from({ length: numComments }, () => {
        const commenter = getRandomItem(MOCK_USERS);
        return {
            id: generateId('CMT'),
            userId: commenter.id,
            userName: commenter.name,
            timestamp: new Date().toISOString(),
            text: `This is a comment on case ${caseId} about ${entityName}.`,
        };
    });

    return {
        id: caseId,
        entityId: entityId,
        entityName,
        entityType,
        caseType,
        riskLevel,
        status,
        dateOpened: formatIsoDate(openedDate),
        dateUpdated: formatIsoDate(updatedDate),
        assigneeId: assignee.id,
        assigneeName: assignee.name,
        summary: getRandomItem(mockSummarySnippets),
        description: `Detailed description for case ${caseId} involving ${entityName}, which is a ${entityType}. This case was automatically triggered by the ${getRandomItem(['onboarding system', 'transaction monitoring engine', 'sanctions screening system'])} due to potential discrepancies.`,
        documents,
        transactions,
        auditLog,
        sanctionScreeningResults,
        adverseMediaResults,
        riskFactors,
        comments,
        relatedCases: Math.random() > 0.9 ? [generateId('KYC'), generateId('AML')] : [],
        priority: getRandomItem(['Low', 'Medium', 'High', 'Urgent']),
        dueDate: Math.random() > 0.3 ? formatIsoDate(new Date(openedDate.getTime() + 7 * 24 * 60 * 60 * 1000 * (Math.random() * 3 + 1))) : undefined, // 1-4 weeks
        sourceSystem: getRandomItem(['Onboarding Portal', 'Transaction Monitoring System', 'Manual Entry']),
    };
};

export const MOCK_CASES: KycAmlCase[] = Array.from({ length: 5000 }, (_, i) => generateMockKycAmlCase(i));

export const MOCK_KPI_HISTORY: KpiSnapshot[] = Array.from({ length: 30 }, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() - (29 - i)); // Dates for the last 30 days
    return {
        date: formatIsoDate(date),
        newCases: Math.floor(Math.random() * 20) + 5,
        underReview: Math.floor(Math.random() * 50) + 10,
        escalated: Math.floor(Math.random() * 10) + 1,
        cleared: Math.floor(Math.random() * 15) + 3,
        avgResolutionTime: parseFloat((Math.random() * 72 + 24).toFixed(1)),
        highRiskCases: Math.floor(Math.random() * 10) + 1,
        criticalRiskCases: Math.floor(Math.random() * 3),
    };
});

export const MOCK_DASHBOARD_SETTINGS: DashboardSettings = {
    theme: 'dark',
    notificationsEnabled: true,
    autoRefreshInterval: 60,
    defaultCaseFilter: 'all',
    alertThresholds: {
        newHighRiskCases: 5,
        escalatedCases: 2,
    },
};

// ================================================================================================
// API SERVICE (MOCKED)
// ================================================================================================

export const kycAmlService = {
    fetchCases: async (filters: any = {}, pagination: { page: number; limit: number; } = { page: 1, limit: 10 }, sort: { field: string; direction: 'asc' | 'desc'; } = { field: 'dateOpened', direction: 'desc' }): Promise<{ cases: KycAmlCase[]; total: number; }> => {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simulate API delay
        let filtered = [...MOCK_CASES];

        if (filters.status && filters.status !== 'all') {
            filtered = filtered.filter(c => c.status === filters.status);
        }
        if (filters.search) {
            const searchTerm = filters.search.toLowerCase();
            filtered = filtered.filter(c =>
                c.id.toLowerCase().includes(searchTerm) ||
                c.entityName.toLowerCase().includes(searchTerm) ||
                c.summary.toLowerCase().includes(searchTerm) ||
                c.assigneeName.toLowerCase().includes(searchTerm)
            );
        }
        if (filters.caseType && filters.caseType !== 'all') {
            filtered = filtered.filter(c => c.caseType === filters.caseType);
        }
        if (filters.riskLevel && filters.riskLevel !== 'all') {
            filtered = filtered.filter(c => c.riskLevel === filters.riskLevel);
        }
        if (filters.dateRange && filters.dateRange.start) {
            filtered = filtered.filter(c => c.dateOpened >= filters.dateRange.start);
        }
        if (filters.dateRange && filters.dateRange.end) {
            filtered = filtered.filter(c => c.dateOpened <= filters.dateRange.end);
        }
        if (filters.assigneeId && filters.assigneeId !== 'all') {
            filtered = filtered.filter(c => c.assigneeId === filters.assigneeId);
        }

        // Sorting
        filtered.sort((a, b) => {
            const aVal = (a as any)[sort.field];
            const bVal = (b as any)[sort.field];

            if (typeof aVal === 'string' && typeof bVal === 'string') {
                return sort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            }
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return sort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            }
            // Fallback for other types or inconsistencies
            return 0;
        });

        const total = filtered.length;
        const start = (pagination.page - 1) * pagination.limit;
        const end = start + pagination.limit;
        const paginatedCases = filtered.slice(start, end);

        return { cases: paginatedCases, total };
    },

    fetchCaseById: async (id: string): Promise<KycAmlCase | null> => {
        await new Promise(resolve => setTimeout(resolve, 200));
        return MOCK_CASES.find(c => c.id === id) || null;
    },

    updateCase: async (caseData: KycAmlCase): Promise<KycAmlCase> => {
        await new Promise(resolve => setTimeout(resolve, 500));
        const index = MOCK_CASES.findIndex(c => c.id === caseData.id);
        if (index !== -1) {
            MOCK_CASES[index] = { ...caseData, dateUpdated: formatIsoDate(new Date()) };
            return MOCK_CASES[index];
        }
        throw new Error('Case not found');
    },

    updateCaseStatus: async (caseId: string, newStatus: CaseStatus, userId: string): Promise<KycAmlCase> => {
        await new Promise(resolve => setTimeout(resolve, 300));
        const caseToUpdate = MOCK_CASES.find(c => c.id === caseId);
        if (caseToUpdate) {
            const oldStatus = caseToUpdate.status;
            caseToUpdate.status = newStatus;
            caseToUpdate.dateUpdated = formatIsoDate(new Date());
            caseToUpdate.auditLog.push(
                generateMockAuditLogEntry(caseId, userId, getRandomItem(MOCK_USERS).name, 'Status Changed', `Case status updated from ${oldStatus} to ${newStatus}.`, oldStatus, newStatus)
            );
            return { ...caseToUpdate };
        }
        throw new Error('Case not found');
    },

    assignCase: async (caseId: string, assigneeId: string, assigneeName: string, userId: string): Promise<KycAmlCase> => {
        await new Promise(resolve => setTimeout(resolve, 300));
        const caseToUpdate = MOCK_CASES.find(c => c.id === caseId);
        if (caseToUpdate) {
            const oldAssignee = caseToUpdate.assigneeName;
            caseToUpdate.assigneeId = assigneeId;
            caseToUpdate.assigneeName = assigneeName;
            caseToUpdate.dateUpdated = formatIsoDate(new Date());
            caseToUpdate.auditLog.push(
                generateMockAuditLogEntry(caseId, userId, getRandomItem(MOCK_USERS).name, 'Case Assigned', `Case reassigned from ${oldAssignee} to ${assigneeName}.`, oldAssignee, assigneeName)
            );
            return { ...caseToUpdate };
        }
        throw new Error('Case not found');
    },

    addCaseComment: async (caseId: string, userId: string, userName: string, text: string): Promise<KycAmlCase> => {
        await new Promise(resolve => setTimeout(resolve, 200));
        const caseToUpdate = MOCK_CASES.find(c => c.id === caseId);
        if (caseToUpdate) {
            const newComment = { id: generateId('CMT'), userId, userName, timestamp: new Date().toISOString(), text };
            caseToUpdate.comments.push(newComment);
            caseToUpdate.auditLog.push(
                generateMockAuditLogEntry(caseId, userId, userName, 'Comment Added', `New comment by ${userName}.`)
            );
            return { ...caseToUpdate };
        }
        throw new Error('Case not found');
    },

    uploadDocument: async (caseId: string, file: File, documentType: string, userId: string): Promise<Document> => {
        await new Promise(resolve => setTimeout(resolve, 1000));
        const caseToUpdate = MOCK_CASES.find(c => c.id === caseId);
        if (caseToUpdate) {
            const newDoc: Document = {
                id: generateId('DOC'),
                caseId,
                documentType: documentType,
                fileName: file.name,
                uploadDate: formatIsoDate(new Date()),
                status: 'Processing',
                fileUrl: URL.createObjectURL(file), // Mock URL
                metadata: { sizeKB: Math.round(file.size / 1024), fileType: file.type },
                version: 1,
                history: [{ date: formatIsoDate(new Date()), action: 'Uploaded', userId: userId }],
            };
            caseToUpdate.documents.push(newDoc);
            caseToUpdate.auditLog.push(
                generateMockAuditLogEntry(caseId, userId, getRandomItem(MOCK_USERS).name, 'Document Uploaded', `New document '${file.name}' uploaded.`)
            );
            return newDoc;
        }
        throw new Error('Case not found');
    },

    updateDocumentStatus: async (caseId: string, docId: string, newStatus: DocumentStatus, reviewerId: string, rejectionReason?: string): Promise<Document> => {
        await new Promise(resolve => setTimeout(resolve, 300));
        const caseToUpdate = MOCK_CASES.find(c => c.id === caseId);
        if (!caseToUpdate) throw new Error('Case not found');
        const docToUpdate = caseToUpdate.documents.find(d => d.id === docId);
        if (!docToUpdate) throw new Error('Document not found');

        const oldStatus = docToUpdate.status;
        docToUpdate.status = newStatus;
        docToUpdate.reviewerId = reviewerId;
        docToUpdate.reviewDate = formatIsoDate(new Date());
        docToUpdate.rejectionReason = rejectionReason;
        docToUpdate.history.push({ date: formatIsoDate(new Date()), action: `Status changed to ${newStatus}`, userId: reviewerId });
        caseToUpdate.auditLog.push(
            generateMockAuditLogEntry(caseId, reviewerId, MOCK_USERS.find(u => u.id === reviewerId)?.name || 'Unknown', 'Document Status Updated', `Document '${docToUpdate.fileName}' status changed from ${oldStatus} to ${newStatus}.`, oldStatus, newStatus)
        );
        return { ...docToUpdate };
    },

    fetchDashboardKPIs: async (): Promise<{ kpis: Record<string, number | string>; history: KpiSnapshot[]; }> => {
        await new Promise(resolve => setTimeout(resolve, 200));

        const newCases = MOCK_CASES.filter(c => c.status === 'New').length;
        const underReview = MOCK_CASES.filter(c => c.status === 'Under Review').length;
        const escalated = MOCK_CASES.filter(c => c.status === 'Escalated').length;
        const highRiskCases = MOCK_CASES.filter(c => c.riskLevel === 'High').length;
        const criticalRiskCases = MOCK_CASES.filter(c => c.riskLevel === 'Critical').length;
        const avgResolutionTime = '48h'; // Mocked for simplicity, would be calculated in real app

        return {
            kpis: { newCases, underReview, escalated, highRiskCases, criticalRiskCases, avgResolutionTime },
            history: MOCK_KPI_HISTORY,
        };
    },

    fetchSettings: async (): Promise<DashboardSettings> => {
        await new Promise(resolve => setTimeout(resolve, 100));
        return MOCK_DASHBOARD_SETTINGS;
    },

    updateSettings: async (settings: DashboardSettings): Promise<DashboardSettings> => {
        await new Promise(resolve => setTimeout(resolve, 200));
        // In a real app, this would persist to a backend
        Object.assign(MOCK_DASHBOARD_SETTINGS, settings);
        return { ...MOCK_DASHBOARD_SETTINGS };
    },
};

// ================================================================================================
// UI COMPONENTS (STYLED WITH TAILWIND CSS)
// ================================================================================================

export const Tooltip: React.FC<{ content: string; children: React.ReactNode; }> = ({ content, children }) => {
    return (
        <div className="relative flex items-center group">
            {children}
            <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 hidden group-hover:block px-3 py-1 bg-gray-700 text-white text-xs rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                {content}
            </div>
        </div>
    );
};

export const TabButton: React.FC<{ label: string; active: boolean; onClick: () => void; }> = ({ label, active, onClick }) => (
    <button
        onClick={onClick}
        className={`px-4 py-2 text-sm font-medium border-b-2 ${active ? 'border-cyan-500 text-cyan-400' : 'border-transparent text-gray-400 hover:text-white hover:border-gray-500'}`}
    >
        {label}
    </button>
);

export const Dropdown: React.FC<{
    label: string;
    options: { value: string; label: string; }[];
    selectedValue: string;
    onValueChange: (value: string) => void;
    className?: string;
}> = ({ label, options, selectedValue, onValueChange, className }) => {
    return (
        <div className={`relative ${className}`}>
            <label htmlFor={`dropdown-${label}`} className="block text-xs font-medium text-gray-400 mb-1">{label}</label>
            <select
                id={`dropdown-${label}`}
                value={selectedValue}
                onChange={(e) => onValueChange(e.target.value)}
                className="block w-full px-3 py-2 text-sm text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500"
            >
                {options.map(option => (
                    <option key={option.value} value={option.value}>{option.label}</option>
                ))}
            </select>
        </div>
    );
};

export const InputField: React.FC<{
    label: string;
    type: string;
    value: string;
    onChange: (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => void;
    placeholder?: string;
    className?: string;
    multiline?: boolean;
}> = ({ label, type, value, onChange, placeholder, className, multiline }) => {
    const Component = multiline ? 'textarea' : 'input';
    return (
        <div className={className}>
            <label htmlFor={`input-${label}`} className="block text-xs font-medium text-gray-400 mb-1">{label}</label>
            <Component
                id={`input-${label}`}
                type={type}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                className="block w-full px-3 py-2 text-sm text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500"
                rows={multiline ? 4 : undefined}
            />
        </div>
    );
};

export const DateRangePicker: React.FC<{
    startDate: string;
    endDate: string;
    onStartDateChange: (date: string) => void;
    onEndDateChange: (date: string) => void;
    label?: string;
}> = ({ startDate, endDate, onStartDateChange, onEndDateChange, label = 'Date Range' }) => {
    return (
        <div className="flex flex-col gap-2">
            <label className="block text-xs font-medium text-gray-400">{label}</label>
            <div className="flex space-x-2">
                <InputField
                    label="From"
                    type="date"
                    value={startDate}
                    onChange={(e) => onStartDateChange(e.target.value)}
                    className="flex-1"
                />
                <InputField
                    label="To"
                    type="date"
                    value={endDate}
                    onChange={(e) => onEndDateChange(e.target.value)}
                    className="flex-1"
                />
            </div>
        </div>
    );
};

export const PaginationControls: React.FC<{
    currentPage: number;
    totalPages: number;
    onPageChange: (page: number) => void;
    onPageSizeChange: (size: number) => void;
    pageSize: number;
    totalItems: number;
}> = ({ currentPage, totalPages, onPageChange, onPageSizeChange, pageSize, totalItems }) => {
    const pageNumbers = useMemo(() => {
        const pages: (number | '...')[] = [];
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) {
                pages.push(i);
            }
        } else {
            pages.push(1);
            if (currentPage > 3) pages.push('...');
            if (currentPage > 2) pages.push(currentPage - 1);
            if (currentPage !== 1 && currentPage !== totalPages) pages.push(currentPage);
            if (currentPage < totalPages - 1) pages.push(currentPage + 1);
            if (currentPage < totalPages - 2) pages.push('...');
            pages.push(totalPages);
        }
        return Array.from(new Set(pages)); // Remove duplicate '...'
    }, [currentPage, totalPages]);

    return (
        <div className="flex justify-between items-center text-sm text-gray-400 mt-4">
            <div>
                Showing {Math.min((currentPage - 1) * pageSize + 1, totalItems)} - {Math.min(currentPage * pageSize, totalItems)} of {totalItems} items
            </div>
            <div className="flex items-center space-x-3">
                <Dropdown
                    label="Items per page"
                    options={[{ value: '10', label: '10' }, { value: '25', label: '25' }, { value: '50', label: '50' }]}
                    selectedValue={String(pageSize)}
                    onValueChange={(value) => onPageSizeChange(Number(value))}
                />
                <nav className="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <button
                        onClick={() => onPageChange(currentPage - 1)}
                        disabled={currentPage === 1}
                        className="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-600 bg-gray-700 text-sm font-medium text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Prev
                    </button>
                    {pageNumbers.map((page, index) => (
                        page === '...' ? (
                            <span key={index} className="relative inline-flex items-center px-4 py-2 border border-gray-600 bg-gray-700 text-sm font-medium text-gray-300">
                                ...
                            </span>
                        ) : (
                            <button
                                key={index}
                                onClick={() => onPageChange(page as number)}
                                className={`relative inline-flex items-center px-4 py-2 border border-gray-600 text-sm font-medium ${currentPage === page ? 'z-10 bg-cyan-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                            >
                                {page}
                            </button>
                        )
                    ))}
                    <button
                        onClick={() => onPageChange(currentPage + 1)}
                        disabled={currentPage === totalPages}
                        className="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-600 bg-gray-700 text-sm font-medium text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Next
                    </button>
                </nav>
            </div>
        </div>
    );
};

export const StatusBadge: React.FC<{ status: CaseStatus }> = ({ status }) => {
    const colors = {
        'New': 'bg-red-500/20 text-red-300',
        'Under Review': 'bg-yellow-500/20 text-yellow-300',
        'Cleared': 'bg-green-500/20 text-green-300',
        'Escalated': 'bg-purple-500/20 text-purple-300',
        'Pending Docs': 'bg-blue-500/20 text-blue-300',
        'Awaiting Approval': 'bg-indigo-500/20 text-indigo-300',
        'Closed': 'bg-gray-500/20 text-gray-300',
    };
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[status]}`}>{status}</span>;
};

export const RiskBadge: React.FC<{ risk: CaseRisk }> = ({ risk }) => {
    const colors = {
        'Low': 'bg-green-500/20 text-green-300',
        'Medium': 'bg-yellow-500/20 text-yellow-300',
        'High': 'bg-orange-500/20 text-orange-300',
        'Critical': 'bg-red-500/20 text-red-300',
    };
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[risk]}`}>{risk}</span>;
};

// ================================================================================================
// CASE DETAIL MODAL TABS
// ================================================================================================

export const OverviewTab: React.FC<{ caseData: KycAmlCase; onUpdateStatus: (status: CaseStatus) => void; onAssignCase: (assigneeId: string, assigneeName: string) => void; onDecision: (decision: KycAmlCase['decision'], reason: string) => void; }> = ({ caseData, onUpdateStatus, onAssignCase, onDecision }) => {
    const [status, setStatus] = useState<CaseStatus>(caseData.status);
    const [assigneeId, setAssigneeId] = useState<string>(caseData.assigneeId);
    const [showDecisionModal, setShowDecisionModal] = useState(false);
    const [decisionValue, setDecisionValue] = useState<KycAmlCase['decision']>('Approved');
    const [decisionReason, setDecisionReason] = useState('');

    useEffect(() => {
        setStatus(caseData.status);
        setAssigneeId(caseData.assigneeId);
    }, [caseData]);

    const handleAssignChange = (newAssigneeId: string) => {
        const user = MOCK_USERS.find(u => u.id === newAssigneeId);
        if (user) {
            setAssigneeId(newAssigneeId);
            onAssignCase(newAssigneeId, user.name);
        }
    };

    const handleStatusChange = (newStatus: CaseStatus) => {
        setStatus(newStatus);
        onUpdateStatus(newStatus);
    };

    const handleDecisionSubmit = () => {
        onDecision(decisionValue, decisionReason);
        setShowDecisionModal(false);
        setDecisionReason('');
        setDecisionValue('Approved');
    };

    return (
        <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <p><strong className="text-gray-400">Entity:</strong> {caseData.entityName}</p>
                <p><strong className="text-gray-400">Entity Type:</strong> {caseData.entityType}</p>
                <p><strong className="text-gray-400">Case Type:</strong> {caseData.caseType}</p>
                <p><strong className="text-gray-400">Risk Level:</strong> <RiskBadge risk={caseData.riskLevel} /></p>
                <p><strong className="text-gray-400">Priority:</strong> {caseData.priority}</p>
                <p><strong className="text-gray-400">Date Opened:</strong> {caseData.dateOpened}</p>
                <p><strong className="text-gray-400">Last Updated:</strong> {caseData.dateUpdated}</p>
                {caseData.dueDate && <p><strong className="text-gray-400">Due Date:</strong> {caseData.dueDate}</p>}
                <p><strong className="text-gray-400">Source System:</strong> {caseData.sourceSystem}</p>
            </div>

            <Card title="Case Summary & Description">
                <p className="text-sm text-gray-300 mb-2">{caseData.summary}</p>
                <p className="text-xs text-gray-400">{caseData.description}</p>
            </Card>

            <Card title="Workflow Actions">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Dropdown
                        label="Current Status"
                        options={Object.values(CaseStatus).map(s => ({ value: s, label: s }))}
                        selectedValue={status}
                        onValueChange={handleStatusChange}
                    />
                    <Dropdown
                        label="Assignee"
                        options={[{ value: 'usr-unassigned', label: 'Unassigned' }, ...MOCK_USERS.filter(u => u.role === 'Analyst' || u.role === 'Senior Analyst').map(u => ({ value: u.id, label: u.name }))]}
                        selectedValue={assigneeId}
                        onValueChange={handleAssignChange}
                    />
                    <div className="self-end">
                        <button
                            onClick={() => setShowDecisionModal(true)}
                            className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg w-full"
                        >
                            Make Decision
                        </button>
                    </div>
                </div>
                {showDecisionModal && (
                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm">
                        <div className="bg-gray-800 rounded-lg shadow-2xl max-w-md w-full border border-gray-700">
                            <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                                <h4 className="text-lg font-semibold text-white">Record Decision</h4>
                                <button onClick={() => setShowDecisionModal(false)} className="text-gray-400 hover:text-white">&times;</button>
                            </div>
                            <div className="p-6 space-y-4">
                                <Dropdown
                                    label="Decision"
                                    options={[{ value: 'Approved', label: 'Approved' }, { value: 'Rejected', label: 'Rejected' }, { value: 'Further Review', label: 'Further Review' }]}
                                    selectedValue={decisionValue || ''}
                                    onValueChange={(val) => setDecisionValue(val as KycAmlCase['decision'])}
                                />
                                <InputField
                                    label="Reason"
                                    type="text"
                                    multiline
                                    value={decisionReason}
                                    onChange={(e) => setDecisionReason(e.target.value)}
                                    placeholder="Provide a detailed reason for the decision."
                                />
                            </div>
                            <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end gap-3">
                                <button onClick={() => setShowDecisionModal(false)} className="px-4 py-2 text-gray-300 hover:text-white text-sm rounded-lg">Cancel</button>
                                <button onClick={handleDecisionSubmit} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg">Submit Decision</button>
                            </div>
                        </div>
                    </div>
                )}
            </Card>

            {caseData.relatedCases.length > 0 && (
                <Card title="Related Cases">
                    <ul className="list-disc list-inside text-sm text-gray-300">
                        {caseData.relatedCases.map(relCaseId => (
                            <li key={relCaseId} className="hover:text-cyan-400 cursor-pointer">
                                {relCaseId} - <span className="text-gray-400">Associated for linked entity</span>
                            </li>
                        ))}
                    </ul>
                </Card>
            )}
        </div>
    );
};

export const DocumentsTab: React.FC<{ caseData: KycAmlCase; onUploadDocument: (file: File, documentType: string) => Promise<void>; onUpdateDocumentStatus: (docId: string, status: DocumentStatus, reason?: string) => Promise<void>; }> = ({ caseData, onUploadDocument, onUpdateDocumentStatus }) => {
    const [showUploadModal, setShowUploadModal] = useState(false);
    const [selectedFile, setSelectedFile] = useState<File | null>(null);
    const [uploadDocumentType, setUploadDocumentType] = useState<string>('Passport');
    const [uploading, setUploading] = useState(false);
    const [showDocumentPreview, setShowDocumentPreview] = useState<Document | null>(null);
    const [docReviewStatus, setDocReviewStatus] = useState<DocumentStatus>('Verified');
    const [docReviewReason, setDocReviewReason] = useState('');
    const [showDocReviewModal, setShowDocReviewModal] = useState<Document | null>(null);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            setSelectedFile(e.target.files[0]);
        }
    };

    const handleUploadSubmit = async () => {
        if (selectedFile) {
            setUploading(true);
            try {
                await onUploadDocument(selectedFile, uploadDocumentType);
                setSelectedFile(null);
                setUploadDocumentType('Passport');
                setShowUploadModal(false);
            } catch (error) {
                console.error('Document upload failed:', error);
            } finally {
                setUploading(false);
            }
        }
    };

    const handleDocumentReview = async () => {
        if (showDocReviewModal) {
            try {
                await onUpdateDocumentStatus(showDocReviewModal.id, docReviewStatus, docReviewStatus === 'Rejected' ? docReviewReason : undefined);
                setShowDocReviewModal(null);
                setDocReviewReason('');
                setDocReviewStatus('Verified');
            } catch (error) {
                console.error('Document status update failed:', error);
            }
        }
    };

    return (
        <div className="space-y-4">
            <div className="flex justify-end">
                <button onClick={() => setShowUploadModal(true)} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">Upload Document</button>
            </div>
            <Card title="Uploaded Documents">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">File Name</th>
                                <th className="px-6 py-3">Type</th>
                                <th className="px-6 py-3">Status</th>
                                <th className="px-6 py-3">Upload Date</th>
                                <th className="px-6 py-3">Reviewer</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {caseData.documents.length === 0 && (
                                <tr><td colSpan={6} className="px-6 py-4 text-center text-gray-500">No documents found.</td></tr>
                            )}
                            {caseData.documents.map(doc => (
                                <tr key={doc.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-mono text-white flex items-center gap-2">
                                        <button onClick={() => setShowDocumentPreview(doc)} className="text-cyan-400 hover:underline">{doc.fileName}</button>
                                        <Tooltip content="View Document History">
                                            <button className="text-gray-500 hover:text-white text-xs">(v{doc.version})</button>
                                        </Tooltip>
                                    </td>
                                    <td className="px-6 py-4">{doc.documentType}</td>
                                    <td className="px-6 py-4">
                                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${doc.status === 'Verified' ? 'bg-green-500/20 text-green-300' : doc.status === 'Rejected' ? 'bg-red-500/20 text-red-300' : 'bg-yellow-500/20 text-yellow-300'}`}>
                                            {doc.status}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">{doc.uploadDate}</td>
                                    <td className="px-6 py-4">{MOCK_USERS.find(u => u.id === doc.reviewerId)?.name || 'N/A'}</td>
                                    <td className="px-6 py-4">
                                        <button onClick={() => setShowDocReviewModal(doc)} className="text-purple-400 hover:underline text-sm mr-2">Review</button>
                                        <button className="text-red-400 hover:underline text-sm">Delete</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>

            {showUploadModal && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-md w-full border border-gray-700">
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h4 className="text-lg font-semibold text-white">Upload New Document</h4>
                            <button onClick={() => setShowUploadModal(false)} className="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-4">
                            <InputField label="File" type="file" value="" onChange={handleFileChange} />
                            <Dropdown
                                label="Document Type"
                                options={mockDocumentTypes.map(type => ({ value: type, label: type }))}
                                selectedValue={uploadDocumentType}
                                onValueChange={setUploadDocumentType}
                            />
                            {selectedFile && <p className="text-sm text-gray-300">Selected: {selectedFile.name}</p>}
                        </div>
                        <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end gap-3">
                            <button onClick={() => setShowUploadModal(false)} className="px-4 py-2 text-gray-300 hover:text-white text-sm rounded-lg">Cancel</button>
                            <button onClick={handleUploadSubmit} disabled={!selectedFile || uploading} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                {uploading ? 'Uploading...' : 'Upload'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {showDocumentPreview && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setShowDocumentPreview(null)}>
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full h-[90vh] flex flex-col border border-gray-700" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h4 className="text-lg font-semibold text-white">Document Preview: {showDocumentPreview.fileName}</h4>
                            <button onClick={() => setShowDocumentPreview(null)} className="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div className="flex-grow p-6 overflow-hidden">
                            {/* In a real app, this would embed a PDF viewer or image, using fileUrl */}
                            <div className="flex items-center justify-center w-full h-full bg-gray-900 text-gray-500 rounded-md">
                                <p className="text-lg">Document preview unavailable in mock. File: <span className="text-white">{showDocumentPreview.fileName}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {showDocReviewModal && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-md w-full border border-gray-700">
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h4 className="text-lg font-semibold text-white">Review Document: {showDocReviewModal.fileName}</h4>
                            <button onClick={() => setShowDocReviewModal(null)} className="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-4">
                            <Dropdown
                                label="Set Status"
                                options={Object.values(DocumentStatus).map(s => ({ value: s, label: s }))}
                                selectedValue={docReviewStatus}
                                onValueChange={(val) => setDocReviewStatus(val as DocumentStatus)}
                            />
                            {docReviewStatus === 'Rejected' && (
                                <InputField
                                    label="Rejection Reason"
                                    type="text"
                                    multiline
                                    value={docReviewReason}
                                    onChange={(e) => setDocReviewReason(e.target.value)}
                                    placeholder="Explain why the document is rejected."
                                />
                            )}
                        </div>
                        <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end gap-3">
                            <button onClick={() => setShowDocReviewModal(null)} className="px-4 py-2 text-gray-300 hover:text-white text-sm rounded-lg">Cancel</button>
                            <button onClick={handleDocumentReview} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg">Update Document</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export const TransactionsTab: React.FC<{ caseData: KycAmlCase; }> = ({ caseData }) => {
    const [filterType, setFilterType] = useState<TransactionType | 'all'>('all');
    const [minAmount, setMinAmount] = useState<string>('');
    const [maxAmount, setMaxAmount] = useState<string>('');
    const [sortField, setSortField] = useState<keyof Transaction>('transactionDate');
    const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');

    const filteredAndSortedTransactions = useMemo(() => {
        let filtered = caseData.transactions;

        if (filterType !== 'all') {
            filtered = filtered.filter(t => t.type === filterType);
        }
        if (minAmount) {
            filtered = filtered.filter(t => t.amount >= parseFloat(minAmount));
        }
        if (maxAmount) {
            filtered = filtered.filter(t => t.amount <= parseFloat(maxAmount));
        }

        return filtered.sort((a, b) => {
            const aVal = a[sortField];
            const bVal = b[sortField];

            if (typeof aVal === 'string' && typeof bVal === 'string') {
                return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            }
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            }
            return 0;
        });
    }, [caseData.transactions, filterType, minAmount, maxAmount, sortField, sortDirection]);

    return (
        <div className="space-y-4">
            <Card title="Transaction Filters">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <Dropdown
                        label="Transaction Type"
                        options={[{ value: 'all', label: 'All Types' }, ...Object.values(TransactionType).map(t => ({ value: t, label: t }))]}
                        selectedValue={filterType}
                        onValueChange={(val) => setFilterType(val as TransactionType | 'all')}
                    />
                    <InputField
                        label="Min Amount"
                        type="number"
                        value={minAmount}
                        onChange={(e) => setMinAmount(e.target.value)}
                        placeholder="e.g. 1000"
                    />
                    <InputField
                        label="Max Amount"
                        type="number"
                        value={maxAmount}
                        onChange={(e) => setMaxAmount(e.target.value)}
                        placeholder="e.g. 50000"
                    />
                    <div className="flex gap-2">
                        <Dropdown
                            label="Sort By"
                            options={Object.keys(caseData.transactions[0] || {})
                                .filter(key => ['transactionDate', 'amount', 'riskScore'].includes(key)) // Only sortable fields
                                .map(key => ({ value: key, label: key.replace(/([A-Z])/g, ' $1').trim() }))
                            }
                            selectedValue={sortField}
                            onValueChange={(val) => setSortField(val as keyof Transaction)}
                        />
                        <Dropdown
                            label="Order"
                            options={[{ value: 'desc', label: 'Desc' }, { value: 'asc', label: 'Asc' }]}
                            selectedValue={sortDirection}
                            onValueChange={(val) => setSortDirection(val as 'asc' | 'desc')}
                        />
                    </div>
                </div>
            </Card>

            <Card title="Transaction History">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Date</th>
                                <th className="px-6 py-3">Type</th>
                                <th className="px-6 py-3">Amount</th>
                                <th className="px-6 py-3">Sender</th>
                                <th className="px-6 py-3">Receiver</th>
                                <th className="px-6 py-3">Risk</th>
                                <th className="px-6 py-3">Status</th>
                                <th className="px-6 py-3">Flags</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredAndSortedTransactions.length === 0 && (
                                <tr><td colSpan={8} className="px-6 py-4 text-center text-gray-500">No transactions matching criteria.</td></tr>
                            )}
                            {filteredAndSortedTransactions.map(txn => (
                                <tr key={txn.id} className="border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer">
                                    <td className="px-6 py-4">{txn.transactionDate}</td>
                                    <td className="px-6 py-4">{txn.type}</td>
                                    <td className="px-6 py-4 font-bold text-white">{txn.currency} {txn.amount.toLocaleString()}</td>
                                    <td className="px-6 py-4">{txn.senderName}</td>
                                    <td className="px-6 py-4">{txn.receiverName}</td>
                                    <td className="px-6 py-4">{txn.riskScore}</td>
                                    <td className="px-6 py-4">
                                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${txn.status === 'Flagged' ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`}>
                                            {txn.status}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">
                                        {txn.flags.length > 0 ? (
                                            <div className="flex flex-wrap gap-1">
                                                {txn.flags.map((flag, i) => (
                                                    <span key={i} className="px-2 py-1 text-xs font-medium rounded-full bg-orange-500/20 text-orange-300">
                                                        {flag}
                                                    </span>
                                                ))}
                                            </div>
                                        ) : 'N/A'}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};

export const AuditLogTab: React.FC<{ caseData: KycAmlCase; }> = ({ caseData }) => {
    const [filterAction, setFilterAction] = useState<string>('all');
    const [filterUser, setFilterUser] = useState<string>('all');

    const filteredAuditLog = useMemo(() => {
        let filtered = caseData.auditLog;
        if (filterAction !== 'all') {
            filtered = filtered.filter(log => log.action === filterAction);
        }
        if (filterUser !== 'all') {
            filtered = filtered.filter(log => log.userId === filterUser);
        }
        return filtered.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
    }, [caseData.auditLog, filterAction, filterUser]);

    const uniqueActions = useMemo(() => ['all', ...Array.from(new Set(caseData.auditLog.map(log => log.action)))], [caseData.auditLog]);
    const uniqueUsers = useMemo(() => ['all', ...Array.from(new Set(caseData.auditLog.map(log => log.userId)))], [caseData.auditLog]);

    return (
        <div className="space-y-4">
            <Card title="Audit Log Filters">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Dropdown
                        label="Action Type"
                        options={uniqueActions.map(action => ({ value: action, label: action.replace(/([A-Z])/g, ' $1').trim() }))}
                        selectedValue={filterAction}
                        onValueChange={setFilterAction}
                    />
                    <Dropdown
                        label="User"
                        options={uniqueUsers.map(userId => ({ value: userId, label: MOCK_USERS.find(u => u.id === userId)?.name || 'Unknown User' }))}
                        selectedValue={filterUser}
                        onValueChange={setFilterUser}
                    />
                </div>
            </Card>
            <Card title="Case Audit Trail">
                <div className="overflow-x-auto max-h-96">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Timestamp</th>
                                <th className="px-6 py-3">User</th>
                                <th className="px-6 py-3">Action</th>
                                <th className="px-6 py-3">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredAuditLog.length === 0 && (
                                <tr><td colSpan={4} className="px-6 py-4 text-center text-gray-500">No audit entries found.</td></tr>
                            )}
                            {filteredAuditLog.map(log => (
                                <tr key={log.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4">{new Date(log.timestamp).toLocaleString()}</td>
                                    <td className="px-6 py-4">{log.userName}</td>
                                    <td className="px-6 py-4"><span className="font-medium text-cyan-400">{log.action}</span></td>
                                    <td className="px-6 py-4">{log.details}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};

export const SanctionsMediaTab: React.FC<{ caseData: KycAmlCase; onTriggerScreening: (type: 'sanctions' | 'adverseMedia') => void; }> = ({ caseData, onTriggerScreening }) => {
    return (
        <div className="space-y-6">
            <Card title="Sanctions Screening Results">
                <div className="flex justify-end mb-4">
                    <button onClick={() => onTriggerScreening('sanctions')} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg">Re-run Sanctions Screen</button>
                </div>
                {caseData.sanctionScreeningResults.length === 0 ? (
                    <p className="text-sm text-gray-500">No sanctions screening results available for this case.</p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-400">
                            <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                <tr>
                                    <th className="px-6 py-3">List</th>
                                    <th className="px-6 py-3">Match Type</th>
                                    <th className="px-6 py-3">Matched Name</th>
                                    <th className="px-6 py-3">Status</th>
                                    <th className="px-6 py-3">Screen Date</th>
                                    <th className="px-6 py-3">Reviewer</th>
                                    <th className="px-6 py-3">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {caseData.sanctionScreeningResults.map(res => (
                                    <tr key={res.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                        <td className="px-6 py-4">{res.list}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${res.matchType === 'None' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>
                                                {res.matchType}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">{res.matchedName || 'N/A'}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${res.status === 'Cleared' ? 'bg-green-500/20 text-green-300' : 'bg-orange-500/20 text-orange-300'}`}>
                                                {res.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">{res.screenDate}</td>
                                        <td className="px-6 py-4">{MOCK_USERS.find(u => u.id === res.reviewerId)?.name || 'N/A'}</td>
                                        <td className="px-6 py-4">{res.notes || 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </Card>

            <Card title="Adverse Media Results">
                <div className="flex justify-end mb-4">
                    <button onClick={() => onTriggerScreening('adverseMedia')} className="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm rounded-lg">Re-run Adverse Media Screen</button>
                </div>
                {caseData.adverseMediaResults.length === 0 ? (
                    <p className="text-sm text-gray-500">No adverse media results available for this case.</p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-400">
                            <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                <tr>
                                    <th className="px-6 py-3">Headline</th>
                                    <th className="px-6 py-3">Source</th>
                                    <th className="px-6 py-3">Category</th>
                                    <th className="px-6 py-3">Sentiment</th>
                                    <th className="px-6 py-3">Publish Date</th>
                                    <th className="px-6 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {caseData.adverseMediaResults.map(res => (
                                    <tr key={res.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                        <td className="px-6 py-4">
                                            <a href={res.url} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">
                                                {res.headline}
                                            </a>
                                        </td>
                                        <td className="px-6 py-4">{res.source}</td>
                                        <td className="px-6 py-4">
                                            {res.category.length > 0 ? (
                                                <div className="flex flex-wrap gap-1">
                                                    {res.category.map((cat, i) => (
                                                        <span key={i} className="px-2 py-1 text-xs font-medium rounded-full bg-indigo-500/20 text-indigo-300">
                                                            {cat}
                                                        </span>
                                                    ))}
                                                </div>
                                            ) : 'N/A'}
                                        </td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${res.sentiment === 'Negative' ? 'bg-red-500/20 text-red-300' : res.sentiment === 'Positive' ? 'bg-green-500/20 text-green-300' : 'bg-gray-500/20 text-gray-300'}`}>
                                                {res.sentiment}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">{res.publishDate}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${res.status === 'Relevant' ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`}>
                                                {res.status}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </Card>

            <Card title="Risk Factor Analysis">
                {caseData.riskFactors.length === 0 ? (
                    <p className="text-sm text-gray-500">No specific risk factors identified for this case.</p>
                ) : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-400">
                            <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                <tr>
                                    <th className="px-6 py-3">Category</th>
                                    <th className="px-6 py-3">Description</th>
                                    <th className="px-6 py-3">Score Impact</th>
                                    <th className="px-6 py-3">Mitigated</th>
                                    <th className="px-6 py-3">Mitigation Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {caseData.riskFactors.map(factor => (
                                    <tr key={factor.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                        <td className="px-6 py-4">{factor.category}</td>
                                        <td className="px-6 py-4">{factor.description}</td>
                                        <td className="px-6 py-4 text-red-400 font-bold">+{factor.scoreImpact}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${factor.isMitigated ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>
                                                {factor.isMitigated ? 'Yes' : 'No'}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">{factor.mitigationDetails || 'N/A'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </Card>
        </div>
    );
};

export const NotesCommunicationTab: React.FC<{ caseData: KycAmlCase; onAddComment: (text: string) => Promise<void>; }> = ({ caseData, onAddComment }) => {
    const [newComment, setNewComment] = useState('');
    const commentsEndRef = useRef<HTMLDivElement>(null);

    const handleAddComment = async () => {
        if (newComment.trim()) {
            await onAddComment(newComment);
            setNewComment('');
        }
    };

    useEffect(() => {
        commentsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [caseData.comments]);

    return (
        <div className="space-y-4">
            <Card title="Case Notes">
                <div className="max-h-80 overflow-y-auto pr-2 space-y-3">
                    {caseData.comments.length === 0 && (
                        <p className="text-sm text-gray-500 text-center">No notes or comments yet. Add one below.</p>
                    )}
                    {caseData.comments.map(comment => (
                        <div key={comment.id} className="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                            <div className="flex justify-between items-center text-xs text-gray-400 mb-1">
                                <span className="font-semibold text-white">{comment.userName}</span>
                                <span>{new Date(comment.timestamp).toLocaleString()}</span>
                            </div>
                            <p className="text-sm text-gray-300">{comment.text}</p>
                        </div>
                    ))}
                    <div ref={commentsEndRef} />
                </div>
                <div className="mt-4 border-t border-gray-700 pt-4">
                    <InputField
                        label="Add New Note"
                        type="text"
                        multiline
                        value={newComment}
                        onChange={(e) => setNewComment(e.target.value)}
                        placeholder="Type your note here..."
                    />
                    <button
                        onClick={handleAddComment}
                        disabled={!newComment.trim()}
                        className="mt-3 px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Add Note
                    </button>
                </div>
            </Card>

            <Card title="Internal Communication (Mock)">
                <p className="text-sm text-gray-500">
                    In a real application, this section would feature a dedicated internal chat or messaging system for compliance teams to discuss cases.
                </p>
                <div className="mt-4 bg-gray-700/30 p-4 rounded-md text-sm text-gray-400">
                    <p className="mb-2"><strong>[Mock Message] Analyst Jane:</strong> Has anyone checked the related entity "Global Holdings LLC" yet?</p>
                    <p className="mb-2 text-right"><strong>[Mock Message] Senior Alice:</strong> Yes, a separate AML case (AML-007) was opened for them. No immediate red flags but monitoring is active.</p>
                    <p><strong>[Mock Message] Analyst Jane:</strong> Ok, thanks for the update!</p>
                </div>
            </Card>
        </div>
    );
};

// ================================================================================================
// SUB-COMPONENTS
// ================================================================================================

export const CaseDetailModal: React.FC<{ caseData: KycAmlCase | null; onClose: () => void; onCaseUpdated: (updatedCase: KycAmlCase) => void; }> = ({ caseData, onClose, onCaseUpdated }) => {
    const [aiSummary, setAiSummary] = useState('');
    const [isLoadingAi, setIsLoadingAi] = useState(false);
    const [activeTab, setActiveTab] = useState('Overview');
    const [currentCaseData, setCurrentCaseData] = useState<KycAmlCase | null>(caseData); // Internal state for case data

    useEffect(() => {
        setCurrentCaseData(caseData);
        setAiSummary(''); // Clear AI summary on new case selection
        if (caseData) {
            setActiveTab('Overview'); // Reset tab to overview for new case
        }
    }, [caseData]);

    if (!currentCaseData) return null;

    const generateSummary = async () => {
        setIsLoadingAi(true);
        setAiSummary('');
        try {
            // NOTE: In a production environment, API_KEY would be securely managed,
            // and the prompt would be more sophisticated with actual case data.
            const ai = new GoogleGenAI({ apiKey: process.env.NEXT_PUBLIC_API_KEY as string }); // Changed to NEXT_PUBLIC_API_KEY for client-side
            const model = ai.getGenerativeModel({ model: 'gemini-pro' }); // Using a more capable model for detailed analysis
            const prompt = `You are a senior compliance analyst AI. Review the following KYC/AML case data and generate a brief, actionable "Next Steps" recommendation in 3-5 bullet points. Also, provide a brief risk assessment statement (1-2 sentences).

            Case ID: ${currentCaseData.id}
            Entity: ${currentCaseData.entityName} (${currentCaseData.entityType})
            Case Type: ${currentCaseData.caseType}
            Current Risk Level: ${currentCaseData.riskLevel}
            Status: ${currentCaseData.status}
            Summary: ${currentCaseData.summary}
            Description: ${currentCaseData.description}
            Documents Status: ${currentCaseData.documents.map(d => `${d.documentType}: ${d.status}`).join(', ') || 'None'}
            Transactions Flags: ${currentCaseData.transactions.flatMap(t => t.flags).join(', ') || 'None'}
            Sanctions Screening: ${currentCaseData.sanctionScreeningResults.map(r => `${r.list}: ${r.status}`).join(', ') || 'None'}
            Adverse Media: ${currentCaseData.adverseMediaResults.map(r => `${r.source}: ${r.status}`).join(', ') || 'None'}
            Risk Factors: ${currentCaseData.riskFactors.map(rf => `${rf.category}: ${rf.description} (Mitigated: ${rf.isMitigated})`).join(', ') || 'None'}
            Comments: ${currentCaseData.comments.map(c => c.text).join('; ') || 'None'}

            Based on this information, provide:
            1. A concise Risk Assessment Statement (1-2 sentences).
            2. 3-5 actionable "Next Steps" as bullet points.
            `;
            const result = await model.generateContent(prompt);
            const responseText = result.response.text();
            setAiSummary(responseText.replace(/â€¢/g, '\n•')); // Replace specific character with standard bullet point
        } catch (err) {
            console.error("AI Generation Error:", err);
            setAiSummary("Error generating AI recommendations. Ensure API key is valid and prompt is well-formed. Check console for details.");
        } finally {
            setIsLoadingAi(false);
        }
    };

    const handleCaseUpdate = (updatedField: Partial<KycAmlCase>) => {
        if (currentCaseData) {
            const updatedCase = { ...currentCaseData, ...updatedField };
            setCurrentCaseData(updatedCase);
            onCaseUpdated(updatedCase); // Notify parent component of the update
        }
    };

    const handleUpdateStatus = async (newStatus: CaseStatus) => {
        try {
            const updated = await kycAmlService.updateCaseStatus(currentCaseData.id, newStatus, MOCK_USERS[0].id); // Using a mock user for now
            handleCaseUpdate(updated);
        } catch (error) {
            console.error('Failed to update case status:', error);
            // Revert UI state if API fails
            setCurrentCaseData(caseData);
        }
    };

    const handleAssignCase = async (assigneeId: string, assigneeName: string) => {
        try {
            const updated = await kycAmlService.assignCase(currentCaseData.id, assigneeId, assigneeName, MOCK_USERS[0].id);
            handleCaseUpdate(updated);
        } catch (error) {
            console.error('Failed to assign case:', error);
            setCurrentCaseData(caseData);
        }
    };

    const handleDecision = async (decision: KycAmlCase['decision'], reason: string) => {
        if (currentCaseData) {
            try {
                const updated = await kycAmlService.updateCase({
                    ...currentCaseData,
                    decision,
                    decisionReason: reason,
                    decisionByUserId: MOCK_USERS[0].id,
                    decisionDate: formatIsoDate(new Date()),
                    status: decision === 'Approved' ? 'Cleared' : decision === 'Rejected' ? 'Closed' : currentCaseData.status,
                });
                handleCaseUpdate(updated);
            } catch (error) {
                console.error('Failed to record decision:', error);
                setCurrentCaseData(caseData);
            }
        }
    };

    const handleAddComment = async (text: string) => {
        try {
            const updated = await kycAmlService.addCaseComment(currentCaseData.id, MOCK_USERS[0].id, MOCK_USERS[0].name, text);
            handleCaseUpdate(updated);
        } catch (error) {
            console.error('Failed to add comment:', error);
        }
    };

    const handleUploadDocument = async (file: File, documentType: string) => {
        try {
            const newDoc = await kycAmlService.uploadDocument(currentCaseData.id, file, documentType, MOCK_USERS[0].id);
            handleCaseUpdate({ documents: [...currentCaseData.documents, newDoc] });
        } catch (error) {
            console.error('Failed to upload document:', error);
            throw error; // Re-throw to indicate failure
        }
    };

    const handleUpdateDocumentStatus = async (docId: string, status: DocumentStatus, reason?: string) => {
        try {
            const updatedDoc = await kycAmlService.updateDocumentStatus(currentCaseData.id, docId, status, MOCK_USERS[0].id, reason);
            handleCaseUpdate({
                documents: currentCaseData.documents.map(d => (d.id === docId ? updatedDoc : d)),
            });
        } catch (error) {
            console.error('Failed to update document status:', error);
            throw error;
        }
    };

    const handleTriggerScreening = async (type: 'sanctions' | 'adverseMedia') => {
        // In a real app, this would trigger a backend process and update the case data
        // For mock, we'll simulate adding a new result
        alert(`Simulating re-running ${type} screening for ${currentCaseData.entityName}. This would update the case data in a real system.`);
        // Simulate a new result being added after some delay
        await new Promise(resolve => setTimeout(resolve, 1500));
        let updatedCase: KycAmlCase | null = null;
        if (type === 'sanctions') {
            const newResult = generateMockSanctionScreeningResult(currentCaseData.entityId);
            newResult.notes = 'Manually re-screened.';
            updatedCase = { ...currentCaseData, sanctionScreeningResults: [...currentCaseData.sanctionScreeningResults, newResult] };
        } else {
            const newResult = generateMockAdverseMediaResult(currentCaseData.entityId);
            newResult.notes = 'Manually re-screened.';
            updatedCase = { ...currentCaseData, adverseMediaResults: [...currentCaseData.adverseMediaResults, newResult] };
        }
        if (updatedCase) {
            handleCaseUpdate(updatedCase);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full border border-gray-700 h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-lg font-semibold text-white">Case Details: {currentCaseData.id} - {currentCaseData.entityName}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button>
                </div>

                <div className="flex-none border-b border-gray-700">
                    <div className="flex space-x-4 px-4 pt-2">
                        <TabButton label="Overview" active={activeTab === 'Overview'} onClick={() => setActiveTab('Overview')} />
                        <TabButton label="Documents" active={activeTab === 'Documents'} onClick={() => setActiveTab('Documents')} />
                        <TabButton label="Transactions" active={activeTab === 'Transactions'} onClick={() => setActiveTab('Transactions')} />
                        <TabButton label="Audit Log" active={activeTab === 'Audit Log'} onClick={() => setActiveTab('Audit Log')} />
                        <TabButton label="Sanctions & Media" active={activeTab === 'Sanctions & Media'} onClick={() => setActiveTab('Sanctions & Media')} />
                        <TabButton label="Notes & Comms" active={activeTab === 'Notes & Comms'} onClick={() => setActiveTab('Notes & Comms')} />
                    </div>
                </div>

                <div className="p-6 flex-grow overflow-y-auto space-y-4">
                    {activeTab === 'Overview' && (
                        <>
                            <OverviewTab
                                caseData={currentCaseData}
                                onUpdateStatus={handleUpdateStatus}
                                onAssignCase={handleAssignCase}
                                onDecision={handleDecision}
                            />
                            <Card title="AI Analyst Recommendations">
                                <div className="min-h-[6rem]">
                                    {isLoadingAi && <p className="text-sm text-gray-400">Analyzing case data with AI...</p>}
                                    {aiSummary && <p className="text-sm text-gray-300 whitespace-pre-line">{aiSummary}</p>}
                                    {!aiSummary && !isLoadingAi && <button onClick={generateSummary} className="text-sm text-cyan-400 hover:underline">Generate AI Recommendations</button>}
                                </div>
                            </Card>
                        </>
                    )}
                    {activeTab === 'Documents' && (
                        <DocumentsTab
                            caseData={currentCaseData}
                            onUploadDocument={handleUploadDocument}
                            onUpdateDocumentStatus={handleUpdateDocumentStatus}
                        />
                    )}
                    {activeTab === 'Transactions' && <TransactionsTab caseData={currentCaseData} />}
                    {activeTab === 'Audit Log' && <AuditLogTab caseData={currentCaseData} />}
                    {activeTab === 'Sanctions & Media' && <SanctionsMediaTab caseData={currentCaseData} onTriggerScreening={handleTriggerScreening} />}
                    {activeTab === 'Notes & Comms' && <NotesCommunicationTab caseData={currentCaseData} onAddComment={handleAddComment} />}
                </div>

                <div className="flex-none p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg">Close</button>
                    {/* Additional action buttons like "Escalate", "Generate Report", etc. */}
                    <button className="px-4 py-2 bg-purple-600/50 hover:bg-purple-600 text-white text-sm rounded-lg">Escalate Case</button>
                </div>
            </div>
        </div>
    );
};

export const KycAmlCaseFilterPanel: React.FC<{
    currentFilters: any;
    onFilterChange: (filters: any) => void;
    onResetFilters: () => void;
    assigneeOptions: { value: string; label: string; }[];
}> = ({ currentFilters, onFilterChange, onResetFilters, assigneeOptions }) => {
    const handleInputChange = (field: string) => (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        onFilterChange({ [field]: e.target.value });
    };

    const handleDateRangeChange = (field: 'startDate' | 'endDate') => (date: string) => {
        onFilterChange({ dateRange: { ...currentFilters.dateRange, [field === 'startDate' ? 'start' : 'end']: date } });
    };

    return (
        <Card title="Advanced Filters" className="mb-6">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <InputField
                    label="Search by ID/Name/Summary"
                    type="text"
                    value={currentFilters.search || ''}
                    onChange={handleInputChange('search')}
                    placeholder="Case ID, Entity Name..."
                />
                <Dropdown
                    label="Case Status"
                    options={[{ value: 'all', label: 'All Statuses' }, ...Object.values(CaseStatus).map(s => ({ value: s, label: s }))]}
                    selectedValue={currentFilters.status || 'all'}
                    onValueChange={(value) => onFilterChange({ status: value as CaseStatus | 'all' })}
                />
                <Dropdown
                    label="Risk Level"
                    options={[{ value: 'all', label: 'All Risks' }, ...Object.values(CaseRisk).map(r => ({ value: r, label: r }))]}
                    selectedValue={currentFilters.riskLevel || 'all'}
                    onValueChange={(value) => onFilterChange({ riskLevel: value as CaseRisk | 'all' })}
                />
                <Dropdown
                    label="Case Type"
                    options={[{ value: 'all', label: 'All Types' }, ...Object.values(CaseType).map(t => ({ value: t, label: t }))]}
                    selectedValue={currentFilters.caseType || 'all'}
                    onValueChange={(value) => onFilterChange({ caseType: value as CaseType | 'all' })}
                />
                <Dropdown
                    label="Assignee"
                    options={assigneeOptions}
                    selectedValue={currentFilters.assigneeId || 'all'}
                    onValueChange={(value) => onFilterChange({ assigneeId: value })}
                />
                <DateRangePicker
                    startDate={currentFilters.dateRange?.start || ''}
                    endDate={currentFilters.dateRange?.end || ''}
                    onStartDateChange={handleDateRangeChange('startDate')}
                    onEndDateChange={handleDateRangeChange('endDate')}
                    label="Date Opened"
                />
            </div>
            <div className="mt-6 flex justify-end gap-3 border-t border-gray-700 pt-4">
                <button onClick={onResetFilters} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg">Reset Filters</button>
                {/* <button onClick={() => applyFilters()} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg">Apply Filters</button> */}
            </div>
        </Card>
    );
};

export const KycAmlReportsView: React.FC = () => {
    const [kpiHistory, setKpiHistory] = useState<KpiSnapshot[]>([]);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const fetchHistory = async () => {
            setIsLoading(true);
            try {
                const response = await kycAmlService.fetchDashboardKPIs();
                setKpiHistory(response.history);
            } catch (error) {
                console.error("Failed to fetch KPI history:", error);
            } finally {
                setIsLoading(false);
            }
        };
        fetchHistory();
    }, []);

    const chartData = useMemo(() => {
        if (!kpiHistory.length) return { labels: [], datasets: [] };
        return {
            labels: kpiHistory.map(kpi => kpi.date.substring(5)), // Month-Day
            datasets: [
                {
                    label: 'New Cases',
                    data: kpiHistory.map(kpi => kpi.newCases),
                    borderColor: 'rgb(239, 68, 68)', // red-500
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    fill: false,
                    tension: 0.1,
                },
                {
                    label: 'Under Review',
                    data: kpiHistory.map(kpi => kpi.underReview),
                    borderColor: 'rgb(250, 204, 21)', // yellow-400
                    backgroundColor: 'rgba(250, 204, 21, 0.2)',
                    fill: false,
                    tension: 0.1,
                },
                {
                    label: 'Escalated Cases',
                    data: kpiHistory.map(kpi => kpi.escalated),
                    borderColor: 'rgb(168, 85, 247)', // purple-500
                    backgroundColor: 'rgba(168, 85, 247, 0.2)',
                    fill: false,
                    tension: 0.1,
                },
                {
                    label: 'Cleared Cases',
                    data: kpiHistory.map(kpi => kpi.cleared),
                    borderColor: 'rgb(34, 197, 94)', // green-500
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    fill: false,
                    tension: 0.1,
                }
            ],
        };
    }, [kpiHistory]);

    // This would typically use a charting library like Chart.js or Recharts.
    // For this exercise, we'll just mock a basic SVG-based representation or a simple text summary.
    const MockLineChart: React.FC<{ data: typeof chartData; title: string; }> = ({ data, title }) => (
        <Card title={title}>
            {isLoading ? (
                <p className="text-gray-400 text-sm">Loading chart data...</p>
            ) : (
                <div className="h-64 flex items-center justify-center bg-gray-900/50 rounded-md text-gray-400 text-sm">
                    <p>Mock Chart for "{title}"</p>
                    {/* In a real app, render a Chart.js Line component */}
                    <div className="absolute opacity-0">
                        {/* Hidden div to show the structure if a library was used */}
                        {JSON.stringify(data)}
                    </div>
                </div>
            )}
        </Card>
    );

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Compliance Reports & Analytics</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <MockLineChart data={chartData} title="Case Volume Trends (Last 30 Days)" />
                <Card title="Case Distribution by Risk">
                    <div className="flex flex-col gap-2">
                        {Object.values(CaseRisk).map(risk => {
                            const count = MOCK_CASES.filter(c => c.riskLevel === risk).length;
                            const total = MOCK_CASES.length;
                            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                            return (
                                <div key={risk} className="flex justify-between items-center text-sm text-gray-300">
                                    <span><RiskBadge risk={risk} /> {risk} Cases</span>
                                    <span className="font-semibold">{count} ({percentage}%)</span>
                                </div>
                            );
                        })}
                    </div>
                </Card>
                <Card title="Top Assignees (By Open Cases)">
                    <ul className="text-sm text-gray-300">
                        {MOCK_USERS.filter(u => u.id !== 'usr-unassigned')
                            .map(user => ({
                                user,
                                openCases: MOCK_CASES.filter(c => c.assigneeId === user.id && (c.status === 'New' || c.status === 'Under Review' || c.status === 'Escalated')).length,
                            }))
                            .sort((a, b) => b.openCases - a.openCases)
                            .slice(0, 5)
                            .map(item => (
                                <li key={item.user.id} className="flex justify-between py-1 border-b border-gray-700 last:border-0">
                                    <span>{item.user.name} ({item.user.role})</span>
                                    <span className="font-semibold text-cyan-400">{item.openCases}</span>
                                </li>
                            ))}
                    </ul>
                </Card>
            </div>
            <Card title="Custom Report Generator (Mock)">
                <p className="text-sm text-gray-500 mb-4">
                    This section would allow users to configure and generate custom reports based on various case parameters, date ranges, and entity attributes.
                </p>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <Dropdown
                        label="Report Type"
                        options={[{ value: 'case_summary', label: 'Case Summary Report' }, { value: 'transaction_audit', label: 'Transaction Audit Log' }, { value: 'risk_overview', label: 'Risk Overview' }]}
                        selectedValue="case_summary"
                        onValueChange={() => { }}
                    />
                    <DateRangePicker
                        startDate=""
                        endDate=""
                        onStartDateChange={() => { }}
                        onEndDateChange={() => { }}
                    />
                    <div className="self-end">
                        <button className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded-lg w-full">Generate Report</button>
                    </div>
                </div>
            </Card>
        </div>
    );
};

export const KycAmlSettingsView: React.FC = () => {
    const [settings, setSettings] = useState<DashboardSettings>(MOCK_DASHBOARD_SETTINGS);
    const [isLoading, setIsLoading] = useState(false);
    const [isSaving, setIsSaving] = useState(false);
    const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');

    useEffect(() => {
        const fetchSettings = async () => {
            setIsLoading(true);
            try {
                const fetchedSettings = await kycAmlService.fetchSettings();
                setSettings(fetchedSettings);
            } catch (error) {
                console.error("Failed to fetch settings:", error);
            } finally {
                setIsLoading(false);
            }
        };
        fetchSettings();
    }, []);

    const handleChange = (field: keyof DashboardSettings, value: any) => {
        setSettings(prev => ({ ...prev, [field]: value }));
    };

    const handleAlertThresholdChange = (field: keyof DashboardSettings['alertThresholds'], value: string) => {
        setSettings(prev => ({
            ...prev,
            alertThresholds: {
                ...prev.alertThresholds,
                [field]: Number(value),
            },
        }));
    };

    const handleSaveSettings = async () => {
        setIsSaving(true);
        setSaveStatus('idle');
        try {
            await kycAmlService.updateSettings(settings);
            setSaveStatus('success');
            setTimeout(() => setSaveStatus('idle'), 3000);
        } catch (error) {
            console.error("Failed to save settings:", error);
            setSaveStatus('error');
            setTimeout(() => setSaveStatus('idle'), 3000);
        } finally {
            setIsSaving(false);
        }
    };

    if (isLoading) {
        return <div className="text-gray-400">Loading settings...</div>;
    }

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Dashboard Settings</h2>

            <Card title="General Preferences">
                <div className="space-y-4">
                    <Dropdown
                        label="Theme"
                        options={[{ value: 'dark', label: 'Dark' }, { value: 'light', label: 'Light' }]}
                        selectedValue={settings.theme}
                        onValueChange={(value) => handleChange('theme', value as DashboardSettings['theme'])}
                    />
                    <div>
                        <label className="inline-flex items-center">
                            <input
                                type="checkbox"
                                className="form-checkbox h-5 w-5 text-cyan-600 bg-gray-700 border-gray-600 rounded"
                                checked={settings.notificationsEnabled}
                                onChange={(e) => handleChange('notificationsEnabled', e.target.checked)}
                            />
                            <span className="ml-2 text-sm text-gray-300">Enable Notifications</span>
                        </label>
                    </div>
                    <InputField
                        label="Auto Refresh Interval (seconds)"
                        type="number"
                        value={String(settings.autoRefreshInterval)}
                        onChange={(e) => handleChange('autoRefreshInterval', Number(e.target.value))}
                        className="max-w-xs"
                    />
                    <Dropdown
                        label="Default Case Filter"
                        options={[{ value: 'all', label: 'All' }, ...Object.values(CaseStatus).map(s => ({ value: s, label: s }))]}
                        selectedValue={settings.defaultCaseFilter}
                        onValueChange={(value) => handleChange('defaultCaseFilter', value as DashboardSettings['defaultCaseFilter'])}
                        className="max-w-xs"
                    />
                </div>
            </Card>

            <Card title="Alert Thresholds">
                <div className="space-y-4">
                    <InputField
                        label="New High Risk Cases (per day)"
                        type="number"
                        value={String(settings.alertThresholds.newHighRiskCases)}
                        onChange={(e) => handleAlertThresholdChange('newHighRiskCases', e.target.value)}
                        className="max-w-xs"
                    />
                    <InputField
                        label="Escalated Cases (total)"
                        type="number"
                        value={String(settings.alertThresholds.escalatedCases)}
                        onChange={(e) => handleAlertThresholdChange('escalatedCases', e.target.value)}
                        className="max-w-xs"
                    />
                </div>
            </Card>

            <div className="flex justify-end gap-3">
                {saveStatus === 'success' && <span className="text-green-500 self-center text-sm">Settings saved successfully!</span>}
                {saveStatus === 'error' && <span className="text-red-500 self-center text-sm">Error saving settings.</span>}
                <button
                    onClick={handleSaveSettings}
                    disabled={isSaving}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {isSaving ? 'Saving...' : 'Save Settings'}
                </button>
            </div>
        </div>
    );
};


// ================================================================================================
// MAIN VIEW COMPONENT
// ================================================================================================

const KycAmlView: React.FC = () => {
    const [allCases, setAllCases] = useState<KycAmlCase[]>([]); // Store all cases
    const [displayedCases, setDisplayedCases] = useState<KycAmlCase[]>([]); // Cases for current page/filters
    const [totalCases, setTotalCases] = useState(0);
    const [filters, setFilters] = useState<{
        status: CaseStatus | 'all';
        search: string;
        caseType: CaseType | 'all';
        riskLevel: CaseRisk | 'all';
        assigneeId: string | 'all';
        dateRange: { start: string; end: string; };
    }>({
        status: 'all',
        search: '',
        caseType: 'all',
        riskLevel: 'all',
        assigneeId: 'all',
        dateRange: { start: '', end: '' },
    });
    const [currentPage, setCurrentPage] = useState(1);
    const [pageSize, setPageSize] = useState(10);
    const [sortBy, setSortBy] = useState<keyof KycAmlCase>('dateOpened');
    const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
    const [selectedCase, setSelectedCase] = useState<KycAmlCase | null>(null);
    const [kpiData, setKpiData] = useState<Record<string, number | string>>({});
    const [activeDashboardTab, setActiveDashboardTab] = useState<'queue' | 'reports' | 'settings'>('queue');
    const [loadingCases, setLoadingCases] = useState(true);
    const [loadingKPIs, setLoadingKPIs] = useState(true);

    const availableAssignees = useMemo(() => {
        return [{ value: 'all', label: 'All Assignees' }, ...MOCK_USERS.map(u => ({ value: u.id, label: u.name }))];
    }, []);

    const fetchCaseData = useCallback(async () => {
        setLoadingCases(true);
        try {
            const { cases, total } = await kycAmlService.fetchCases(
                filters,
                { page: currentPage, limit: pageSize },
                { field: sortBy, direction: sortDirection }
            );
            setDisplayedCases(cases);
            setTotalCases(total);
        } catch (error) {
            console.error("Failed to fetch cases:", error);
            setDisplayedCases([]);
            setTotalCases(0);
        } finally {
            setLoadingCases(false);
        }
    }, [filters, currentPage, pageSize, sortBy, sortDirection]);

    const fetchKpiData = useCallback(async () => {
        setLoadingKPIs(true);
        try {
            const { kpis } = await kycAmlService.fetchDashboardKPIs();
            setKpiData(kpis);
        } catch (error) {
            console.error("Failed to fetch KPIs:", error);
            setKpiData({});
        } finally {
            setLoadingKPIs(false);
        }
    }, []);

    useEffect(() => {
        fetchCaseData();
    }, [fetchCaseData]);

    useEffect(() => {
        fetchKpiData();
        // Set up auto-refresh for KPIs
        const intervalId = setInterval(fetchKpiData, MOCK_DASHBOARD_SETTINGS.autoRefreshInterval * 1000);
        return () => clearInterval(intervalId);
    }, [fetchKpiData]);

    const handleFilterChange = (newFilterPartial: Partial<typeof filters>) => {
        setFilters(prev => {
            const newFilters = { ...prev, ...newFilterPartial };
            // Ensure dateRange object is merged properly, not overwritten completely
            if (newFilterPartial.dateRange) {
                newFilters.dateRange = { ...prev.dateRange, ...newFilterPartial.dateRange };
            }
            return newFilters;
        });
        setCurrentPage(1); // Reset to first page on filter change
    };

    const handleResetFilters = () => {
        setFilters({
            status: 'all',
            search: '',
            caseType: 'all',
            riskLevel: 'all',
            assigneeId: 'all',
            dateRange: { start: '', end: '' },
        });
        setCurrentPage(1);
        setSortBy('dateOpened');
        setSortDirection('desc');
    };

    const handleCaseUpdated = (updatedCase: KycAmlCase) => {
        // Update the case in the displayed list and the overall mock data
        setDisplayedCases(prev => prev.map(c => (c.id === updatedCase.id ? updatedCase : c)));
        // Also update MOCK_CASES to reflect the change for other components/future fetches
        const indexInAllCases = MOCK_CASES.findIndex(c => c.id === updatedCase.id);
        if (indexInAllCases !== -1) {
            MOCK_CASES[indexInAllCases] = updatedCase;
        }
        if (selectedCase && selectedCase.id === updatedCase.id) {
            setSelectedCase(updatedCase); // Update the modal's state if it's open
        }
        fetchKpiData(); // KPIs might change with status updates
    };

    const totalPages = Math.ceil(totalCases / pageSize);

    const getKpiValue = (key: string, defaultValue: string | number = '-') =>
        loadingKPIs ? '...' : kpiData[key] !== undefined ? kpiData[key] : defaultValue;


    return (
        <>
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h2 className="text-3xl font-bold text-white tracking-wider">KYC/AML Compliance Dashboard</h2>
                    <div className="flex space-x-2 p-1 bg-gray-900/50 rounded-lg">
                        <TabButton label="Case Queue" active={activeDashboardTab === 'queue'} onClick={() => setActiveDashboardTab('queue')} />
                        <TabButton label="Reports" active={activeDashboardTab === 'reports'} onClick={() => setActiveDashboardTab('reports')} />
                        <TabButton label="Settings" active={activeDashboardTab === 'settings'} onClick={() => setActiveDashboardTab('settings')} />
                    </div>
                </div>

                {activeDashboardTab === 'queue' && (
                    <>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                            <Card className="text-center"><p className="text-3xl font-bold text-red-400">{getKpiValue('newCases', 0)}</p><p className="text-sm text-gray-400 mt-1">New Cases</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-yellow-400">{getKpiValue('underReview', 0)}</p><p className="text-sm text-gray-400 mt-1">Under Review</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-purple-400">{getKpiValue('escalated', 0)}</p><p className="text-sm text-gray-400 mt-1">Escalated</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-orange-400">{getKpiValue('highRiskCases', 0)}</p><p className="text-sm text-gray-400 mt-1">High Risk Cases</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-white">{getKpiValue('avgResolutionTime', 'N/A')}</p><p className="text-sm text-gray-400 mt-1">Avg. Resolution Time</p></Card>
                        </div>

                        <KycAmlCaseFilterPanel
                            currentFilters={filters}
                            onFilterChange={handleFilterChange}
                            onResetFilters={handleResetFilters}
                            assigneeOptions={availableAssignees}
                        />

                        <Card>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-semibold text-white">Case Review Queue</h3>
                                <div className="flex space-x-1 p-1 bg-gray-900/50 rounded-lg">
                                    {(['all', 'New', 'Under Review', 'Cleared', 'Escalated', 'Pending Docs', 'Awaiting Approval', 'Closed'] as const).map(status => (
                                        <button key={status} onClick={() => handleFilterChange({ status })} className={`px-3 py-1 text-sm rounded-md ${filters.status === status ? 'bg-cyan-600' : 'text-gray-300'}`}>{status}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-400">
                                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                        <tr>
                                            {([
                                                { key: 'id', label: 'Case ID' },
                                                { key: 'entityName', label: 'Entity' },
                                                { key: 'caseType', label: 'Case Type' },
                                                { key: 'riskLevel', label: 'Risk Level' },
                                                { key: 'status', label: 'Status' },
                                                { key: 'assigneeName', label: 'Assignee' },
                                                { key: 'dateOpened', label: 'Opened' },
                                            ] as const).map(col => (
                                                <th
                                                    key={col.key}
                                                    className="px-6 py-3 cursor-pointer select-none"
                                                    onClick={() => {
                                                        if (sortBy === col.key) {
                                                            setSortDirection(prev => (prev === 'asc' ? 'desc' : 'asc'));
                                                        } else {
                                                            setSortBy(col.key);
                                                            setSortDirection('desc');
                                                        }
                                                    }}
                                                >
                                                    {col.label}
                                                    {sortBy === col.key && (
                                                        <span className="ml-1">
                                                            {sortDirection === 'asc' ? '▲' : '▼'}
                                                        </span>
                                                    )}
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {loadingCases ? (
                                            <tr><td colSpan={7} className="px-6 py-4 text-center text-gray-500">Loading cases...</td></tr>
                                        ) : displayedCases.length === 0 ? (
                                            <tr><td colSpan={7} className="px-6 py-4 text-center text-gray-500">No cases found matching your criteria.</td></tr>
                                        ) : (
                                            displayedCases.map(c => (
                                                <tr key={c.id} onClick={() => setSelectedCase(c)} className="border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer">
                                                    <td className="px-6 py-4 font-mono text-white">{c.id}</td>
                                                    <td className="px-6 py-4">{c.entityName}</td>
                                                    <td className="px-6 py-4">{c.caseType}</td>
                                                    <td className="px-6 py-4"><RiskBadge risk={c.riskLevel} /></td>
                                                    <td className="px-6 py-4"><StatusBadge status={c.status} /></td>
                                                    <td className="px-6 py-4">{c.assigneeName}</td>
                                                    <td className="px-6 py-4">{c.dateOpened}</td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <PaginationControls
                                currentPage={currentPage}
                                totalPages={totalPages}
                                onPageChange={setCurrentPage}
                                pageSize={pageSize}
                                onPageSizeChange={setPageSize}
                                totalItems={totalCases}
                            />
                        </Card>
                    </>
                )}

                {activeDashboardTab === 'reports' && <KycAmlReportsView />}
                {activeDashboardTab === 'settings' && <KycAmlSettingsView />}
            </div>
            <CaseDetailModal caseData={selectedCase} onClose={() => setSelectedCase(null)} onCaseUpdated={handleCaseUpdated} />
        </>
    );
};

export default KycAmlView;

--- FILE: SupportDeskView.tsx ---

import React, { useState, useMemo, useCallback, useEffect, createContext, useContext } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// ================================================================================================
// GLOBAL UTILITIES & CONTEXTS (New section to support enterprise features)
// ================================================================================================

// Mock API Call Utility
export const mockApiCall = <T,>(data: T, delay: number = 500): Promise<T> => {
    return new Promise(resolve => setTimeout(() => resolve(data), delay));
};

// Date Formatting Utility
export const formatDate = (dateString: string | Date, options?: Intl.DateTimeFormatOptions): string => {
    const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
    return new Intl.DateTimeFormat('en-US', options || { dateStyle: 'medium', timeStyle: 'short' }).format(date);
};

// Simple UUID Generator (for mock data)
export const generateUUID = (): string => {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
};

// Notification Context for global alerts/messages
interface Notification {
    id: string;
    message: string;
    type: 'success' | 'error' | 'info' | 'warning';
    duration?: number;
}

interface NotificationContextType {
    addNotification: (message: string, type?: Notification['type'], duration?: number) => void;
    removeNotification: (id: string) => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [notifications, setNotifications] = useState<Notification[]>([]);

    const addNotification = useCallback((message: string, type: Notification['type'] = 'info', duration: number = 3000) => {
        const id = generateUUID();
        const newNotification = { id, message, type, duration };
        setNotifications((prev) => [...prev, newNotification]);

        if (duration > 0) {
            setTimeout(() => {
                removeNotification(id);
            }, duration);
        }
    }, []);

    const removeNotification = useCallback((id: string) => {
        setNotifications((prev) => prev.filter((n) => n.id !== id));
    }, []);

    const notificationColors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500',
    };

    return (
        <NotificationContext.Provider value={{ addNotification, removeNotification }}>
            {children}
            <div className="fixed bottom-4 right-4 z-[100] space-y-2">
                {notifications.map((n) => (
                    <div
                        key={n.id}
                        className={`${notificationColors[n.type]} text-white px-4 py-2 rounded-lg shadow-lg flex items-center justify-between min-w-[250px]`}
                        role="alert"
                    >
                        <span>{n.message}</span>
                        <button onClick={() => removeNotification(n.id)} className="ml-4 text-white hover:text-gray-200">
                            &times;
                        </button>
                    </div>
                ))}
            </div>
        </NotificationContext.Provider>
    );
};

export const useNotifications = () => {
    const context = useContext(NotificationContext);
    if (!context) {
        throw new Error('useNotifications must be used within a NotificationProvider');
    }
    return context;
};

// Mock Auth Context (for agent roles, permissions)
type UserRole = 'Admin' | 'Agent' | 'Manager';
interface AuthContextType {
    currentUser: { id: string; name: string; email: string; role: UserRole; };
    isAuthenticated: boolean;
    login: (username: string, password: string) => void;
    logout: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [currentUser, setCurrentUser] = useState<{ id: string; name: string; email: string; role: UserRole; } | null>(null);
    const [isAuthenticated, setIsAuthenticated] = useState(false);

    useEffect(() => {
        // Mock auto-login for demonstration
        setCurrentUser({ id: 'agent_007', name: 'James Bond', email: 'jbond@demobank.com', role: 'Agent' });
        setIsAuthenticated(true);
    }, []);

    const login = useCallback(async (username: string, password: string) => {
        // Mock authentication
        if (username === 'agent' && password === 'password') {
            await mockApiCall({}, 500); // Simulate network delay
            setCurrentUser({ id: 'agent_007', name: 'James Bond', email: 'jbond@demobank.com', role: 'Agent' });
            setIsAuthenticated(true);
            return true;
        }
        return false;
    }, []);

    const logout = useCallback(() => {
        setCurrentUser(null);
        setIsAuthenticated(false);
    }, []);

    const value = useMemo(() => ({ currentUser, isAuthenticated, login, logout }), [currentUser, isAuthenticated, login, logout]);

    return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
};

// ================================================================================================
// TYPE DEFINITIONS & MOCK DATA EXPANSION
// ================================================================================================

type TicketStatus = 'Open' | 'Pending' | 'Resolved' | 'Closed' | 'On-Hold' | 'Reopened';
type TicketPriority = 'Low' | 'Medium' | 'High' | 'Urgent';
type TicketCategory = 'Billing' | 'Technical' | 'Account' | 'Feature Request' | 'General Inquiry' | 'Fraud';
type CommunicationChannel = 'Email' | 'Chat' | 'Phone' | 'Social Media';
type AttachmentType = 'image' | 'document' | 'other';
type Sentiment = 'Positive' | 'Neutral' | 'Negative' | 'Mixed';

interface Agent {
    id: string;
    name: string;
    email: string;
    role: UserRole;
    status: 'Online' | 'Offline' | 'Busy';
    team: string;
    avatarUrl: string;
    lastActive: string;
}

interface Customer {
    id: string;
    name: string;
    email: string;
    phone: string;
    registrationDate: string;
    lastLogin: string;
    totalTickets: number;
    openTickets: number;
    status: 'Active' | 'Inactive' | 'VIP';
    notes: string[];
    associatedAccounts?: string[]; // e.g., corporate accounts
}

interface TicketMessage {
    id: string;
    senderId: string; // user or agent id
    senderName: string;
    timestamp: string;
    content: string;
    isInternal: boolean; // true if agent note, false if customer/public reply
    attachments?: Attachment[];
}

interface Attachment {
    id: string;
    filename: string;
    url: string;
    type: AttachmentType;
    uploadedBy: string;
    uploadDate: string;
    sizeKB: number;
}

interface SLA {
    id: string;
    name: string;
    priority: TicketPriority;
    firstResponseTimeHours: number;
    resolutionTimeHours: number;
    breached: boolean;
    timeRemainingFirstResponse: string; // e.g., '2h 30m'
    timeRemainingResolution: string;
    status: 'Met' | 'Breached' | 'Warning';
}

interface SupportTicket {
    id: string;
    subject: string;
    userId: string;
    userName: string; // Denormalized for quick access
    status: TicketStatus;
    priority: TicketPriority;
    category: TicketCategory;
    assignedAgentId: string | null;
    assignedAgentName: string | null; // Denormalized
    lastUpdate: string;
    createdDate: string;
    description: string;
    messages: TicketMessage[];
    attachments: Attachment[];
    internalNotes: TicketMessage[]; // Separate for internal comms
    sla: SLA;
    tags: string[];
    sentiment?: Sentiment;
    channel: CommunicationChannel;
    linkedTickets?: string[]; // IDs of related tickets
    customFields?: { [key: string]: string };
}

interface CannedResponse {
    id: string;
    title: string;
    content: string;
    category: string;
    keywords: string[];
    createdBy: string;
    lastModified: string;
}

interface SLARule {
    id: string;
    name: string;
    conditions: { field: keyof SupportTicket; operator: 'equals' | 'contains' | 'greaterThan' | 'lessThan'; value: string | number | boolean; }[];
    firstResponseTimeHours: number;
    resolutionTimeHours: number;
    priority: TicketPriority;
    isActive: boolean;
    description?: string;
}

// ================================================================================================
// MOCK DATA GENERATION UTILITIES
// ================================================================================================

const getRandom = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)];
const getRandomInt = (min: number, max: number): number => Math.floor(Math.random() * (max - min + 1)) + min;
const getRandomDate = (start: Date, end: Date): Date => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));

const generateMockTicket = (index: number): SupportTicket => {
    const statuses: TicketStatus[] = ['Open', 'Pending', 'Resolved', 'Closed', 'On-Hold', 'Reopened'];
    const priorities: TicketPriority[] = ['Low', 'Medium', 'High', 'Urgent'];
    const categories: TicketCategory[] = ['Billing', 'Technical', 'Account', 'Feature Request', 'General Inquiry', 'Fraud'];
    const channels: CommunicationChannel[] = ['Email', 'Chat', 'Phone', 'Social Media'];
    const agents: Agent[] = MOCK_AGENTS;
    const customers: Customer[] = MOCK_CUSTOMERS;

    const customer = getRandom(customers);
    const status = getRandom(statuses);
    const priority = getRandom(priorities);
    const agent = status === 'Open' || status === 'Reopened' ? null : getRandom(agents);
    const createdDate = getRandomDate(new Date(2023, 0, 1), new Date());
    const lastUpdate = getRandomDate(createdDate, new Date());

    const slaStatus: SLA['status'] = getRandom(['Met', 'Breached', 'Warning']);
    const firstResponseTime = getRandomInt(1, 48);
    const resolutionTime = getRandomInt(2, 72);
    const breached = slaStatus === 'Breached';
    const timeRemainingFirstResponse = breached ? 'Breached' : `${getRandomInt(1, 24)}h ${getRandomInt(0, 59)}m`;
    const timeRemainingResolution = breached ? 'Breached' : `${getRandomInt(1, 72)}h ${getRandomInt(0, 59)}m`;

    const descriptionContent = [
        "I can't log into my account. I've tried resetting my password multiple times, but it says my email isn't recognized.",
        "My recent transaction for $150 was debited twice. Please investigate and reverse the duplicate charge.",
        "The mobile app is crashing whenever I try to access my statements. I'm using an iPhone 14 Pro, iOS 17.2.",
        "I need to update my personal information, specifically my mailing address. How can I do this securely?",
        "There's a strange charge on my credit card for an unknown merchant. I suspect it might be fraudulent.",
        "When will the new dark mode feature be released for the web interface? I'm excited about it!",
        "I received an email stating my account was locked, but I didn't try to log in. Is my account secure?",
        "I want to close my account. What is the procedure for this?",
        "My direct deposit didn't show up this week. It usually arrives on Thursdays.",
        "I'm experiencing issues with linking my external bank account. It gives an error 'Connection Failed'."
    ];

    const messages: TicketMessage[] = [
        {
            id: generateUUID(), senderId: customer.id, senderName: customer.name, timestamp: createdDate.toISOString(),
            content: `Initial query: ${getRandom(descriptionContent)}`, isInternal: false
        },
    ];

    if (agent && status !== 'Open') {
        const agentReplyDate = new Date(createdDate.getTime() + getRandomInt(1, 12) * 3600 * 1000); // 1 to 12 hours later
        messages.push({
            id: generateUUID(), senderId: agent.id, senderName: agent.name, timestamp: agentReplyDate.toISOString(),
            content: `Thank you for reaching out. We are looking into this for you. Your ticket ID is ${index}.`, isInternal: false
        });
    }

    const sentiments: Sentiment[] = ['Positive', 'Neutral', 'Negative', 'Mixed'];

    return {
        id: `TKT-${String(100 + index).padStart(3, '0')}`,
        subject: `Issue with ${getRandom(categories)}: ${getRandom(descriptionContent).substring(0, 40)}...`,
        userId: customer.id,
        userName: customer.name,
        status: status,
        priority: priority,
        category: getRandom(categories),
        assignedAgentId: agent?.id || null,
        assignedAgentName: agent?.name || null,
        lastUpdate: lastUpdate.toISOString(),
        createdDate: createdDate.toISOString(),
        description: getRandom(descriptionContent),
        messages: messages,
        attachments: [],
        internalNotes: [],
        sla: {
            id: generateUUID(),
            name: `${priority} Priority SLA`,
            priority: priority,
            firstResponseTimeHours: firstResponseTime,
            resolutionTimeHours: resolutionTime,
            breached: breached,
            timeRemainingFirstResponse: timeRemainingFirstResponse,
            timeRemainingResolution: timeRemainingResolution,
            status: slaStatus,
        },
        tags: [getRandom(['billing', 'urgent', 'bug', 'feature']), getRandom(['mobile', 'web', 'api'])],
        sentiment: getRandom(sentiments),
        channel: getRandom(channels),
        linkedTickets: index % 5 === 0 ? [`TKT-${String(100 + (index - 1 > 0 ? index - 1 : index + 1)).padStart(3, '0')}`] : [],
        customFields: {
            'Account Type': getRandom(['Personal', 'Business']),
            'Device OS': getRandom(['iOS', 'Android', 'Windows', 'MacOS', 'Linux']),
        }
    };
};

export const MOCK_AGENTS: Agent[] = [
    { id: 'agent_001', name: 'Alice Smith', email: 'alice.s@demobank.com', role: 'Agent', status: 'Online', team: 'Level 1 Support', avatarUrl: 'https://i.pravatar.cc/40?img=1', lastActive: '2m ago' },
    { id: 'agent_002', name: 'Bob Johnson', email: 'bob.j@demobank.com', role: 'Agent', status: 'Busy', team: 'Level 1 Support', avatarUrl: 'https://i.pravatar.cc/40?img=2', lastActive: '15m ago' },
    { id: 'agent_003', name: 'Charlie Brown', email: 'charlie.b@demobank.com', role: 'Agent', status: 'Offline', team: 'Technical Support', avatarUrl: 'https://i.pravatar.cc/40?img=3', lastActive: '2h ago' },
    { id: 'agent_004', name: 'Diana Prince', email: 'diana.p@demobank.com', role: 'Manager', status: 'Online', team: 'Management', avatarUrl: 'https://i.pravatar.cc/40?img=4', lastActive: '5m ago' },
    { id: 'agent_005', name: 'Eve Adams', email: 'eve.a@demobank.com', role: 'Agent', status: 'Online', team: 'Billing & Fraud', avatarUrl: 'https://i.pravatar.cc/40?img=5', lastActive: '1m ago' },
    { id: 'agent_006', name: 'Frank White', email: 'frank.w@demobank.com', role: 'Agent', status: 'Offline', team: 'Technical Support', avatarUrl: 'https://i.pravatar.cc/40?img=6', lastActive: '1d ago' },
    { id: 'agent_007', name: 'James Bond', email: 'jbond@demobank.com', role: 'Agent', status: 'Online', team: 'VIP Support', avatarUrl: 'https://i.pravatar.cc/40?img=7', lastActive: '0m ago' },
];

export const MOCK_CUSTOMERS: Customer[] = [
    { id: 'user123', name: 'John Doe', email: 'john.doe@example.com', phone: '555-1234', registrationDate: '2022-01-15', lastLogin: '2024-07-20', totalTickets: 5, openTickets: 1, status: 'Active', notes: ['VIP customer, quick resolution needed.'] },
    { id: 'user456', name: 'Jane Smith', email: 'jane.s@example.com', phone: '555-5678', registrationDate: '2023-03-01', lastLogin: '2024-07-18', totalTickets: 2, openTickets: 0, status: 'Active', notes: [] },
    { id: 'corp_user_1', name: 'ACME Corp.', email: 'support@acme.com', phone: '555-9000', registrationDate: '2021-11-20', lastLogin: '2024-07-20', totalTickets: 12, openTickets: 3, status: 'VIP', notes: ['Key business partner.', 'Requires dedicated agent.'] },
    { id: 'user789', name: 'Robert Paulson', email: 'rob.p@example.com', phone: '555-1122', registrationDate: '2024-01-01', lastLogin: '2024-07-19', totalTickets: 1, openTickets: 1, status: 'Active', notes: [] },
    { id: 'corp_user_2', name: 'Globex Inc.', email: 'admin@globex.net', phone: '555-3344', registrationDate: '2022-06-01', lastLogin: '2024-07-17', totalTickets: 8, openTickets: 0, status: 'Active', notes: [] },
    { id: 'user_999', name: 'Alice Wonderland', email: 'alice.w@example.com', phone: '555-8888', registrationDate: '2023-10-10', lastLogin: '2024-07-20', totalTickets: 3, openTickets: 2, status: 'Active', notes: [] },
];

export const MOCK_CANNED_RESPONSES: CannedResponse[] = [
    { id: 'CR-001', title: 'Welcome & Thanks', content: 'Thank you for contacting Demo Bank Support! We have received your request and will get back to you shortly.', category: 'General', keywords: ['welcome', 'thanks', 'received'], createdBy: 'admin', lastModified: '2023-01-01' },
    { id: 'CR-002', title: 'Password Reset', content: 'To reset your password, please visit our password reset page at [LINK_TO_RESET_PAGE] or use the "Forgot Password" link on the login screen. Ensure you use a strong, unique password.', category: 'Account', keywords: ['password', 'reset', 'login'], createdBy: 'admin', lastModified: '2023-03-15' },
    { id: 'CR-003', title: 'Missing Transaction', content: 'We apologize for the inconvenience. Please provide the transaction ID, date, amount, and recipient\'s details so we can investigate further.', category: 'Billing', keywords: ['transaction', 'missing', 'charge'], createdBy: 'admin', lastModified: '2023-06-20' },
    { id: 'CR-004', title: 'Troubleshooting App Crash', content: 'Please try the following steps to resolve the app crashing issue: 1. Ensure your app is updated to the latest version. 2. Clear your app cache. 3. Reinstall the application. If the issue persists, please provide your device model and OS version.', category: 'Technical', keywords: ['app', 'crash', 'troubleshoot'], createdBy: 'admin', lastModified: '2023-09-10' },
    { id: 'CR-005', title: 'Fraudulent Activity Report', content: 'We take fraudulent activity very seriously. Please confirm if you have already reported this to your bank. We will initiate an investigation on our end. For immediate security, please change your password and review recent account activity.', category: 'Fraud', keywords: ['fraud', 'security', 'report'], createdBy: 'agent_004', lastModified: '2024-01-05' },
];

export const MOCK_SLA_RULES: SLARule[] = [
    {
        id: 'SLA-001', name: 'Urgent Priority SLA',
        conditions: [{ field: 'priority', operator: 'equals', value: 'Urgent' }],
        firstResponseTimeHours: 1, resolutionTimeHours: 4, priority: 'Urgent', isActive: true,
        description: 'All urgent tickets must be responded to within 1 hour and resolved within 4 hours.'
    },
    {
        id: 'SLA-002', name: 'High Priority SLA',
        conditions: [{ field: 'priority', operator: 'equals', value: 'High' }],
        firstResponseTimeHours: 2, resolutionTimeHours: 8, priority: 'High', isActive: true,
        description: 'High priority tickets must be responded to within 2 hours and resolved within 8 hours.'
    },
    {
        id: 'SLA-003', name: 'Billing Category SLA',
        conditions: [{ field: 'category', operator: 'equals', value: 'Billing' }],
        firstResponseTimeHours: 4, resolutionTimeHours: 24, priority: 'Medium', isActive: true,
        description: 'Billing related tickets have a slightly relaxed response time.'
    },
];

const NUM_MOCK_TICKETS = 150; // Significantly increased
export const MOCK_ALL_TICKETS: SupportTicket[] = Array.from({ length: NUM_MOCK_TICKETS }, (_, i) => generateMockTicket(i + 1));

// ================================================================================================
// SUB-COMPONENTS
// ================================================================================================

// Re-export existing PriorityBadge
export const PriorityBadge: React.FC<{ priority: TicketPriority }> = ({ priority }) => {
    const colors = {
        'Low': 'bg-gray-500/20 text-gray-300', 'Medium': 'bg-cyan-500/20 text-cyan-300',
        'High': 'bg-yellow-500/20 text-yellow-300', 'Urgent': 'bg-red-500/20 text-red-300',
    };
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[priority]}`}>{priority}</span>;
};

// New: Status Badge
export const StatusBadge: React.FC<{ status: TicketStatus }> = ({ status }) => {
    const colors = {
        'Open': 'bg-blue-500/20 text-blue-300', 'Pending': 'bg-yellow-500/20 text-yellow-300',
        'Resolved': 'bg-green-500/20 text-green-300', 'Closed': 'bg-gray-500/20 text-gray-300',
        'On-Hold': 'bg-purple-500/20 text-purple-300', 'Reopened': 'bg-orange-500/20 text-orange-300',
    };
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[status]}`}>{status}</span>;
};

// New: Agent Selector
export const AgentSelector: React.FC<{
    selectedAgentId: string | null;
    onSelectAgent: (agentId: string | null) => void;
    agents: Agent[];
}> = ({ selectedAgentId, onSelectAgent, agents }) => {
    return (
        <select
            value={selectedAgentId || ''}
            onChange={(e) => onSelectAgent(e.target.value === '' ? null : e.target.value)}
            className="p-2 text-sm bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
        >
            <option value="">Unassigned</option>
            {agents.map(agent => (
                <option key={agent.id} value={agent.id}>{agent.name} ({agent.status})</option>
            ))}
        </select>
    );
};

// New: Ticket History / Messages Display
export const TicketMessagesDisplay: React.FC<{ messages: TicketMessage[]; agents: Agent[]; customers: Customer[]; }> = ({ messages, agents, customers }) => {
    const getSenderInfo = (senderId: string) => {
        const agent = agents.find(a => a.id === senderId);
        if (agent) return { name: agent.name, role: 'Agent', avatar: agent.avatarUrl, color: 'text-cyan-400' };
        const customer = customers.find(c => c.id === senderId);
        if (customer) return { name: customer.name, role: 'Customer', avatar: 'https://i.pravatar.cc/40?img=customer', color: 'text-yellow-400' };
        return { name: 'System', role: 'System', avatar: 'https://i.pravatar.cc/40?img=system', color: 'text-gray-400' };
    };

    return (
        <div className="space-y-4 max-h-80 overflow-y-auto pr-2 custom-scrollbar">
            {messages.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()).map(msg => {
                const sender = getSenderInfo(msg.senderId);
                return (
                    <div key={msg.id} className={`p-3 rounded-lg ${msg.isInternal ? 'bg-gray-900 border-l-4 border-gray-600' : 'bg-gray-700/50'}`}>
                        <div className="flex items-center mb-1">
                            <img src={sender.avatar} alt={sender.name} className="w-8 h-8 rounded-full mr-2" />
                            <strong className={`${sender.color} text-sm`}>{sender.name}</strong>
                            <span className="text-xs text-gray-500 ml-2">({sender.role})</span>
                            <span className="text-xs text-gray-500 ml-auto">{formatDate(msg.timestamp)}</span>
                        </div>
                        <p className="text-sm text-gray-300 ml-10">{msg.content}</p>
                        {msg.attachments && msg.attachments.length > 0 && (
                            <div className="ml-10 mt-2 text-xs text-gray-400">
                                Attachments: {msg.attachments.map(att => (
                                    <a key={att.id} href={att.url} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline mr-2">{att.filename}</a>
                                ))}
                            </div>
                        )}
                    </div>
                );
            })}
        </div>
    );
};

// New: Attachments Viewer/Uploader (simplified)
export const AttachmentsSection: React.FC<{ attachments: Attachment[]; onUpload?: (files: FileList) => void; onDelete?: (id: string) => void; editable?: boolean; }> = ({ attachments, onUpload, onDelete, editable = false }) => {
    const { addNotification } = useNotifications();
    const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && onUpload) {
            addNotification(`Uploading ${e.target.files.length} files...`, 'info');
            onUpload(e.target.files);
            e.target.value = ''; // Clear input
        }
    };

    return (
        <Card title="Attachments">
            <div className="space-y-2">
                {attachments.length === 0 ? (
                    <p className="text-sm text-gray-400">No attachments.</p>
                ) : (
                    attachments.map(att => (
                        <div key={att.id} className="flex items-center justify-between bg-gray-800/50 p-2 rounded-md text-sm">
                            <a href={att.url} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">
                                {att.filename} ({att.sizeKB}KB)
                            </a>
                            {editable && onDelete && (
                                <button onClick={() => onDelete(att.id)} className="ml-4 text-red-400 hover:text-red-500">
                                    &times;
                                </button>
                            )}
                        </div>
                    ))
                )}
            </div>
            {editable && onUpload && (
                <div className="mt-4 border-t border-gray-700 pt-4">
                    <label className="block text-sm font-medium text-gray-300 mb-2">Upload new attachments:</label>
                    <input
                        type="file"
                        multiple
                        onChange={handleFileUpload}
                        className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100"
                    />
                </div>
            )}
        </Card>
    );
};

// New: Customer Details Card
export const CustomerDetailCard: React.FC<{ customer: Customer; }> = ({ customer }) => {
    return (
        <Card title="Customer Details">
            <div className="space-y-2 text-sm text-gray-300">
                <p><strong>Name:</strong> {customer.name}</p>
                <p><strong>Email:</strong> {customer.email}</p>
                <p><strong>Phone:</strong> {customer.phone}</p>
                <p><strong>Status:</strong> <span className={`font-semibold ${customer.status === 'VIP' ? 'text-yellow-400' : 'text-gray-300'}`}>{customer.status}</span></p>
                <p><strong>Total Tickets:</strong> {customer.totalTickets}</p>
                <p><strong>Open Tickets:</strong> {customer.openTickets}</p>
                <p><strong>Registration Date:</strong> {formatDate(customer.registrationDate, { dateStyle: 'medium' })}</p>
                {customer.notes.length > 0 && (
                    <div>
                        <p className="font-semibold text-gray-400">Notes:</p>
                        <ul className="list-disc list-inside ml-2 text-xs">
                            {customer.notes.map((note, i) => <li key={i}>{note}</li>)}
                        </ul>
                    </div>
                )}
                {customer.associatedAccounts && customer.associatedAccounts.length > 0 && (
                    <div>
                        <p className="font-semibold text-gray-400">Associated Accounts:</p>
                        <ul className="list-disc list-inside ml-2 text-xs">
                            {customer.associatedAccounts.map((account, i) => <li key={i}>{account}</li>)}
                        </ul>
                    </div>
                )}
            </div>
        </Card>
    );
};

// New: SLA Tracker Card
export const SLATrackerCard: React.FC<{ sla: SLA; }> = ({ sla }) => {
    const getSLAStatusClass = (status: SLA['status']) => {
        switch (status) {
            case 'Met': return 'text-green-400 bg-green-500/10';
            case 'Breached': return 'text-red-400 bg-red-500/10';
            case 'Warning': return 'text-yellow-400 bg-yellow-500/10';
            default: return 'text-gray-400 bg-gray-500/10';
        }
    };

    return (
        <Card title="SLA Status">
            <div className="space-y-3 text-sm">
                <p className="text-gray-300"><strong>Policy:</strong> {sla.name}</p>
                <p className="text-gray-300"><strong>Priority:</strong> <PriorityBadge priority={sla.priority} /></p>
                <p className="text-gray-300"><strong>First Response Target:</strong> {sla.firstResponseTimeHours} hours</p>
                <p className="text-gray-300"><strong>Resolution Target:</strong> {sla.resolutionTimeHours} hours</p>
                <div className={`p-2 rounded-md ${getSLAStatusClass(sla.status)} flex items-center justify-between`}>
                    <span className="font-semibold">Overall Status:</span>
                    <span className="font-bold">{sla.status} {sla.breached && '(Breached)'}</span>
                </div>
                {sla.status !== 'Breached' && (
                    <div className="text-xs text-gray-400">
                        <p>Time for First Response: <strong className="text-white">{sla.timeRemainingFirstResponse}</strong></p>
                        <p>Time for Resolution: <strong className="text-white">{sla.timeRemainingResolution}</strong></p>
                    </div>
                )}
            </div>
        </Card>
    );
};

// Expanded TicketDetailModal
export const TicketDetailModal: React.FC<{ ticket: SupportTicket | null; onClose: () => void; onUpdateTicket: (updatedTicket: SupportTicket) => void; }> = (
    { ticket, onClose, onUpdateTicket }
) => {
    const [suggestedReply, setSuggestedReply] = useState('');
    const [isLoadingAI, setIsLoadingAI] = useState(false);
    const [currentReply, setCurrentReply] = useState('');
    const [newInternalNote, setNewInternalNote] = useState('');
    const [isSendingReply, setIsSendingReply] = useState(false);
    const [tempAttachments, setTempAttachments] = useState<File[]>([]);
    const [selectedCannedResponse, setSelectedCannedResponse] = useState<string>('');

    const { addNotification } = useNotifications();
    const { currentUser } = useAuth();

    // Find full customer and agent details
    const customer = useMemo(() => MOCK_CUSTOMERS.find(c => c.id === ticket?.userId), [ticket]);
    const agents = MOCK_AGENTS; // All available agents for assignment

    useEffect(() => {
        if (!ticket) {
            setSuggestedReply('');
            setCurrentReply('');
            setNewInternalNote('');
            setSelectedCannedResponse('');
            setTempAttachments([]);
        } else {
            setCurrentReply(`Hi ${customer?.name || 'there'}, \n\n`);
        }
    }, [ticket, customer]);

    if (!ticket) return null;

    const generateReply = async () => {
        setIsLoadingAI(true);
        setSuggestedReply('');
        try {
            if (!process.env.NEXT_PUBLIC_API_KEY_GOOGLE_GENAI) { // Corrected env variable name
                throw new Error("Google GenAI API Key is not configured.");
            }
            const ai = new GoogleGenAI({ apiKey: process.env.NEXT_PUBLIC_API_KEY_GOOGLE_GENAI as string });
            const model = ai.getGenerativeModel({ model: 'gemini-1.5-flash-latest' }); // Using a more recent model
            const chat = model.startChat({
                history: ticket.messages.filter(m => !m.isInternal).map(m => ({
                    role: m.senderId === ticket.userId ? 'user' : 'model',
                    parts: [{ text: m.content }]
                }))
            });

            const prompt = `Based on the conversation and the last user message, act as an empathetic and professional customer support agent for Demo Bank. Generate a concise, helpful, and actionable reply. Keep it to 3-5 sentences. Start with a greeting to the customer. The ticket subject is "${ticket.subject}". The current status is "${ticket.status}". The customer's initial description was: "${ticket.description}".`;
            const result = await chat.sendMessage(prompt);
            const responseText = result.response.text();
            setSuggestedReply(responseText);
            addNotification('AI suggested reply generated!', 'success');
        } catch (err: any) {
            console.error("Error generating AI reply:", err);
            setSuggestedReply(`Error generating AI reply: ${err.message || 'Please check API key or network.'}`);
            addNotification(`Failed to generate AI reply: ${err.message || 'Unknown error'}`, 'error');
        } finally {
            setIsLoadingAI(false);
        }
    };

    const handleCannedResponseSelect = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const selectedId = e.target.value;
        setSelectedCannedResponse(selectedId);
        if (selectedId) {
            const cr = MOCK_CANNED_RESPONSES.find(r => r.id === selectedId);
            if (cr) {
                setCurrentReply(prev => (prev.endsWith('\n\n') ? prev : prev + '\n\n') + cr.content + '\n\n');
            }
        }
    };

    const handleReplyChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        setCurrentReply(e.target.value);
    };

    const handleInternalNoteChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        setNewInternalNote(e.target.value);
    };

    const handleStatusChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const newStatus = e.target.value as TicketStatus;
        onUpdateTicket({ ...ticket, status: newStatus });
        addNotification(`Ticket status updated to ${newStatus}.`, 'info');
    };

    const handlePriorityChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const newPriority = e.target.value as TicketPriority;
        onUpdateTicket({ ...ticket, priority: newPriority });
        addNotification(`Ticket priority updated to ${newPriority}.`, 'info');
    };

    const handleAgentAssign = (agentId: string | null) => {
        const agent = agents.find(a => a.id === agentId);
        onUpdateTicket({ ...ticket, assignedAgentId: agentId, assignedAgentName: agent?.name || null });
        addNotification(`Ticket assigned to ${agent?.name || 'Unassigned'}.`, 'info');
    };

    const handleAddTempAttachments = (files: FileList) => {
        setTempAttachments(prev => [...prev, ...Array.from(files)]);
    };

    const handleRemoveTempAttachment = (index: number) => {
        setTempAttachments(prev => prev.filter((_, i) => i !== index));
    };

    const handleSendReply = async () => {
        if (!currentReply.trim() && tempAttachments.length === 0) {
            addNotification('Reply content or attachments are required to send a reply.', 'warning');
            return;
        }
        setIsSendingReply(true);
        try {
            await mockApiCall({}, 1000); // Simulate API call for sending reply and updating ticket

            const newAttachments: Attachment[] = tempAttachments.map(file => ({
                id: generateUUID(),
                filename: file.name,
                url: URL.createObjectURL(file), // Using blob URL for display, in real app would be S3 URL etc.
                type: file.type.startsWith('image/') ? 'image' : (file.type.includes('pdf') || file.type.includes('document') ? 'document' : 'other'),
                uploadedBy: currentUser?.name || 'Agent',
                uploadDate: new Date().toISOString(),
                sizeKB: Math.round(file.size / 1024),
            }));

            const newPublicMessage: TicketMessage = {
                id: generateUUID(),
                senderId: currentUser?.id || 'agent_system',
                senderName: currentUser?.name || 'Support Agent',
                timestamp: new Date().toISOString(),
                content: currentReply,
                isInternal: false,
                attachments: newAttachments,
            };

            const updatedTicket: SupportTicket = {
                ...ticket,
                messages: [...ticket.messages, newPublicMessage],
                attachments: [...ticket.attachments, ...newAttachments], // Add to global ticket attachments
                lastUpdate: new Date().toISOString(),
                status: ticket.status === 'Open' ? 'Pending' : ticket.status, // Often, an agent reply makes it 'Pending'
            };

            onUpdateTicket(updatedTicket);
            setCurrentReply('');
            setTempAttachments([]);
            addNotification('Reply sent and ticket updated!', 'success');
        } catch (error) {
            addNotification('Failed to send reply.', 'error');
        } finally {
            setIsSendingReply(false);
        }
    };

    const handleAddInternalNote = async () => {
        if (!newInternalNote.trim()) {
            addNotification('Internal note content is required.', 'warning');
            return;
        }
        setIsSendingReply(true); // Re-using this state for any submit action
        try {
            await mockApiCall({}, 500);

            const note: TicketMessage = {
                id: generateUUID(),
                senderId: currentUser?.id || 'agent_system',
                senderName: currentUser?.name || 'Support Agent',
                timestamp: new Date().toISOString(),
                content: newInternalNote,
                isInternal: true,
            };

            const updatedTicket = {
                ...ticket,
                internalNotes: [...ticket.internalNotes, note],
                lastUpdate: new Date().toISOString(),
            };
            onUpdateTicket(updatedTicket);
            setNewInternalNote('');
            addNotification('Internal note added.', 'success');
        } catch (error) {
            addNotification('Failed to add internal note.', 'error');
        } finally {
            setIsSendingReply(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-7xl w-full border border-gray-700 max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">{ticket.subject} (Ticket {ticket.id})</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div className="p-6 flex-grow overflow-y-auto grid grid-cols-1 lg:grid-cols-4 xl:grid-cols-5 gap-6 custom-scrollbar">
                    <div className="lg:col-span-3 xl:col-span-3 space-y-6">
                        <Card title="Ticket Overview">
                            <p className="text-sm text-gray-300 bg-gray-900/50 p-3 rounded-lg mb-4">{ticket.description}</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-300">
                                <p><strong>User:</strong> {ticket.userName}</p>
                                <p><strong>Category:</strong> <span className="text-cyan-400">{ticket.category}</span></p>
                                <p><strong>Created:</strong> {formatDate(ticket.createdDate)}</p>
                                <p><strong>Last Update:</strong> {formatDate(ticket.lastUpdate)}</p>
                                <p><strong>Channel:</strong> {ticket.channel}</p>
                                <p><strong>Sentiment:</strong> <span className={`font-semibold ${ticket.sentiment === 'Negative' ? 'text-red-400' : ticket.sentiment === 'Positive' ? 'text-green-400' : 'text-gray-400'}`}>{ticket.sentiment}</span></p>
                                {ticket.tags.length > 0 && <p className="col-span-2"><strong>Tags:</strong> {ticket.tags.map(tag => <span key={tag} className="inline-block bg-cyan-600/20 text-cyan-300 text-xs px-2 py-0.5 rounded-full mr-2">{tag}</span>)}</p>}
                                {ticket.linkedTickets && ticket.linkedTickets.length > 0 && <p className="col-span-2"><strong>Linked Tickets:</strong> {ticket.linkedTickets.map(lt => <a key={lt} href="#" className="text-cyan-400 hover:underline mr-2">{lt}</a>)}</p>}
                                {ticket.customFields && Object.keys(ticket.customFields).length > 0 && (
                                    <div className="col-span-2">
                                        <p className="font-semibold text-gray-400 mb-1">Custom Fields:</p>
                                        <ul className="list-disc list-inside ml-2 text-xs">
                                            {Object.entries(ticket.customFields).map(([key, value]) => (
                                                <li key={key}><strong className="text-gray-500">{key}:</strong> {value}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </Card>

                        <Card title="Communication History">
                            <TicketMessagesDisplay messages={ticket.messages} agents={MOCK_AGENTS} customers={MOCK_CUSTOMERS} />
                        </Card>

                        <Card title="Internal Agent Notes">
                            <TicketMessagesDisplay messages={ticket.internalNotes} agents={MOCK_AGENTS} customers={MOCK_CUSTOMERS} />
                            <div className="mt-4 border-t border-gray-700 pt-4">
                                <textarea
                                    className="w-full min-h-[6rem] p-3 text-sm bg-gray-900/50 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"
                                    placeholder="Add an internal note..."
                                    value={newInternalNote}
                                    onChange={handleInternalNoteChange}
                                ></textarea>
                                <button
                                    onClick={handleAddInternalNote}
                                    disabled={isSendingReply || !newInternalNote.trim()}
                                    className="mt-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {isSendingReply ? 'Adding Note...' : 'Add Internal Note'}
                                </button>
                            </div>
                        </Card>

                        <AttachmentsSection attachments={ticket.attachments} />

                    </div>

                    <div className="lg:col-span-1 xl:col-span-2 space-y-6">
                        <Card title="Ticket Actions & Details">
                            <div className="space-y-4 text-sm">
                                <p>
                                    <strong className="text-gray-400">Status:</strong>
                                    <select
                                        value={ticket.status}
                                        onChange={handleStatusChange}
                                        className="ml-2 p-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                                    >
                                        {(['Open', 'Pending', 'Resolved', 'Closed', 'On-Hold', 'Reopened'] as TicketStatus[]).map(s => (
                                            <option key={s} value={s}>{s}</option>
                                        ))}
                                    </select>
                                </p>
                                <p>
                                    <strong className="text-gray-400">Priority:</strong>
                                    <select
                                        value={ticket.priority}
                                        onChange={handlePriorityChange}
                                        className="ml-2 p-1 bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                                    >
                                        {(['Low', 'Medium', 'High', 'Urgent'] as TicketPriority[]).map(p => (
                                            <option key={p} value={p}>{p}</option>
                                        ))}
                                    </select>
                                </p>
                                <p>
                                    <strong className="text-gray-400">Agent:</strong>
                                    <AgentSelector
                                        selectedAgentId={ticket.assignedAgentId}
                                        onSelectAgent={handleAgentAssign}
                                        agents={MOCK_AGENTS}
                                    />
                                </p>
                            </div>
                        </Card>

                        {customer && <CustomerDetailCard customer={customer} />}

                        <SLATrackerCard sla={ticket.sla} />

                        <Card title="Agent Reply">
                            <div className="space-y-4">
                                <div className="flex items-center space-x-2 mb-2">
                                    <label htmlFor="canned-response-select" className="text-sm text-gray-400">Canned Response:</label>
                                    <select
                                        id="canned-response-select"
                                        value={selectedCannedResponse}
                                        onChange={handleCannedResponseSelect}
                                        className="flex-grow p-2 text-sm bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                                    >
                                        <option value="">Select a canned response</option>
                                        {MOCK_CANNED_RESPONSES.map(cr => (
                                            <option key={cr.id} value={cr.id}>{cr.title}</option>
                                        ))}
                                    </select>
                                </div>

                                <textarea
                                    value={currentReply}
                                    onChange={handleReplyChange}
                                    className="w-full min-h-[10rem] p-3 text-sm bg-gray-900/50 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"
                                    placeholder="Type your reply here..."
                                ></textarea>

                                <div className="border-t border-gray-700 pt-4">
                                    <label className="block text-sm font-medium text-gray-300 mb-2">Add Files to Reply:</label>
                                    <input
                                        type="file"
                                        multiple
                                        onChange={(e) => handleAddTempAttachments(e.target.files!)}
                                        className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100"
                                    />
                                    {tempAttachments.length > 0 && (
                                        <div className="mt-2 space-y-1 text-xs text-gray-400">
                                            <p>Selected for upload:</p>
                                            {tempAttachments.map((file, index) => (
                                                <div key={index} className="flex items-center justify-between bg-gray-700/50 p-1 rounded-md">
                                                    <span>{file.name} ({Math.round(file.size / 1024)}KB)</span>
                                                    <button onClick={() => handleRemoveTempAttachment(index)} className="ml-2 text-red-400 hover:text-red-500">&times;</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <h4 className="font-semibold text-gray-200 mt-6 mb-2">AI Suggested Reply</h4>
                                <div className="min-h-[10rem] bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                                    {isLoadingAI && <p className="text-sm text-gray-400">Generating reply...</p>}
                                    {suggestedReply && <textarea value={suggestedReply} readOnly className="w-full h-40 text-sm bg-transparent border-none text-gray-300 focus:ring-0 resize-none"></textarea>}
                                    {!suggestedReply && !isLoadingAI && <button onClick={generateReply} className="text-sm text-cyan-400 hover:underline">Generate AI Suggested Reply</button>}
                                    {suggestedReply && !isLoadingAI && (
                                        <div className="flex justify-end space-x-2 mt-2">
                                            <button onClick={() => setCurrentReply(prev => (prev.endsWith('\n\n') ? prev : prev + '\n\n') + suggestedReply + '\n\n')} className="text-xs px-3 py-1 bg-cyan-600 hover:bg-cyan-700 text-white rounded-md">
                                                Insert into Reply
                                            </button>
                                            <button onClick={() => setSuggestedReply('')} className="text-xs px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded-md">
                                                Clear AI Suggestion
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
                <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end space-x-3">
                    <button
                        onClick={handleSendReply}
                        disabled={isSendingReply || (!currentReply.trim() && tempAttachments.length === 0)}
                        className="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-base font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {isSendingReply ? 'Sending...' : 'Send Reply & Update'}
                    </button>
                    <button onClick={onClose} className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white text-base rounded-lg">
                        Close
                    </button>
                </div>
            </div>
        </div>
    );
};

// ================================================================================================
// NEW: DASHBOARD WIDGETS
// ================================================================================================

export const AgentPerformanceWidget: React.FC<{ agent: Agent }> = ({ agent }) => {
    const agentTickets = useMemo(() => MOCK_ALL_TICKETS.filter(t => t.assignedAgentId === agent.id), [agent]);
    const resolvedTickets = agentTickets.filter(t => t.status === 'Resolved' || t.status === 'Closed').length;
    const openTickets = agentTickets.filter(t => t.status === 'Open' || t.status === 'Reopened').length;
    const avgResolutionTimeHours = agentTickets.length > 0
        ? agentTickets.reduce((sum, t) => {
            if (t.createdDate && (t.status === 'Resolved' || t.status === 'Closed')) {
                const created = new Date(t.createdDate).getTime();
                const resolved = new Date(t.lastUpdate).getTime();
                return sum + (resolved - created) / (1000 * 60 * 60);
            }
            return sum;
        }, 0) / resolvedTickets
        : 0;

    return (
        <Card className="text-sm">
            <div className="flex items-center mb-3">
                <img src={agent.avatarUrl} alt={agent.name} className="w-10 h-10 rounded-full mr-3" />
                <div>
                    <h4 className="font-semibold text-white">{agent.name}</h4>
                    <p className="text-xs text-gray-400">{agent.role} - {agent.team}</p>
                </div>
                <span className={`ml-auto px-2 py-1 text-xs rounded-full ${agent.status === 'Online' ? 'bg-green-500/20 text-green-300' : agent.status === 'Busy' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-gray-500/20 text-gray-300'}`}>
                    {agent.status}
                </span>
            </div>
            <div className="grid grid-cols-2 gap-2 mt-4 text-gray-300">
                <div>Open: <span className="font-semibold text-red-400">{openTickets}</span></div>
                <div>Resolved: <span className="font-semibold text-green-400">{resolvedTickets}</span></div>
                <div className="col-span-2">Avg. Resolution: <span className="font-semibold">{avgResolutionTimeHours > 0 ? `${avgResolutionTimeHours.toFixed(1)}h` : 'N/A'}</span></div>
                <div className="col-span-2 text-xs text-gray-500">Last Active: {agent.lastActive}</div>
            </div>
        </Card>
    );
};

export const RecentActivitiesWidget: React.FC = () => {
    const recentEvents = useMemo(() => {
        // Mock recent events from all tickets
        const events: { timestamp: string; description: string; type: 'ticket' | 'agent' | 'sla'; icon: string; }[] = [];
        MOCK_ALL_TICKETS.forEach(ticket => {
            events.push({
                timestamp: ticket.lastUpdate,
                description: `Ticket ${ticket.id} (${ticket.subject}) updated to ${ticket.status}.`,
                type: 'ticket',
                icon: '📝'
            });
            if (ticket.status === 'Open' && Math.random() < 0.3) { // Simulate some SLA warnings
                events.push({
                    timestamp: new Date(new Date(ticket.createdDate).getTime() + 1 * 60 * 60 * 1000).toISOString(), // 1 hour after creation
                    description: `SLA warning for Ticket ${ticket.id} (First Response due soon).`,
                    type: 'sla',
                    icon: '⚠️'
                });
            }
        });
        MOCK_AGENTS.forEach(agent => {
            if (agent.status === 'Online' && agent.lastActive === '0m ago') {
                events.push({
                    timestamp: new Date().toISOString(),
                    description: `${agent.name} is now online.`,
                    type: 'agent',
                    icon: '🟢'
                });
            }
        });

        return events.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()).slice(0, 10);
    }, []);

    return (
        <Card title="Recent Activities">
            <ul className="space-y-3">
                {recentEvents.map((event, index) => (
                    <li key={index} className="flex items-start text-sm text-gray-300">
                        <span className="mr-2 text-lg flex-shrink-0">{event.icon}</span>
                        <div>
                            <p>{event.description}</p>
                            <p className="text-xs text-gray-500">{formatDate(event.timestamp, { dateStyle: 'short', timeStyle: 'short' })}</p>
                        </div>
                    </li>
                ))}
            </ul>
        </Card>
    );
};

export const TicketTrendChartWidget: React.FC = () => {
    // This would typically involve a charting library like Chart.js or Recharts
    // For this exercise, we'll use a placeholder div.
    const chartData = useMemo(() => {
        const data: { [date: string]: { created: number; resolved: number; } } = {};
        const today = new Date();
        for (let i = 0; i < 30; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            data[dateStr] = { created: 0, resolved: 0 };
        }

        MOCK_ALL_TICKETS.forEach(ticket => {
            const createdDate = new Date(ticket.createdDate).toISOString().split('T')[0];
            if (data[createdDate]) {
                data[createdDate].created++;
            }
            if (ticket.status === 'Resolved' || ticket.status === 'Closed') {
                const resolvedDate = new Date(ticket.lastUpdate).toISOString().split('T')[0];
                if (data[resolvedDate]) {
                    data[resolvedDate].resolved++;
                }
            }
        });

        // Simple mock for chart visualization
        return Object.entries(data).sort(([dateA], [dateB]) => new Date(dateA).getTime() - new Date(dateB).getTime());
    }, []);

    return (
        <Card title="Ticket Volume Trend (Last 30 Days)">
            <div className="h-48 bg-gray-900 rounded-md flex items-center justify-center text-gray-500 text-sm">
                [Placeholder for a Chart.js/Recharts component]
                <p>Showing {chartData.length} days of data.</p>
            </div>
            <div className="mt-4 text-xs text-gray-400">
                <p>New Tickets: <span className="text-cyan-400">{chartData.reduce((sum, [, d]) => sum + d.created, 0)}</span></p>
                <p>Resolved Tickets: <span className="text-green-400">{chartData.reduce((sum, [, d]) => sum + d.resolved, 0)}</span></p>
            </div>
        </Card>
    );
};

// ================================================================================================
// NEW: NAVIGATION COMPONENTS
// ================================================================================================

export type MainView = 'Dashboard' | 'Tickets' | 'Agents' | 'Customers' | 'CannedResponses' | 'SLARules' | 'Reports' | 'Settings' | 'KnowledgeBase';

interface NavItemProps {
    label: string;
    icon: string;
    view: MainView;
    currentView: MainView;
    onClick: (view: MainView) => void;
}

export const SidebarNavItem: React.FC<NavItemProps> = ({ label, icon, view, currentView, onClick }) => {
    const isActive = currentView === view;
    return (
        <button
            onClick={() => onClick(view)}
            className={`flex items-center p-3 rounded-lg w-full text-left transition-colors duration-200
                        ${isActive ? 'bg-cyan-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}
        >
            <span className="text-xl mr-3">{icon}</span>
            <span className="font-medium text-sm">{label}</span>
        </button>
    );
};

export const MainSidebar: React.FC<{ currentView: MainView; onSelectView: (view: MainView) => void; }> = ({ currentView, onSelectView }) => {
    return (
        <div className="w-64 bg-gray-800 p-4 border-r border-gray-700 flex flex-col shadow-lg">
            <div className="flex items-center mb-6">
                <span className="text-3xl mr-2">🚀</span>
                <h1 className="text-xl font-bold text-white">MegaDesk</h1>
            </div>
            <nav className="space-y-2">
                <SidebarNavItem label="Dashboard" icon="📊" view="Dashboard" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="Tickets" icon="🎫" view="Tickets" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="Agents" icon="🧑‍💻" view="Agents" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="Customers" icon="👤" view="Customers" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="Canned Responses" icon="💬" view="CannedResponses" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="SLA Rules" icon="⏱️" view="SLARules" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="Reports" icon="📈" view="Reports" currentView={currentView} onClick={onSelectView} />
                <SidebarNavItem label="Knowledge Base" icon="📚" view="KnowledgeBase" currentView={currentView} onClick={onSelectView} />
                <div className="border-t border-gray-700 my-4 pt-4"></div>
                <SidebarNavItem label="Settings" icon="⚙️" view="Settings" currentView={currentView} onClick={onSelectView} />
            </nav>
            <div className="mt-auto pt-4 text-xs text-gray-500">
                <p>&copy; 2024 Demo Bank. All rights reserved.</p>
                <p>Version 1.5.0-beta</p>
            </div>
        </div>
    );
};

// ================================================================================================
// NEW: MANAGEMENT VIEWS
// ================================================================================================

export const AgentsManagementView: React.FC = () => {
    const [agents, setAgents] = useState<Agent[]>(MOCK_AGENTS);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState<'all' | 'Online' | 'Offline' | 'Busy'>('all');
    const { addNotification } = useNotifications();

    const filteredAgents = useMemo(() => {
        return agents.filter(agent => {
            const matchesSearch = agent.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                agent.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                agent.team.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesStatus = filterStatus === 'all' || agent.status === filterStatus;
            return matchesSearch && matchesStatus;
        });
    }, [agents, searchTerm, filterStatus]);

    const handleUpdateAgentStatus = useCallback(async (agentId: string, newStatus: Agent['status']) => {
        const updatedAgents = agents.map(agent =>
            agent.id === agentId ? { ...agent, status: newStatus, lastActive: new Date().toLocaleTimeString('en-US') } : agent
        );
        // Simulate API call
        await mockApiCall(updatedAgents, 300);
        setAgents(updatedAgents);
        addNotification(`Agent ${agents.find(a => a.id === agentId)?.name} status updated to ${newStatus}.`, 'success');
    }, [agents, addNotification]);

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Agent Management</h2>
            <Card>
                <div className="flex justify-between items-center mb-4">
                    <input
                        type="text"
                        placeholder="Search agents..."
                        className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 w-64 focus:ring-cyan-500 focus:border-cyan-500"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <div className="flex space-x-2">
                        {(['all', 'Online', 'Offline', 'Busy'] as const).map(status => (
                            <button
                                key={status}
                                onClick={() => setFilterStatus(status)}
                                className={`px-3 py-1 text-sm rounded-md ${filterStatus === status ? 'bg-cyan-600' : 'text-gray-300 bg-gray-900/50'}`}
                            >
                                {status === 'all' ? 'All Statuses' : status}
                            </button>
                        ))}
                    </div>
                    <button className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg">Add New Agent</button>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Agent Name</th>
                                <th className="px-6 py-3">Email</th>
                                <th className="px-6 py-3">Role</th>
                                <th className="px-6 py-3">Team</th>
                                <th className="px-6 py-3">Status</th>
                                <th className="px-6 py-3">Last Active</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredAgents.map(agent => (
                                <tr key={agent.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white flex items-center">
                                        <img src={agent.avatarUrl} alt={agent.name} className="w-8 h-8 rounded-full mr-3" />
                                        {agent.name}
                                    </td>
                                    <td className="px-6 py-4">{agent.email}</td>
                                    <td className="px-6 py-4">{agent.role}</td>
                                    <td className="px-6 py-4">{agent.team}</td>
                                    <td className="px-6 py-4">
                                        <span className={`px-2 py-1 text-xs rounded-full ${agent.status === 'Online' ? 'bg-green-500/20 text-green-300' : agent.status === 'Busy' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-gray-500/20 text-gray-300'}`}>
                                            {agent.status}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">{agent.lastActive}</td>
                                    <td className="px-6 py-4">
                                        <div className="flex space-x-2">
                                            <button className="text-cyan-400 hover:text-cyan-300 text-sm">Edit</button>
                                            <select
                                                value={agent.status}
                                                onChange={(e) => handleUpdateAgentStatus(agent.id, e.target.value as Agent['status'])}
                                                className="p-1 text-xs bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500"
                                            >
                                                <option value="Online">Online</option>
                                                <option value="Offline">Offline</option>
                                                <option value="Busy">Busy</option>
                                            </select>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};

export const CustomersManagementView: React.FC = () => {
    const [customers, setCustomers] = useState<Customer[]>(MOCK_CUSTOMERS);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState<'all' | 'Active' | 'Inactive' | 'VIP'>('all');
    const { addNotification } = useNotifications();

    const filteredCustomers = useMemo(() => {
        return customers.filter(customer => {
            const matchesSearch = customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                customer.id.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesStatus = filterStatus === 'all' || customer.status === filterStatus;
            return matchesSearch && matchesStatus;
        });
    }, [customers, searchTerm, filterStatus]);

    const handleUpdateCustomer = useCallback(async (updatedCustomer: Customer) => {
        const updatedList = customers.map(cust => cust.id === updatedCustomer.id ? updatedCustomer : cust);
        await mockApiCall(updatedList, 300);
        setCustomers(updatedList);
        addNotification(`Customer ${updatedCustomer.name} updated.`, 'success');
    }, [customers, addNotification]);

    // Simple inline editor for status
    const CustomerRow: React.FC<{ customer: Customer; onUpdate: (c: Customer) => void }> = ({ customer, onUpdate }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [currentStatus, setCurrentStatus] = useState(customer.status);

        const handleStatusChange = async (e: React.ChangeEvent<HTMLSelectElement>) => {
            const newStatus = e.target.value as Customer['status'];
            setCurrentStatus(newStatus);
            await onUpdate({ ...customer, status: newStatus });
            setIsEditing(false); // Optionally close after selection
        };

        return (
            <tr key={customer.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                <td className="px-6 py-4 font-medium text-white">{customer.name}</td>
                <td className="px-6 py-4">{customer.email}</td>
                <td className="px-6 py-4">{customer.phone}</td>
                <td className="px-6 py-4">{customer.totalTickets} / {customer.openTickets}</td>
                <td className="px-6 py-4">
                    {isEditing ? (
                        <select value={currentStatus} onChange={handleStatusChange} onBlur={() => setIsEditing(false)} className="p-1 text-xs bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="VIP">VIP</option>
                        </select>
                    ) : (
                        <span onClick={() => setIsEditing(true)} className={`cursor-pointer px-2 py-1 text-xs rounded-full ${customer.status === 'VIP' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-gray-500/20 text-gray-300'}`}>
                            {customer.status}
                        </span>
                    )}
                </td>
                <td className="px-6 py-4">
                    <button className="text-cyan-400 hover:text-cyan-300 text-sm mr-2">View History</button>
                    <button className="text-purple-400 hover:text-purple-300 text-sm">Edit Notes</button>
                </td>
            </tr>
        );
    };


    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Customer Management</h2>
            <Card>
                <div className="flex justify-between items-center mb-4">
                    <input
                        type="text"
                        placeholder="Search customers..."
                        className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 w-64 focus:ring-cyan-500 focus:border-cyan-500"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <div className="flex space-x-2">
                        {(['all', 'Active', 'Inactive', 'VIP'] as const).map(status => (
                            <button
                                key={status}
                                onClick={() => setFilterStatus(status)}
                                className={`px-3 py-1 text-sm rounded-md ${filterStatus === status ? 'bg-cyan-600' : 'text-gray-300 bg-gray-900/50'}`}
                            >
                                {status === 'all' ? 'All Statuses' : status}
                            </button>
                        ))}
                    </div>
                    <button className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg">Add New Customer</button>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Name</th>
                                <th className="px-6 py-3">Email</th>
                                <th className="px-6 py-3">Phone</th>
                                <th className="px-6 py-3">Tickets (Total/Open)</th>
                                <th className="px-6 py-3">Status</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredCustomers.map(customer => (
                                <CustomerRow key={customer.id} customer={customer} onUpdate={handleUpdateCustomer} />
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};

export const CannedResponsesManagementView: React.FC = () => {
    const [cannedResponses, setCannedResponses] = useState<CannedResponse[]>(MOCK_CANNED_RESPONSES);
    const [searchTerm, setSearchTerm] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingResponse, setEditingResponse] = useState<CannedResponse | null>(null);
    const { addNotification } = useNotifications();

    const filteredResponses = useMemo(() => {
        return cannedResponses.filter(response =>
            response.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
            response.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
            response.category.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }, [cannedResponses, searchTerm]);

    const handleSaveResponse = async (response: CannedResponse) => {
        if (editingResponse) {
            const updatedResponses = cannedResponses.map(cr => cr.id === response.id ? response : cr);
            await mockApiCall(updatedResponses, 300);
            setCannedResponses(updatedResponses);
            addNotification(`Canned response "${response.title}" updated.`, 'success');
        } else {
            const newResponse = { ...response, id: `CR-${generateUUID().substring(0, 4).toUpperCase()}`, createdBy: 'agent_007', lastModified: new Date().toISOString() };
            await mockApiCall([...cannedResponses, newResponse], 300);
            setCannedResponses(prev => [...prev, newResponse]);
            addNotification(`Canned response "${newResponse.title}" added.`, 'success');
        }
        setIsModalOpen(false);
        setEditingResponse(null);
    };

    const handleDeleteResponse = async (id: string) => {
        if (window.confirm('Are you sure you want to delete this canned response?')) {
            const updatedResponses = cannedResponses.filter(cr => cr.id !== id);
            await mockApiCall(updatedResponses, 300);
            setCannedResponses(updatedResponses);
            addNotification('Canned response deleted.', 'success');
        }
    };

    const CannedResponseModal: React.FC<{
        isOpen: boolean;
        onClose: () => void;
        response: CannedResponse | null;
        onSave: (response: CannedResponse) => void;
    }> = ({ isOpen, onClose, response, onSave }) => {
        const [formData, setFormData] = useState<CannedResponse>(response || {
            id: '', title: '', content: '', category: 'General', keywords: [], createdBy: '', lastModified: ''
        });

        useEffect(() => {
            setFormData(response || {
                id: '', title: '', content: '', category: 'General', keywords: [], createdBy: '', lastModified: ''
            });
        }, [response]);

        if (!isOpen) return null;

        const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
            const { name, value } = e.target;
            if (name === 'keywords') {
                setFormData({ ...formData, keywords: value.split(',').map(k => k.trim()).filter(k => k) });
            } else {
                setFormData({ ...formData, [name]: value });
            }
        };

        const handleSubmit = (e: React.FormEvent) => {
            e.preventDefault();
            onSave(formData);
        };

        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                <div className="bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full border border-gray-700" onClick={e => e.stopPropagation()}>
                    <form onSubmit={handleSubmit}>
                        <div className="p-4 border-b border-gray-700">
                            <h3 className="text-lg font-semibold text-white">{response ? 'Edit Canned Response' : 'Create New Canned Response'}</h3>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Title</label>
                                <input type="text" name="title" value={formData.title} onChange={handleChange} required className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Content</label>
                                <textarea name="content" value={formData.content} onChange={handleChange} required rows={6} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Category</label>
                                <select name="category" value={formData.category} onChange={handleChange} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                                    {(['General', 'Account', 'Billing', 'Technical', 'Fraud'] as TicketCategory[]).map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Keywords (comma-separated)</label>
                                <input type="text" name="keywords" value={formData.keywords.join(', ')} onChange={handleChange} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                            </div>
                        </div>
                        <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end space-x-3">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg">Cancel</button>
                            <button type="submit" className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg">Save Response</button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Canned Responses Management</h2>
            <Card>
                <div className="flex justify-between items-center mb-4">
                    <input
                        type="text"
                        placeholder="Search responses..."
                        className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 w-64 focus:ring-cyan-500 focus:border-cyan-500"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <button
                        onClick={() => { setEditingResponse(null); setIsModalOpen(true); }}
                        className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg"
                    >
                        Add New Response
                    </button>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Title</th>
                                <th className="px-6 py-3">Category</th>
                                <th className="px-6 py-3">Content Snippet</th>
                                <th className="px-6 py-3">Keywords</th>
                                <th className="px-6 py-3">Last Modified</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredResponses.map(response => (
                                <tr key={response.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white">{response.title}</td>
                                    <td className="px-6 py-4">{response.category}</td>
                                    <td className="px-6 py-4 text-xs max-w-xs truncate">{response.content.substring(0, 100)}...</td>
                                    <td className="px-6 py-4 text-xs">{response.keywords.join(', ')}</td>
                                    <td className="px-6 py-4 text-xs">{formatDate(response.lastModified, { dateStyle: 'short' })}</td>
                                    <td className="px-6 py-4">
                                        <button
                                            onClick={() => { setEditingResponse(response); setIsModalOpen(true); }}
                                            className="text-cyan-400 hover:text-cyan-300 text-sm mr-2"
                                        >
                                            Edit
                                        </button>
                                        <button
                                            onClick={() => handleDeleteResponse(response.id)}
                                            className="text-red-400 hover:text-red-300 text-sm"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
            <CannedResponseModal
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                response={editingResponse}
                onSave={handleSaveResponse}
            />
        </div>
    );
};

export const SLARulesManagementView: React.FC = () => {
    const [slaRules, setSlaRules] = useState<SLARule[]>(MOCK_SLA_RULES);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingRule, setEditingRule] = useState<SLARule | null>(null);
    const { addNotification } = useNotifications();

    const handleSaveRule = async (rule: SLARule) => {
        if (editingRule) {
            const updatedRules = slaRules.map(sr => sr.id === rule.id ? rule : sr);
            await mockApiCall(updatedRules, 300);
            setSlaRules(updatedRules);
            addNotification(`SLA Rule "${rule.name}" updated.`, 'success');
        } else {
            const newRule = { ...rule, id: `SLA-${generateUUID().substring(0, 4).toUpperCase()}` };
            await mockApiCall([...slaRules, newRule], 300);
            setSlaRules(prev => [...prev, newRule]);
            addNotification(`SLA Rule "${newRule.name}" added.`, 'success');
        }
        setIsModalOpen(false);
        setEditingRule(null);
    };

    const handleDeleteRule = async (id: string) => {
        if (window.confirm('Are you sure you want to delete this SLA rule?')) {
            const updatedRules = slaRules.filter(sr => sr.id !== id);
            await mockApiCall(updatedRules, 300);
            setSlaRules(updatedRules);
            addNotification('SLA rule deleted.', 'success');
        }
    };

    const SLARuleModal: React.FC<{
        isOpen: boolean;
        onClose: () => void;
        rule: SLARule | null;
        onSave: (rule: SLARule) => void;
    }> = ({ isOpen, onClose, rule, onSave }) => {
        const [formData, setFormData] = useState<SLARule>(rule || {
            id: '', name: '', conditions: [], firstResponseTimeHours: 1, resolutionTimeHours: 4, priority: 'Medium', isActive: true, description: ''
        });

        useEffect(() => {
            setFormData(rule || {
                id: '', name: '', conditions: [], firstResponseTimeHours: 1, resolutionTimeHours: 4, priority: 'Medium', isActive: true, description: ''
            });
        }, [rule]);

        if (!isOpen) return null;

        const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
            const { name, value, type, checked } = e.target;
            setFormData(prev => ({
                ...prev,
                [name]: type === 'checkbox' ? checked : (type === 'number' ? parseFloat(value) : value)
            }));
        };

        const handleConditionChange = (index: number, field: string, value: string | number | boolean) => {
            const newConditions = [...formData.conditions];
            newConditions[index] = { ...newConditions[index], [field]: value };
            setFormData({ ...formData, conditions: newConditions });
        };

        const addCondition = () => {
            setFormData(prev => ({
                ...prev,
                conditions: [...prev.conditions, { field: 'status', operator: 'equals', value: 'Open' }]
            }));
        };

        const removeCondition = (index: number) => {
            setFormData(prev => ({
                ...prev,
                conditions: prev.conditions.filter((_, i) => i !== index)
            }));
        };

        const handleSubmit = (e: React.FormEvent) => {
            e.preventDefault();
            onSave(formData);
        };

        const availableTicketFields: { label: string; value: keyof SupportTicket; type: 'string' | 'number' | 'boolean' | 'enum'; enumOptions?: string[]; }[] = [
            { label: 'Status', value: 'status', type: 'enum', enumOptions: ['Open', 'Pending', 'Resolved', 'Closed', 'On-Hold', 'Reopened'] },
            { label: 'Priority', value: 'priority', type: 'enum', enumOptions: ['Low', 'Medium', 'High', 'Urgent'] },
            { label: 'Category', value: 'category', type: 'enum', enumOptions: ['Billing', 'Technical', 'Account', 'Feature Request', 'General Inquiry', 'Fraud'] },
            { label: 'Sentiment', value: 'sentiment', type: 'enum', enumOptions: ['Positive', 'Neutral', 'Negative', 'Mixed'] },
            // Add more fields as needed for a real application
        ];

        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                <div className="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full border border-gray-700" onClick={e => e.stopPropagation()}>
                    <form onSubmit={handleSubmit}>
                        <div className="p-4 border-b border-gray-700">
                            <h3 className="text-lg font-semibold text-white">{rule ? 'Edit SLA Rule' : 'Create New SLA Rule'}</h3>
                        </div>
                        <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Rule Name</label>
                                <input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Description</label>
                                <textarea name="description" value={formData.description || ''} onChange={handleChange} rows={3} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-1">First Response Time (hours)</label>
                                    <input type="number" name="firstResponseTimeHours" value={formData.firstResponseTimeHours} onChange={handleChange} required min="1" className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-1">Resolution Time (hours)</label>
                                    <input type="number" name="resolutionTimeHours" value={formData.resolutionTimeHours} onChange={handleChange} required min="1" className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Default Priority for this SLA</label>
                                <select name="priority" value={formData.priority} onChange={handleChange} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                                    {(['Low', 'Medium', 'High', 'Urgent'] as TicketPriority[]).map(p => (
                                        <option key={p} value={p}>{p}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex items-center">
                                <input type="checkbox" name="isActive" checked={formData.isActive} onChange={handleChange} id="isActive" className="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-600 rounded" />
                                <label htmlFor="isActive" className="ml-2 block text-sm text-gray-300">Is Active</label>
                            </div>

                            <div className="border-t border-gray-700 pt-4 mt-4">
                                <h4 className="text-md font-semibold text-gray-200 mb-2">Conditions</h4>
                                {formData.conditions.map((condition, index) => {
                                    const fieldMeta = availableTicketFields.find(f => f.value === condition.field);
                                    return (
                                        <div key={index} className="flex items-center space-x-2 mb-2 p-2 bg-gray-900/50 rounded-md">
                                            <select
                                                value={condition.field}
                                                onChange={(e) => handleConditionChange(index, 'field', e.target.value as keyof SupportTicket)}
                                                className="p-1 text-sm bg-gray-700 border border-gray-600 rounded-md text-gray-300"
                                            >
                                                {availableTicketFields.map(field => (
                                                    <option key={field.value} value={field.value}>{field.label}</option>
                                                ))}
                                            </select>
                                            <select
                                                value={condition.operator}
                                                onChange={(e) => handleConditionChange(index, 'operator', e.target.value as any)}
                                                className="p-1 text-sm bg-gray-700 border border-gray-600 rounded-md text-gray-300"
                                            >
                                                <option value="equals">equals</option>
                                                <option value="contains">contains</option>
                                                {/* Add more operators as relevant to field type */}
                                            </select>
                                            {fieldMeta?.type === 'enum' ? (
                                                <select
                                                    value={condition.value as string}
                                                    onChange={(e) => handleConditionChange(index, 'value', e.target.value)}
                                                    className="p-1 text-sm bg-gray-700 border border-gray-600 rounded-md text-gray-300"
                                                >
                                                    {fieldMeta.enumOptions?.map(option => (
                                                        <option key={option} value={option}>{option}</option>
                                                    ))}
                                                </select>
                                            ) : (
                                                <input
                                                    type={fieldMeta?.type === 'number' ? 'number' : 'text'}
                                                    value={condition.value as string}
                                                    onChange={(e) => handleConditionChange(index, 'value', fieldMeta?.type === 'number' ? parseFloat(e.target.value) : e.target.value)}
                                                    className="flex-grow p-1 text-sm bg-gray-700 border border-gray-600 rounded-md text-gray-300"
                                                />
                                            )}
                                            <button type="button" onClick={() => removeCondition(index)} className="text-red-400 hover:text-red-300">
                                                &times;
                                            </button>
                                        </div>
                                    );
                                })}
                                <button type="button" onClick={addCondition} className="mt-2 px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded-lg">
                                    Add Condition
                                </button>
                            </div>
                        </div>
                        <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end space-x-3">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg">Cancel</button>
                            <button type="submit" className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg">Save Rule</button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">SLA Rules Management</h2>
            <Card>
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-semibold text-white">Defined SLA Rules</h3>
                    <button
                        onClick={() => { setEditingRule(null); setIsModalOpen(true); }}
                        className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg"
                    >
                        Add New Rule
                    </button>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Rule Name</th>
                                <th className="px-6 py-3">Conditions</th>
                                <th className="px-6 py-3">Response Time</th>
                                <th className="px-6 py-3">Resolution Time</th>
                                <th className="px-6 py-3">Priority</th>
                                <th className="px-6 py-3">Active</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {slaRules.map(rule => (
                                <tr key={rule.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white">{rule.name}</td>
                                    <td className="px-6 py-4 text-xs">
                                        {rule.conditions.map((cond, i) => (
                                            <span key={i} className="block text-gray-500">{cond.field} {cond.operator} {String(cond.value)}</span>
                                        ))}
                                    </td>
                                    <td className="px-6 py-4">{rule.firstResponseTimeHours}h</td>
                                    <td className="px-6 py-4">{rule.resolutionTimeHours}h</td>
                                    <td className="px-6 py-4"><PriorityBadge priority={rule.priority} /></td>
                                    <td className="px-6 py-4">{rule.isActive ? 'Yes' : 'No'}</td>
                                    <td className="px-6 py-4">
                                        <button
                                            onClick={() => { setEditingRule(rule); setIsModalOpen(true); }}
                                            className="text-cyan-400 hover:text-cyan-300 text-sm mr-2"
                                        >
                                            Edit
                                        </button>
                                        <button
                                            onClick={() => handleDeleteRule(rule.id)}
                                            className="text-red-400 hover:text-red-300 text-sm"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
            <SLARuleModal
                isOpen={isModalOpen}
                onClose={() => setIsModalOpen(false)}
                rule={editingRule}
                onSave={handleSaveRule}
            />
        </div>
    );
};

export const ReportsView: React.FC = () => {
    const { addNotification } = useNotifications();
    const [reportType, setReportType] = useState('ticketVolume');
    const [timeRange, setTimeRange] = useState('last30days');
    const [loadingReport, setLoadingReport] = useState(false);
    const [reportData, setReportData] = useState<any>(null); // Placeholder for actual report data structure

    const generateReport = useCallback(async () => {
        setLoadingReport(true);
        setReportData(null);
        try {
            // Simulate fetching complex report data
            await mockApiCall({}, 1500);

            let data: any = {};
            if (reportType === 'ticketVolume') {
                const dates: string[] = [];
                const created: number[] = [];
                const resolved: number[] = [];
                const today = new Date();
                for (let i = 0; i < 30; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    dates.unshift(d.toISOString().split('T')[0]);
                    created.unshift(getRandomInt(5, 20));
                    resolved.unshift(getRandomInt(3, 15));
                }
                data = {
                    title: `Ticket Volume Report (${timeRange})`,
                    chartType: 'line',
                    labels: dates,
                    datasets: [
                        { label: 'Tickets Created', data: created, borderColor: '#34d399', backgroundColor: 'rgba(52, 211, 153, 0.2)' },
                        { label: 'Tickets Resolved', data: resolved, borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.2)' }
                    ],
                    summary: `Total Created: ${created.reduce((a, b) => a + b, 0)}, Total Resolved: ${resolved.reduce((a, b) => a + b, 0)}`
                };
            } else if (reportType === 'agentPerformance') {
                const agents = MOCK_AGENTS.filter(a => a.role === 'Agent');
                const agentNames = agents.map(a => a.name);
                const resolvedCounts = agents.map(() => getRandomInt(20, 100));
                const avgResponseTimes = agents.map(() => getRandomInt(1, 10) + Math.random().toFixed(1));
                data = {
                    title: `Agent Performance Report (${timeRange})`,
                    chartType: 'bar',
                    labels: agentNames,
                    datasets: [
                        { label: 'Tickets Resolved', data: resolvedCounts, backgroundColor: '#818cf8' },
                        { label: 'Avg. Response Time (h)', data: avgResponseTimes, backgroundColor: '#fbbf24' }
                    ],
                    summary: `Total Agents: ${agents.length}, Avg. Resolved per Agent: ${(resolvedCounts.reduce((a, b) => a + b, 0) / agents.length).toFixed(1)}`
                };
            }
            setReportData(data);
            addNotification('Report generated successfully!', 'success');
        } catch (error) {
            addNotification('Failed to generate report.', 'error');
        } finally {
            setLoadingReport(false);
        }
    }, [reportType, timeRange, addNotification]);

    useEffect(() => {
        generateReport(); // Generate initial report on load
    }, [generateReport]);

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Reports & Analytics</h2>
            <Card>
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                    <div className="flex items-center space-x-3">
                        <label htmlFor="reportType" className="text-gray-300 text-sm">Report Type:</label>
                        <select
                            id="reportType"
                            value={reportType}
                            onChange={(e) => setReportType(e.target.value)}
                            className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 text-sm focus:ring-cyan-500 focus:border-cyan-500"
                        >
                            <option value="ticketVolume">Ticket Volume</option>
                            <option value="agentPerformance">Agent Performance</option>
                            <option value="slaCompliance">SLA Compliance</option>
                            <option value="customerSatisfaction">Customer Satisfaction</option>
                            {/* Add more report types */}
                        </select>
                    </div>
                    <div className="flex items-center space-x-3">
                        <label htmlFor="timeRange" className="text-gray-300 text-sm">Time Range:</label>
                        <select
                            id="timeRange"
                            value={timeRange}
                            onChange={(e) => setTimeRange(e.target.value)}
                            className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 text-sm focus:ring-cyan-500 focus:border-cyan-500"
                        >
                            <option value="today">Today</option>
                            <option value="last7days">Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="thisMonth">This Month</option>
                            <option value="lastMonth">Last Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <button
                        onClick={generateReport}
                        disabled={loadingReport}
                        className="px-5 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loadingReport ? 'Generating...' : 'Generate Report'}
                    </button>
                </div>

                <div className="border-t border-gray-700 pt-6 mt-6">
                    {loadingReport && (
                        <div className="flex items-center justify-center p-8 text-cyan-400">
                            <svg className="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"> {/* Spinner */}
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading report data...
                        </div>
                    )}
                    {!loadingReport && reportData && (
                        <div>
                            <h3 className="text-xl font-semibold text-white mb-4">{reportData.title}</h3>
                            <div className="bg-gray-900 rounded-md p-4 mb-4">
                                <p className="text-sm text-gray-300">{reportData.summary}</p>
                            </div>
                            <div className="h-80 bg-gray-900 rounded-md flex items-center justify-center text-gray-500 text-sm">
                                [Placeholder for a {reportData.chartType} chart visualization, e.g., using Chart.js]
                                <p>Chart data for {reportData.title} available.</p>
                            </div>
                            {/* Example of displaying raw data (for debug/testing) */}
                            <div className="mt-4 p-3 bg-gray-900/50 rounded-md max-h-48 overflow-y-auto text-xs text-gray-400">
                                <pre>{JSON.stringify(reportData, null, 2)}</pre>
                            </div>
                        </div>
                    )}
                    {!loadingReport && !reportData && (
                        <div className="p-8 text-center text-gray-500">
                            Select report type and time range, then click "Generate Report".
                        </div>
                    )}
                </div>
            </Card>
        </div>
    );
};

export const KnowledgeBaseView: React.FC = () => {
    interface Article {
        id: string;
        title: string;
        content: string;
        category: string;
        tags: string[];
        lastUpdated: string;
        author: string;
        views: number;
    }

    const MOCK_KB_ARTICLES: Article[] = [
        { id: 'KB-001', title: 'How to Reset Your Password', content: 'Detailed steps on how users can securely reset their forgotten passwords through the web portal or mobile app. Includes screenshots.', category: 'Account Management', tags: ['password', 'reset', 'login'], lastUpdated: '2024-06-15', author: 'KB Admin', views: 1250 },
        { id: 'KB-002', title: 'Understanding Transaction Fees', content: 'An explanation of different transaction fees, including withdrawal fees, transfer fees, and foreign exchange fees. Provides a table of rates.', category: 'Billing & Fees', tags: ['fees', 'transactions', 'charges'], lastUpdated: '2024-07-01', author: 'Finance Team', views: 980 },
        { id: 'KB-003', title: 'Troubleshooting Mobile App Issues', content: 'Common fixes for mobile app problems like crashing, freezing, or slow performance. Covers iOS and Android specific steps.', category: 'Technical Support', tags: ['mobile', 'app', 'crash', 'bug'], lastUpdated: '2024-07-10', author: 'Tech Support', views: 1500 },
        { id: 'KB-004', title: 'Setting Up Direct Deposit', content: 'Step-by-step guide to setting up direct deposit with your employer. Includes required bank information and forms.', category: 'Account Management', tags: ['direct deposit', 'payroll'], lastUpdated: '2024-05-20', author: 'Payroll Dept', views: 720 },
        { id: 'KB-005', title: 'Reporting Fraudulent Activity', content: 'Instructions on what to do if you suspect fraudulent activity on your account, including contact information for fraud department and necessary documentation.', category: 'Security & Fraud', tags: ['fraud', 'security', 'report'], lastUpdated: '2024-07-18', author: 'Security Team', views: 1100 },
        { id: 'KB-006', title: 'Contacting Support', content: 'Overview of all available channels to contact customer support: phone, email, chat, and in-app messaging. Includes operating hours.', category: 'General Information', tags: ['contact', 'support'], lastUpdated: '2024-04-01', author: 'Support Ops', views: 200 },
        { id: 'KB-007', title: 'Understanding Your Monthly Statement', content: 'A guide to help customers interpret their monthly bank statements, explaining each section and common terms.', category: 'Billing & Fees', tags: ['statement', 'billing', 'finance'], lastUpdated: '2024-06-01', author: 'Finance Team', views: 600 },
        { id: 'KB-008', title: 'Managing Your Debit Card', content: 'How to activate, block, or reorder your debit card. Information on ATM withdrawals and daily limits.', category: 'Account Management', tags: ['debit card', 'ATM', 'card management'], lastUpdated: '2024-07-05', author: 'Operations', views: 850 },
    ];

    const [articles, setArticles] = useState<Article[]>(MOCK_KB_ARTICLES);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterCategory, setFilterCategory] = useState<'all' | string>('all');
    const [selectedArticle, setSelectedArticle] = useState<Article | null>(null);
    const { addNotification } = useNotifications();

    const uniqueCategories = useMemo(() => {
        const categories = new Set(MOCK_KB_ARTICLES.map(a => a.category));
        return ['all', ...Array.from(categories)];
    }, []);

    const filteredArticles = useMemo(() => {
        return articles.filter(article => {
            const matchesSearch = article.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                article.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
                article.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));
            const matchesCategory = filterCategory === 'all' || article.category === filterCategory;
            return matchesSearch && matchesCategory;
        });
    }, [articles, searchTerm, filterCategory]);

    const handleSaveArticle = async (article: Article) => {
        if (selectedArticle) {
            const updatedArticles = articles.map(a => a.id === article.id ? article : a);
            await mockApiCall(updatedArticles, 300);
            setArticles(updatedArticles);
            addNotification(`Article "${article.title}" updated.`, 'success');
        } else {
            const newArticle = { ...article, id: `KB-${generateUUID().substring(0, 4).toUpperCase()}`, author: 'Current Agent', lastUpdated: new Date().toISOString(), views: 0 };
            await mockApiCall([...articles, newArticle], 300);
            setArticles(prev => [...prev, newArticle]);
            addNotification(`Article "${newArticle.title}" added.`, 'success');
        }
        setSelectedArticle(null);
    };

    const handleDeleteArticle = async (id: string) => {
        if (window.confirm('Are you sure you want to delete this article?')) {
            const updatedArticles = articles.filter(a => a.id !== id);
            await mockApiCall(updatedArticles, 300);
            setArticles(updatedArticles);
            addNotification('Article deleted.', 'success');
        }
    };

    const ArticleModal: React.FC<{
        isOpen: boolean;
        onClose: () => void;
        article: Article | null;
        onSave: (article: Article) => void;
    }> = ({ isOpen, onClose, article, onSave }) => {
        const [formData, setFormData] = useState<Article>(article || {
            id: '', title: '', content: '', category: '', tags: [], lastUpdated: '', author: '', views: 0
        });

        useEffect(() => {
            setFormData(article || {
                id: '', title: '', content: '', category: uniqueCategories[1] as string, tags: [], lastUpdated: '', author: '', views: 0
            });
        }, [article, uniqueCategories]);

        if (!isOpen) return null;

        const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
            const { name, value } = e.target;
            if (name === 'tags') {
                setFormData({ ...formData, tags: value.split(',').map(k => k.trim()).filter(k => k) });
            } else {
                setFormData({ ...formData, [name]: value });
            }
        };

        const handleSubmit = (e: React.FormEvent) => {
            e.preventDefault();
            onSave(formData);
        };

        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                <div className="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full border border-gray-700" onClick={e => e.stopPropagation()}>
                    <form onSubmit={handleSubmit}>
                        <div className="p-4 border-b border-gray-700">
                            <h3 className="text-lg font-semibold text-white">{article ? 'Edit Knowledge Base Article' : 'Create New Article'}</h3>
                        </div>
                        <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Title</label>
                                <input type="text" name="title" value={formData.title} onChange={handleChange} required className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Content</label>
                                <textarea name="content" value={formData.content} onChange={handleChange} required rows={10} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Category</label>
                                <select name="category" value={formData.category} onChange={handleChange} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500">
                                    {uniqueCategories.filter(cat => cat !== 'all').map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-1">Tags (comma-separated)</label>
                                <input type="text" name="tags" value={formData.tags.join(', ')} onChange={handleChange} className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500" />
                            </div>
                        </div>
                        <div className="p-4 bg-gray-900/50 border-t border-gray-700 flex justify-end space-x-3">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg">Cancel</button>
                            <button type="submit" className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-sm rounded-lg">Save Article</button>
                        </div>
                    </form>
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Knowledge Base Management</h2>
            <Card>
                <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <input
                        type="text"
                        placeholder="Search articles..."
                        className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 w-full md:w-64 focus:ring-cyan-500 focus:border-cyan-500"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <div className="flex space-x-2">
                        <label htmlFor="kb-category" className="sr-only">Filter by Category</label>
                        <select
                            id="kb-category"
                            value={filterCategory}
                            onChange={(e) => setFilterCategory(e.target.value)}
                            className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 text-sm focus:ring-cyan-500 focus:border-cyan-500"
                        >
                            {uniqueCategories.map(cat => (
                                <option key={cat} value={cat}>{cat === 'all' ? 'All Categories' : cat}</option>
                            ))}
                        </select>
                    </div>
                    <button
                        onClick={() => { setSelectedArticle(null); setSelectedArticle(null); }} // Clear selection to create new
                        className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg"
                    >
                        Add New Article
                    </button>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th className="px-6 py-3">Title</th>
                                <th className="px-6 py-3">Category</th>
                                <th className="px-6 py-3">Tags</th>
                                <th className="px-6 py-3">Last Updated</th>
                                <th className="px-6 py-3">Views</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredArticles.map(article => (
                                <tr key={article.id} className="border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer" onClick={() => setSelectedArticle(article)}>
                                    <td className="px-6 py-4 font-medium text-white">{article.title}</td>
                                    <td className="px-6 py-4">{article.category}</td>
                                    <td className="px-6 py-4 text-xs">{article.tags.join(', ')}</td>
                                    <td className="px-6 py-4 text-xs">{formatDate(article.lastUpdated, { dateStyle: 'short' })}</td>
                                    <td className="px-6 py-4">{article.views}</td>
                                    <td className="px-6 py-4" onClick={e => e.stopPropagation()}> {/* Prevent row click from triggering modal */}
                                        <button
                                            onClick={() => setSelectedArticle(article)}
                                            className="text-cyan-400 hover:text-cyan-300 text-sm mr-2"
                                        >
                                            View/Edit
                                        </button>
                                        <button
                                            onClick={() => handleDeleteArticle(article.id)}
                                            className="text-red-400 hover:text-red-300 text-sm"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
            {selectedArticle && (
                <ArticleModal
                    isOpen={!!selectedArticle}
                    onClose={() => setSelectedArticle(null)}
                    article={selectedArticle}
                    onSave={handleSaveArticle}
                />
            )}
        </div>
    );
};

export const SettingsView: React.FC = () => {
    const { addNotification } = useNotifications();
    const [settings, setSettings] = useState({
        emailNotifications: true,
        darkMode: true,
        autoAssignNewTickets: false,
        defaultSLA: 'SLA-002', // Default to High Priority SLA
        replyTemplateHeader: "Dear [CUSTOMER_NAME],\n\n",
        replyTemplateFooter: "\n\nBest regards,\n[AGENT_NAME] - Demo Bank Support"
    });
    const [isSaving, setIsSaving] = useState(false);

    const handleSettingChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type, checked } = e.target;
        setSettings(prev => ({
            ...prev,
            [name]: type === 'checkbox' ? checked : value
        }));
    };

    const handleSaveSettings = async () => {
        setIsSaving(true);
        try {
            await mockApiCall(settings, 1000); // Simulate API call
            addNotification('Settings saved successfully!', 'success');
        } catch (error) {
            addNotification('Failed to save settings.', 'error');
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">System Settings</h2>
            <Card title="General Settings">
                <div className="space-y-4">
                    <div className="flex items-center justify-between">
                        <label htmlFor="emailNotifications" className="text-sm text-gray-300">Email Notifications</label>
                        <input
                            type="checkbox"
                            name="emailNotifications"
                            id="emailNotifications"
                            checked={settings.emailNotifications}
                            onChange={handleSettingChange}
                            className="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-600 rounded"
                        />
                    </div>
                    <div className="flex items-center justify-between">
                        <label htmlFor="darkMode" className="text-sm text-gray-300">Dark Mode (UI Preference)</label>
                        <input
                            type="checkbox"
                            name="darkMode"
                            id="darkMode"
                            checked={settings.darkMode}
                            onChange={handleSettingChange}
                            className="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-600 rounded"
                        />
                    </div>
                    <div className="flex items-center justify-between">
                        <label htmlFor="autoAssignNewTickets" className="text-sm text-gray-300">Auto-assign New Tickets</label>
                        <input
                            type="checkbox"
                            name="autoAssignNewTickets"
                            id="autoAssignNewTickets"
                            checked={settings.autoAssignNewTickets}
                            onChange={handleSettingChange}
                            className="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-600 rounded"
                        />
                    </div>
                    <div>
                        <label htmlFor="defaultSLA" className="block text-sm font-medium text-gray-300 mb-1">Default SLA for Uncategorized Tickets</label>
                        <select
                            name="defaultSLA"
                            id="defaultSLA"
                            value={settings.defaultSLA}
                            onChange={handleSettingChange}
                            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"
                        >
                            {MOCK_SLA_RULES.map(rule => (
                                <option key={rule.id} value={rule.id}>{rule.name} ({rule.priority})</option>
                            ))}
                        </select>
                    </div>
                </div>
            </Card>

            <Card title="Email Reply Templates">
                <div className="space-y-4">
                    <div>
                        <label htmlFor="replyTemplateHeader" className="block text-sm font-medium text-gray-300 mb-1">Reply Template Header</label>
                        <textarea
                            name="replyTemplateHeader"
                            id="replyTemplateHeader"
                            value={settings.replyTemplateHeader}
                            onChange={handleSettingChange}
                            rows={4}
                            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"
                        ></textarea>
                        <p className="text-xs text-gray-500 mt-1">Use [CUSTOMER_NAME] and [AGENT_NAME] for placeholders.</p>
                    </div>
                    <div>
                        <label htmlFor="replyTemplateFooter" className="block text-sm font-medium text-gray-300 mb-1">Reply Template Footer</label>
                        <textarea
                            name="replyTemplateFooter"
                            id="replyTemplateFooter"
                            value={settings.replyTemplateFooter}
                            onChange={handleSettingChange}
                            rows={4}
                            className="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 focus:ring-cyan-500 focus:border-cyan-500"
                        ></textarea>
                    </div>
                </div>
            </Card>

            <div className="flex justify-end">
                <button
                    onClick={handleSaveSettings}
                    disabled={isSaving}
                    className="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white text-base font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {isSaving ? 'Saving...' : 'Save Settings'}
                </button>
            </div>
        </div>
    );
};


// ================================================================================================
// MAIN VIEW COMPONENT
// ================================================================================================

export const SupportDeskView: React.FC = () => {
    const [tickets, setTickets] = useState<SupportTicket[]>(MOCK_ALL_TICKETS);
    const [filterStatus, setFilterStatus] = useState<TicketStatus | 'all'>('Open');
    const [filterPriority, setFilterPriority] = useState<TicketPriority | 'all'>('all');
    const [filterAgent, setFilterAgent] = useState<string | 'all'>('all'); // Agent ID or 'all'
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedTicket, setSelectedTicket] = useState<SupportTicket | null>(null);
    const [currentPage, setCurrentPage] = useState(1);
    const [ticketsPerPage] = useState(15);

    const [currentMainView, setCurrentMainView] = useState<MainView>('Dashboard');

    const { addNotification } = useNotifications();
    const { currentUser } = useAuth();

    const handleUpdateTicket = useCallback((updatedTicket: SupportTicket) => {
        setTickets(prevTickets =>
            prevTickets.map(t => (t.id === updatedTicket.id ? updatedTicket : t))
        );
        addNotification(`Ticket ${updatedTicket.id} updated.`, 'info');
    }, [addNotification]);

    const filteredAndSortedTickets = useMemo(() => {
        let currentTickets = tickets;

        // Apply search term
        if (searchTerm) {
            currentTickets = currentTickets.filter(t =>
                t.subject.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                t.userName.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }

        // Apply status filter
        if (filterStatus !== 'all') {
            currentTickets = currentTickets.filter(t => t.status === filterStatus);
        }

        // Apply priority filter
        if (filterPriority !== 'all') {
            currentTickets = currentTickets.filter(t => t.priority === filterPriority);
        }

        // Apply agent filter
        if (filterAgent !== 'all') {
            currentTickets = currentTickets.filter(t => t.assignedAgentId === filterAgent);
        }

        // Sort (e.g., by last update, newest first)
        currentTickets.sort((a, b) => new Date(b.lastUpdate).getTime() - new Date(a.lastUpdate).getTime());

        return currentTickets;
    }, [tickets, searchTerm, filterStatus, filterPriority, filterAgent]);

    // Pagination logic
    const indexOfLastTicket = currentPage * ticketsPerPage;
    const indexOfFirstTicket = indexOfLastTicket - ticketsPerPage;
    const currentTicketsPaginated = filteredAndSortedTickets.slice(indexOfFirstTicket, indexOfLastTicket);
    const totalPages = Math.ceil(filteredAndSortedTickets.length / ticketsPerPage);

    const paginate = (pageNumber: number) => setCurrentPage(pageNumber);

    const kpiData = useMemo(() => ({
        openTickets: tickets.filter(t => t.status === 'Open').length,
        pendingTickets: tickets.filter(t => t.status === 'Pending').length,
        resolvedToday: tickets.filter(t => (t.status === 'Resolved' || t.status === 'Closed') && new Date(t.lastUpdate).toDateString() === new Date().toDateString()).length,
        avgResponseTime: '2.5h', // Mocked, would be calculated from real data
        satisfaction: '95%', // Mocked
        slaBreaches: tickets.filter(t => t.sla.breached).length,
    }), [tickets]);

    const renderMainContent = () => {
        switch (currentMainView) {
            case 'Dashboard':
                return (
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-white tracking-wider">Dashboard</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                            <Card className="text-center"><p className="text-3xl font-bold text-red-400">{kpiData.openTickets}</p><p className="text-sm text-gray-400 mt-1">Open Tickets</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-yellow-400">{kpiData.pendingTickets}</p><p className="text-sm text-gray-400 mt-1">Pending Customer</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-green-400">{kpiData.resolvedToday}</p><p className="text-sm text-gray-400 mt-1">Resolved Today</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-white">{kpiData.avgResponseTime}</p><p className="text-sm text-gray-400 mt-1">Avg. First Response</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-red-500">{kpiData.slaBreaches}</p><p className="text-sm text-gray-400 mt-1">SLA Breaches</p></Card>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                            <div className="lg:col-span-1 xl:col-span-1">
                                <RecentActivitiesWidget />
                            </div>
                            <div className="lg:col-span-1 xl:col-span-2">
                                <TicketTrendChartWidget />
                            </div>
                        </div>

                        <Card title="Agent Activity Snapshot">
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {MOCK_AGENTS.slice(0, 4).map(agent => (
                                    <AgentPerformanceWidget key={agent.id} agent={agent} />
                                ))}
                            </div>
                            <div className="text-right mt-4">
                                <button onClick={() => setCurrentMainView('Agents')} className="text-cyan-400 hover:underline text-sm">View All Agents & Performance</button>
                            </div>
                        </Card>
                    </div>
                );
            case 'Tickets':
                return (
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-white tracking-wider">Ticket Queue</h2>
                        <Card>
                            <div className="flex flex-wrap items-center gap-4 mb-4">
                                <input
                                    type="text"
                                    placeholder="Search tickets..."
                                    className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 w-full md:w-64 focus:ring-cyan-500 focus:border-cyan-500"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                <div className="flex space-x-1 p-1 bg-gray-900/50 rounded-lg">
                                    {(['all', 'Open', 'Pending', 'Resolved', 'Closed', 'On-Hold'] as const).map(status => (
                                        <button key={status} onClick={() => setFilterStatus(status)} className={`px-3 py-1 text-sm rounded-md ${filterStatus === status ? 'bg-cyan-600' : 'text-gray-300'}`}>{status}</button>
                                    ))}
                                </div>
                                <select
                                    value={filterPriority}
                                    onChange={(e) => setFilterPriority(e.target.value as TicketPriority | 'all')}
                                    className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 text-sm focus:ring-cyan-500 focus:border-cyan-500"
                                >
                                    <option value="all">All Priorities</option>
                                    {(['Low', 'Medium', 'High', 'Urgent'] as TicketPriority[]).map(p => (
                                        <option key={p} value={p}>{p}</option>
                                    ))}
                                </select>
                                <select
                                    value={filterAgent}
                                    onChange={(e) => setFilterAgent(e.target.value)}
                                    className="p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-300 text-sm focus:ring-cyan-500 focus:border-cyan-500"
                                >
                                    <option value="all">All Agents</option>
                                    <option value="">Unassigned</option>
                                    {MOCK_AGENTS.map(agent => (
                                        <option key={agent.id} value={agent.id}>{agent.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-gray-400">
                                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                        <tr>
                                            <th className="px-6 py-3">Subject</th>
                                            <th className="px-6 py-3">User</th>
                                            <th className="px-6 py-3">Status</th>
                                            <th className="px-6 py-3">Priority</th>
                                            <th className="px-6 py-3">Last Update</th>
                                            <th className="px-6 py-3">Agent</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {currentTicketsPaginated.length > 0 ? (
                                            currentTicketsPaginated.map(t => (
                                                <tr key={t.id} onClick={() => setSelectedTicket(t)} className="border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer">
                                                    <td className="px-6 py-4 font-medium text-white max-w-sm truncate">{t.subject}</td>
                                                    <td className="px-6 py-4">{t.userName}</td>
                                                    <td className="px-6 py-4"><StatusBadge status={t.status} /></td>
                                                    <td className="px-6 py-4"><PriorityBadge priority={t.priority} /></td>
                                                    <td className="px-6 py-4">{formatDate(t.lastUpdate, { dateStyle: 'short', timeStyle: 'short' })}</td>
                                                    <td className="px-6 py-4">{t.assignedAgentName || 'Unassigned'}</td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan={6} className="px-6 py-4 text-center text-gray-500">No tickets matching your criteria.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            {/* Pagination controls */}
                            {filteredAndSortedTickets.length > ticketsPerPage && (
                                <div className="flex justify-center mt-4 space-x-2">
                                    <button
                                        onClick={() => paginate(currentPage - 1)}
                                        disabled={currentPage === 1}
                                        className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-gray-300 disabled:opacity-50"
                                    >
                                        Previous
                                    </button>
                                    {Array.from({ length: totalPages }, (_, i) => i + 1).map(number => (
                                        <button
                                            key={number}
                                            onClick={() => paginate(number)}
                                            className={`px-3 py-1 rounded-md text-sm ${currentPage === number ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                        >
                                            {number}
                                        </button>
                                    ))}
                                    <button
                                        onClick={() => paginate(currentPage + 1)}
                                        disabled={currentPage === totalPages}
                                        className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-md text-gray-300 disabled:opacity-50"
                                    >
                                        Next
                                    </button>
                                </div>
                            )}
                        </Card>
                    </div>
                );
            case 'Agents':
                return <AgentsManagementView />;
            case 'Customers':
                return <CustomersManagementView />;
            case 'CannedResponses':
                return <CannedResponsesManagementView />;
            case 'SLARules':
                return <SLARulesManagementView />;
            case 'Reports':
                return <ReportsView />;
            case 'KnowledgeBase':
                return <KnowledgeBaseView />;
            case 'Settings':
                return <SettingsView />;
            default:
                return <p className="text-white">Select a view from the sidebar.</p>;
        }
    };

    return (
        <NotificationProvider>
            <AuthProvider>
                <div className="flex min-h-screen bg-gray-900 text-gray-100">
                    <MainSidebar currentView={currentMainView} onSelectView={setCurrentMainView} />
                    <main className="flex-grow p-6 overflow-y-auto">
                        {renderMainContent()}
                    </main>
                </div>
                <TicketDetailModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} onUpdateTicket={handleUpdateTicket} />
            </AuthProvider>
        </NotificationProvider>
    );
};

export default SupportDeskView;

--- FILE: UserInsightsView.tsx ---

// components/views/megadashboard/userclient/UserInsightsView.tsx
// This component has been architected as a comprehensive user insights dashboard.
// It features multiple complex charts using the Recharts library to visualize
// key business metrics like user growth, cohort engagement, churn, and satisfaction.
// The code is intentionally detailed to represent a production-quality analytics view.

import React, { useState, useEffect, useReducer, useMemo, useCallback } from 'react';
import Card from '../../../Card';
import { AreaChart, Area, BarChart, Bar, LineChart, Line, RadialBarChart, RadialBar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, Funnel, FunnelChart, LabelList, Treemap } from 'recharts';

// ================================================================================================
// MOCK DATA FOR CHARTS (Original)
// ================================================================================================

const userGrowthData = [
    { name: 'Jan', users: 4000 }, { name: 'Feb', users: 4300 },
    { name: 'Mar', users: 5000 }, { name: 'Apr', users: 5800 },
    { name: 'May', users: 6500 }, { name: 'Jun', users: 7800 },
];

const engagementByCohortData = [
    { cohort: 'Jan \'24', w1: 85, w2: 72, w3: 65, w4: 60 },
    { cohort: 'Feb \'24', w1: 88, w2: 78, w3: 70, w4: 68 },
    { cohort: 'Mar \'24', w1: 92, w2: 85, w3: 80, w4: 78 },
    { cohort: 'Apr \'24', w1: 90, w2: 82, w3: 75, w4: 71 },
];

const churnPredictionData = [
    { month: 'Jul', actual: 2.1, predicted: 2.2 },
    { month: 'Aug', actual: 2.3, predicted: 2.3 },
    { month: 'Sep', actual: 2.2, predicted: 2.4 },
    { month: 'Oct', predicted: 2.5 },
    { month: 'Nov', predicted: 2.6 },
];

const userSatisfactionData = [
    { name: 'CSAT', value: 91, fill: '#10b981' },
    { name: 'NPS', value: 65, fill: '#06b6d4' },
    { name: 'CES', value: 85, fill: '#6366f1' },
];

// ================================================================================================
// AI INSIGHTS (STATIC MOCK) (Original)
// ================================================================================================

const aiInsights = [
    "The March '24 cohort shows significantly higher week-over-week retention. Investigate marketing campaigns from that period.",
    "Predicted churn is trending upwards for Q4. Proactive retention campaigns are recommended for at-risk user segments.",
    "User growth is accelerating, but the average Customer Effort Score (CES) has slightly decreased. Monitor support tickets for friction points."
];


// ================================================================================================
// NEW - ADVANCED TYPESCRIPT INTERFACES
// ================================================================================================

export type DateRange = '7d' | '30d' | '90d' | '12m' | 'all';
export type UserSegment = 'all' | 'new' | 'power' | 'at_risk' | 'churned';
export type Region = 'all' | 'NA' | 'EU' | 'APAC' | 'LATAM';

export interface DashboardFilters {
    dateRange: DateRange;
    userSegment: UserSegment;
    region: Region;
}

export interface UserDemographics {
    age: { '18-24': number; '25-34': number; '35-44': number; '45-54': number; '55+': number; };
    gender: { male: number; female: number; other: number; };
    location: { name: string; value: number }[];
}

export interface AcquisitionChannel {
    channel: string;
    visitors: number;
    signups: number;
    paid: number;
    cost: number;
}

export interface FeatureAdoption {
    feature: string;
    adoptionRate: number;
    avgTimeSpent: number; // in minutes
}

export interface UserFeedback {
    id: string;
    timestamp: string;
    user: string;
    sentiment: 'positive' | 'neutral' | 'negative';
    comment: string;
    tags: string[];
}

export interface DetailedUser {
    id: string;
    name: string;
    email: string;
    region: Region;
    segment: UserSegment;
    signupDate: string;
    lastSeen: string;
    ltv: number;
    healthScore: number;
}

export interface LtvCacDataPoint {
    month: string;
    ltv: number;
    cac: number;
}

export interface SubscriptionTier {
    name: 'Free' | 'Pro' | 'Enterprise';
    count: number;
    mrr: number;
}

export interface ABTestResult {
    testName: string;
    variantA_conversions: number;
    variantA_users: number;
    variantB_conversions: number;
    variantB_users: number;
    significance: number;
    winner: 'A' | 'B' | null;
}

export interface FullDashboardData {
    kpis: {
        totalActiveUsers: number;
        mauPercentage: number;
        ltv: number;
        monthlyChurn: number;
        dau: number;
        wou: number;
        arppu: number;
        cac: number;
    };
    userGrowth: { name: string; users: number }[];
    engagementByCohort: { cohort: string; w1: number; w2: number; w3: number; w4: number }[];
    churnPrediction: { month: string; actual?: number; predicted: number }[];
    userSatisfaction: { name: string; value: number; fill: string }[];
    demographics: UserDemographics;
    acquisitionChannels: AcquisitionChannel[];
    featureAdoption: FeatureAdoption[];
    recentFeedback: UserFeedback[];
    detailedUsers: DetailedUser[];
    ltvCac: LtvCacDataPoint[];
    subscriptionTiers: SubscriptionTier[];
    abTests: ABTestResult[];
}

export interface DashboardState {
    loading: boolean;
    error: string | null;
    filters: DashboardFilters;
    data: FullDashboardData | null;
}

export type DashboardAction =
    | { type: 'FETCH_START' }
    | { type: 'FETCH_SUCCESS'; payload: FullDashboardData }
    | { type: 'FETCH_ERROR'; payload: string }
    | { type: 'SET_FILTERS'; payload: Partial<DashboardFilters> };

// ================================================================================================
// NEW - UTILITY & FORMATTING FUNCTIONS
// ================================================================================================

/**
 * Formats a number as currency.
 * @param value The number to format.
 * @returns A string representing the currency.
 */
export const formatCurrency = (value: number): string => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
};

/**
 * Formats a number as a percentage.
 * @param value The number to format (e.g., 0.85 for 85%).
 * @param decimals The number of decimal places.
 * @returns A string representing the percentage.
 */
export const formatPercentage = (value: number, decimals: number = 1): string => {
    return `${(value * 100).toFixed(decimals)}%`;
};

/**
 * Generates a random integer within a given range.
 * @param min The minimum value.
 * @param max The maximum value.
 * @returns A random integer.
 */
export const getRandomInt = (min: number, max: number): number => {
    return Math.floor(Math.random() * (max - min + 1)) + min;
};

/**
 * A simple debounce function.
 * @param func The function to debounce.
 * @param delay The debounce delay in milliseconds.
 * @returns A debounced function.
 */
export const debounce = <T extends (...args: any[]) => any>(func: T, delay: number): ((...args: Parameters<T>) => void) => {
    let timeout: NodeJS.Timeout;
    return (...args: Parameters<T>) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
    };
};

// ================================================================================================
// NEW - MOCK DATA GENERATION
// ================================================================================================

const REGIONS: Region[] = ['NA', 'EU', 'APAC', 'LATAM'];
const SEGMENTS: UserSegment[] = ['new', 'power', 'at_risk', 'churned'];
const FIRST_NAMES = ['John', 'Jane', 'Alex', 'Emily', 'Chris', 'Katie', 'Michael', 'Sarah'];
const LAST_NAMES = ['Smith', 'Doe', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller'];
const FEATURES = ['Dashboard', 'Reporting', 'Integrations', 'Team Management', 'API Access', 'Custom Fields'];

/**
 * Generates realistic-looking mock data for the entire dashboard.
 * @param filters The current dashboard filters to apply.
 * @returns A complete set of dashboard data.
 */
export const generateMockData = (filters: DashboardFilters): FullDashboardData => {
    // This function can be extremely complex to simulate real data filtering on the backend.
    const baseUserCount = 12500;
    const filterMultiplier = (filters.region === 'all' ? 1 : 0.4) * (filters.userSegment === 'all' ? 1 : 0.3);
    const userCount = Math.floor(baseUserCount * filterMultiplier);

    const generatedUserGrowth = Array.from({ length: 12 }, (_, i) => {
        const month = new Date(2023, i, 1).toLocaleString('default', { month: 'short' });
        return { name: month, users: Math.floor(userCount * (0.6 + i * 0.04) * (1 + (Math.random() - 0.5) * 0.1)) };
    });

    const generatedDemographics: UserDemographics = {
        age: { '18-24': getRandomInt(15, 25), '25-34': getRandomInt(30, 40), '35-44': getRandomInt(20, 30), '45-54': getRandomInt(10, 15), '55+': getRandomInt(5, 10) },
        gender: { male: getRandomInt(45, 55), female: getRandomInt(40, 50), other: getRandomInt(1, 5) },
        location: [{ name: 'USA', value: 400 }, { name: 'Germany', value: 250 }, { name: 'UK', value: 200 }, { name: 'Japan', value: 150 }, { name: 'Brazil', value: 120 }, { name: 'India', value: 100 }]
    };

    const generatedAcquisitionChannels: AcquisitionChannel[] = [
        { channel: 'Organic Search', visitors: getRandomInt(18000, 22000), signups: getRandomInt(800, 1200), paid: getRandomInt(200, 300), cost: 0 },
        { channel: 'Paid Social', visitors: getRandomInt(12000, 15000), signups: getRandomInt(1000, 1400), paid: getRandomInt(300, 400), cost: 25000 },
        { channel: 'Referral', visitors: getRandomInt(8000, 10000), signups: getRandomInt(1200, 1600), paid: getRandomInt(400, 500), cost: 5000 },
        { channel: 'Direct', visitors: getRandomInt(5000, 7000), signups: getRandomInt(400, 600), paid: getRandomInt(150, 250), cost: 0 },
        { channel: 'Email Marketing', visitors: getRandomInt(20000, 25000), signups: getRandomInt(600, 900), paid: getRandomInt(250, 350), cost: 8000 },
    ];
    
    const generatedFeatureAdoption: FeatureAdoption[] = FEATURES.map(f => ({
        feature: f,
        adoptionRate: getRandomInt(20, 95),
        avgTimeSpent: getRandomInt(5, 60)
    }));
    
    const generatedRecentFeedback: UserFeedback[] = Array.from({ length: 20 }, (_, i) => {
        const sentimentVal = Math.random();
        return {
            id: `feedback-${i}`,
            timestamp: new Date(Date.now() - i * 3600000).toISOString(),
            user: `${FIRST_NAMES[getRandomInt(0, 7)]} ${LAST_NAMES[getRandomInt(0, 7)][0]}.`,
            sentiment: sentimentVal > 0.7 ? 'positive' : sentimentVal < 0.3 ? 'negative' : 'neutral',
            comment: `This is a sample user comment number ${i + 1}. The new feature is ${sentimentVal > 0.5 ? 'great' : 'a bit confusing'}.`,
            tags: ['ui', 'performance']
        };
    });

    const generatedDetailedUsers: DetailedUser[] = Array.from({ length: 100 }, (_, i) => ({
        id: `user-${1000 + i}`,
        name: `${FIRST_NAMES[getRandomInt(0, 7)]} ${LAST_NAMES[getRandomInt(0, 7)]}`,
        email: `user${i}@example.com`,
        region: REGIONS[getRandomInt(0, 3)],
        segment: SEGMENTS[getRandomInt(0, 3)],
        signupDate: new Date(Date.now() - getRandomInt(30, 365) * 86400000).toISOString().split('T')[0],
        lastSeen: new Date(Date.now() - getRandomInt(1, 45) * 86400000).toISOString().split('T')[0],
        ltv: getRandomInt(50, 1500),
        healthScore: getRandomInt(20, 100),
    }));

    const generatedLtvCac: LtvCacDataPoint[] = Array.from({length: 12}, (_, i) => {
        const month = new Date(2023, i, 1).toLocaleString('default', { month: 'short' });
        return {
            month,
            ltv: getRandomInt(100 + i*5, 120 + i*8),
            cac: getRandomInt(70 - i*2, 80 - i*2.5)
        }
    });

    const generatedSubscriptionTiers: SubscriptionTier[] = [
        { name: 'Free', count: Math.floor(userCount * 0.6), mrr: 0 },
        { name: 'Pro', count: Math.floor(userCount * 0.3), mrr: Math.floor(userCount * 0.3) * 25 },
        { name: 'Enterprise', count: Math.floor(userCount * 0.1), mrr: Math.floor(userCount * 0.1) * 150 }
    ];

    const generatedABTests: ABTestResult[] = [
        { testName: 'New Onboarding Flow', variantA_conversions: 450, variantA_users: 1000, variantB_conversions: 520, variantB_users: 1000, significance: 98.5, winner: 'B'},
        { testName: 'Homepage CTA Button Color', variantA_conversions: 1203, variantA_users: 10000, variantB_conversions: 1215, variantB_users: 10000, significance: 60.1, winner: null },
        { testName: 'Pricing Page Layout', variantA_conversions: 88, variantA_users: 500, variantB_conversions: 121, variantB_users: 500, significance: 99.8, winner: 'B' },
    ];
    
    return {
        kpis: {
            totalActiveUsers: userCount,
            mauPercentage: 85,
            ltv: 125,
            monthlyChurn: 2.2,
            dau: Math.floor(userCount * 0.35),
            wou: Math.floor(userCount * 0.60),
            arppu: 42,
            cac: 78,
        },
        userGrowth: generatedUserGrowth,
        engagementByCohort,
        churnPrediction,
        userSatisfaction,
        demographics: generatedDemographics,
        acquisitionChannels: generatedAcquisitionChannels,
        featureAdoption: generatedFeatureAdoption,
        recentFeedback: generatedRecentFeedback,
        detailedUsers: generatedDetailedUsers,
        ltvCac: generatedLtvCac,
        subscriptionTiers: generatedSubscriptionTiers,
        abTests: generatedABTests,
    };
};

// ================================================================================================
// NEW - SIMULATED API CLIENT
// ================================================================================================

/**
 * A mock API client to simulate network requests.
 */
export class ApiClient {
    /**
     * Fetches the complete dashboard data.
     * @param filters The filters to apply to the data query.
     * @returns A promise that resolves with the full dashboard data.
     */
    static fetchUserInsightsData(filters: DashboardFilters): Promise<FullDashboardData> {
        console.log('Fetching data with filters:', filters);
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (Math.random() < 0.05) { // 5% chance of API failure
                    reject(new Error('Failed to fetch user insights. A transient network error occurred.'));
                } else {
                    resolve(generateMockData(filters));
                }
            }, getRandomInt(500, 1500)); // Simulate network latency
        });
    }
}

// ================================================================================================
// NEW - STATE MANAGEMENT (useReducer)
// ================================================================================================

export const initialState: DashboardState = {
    loading: true,
    error: null,
    filters: {
        dateRange: '30d',
        userSegment: 'all',
        region: 'all',
    },
    data: null,
};

/**
 * Reducer function for managing the dashboard's state.
 * @param state The current state.
 * @param action The dispatched action.
 * @returns The new state.
 */
export function dashboardReducer(state: DashboardState, action: DashboardAction): DashboardState {
    switch (action.type) {
        case 'FETCH_START':
            return { ...state, loading: true, error: null };
        case 'FETCH_SUCCESS':
            return { ...state, loading: false, data: action.payload };
        case 'FETCH_ERROR':
            return { ...state, loading: false, error: action.payload };
        case 'SET_FILTERS':
            return { ...state, filters: { ...state.filters, ...action.payload } };
        default:
            return state;
    }
}

// ================================================================================================
// NEW - CUSTOM SUB-COMPONENTS
// ================================================================================================

export interface CustomTooltipProps {
    active?: boolean;
    payload?: any[];
    label?: string;
}

/**
 * A custom tooltip component for Recharts to match the dashboard's theme.
 */
export const CustomTooltip: React.FC<CustomTooltipProps> = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        return (
            <div className="p-3 bg-gray-800 bg-opacity-90 border border-gray-600 rounded-lg shadow-lg">
                <p className="label text-gray-300 font-bold">{`${label}`}</p>
                {payload.map((p, index) => (
                    <p key={index} style={{ color: p.color }} className="intro">
                        {`${p.name}: ${p.value.toLocaleString()}${p.unit || ''}`}
                    </p>
                ))}
            </div>
        );
    }
    return null;
};

/**
 * A component to display filter controls for the dashboard.
 */
export const FilterBar: React.FC<{ filters: DashboardFilters; onFilterChange: (filters: Partial<DashboardFilters>) => void; disabled: boolean }> = ({ filters, onFilterChange, disabled }) => {
    const commonSelectClasses = "bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 transition-colors disabled:opacity-50";

    return (
        <Card>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label htmlFor="dateRange" className="block mb-2 text-sm font-medium text-gray-300">Date Range</label>
                    <select id="dateRange" value={filters.dateRange} onChange={e => onFilterChange({ dateRange: e.target.value as DateRange })} className={commonSelectClasses} disabled={disabled}>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                        <option value="12m">Last 12 Months</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div>
                    <label htmlFor="userSegment" className="block mb-2 text-sm font-medium text-gray-300">User Segment</label>
                    <select id="userSegment" value={filters.userSegment} onChange={e => onFilterChange({ userSegment: e.target.value as UserSegment })} className={commonSelectClasses} disabled={disabled}>
                        <option value="all">All Segments</option>
                        <option value="new">New Users</option>
                        <option value="power">Power Users</option>
                        <option value="at_risk">At Risk</option>
                        <option value="churned">Churned</option>
                    </select>
                </div>
                <div>
                    <label htmlFor="region" className="block mb-2 text-sm font-medium text-gray-300">Region</label>
                    <select id="region" value={filters.region} onChange={e => onFilterChange({ region: e.target.value as Region })} className={commonSelectClasses} disabled={disabled}>
                        <option value="all">All Regions</option>
                        <option value="NA">North America</option>
                        <option value="EU">Europe</option>
                        <option value="APAC">Asia-Pacific</option>
                        <option value="LATAM">Latin America</option>
                    </select>
                </div>
            </div>
        </Card>
    );
};

const PIE_CHART_COLORS = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6'];

/**
 * A component for rendering user demographics charts.
 */
export const DemographicsCharts: React.FC<{ data: UserDemographics }> = ({ data }) => {
    const ageData = Object.entries(data.age).map(([name, value]) => ({ name, value }));
    const genderData = Object.entries(data.gender).map(([name, value]) => ({ name, value }));
    
    return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card title="Age Distribution" className="md:col-span-1">
                <ResponsiveContainer width="100%" height={250}>
                    <PieChart>
                        <Pie data={ageData} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} label>
                            {ageData.map((entry, index) => <Cell key={`cell-${index}`} fill={PIE_CHART_COLORS[index % PIE_CHART_COLORS.length]} />)}
                        </Pie>
                        <Tooltip content={<CustomTooltip />} />
                        <Legend />
                    </PieChart>
                </ResponsiveContainer>
            </Card>
            <Card title="Gender Distribution" className="md:col-span-1">
                 <ResponsiveContainer width="100%" height={250}>
                    <PieChart>
                        <Pie data={genderData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={40} outerRadius={80} paddingAngle={5}>
                             {genderData.map((entry, index) => <Cell key={`cell-${index}`} fill={PIE_CHART_COLORS[index % PIE_CHART_COLORS.length]} />)}
                        </Pie>
                        <Tooltip content={<CustomTooltip />} />
                        <Legend />
                    </PieChart>
                </ResponsiveContainer>
            </Card>
             <Card title="Top Locations" className="md:col-span-1">
                 <ResponsiveContainer width="100%" height={250}>
                    <Treemap
                        data={data.location}
                        dataKey="value"
                        ratio={4 / 3}
                        stroke="#fff"
                        fill="#8884d8"
                        content={<CustomizedTreeMapContent colors={PIE_CHART_COLORS} />}
                    />
                    <Tooltip content={<CustomTooltip />} />
                </ResponsiveContainer>
            </Card>
        </div>
    );
};

export const CustomizedTreeMapContent: React.FC<any> = ({ root, depth, x, y, width, height, index, colors, name }) => {
    return (
        <g>
            <rect
                x={x}
                y={y}
                width={width}
                height={height}
                style={{
                    fill: depth === 1 ? colors[index % colors.length] : 'none',
                    stroke: '#fff',
                    strokeWidth: 2 / (depth + 1e-10),
                    strokeOpacity: 1 / (depth + 1e-10),
                }}
            />
            {depth === 1 && width > 50 && height > 25 ? (
                <text x={x + width / 2} y={y + height / 2 + 7} textAnchor="middle" fill="#fff" fontSize={14}>
                    {name}
                </text>
            ) : null}
        </g>
    );
};

/**
 * A funnel chart to visualize user acquisition channels.
 */
export const AcquisitionFunnelChart: React.FC<{ data: AcquisitionChannel[] }> = ({ data }) => {
    const funnelData = [
        { value: data.reduce((sum, item) => sum + item.visitors, 0), name: 'Visitors', fill: '#6366f1' },
        { value: data.reduce((sum, item) => sum + item.signups, 0), name: 'Signups', fill: '#3b82f6' },
        { value: data.reduce((sum, item) => sum + item.paid, 0), name: 'Paid Users', fill: '#10b981' },
    ];

    return (
        <Card title="Acquisition Funnel">
            <ResponsiveContainer width="100%" height={300}>
                <FunnelChart>
                    <Tooltip content={<CustomTooltip />} />
                    <Funnel dataKey="value" data={funnelData} isAnimationActive>
                        <LabelList position="right" fill="#fff" stroke="none" dataKey="name" />
                        <LabelList position="center" fill="#000" stroke="none" dataKey="value" formatter={(value: number) => value.toLocaleString()} />
                    </Funnel>
                </FunnelChart>
            </ResponsiveContainer>
        </Card>
    );
};

/**
 * A bar chart to show performance of different acquisition channels.
 */
export const AcquisitionChannelPerformance: React.FC<{ data: AcquisitionChannel[] }> = ({ data }) => {
    const processedData = data.map(item => ({
        ...item,
        cpa: item.cost > 0 && item.paid > 0 ? item.cost / item.paid : 0,
        signupRate: item.visitors > 0 ? item.signups / item.visitors : 0
    }));

    return (
        <Card title="Channel Performance (CPA & Signup Rate)">
            <ResponsiveContainer width="100%" height={300}>
                <BarChart data={processedData} layout="vertical">
                    <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                    <XAxis type="number" stroke="#9ca3af" />
                    <YAxis type="category" dataKey="channel" stroke="#9ca3af" width={120} />
                    <Tooltip content={<CustomTooltip />} />
                    <Legend />
                    <Bar dataKey="cpa" fill="#ef4444" name="Cost Per Acquisition ($)" />
                    <Bar dataKey="signupRate" fill="#06b6d4" name="Signup Rate (%)" formatter={(value: number) => value.toFixed(2)} />
                </BarChart>
            </ResponsiveContainer>
        </Card>
    )
}

/**
 * A component to visualize feature adoption rates.
 */
export const FeatureAdoptionChart: React.FC<{ data: FeatureAdoption[] }> = ({ data }) => {
    return (
        <Card title="Feature Adoption & Engagement">
            <ResponsiveContainer width="100%" height={400}>
                <BarChart data={data} layout="vertical" margin={{ top: 20, right: 30, left: 100, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                    <XAxis type="number" stroke="#9ca3af" unit="%" domain={[0, 100]} />
                    <YAxis dataKey="feature" type="category" stroke="#9ca3af" />
                    <Tooltip content={<CustomTooltip />} />
                    <Legend />
                    <Bar dataKey="adoptionRate" name="Adoption Rate" fill="#8884d8" />
                </BarChart>
            </ResponsiveContainer>
        </Card>
    );
};


/**
 * A component displaying a real-time feed of user feedback.
 */
export const UserFeedbackStream: React.FC<{ feedback: UserFeedback[] }> = ({ feedback }) => {
    const getSentimentColor = (sentiment: 'positive' | 'neutral' | 'negative') => {
        if (sentiment === 'positive') return 'border-green-500';
        if (sentiment === 'negative') return 'border-red-500';
        return 'border-gray-500';
    };

    return (
        <Card title="Live User Feedback Stream" className="lg:col-span-2">
            <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                {feedback.map(item => (
                    <div key={item.id} className={`p-3 border-l-4 ${getSentimentColor(item.sentiment)} bg-gray-800 rounded-r-md`}>
                        <p className="text-sm text-gray-300">"{item.comment}"</p>
                        <div className="flex justify-between items-center mt-2">
                            <span className="text-xs font-semibold text-indigo-400">{item.user}</span>
                            <span className="text-xs text-gray-500">{new Date(item.timestamp).toLocaleTimeString()}</span>
                        </div>
                    </div>
                ))}
            </div>
        </Card>
    );
}

/**
 * Renders A/B test results.
 */
export const ABTestResults: React.FC<{ data: ABTestResult[] }> = ({ data }) => {
    const getWinnerClass = (winner: 'A' | 'B' | null) => {
        if (winner === 'A') return 'bg-blue-500 text-white';
        if (winner === 'B') return 'bg-green-500 text-white';
        return 'bg-gray-500 text-white';
    };

    const calculateConversionRate = (conversions: number, users: number) => {
        if (users === 0) return '0.00%';
        return ((conversions / users) * 100).toFixed(2) + '%';
    };

    return (
         <Card title="A/B Test Results" className="lg:col-span-3">
             <div className="space-y-4">
                 {data.map((test, index) => (
                     <div key={index} className="p-3 bg-gray-800 rounded-lg">
                         <div className="flex justify-between items-center">
                             <h4 className="font-bold text-white">{test.testName}</h4>
                              <div className="flex items-center space-x-2">
                                <span className={`text-xs px-2 py-1 rounded-full ${getWinnerClass(test.winner)}`}>
                                    {test.winner ? `Winner: Variant ${test.winner}` : 'Inconclusive'}
                                </span>
                                <span className={`text-xs font-mono px-2 py-1 rounded ${test.significance >= 95 ? 'bg-green-600' : 'bg-yellow-600'}`}>
                                    {test.significance}% sig.
                                </span>
                              </div>
                         </div>
                         <div className="grid grid-cols-2 gap-4 mt-3 text-center">
                             <div>
                                 <p className="text-gray-400 text-sm">Variant A</p>
                                 <p className="text-lg font-semibold text-white">{calculateConversionRate(test.variantA_conversions, test.variantA_users)}</p>
                                 <p className="text-xs text-gray-500">{test.variantA_conversions.toLocaleString()} / {test.variantA_users.toLocaleString()}</p>
                             </div>
                             <div>
                                 <p className="text-gray-400 text-sm">Variant B</p>
                                 <p className="text-lg font-semibold text-white">{calculateConversionRate(test.variantB_conversions, test.variantB_users)}</p>
                                 <p className="text-xs text-gray-500">{test.variantB_conversions.toLocaleString()} / {test.variantB_users.toLocaleString()}</p>
                             </div>
                         </div>
                     </div>
                 ))}
             </div>
        </Card>
    );
};

// ================================================================================================
// MAIN VIEW COMPONENT (REFACTORED & EXPANDED)
// ================================================================================================

const UserInsightsView: React.FC = () => {
    const [state, dispatch] = useReducer(dashboardReducer, initialState);

    const fetchData = useCallback((filters: DashboardFilters) => {
        dispatch({ type: 'FETCH_START' });
        ApiClient.fetchUserInsightsData(filters)
            .then(data => {
                dispatch({ type: 'FETCH_SUCCESS', payload: data });
            })
            .catch(error => {
                dispatch({ type: 'FETCH_ERROR', payload: error.message });
            });
    }, []);

    useEffect(() => {
        fetchData(state.filters);
    }, [state.filters, fetchData]);

    const handleFilterChange = useCallback((newFilters: Partial<DashboardFilters>) => {
        dispatch({ type: 'SET_FILTERS', payload: newFilters });
    }, []);
    
    // Using useMemo to prevent re-rendering of expensive components if data hasn't changed
    const memoizedCharts = useMemo(() => {
        if (!state.data) return null;
        return (
            <>
                {/* Enhanced KPI Cards */}
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{state.data.kpis.totalActiveUsers.toLocaleString()}</p><p className="text-xs text-gray-400 mt-1">Total Active Users</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{state.data.kpis.dau.toLocaleString()}</p><p className="text-xs text-gray-400 mt-1">Daily Active</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{state.data.kpis.wou.toLocaleString()}</p><p className="text-xs text-gray-400 mt-1">Weekly Active</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{state.data.kpis.mauPercentage}%</p><p className="text-xs text-gray-400 mt-1">Monthly Active</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{formatCurrency(state.data.kpis.ltv)}</p><p className="text-xs text-gray-400 mt-1">Lifetime Value</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{formatCurrency(state.data.kpis.arppu)}</p><p className="text-xs text-gray-400 mt-1">ARPPU</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-white">{formatCurrency(state.data.kpis.cac)}</p><p className="text-xs text-gray-400 mt-1">Acquisition Cost</p></Card>
                    <Card className="text-center"><p className="text-2xl font-bold text-red-400">{state.data.kpis.monthlyChurn}%</p><p className="text-xs text-gray-400 mt-1">Monthly Churn</p></Card>
                </div>
                
                 {/* Main Charts (Originals) */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <Card title="User Growth">
                        <ResponsiveContainer width="100%" height={300}>
                            <AreaChart data={state.data.userGrowth}>
                                <defs><linearGradient id="colorUsers" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#8884d8" stopOpacity={0.8}/><stop offset="95%" stopColor="#8884d8" stopOpacity={0}/></linearGradient></defs>
                                <XAxis dataKey="name" stroke="#9ca3af" />
                                <YAxis stroke="#9ca3af" />
                                <Tooltip content={<CustomTooltip />} />
                                <Area type="monotone" dataKey="users" stroke="#8884d8" fill="url(#colorUsers)" name="Active Users" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </Card>
                    <Card title="Engagement by Cohort (Weekly Retention %)">
                        <ResponsiveContainer width="100%" height={300}>
                            <BarChart data={state.data.engagementByCohort}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                                <XAxis dataKey="cohort" stroke="#9ca3af" />
                                <YAxis stroke="#9ca3af" unit="%" />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend />
                                <Bar dataKey="w1" fill="#06b6d4" name="Week 1" />
                                <Bar dataKey="w2" fill="#3b82f6" name="Week 2" />
                                <Bar dataKey="w3" fill="#6366f1" name="Week 3" />
                                <Bar dataKey="w4" fill="#8b5cf6" name="Week 4" />
                            </BarChart>
                        </ResponsiveContainer>
                    </Card>
                </div>
                
                 {/* New - Demographics Section */}
                <DemographicsCharts data={state.data.demographics} />
                
                {/* New - Acquisition Section */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <AcquisitionFunnelChart data={state.data.acquisitionChannels} />
                    <AcquisitionChannelPerformance data={state.data.acquisitionChannels} />
                </div>
                
                {/* Churn & Insights */}
                <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <Card title="AI-Generated Key Insights" className="lg:col-span-2">
                        <ul className="space-y-4 list-disc list-inside text-gray-300">
                           {aiInsights.map((insight, index) => <li key={index}>{insight}</li>)}
                        </ul>
                   </Card>
                   <Card title="Churn Prediction (%)" className="lg:col-span-3">
                        <ResponsiveContainer width="100%" height={300}>
                           <LineChart data={state.data.churnPrediction}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                               <XAxis dataKey="month" stroke="#9ca3af" />
                               <YAxis stroke="#9ca3af" domain={[2, 3]} unit="%" />
                               <Tooltip content={<CustomTooltip />} />
                               <Legend />
                               <Line type="monotone" dataKey="actual" stroke="#10b981" name="Actual Churn" strokeWidth={2} />
                               <Line type="monotone" dataKey="predicted" stroke="#ef4444" name="AI Predicted Churn" strokeWidth={2} strokeDasharray="5 5" />
                           </LineChart>
                       </ResponsiveContainer>
                   </Card>
                </div>
                
                {/* New - Feature Adoption and LTV/CAC */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <FeatureAdoptionChart data={state.data.featureAdoption} />
                    <Card title="LTV vs CAC Analysis">
                        <ResponsiveContainer width="100%" height={400}>
                            <LineChart data={state.data.ltvCac}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                                <XAxis dataKey="month" stroke="#9ca3af" />
                                <YAxis stroke="#9ca3af" unit="$" />
                                <Tooltip content={<CustomTooltip />} />
                                <Legend />
                                <Line type="monotone" dataKey="ltv" name="Lifetime Value (LTV)" stroke="#10b981" strokeWidth={2} />
                                <Line type="monotone" dataKey="cac" name="Customer Acquisition Cost (CAC)" stroke="#ef4444" strokeWidth={2} />
                            </LineChart>
                        </ResponsiveContainer>
                    </Card>
                </div>
                
                {/* Satisfaction and Feedback */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <Card title="User Satisfaction Scores">
                         <ResponsiveContainer width="100%" height={300}>
                             <RadialBarChart 
                                innerRadius="20%" 
                                outerRadius="80%" 
                                data={userSatisfactionData} 
                                startAngle={180} 
                                endAngle={0}
                            >
                                <RadialBar 
                                    minAngle={15} 
                                    background 
                                    clockwise
                                    dataKey="value" 
                                />
                                <Legend iconSize={10} layout="horizontal" verticalAlign="bottom" align="center" />
                                <Tooltip content={<CustomTooltip />} />
                            </RadialBarChart>
                        </ResponsiveContainer>
                    </Card>
                    <UserFeedbackStream feedback={state.data.recentFeedback} />
                </div>

                {/* A/B Testing & Subscription Tiers */}
                 <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <ABTestResults data={state.data.abTests} />
                    <Card title="Subscription Tiers" className="lg:col-span-2">
                        <ResponsiveContainer width="100%" height={300}>
                            <PieChart>
                                <Pie 
                                    data={state.data.subscriptionTiers} 
                                    dataKey="count" 
                                    nameKey="name" 
                                    cx="50%" 
                                    cy="50%" 
                                    outerRadius={100} 
                                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                >
                                    {state.data.subscriptionTiers.map((entry, index) => <Cell key={`cell-${index}`} fill={PIE_CHART_COLORS[index % PIE_CHART_COLORS.length]} />)}
                                </Pie>
                                <Tooltip formatter={(value, name, props) => [`${(value as number).toLocaleString()} users`, name]} content={<CustomTooltip />} />
                                <Legend />
                            </PieChart>
                        </ResponsiveContainer>
                    </Card>
                </div>
            </>
        );
    }, [state.data]);

    return (
        <div className="space-y-6">
            <div className="flex flex-wrap justify-between items-center gap-4">
                <h2 className="text-3xl font-bold text-white tracking-wider">User & Client Insights</h2>
                {/* Add Export buttons or other actions here */}
                <div className="flex space-x-2">
                    <button className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50" disabled={state.loading}>Export CSV</button>
                    <button className="px-4 py-2 text-sm font-medium text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors disabled:opacity-50" disabled={state.loading}>Generate Report</button>
                </div>
            </div>

            <FilterBar filters={state.filters} onFilterChange={handleFilterChange} disabled={state.loading} />

            {state.loading && (
                <div className="flex justify-center items-center h-96">
                    <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-indigo-500"></div>
                </div>
            )}
            
            {state.error && (
                <Card className="bg-red-900 border-red-700">
                    <h3 className="text-lg font-bold text-red-200">An Error Occurred</h3>
                    <p className="text-red-300 mt-2">{state.error}</p>
                    <button onClick={() => fetchData(state.filters)} className="mt-4 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold">
                        Retry
                    </button>
                </Card>
            )}

            {!state.loading && !state.error && state.data && memoizedCharts}
        </div>
    );
};

export default UserInsightsView;
