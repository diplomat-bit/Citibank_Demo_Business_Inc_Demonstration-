
--- FILE: DaoGovernanceView.tsx ---

import React, { useState, useEffect, useCallback, useMemo, createContext, useContext } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// --- START: NEW IMPORTS FOR EXTENDED FUNCTIONALITY ---
// Assuming these are standard icon libraries or similar, not creating them for line count
// import { FiPieChart, FiUsers, FiDollarSign, FiZap, FiSettings, FiPlusCircle, FiBarChart2, FiGlobe, FiMessageSquare, FiBell, FiChevronRight } from 'react-icons/fi';
// import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts'; // Placeholder for charts
// --- END: NEW IMPORTS FOR EXTENDED FUNCTIONALITY ---

// --- START: MOCK DATA AND TYPE DEFINITIONS (adds significant lines) ---

// Utility types
type Awaited<T> = T extends PromiseLike<infer U> ? U : T;

// DAO specific types
export enum ProposalStatus {
    Pending = 'Pending',
    Active = 'Active',
    Passed = 'Passed',
    Failed = 'Failed',
    Executed = 'Executed',
    Canceled = 'Canceled',
}

export enum VoteOption {
    For = 'For',
    Against = 'Against',
    Abstain = 'Abstain',
}

export interface Proposal {
    id: string;
    title: string;
    description: string;
    proposer: string;
    status: ProposalStatus;
    votingPeriodStart: Date;
    votingPeriodEnd: Date;
    forVotes: number;
    againstVotes: number;
    abstainVotes: number;
    totalVotes: number;
    quorumThreshold: number; // percentage, e.g., 0.20 for 20%
    passThreshold: number; // percentage of 'for' votes needed, e.g., 0.50 for 50%
    detailsLink: string;
    tags: string[];
    contractInteraction: {
        method: string;
        targetAddress: string;
        value: string; // e.g., "1000 ETH"
        parameters: { name: string; type: string; value: string; }[];
    } | null;
    aiSummary?: string;
    aiImpactAnalysis?: string;
    aiRiskAssessment?: string;
}

export interface Vote {
    proposalId: string;
    voterAddress: string;
    option: VoteOption;
    votingPower: number;
    timestamp: Date;
    transactionHash: string;
}

export interface TreasuryAsset {
    id: string;
    name: string;
    symbol: string;
    amount: number;
    usdValue: number;
    contractAddress: string;
    logoUrl: string;
}

export interface Grant {
    id: string;
    proposalId: string;
    title: string;
    description: string;
    recipient: string;
    amount: number;
    tokenSymbol: string;
    status: 'Approved' | 'Pending' | 'Rejected' | 'Paid';
    milestones: { description: string; status: 'Completed' | 'Pending'; payment: number; }[];
    applicationDate: Date;
    approvalDate?: Date;
}

export interface Delegate {
    address: string;
    name: string;
    bio: string;
    votingPower: number;
    proposalsVoted: number;
    forRate: number; // percentage of 'for' votes
    againstRate: number; // percentage of 'against' votes
    lastActive: Date;
    socialLinks: { twitter?: string; github?: string; website?: string; };
    image?: string;
}

export interface UserProfile {
    walletAddress: string;
    currentVotingPower: number;
    delegatedTo?: string; // Address of delegate
    delegators: string[]; // Addresses of users who delegated to this user
    tokenBalance: number;
    nftHoldings: { id: string; name: string; imageUrl: string; }[];
    notifications: Notification[];
}

export enum NotificationType {
    NewProposal = 'NewProposal',
    ProposalStatusChange = 'ProposalStatusChange',
    VoteOutcome = 'VoteOutcome',
    DelegationChange = 'DelegationChange',
    GrantUpdate = 'GrantUpdate',
    SystemMessage = 'SystemMessage',
}

export interface Notification {
    id: string;
    type: NotificationType;
    message: string;
    timestamp: Date;
    read: boolean;
    relatedEntityId?: string; // e.g., proposalId, grantId
}

export interface GovernanceMetric {
    date: Date;
    totalProposals: number;
    activeProposals: number;
    passedProposals: number;
    failedProposals: number;
    totalVotesCast: number;
    uniqueVoters: number;
    participationRate: number; // percentage
    treasuryValue: number;
}

// Mock Data Generators (to simulate a large dataset)
const generateRandomAddress = () => `0x${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}`;
const generateRandomDate = (start: Date, end: Date) => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
const randomInt = (min: number, max: number) => Math.floor(Math.random() * (max - min + 1)) + min;
const randomFloat = (min: number, max: number) => Math.random() * (max - min) + min;

export const mockProposals: Proposal[] = Array.from({ length: 50 }).map((_, i) => {
    const statusOptions = Object.values(ProposalStatus);
    const status = statusOptions[randomInt(0, statusOptions.length - 1)];
    const startDate = generateRandomDate(new Date(2023, 0, 1), new Date());
    const endDate = new Date(startDate.getTime() + randomInt(3, 7) * 24 * 60 * 60 * 1000); // 3-7 days later

    const forVotes = randomInt(10000, 500000);
    const againstVotes = randomInt(5000, 200000);
    const abstainVotes = randomInt(1000, 50000);
    const totalVotes = forVotes + againstVotes + abstainVotes;

    return {
        id: `prop-${i + 1}`,
        title: `Proposal to ${['Enhance', 'Optimize', 'Fund', 'Decentralize', 'Integrate'][randomInt(0, 4)]} DAO ${['Treasury', 'Protocol', 'Community', 'Security', 'User Experience'][randomInt(0, 4)]} - v${randomInt(1, 5)}.${randomInt(0, 9)}`,
        description: `This proposal outlines a plan to ${['allocate funds for a new initiative', 'update the core smart contracts', 'engage more community members', 'improve governance mechanisms', 'expand partnerships'][randomInt(0, 4)]} by doing X, Y, and Z. We believe this will result in A, B, and C. The estimated cost is ${randomInt(10000, 1000000)} tokens, to be sourced from the DAO treasury. This is a detailed description of the proposal aiming to improve the overall ecosystem health and sustainability. It covers technical specifications, financial implications, and community benefits. We encourage all token holders to review the full details linked below and cast their vote. This action is critical for the long-term growth and success of the DAO.`,
        proposer: generateRandomAddress(),
        status: status,
        votingPeriodStart: startDate,
        votingPeriodEnd: endDate,
        forVotes: forVotes,
        againstVotes: againstVotes,
        abstainVotes: abstainVotes,
        totalVotes: totalVotes,
        quorumThreshold: 0.10 + randomFloat(0, 0.20), // 10-30%
        passThreshold: 0.50 + randomFloat(0, 0.20), // 50-70%
        detailsLink: `https://example.com/proposals/prop-${i + 1}`,
        tags: [
            ['Treasury', 'Protocol', 'Community', 'Grants', 'Security'][randomInt(0, 4)],
            ['Development', 'Marketing', 'Ecosystem', 'Operations'][randomInt(0, 3)]
        ],
        contractInteraction: i % 3 === 0 ? {
            method: 'transfer',
            targetAddress: generateRandomAddress(),
            value: `${randomInt(1000, 100000)} ETH`,
            parameters: [
                { name: 'recipient', type: 'address', value: generateRandomAddress() },
                { name: 'amount', type: 'uint256', value: randomInt(100, 10000).toString() }
            ]
        } : null,
        aiSummary: i % 5 === 0 ? `Key Points: 1. Allocate ${randomInt(10, 50)}% treasury for new grant. 2. Establish 3-person review committee. 3. Focus on ecosystem growth and developer incentives.` : undefined,
        aiImpactAnalysis: i % 5 === 1 ? `Predicted Impact: High positive on developer engagement, moderate on token value. Potential risks include misuse of funds without strict oversight.` : undefined,
        aiRiskAssessment: i % 5 === 2 ? `Risk Assessment: Low technical risk, moderate financial risk due to new expenditure, low governance risk.` : undefined,
    };
});

export const mockVotes: Vote[] = Array.from({ length: 200 }).map((_, i) => ({
    proposalId: mockProposals[randomInt(0, mockProposals.length - 1)].id,
    voterAddress: generateRandomAddress(),
    option: Object.values(VoteOption)[randomInt(0, 2)],
    votingPower: randomInt(10, 100000),
    timestamp: generateRandomDate(new Date(2023, 0, 1), new Date()),
    transactionHash: `0x${Math.random().toString(16).substring(2, 18)}${Math.random().toString(16).substring(2, 18)}`
}));

export const mockTreasuryAssets: TreasuryAsset[] = [
    { id: '1', name: 'Ethereum', symbol: 'ETH', amount: 5000 + randomInt(0, 1000), usdValue: (5000 + randomInt(0, 1000)) * 3000, contractAddress: '0x...', logoUrl: '/eth.png' },
    { id: '2', name: 'DAO Token', symbol: 'DAO', amount: 10000000 + randomInt(0, 1000000), usdValue: (10000000 + randomInt(0, 1000000)) * 0.5, contractAddress: '0x...', logoUrl: '/dao.png' },
    { id: '3', name: 'USDC', symbol: 'USDC', amount: 2000000 + randomInt(0, 500000), usdValue: (2000000 + randomInt(0, 500000)) * 1, contractAddress: '0x...', logoUrl: '/usdc.png' },
    { id: '4', name: 'Wrapped BTC', symbol: 'WBTC', amount: 50 + randomInt(0, 10), usdValue: (50 + randomInt(0, 10)) * 60000, contractAddress: '0x...', logoUrl: '/wbtc.png' },
    { id: '5', name: 'Aave', symbol: 'AAVE', amount: 10000 + randomInt(0, 1000), usdValue: (10000 + randomInt(0, 1000)) * 100, contractAddress: '0x...', logoUrl: '/aave.png' },
];

export const mockGrants: Grant[] = Array.from({ length: 15 }).map((_, i) => ({
    id: `grant-${i + 1}`,
    proposalId: mockProposals[randomInt(0, mockProposals.length - 1)].id,
    title: `Grant for ${['Front-end Development', 'Smart Contract Audit', 'Community Engagement', 'Educational Content', 'Research Initiative'][randomInt(0, 4)]}`,
    description: `This grant aims to support the development of a key feature for the DAO, ensuring its long-term viability and competitiveness in the ecosystem.`,
    recipient: generateRandomAddress(),
    amount: randomInt(5000, 50000),
    tokenSymbol: ['DAO', 'USDC'][randomInt(0, 1)],
    status: ['Approved', 'Pending', 'Rejected', 'Paid'][randomInt(0, 3)],
    milestones: [
        { description: 'Phase 1 Completion', status: 'Completed', payment: randomInt(1000, 5000) },
        { description: 'Phase 2 Completion', status: 'Pending', payment: randomInt(1000, 5000) },
    ],
    applicationDate: generateRandomDate(new Date(2023, 6, 1), new Date()),
    approvalDate: i % 2 === 0 ? generateRandomDate(new Date(2023, 9, 1), new Date()) : undefined,
}));

export const mockDelegates: Delegate[] = Array.from({ length: 20 }).map((_, i) => ({
    address: generateRandomAddress(),
    name: `Delegate ${String.fromCharCode(65 + i)}`,
    bio: `Experienced in ${['protocol governance', 'financial analysis', 'community building', 'technical development'][randomInt(0, 3)]}. Committed to the long-term success of the DAO.`,
    votingPower: randomInt(100000, 5000000),
    proposalsVoted: randomInt(20, 100),
    forRate: randomFloat(0.6, 0.9),
    againstRate: randomFloat(0.1, 0.3),
    lastActive: generateRandomDate(new Date(2024, 0, 1), new Date()),
    socialLinks: {
        twitter: `https://twitter.com/delegate${i}`,
        github: i % 3 === 0 ? `https://github.com/delegate${i}` : undefined,
    },
    image: `https://i.pravatar.cc/150?img=${i + 10}` // Placeholder avatars
}));

export const mockUserProfile: UserProfile = {
    walletAddress: '0xMyWalletAddressABCDEF1234567890abcdef',
    currentVotingPower: 15000,
    delegatedTo: mockDelegates[0].address,
    delegators: Array.from({ length: 5 }).map(() => generateRandomAddress()),
    tokenBalance: 25000,
    nftHoldings: [
        { id: 'nft-1', name: 'DAO Founder Pass #123', imageUrl: 'https://via.placeholder.com/100/0000FF/FFFFFF?text=NFT1' },
        { id: 'nft-2', name: 'DAO Contributor Badge', imageUrl: 'https://via.placeholder.com/100/FF0000/FFFFFF?text=NFT2' },
    ],
    notifications: Array.from({ length: 7 }).map((_, i) => ({
        id: `notif-${i}`,
        type: Object.values(NotificationType)[randomInt(0, Object.values(NotificationType).length - 1)],
        message: `Notification ${i + 1}: Proposal #${mockProposals[i % mockProposals.length].id} ${['updated', 'passed', 'failed', 'newly created'][randomInt(0, 3)]}.`,
        timestamp: generateRandomDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), new Date()),
        read: i % 3 === 0,
    })),
};

export const mockGovernanceMetrics: GovernanceMetric[] = Array.from({ length: 12 }).map((_, i) => {
    const baseProposals = 10 + i * 2;
    const baseVotes = 50000 + i * 10000;
    const baseTreasury = 10000000 + i * 500000;
    return {
        date: new Date(2023, i + 1, 1),
        totalProposals: baseProposals + randomInt(-2, 2),
        activeProposals: randomInt(1, 5),
        passedProposals: randomInt(baseProposals * 0.6, baseProposals * 0.8),
        failedProposals: randomInt(baseProposals * 0.1, baseProposals * 0.2),
        totalVotesCast: baseVotes + randomInt(-5000, 5000),
        uniqueVoters: randomInt(baseVotes / 100, baseVotes / 50),
        participationRate: randomFloat(0.05, 0.25),
        treasuryValue: baseTreasury + randomInt(-1000000, 1000000),
    };
});

// Context for global state (e.g., wallet connection)
export interface WalletContextType {
    isConnected: boolean;
    address: string | null;
    connectWallet: () => Promise<void>;
    disconnectWallet: () => void;
    userProfile: UserProfile | null;
    fetchUserProfile: (address: string) => Promise<void>;
}

export const WalletContext = createContext<WalletContextType | undefined>(undefined);

export const useWallet = () => {
    const context = useContext(WalletContext);
    if (!context) {
        throw new Error('useWallet must be used within a WalletProvider');
    }
    return context;
};

// Wallet Provider Component (for future expansion, keeping within file for line count)
export const WalletProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [isConnected, setIsConnected] = useState<boolean>(false);
    const [address, setAddress] = useState<string | null>(null);
    const [userProfile, setUserProfile] = useState<UserProfile | null>(null);

    const connectWallet = useCallback(async () => {
        // Simulate wallet connection logic
        await new Promise(resolve => setTimeout(resolve, 1000));
        setIsConnected(true);
        setAddress(mockUserProfile.walletAddress);
        // In a real app, this would fetch the actual profile for the connected address
        setUserProfile(mockUserProfile);
        console.log("Wallet connected:", mockUserProfile.walletAddress);
    }, []);

    const disconnectWallet = useCallback(() => {
        setIsConnected(false);
        setAddress(null);
        setUserProfile(null);
        console.log("Wallet disconnected.");
    }, []);

    const fetchUserProfile = useCallback(async (walletAddress: string) => {
        // Simulate fetching user profile from backend/blockchain
        await new Promise(resolve => setTimeout(resolve, 500));
        if (walletAddress === mockUserProfile.walletAddress) {
            setUserProfile(mockUserProfile);
        } else {
            // Simulate a generic profile for an unconnected user or different address
            setUserProfile({
                walletAddress,
                currentVotingPower: randomInt(0, 5000),
                delegators: [],
                nftHoldings: [],
                notifications: [],
                tokenBalance: randomInt(0, 10000),
            });
        }
    }, []);

    const contextValue = useMemo(() => ({
        isConnected,
        address,
        connectWallet,
        disconnectWallet,
        userProfile,
        fetchUserProfile,
    }), [isConnected, address, connectWallet, disconnectWallet, userProfile, fetchUserProfile]);

    return (
        <WalletContext.Provider value={contextValue}>
            {children}
        </WalletContext.Provider>
    );
};

// Placeholder for an actual chart component using recharts
export const MockLineChart: React.FC<{ data: any[]; dataKey: string; name: string }> = ({ data, dataKey, name }) => (
    <div className="w-full h-64 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400">
        <p className="text-center">
            {name} Chart Placeholder<br/>
            (Data points: {data.length})
        </p>
    </div>
);

// --- END: MOCK DATA AND TYPE DEFINITIONS ---


// --- START: NEW COMPONENTS AND HELPER FUNCTIONS (adds significant lines) ---

// Helper to format large numbers
export const formatNumber = (num: number, currency: boolean = false, decimals: number = 0) => {
    if (num >= 1000000) {
        return `${currency ? '$' : ''}${(num / 1000000).toFixed(decimals)}M`;
    }
    if (num >= 1000) {
        return `${currency ? '$' : ''}${(num / 1000).toFixed(decimals)}K`;
    }
    return `${currency ? '$' : ''}${num.toFixed(decimals)}`;
};

export const formatAddress = (address: string, chars = 6) => {
    if (!address) return '';
    return `${address.substring(0, chars)}...${address.substring(address.length - chars)}`;
};

export const getStatusColor = (status: ProposalStatus) => {
    switch (status) {
        case ProposalStatus.Active: return 'bg-blue-600';
        case ProposalStatus.Passed: return 'bg-green-600';
        case ProposalStatus.Failed: return 'bg-red-600';
        case ProposalStatus.Executed: return 'bg-purple-600';
        case ProposalStatus.Pending: return 'bg-yellow-600';
        case ProposalStatus.Canceled: return 'bg-gray-600';
        default: return 'bg-gray-500';
    }
};

// Custom Hook for AI Interactions
export interface AIInteractionOptions {
    model: string;
    apiKey: string;
}

export const useAIInteraction = (options: AIInteractionOptions) => {
    const [aiResponse, setAiResponse] = useState<string | null>(null);
    const [aiLoading, setAiLoading] = useState<boolean>(false);
    const [aiError, setAiError] = useState<string | null>(null);

    const generateContent = useCallback(async (prompt: string): Promise<string | null> => {
        setAiLoading(true);
        setAiError(null);
        setAiResponse(null);
        try {
            const ai = new GoogleGenAI({ apiKey: options.apiKey });
            const response = await ai.models.generateContent({ model: options.model, contents: prompt });
            const text = response.text || '';
            setAiResponse(text);
            return text;
        } catch (err: any) {
            console.error("AI Generation Error:", err);
            setAiError(err.message || "Failed to generate AI content.");
            return null;
        } finally {
            setAiLoading(false);
        }
    }, [options.apiKey, options.model]);

    return { aiResponse, aiLoading, aiError, generateContent };
};

// Proposal Card Component
export const ProposalCard: React.FC<{ proposal: Proposal; onViewDetails: (proposal: Proposal) => void }> = ({ proposal, onViewDetails }) => {
    const now = new Date();
    const isVotingActive = proposal.status === ProposalStatus.Active && now >= proposal.votingPeriodStart && now <= proposal.votingPeriodEnd;
    const votesForPercentage = proposal.totalVotes > 0 ? (proposal.forVotes / proposal.totalVotes) * 100 : 0;
    const votesAgainstPercentage = proposal.totalVotes > 0 ? (proposal.againstVotes / proposal.totalVotes) * 100 : 0;
    const votesAbstainPercentage = proposal.totalVotes > 0 ? (proposal.abstainVotes / proposal.totalVotes) * 100 : 0;

    return (
        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700 flex flex-col space-y-4 hover:shadow-lg hover:shadow-cyan-900/30 transition-shadow duration-300">
            <div className="flex justify-between items-start">
                <h3 className="text-xl font-semibold text-white leading-tight">{proposal.title}</h3>
                <span className={`px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(proposal.status)} text-white`}>
                    {proposal.status}
                </span>
            </div>
            <p className="text-gray-400 text-sm line-clamp-3">{proposal.description}</p>
            <div className="grid grid-cols-2 gap-2 text-sm text-gray-400">
                <div><span className="font-medium text-gray-300">Proposer:</span> {formatAddress(proposal.proposer)}</div>
                <div><span className="font-medium text-gray-300">Ends:</span> {proposal.votingPeriodEnd.toLocaleDateString()}</div>
                <div><span className="font-medium text-gray-300">Total Votes:</span> {formatNumber(proposal.totalVotes)}</div>
                <div><span className="font-medium text-gray-300">Quorum:</span> {(proposal.quorumThreshold * 100).toFixed(0)}%</div>
            </div>

            <div className="space-y-2">
                <div className="flex justify-between text-xs text-gray-400">
                    <span>For: {formatNumber(proposal.forVotes)} ({votesForPercentage.toFixed(1)}%)</span>
                    <span>Against: {formatNumber(proposal.againstVotes)} ({votesAgainstPercentage.toFixed(1)}%)</span>
                </div>
                <div className="w-full bg-gray-700 rounded-full h-2.5">
                    <div
                        className="bg-green-500 h-2.5 rounded-l-full"
                        style={{ width: `${votesForPercentage}%` }}
                    ></div>
                    <div
                        className="bg-red-500 h-2.5 rounded-r-full -mt-2.5"
                        style={{ width: `${votesAgainstPercentage}%`, marginLeft: `${votesForPercentage}%` }}
                    ></div>
                </div>
            </div>

            <div className="flex justify-end pt-4 border-t border-gray-700 mt-auto">
                {isVotingActive && (
                    <button className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium mr-2">
                        Vote Now
                    </button>
                )}
                <button
                    onClick={() => onViewDetails(proposal)}
                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium"
                >
                    View Details
                </button>
            </div>
        </div>
    );
};

// Proposal Details Modal Component
export const ProposalDetailsModal: React.FC<{ proposal: Proposal; onClose: () => void; onVote: (proposalId: string, option: VoteOption) => Promise<void> }> = ({ proposal, onClose, onVote }) => {
    const { isConnected, address, userProfile } = useWallet();
    const [selectedVote, setSelectedVote] = useState<VoteOption | null>(null);
    const [isVoting, setIsVoting] = useState(false);
    const [voteMessage, setVoteMessage] = useState<string | null>(null);

    const now = new Date();
    const isVotingActive = proposal.status === ProposalStatus.Active && now >= proposal.votingPeriodStart && now <= proposal.votingPeriodEnd;
    const hasVoted = mockVotes.some(v => v.proposalId === proposal.id && v.voterAddress === address); // Simplified check

    const handleCastVote = async () => {
        if (!isConnected || !address || !selectedVote) {
            setVoteMessage("Please connect wallet and select a vote option.");
            return;
        }
        setIsVoting(true);
        setVoteMessage(null);
        try {
            await onVote(proposal.id, selectedVote);
            setVoteMessage("Vote cast successfully!");
            // Optionally refresh proposal data
        } catch (error: any) {
            setVoteMessage(`Voting failed: ${error.message || "Unknown error"}`);
        } finally {
            setIsVoting(false);
        }
    };

    const votesForPercentage = proposal.totalVotes > 0 ? (proposal.forVotes / proposal.totalVotes) * 100 : 0;
    const votesAgainstPercentage = proposal.totalVotes > 0 ? (proposal.againstVotes / proposal.totalVotes) * 100 : 0;
    const votesAbstainPercentage = proposal.totalVotes > 0 ? (proposal.abstainVotes / proposal.totalVotes) * 100 : 0;
    const currentQuorum = proposal.totalVotes / (mockTreasuryAssets[1]?.amount || 1) * 100; // Total DAO tokens
    const isQuorumMet = currentQuorum >= (proposal.quorumThreshold * 100);
    const isPassedThresholdMet = votesForPercentage >= (proposal.passThreshold * 100);

    return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full border border-gray-700 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">{proposal.title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button>
                </div>
                <div className="p-6 space-y-6 text-gray-300">
                    <div className="flex justify-between items-center text-sm">
                        <span className="font-medium text-gray-200">Proposer: {formatAddress(proposal.proposer)}</span>
                        <span className={`px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(proposal.status)} text-white`}>
                            {proposal.status}
                        </span>
                    </div>

                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Description</h4>
                        <p className="whitespace-pre-line">{proposal.description}</p>
                        {proposal.detailsLink && (
                            <a href={proposal.detailsLink} target="_blank" rel="noopener noreferrer" className="text-cyan-500 hover:underline text-sm mt-2 block">
                                Read full proposal
                            </a>
                        )}
                    </div>

                    {proposal.contractInteraction && (
                        <div>
                            <h4 className="font-semibold text-lg text-white mb-2">On-chain Action</h4>
                            <div className="bg-gray-900 p-4 rounded text-sm font-mono space-y-2">
                                <p>Method: <span className="text-purple-400">{proposal.contractInteraction.method}</span></p>
                                <p>Target: <span className="text-cyan-400">{formatAddress(proposal.contractInteraction.targetAddress, 10)}</span></p>
                                <p>Value: <span className="text-green-400">{proposal.contractInteraction.value}</span></p>
                                <p>Parameters:</p>
                                <ul className="list-disc list-inside ml-4">
                                    {proposal.contractInteraction.parameters.map((p, idx) => (
                                        <li key={idx}>
                                            {p.name} (<span className="text-yellow-400">{p.type}</span>): {p.value}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    )}

                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Voting Results</h4>
                        <div className="space-y-3">
                            <div className="flex justify-between text-sm">
                                <span>For: <span className="font-medium text-green-400">{formatNumber(proposal.forVotes)} ({votesForPercentage.toFixed(1)}%)</span></span>
                                <span>Against: <span className="font-medium text-red-400">{formatNumber(proposal.againstVotes)} ({votesAgainstPercentage.toFixed(1)}%)</span></span>
                                <span>Abstain: <span className="font-medium text-yellow-400">{formatNumber(proposal.abstainVotes)} ({votesAbstainPercentage.toFixed(1)}%)</span></span>
                            </div>
                            <div className="w-full bg-gray-700 rounded-full h-3 flex overflow-hidden">
                                <div className="bg-green-500 h-full" style={{ width: `${votesForPercentage}%` }}></div>
                                <div className="bg-red-500 h-full" style={{ width: `${votesAgainstPercentage}%` }}></div>
                                <div className="bg-yellow-500 h-full" style={{ width: `${votesAbstainPercentage}%` }}></div>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div><span className="font-medium text-gray-200">Quorum:</span> {(proposal.quorumThreshold * 100).toFixed(0)}% ({currentQuorum.toFixed(1)}% currently) <span className={`ml-1 text-xs font-semibold ${isQuorumMet ? 'text-green-400' : 'text-red-400'}`}>{isQuorumMet ? 'MET' : 'NOT MET'}</span></div>
                                <div><span className="font-medium text-gray-200">Pass Threshold:</span> {(proposal.passThreshold * 100).toFixed(0)}% For <span className={`ml-1 text-xs font-semibold ${isPassedThresholdMet ? 'text-green-400' : 'text-red-400'}`}>{isPassedThresholdMet ? 'MET' : 'NOT MET'}</span></div>
                            </div>
                        </div>
                    </div>

                    {proposal.aiSummary && (
                        <Card title="AI Summary (Gemini)" className="bg-gray-900/50">
                            <div className="text-sm text-gray-300 whitespace-pre-line">{proposal.aiSummary}</div>
                        </Card>
                    )}
                    {proposal.aiImpactAnalysis && (
                        <Card title="AI Impact Analysis (Gemini)" className="bg-gray-900/50">
                            <div className="text-sm text-gray-300 whitespace-pre-line">{proposal.aiImpactAnalysis}</div>
                        </Card>
                    )}
                     {proposal.aiRiskAssessment && (
                        <Card title="AI Risk Assessment (Gemini)" className="bg-gray-900/50">
                            <div className="text-sm text-gray-300 whitespace-pre-line">{proposal.aiRiskAssessment}</div>
                        </Card>
                    )}

                    {isVotingActive && isConnected && !hasVoted && (
                        <div className="p-4 bg-gray-900/50 rounded-lg space-y-4 border border-gray-700">
                            <h4 className="font-semibold text-lg text-white">Cast Your Vote</h4>
                            <div className="flex space-x-4">
                                {Object.values(VoteOption).map(option => (
                                    <button
                                        key={option}
                                        onClick={() => setSelectedVote(option)}
                                        className={`flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all duration-200
                                                    ${selectedVote === option ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                    >
                                        {option}
                                    </button>
                                ))}
                            </div>
                            <button
                                onClick={handleCastVote}
                                disabled={isVoting || !selectedVote || !userProfile?.currentVotingPower}
                                className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isVoting ? 'Submitting Vote...' : `Vote with ${formatNumber(userProfile?.currentVotingPower || 0)} Power`}
                            </button>
                            {voteMessage && <p className={`text-center text-sm ${voteMessage.includes('failed') ? 'text-red-400' : 'text-green-400'}`}>{voteMessage}</p>}
                        </div>
                    )}
                    {!isConnected && isVotingActive && (
                        <div className="p-4 bg-yellow-900/30 text-yellow-300 rounded-lg text-center">
                            Connect your wallet to cast a vote.
                        </div>
                    )}
                    {hasVoted && isConnected && (
                        <div className="p-4 bg-green-900/30 text-green-300 rounded-lg text-center">
                            You have already voted on this proposal.
                        </div>
                    )}
                    {!isVotingActive && (
                        <div className="p-4 bg-gray-900/50 text-gray-400 rounded-lg text-center">
                            Voting for this proposal is currently {proposal.status}.
                        </div>
                    )}

                    {/* Placeholder for comments/discussion */}
                    <div className="p-4 bg-gray-900/50 rounded-lg space-y-4 border border-gray-700">
                        <h4 className="font-semibold text-lg text-white">Discussion & Comments (Mock)</h4>
                        <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                            <div className="bg-gray-700 p-3 rounded-md text-sm">
                                <p className="font-semibold text-white">{formatAddress(generateRandomAddress(), 8)} <span className="text-gray-400 font-normal text-xs ml-2">{new Date().toLocaleDateString()}</span></p>
                                <p className="text-gray-300 mt-1">Great proposal, looking forward to seeing this implemented!</p>
                            </div>
                            <div className="bg-gray-700 p-3 rounded-md text-sm">
                                <p className="font-semibold text-white">{formatAddress(generateRandomAddress(), 8)} <span className="text-gray-400 font-normal text-xs ml-2">{new Date(Date.now() - 3600000).toLocaleDateString()}</span></p>
                                <p className="text-gray-300 mt-1">Concerns about the budget allocation, could we get a more detailed breakdown?</p>
                            </div>
                            <div className="bg-gray-700 p-3 rounded-md text-sm">
                                <p className="font-semibold text-white">{formatAddress(generateRandomAddress(), 8)} <span className="text-gray-400 font-normal text-xs ml-2">{new Date(Date.now() - 7200000).toLocaleDateString()}</span></p>
                                <p className="text-gray-300 mt-1">How will this impact the current treasury reserves? Any long-term projections?</p>
                            </div>
                        </div>
                        {isConnected && (
                            <div className="flex flex-col space-y-2">
                                <textarea
                                    className="w-full h-20 bg-gray-900/50 p-2 rounded text-white text-sm border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500"
                                    placeholder="Add your comment..."
                                ></textarea>
                                <button className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium self-end">
                                    Post Comment
                                </button>
                            </div>
                        )}
                    </div>

                </div>
            </div>
        </div>
    );
};


// Proposal Creation Form Component
export const ProposalCreationForm: React.FC<{ onCreateProposal: (proposalData: Partial<Proposal>) => Promise<void>; onClose: () => void }> = ({ onCreateProposal, onClose }) => {
    const { isConnected, address } = useWallet();
    const [title, setTitle] = useState('');
    const [description, setDescription] = useState('');
    const [detailsLink, setDetailsLink] = useState('');
    const [contractInteractionEnabled, setContractInteractionEnabled] = useState(false);
    const [targetAddress, setTargetAddress] = useState('');
    const [method, setMethod] = useState('');
    const [value, setValue] = useState('');
    const [parameters, setParameters] = useState<{ name: string; type: string; value: string; }[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');
    const [successMessage, setSuccessMessage] = useState('');

    const addParameter = () => setParameters([...parameters, { name: '', type: '', value: '' }]);
    const updateParameter = (index: number, field: string, val: string) => {
        const newParams = [...parameters];
        (newParams[index] as any)[field] = val;
        setParameters(newParams);
    };
    const removeParameter = (index: number) => setParameters(parameters.filter((_, i) => i !== index));

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!isConnected || !address) {
            setErrorMessage("Please connect your wallet to create a proposal.");
            return;
        }
        if (!title || !description) {
            setErrorMessage("Title and description are required.");
            return;
        }

        setIsLoading(true);
        setErrorMessage('');
        setSuccessMessage('');

        const newProposalData: Partial<Proposal> = {
            title,
            description,
            proposer: address, // Set connected user as proposer
            status: ProposalStatus.Pending, // New proposals start as pending
            votingPeriodStart: new Date(), // Placeholder, typically set by governance
            votingPeriodEnd: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days from now
            forVotes: 0, againstVotes: 0, abstainVotes: 0, totalVotes: 0,
            quorumThreshold: 0.20, // Default values
            passThreshold: 0.50, // Default values
            detailsLink: detailsLink || undefined,
            tags: ['Community', 'New'], // Default tags
            contractInteraction: contractInteractionEnabled && targetAddress && method ? {
                method,
                targetAddress,
                value,
                parameters: parameters.filter(p => p.name && p.type && p.value),
            } : null,
        };

        try {
            await onCreateProposal(newProposalData);
            setSuccessMessage("Proposal submitted successfully!");
            // Clear form
            setTitle(''); setDescription(''); setDetailsLink('');
            setContractInteractionEnabled(false); setTargetAddress(''); setMethod(''); setValue(''); setParameters([]);
            // onClose(); // Optionally close immediately
        } catch (error: any) {
            setErrorMessage(`Failed to create proposal: ${error.message || "Unknown error"}`);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full border border-gray-700 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">Create New Proposal</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button>
                </div>
                <form onSubmit={handleSubmit} className="p-6 space-y-6 text-gray-300">
                    <div className="form-group">
                        <label htmlFor="title" className="block text-sm font-medium text-gray-200 mb-1">Proposal Title</label>
                        <input
                            type="text"
                            id="title"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            className="w-full bg-gray-900/50 p-3 rounded-md border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                            placeholder="e.g., Allocate funds for Ecosystem Grants Program"
                            required
                        />
                    </div>
                    <div className="form-group">
                        <label htmlFor="description" className="block text-sm font-medium text-gray-200 mb-1">Description</label>
                        <textarea
                            id="description"
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            rows={8}
                            className="w-full bg-gray-900/50 p-3 rounded-md border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                            placeholder="Provide a detailed explanation of your proposal..."
                            required
                        />
                    </div>
                    <div className="form-group">
                        <label htmlFor="detailsLink" className="block text-sm font-medium text-gray-200 mb-1">External Details Link (Optional)</label>
                        <input
                            type="url"
                            id="detailsLink"
                            value={detailsLink}
                            onChange={(e) => setDetailsLink(e.target.value)}
                            className="w-full bg-gray-900/50 p-3 rounded-md border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                            placeholder="e.g., https://forum.dao.com/t/proposal-discussion-x-y-z"
                        />
                    </div>

                    <div className="form-group flex items-center">
                        <input
                            type="checkbox"
                            id="contractInteraction"
                            checked={contractInteractionEnabled}
                            onChange={(e) => setContractInteractionEnabled(e.target.checked)}
                            className="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-600 rounded bg-gray-700"
                        />
                        <label htmlFor="contractInteraction" className="ml-2 block text-sm font-medium text-gray-200">
                            Include On-chain Contract Interaction
                        </label>
                    </div>

                    {contractInteractionEnabled && (
                        <div className="bg-gray-900/50 p-4 rounded-lg space-y-4 border border-gray-700">
                            <h4 className="font-semibold text-lg text-white">Contract Interaction Details</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="form-group">
                                    <label htmlFor="targetAddress" className="block text-sm font-medium text-gray-200 mb-1">Target Contract Address</label>
                                    <input
                                        type="text"
                                        id="targetAddress"
                                        value={targetAddress}
                                        onChange={(e) => setTargetAddress(e.target.value)}
                                        className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white font-mono text-sm"
                                        placeholder="0x..."
                                        required={contractInteractionEnabled}
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="method" className="block text-sm font-medium text-gray-200 mb-1">Method Name</label>
                                    <input
                                        type="text"
                                        id="method"
                                        value={method}
                                        onChange={(e) => setMethod(e.target.value)}
                                        className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white font-mono text-sm"
                                        placeholder="e.g., transfer, updateConfig"
                                        required={contractInteractionEnabled}
                                    />
                                </div>
                            </div>
                            <div className="form-group">
                                <label htmlFor="value" className="block text-sm font-medium text-gray-200 mb-1">Value (e.g., ETH to send)</label>
                                <input
                                    type="text"
                                    id="value"
                                    value={value}
                                    onChange={(e) => setValue(e.target.value)}
                                    className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white font-mono text-sm"
                                    placeholder="e.g., 0.5 ETH, 1000000 WEI"
                                />
                            </div>

                            <h5 className="font-medium text-md text-white mt-4 mb-2">Parameters</h5>
                            {parameters.map((param, index) => (
                                <div key={index} className="flex gap-2 items-center bg-gray-700 p-3 rounded-md">
                                    <input
                                        type="text"
                                        placeholder="Name"
                                        value={param.name}
                                        onChange={(e) => updateParameter(index, 'name', e.target.value)}
                                        className="flex-1 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Type (e.g., address, uint256)"
                                        value={param.type}
                                        onChange={(e) => updateParameter(index, 'type', e.target.value)}
                                        className="flex-1 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Value"
                                        value={param.value}
                                        onChange={(e) => updateParameter(index, 'value', e.target.value)}
                                        className="flex-2 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm"
                                    />
                                    <button type="button" onClick={() => removeParameter(index)} className="p-2 text-red-400 hover:text-red-300">
                                        &times;
                                    </button>
                                </div>
                            ))}
                            <button type="button" onClick={addParameter} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                                Add Parameter
                            </button>
                        </div>
                    )}

                    {errorMessage && <p className="text-red-500 text-sm text-center">{errorMessage}</p>}
                    {successMessage && <p className="text-green-500 text-sm text-center">{successMessage}</p>}

                    <div className="flex justify-end space-x-3 pt-4 border-t border-gray-700">
                        <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium">
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={isLoading || !isConnected}
                            className="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isLoading ? 'Submitting...' : 'Submit Proposal'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// Delegate Card Component
export const DelegateCard: React.FC<{ delegate: Delegate; onDelegate: (delegateAddress: string) => void; isDelegatedTo: boolean }> = ({ delegate, onDelegate, isDelegatedTo }) => {
    return (
        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700 flex flex-col items-center text-center space-y-3">
            <img src={delegate.image || `https://i.pravatar.cc/150?img=${delegate.address.charCodeAt(2)}`} alt={delegate.name} className="w-20 h-20 rounded-full object-cover border-2 border-cyan-500" />
            <h4 className="text-lg font-semibold text-white">{delegate.name}</h4>
            <p className="text-gray-400 text-sm line-clamp-2">{delegate.bio}</p>
            <div className="text-gray-300 text-sm">
                <p><span className="font-medium">Voting Power:</span> {formatNumber(delegate.votingPower)}</p>
                <p><span className="font-medium">Proposals Voted:</span> {delegate.proposalsVoted}</p>
                <p><span className="font-medium">For Rate:</span> {(delegate.forRate * 100).toFixed(0)}%</p>
            </div>
            <div className="flex space-x-2 mt-2">
                {delegate.socialLinks.twitter && (
                    <a href={delegate.socialLinks.twitter} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:text-cyan-300">
                        {/* <FiGlobe /> // Placeholder for actual icon */}
                        <span className="sr-only">Twitter</span>
                        <span className="text-xs">Twitter</span>
                    </a>
                )}
                {delegate.socialLinks.github && (
                    <a href={delegate.socialLinks.github} target="_blank" rel="noopener noreferrer" className="text-purple-400 hover:text-purple-300">
                        {/* <FiGithub /> */}
                        <span className="sr-only">GitHub</span>
                        <span className="text-xs">GitHub</span>
                    </a>
                )}
            </div>
            <button
                onClick={() => onDelegate(delegate.address)}
                disabled={isDelegatedTo}
                className={`w-full py-2 rounded-lg text-sm font-medium mt-4 ${isDelegatedTo ? 'bg-gray-600 text-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}
            >
                {isDelegatedTo ? 'Delegated' : 'Delegate Vote'}
            </button>
        </div>
    );
};

// Grant Card Component
export const GrantCard: React.FC<{ grant: Grant }> = ({ grant }) => {
    const getGrantStatusColor = (status: Grant['status']) => {
        switch (status) {
            case 'Approved': return 'bg-green-600';
            case 'Pending': return 'bg-yellow-600';
            case 'Rejected': return 'bg-red-600';
            case 'Paid': return 'bg-purple-600';
            default: return 'bg-gray-500';
        }
    };

    return (
        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700 space-y-3">
            <div className="flex justify-between items-start">
                <h4 className="text-lg font-semibold text-white">{grant.title}</h4>
                <span className={`px-3 py-1 text-xs font-medium rounded-full ${getGrantStatusColor(grant.status)} text-white`}>
                    {grant.status}
                </span>
            </div>
            <p className="text-gray-400 text-sm line-clamp-2">{grant.description}</p>
            <div className="grid grid-cols-2 gap-2 text-sm text-gray-400">
                <div><span className="font-medium text-gray-300">Recipient:</span> {formatAddress(grant.recipient)}</div>
                <div><span className="font-medium text-gray-300">Amount:</span> {formatNumber(grant.amount)} {grant.tokenSymbol}</div>
                <div><span className="font-medium text-gray-300">Application:</span> {grant.applicationDate.toLocaleDateString()}</div>
                {grant.approvalDate && <div><span className="font-medium text-gray-300">Approved:</span> {grant.approvalDate.toLocaleDateString()}</div>}
            </div>
            <div>
                <h5 className="font-medium text-gray-300 text-sm mt-2">Milestones:</h5>
                <ul className="list-disc list-inside ml-2 text-gray-400 text-xs">
                    {grant.milestones.map((milestone, idx) => (
                        <li key={idx} className={milestone.status === 'Completed' ? 'text-green-500' : 'text-yellow-500'}>
                            {milestone.description} ({formatNumber(milestone.payment)} {grant.tokenSymbol}) - {milestone.status}
                        </li>
                    ))}
                </ul>
            </div>
            <div className="flex justify-end">
                <button className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-medium">
                    View Grant
                </button>
            </div>
        </div>
    );
};

// Activity Feed Item Component
export const ActivityFeedItem: React.FC<{ notification: Notification }> = ({ notification }) => {
    const getNotificationIcon = (type: NotificationType) => {
        switch (type) {
            case NotificationType.NewProposal: return '';
            case NotificationType.ProposalStatusChange: return '';
            case NotificationType.VoteOutcome: return '';
            case NotificationType.DelegationChange: return '';
            case NotificationType.GrantUpdate: return '';
            case NotificationType.SystemMessage: return '';
            default: return '';
        }
    };

    const getNotificationColor = (read: boolean) => read ? 'text-gray-500' : 'text-white';
    const getNotificationBg = (read: boolean) => read ? 'bg-gray-900' : 'bg-gray-700 hover:bg-gray-600';

    return (
        <div className={`flex items-center space-x-3 p-3 rounded-lg ${getNotificationBg(notification.read)} transition-colors duration-200`}>
            <span className={`text-xl ${getNotificationColor(notification.read)}`}>{getNotificationIcon(notification.type)}</span>
            <div className="flex-1">
                <p className={`text-sm ${getNotificationColor(notification.read)}`}>{notification.message}</p>
                <p className={`text-xs text-gray-400 mt-0.5`}>{notification.timestamp.toLocaleString()}</p>
            </div>
            {!notification.read && <span className="w-2 h-2 bg-cyan-500 rounded-full"></span>}
        </div>
    );
};


// Main DAO Governance View Component
export const DaoGovernanceView: React.FC = () => {
    // Original AI Summarizer State
    const [isSummarizerOpen, setSummarizerOpen] = useState(false);
    const [proposalText, setProposalText] = useState("Proposal to allocate 5% of treasury funds to a new grant program for ecosystem developers, subject to a 3-person committee review for grants over 10,000 tokens...");
    const { aiResponse: summary, aiLoading: isLoading, aiError: summaryError, generateContent: handleSummarizeAI } = useAIInteraction({
        apiKey: process.env.NEXT_PUBLIC_API_KEY as string, // Ensure API key is accessible for client-side
        model: 'gemini-pro', // Using gemini-pro for more general purpose use
    });

    // New State for expanded features
    const { isConnected, address, connectWallet, userProfile, disconnectWallet } = useWallet();

    // Proposal Management
    const [proposals, setProposals] = useState<Proposal[]>(mockProposals);
    const [activeTab, setActiveTab] = useState<'All' | 'Active' | 'Passed' | 'Failed' | 'Pending'>('All');
    const [searchTerm, setSearchTerm] = useState('');
    const [sortOrder, setSortOrder] = useState<'latest' | 'mostVoted'>('latest');
    const [selectedProposal, setSelectedProposal] = useState<Proposal | null>(null);
    const [isProposalCreationOpen, setProposalCreationOpen] = useState(false);
    const [currentPage, setCurrentPage] = useState(1);
    const proposalsPerPage = 8;

    // Treasury Management
    const [treasuryAssets, setTreasuryAssets] = useState<TreasuryAsset[]>(mockTreasuryAssets);
    const [grants, setGrants] = useState<Grant[]>(mockGrants);

    // Delegation
    const [delegates, setDelegates] = useState<Delegate[]>(mockDelegates);
    const [myDelegatedTo, setMyDelegatedTo] = useState<string | undefined>(userProfile?.delegatedTo);

    // Notifications
    const [notifications, setNotifications] = useState<Notification[]>(mockUserProfile.notifications);
    const unreadNotificationsCount = useMemo(() => notifications.filter(n => !n.read).length, [notifications]);

    // Governance Metrics
    const [governanceMetrics, setGovernanceMetrics] = useState<GovernanceMetric[]>(mockGovernanceMetrics);

    // AI additional functions
    const { aiResponse: impactAnalysis, aiLoading: impactLoading, generateContent: generateImpactAnalysis } = useAIInteraction({
        apiKey: process.env.NEXT_PUBLIC_API_KEY as string,
        model: 'gemini-pro',
    });
    const { aiResponse: riskAssessment, aiLoading: riskLoading, generateContent: generateRiskAssessment } = useAIInteraction({
        apiKey: process.env.NEXT_PUBLIC_API_KEY as string,
        model: 'gemini-pro',
    });


    // Effects
    useEffect(() => {
        // Simulate fetching initial data
        setProposals(mockProposals);
        setTreasuryAssets(mockTreasuryAssets);
        setGrants(mockGrants);
        setDelegates(mockDelegates);
        if (userProfile) {
            setMyDelegatedTo(userProfile.delegatedTo);
            setNotifications(userProfile.notifications);
        }
        setGovernanceMetrics(mockGovernanceMetrics);
    }, [userProfile]); // Refresh if userProfile changes (e.g., wallet connect)

    // Handlers for Proposal Management
    const handleFilterProposals = useMemo(() => {
        let filtered = proposals;
        if (activeTab !== 'All') {
            filtered = filtered.filter(p => p.status === activeTab);
        }
        if (searchTerm) {
            filtered = filtered.filter(p =>
                p.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.proposer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
            );
        }
        if (sortOrder === 'latest') {
            filtered.sort((a, b) => b.votingPeriodStart.getTime() - a.votingPeriodStart.getTime());
        } else if (sortOrder === 'mostVoted') {
            filtered.sort((a, b) => b.totalVotes - a.totalVotes);
        }
        return filtered;
    }, [proposals, activeTab, searchTerm, sortOrder]);

    const paginatedProposals = useMemo(() => {
        const startIndex = (currentPage - 1) * proposalsPerPage;
        const endIndex = startIndex + proposalsPerPage;
        return handleFilterProposals.slice(startIndex, endIndex);
    }, [handleFilterProposals, currentPage, proposalsPerPage]);

    const totalPages = Math.ceil(handleFilterProposals.length / proposalsPerPage);

    const handleVote = useCallback(async (proposalId: string, option: VoteOption) => {
        console.log(`User ${address} voting ${option} on proposal ${proposalId}`);
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1500));
        // Update mock data: find proposal, increment vote count
        setProposals(prev => prev.map(p => {
            if (p.id === proposalId) {
                const newP = { ...p };
                if (option === VoteOption.For) newP.forVotes += (userProfile?.currentVotingPower || 0);
                if (option === VoteOption.Against) newP.againstVotes += (userProfile?.currentVotingPower || 0);
                if (option === VoteOption.Abstain) newP.abstainVotes += (userProfile?.currentVotingPower || 0);
                newP.totalVotes += (userProfile?.currentVotingPower || 0);
                return newP;
            }
            return p;
        }));
        // Add user's vote to mockVotes
        mockVotes.push({
            proposalId,
            voterAddress: address!,
            option,
            votingPower: userProfile?.currentVotingPower || 0,
            timestamp: new Date(),
            transactionHash: generateRandomAddress(),
        });
        setSelectedProposal(prev => prev ? { ...prev,
            forVotes: prev.forVotes + (option === VoteOption.For ? (userProfile?.currentVotingPower || 0) : 0),
            againstVotes: prev.againstVotes + (option === VoteOption.Against ? (userProfile?.currentVotingPower || 0) : 0),
            abstainVotes: prev.abstainVotes + (option === VoteOption.Abstain ? (userProfile?.currentVotingPower || 0) : 0),
            totalVotes: prev.totalVotes + (userProfile?.currentVotingPower || 0),
        } : null);
        console.log("Vote recorded.");
    }, [address, userProfile]);

    const handleCreateProposal = useCallback(async (newProposalData: Partial<Proposal>) => {
        console.log("Creating new proposal:", newProposalData);
        await new Promise(resolve => setTimeout(resolve, 2000));
        const newProposal: Proposal = {
            id: `prop-${proposals.length + 1}-${Date.now()}`,
            proposer: address!,
            status: ProposalStatus.Pending,
            votingPeriodStart: new Date(),
            votingPeriodEnd: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // Default 7 days
            forVotes: 0, againstVotes: 0, abstainVotes: 0, totalVotes: 0,
            quorumThreshold: 0.20, passThreshold: 0.50,
            tags: ['Community', 'New'],
            detailsLink: '',
            ...newProposalData,
            description: newProposalData.description || "No description provided.",
            title: newProposalData.title || "Untitled Proposal",
            contractInteraction: newProposalData.contractInteraction || null,
        };
        setProposals(prev => [...prev, newProposal]);
        setNotifications(prev => [{
            id: `notif-${Date.now()}`,
            type: NotificationType.NewProposal,
            message: `New proposal created: "${newProposal.title}"`,
            timestamp: new Date(),
            read: false,
            relatedEntityId: newProposal.id,
        }, ...prev]);
        console.log("Proposal created:", newProposal.id);
        setProposalCreationOpen(false); // Close form after creation
    }, [address, proposals.length]);


    // Handlers for Delegation
    const handleDelegateVote = useCallback(async (delegateAddress: string) => {
        if (!isConnected || !address) {
            console.warn("Wallet not connected to delegate.");
            return;
        }
        console.log(`Delegating ${userProfile?.currentVotingPower} power to ${delegateAddress}`);
        await new Promise(resolve => setTimeout(resolve, 1500));
        setMyDelegatedTo(delegateAddress);
        if (userProfile) {
            userProfile.delegatedTo = delegateAddress;
            // In a real app, update on-chain and refresh user profile
        }
        setNotifications(prev => [{
            id: `notif-${Date.now()}`,
            type: NotificationType.DelegationChange,
            message: `You delegated your voting power to ${formatAddress(delegateAddress)}.`,
            timestamp: new Date(),
            read: false,
        }, ...prev]);
        console.log("Delegation successful.");
    }, [isConnected, address, userProfile]);

    const handleUndelegateVote = useCallback(async () => {
        if (!isConnected || !address) return;
        console.log("Undelegating voting power.");
        await new Promise(resolve => setTimeout(resolve, 1500));
        setMyDelegatedTo(undefined);
        if (userProfile) {
            userProfile.delegatedTo = undefined;
        }
        setNotifications(prev => [{
            id: `notif-${Date.now()}`,
            type: NotificationType.DelegationChange,
            message: `You undelegated your voting power.`,
            timestamp: new Date(),
            read: false,
        }, ...prev]);
        console.log("Undelegation successful.");
    }, [isConnected, address, userProfile]);

    // Handle AI Summarizer
    const triggerSummarize = useCallback(async () => {
        if (!process.env.NEXT_PUBLIC_API_KEY) {
            alert("API Key not configured for AI summarizer.");
            return;
        }
        await handleSummarizeAI(`Summarize the key points of the following DAO governance proposal into 3 simple bullet points. Proposal: "${proposalText}"`);
    }, [proposalText, handleSummarizeAI]);

    const totalTreasuryValue = useMemo(() => treasuryAssets.reduce((sum, asset) => sum + asset.usdValue, 0), [treasuryAssets]);

    // Function to mark notifications as read
    const markNotificationAsRead = useCallback((id: string) => {
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
    }, []);

    return (
        <WalletProvider> {/* Wrap the whole component tree in WalletProvider to provide context */}
        <>
            <div className="space-y-6">
                <div className="flex justify-between items-center mb-8">
                    <h2 className="text-4xl font-extrabold text-white tracking-wider">DAO Governance Dashboard</h2>
                    <div className="flex items-center space-x-4">
                        {isConnected ? (
                            <>
                                <div className="relative">
                                    <button onClick={() => { /* Toggle notification dropdown */ }} className="p-2 rounded-full bg-gray-700 hover:bg-gray-600 text-gray-300 relative">
                                        {/* <FiBell className="w-5 h-5" /> */}
                                        
                                        {unreadNotificationsCount > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                                {unreadNotificationsCount}
                                            </span>
                                        )}
                                    </button>
                                    {/* Notification Dropdown (mocked) */}
                                    {/* <div className="absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl overflow-hidden z-50">
                                        <div className="p-3 border-b border-gray-700 flex justify-between items-center">
                                            <h4 className="font-semibold text-white">Notifications</h4>
                                            <button onClick={() => setNotifications(prev => prev.map(n => ({ ...n, read: true })))} className="text-xs text-cyan-500 hover:underline">Mark All Read</button>
                                        </div>
                                        <div className="max-h-60 overflow-y-auto custom-scrollbar">
                                            {notifications.length === 0 ? (
                                                <p className="p-3 text-sm text-gray-400 text-center">No new notifications.</p>
                                            ) : (
                                                notifications.map(notif => (
                                                    <div key={notif.id} onClick={() => markNotificationAsRead(notif.id)} className="cursor-pointer">
                                                        <ActivityFeedItem notification={notif} />
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                        <div className="p-3 border-t border-gray-700 text-center">
                                            <button className="text-sm text-cyan-500 hover:underline">View All</button>
                                        </div>
                                    </div> */}
                                </div>
                                <span className="text-gray-300 text-sm">{formatAddress(address!)}</span>
                                <button onClick={disconnectWallet} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium">Disconnect</button>
                            </>
                        ) : (
                            <button onClick={connectWallet} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">Connect Wallet</button>
                        )}
                        <button onClick={() => setSummarizerOpen(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium">AI Proposal Summarizer</button>
                    </div>
                </div>

                {/* Main Dashboard Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    {/* Treasury Overview Card */}
                    <Card className="col-span-1 lg:col-span-1" title="Treasury Overview" icon="FiDollarSign">
                        <div className="space-y-4">
                            <div className="flex justify-between items-center pb-2 border-b border-gray-700">
                                <p className="text-lg text-gray-300">Total Value:</p>
                                <p className="text-2xl font-bold text-green-400">{formatNumber(totalTreasuryValue, true, 2)} USD</p>
                            </div>
                            <h4 className="text-md font-semibold text-white">Top Assets:</h4>
                            <ul className="space-y-2">
                                {treasuryAssets.slice(0, 3).map(asset => (
                                    <li key={asset.id} className="flex justify-between items-center text-sm text-gray-400">
                                        <div className="flex items-center space-x-2">
                                            <img src={asset.logoUrl || `https://via.placeholder.com/20/random?text=${asset.symbol}`} alt={asset.symbol} className="w-5 h-5 rounded-full" />
                                            <span>{asset.name} ({asset.symbol})</span>
                                        </div>
                                        <span className="font-medium text-gray-300">{formatNumber(asset.amount, false, 2)} ({formatNumber(asset.usdValue, true, 0)})</span>
                                    </li>
                                ))}
                            </ul>
                            <div className="flex justify-end pt-2 border-t border-gray-700">
                                <button className="text-cyan-500 hover:underline text-sm">View Full Treasury</button>
                            </div>
                        </div>
                    </Card>

                    {/* My Voting Power Card */}
                    <Card className="col-span-1" title="My Voting Power" icon="FiZap">
                        <div className="space-y-4">
                            {isConnected && userProfile ? (
                                <>
                                    <div className="flex justify-between items-center">
                                        <p className="text-lg text-gray-300">Available Power:</p>
                                        <p className="text-2xl font-bold text-purple-400">{formatNumber(userProfile.tokenBalance)} DAO</p>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 border-t border-gray-700">
                                        <p className="text-md text-gray-400">Delegated Power:</p>
                                        <p className="text-xl font-semibold text-cyan-400">{formatNumber(userProfile.currentVotingPower)} Votes</p>
                                    </div>
                                    {myDelegatedTo ? (
                                        <div className="text-sm text-gray-400">
                                            Currently delegated to: <span className="text-cyan-300 font-medium">{formatAddress(myDelegatedTo)}</span>
                                            <button onClick={handleUndelegateVote} className="ml-3 px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-medium">Undelegate</button>
                                        </div>
                                    ) : (
                                        <p className="text-sm text-gray-400">
                                            Your voting power is not delegated. Consider delegating to an experienced delegate.
                                        </p>
                                    )}
                                    <div className="flex justify-end pt-2 border-t border-gray-700">
                                        <button className="text-cyan-500 hover:underline text-sm" onClick={() => setActiveTab('Delegation')}>Manage Delegation</button>
                                    </div>
                                </>
                            ) : (
                                <p className="text-gray-400 text-center py-8">Connect your wallet to see your voting power.</p>
                            )}
                        </div>
                    </Card>

                    {/* Governance Metrics Summary Card */}
                    <Card className="col-span-1" title="Governance Metrics" icon="FiBarChart2">
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p className="text-gray-400">Total Proposals (Last 30D)</p>
                                    <p className="text-xl font-bold text-white">{formatNumber(governanceMetrics.slice(-1)[0]?.totalProposals || 0)}</p>
                                </div>
                                <div>
                                    <p className="text-gray-400">Voting Participation (Avg)</p>
                                    <p className="text-xl font-bold text-white">{(governanceMetrics.slice(-1)[0]?.participationRate * 100 || 0).toFixed(1)}%</p>
                                </div>
                                <div>
                                    <p className="text-gray-400">Successful Proposals</p>
                                    <p className="text-xl font-bold text-green-400">{formatNumber(governanceMetrics.reduce((sum, m) => sum + m.passedProposals, 0))}</p>
                                </div>
                                <div>
                                    <p className="text-gray-400">Active Delegates</p>
                                    <p className="text-xl font-bold text-cyan-400">{delegates.length}</p>
                                </div>
                            </div>
                            <div className="flex justify-end pt-2 border-t border-gray-700">
                                <button className="text-cyan-500 hover:underline text-sm">View Full Analytics</button>
                            </div>
                        </div>
                    </Card>
                </div>

                {/* Proposals Section */}
                <Card className="col-span-3" title="DAO Proposals">
                    <div className="space-y-6">
                        <div className="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div className="flex space-x-2">
                                {['All', 'Active', 'Passed', 'Failed', 'Pending'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => { setActiveTab(tab as any); setCurrentPage(1); }}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium ${activeTab === tab ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                    >
                                        {tab} ({handleFilterProposals.filter(p => tab === 'All' || p.status === tab).length})
                                    </button>
                                ))}
                            </div>
                            <div className="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full md:w-auto">
                                <input
                                    type="text"
                                    placeholder="Search proposals..."
                                    value={searchTerm}
                                    onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                                    className="w-full sm:w-60 px-3 py-2 bg-gray-900/50 border border-gray-700 rounded-lg text-white text-sm focus:ring-cyan-500 focus:border-cyan-500"
                                />
                                <select
                                    value={sortOrder}
                                    onChange={(e) => setSortOrder(e.target.value as any)}
                                    className="w-full sm:w-auto px-3 py-2 bg-gray-900/50 border border-gray-700 rounded-lg text-white text-sm focus:ring-cyan-500 focus:border-cyan-500"
                                >
                                    <option value="latest">Sort by Latest</option>
                                    <option value="mostVoted">Sort by Most Voted</option>
                                </select>
                                {isConnected && (
                                     <button onClick={() => setProposalCreationOpen(true)} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium w-full sm:w-auto">
                                        {/* <FiPlusCircle className="inline-block mr-1" /> */}
                                        + Create Proposal
                                    </button>
                                )}

                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {paginatedProposals.length > 0 ? (
                                paginatedProposals.map(proposal => (
                                    <ProposalCard key={proposal.id} proposal={proposal} onViewDetails={setSelectedProposal} />
                                ))
                            ) : (
                                <p className="col-span-full text-center text-gray-400 py-10">No proposals found matching your criteria.</p>
                            )}
                        </div>

                        {/* Pagination */}
                        {totalPages > 1 && (
                            <div className="flex justify-center items-center space-x-4 mt-6">
                                <button
                                    onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                    disabled={currentPage === 1}
                                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Previous
                                </button>
                                <span className="text-gray-300 text-sm">Page {currentPage} of {totalPages}</span>
                                <button
                                    onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                    disabled={currentPage === totalPages}
                                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Next
                                </button>
                            </div>
                        )}
                    </div>
                </Card>

                {/* Delegates Section */}
                <Card title="DAO Delegates" icon="FiUsers">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {delegates.map(delegate => (
                            <DelegateCard
                                key={delegate.address}
                                delegate={delegate}
                                onDelegate={handleDelegateVote}
                                isDelegatedTo={isConnected && userProfile?.delegatedTo === delegate.address}
                            />
                        ))}
                    </div>
                    {delegates.length === 0 && (
                         <p className="col-span-full text-center text-gray-400 py-10">No delegates found.</p>
                    )}
                </Card>

                {/* Grant Programs Section */}
                <Card title="Grant Programs" icon="FiGlobe">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {grants.length > 0 ? (
                            grants.map(grant => <GrantCard key={grant.id} grant={grant} />)
                        ) : (
                            <p className="col-span-full text-center text-gray-400 py-10">No active grant programs.</p>
                        )}
                    </div>
                </Card>

                {/* Governance Activity Feed */}
                <Card title="Recent Governance Activity" icon="FiMessageSquare">
                    <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                        {notifications.length > 0 ? (
                            notifications.map(notif => (
                                <div key={notif.id} onClick={() => markNotificationAsRead(notif.id)} className="cursor-pointer">
                                    <ActivityFeedItem notification={notif} />
                                </div>
                            ))
                        ) : (
                            <p className="text-center text-gray-400 py-10">No recent activity.</p>
                        )}
                    </div>
                </Card>

                {/* Advanced Governance Analytics Chart */}
                <Card title="Historical Governance Metrics" icon="FiPieChart">
                    <div className="h-96 w-full">
                        <MockLineChart
                            data={governanceMetrics.map(m => ({
                                name: m.date.toLocaleString('default', { month: 'short', year: 'numeric' }),
                                'Total Proposals': m.totalProposals,
                                'Votes Cast': m.totalVotesCast / 1000, // Scale for chart
                                'Participation Rate': m.participationRate * 100,
                                'Treasury Value (M)': m.treasuryValue / 1000000,
                            }))}
                            dataKey="Total Proposals"
                            name="Proposals Over Time"
                        />
                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-6 text-sm text-gray-400">
                            <p>Total Metrics: {governanceMetrics.length} months</p>
                            <p>Avg. Proposals/Month: {(governanceMetrics.reduce((sum, m) => sum + m.totalProposals, 0) / governanceMetrics.length).toFixed(1)}</p>
                            <p>Avg. Participation Rate: {(governanceMetrics.reduce((sum, m) => sum + m.participationRate, 0) / governanceMetrics.length * 100).toFixed(1)}%</p>
                            <p>Max Treasury Value: {formatNumber(Math.max(...governanceMetrics.map(m => m.treasuryValue)), true, 0)}</p>
                        </div>
                    </div>
                </Card>

            </div>

            {/* AI Proposal Summarizer Modal */}
            {isSummarizerOpen && (
                 <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setSummarizerOpen(false)}>
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full border border-gray-700" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-white">AI Proposal Summarizer</h3>
                            <button onClick={() => setSummarizerOpen(false)} className="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-4">
                             <textarea
                                value={proposalText}
                                onChange={e => setProposalText(e.target.value)}
                                className="w-full h-40 bg-gray-900/50 p-2 rounded text-white text-sm border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500"
                                placeholder="Paste your detailed DAO proposal here for an AI summary..."
                            />
                             <button
                                onClick={triggerSummarize}
                                disabled={isLoading}
                                className="w-full py-2 bg-cyan-600 rounded disabled:opacity-50 hover:bg-cyan-700 text-white font-medium"
                            >
                                {isLoading ? 'Summarizing...' : 'Summarize Proposal'}
                            </button>
                            <Card title="Summary (Gemini AI)">
                                <div className="min-h-[6rem] text-sm text-gray-300 whitespace-pre-line">
                                    {isLoading ? '...' : (summary || summaryError || 'Enter proposal text and click summarize.')}
                                </div>
                                {summaryError && <p className="text-red-400 text-xs mt-2">{summaryError}</p>}
                            </Card>
                            <Card title="AI Impact Analysis (Optional - Mock)" className="bg-gray-900/50">
                                <button
                                    onClick={() => generateImpactAnalysis(`Analyze the potential impact of the following DAO governance proposal, considering its effects on tokenomics, community engagement, and protocol security. Proposal: "${proposalText}"`)}
                                    disabled={impactLoading || !proposalText}
                                    className="w-full py-2 bg-purple-600 rounded disabled:opacity-50 hover:bg-purple-700 text-white text-sm font-medium"
                                >
                                    {impactLoading ? 'Analyzing Impact...' : 'Generate Impact Analysis'}
                                </button>
                                <div className="min-h-[4rem] text-sm text-gray-300 whitespace-pre-line mt-2">
                                    {impactLoading ? '...' : (impactAnalysis || 'Click to analyze impact.')}
                                </div>
                            </Card>
                            <Card title="AI Risk Assessment (Optional - Mock)" className="bg-gray-900/50">
                                <button
                                    onClick={() => generateRiskAssessment(`Identify potential risks associated with the following DAO governance proposal, including financial, technical, and governance risks. Suggest mitigation strategies. Proposal: "${proposalText}"`)}
                                    disabled={riskLoading || !proposalText}
                                    className="w-full py-2 bg-red-600 rounded disabled:opacity-50 hover:bg-red-700 text-white text-sm font-medium"
                                >
                                    {riskLoading ? 'Assessing Risks...' : 'Generate Risk Assessment'}
                                </button>
                                <div className="min-h-[4rem] text-sm text-gray-300 whitespace-pre-line mt-2">
                                    {riskLoading ? '...' : (riskAssessment || 'Click to assess risks.')}
                                </div>
                            </Card>
                        </div>
                    </div>
                 </div>
            )}

            {/* Proposal Details Modal */}
            {selectedProposal && (
                <ProposalDetailsModal
                    proposal={selectedProposal}
                    onClose={() => setSelectedProposal(null)}
                    onVote={handleVote}
                />
            )}

            {/* Proposal Creation Modal */}
            {isProposalCreationOpen && (
                <ProposalCreationForm
                    onCreateProposal={handleCreateProposal}
                    onClose={() => setProposalCreationOpen(false)}
                />
            )}
        </>
        </WalletProvider>
    );
};

export default DaoGovernanceView;
```typescript
// components/views/megadashboard/digitalassets/DaoGovernanceView.tsx
import React, { useState, useEffect, useCallback, useMemo, createContext, useContext } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// --- START: NEW IMPORTS FOR EXTENDED FUNCTIONALITY ---
// Assuming these are standard icon libraries or similar, not creating them for line count
// import { FiPieChart, FiUsers, FiDollarSign, FiZap, FiSettings, FiPlusCircle, FiBarChart2, FiGlobe, FiMessageSquare, FiBell, FiChevronRight } from 'react-icons/fi';
// import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts'; // Placeholder for charts
// --- END: NEW IMPORTS FOR EXTENDED FUNCTIONALITY ---

// --- START: MOCK DATA AND TYPE DEFINITIONS (adds significant lines) ---

// Utility types
type Awaited<T> = T extends PromiseLike<infer U> ? U : T;

// DAO specific types
export enum ProposalStatus {
    Pending = 'Pending',
    Active = 'Active',
    Passed = 'Passed',
    Failed = 'Failed',
    Executed = 'Executed',
    Canceled = 'Canceled',
}

export enum VoteOption {
    For = 'For',
    Against = 'Against',
    Abstain = 'Abstain',
}

export interface Proposal {
    id: string;
    title: string;
    description: string;
    proposer: string;
    status: ProposalStatus;
    votingPeriodStart: Date;
    votingPeriodEnd: Date;
    forVotes: number;
    againstVotes: number;
    abstainVotes: number;
    totalVotes: number;
    quorumThreshold: number; // percentage, e.g., 0.20 for 20%
    passThreshold: number; // percentage of 'for' votes needed, e.g., 0.50 for 50%
    detailsLink: string;
    tags: string[];
    contractInteraction: {
        method: string;
        targetAddress: string;
        value: string; // e.g., "1000 ETH"
        parameters: { name: string; type: string; value: string; }[];
    } | null;
    aiSummary?: string;
    aiImpactAnalysis?: string;
    aiRiskAssessment?: string;
}

export interface Vote {
    proposalId: string;
    voterAddress: string;
    option: VoteOption;
    votingPower: number;
    timestamp: Date;
    transactionHash: string;
}

export interface TreasuryAsset {
    id: string;
    name: string;
    symbol: string;
    amount: number;
    usdValue: number;
    contractAddress: string;
    logoUrl: string;
}

export interface Grant {
    id: string;
    proposalId: string;
    title: string;
    description: string;
    recipient: string;
    amount: number;
    tokenSymbol: string;
    status: 'Approved' | 'Pending' | 'Rejected' | 'Paid';
    milestones: { description: string; status: 'Completed' | 'Pending'; payment: number; }[];
    applicationDate: Date;
    approvalDate?: Date;
}

export interface Delegate {
    address: string;
    name: string;
    bio: string;
    votingPower: number;
    proposalsVoted: number;
    forRate: number; // percentage of 'for' votes
    againstRate: number; // percentage of 'against' votes
    lastActive: Date;
    socialLinks: { twitter?: string; github?: string; website?: string; };
    image?: string;
}

export interface UserProfile {
    walletAddress: string;
    currentVotingPower: number;
    delegatedTo?: string; // Address of delegate
    delegators: string[]; // Addresses of users who delegated to this user
    tokenBalance: number;
    nftHoldings: { id: string; name: string; imageUrl: string; }[];
    notifications: Notification[];
}

export enum NotificationType {
    NewProposal = 'NewProposal',
    ProposalStatusChange = 'ProposalStatusChange',
    VoteOutcome = 'VoteOutcome',
    DelegationChange = 'DelegationChange',
    GrantUpdate = 'GrantUpdate',
    SystemMessage = 'SystemMessage',
}

export interface Notification {
    id: string;
    type: NotificationType;
    message: string;
    timestamp: Date;
    read: boolean;
    relatedEntityId?: string; // e.g., proposalId, grantId
}

export interface GovernanceMetric {
    date: Date;
    totalProposals: number;
    activeProposals: number;
    passedProposals: number;
    failedProposals: number;
    totalVotesCast: number;
    uniqueVoters: number;
    participationRate: number; // percentage
    treasuryValue: number;
}

// Mock Data Generators (to simulate a large dataset)
const generateRandomAddress = () => `0x${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}${Math.random().toString(16).substring(2, 10)}`;
const generateRandomDate = (start: Date, end: Date) => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
const randomInt = (min: number, max: number) => Math.floor(Math.random() * (max - min + 1)) + min;
const randomFloat = (min: number, max: number) => Math.random() * (max - min) + min;

export const mockProposals: Proposal[] = Array.from({ length: 50 }).map((_, i) => {
    const statusOptions = Object.values(ProposalStatus);
    const status = statusOptions[randomInt(0, statusOptions.length - 1)];
    const startDate = generateRandomDate(new Date(2023, 0, 1), new Date());
    const endDate = new Date(startDate.getTime() + randomInt(3, 7) * 24 * 60 * 60 * 1000); // 3-7 days later

    const forVotes = randomInt(10000, 500000);
    const againstVotes = randomInt(5000, 200000);
    const abstainVotes = randomInt(1000, 50000);
    const totalVotes = forVotes + againstVotes + abstainVotes;

    return {
        id: `prop-${i + 1}`,
        title: `Proposal to ${['Enhance', 'Optimize', 'Fund', 'Decentralize', 'Integrate'][randomInt(0, 4)]} DAO ${['Treasury', 'Protocol', 'Community', 'Security', 'User Experience'][randomInt(0, 4)]} - v${randomInt(1, 5)}.${randomInt(0, 9)}`,
        description: `This proposal outlines a plan to ${['allocate funds for a new initiative', 'update the core smart contracts', 'engage more community members', 'improve governance mechanisms', 'expand partnerships'][randomInt(0, 4)]} by doing X, Y, and Z. We believe this will result in A, B, and C. The estimated cost is ${randomInt(10000, 1000000)} tokens, to be sourced from the DAO treasury. This is a detailed description of the proposal aiming to improve the overall ecosystem health and sustainability. It covers technical specifications, financial implications, and community benefits. We encourage all token holders to review the full details linked below and cast their vote. This action is critical for the long-term growth and success of the DAO.`,
        proposer: generateRandomAddress(),
        status: status,
        votingPeriodStart: startDate,
        votingPeriodEnd: endDate,
        forVotes: forVotes,
        againstVotes: againstVotes,
        abstainVotes: abstainVotes,
        totalVotes: totalVotes,
        quorumThreshold: 0.10 + randomFloat(0, 0.20), // 10-30%
        passThreshold: 0.50 + randomFloat(0, 0.20), // 50-70%
        detailsLink: `https://example.com/proposals/prop-${i + 1}`,
        tags: [
            ['Treasury', 'Protocol', 'Community', 'Grants', 'Security'][randomInt(0, 4)],
            ['Development', 'Marketing', 'Ecosystem', 'Operations'][randomInt(0, 3)]
        ],
        contractInteraction: i % 3 === 0 ? {
            method: 'transfer',
            targetAddress: generateRandomAddress(),
            value: `${randomInt(1000, 100000)} ETH`,
            parameters: [
                { name: 'recipient', type: 'address', value: generateRandomAddress() },
                { name: 'amount', type: 'uint256', value: randomInt(100, 10000).toString() }
            ]
        } : null,
        aiSummary: i % 5 === 0 ? `Key Points: 1. Allocate ${randomInt(10, 50)}% treasury for new grant. 2. Establish 3-person review committee. 3. Focus on ecosystem growth and developer incentives.` : undefined,
        aiImpactAnalysis: i % 5 === 1 ? `Predicted Impact: High positive on developer engagement, moderate on token value. Potential risks include misuse of funds without strict oversight.` : undefined,
        aiRiskAssessment: i % 5 === 2 ? `Risk Assessment: Low technical risk, moderate financial risk due to new expenditure, low governance risk.` : undefined,
    };
});

export const mockVotes: Vote[] = Array.from({ length: 200 }).map((_, i) => ({
    proposalId: mockProposals[randomInt(0, mockProposals.length - 1)].id,
    voterAddress: generateRandomAddress(),
    option: Object.values(VoteOption)[randomInt(0, 2)],
    votingPower: randomInt(10, 100000),
    timestamp: generateRandomDate(new Date(2023, 0, 1), new Date()),
    transactionHash: `0x${Math.random().toString(16).substring(2, 18)}${Math.random().toString(16).substring(2, 18)}`
}));

export const mockTreasuryAssets: TreasuryAsset[] = [
    { id: '1', name: 'Ethereum', symbol: 'ETH', amount: 5000 + randomInt(0, 1000), usdValue: (5000 + randomInt(0, 1000)) * 3000, contractAddress: '0x...', logoUrl: '/eth.png' },
    { id: '2', name: 'DAO Token', symbol: 'DAO', amount: 10000000 + randomInt(0, 1000000), usdValue: (10000000 + randomInt(0, 1000000)) * 0.5, contractAddress: '0x...', logoUrl: '/dao.png' },
    { id: '3', name: 'USDC', symbol: 'USDC', amount: 2000000 + randomInt(0, 500000), usdValue: (2000000 + randomInt(0, 500000)) * 1, contractAddress: '0x...', logoUrl: '/usdc.png' },
    { id: '4', name: 'Wrapped BTC', symbol: 'WBTC', amount: 50 + randomInt(0, 10), usdValue: (50 + randomInt(0, 10)) * 60000, contractAddress: '0x...', logoUrl: '/wbtc.png' },
    { id: '5', name: 'Aave', symbol: 'AAVE', amount: 10000 + randomInt(0, 1000), usdValue: (10000 + randomInt(0, 1000)) * 100, contractAddress: '0x...', logoUrl: '/aave.png' },
];

export const mockGrants: Grant[] = Array.from({ length: 15 }).map((_, i) => ({
    id: `grant-${i + 1}`,
    proposalId: mockProposals[randomInt(0, mockProposals.length - 1)].id,
    title: `Grant for ${['Front-end Development', 'Smart Contract Audit', 'Community Engagement', 'Educational Content', 'Research Initiative'][randomInt(0, 4)]}`,
    description: `This grant aims to support the development of a key feature for the DAO, ensuring its long-term viability and competitiveness in the ecosystem.`,
    recipient: generateRandomAddress(),
    amount: randomInt(5000, 50000),
    tokenSymbol: ['DAO', 'USDC'][randomInt(0, 1)],
    status: ['Approved', 'Pending', 'Rejected', 'Paid'][randomInt(0, 3)],
    milestones: [
        { description: 'Phase 1 Completion', status: 'Completed', payment: randomInt(1000, 5000) },
        { description: 'Phase 2 Completion', status: 'Pending', payment: randomInt(1000, 5000) },
    ],
    applicationDate: generateRandomDate(new Date(2023, 6, 1), new Date()),
    approvalDate: i % 2 === 0 ? generateRandomDate(new Date(2023, 9, 1), new Date()) : undefined,
}));

export const mockDelegates: Delegate[] = Array.from({ length: 20 }).map((_, i) => ({
    address: generateRandomAddress(),
    name: `Delegate ${String.fromCharCode(65 + i)}`,
    bio: `Experienced in ${['protocol governance', 'financial analysis', 'community building', 'technical development'][randomInt(0, 3)]}. Committed to the long-term success of the DAO.`,
    votingPower: randomInt(100000, 5000000),
    proposalsVoted: randomInt(20, 100),
    forRate: randomFloat(0.6, 0.9),
    againstRate: randomFloat(0.1, 0.3),
    lastActive: generateRandomDate(new Date(2024, 0, 1), new Date()),
    socialLinks: {
        twitter: `https://twitter.com/delegate${i}`,
        github: i % 3 === 0 ? `https://github.com/delegate${i}` : undefined,
    },
    image: `https://i.pravatar.cc/150?img=${i + 10}` // Placeholder avatars
}));

export const mockUserProfile: UserProfile = {
    walletAddress: '0xMyWalletAddressABCDEF1234567890abcdef',
    currentVotingPower: 15000,
    delegatedTo: mockDelegates[0].address,
    delegators: Array.from({ length: 5 }).map(() => generateRandomAddress()),
    tokenBalance: 25000,
    nftHoldings: [
        { id: 'nft-1', name: 'DAO Founder Pass #123', imageUrl: 'https://via.placeholder.com/100/0000FF/FFFFFF?text=NFT1' },
        { id: 'nft-2', name: 'DAO Contributor Badge', imageUrl: 'https://via.placeholder.com/100/FF0000/FFFFFF?text=NFT2' },
    ],
    notifications: Array.from({ length: 7 }).map((_, i) => ({
        id: `notif-${i}`,
        type: Object.values(NotificationType)[randomInt(0, Object.values(NotificationType).length - 1)],
        message: `Notification ${i + 1}: Proposal #${mockProposals[i % mockProposals.length].id} ${['updated', 'passed', 'failed', 'newly created'][randomInt(0, 3)]}.`,
        timestamp: generateRandomDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), new Date()),
        read: i % 3 === 0,
    })),
};

export const mockGovernanceMetrics: GovernanceMetric[] = Array.from({ length: 12 }).map((_, i) => {
    const baseProposals = 10 + i * 2;
    const baseVotes = 50000 + i * 10000;
    const baseTreasury = 10000000 + i * 500000;
    return {
        date: new Date(2023, i + 1, 1),
        totalProposals: baseProposals + randomInt(-2, 2),
        activeProposals: randomInt(1, 5),
        passedProposals: randomInt(baseProposals * 0.6, baseProposals * 0.8),
        failedProposals: randomInt(baseProposals * 0.1, baseProposals * 0.2),
        totalVotesCast: baseVotes + randomInt(-5000, 5000),
        uniqueVoters: randomInt(baseVotes / 100, baseVotes / 50),
        participationRate: randomFloat(0.05, 0.25),
        treasuryValue: baseTreasury + randomInt(-1000000, 1000000),
    };
});

// Context for global state (e.g., wallet connection)
export interface WalletContextType {
    isConnected: boolean;
    address: string | null;
    connectWallet: () => Promise<void>;
    disconnectWallet: () => void;
    userProfile: UserProfile | null;
    fetchUserProfile: (address: string) => Promise<void>;
}

export const WalletContext = createContext<WalletContextType | undefined>(undefined);

export const useWallet = () => {
    const context = useContext(WalletContext);
    if (!context) {
        throw new Error('useWallet must be used within a WalletProvider');
    }
    return context;
};

// Wallet Provider Component (for future expansion, keeping within file for line count)
export const WalletProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [isConnected, setIsConnected] = useState<boolean>(false);
    const [address, setAddress] = useState<string | null>(null);
    const [userProfile, setUserProfile] = useState<UserProfile | null>(null);

    const connectWallet = useCallback(async () => {
        // Simulate wallet connection logic
        await new Promise(resolve => setTimeout(resolve, 1000));
        setIsConnected(true);
        setAddress(mockUserProfile.walletAddress);
        // In a real app, this would fetch the actual profile for the connected address
        setUserProfile(mockUserProfile);
        console.log("Wallet connected:", mockUserProfile.walletAddress);
    }, []);

    const disconnectWallet = useCallback(() => {
        setIsConnected(false);
        setAddress(null);
        setUserProfile(null);
        console.log("Wallet disconnected.");
    }, []);

    const fetchUserProfile = useCallback(async (walletAddress: string) => {
        // Simulate fetching user profile from backend/blockchain
        await new Promise(resolve => setTimeout(resolve, 500));
        if (walletAddress === mockUserProfile.walletAddress) {
            setUserProfile(mockUserProfile);
        } else {
            // Simulate a generic profile for an unconnected user or different address
            setUserProfile({
                walletAddress,
                currentVotingPower: randomInt(0, 5000),
                delegators: [],
                nftHoldings: [],
                notifications: [],
                tokenBalance: randomInt(0, 10000),
            });
        }
    }, []);

    const contextValue = useMemo(() => ({
        isConnected,
        address,
        connectWallet,
        disconnectWallet,
        userProfile,
        fetchUserProfile,
    }), [isConnected, address, connectWallet, disconnectWallet, userProfile, fetchUserProfile]);

    return (
        <WalletContext.Provider value={contextValue}>
            {children}
        </WalletContext.Provider>
    );
};

// Placeholder for an actual chart component using recharts
export const MockLineChart: React.FC<{ data: any[]; dataKey: string; name: string }> = ({ data, dataKey, name }) => (
    <div className="w-full h-64 bg-gray-900 rounded-lg flex items-center justify-center text-gray-400">
        <p className="text-center">
            {name} Chart Placeholder<br/>
            (Data points: {data.length})
        </p>
    </div>
);

// --- END: MOCK DATA AND TYPE DEFINITIONS ---


// --- START: NEW COMPONENTS AND HELPER FUNCTIONS (adds significant lines) ---

// Helper to format large numbers
export const formatNumber = (num: number, currency: boolean = false, decimals: number = 0) => {
    if (num >= 1000000) {
        return `${currency ? '$' : ''}${(num / 1000000).toFixed(decimals)}M`;
    }
    if (num >= 1000) {
        return `${currency ? '$' : ''}${(num / 1000).toFixed(decimals)}K`;
    }
    return `${currency ? '$' : ''}${num.toFixed(decimals)}`;
};

export const formatAddress = (address: string, chars = 6) => {
    if (!address) return '';
    return `${address.substring(0, chars)}...${address.substring(address.length - chars)}`;
};

export const getStatusColor = (status: ProposalStatus) => {
    switch (status) {
        case ProposalStatus.Active: return 'bg-blue-600';
        case ProposalStatus.Passed: return 'bg-green-600';
        case ProposalStatus.Failed: return 'bg-red-600';
        case ProposalStatus.Executed: return 'bg-purple-600';
        case ProposalStatus.Pending: return 'bg-yellow-600';
        case ProposalStatus.Canceled: return 'bg-gray-600';
        default: return 'bg-gray-500';
    }
};

// Custom Hook for AI Interactions
export interface AIInteractionOptions {
    model: string;
    apiKey: string;
}

export const useAIInteraction = (options: AIInteractionOptions) => {
    const [aiResponse, setAiResponse] = useState<string | null>(null);
    const [aiLoading, setAiLoading] = useState<boolean>(false);
    const [aiError, setAiError] = useState<string | null>(null);

    const generateContent = useCallback(async (prompt: string): Promise<string | null> => {
        setAiLoading(true);
        setAiError(null);
        setAiResponse(null);
        try {
            const ai = new GoogleGenAI({ apiKey: options.apiKey });
            const model = ai.getGenerativeModel({ model: options.model }); // Corrected method for getting model
            const result = await model.generateContent(prompt); // Adjusted to use model.generateContent
            const response = await result.response; // Get the response object
            const text = response.text() || ''; // Extract text content
            setAiResponse(text);
            return text;
        } catch (err: any) {
            console.error("AI Generation Error:", err);
            setAiError(err.message || "Failed to generate AI content.");
            return null;
        } finally {
            setAiLoading(false);
        }
    }, [options.apiKey, options.model]);

    return { aiResponse, aiLoading, aiError, generateContent };
};

// Proposal Card Component
export const ProposalCard: React.FC<{ proposal: Proposal; onViewDetails: (proposal: Proposal) => void }> = ({ proposal, onViewDetails }) => {
    const now = new Date();
    const isVotingActive = proposal.status === ProposalStatus.Active && now >= proposal.votingPeriodStart && now <= proposal.votingPeriodEnd;
    const votesForPercentage = proposal.totalVotes > 0 ? (proposal.forVotes / proposal.totalVotes) * 100 : 0;
    const votesAgainstPercentage = proposal.totalVotes > 0 ? (proposal.againstVotes / proposal.totalVotes) * 100 : 0;
    // const votesAbstainPercentage = proposal.totalVotes > 0 ? (proposal.abstainVotes / proposal.totalVotes) * 100 : 0;

    return (
        <div className="bg-gray-800 rounded-lg p-6 border border-gray-700 flex flex-col space-y-4 hover:shadow-lg hover:shadow-cyan-900/30 transition-shadow duration-300">
            <div className="flex justify-between items-start">
                <h3 className="text-xl font-semibold text-white leading-tight">{proposal.title}</h3>
                <span className={`px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(proposal.status)} text-white`}>
                    {proposal.status}
                </span>
            </div>
            <p className="text-gray-400 text-sm line-clamp-3">{proposal.description}</p>
            <div className="grid grid-cols-2 gap-2 text-sm text-gray-400">
                <div><span className="font-medium text-gray-300">Proposer:</span> {formatAddress(proposal.proposer)}</div>
                <div><span className="font-medium text-gray-300">Ends:</span> {proposal.votingPeriodEnd.toLocaleDateString()}</div>
                <div><span className="font-medium text-gray-300">Total Votes:</span> {formatNumber(proposal.totalVotes)}</div>
                <div><span className="font-medium text-gray-300">Quorum:</span> {(proposal.quorumThreshold * 100).toFixed(0)}%</div>
            </div>

            <div className="space-y-2">
                <div className="flex justify-between text-xs text-gray-400">
                    <span>For: {formatNumber(proposal.forVotes)} ({votesForPercentage.toFixed(1)}%)</span>
                    <span>Against: {formatNumber(proposal.againstVotes)} ({votesAgainstPercentage.toFixed(1)}%)</span>
                </div>
                <div className="w-full bg-gray-700 rounded-full h-2.5">
                    <div
                        className="bg-green-500 h-2.5 rounded-l-full"
                        style={{ width: `${votesForPercentage}%` }}
                    ></div>
                    <div
                        className="bg-red-500 h-2.5 rounded-r-full -mt-2.5"
                        style={{ width: `${votesAgainstPercentage}%`, marginLeft: `${votesForPercentage}%` }}
                    ></div>
                </div>
            </div>

            <div className="flex justify-end pt-4 border-t border-gray-700 mt-auto">
                {isVotingActive && (
                    <button className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium mr-2">
                        Vote Now
                    </button>
                )}
                <button
                    onClick={() => onViewDetails(proposal)}
                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium"
                >
                    View Details
                </button>
            </div>
        </div>
    );
};

// Proposal Details Modal Component
export const ProposalDetailsModal: React.FC<{ proposal: Proposal; onClose: () => void; onVote: (proposalId: string, option: VoteOption) => Promise<void> }> = ({ proposal, onClose, onVote }) => {
    const { isConnected, address, userProfile } = useWallet();
    const [selectedVote, setSelectedVote] = useState<VoteOption | null>(null);
    const [isVoting, setIsVoting] = useState(false);
    const [voteMessage, setVoteMessage] = useState<string | null>(null);

    const now = new Date();
    const isVotingActive = proposal.status === ProposalStatus.Active && now >= proposal.votingPeriodStart && now <= proposal.votingPeriodEnd;
    const hasVoted = mockVotes.some(v => v.proposalId === proposal.id && v.voterAddress === address); // Simplified check

    const handleCastVote = async () => {
        if (!isConnected || !address || !selectedVote) {
            setVoteMessage("Please connect wallet and select a vote option.");
            return;
        }
        setIsVoting(true);
        setVoteMessage(null);
        try {
            await onVote(proposal.id, selectedVote);
            setVoteMessage("Vote cast successfully!");
            // Optionally refresh proposal data
        } catch (error: any) {
            setVoteMessage(`Voting failed: ${error.message || "Unknown error"}`);
        } finally {
            setIsVoting(false);
        }
    };

    const votesForPercentage = proposal.totalVotes > 0 ? (proposal.forVotes / proposal.totalVotes) * 100 : 0;
    const votesAgainstPercentage = proposal.totalVotes > 0 ? (proposal.againstVotes / proposal.totalVotes) * 100 : 0;
    const votesAbstainPercentage = proposal.totalVotes > 0 ? (proposal.abstainVotes / proposal.totalVotes) * 100 : 0;
    const currentQuorum = proposal.totalVotes / (mockTreasuryAssets[1]?.amount || 1) * 100; // Total DAO tokens
    const isQuorumMet = currentQuorum >= (proposal.quorumThreshold * 100);
    const isPassedThresholdMet = votesForPercentage >= (proposal.passThreshold * 100);

    return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full border border-gray-700 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">{proposal.title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button>
                </div>
                <div className="p-6 space-y-6 text-gray-300">
                    <div className="flex justify-between items-center text-sm">
                        <span className="font-medium text-gray-200">Proposer: {formatAddress(proposal.proposer)}</span>
                        <span className={`px-3 py-1 text-xs font-medium rounded-full ${getStatusColor(proposal.status)} text-white`}>
                            {proposal.status}
                        </span>
                    </div>

                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Description</h4>
                        <p className="whitespace-pre-line">{proposal.description}</p>
                        {proposal.detailsLink && (
                            <a href={proposal.detailsLink} target="_blank" rel="noopener noreferrer" className="text-cyan-500 hover:underline text-sm mt-2 block">
                                Read full proposal
                            </a>
                        )}
                    </div>

                    {proposal.contractInteraction && (
                        <div>
                            <h4 className="font-semibold text-lg text-white mb-2">On-chain Action</h4>
                            <div className="bg-gray-900 p-4 rounded text-sm font-mono space-y-2">
                                <p>Method: <span className="text-purple-400">{proposal.contractInteraction.method}</span></p>
                                <p>Target: <span className="text-cyan-400">{formatAddress(proposal.contractInteraction.targetAddress, 10)}</span></p>
                                <p>Value: <span className="text-green-400">{proposal.contractInteraction.value}</span></p>
                                <p>Parameters:</p>
                                <ul className="list-disc list-inside ml-4">
                                    {proposal.contractInteraction.parameters.map((p, idx) => (
                                        <li key={idx}>
                                            {p.name} (<span className="text-yellow-400">{p.type}</span>): {p.value}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    )}

                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Voting Results</h4>
                        <div className="space-y-3">
                            <div className="flex justify-between text-sm">
                                <span>For: <span className="font-medium text-green-400">{formatNumber(proposal.forVotes)} ({votesForPercentage.toFixed(1)}%)</span></span>
                                <span>Against: <span className="font-medium text-red-400">{formatNumber(proposal.againstVotes)} ({votesAgainstPercentage.toFixed(1)}%)</span></span>
                                <span>Abstain: <span className="font-medium text-yellow-400">{formatNumber(proposal.abstainVotes)} ({votesAbstainPercentage.toFixed(1)}%)</span></span>
                            </div>
                            <div className="w-full bg-gray-700 rounded-full h-3 flex overflow-hidden">
                                <div className="bg-green-500 h-full" style={{ width: `${votesForPercentage}%` }}></div>
                                <div className="bg-red-500 h-full" style={{ width: `${votesAgainstPercentage}%` }}></div>
                                <div className="bg-yellow-500 h-full" style={{ width: `${votesAbstainPercentage}%` }}></div>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div><span className="font-medium text-gray-200">Quorum:</span> {(proposal.quorumThreshold * 100).toFixed(0)}% ({currentQuorum.toFixed(1)}% currently) <span className={`ml-1 text-xs font-semibold ${isQuorumMet ? 'text-green-400' : 'text-red-400'}`}>{isQuorumMet ? 'MET' : 'NOT MET'}</span></div>
                                <div><span className="font-medium text-gray-200">Pass Threshold:</span> {(proposal.passThreshold * 100).toFixed(0)}% For <span className={`ml-1 text-xs font-semibold ${isPassedThresholdMet ? 'text-green-400' : 'text-red-400'}`}>{isPassedThresholdMet ? 'MET' : 'NOT MET'}</span></div>
                            </div>
                        </div>
                    </div>

                    {proposal.aiSummary && (
                        <Card title="AI Summary (Gemini)" className="bg-gray-900/50">
                            <div className="text-sm text-gray-300 whitespace-pre-line">{proposal.aiSummary}</div>
                        </Card>
                    )}
                    {proposal.aiImpactAnalysis && (
                        <Card title="AI Impact Analysis (Gemini)" className="bg-gray-900/50">
                            <div className="text-sm text-gray-300 whitespace-pre-line">{proposal.aiImpactAnalysis}</div>
                        </Card>
                    )}
                     {proposal.aiRiskAssessment && (
                        <Card title="AI Risk Assessment (Gemini)" className="bg-gray-900/50">
                            <div className="text-sm text-gray-300 whitespace-pre-line">{proposal.aiRiskAssessment}</div>
                        </Card>
                    )}

                    {isVotingActive && isConnected && !hasVoted && (
                        <div className="p-4 bg-gray-900/50 rounded-lg space-y-4 border border-gray-700">
                            <h4 className="font-semibold text-lg text-white">Cast Your Vote</h4>
                            <div className="flex space-x-4">
                                {Object.values(VoteOption).map(option => (
                                    <button
                                        key={option}
                                        onClick={() => setSelectedVote(option)}
                                        className={`flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all duration-200
                                                    ${selectedVote === option ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                    >
                                        {option}
                                    </button>
                                ))}
                            </div>
                            <button
                                onClick={handleCastVote}
                                disabled={isVoting || !selectedVote || !userProfile?.currentVotingPower}
                                className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isVoting ? 'Submitting Vote...' : `Vote with ${formatNumber(userProfile?.currentVotingPower || 0)} Power`}
                            </button>
                            {voteMessage && <p className={`text-center text-sm ${voteMessage.includes('failed') ? 'text-red-400' : 'text-green-400'}`}>{voteMessage}</p>}
                        </div>
                    )}
                    {!isConnected && isVotingActive && (
                        <div className="p-4 bg-yellow-900/30 text-yellow-300 rounded-lg text-center">
                            Connect your wallet to cast a vote.
                        </div>
                    )}
                    {hasVoted && isConnected && (
                        <div className="p-4 bg-green-900/30 text-green-300 rounded-lg text-center">
                            You have already voted on this proposal.
                        </div>
                    )}
                    {!isVotingActive && (
                        <div className="p-4 bg-gray-900/50 text-gray-400 rounded-lg text-center">
                            Voting for this proposal is currently {proposal.status}.
                        </div>
                    )}

                    {/* Placeholder for comments/discussion */}
                    <div className="p-4 bg-gray-900/50 rounded-lg space-y-4 border border-gray-700">
                        <h4 className="font-semibold text-lg text-white">Discussion & Comments (Mock)</h4>
                        <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                            <div className="bg-gray-700 p-3 rounded-md text-sm">
                                <p className="font-semibold text-white">{formatAddress(generateRandomAddress(), 8)} <span className="text-gray-400 font-normal text-xs ml-2">{new Date().toLocaleDateString()}</span></p>
                                <p className="text-gray-300 mt-1">Great proposal, looking forward to seeing this implemented!</p>
                            </div>
                            <div className="bg-gray-700 p-3 rounded-md text-sm">
                                <p className="font-semibold text-white">{formatAddress(generateRandomAddress(), 8)} <span className="text-gray-400 font-normal text-xs ml-2">{new Date(Date.now() - 3600000).toLocaleDateString()}</span></p>
                                <p className="text-gray-300 mt-1">Concerns about the budget allocation, could we get a more detailed breakdown?</p>
                            </div>
                            <div className="bg-gray-700 p-3 rounded-md text-sm">
                                <p className="font-semibold text-white">{formatAddress(generateRandomAddress(), 8)} <span className="text-gray-400 font-normal text-xs ml-2">{new Date(Date.now() - 7200000).toLocaleDateString()}</span></p>
                                <p className="text-gray-300 mt-1">How will this impact the current treasury reserves? Any long-term projections?</p>
                            </div>
                        </div>
                        {isConnected && (
                            <div className="flex flex-col space-y-2">
                                <textarea
                                    className="w-full h-20 bg-gray-900/50 p-2 rounded text-white text-sm border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500"
                                    placeholder="Add your comment..."
                                ></textarea>
                                <button className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium self-end">
                                    Post Comment
                                </button>
                            </div>
                        )}
                    </div>

                </div>
            </div>
        </div>
    );
};


// Proposal Creation Form Component
export const ProposalCreationForm: React.FC<{ onCreateProposal: (proposalData: Partial<Proposal>) => Promise<void>; onClose: () => void }> = ({ onCreateProposal, onClose }) => {
    const { isConnected, address } = useWallet();
    const [title, setTitle] = useState('');
    const [description, setDescription] = useState('');
    const [detailsLink, setDetailsLink] = useState('');
    const [contractInteractionEnabled, setContractInteractionEnabled] = useState(false);
    const [targetAddress, setTargetAddress] = useState('');
    const [method, setMethod] = useState('');
    const [value, setValue] = useState('');
    const [parameters, setParameters] = useState<{ name: string; type: string; value: string; }[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');
    const [successMessage, setSuccessMessage] = useState('');

    const addParameter = () => setParameters([...parameters, { name: '', type: '', value: '' }]);
    const updateParameter = (index: number, field: string, val: string) => {
        const newParams = [...parameters];
        (newParams[index] as any)[field] = val;
        setParameters(newParams);
    };
    const removeParameter = (index: number) => setParameters(parameters.filter((_, i) => i !== index));

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!isConnected || !address) {
            setErrorMessage("Please connect your wallet to create a proposal.");
            return;
        }
        if (!title || !description) {
            setErrorMessage("Title and description are required.");
            return;
        }

        setIsLoading(true);
        setErrorMessage('');
        setSuccessMessage('');

        const newProposalData: Partial<Proposal> = {
            title,
            description,
            proposer: address, // Set connected user as proposer
            status: ProposalStatus.Pending, // New proposals start as pending
            votingPeriodStart: new Date(), // Placeholder, typically set by governance
            votingPeriodEnd: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days from now
            forVotes: 0, againstVotes: 0, abstainVotes: 0, totalVotes: 0,
            quorumThreshold: 0.20, // Default values
            passThreshold: 0.50, // Default values
            detailsLink: detailsLink || undefined,
            tags: ['Community', 'New'], // Default tags
            contractInteraction: contractInteractionEnabled && targetAddress && method ? {
                method,
                targetAddress,
                value,
                parameters: parameters.filter(p => p.name && p.type && p.value),
            } : null,
        };

        try {
            await onCreateProposal(newProposalData);
            setSuccessMessage("Proposal submitted successfully!");
            // Clear form
            setTitle(''); setDescription(''); setDetailsLink('');
            setContractInteractionEnabled(false); setTargetAddress(''); setMethod(''); setValue(''); setParameters([]);
            // onClose(); // Optionally close immediately
        } catch (error: any) {
            setErrorMessage(`Failed to create proposal: ${error.message || "Unknown error"}`);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-3xl w-full border border-gray-700 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">Create New Proposal</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button>
                </div>
                <form onSubmit={handleSubmit} className="p-6 space-y-6 text-gray-300">
                    <div className="form-group">
                        <label htmlFor="title" className="block text-sm font-medium text-gray-200 mb-1">Proposal Title</label>
                        <input
                            type="text"
                            id="title"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            className="w-full bg-gray-900/50 p-3 rounded-md border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                            placeholder="e.g., Allocate funds for Ecosystem Grants Program"
                            required
                        />
                    </div>
                    <div className="form-group">
                        <label htmlFor="description" className="block text-sm font-medium text-gray-200 mb-1">Description</label>
                        <textarea
                            id="description"
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            rows={8}
                            className="w-full bg-gray-900/50 p-3 rounded-md border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                            placeholder="Provide a detailed explanation of your proposal..."
                            required
                        />
                    </div>
                    <div className="form-group">
                        <label htmlFor="detailsLink" className="block text-sm font-medium text-gray-200 mb-1">External Details Link (Optional)</label>
                        <input
                            type="url"
                            id="detailsLink"
                            value={detailsLink}
                            onChange={(e) => setDetailsLink(e.target.value)}
                            className="w-full bg-gray-900/50 p-3 rounded-md border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-white"
                            placeholder="e.g., https://forum.dao.com/t/proposal-discussion-x-y-z"
                        />
                    </div>

                    <div className="form-group flex items-center">
                        <input
                            type="checkbox"
                            id="contractInteraction"
                            checked={contractInteractionEnabled}
                            onChange={(e) => setContractInteractionEnabled(e.target.checked)}
                            className="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-600 rounded bg-gray-700"
                        />
                        <label htmlFor="contractInteraction" className="ml-2 block text-sm font-medium text-gray-200">
                            Include On-chain Contract Interaction
                        </label>
                    </div>

                    {contractInteractionEnabled && (
                        <div className="bg-gray-900/50 p-4 rounded-lg space-y-4 border border-gray-700">
                            <h4 className="font-semibold text-lg text-white">Contract Interaction Details</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="form-group">
                                    <label htmlFor="targetAddress" className="block text-sm font-medium text-gray-200 mb-1">Target Contract Address</label>
                                    <input
                                        type="text"
                                        id="targetAddress"
                                        value={targetAddress}
                                        onChange={(e) => setTargetAddress(e.target.value)}
                                        className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white font-mono text-sm"
                                        placeholder="0x..."
                                        required={contractInteractionEnabled}
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="method" className="block text-sm font-medium text-gray-200 mb-1">Method Name</label>
                                    <input
                                        type="text"
                                        id="method"
                                        value={method}
                                        onChange={(e) => setMethod(e.target.value)}
                                        className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white font-mono text-sm"
                                        placeholder="e.g., transfer, updateConfig"
                                        required={contractInteractionEnabled}
                                    />
                                </div>
                            </div>
                            <div className="form-group">
                                <label htmlFor="value" className="block text-sm font-medium text-gray-200 mb-1">Value (e.g., ETH to send)</label>
                                <input
                                    type="text"
                                    id="value"
                                    value={value}
                                    onChange={(e) => setValue(e.target.value)}
                                    className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white font-mono text-sm"
                                    placeholder="e.g., 0.5 ETH, 1000000 WEI"
                                />
                            </div>

                            <h5 className="font-medium text-md text-white mt-4 mb-2">Parameters</h5>
                            {parameters.map((param, index) => (
                                <div key={index} className="flex gap-2 items-center bg-gray-700 p-3 rounded-md">
                                    <input
                                        type="text"
                                        placeholder="Name"
                                        value={param.name}
                                        onChange={(e) => updateParameter(index, 'name', e.target.value)}
                                        className="flex-1 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Type (e.g., address, uint256)"
                                        value={param.type}
                                        onChange={(e) => updateParameter(index, 'type', e.target.value)}
                                        className="flex-1 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Value"
                                        value={param.value}
                                        onChange={(e) => updateParameter(index, 'value', e.target.value)}
                                        className="flex-2 bg-gray-800 p-2 rounded border border-gray-600 text-white text-sm"
                                    />
                                    <button type="button" onClick={() => removeParameter(index)} className="p-2 text-red-400 hover:text-red-300">
                                        &times;
                                    </button>
                                </div>
                            ))}
                            <button type="button" onClick={addParameter} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                                Add Parameter
                            </button>
                        </div>
                    )}

                    {errorMessage && <p className="text-red-500 text-sm text-center">{errorMessage}</p>}
                    {successMessage && <p className="text-green-500 text-sm text-center">{successMessage}</p>}

                    <div className="flex justify-end space-x-3 pt-4 border-t border-gray-700">
                        <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium">
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={isLoading || !isConnected}
                            className="px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isLoading ? 'Submitting...' : 'Submit Proposal'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// Delegate Card Component
export const DelegateCard: React.FC<{ delegate: Delegate; onDelegate: (delegateAddress: string) => void; isDelegatedTo: boolean }> = ({ delegate, onDelegate, isDelegatedTo }) => {
    return (
        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700 flex flex-col items-center text-center space-y-3">
            <img src={delegate.image || `https://i.pravatar.cc/150?img=${delegate.address.charCodeAt(2)}`} alt={delegate.name} className="w-20 h-20 rounded-full object-cover border-2 border-cyan-500" />
            <h4 className="text-lg font-semibold text-white">{delegate.name}</h4>
            <p className="text-gray-400 text-sm line-clamp-2">{delegate.bio}</p>
            <div className="text-gray-300 text-sm">
                <p><span className="font-medium">Voting Power:</span> {formatNumber(delegate.votingPower)}</p>
                <p><span className="font-medium">Proposals Voted:</span> {delegate.proposalsVoted}</p>
                <p><span className="font-medium">For Rate:</span> {(delegate.forRate * 100).toFixed(0)}%</p>
            </div>
            <div className="flex space-x-2 mt-2">
                {delegate.socialLinks.twitter && (
                    <a href={delegate.socialLinks.twitter} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:text-cyan-300">
                        {/* <FiGlobe /> // Placeholder for actual icon */}
                        <span className="sr-only">Twitter</span>
                        <span className="text-xs">Twitter</span>
                    </a>
                )}
                {delegate.socialLinks.github && (
                    <a href={delegate.socialLinks.github} target="_blank" rel="noopener noreferrer" className="text-purple-400 hover:text-purple-300">
                        {/* <FiGithub /> */}
                        <span className="sr-only">GitHub</span>
                        <span className="text-xs">GitHub</span>
                    </a>
                )}
            </div>
            <button
                onClick={() => onDelegate(delegate.address)}
                disabled={isDelegatedTo}
                className={`w-full py-2 rounded-lg text-sm font-medium mt-4 ${isDelegatedTo ? 'bg-gray-600 text-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}
            >
                {isDelegatedTo ? 'Delegated' : 'Delegate Vote'}
            </button>
        </div>
    );
};

// Grant Card Component
export const GrantCard: React.FC<{ grant: Grant }> = ({ grant }) => {
    const getGrantStatusColor = (status: Grant['status']) => {
        switch (status) {
            case 'Approved': return 'bg-green-600';
            case 'Pending': return 'bg-yellow-600';
            case 'Rejected': return 'bg-red-600';
            case 'Paid': return 'bg-purple-600';
            default: return 'bg-gray-500';
        }
    };

    return (
        <div className="bg-gray-800 rounded-lg p-5 border border-gray-700 space-y-3">
            <div className="flex justify-between items-start">
                <h4 className="text-lg font-semibold text-white">{grant.title}</h4>
                <span className={`px-3 py-1 text-xs font-medium rounded-full ${getGrantStatusColor(grant.status)} text-white`}>
                    {grant.status}
                </span>
            </div>
            <p className="text-gray-400 text-sm line-clamp-2">{grant.description}</p>
            <div className="grid grid-cols-2 gap-2 text-sm text-gray-400">
                <div><span className="font-medium text-gray-300">Recipient:</span> {formatAddress(grant.recipient)}</div>
                <div><span className="font-medium text-gray-300">Amount:</span> {formatNumber(grant.amount)} {grant.tokenSymbol}</div>
                <div><span className="font-medium text-gray-300">Application:</span> {grant.applicationDate.toLocaleDateString()}</div>
                {grant.approvalDate && <div><span className="font-medium text-gray-300">Approved:</span> {grant.approvalDate.toLocaleDateString()}</div>}
            </div>
            <div>
                <h5 className="font-medium text-gray-300 text-sm mt-2">Milestones:</h5>
                <ul className="list-disc list-inside ml-2 text-gray-400 text-xs">
                    {grant.milestones.map((milestone, idx) => (
                        <li key={idx} className={milestone.status === 'Completed' ? 'text-green-500' : 'text-yellow-500'}>
                            {milestone.description} ({formatNumber(milestone.payment)} {grant.tokenSymbol}) - {milestone.status}
                        </li>
                    ))}
                </ul>
            </div>
            <div className="flex justify-end">
                <button className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-medium">
                    View Grant
                </button>
            </div>
        </div>
    );
};

// Activity Feed Item Component
export const ActivityFeedItem: React.FC<{ notification: Notification }> = ({ notification }) => {
    const getNotificationIcon = (type: NotificationType) => {
        switch (type) {
            case NotificationType.NewProposal: return '';
            case NotificationType.ProposalStatusChange: return '';
            case NotificationType.VoteOutcome: return '';
            case NotificationType.DelegationChange: return '';
            case NotificationType.GrantUpdate: return '';
            case NotificationType.SystemMessage: return '';
            default: return '';
        }
    };

    const getNotificationColor = (read: boolean) => read ? 'text-gray-500' : 'text-white';
    const getNotificationBg = (read: boolean) => read ? 'bg-gray-900' : 'bg-gray-700 hover:bg-gray-600';

    return (
        <div className={`flex items-center space-x-3 p-3 rounded-lg ${getNotificationBg(notification.read)} transition-colors duration-200`}>
            <span className={`text-xl ${getNotificationColor(notification.read)}`}>{getNotificationIcon(notification.type)}</span>
            <div className="flex-1">
                <p className={`text-sm ${getNotificationColor(notification.read)}`}>{notification.message}</p>
                <p className={`text-xs text-gray-400 mt-0.5`}>{notification.timestamp.toLocaleString()}</p>
            </div>
            {!notification.read && <span className="w-2 h-2 bg-cyan-500 rounded-full"></span>}
        </div>
    );
};


// Main DAO Governance View Component
export const DaoGovernanceView: React.FC = () => {
    // Original AI Summarizer State
    const [isSummarizerOpen, setSummarizerOpen] = useState(false);
    const [proposalText, setProposalText] = useState("Proposal to allocate 5% of treasury funds to a new grant program for ecosystem developers, subject to a 3-person committee review for grants over 10,000 tokens...");
    const { aiResponse: summary, aiLoading: isLoading, aiError: summaryError, generateContent: handleSummarizeAI } = useAIInteraction({
        apiKey: process.env.NEXT_PUBLIC_API_KEY as string, // Ensure API key is accessible for client-side
        model: 'gemini-pro', // Using gemini-pro for more general purpose use
    });

    // New State for expanded features
    const { isConnected, address, connectWallet, userProfile, disconnectWallet } = useWallet();

    // Proposal Management
    const [proposals, setProposals] = useState<Proposal[]>(mockProposals);
    const [activeTab, setActiveTab] = useState<'All' | 'Active' | 'Passed' | 'Failed' | 'Pending'>('All');
    const [searchTerm, setSearchTerm] = useState('');
    const [sortOrder, setSortOrder] = useState<'latest' | 'mostVoted'>('latest');
    const [selectedProposal, setSelectedProposal] = useState<Proposal | null>(null);
    const [isProposalCreationOpen, setProposalCreationOpen] = useState(false);
    const [currentPage, setCurrentPage] = useState(1);
    const proposalsPerPage = 8;

    // Treasury Management
    const [treasuryAssets, setTreasuryAssets] = useState<TreasuryAsset[]>(mockTreasuryAssets);
    const [grants, setGrants] = useState<Grant[]>(mockGrants);

    // Delegation
    const [delegates, setDelegates] = useState<Delegate[]>(mockDelegates);
    const [myDelegatedTo, setMyDelegatedTo] = useState<string | undefined>(userProfile?.delegatedTo);

    // Notifications
    const [notifications, setNotifications] = useState<Notification[]>(mockUserProfile.notifications);
    const unreadNotificationsCount = useMemo(() => notifications.filter(n => !n.read).length, [notifications]);

    // Governance Metrics
    const [governanceMetrics, setGovernanceMetrics] = useState<GovernanceMetric[]>(mockGovernanceMetrics);

    // AI additional functions
    const { aiResponse: impactAnalysis, aiLoading: impactLoading, generateContent: generateImpactAnalysis } = useAIInteraction({
        apiKey: process.env.NEXT_PUBLIC_API_KEY as string,
        model: 'gemini-pro',
    });
    const { aiResponse: riskAssessment, aiLoading: riskLoading, generateContent: generateRiskAssessment } = useAIInteraction({
        apiKey: process.env.NEXT_PUBLIC_API_KEY as string,
        model: 'gemini-pro',
    });


    // Effects
    useEffect(() => {
        // Simulate fetching initial data
        setProposals(mockProposals);
        setTreasuryAssets(mockTreasuryAssets);
        setGrants(mockGrants);
        setDelegates(mockDelegates);
        if (userProfile) {
            setMyDelegatedTo(userProfile.delegatedTo);
            setNotifications(userProfile.notifications);
        }
        setGovernanceMetrics(mockGovernanceMetrics);
    }, [userProfile]); // Refresh if userProfile changes (e.g., wallet connect)

    // Handlers for Proposal Management
    const handleFilterProposals = useMemo(() => {
        let filtered = proposals;
        if (activeTab !== 'All') {
            filtered = filtered.filter(p => p.status === activeTab);
        }
        if (searchTerm) {
            filtered = filtered.filter(p =>
                p.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.proposer.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
            );
        }
        if (sortOrder === 'latest') {
            filtered.sort((a, b) => b.votingPeriodStart.getTime() - a.votingPeriodStart.getTime());
        } else if (sortOrder === 'mostVoted') {
            filtered.sort((a, b) => b.totalVotes - a.totalVotes);
        }
        return filtered;
    }, [proposals, activeTab, searchTerm, sortOrder]);

    const paginatedProposals = useMemo(() => {
        const startIndex = (currentPage - 1) * proposalsPerPage;
        const endIndex = startIndex + proposalsPerPage;
        return handleFilterProposals.slice(startIndex, endIndex);
    }, [handleFilterProposals, currentPage, proposalsPerPage]);

    const totalPages = Math.ceil(handleFilterProposals.length / proposalsPerPage);

    const handleVote = useCallback(async (proposalId: string, option: VoteOption) => {
        console.log(`User ${address} voting ${option} on proposal ${proposalId}`);
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1500));
        // Update mock data: find proposal, increment vote count
        setProposals(prev => prev.map(p => {
            if (p.id === proposalId) {
                const newP = { ...p };
                if (option === VoteOption.For) newP.forVotes += (userProfile?.currentVotingPower || 0);
                if (option === VoteOption.Against) newP.againstVotes += (userProfile?.currentVotingPower || 0);
                if (option === VoteOption.Abstain) newP.abstainVotes += (userProfile?.currentVotingPower || 0);
                newP.totalVotes += (userProfile?.currentVotingPower || 0);
                return newP;
            }
            return p;
        }));
        // Add user's vote to mockVotes
        mockVotes.push({
            proposalId,
            voterAddress: address!,
            option,
            votingPower: userProfile?.currentVotingPower || 0,
            timestamp: new Date(),
            transactionHash: generateRandomAddress(),
        });
        setSelectedProposal(prev => prev ? { ...prev,
            forVotes: prev.forVotes + (option === VoteOption.For ? (userProfile?.currentVotingPower || 0) : 0),
            againstVotes: prev.againstVotes + (option === VoteOption.Against ? (userProfile?.currentVotingPower || 0) : 0),
            abstainVotes: prev.abstainVotes + (option === VoteOption.Abstain ? (userProfile?.currentVotingPower || 0) : 0),
            totalVotes: prev.totalVotes + (userProfile?.currentVotingPower || 0),
        } : null);
        console.log("Vote recorded.");
    }, [address, userProfile]);

    const handleCreateProposal = useCallback(async (newProposalData: Partial<Proposal>) => {
        console.log("Creating new proposal:", newProposalData);
        await new Promise(resolve => setTimeout(resolve, 2000));
        const newProposal: Proposal = {
            id: `prop-${proposals.length + 1}-${Date.now()}`,
            proposer: address!,
            status: ProposalStatus.Pending,
            votingPeriodStart: new Date(),
            votingPeriodEnd: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // Default 7 days
            forVotes: 0, againstVotes: 0, abstainVotes: 0, totalVotes: 0,
            quorumThreshold: 0.20, passThreshold: 0.50,
            tags: ['Community', 'New'],
            detailsLink: '',
            ...newProposalData,
            description: newProposalData.description || "No description provided.",
            title: newProposalData.title || "Untitled Proposal",
            contractInteraction: newProposalData.contractInteraction || null,
        };
        setProposals(prev => [...prev, newProposal]);
        setNotifications(prev => [{
            id: `notif-${Date.now()}`,
            type: NotificationType.NewProposal,
            message: `New proposal created: "${newProposal.title}"`,
            timestamp: new Date(),
            read: false,
            relatedEntityId: newProposal.id,
        }, ...prev]);
        console.log("Proposal created:", newProposal.id);
        setProposalCreationOpen(false); // Close form after creation
    }, [address, proposals.length]);


    // Handlers for Delegation
    const handleDelegateVote = useCallback(async (delegateAddress: string) => {
        if (!isConnected || !address) {
            console.warn("Wallet not connected to delegate.");
            return;
        }
        console.log(`Delegating ${userProfile?.currentVotingPower} power to ${delegateAddress}`);
        await new Promise(resolve => setTimeout(resolve, 1500));
        setMyDelegatedTo(delegateAddress);
        if (userProfile) {
            userProfile.delegatedTo = delegateAddress;
            // In a real app, update on-chain and refresh user profile
        }
        setNotifications(prev => [{
            id: `notif-${Date.now()}`,
            type: NotificationType.DelegationChange,
            message: `You delegated your voting power to ${formatAddress(delegateAddress)}.`,
            timestamp: new Date(),
            read: false,
        }, ...prev]);
        console.log("Delegation successful.");
    }, [isConnected, address, userProfile]);

    const handleUndelegateVote = useCallback(async () => {
        if (!isConnected || !address) return;
        console.log("Undelegating voting power.");
        await new Promise(resolve => setTimeout(resolve, 1500));
        setMyDelegatedTo(undefined);
        if (userProfile) {
            userProfile.delegatedTo = undefined;
        }
        setNotifications(prev => [{
            id: `notif-${Date.now()}`,
            type: NotificationType.DelegationChange,
            message: `You undelegated your voting power.`,
            timestamp: new Date(),
            read: false,
        }, ...prev]);
        console.log("Undelegation successful.");
    }, [isConnected, address, userProfile]);

    // Handle AI Summarizer
    const triggerSummarize = useCallback(async () => {
        if (!process.env.NEXT_PUBLIC_API_KEY) {
            alert("API Key not configured for AI summarizer.");
            return;
        }
        await handleSummarizeAI(`Summarize the key points of the following DAO governance proposal into 3 simple bullet points. Proposal: "${proposalText}"`);
    }, [proposalText, handleSummarizeAI]);

    const totalTreasuryValue = useMemo(() => treasuryAssets.reduce((sum, asset) => sum + asset.usdValue, 0), [treasuryAssets]);

    // Function to mark notifications as read
    const markNotificationAsRead = useCallback((id: string) => {
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
    }, []);

    return (
        <WalletProvider> {/* Wrap the whole component tree in WalletProvider to provide context */}
        <>
            <div className="space-y-6">
                <div className="flex justify-between items-center mb-8">
                    <h2 className="text-4xl font-extrabold text-white tracking-wider">DAO Governance Dashboard</h2>
                    <div className="flex items-center space-x-4">
                        {isConnected ? (
                            <>
                                <div className="relative">
                                    <button onClick={() => { /* Toggle notification dropdown */ }} className="p-2 rounded-full bg-gray-700 hover:bg-gray-600 text-gray-300 relative">
                                        {/* <FiBell className="w-5 h-5" /> */}
                                        
                                        {unreadNotificationsCount > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                                                {unreadNotificationsCount}
                                            </span>
                                        )}
                                    </button>
                                    {/* Notification Dropdown (mocked) */}
                                    {/* <div className="absolute right-0 mt-2 w-80 bg-gray-800 border border-gray-700 rounded-lg shadow-xl overflow-hidden z-50">
                                        <div className="p-3 border-b border-gray-700 flex justify-between items-center">
                                            <h4 className="font-semibold text-white">Notifications</h4>
                                            <button onClick={() => setNotifications(prev => prev.map(n => ({ ...n, read: true })))} className="text-xs text-cyan-500 hover:underline">Mark All Read</button>
                                        </div>
                                        <div className="max-h-60 overflow-y-auto custom-scrollbar">
                                            {notifications.length === 0 ? (
                                                <p className="p-3 text-sm text-gray-400 text-center">No new notifications.</p>
                                            ) : (
                                                notifications.map(notif => (
                                                    <div key={notif.id} onClick={() => markNotificationAsRead(notif.id)} className="cursor-pointer">
                                                        <ActivityFeedItem notification={notif} />
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                        <div className="p-3 border-t border-gray-700 text-center">
                                            <button className="text-sm text-cyan-500 hover:underline">View All</button>
                                        </div>
                                    </div> */}
                                </div>
                                <span className="text-gray-300 text-sm">{formatAddress(address!)}</span>
                                <button onClick={disconnectWallet} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium">Disconnect</button>
                            </>
                        ) : (
                            <button onClick={connectWallet} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">Connect Wallet</button>
                        )}
                        <button onClick={() => setSummarizerOpen(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium">AI Proposal Summarizer</button>
                    </div>
                </div>

                {/* Main Dashboard Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    {/* Treasury Overview Card */}
                    <Card className="col-span-1 lg:col-span-1" title="Treasury Overview" icon="FiDollarSign">
                        <div className="space-y-4">
                            <div className="flex justify-between items-center pb-2 border-b border-gray-700">
                                <p className="text-lg text-gray-300">Total Value:</p>
                                <p className="text-2xl font-bold text-green-400">{formatNumber(totalTreasuryValue, true, 2)} USD</p>
                            </div>
                            <h4 className="text-md font-semibold text-white">Top Assets:</h4>
                            <ul className="space-y-2">
                                {treasuryAssets.slice(0, 3).map(asset => (
                                    <li key={asset.id} className="flex justify-between items-center text-sm text-gray-400">
                                        <div className="flex items-center space-x-2">
                                            <img src={asset.logoUrl || `https://via.placeholder.com/20/random?text=${asset.symbol}`} alt={asset.symbol} className="w-5 h-5 rounded-full" />
                                            <span>{asset.name} ({asset.symbol})</span>
                                        </div>
                                        <span className="font-medium text-gray-300">{formatNumber(asset.amount, false, 2)} ({formatNumber(asset.usdValue, true, 0)})</span>
                                    </li>
                                ))}
                            </ul>
                            <div className="flex justify-end pt-2 border-t border-gray-700">
                                <button className="text-cyan-500 hover:underline text-sm">View Full Treasury</button>
                            </div>
                        </div>
                    </Card>

                    {/* My Voting Power Card */}
                    <Card className="col-span-1" title="My Voting Power" icon="FiZap">
                        <div className="space-y-4">
                            {isConnected && userProfile ? (
                                <>
                                    <div className="flex justify-between items-center">
                                        <p className="text-lg text-gray-300">Available Power:</p>
                                        <p className="text-2xl font-bold text-purple-400">{formatNumber(userProfile.tokenBalance)} DAO</p>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 border-t border-gray-700">
                                        <p className="text-md text-gray-400">Delegated Power:</p>
                                        <p className="text-xl font-semibold text-cyan-400">{formatNumber(userProfile.currentVotingPower)} Votes</p>
                                    </div>
                                    {myDelegatedTo ? (
                                        <div className="text-sm text-gray-400">
                                            Currently delegated to: <span className="text-cyan-300 font-medium">{formatAddress(myDelegatedTo)}</span>
                                            <button onClick={handleUndelegateVote} className="ml-3 px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-medium">Undelegate</button>
                                        </div>
                                    ) : (
                                        <p className="text-sm text-gray-400">
                                            Your voting power is not delegated. Consider delegating to an experienced delegate.
                                        </p>
                                    )}
                                    <div className="flex justify-end pt-2 border-t border-gray-700">
                                        <button className="text-cyan-500 hover:underline text-sm" onClick={() => setActiveTab('Delegation')}>Manage Delegation</button>
                                    </div>
                                </>
                            ) : (
                                <p className="text-gray-400 text-center py-8">Connect your wallet to see your voting power.</p>
                            )}
                        </div>
                    </Card>

                    {/* Governance Metrics Summary Card */}
                    <Card className="col-span-1" title="Governance Metrics" icon="FiBarChart2">
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p className="text-gray-400">Total Proposals (Last 30D)</p>
                                    <p className="text-xl font-bold text-white">{formatNumber(governanceMetrics.slice(-1)[0]?.totalProposals || 0)}</p>
                                </div>
                                <div>
                                    <p className="text-gray-400">Voting Participation (Avg)</p>
                                    <p className="text-xl font-bold text-white">{(governanceMetrics.slice(-1)[0]?.participationRate * 100 || 0).toFixed(1)}%</p>
                                </div>
                                <div>
                                    <p className="text-gray-400">Successful Proposals</p>
                                    <p className="text-xl font-bold text-green-400">{formatNumber(governanceMetrics.reduce((sum, m) => sum + m.passedProposals, 0))}</p>
                                </div>
                                <div>
                                    <p className="text-gray-400">Active Delegates</p>
                                    <p className="text-xl font-bold text-cyan-400">{delegates.length}</p>
                                </div>
                            </div>
                            <div className="flex justify-end pt-2 border-t border-gray-700">
                                <button className="text-cyan-500 hover:underline text-sm">View Full Analytics</button>
                            </div>
                        </div>
                    </Card>
                </div>

                {/* Proposals Section */}
                <Card className="col-span-3" title="DAO Proposals">
                    <div className="space-y-6">
                        <div className="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                            <div className="flex space-x-2">
                                {['All', 'Active', 'Passed', 'Failed', 'Pending'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => { setActiveTab(tab as any); setCurrentPage(1); }}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium ${activeTab === tab ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                    >
                                        {tab} ({handleFilterProposals.filter(p => tab === 'All' || p.status === tab).length})
                                    </button>
                                ))}
                            </div>
                            <div className="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full md:w-auto">
                                <input
                                    type="text"
                                    placeholder="Search proposals..."
                                    value={searchTerm}
                                    onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                                    className="w-full sm:w-60 px-3 py-2 bg-gray-900/50 border border-gray-700 rounded-lg text-white text-sm focus:ring-cyan-500 focus:border-cyan-500"
                                />
                                <select
                                    value={sortOrder}
                                    onChange={(e) => setSortOrder(e.target.value as any)}
                                    className="w-full sm:w-auto px-3 py-2 bg-gray-900/50 border border-gray-700 rounded-lg text-white text-sm focus:ring-cyan-500 focus:border-cyan-500"
                                >
                                    <option value="latest">Sort by Latest</option>
                                    <option value="mostVoted">Sort by Most Voted</option>
                                </select>
                                {isConnected && (
                                     <button onClick={() => setProposalCreationOpen(true)} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium w-full sm:w-auto">
                                        {/* <FiPlusCircle className="inline-block mr-1" /> */}
                                        + Create Proposal
                                    </button>
                                )}

                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {paginatedProposals.length > 0 ? (
                                paginatedProposals.map(proposal => (
                                    <ProposalCard key={proposal.id} proposal={proposal} onViewDetails={setSelectedProposal} />
                                ))
                            ) : (
                                <p className="col-span-full text-center text-gray-400 py-10">No proposals found matching your criteria.</p>
                            )}
                        </div>

                        {/* Pagination */}
                        {totalPages > 1 && (
                            <div className="flex justify-center items-center space-x-4 mt-6">
                                <button
                                    onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                    disabled={currentPage === 1}
                                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Previous
                                </button>
                                <span className="text-gray-300 text-sm">Page {currentPage} of {totalPages}</span>
                                <button
                                    onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                    disabled={currentPage === totalPages}
                                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Next
                                </button>
                            </div>
                        )}
                    </div>
                </Card>

                {/* Delegates Section */}
                <Card title="DAO Delegates" icon="FiUsers">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {delegates.map(delegate => (
                            <DelegateCard
                                key={delegate.address}
                                delegate={delegate}
                                onDelegate={handleDelegateVote}
                                isDelegatedTo={isConnected && userProfile?.delegatedTo === delegate.address}
                            />
                        ))}
                    </div>
                    {delegates.length === 0 && (
                         <p className="col-span-full text-center text-gray-400 py-10">No delegates found.</p>
                    )}
                </Card>

                {/* Grant Programs Section */}
                <Card title="Grant Programs" icon="FiGlobe">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {grants.length > 0 ? (
                            grants.map(grant => <GrantCard key={grant.id} grant={grant} />)
                        ) : (
                            <p className="col-span-full text-center text-gray-400 py-10">No active grant programs.</p>
                        )}
                    </div>
                </Card>

                {/* Governance Activity Feed */}
                <Card title="Recent Governance Activity" icon="FiMessageSquare">
                    <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                        {notifications.length > 0 ? (
                            notifications.map(notif => (
                                <div key={notif.id} onClick={() => markNotificationAsRead(notif.id)} className="cursor-pointer">
                                    <ActivityFeedItem notification={notif} />
                                </div>
                            ))
                        ) : (
                            <p className="text-center text-gray-400 py-10">No recent activity.</p>
                        )}
                    </div>
                </Card>

                {/* Advanced Governance Analytics Chart */}
                <Card title="Historical Governance Metrics" icon="FiPieChart">
                    <div className="h-96 w-full">
                        <MockLineChart
                            data={governanceMetrics.map(m => ({
                                name: m.date.toLocaleString('default', { month: 'short', year: 'numeric' }),
                                'Total Proposals': m.totalProposals,
                                'Votes Cast': m.totalVotesCast / 1000, // Scale for chart
                                'Participation Rate': m.participationRate * 100,
                                'Treasury Value (M)': m.treasuryValue / 1000000,
                            }))}
                            dataKey="Total Proposals"
                            name="Proposals Over Time"
                        />
                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-6 text-sm text-gray-400">
                            <p>Total Metrics: {governanceMetrics.length} months</p>
                            <p>Avg. Proposals/Month: {(governanceMetrics.reduce((sum, m) => sum + m.totalProposals, 0) / governanceMetrics.length).toFixed(1)}</p>
                            <p>Avg. Participation Rate: {(governanceMetrics.reduce((sum, m) => sum + m.participationRate, 0) / governanceMetrics.length * 100).toFixed(1)}%</p>
                            <p>Max Treasury Value: {formatNumber(Math.max(...governanceMetrics.map(m => m.treasuryValue)), true, 0)}</p>
                        </div>
                    </div>
                </Card>

            </div>

            {/* AI Proposal Summarizer Modal */}
            {isSummarizerOpen && (
                 <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setSummarizerOpen(false)}>
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full border border-gray-700" onClick={e=>e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-white">AI Proposal Summarizer</h3>
                            <button onClick={() => setSummarizerOpen(false)} className="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div className="p-6 space-y-4">
                             <textarea
                                value={proposalText}
                                onChange={e => setProposalText(e.target.value)}
                                className="w-full h-40 bg-gray-900/50 p-2 rounded text-white text-sm border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500"
                                placeholder="Paste your detailed DAO proposal here for an AI summary..."
                            />
                             <button
                                onClick={triggerSummarize}
                                disabled={isLoading}
                                className="w-full py-2 bg-cyan-600 rounded disabled:opacity-50 hover:bg-cyan-700 text-white font-medium"
                            >
                                {isLoading ? 'Summarizing...' : 'Summarize Proposal'}
                            </button>
                            <Card title="Summary (Gemini AI)">
                                <div className="min-h-[6rem] text-sm text-gray-300 whitespace-pre-line">
                                    {isLoading ? '...' : (summary || summaryError || 'Enter proposal text and click summarize.')}
                                </div>
                                {summaryError && <p className="text-red-400 text-xs mt-2">{summaryError}</p>}
                            </Card>
                            <Card title="AI Impact Analysis (Optional - Mock)" className="bg-gray-900/50">
                                <button
                                    onClick={() => generateImpactAnalysis(`Analyze the potential impact of the following DAO governance proposal, considering its effects on tokenomics, community engagement, and protocol security. Proposal: "${proposalText}"`)}
                                    disabled={impactLoading || !proposalText}
                                    className="w-full py-2 bg-purple-600 rounded disabled:opacity-50 hover:bg-purple-700 text-white text-sm font-medium"
                                >
                                    {impactLoading ? 'Analyzing Impact...' : 'Generate Impact Analysis'}
                                </button>
                                <div className="min-h-[4rem] text-sm text-gray-300 whitespace-pre-line mt-2">
                                    {impactLoading ? '...' : (impactAnalysis || 'Click to analyze impact.')}
                                </div>
                            </Card>
                            <Card title="AI Risk Assessment (Optional - Mock)" className="bg-gray-900/50">
                                <button
                                    onClick={() => generateRiskAssessment(`Identify potential risks associated with the following DAO governance proposal, including financial, technical, and governance risks. Suggest mitigation strategies. Proposal: "${proposalText}"`)}
                                    disabled={riskLoading || !proposalText}
                                    className="w-full py-2 bg-red-600 rounded disabled:opacity-50 hover:bg-red-700 text-white text-sm font-medium"
                                >
                                    {riskLoading ? 'Assessing Risks...' : 'Generate Risk Assessment'}
                                </button>
                                <div className="min-h-[4rem] text-sm text-gray-300 whitespace-pre-line mt-2">
                                    {riskLoading ? '...' : (riskAssessment || 'Click to assess risks.')}
                                </div>
                            </Card>
                        </div>
                    </div>
                 </div>
            )}

            {/* Proposal Details Modal */}
            {selectedProposal && (
                <ProposalDetailsModal
                    proposal={selectedProposal}
                    onClose={() => setSelectedProposal(null)}
                    onVote={handleVote}
                />
            )}

            {/* Proposal Creation Modal */}
            {isProposalCreationOpen && (
                <ProposalCreationForm
                    onCreateProposal={handleCreateProposal}
                    onClose={() => setProposalCreationOpen(false)}
                />
            )}
        </>
        </WalletProvider>
    );
};

export default DaoGovernanceView;
```

--- FILE: NftVaultView.tsx ---

// components/views/megadashboard/digitalassets/NftVaultView.tsx
import React, { useState, useEffect, useCallback, useReducer, createContext, useContext } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// --- START: Global Contexts and Utilities (for internal component structure) ---

// Define types for better organization and readability
export interface NftTrait {
    trait_type: string;
    value: string | number;
    rarity?: number; // 0-100 or percentile
}

export interface NftMedia {
    original: string;
    thumbnail?: string;
    animated?: string; // For videos/GIFs
}

export interface NftOffer {
    id: string;
    maker: string; // Wallet address
    price: number; // ETH or other currency
    currency: 'ETH' | 'WETH' | 'SOL';
    expiresAt: Date;
}

export interface NftListing {
    id: string;
    seller: string; // Wallet address
    price: number;
    currency: 'ETH' | 'WETH' | 'SOL';
    listedAt: Date;
    marketplace: string;
}

export interface NftCollectionMetadata {
    slug: string;
    name: string;
    description: string;
    imageUrl: string;
    bannerImageUrl?: string;
    floorPrice: number;
    totalVolume: number;
    numOwners: number;
    totalSupply: number;
    oneDayChange: number; // % change
    sevenDayChange: number; // % change
    thirtyDayChange: number; // % change
}

export interface Nft {
    id: string; // Unique ID (e.g., contractAddress-tokenId)
    tokenId: string;
    contractAddress: string;
    name: string;
    description: string;
    imageUrl: string;
    animationUrl?: string; // If it's an animated NFT
    collection: NftCollectionMetadata;
    ownerAddress: string;
    lastSalePrice?: number;
    lastSaleCurrency?: 'ETH' | 'WETH' | 'SOL';
    currentPrice?: number; // If listed for sale
    currentCurrency?: 'ETH' | 'WETH' | 'SOL';
    listedMarketplace?: string;
    traits: NftTrait[];
    rarityScore?: number; // Calculated score
    rank?: number; // Rank within collection based on rarity
    metadataUrl?: string; // Link to raw metadata
    acquiredPrice?: number; // What the user paid for it
    acquiredCurrency?: 'ETH' | 'WETH' | 'SOL';
    acquiredDate?: Date;
    media: NftMedia[];
    offers?: NftOffer[];
    listings?: NftListing[];
    aiValuations?: ValuationResult[]; // History of AI valuations
}

export interface WalletInfo {
    address: string;
    connected: boolean;
    balanceEth: number;
    balanceWeth: number;
    balanceSol: number;
    network: 'ethereum' | 'solana' | 'polygon';
}

export interface Transaction {
    id: string;
    type: 'purchase' | 'sale' | 'transfer_in' | 'transfer_out' | 'mint';
    nftId: string; // The ID of the NFT involved
    nftName: string;
    collectionName: string;
    price?: number;
    currency?: 'ETH' | 'WETH' | 'SOL';
    fromAddress?: string;
    toAddress?: string;
    timestamp: Date;
    txHash: string;
    marketplace?: string;
}

export interface ValuationResult {
    timestamp: Date;
    estimatedValue: string; // The AI-generated text
    confidenceScore?: number; // e.g., 0-100
    details?: string; // More detailed breakdown from AI
    modelUsed: string;
    inputPrompt: string;
}

// --- Mock Data Generation Functions (to simulate a large dataset) ---

const MOCK_WALLETS: WalletInfo[] = [
    { address: "0x1A2b3c4d5E6f7A8b9C0d1E2f3A4b5C6d7E8f9A0b", connected: true, balanceEth: 12.5, balanceWeth: 3.2, balanceSol: 0, network: 'ethereum' },
    { address: "0xBbCcDdEeFf00112233445566778899AAbbCcDdEe", connected: false, balanceEth: 0, balanceWeth: 0, balanceSol: 0, network: 'ethereum' },
    { address: "sol_A1B2C3D4E5F6G7H8I9J0K1L2M3N4O5P6Q7R8S9T0", connected: true, balanceEth: 0, balanceWeth: 0, balanceSol: 250.7, network: 'solana' },
];

const generateRandomDate = (start: Date, end: Date) => new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));

const generateRandomPrice = (min: number, max: number) => parseFloat((Math.random() * (max - min) + min).toFixed(3));

const MOCK_COLLECTIONS: NftCollectionMetadata[] = [
    {
        slug: 'cryptopunks',
        name: 'CryptoPunks',
        description: 'The original pixel art NFTs.',
        imageUrl: 'https://i.seadn.io/gae/BdxvLseXcflCxrk3fiLRUSrckzEfxn5TzRJuxL58XvJx5LUGgjh_YkLAgONPVD5McdgqzFscHWNCpt58kvcERcVEarFdhrByW2gNKQ?auto=format&w=256',
        bannerImageUrl: 'https://i.seadn.io/gcs/files/b4959146522c71ce85d6ed79e7826359.png?auto=format&w=1920',
        floorPrice: 50.2,
        totalVolume: 1000000,
        numOwners: 3000,
        totalSupply: 10000,
        oneDayChange: 1.2,
        sevenDayChange: -3.5,
        thirtyDayChange: 8.1,
    },
    {
        slug: 'boredapeyachtclub',
        name: 'Bored Ape Yacht Club',
        description: 'A collection of 10,000 unique Bored Ape NFTs.',
        imageUrl: 'https://i.seadn.io/gae/JuQ8JtE_D1Nl1_B3R821Ld12UuUoN895u6iC-8j-6_d2E9P74-F-u2E-J1P9V-Y1F-W1X-Z1A-C1T-R1Y-U1Z-V1W-H1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A1B-C1D-E1F-G1H-I1J-K1L-M1N-O1P-Q1R-S1T-U1V-W1X-Y1Z-A

--- FILE: OnChainAnalyticsView.tsx ---

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// --- MOCK DATA AND TYPE DEFINITIONS (START) ---
/**
 * @typedef {object} Transaction
 * @property {string} hash - Unique transaction hash.
 * @property {string} from - Sender address.
 * @property {string} to - Receiver or contract address.
 * @property {string} value - Value transferred (in ETH/token, string for large numbers).
 * @property {string} tokenSymbol - Symbol of the token if it's a token transfer.
 * @property {number} gasUsed - Gas consumed by the transaction.
 * @property {string} gasPrice - Gas price (wei, string).
 * @property {number} timestamp - Unix timestamp of the block.
 * @property {string} status - 'success' | 'failed' | 'pending'.
 * @property {string} type - 'transfer' | 'contract_call' | 'swap' | 'mint' | 'burn'.
 * @property {string} blockNumber - Block number.
 * @property {string} [contractAddress] - Contract address if applicable.
 * @property {string} [method] - Method called for contract interactions.
 * @property {string} fee - Calculated transaction fee in ETH.
 */
export interface Transaction {
    hash: string;
    from: string;
    to: string;
    value: string;
    tokenSymbol?: string;
    gasUsed: number;
    gasPrice: string;
    timestamp: number;
    status: 'success' | 'failed' | 'pending';
    type: 'transfer' | 'contract_call' | 'swap' | 'mint' | 'burn';
    blockNumber: string;
    contractAddress?: string;
    method?: string;
    fee: string;
}

/**
 * @typedef {object} TokenBalance
 * @property {string} symbol - Token symbol (e.g., ETH, USDC).
 * @property {string} name - Full token name.
 * @property {string} address - Contract address of the token.
 * @property {string} balance - Raw balance (string, for precision).
 * @property {number} decimals - Number of decimals for the token.
 * @property {number} valueUsd - Current USD value of the balance.
 * @property {number} priceUsd - Current price per token in USD.
 * @property {string} [logoUrl] - URL for the token logo.
 */
export interface TokenBalance {
    symbol: string;
    name: string;
    address: string;
    balance: string;
    decimals: number;
    valueUsd: number;
    priceUsd: number;
    logoUrl?: string;
}

/**
 * @typedef {object} WalletActivity
 * @property {string} address - Wallet address.
 * @property {TokenBalance[]} balances - Array of token balances.
 * @property {Transaction[]} recentTransactions - Array of recent transactions.
 * @property {string} totalValueUsd - Total USD value of the wallet.
 * @property {number} transactionCount - Total number of transactions.
 * @property {number} firstSeenTimestamp - Timestamp when wallet first had activity.
 */
export interface WalletActivity {
    address: string;
    balances: TokenBalance[];
    recentTransactions: Transaction[];
    totalValueUsd: string;
    transactionCount: number;
    firstSeenTimestamp: number;
}

/**
 * @typedef {object} DeFiProtocol
 * @property {string} name - Name of the protocol (e.g., Uniswap, Aave).
 * @property {string} category - e.g., 'DEX', 'Lending'.
 * @property {string} address - Main contract address or identifier.
 * @property {number} tvlUsd - Total Value Locked in USD.
 * @property {number} volume24hUsd - 24-hour trading/lending volume in USD.
 * @property {string} [logoUrl] - URL for the protocol logo.
 * @property {string} description - Brief description.
 */
export interface DeFiProtocol {
    name: string;
    category: 'DEX' | 'Lending' | 'Borrowing' | 'Staking' | 'Yield Farming';
    address: string;
    tvlUsd: number;
    volume24hUsd: number;
    logoUrl?: string;
    description: string;
}

/**
 * @typedef {object} NFTCollection
 * @property {string} name - Collection name.
 * @property {string} contractAddress - Contract address.
 * @property {number} floorPriceEth - Current floor price in ETH.
 * @property {number} floorPriceUsd - Current floor price in USD.
 * @property {number} volume24hEth - 24-hour volume in ETH.
 * @property {number} volume24hUsd - 24-hour volume in USD.
 * @property {number} totalVolumeEth - Total volume in ETH.
 * @property {number} uniqueHolders - Number of unique holders.
 * @property {string} [imageUrl] - Collection image URL.
 */
export interface NFTCollection {
    name: string;
    contractAddress: string;
    floorPriceEth: number;
    floorPriceUsd: number;
    volume24hEth: number;
    volume24hUsd: number;
    totalVolumeEth: number;
    uniqueHolders: number;
    imageUrl?: string;
}

/**
 * @typedef {object} GasPriceInfo
 * @property {number} standardGwei - Standard gas price in Gwei.
 * @property {number} fastGwei - Fast gas price in Gwei.
 * @property {number} rapidGwei - Rapid gas price in Gwei.
 * @property {number} baseFeeGwei - Current base fee in Gwei.
 * @property {number} priorityFeeGwei - Recommended priority fee in Gwei.
 * @property {number} lastBlock - Block number for this info.
 */
export interface GasPriceInfo {
    standardGwei: number;
    fastGwei: number;
    rapidGwei: number;
    baseFeeGwei: number;
    priorityFeeGwei: number;
    lastBlock: number;
}

/**
 * @typedef {object} ChartDataPoint
 * @property {number} timestamp - Unix timestamp.
 * @property {number} value - Numeric value for the chart.
 */
export interface ChartDataPoint {
    timestamp: number;
    value: number;
}

/**
 * @typedef {object} ProtocolOverview
 * @property {string} name
 * @property {number} tvl
 * @property {number} volume24h
 * @property {string} category
 * @property {string} logo
 */
export interface ProtocolOverview {
    name: string;
    tvl: number;
    volume24h: number;
    category: string;
    logo: string;
}


// --- UTILITY FUNCTIONS ---
/**
 * Shortens an Ethereum address for display.
 * @param {string} address - The full Ethereum address.
 * @param {number} [chars=4] - Number of characters to show at start/end.
 * @returns {string} The shortened address (e.g., "0xabc...xyz").
 */
export const shortenAddress = (address: string, chars = 4): string => {
    if (!address) return '';
    return `${address.substring(0, chars + 2)}...${address.substring(address.length - chars)}`;
};

/**
 * Formats a large number as currency.
 * @param {number} value - The numeric value.
 * @param {string} [currency='$'] - The currency symbol (e.g., "$", "").
 * @param {number} [decimals=2] - Number of decimal places.
 * @returns {string} Formatted currency string.
 */
export const formatCurrency = (value: number, currency: string = '$', decimals: number = 2): string => {
    if (value === null || value === undefined || isNaN(value)) return `${currency}0.00`;
    return `${currency}${value.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals })}`;
};

/**
 * Formats a number for display.
 * @param {number} value - The numeric value.
 * @param {number} [decimals=2] - Number of decimal places.
 * @returns {string} Formatted number string.
 */
export const formatNumber = (value: number, decimals: number = 2): string => {
    if (value === null || value === undefined || isNaN(value)) return '0.00';
    return value.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
};

/**
 * Converts a Unix timestamp to a human-readable date string.
 * @param {number} timestamp - Unix timestamp.
 * @returns {string} Formatted date string.
 */
export const formatDate = (timestamp: number): string => {
    if (!timestamp) return 'N/A';
    return new Date(timestamp * 1000).toLocaleString();
};

/**
 * Calculates time ago from a Unix timestamp.
 * @param {number} timestamp - Unix timestamp.
 * @returns {string} Time ago string (e.g., "5 minutes ago").
 */
export const timeAgo = (timestamp: number): string => {
    if (!timestamp) return 'N/A';
    const seconds = Math.floor((new Date().getTime() - timestamp * 1000) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
};

/**
 * Converts wei to ETH.
 * @param {string} wei - Value in wei.
 * @returns {number} Value in ETH.
 */
export const weiToEth = (wei: string): number => {
    if (!wei) return 0;
    try {
        return parseFloat(BigInt(wei).toString()) / 1e18;
    } catch {
        return 0; // Handle invalid BigInt strings
    }
};

/**
 * Converts Gwei to ETH.
 * @param {number} gwei - Value in Gwei.
 * @returns {number} Value in ETH.
 */
export const gweiToEth = (gwei: number): number => {
    return gwei / 1e9;
};

/**
 * Calculate transaction fee in ETH.
 * @param {number} gasUsed - Gas consumed.
 * @param {string} gasPrice - Gas price in wei.
 * @returns {string} Fee in ETH (formatted).
 */
export const calculateFeeEth = (gasUsed: number, gasPrice: string): string => {
    if (!gasUsed || !gasPrice) return '0';
    try {
        const feeWei = BigInt(gasUsed) * BigInt(gasPrice);
        return weiToEth(feeWei.toString()).toFixed(6);
    } catch {
        return '0';
    }
};


// --- MOCK API FUNCTIONS (SIMULATED BACKEND INTERACTION) ---
/**
 * Simulates fetching global blockchain metrics.
 */
export const fetchGlobalMetrics = async (): Promise<{
    totalVolume24hUsd: number;
    totalTransactions24h: number;
    activeWallets24h: number;
    averageGasPriceGwei: number;
    ethPriceUsd: number;
}> => {
    return new Promise(resolve => setTimeout(() => resolve({
        totalVolume24hUsd: Math.random() * 10_000_000_000 + 500_000_000,
        totalTransactions24h: Math.floor(Math.random() * 2_000_000 + 500_000),
        activeWallets24h: Math.floor(Math.random() * 500_000 + 100_000),
        averageGasPriceGwei: Math.random() * 50 + 10,
        ethPriceUsd: Math.random() * 1000 + 1500, // Simulate ETH price around $1500-$2500
    }), 800 + Math.random() * 400));
};

/**
 * Simulates fetching recent transactions.
 * @param {number} [count=10] - Number of transactions to fetch.
 */
export const fetchRecentTransactions = async (count: number = 10): Promise<Transaction[]> => {
    const transactions: Transaction[] = [];
    const now = Math.floor(Date.now() / 1000);
    const ethPrice = (await fetchGlobalMetrics()).ethPriceUsd; // Ensure ethPrice is fetched.

    for (let i = 0; i < count; i++) {
        const valueEth = Math.random() * 10 + 0.1;
        const gasUsed = Math.floor(Math.random() * 200000 + 21000);
        const gasPriceGwei = Math.random() * 50 + 10;
        const gasPriceWei = (gasPriceGwei * 1e9).toFixed(0);
        const timestamp = now - Math.floor(Math.random() * 3600 * 24 * 7); // Last 7 days
        const typeOptions = ['transfer', 'contract_call', 'swap', 'mint', 'burn'];
        const selectedType = typeOptions[Math.floor(Math.random() * typeOptions.length)];

        transactions.push({
            hash: `0x${[...Array(64)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
            from: `0x${[...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
            to: `0x${[...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`,
            value: (valueEth * 1e18).toFixed(0),
            tokenSymbol: Math.random() > 0.5 ? 'ETH' : (Math.random() > 0.5 ? 'USDC' : 'DAI'),
            gasUsed: gasUsed,
            gasPrice: gasPriceWei,
            timestamp: timestamp,
            status: Math.random() > 0.1 ? 'success' : 'failed',
            type: selectedType,
            blockNumber: (Math.floor(Math.random() * 1000000) + 18000000).toString(),
            contractAddress: selectedType !== 'transfer' ? `0x${[...Array(40)].map(() => Math.floor(Math.random() * 16).toString(16)).join('')}` : undefined,
            method: selectedType === 'contract_call' ? (Math.random() > 0.5 ? 'swapExactETHForTokens' : 'transferFrom') : undefined,
            fee: calculateFeeEth(gasUsed, gasPriceWei),
        });
    }
    return new Promise(resolve => setTimeout(() => resolve(transactions), 1000 + Math.random() * 500));
};

/**
 * Simulates fetching top tokens by market cap/volume.
 * @param {number} [count=10] - Number of tokens to fetch.
 */
export const fetchTopTokens = async (count: number = 10): Promise<TokenBalance[]> => {
    const tokenList = [
        { symbol: 'ETH', name: 'Ethereum', address: '0x0000000000000000000000000000000000000000', decimals: 18, logoUrl: '/logos/eth.png' },
        { symbol: 'USDC', name: 'USD Coin', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6, logoUrl: '/logos/usdc.png' },
        { symbol: 'USDT', name: 'Tether', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6, logoUrl: '/logos/usdt.png' },
        { symbol: 'BNB', name: 'Binance Coin', address: '0xB8c77482e45F1F44dE1745F52C67B5B7D7c4f74B', decimals: 18, logoUrl: '/logos/bnb.png' },
        { symbol: 'SOL', name: 'Solana', address: '0xd31a59c85ae9d8edec1e70ef6091ee40a029d3cf', decimals: 9, logoUrl: '/logos/sol.png' },
        { symbol: 'XRP', name: 'XRP', address: '0x1D2F0aF783B0Ea591eF66986FfC35E2F68A48c08', decimals: 6, logoUrl: '/logos/xrp.png' },
        { symbol: 'ADA', name: 'Cardano', address: '0x3ee2200efb3400fabb9aace3bc3996230f3073d4', decimals: 6, logoUrl: '/logos/ada.png' },
        { symbol: 'DOGE', name: 'Dogecoin', address: '0x7466EaC25b1E51b689a94C56a908C6856C9542B7', decimals: 8, logoUrl: '/logos/doge.png' },
        { symbol: 'TRX', name: 'TRON', address: '0xf230b790E053903415fdC4aEAA533E97f6D66E61', decimals: 6, logoUrl: '/logos/trx.png' },
        { symbol: 'LINK', name: 'Chainlink', address: '0x514910771af9ca656af8407ff8582ae2ea2f7d28', decimals: 18, logoUrl: '/logos/link.png' },
        { symbol: 'AVAX', name: 'Avalanche', address: '0x6eF95b211B56F42C1a5d62512Ff5E724F534241a', decimals: 18, logoUrl: '/logos/avax.png' },
    ];
    const ethPrice = (await fetchGlobalMetrics()).ethPriceUsd;

    return new Promise(resolve => setTimeout(() => {
        const tokens = tokenList.slice(0, count).map(token => {
            let priceUsd;
            if (token.symbol === 'ETH') priceUsd = ethPrice;
            else if (token.symbol === 'USDC' || token.symbol === 'USDT') priceUsd = 1.0;
            else priceUsd = Math.random() * 100 + 0.1;
            
            const balanceValue = Math.random() * 100000000 + 1000000;
            const balanceRaw = (balanceValue / priceUsd).toFixed(token.decimals);

            return {
                ...token,
                balance: balanceRaw,
                valueUsd: balanceValue,
                priceUsd: priceUsd,
            };
        });
        resolve(tokens);
    }, 900 + Math.random() * 400));
};

/**
 * Simulates fetching DeFi protocol data.
 * @param {number} [count=5] - Number of protocols to fetch.
 */
export const fetchDeFiProtocols = async (count: number = 5): Promise<DeFiProtocol[]> => {
    const protocolList = [
        { name: 'Uniswap V3', category: 'DEX', address: '0x1F98431c8aD98523631AE4a59f267346aFd3bF1a', description: 'Leading decentralized exchange.' },
        { name: 'Aave V3', category: 'Lending', address: '0x7d2768dE32b0b80b07a761e1edE2bCd7Daa87Ddf', description: 'Decentralized lending and borrowing protocol.' },
        { name: 'Compound', category: 'Lending', address: '0x3d9819210A31b4961b30EF54bE2aeD79DcbE76C2', description: 'Algorithmic money market protocol.' },
        { name: 'Curve Finance', category: 'DEX', address: '0xD533a949740bb3306d119Ebbd726Aef1B1b0Cf9C', description: 'Exchange for stablecoins and pegged assets.' },
        { name: 'MakerDAO', category: 'Lending', address: '0x9f8F72aa9304c8B593d555F12eF6589cC3A579A2', description: 'Creator of the DAI stablecoin.' },
        { name: 'Lido', category: 'Staking', address: '0x5A98FcE30Ad1C88FbB96f86644f568b2e50570b5', description: 'Liquid staking for ETH 2.0.' },
    ];
    return new Promise(resolve => setTimeout(() => {
        const protocols = protocolList.slice(0, count).map(protocol => ({
            ...protocol,
            tvlUsd: Math.random() * 10_000_000_000 + 100_000_000,
            volume24hUsd: Math.random() * 1_000_000_000 + 10_000_000,
            logoUrl: `/logos/${protocol.name.toLowerCase().replace(/\s/g, '-')}.png`,
        }));
        resolve(protocols);
    }, 700 + Math.random() * 300));
};

/**
 * Simulates fetching NFT collection data.
 * @param {number} [count=5] - Number of collections to fetch.
 */
export const fetchNFTCollections = async (count: number = 5): Promise<NFTCollection[]> => {
    const collectionsList = [
        { name: 'Bored Ape Yacht Club', contractAddress: '0xBC4CA0EdA7647A8aB7C2061c2E118A18a93fE1Ad', imageUrl: '/logos/bayc.png' },
        { name: 'CryptoPunks', contractAddress: '0xb47e3cd837dDF8e4c57F05d70ab865de6e193bbb', imageUrl: '/logos/cryptopunks.png' },
        { name: 'Mutant Ape Yacht Club', contractAddress: '0x60E4d786628Fea6478F785A6d7ce6Fb0EEb5Feac', imageUrl: '/logos/mayc.png' },
        { name: 'Azuki', contractAddress: '0xED5AF388653567Af2F388E6224dCDfC4b0455F2A', imageUrl: '/logos/azuki.png' },
        { name: 'DeGods', contractAddress: '0x8821Be2e5390772C50811e582b130a0F284B903E', imageUrl: '/logos/degods.png' },
    ];
    const ethPrice = (await fetchGlobalMetrics()).ethPriceUsd;

    return new Promise(resolve => setTimeout(() => {
        const collections = collectionsList.slice(0, count).map(collection => {
            const floorEth = Math.random() * 50 + 5;
            const volume24hEth = Math.random() * 1000 + 100;
            const totalVolumeEth = Math.random() * 1000000 + 10000;
            return {
                ...collection,
                floorPriceEth: floorEth,
                floorPriceUsd: floorEth * ethPrice,
                volume24hEth: volume24hEth,
                volume24hUsd: volume24hEth * ethPrice,
                totalVolumeEth: totalVolumeEth,
                uniqueHolders: Math.floor(Math.random() * 10000 + 1000),
            };
        });
        resolve(collections);
    }, 1100 + Math.random() * 500));
};

/**
 * Simulates fetching historical chart data.
 * @param {string} type - Type of data ('ethPrice', 'gas', 'totalTx').
 * @param {'7d' | '30d' | '90d' | '1y'} duration - Duration of the chart data.
 */
export const fetchChartData = async (type: string, duration: '7d' | '30d' | '90d' | '1y'): Promise<ChartDataPoint[]> => {
    return new Promise(resolve => setTimeout(() => {
        const data: ChartDataPoint[] = [];
        const now = Math.floor(Date.now() / 1000);
        let numPoints = 0;
        let interval = 0; // seconds

        switch (duration) {
            case '7d': numPoints = 7 * 24; interval = 3600; break; // hourly
            case '30d': numPoints = 30; interval = 86400; break; // daily
            case '90d': numPoints = 90; interval = 86400; break; // daily
            case '1y': numPoints = 365; interval = 86400; break; // daily
        }

        let baseValue = type === 'gas' ? 30 : (type === 'ethPrice' ? 2000 : 1000000);
        let volatility = type === 'gas' ? 5 : (type === 'ethPrice' ? 100 : 100000);

        for (let i = 0; i < numPoints; i++) {
            const timestamp = now - (numPoints - i) * interval;
            const value = baseValue + (Math.random() - 0.5) * volatility * 2;
            data.push({ timestamp, value: Math.max(0, value) }); // Ensure value is not negative
        }
        resolve(data);
    }, 600 + Math.random() * 300));
};

/**
 * Simulates fetching detailed wallet activity.
 * @param {string} address - Wallet address.
 */
export const fetchWalletActivity = async (address: string): Promise<WalletActivity> => {
    const ethPrice = (await fetchGlobalMetrics()).ethPriceUsd;
    const now = Math.floor(Date.now() / 1000);

    const balances: TokenBalance[] = [
        {
            symbol: 'ETH', name: 'Ethereum', address: '0x0', decimals: 18,
            balance: (Math.random() * 5 + 0.1).toFixed(18),
            priceUsd: ethPrice,
            valueUsd: (Math.random() * 5 + 0.1) * ethPrice,
            logoUrl: '/logos/eth.png'
        },
        {
            symbol: 'USDC', name: 'USD Coin', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6,
            balance: (Math.random() * 5000 + 100).toFixed(6),
            priceUsd: 1.0,
            valueUsd: (Math.random() * 5000 + 100) * 1.0,
            logoUrl: '/logos/usdc.png'
        },
        {
            symbol: 'DAI', name: 'Dai Stablecoin', address: '0x6B175474E89094C44Da98b954EedeAC495271d0F', decimals: 18,
            balance: (Math.random() * 2000 + 50).toFixed(18),
            priceUsd: 1.0,
            valueUsd: (Math.random() * 2000 + 50) * 1.0,
            logoUrl: '/logos/dai.png'
        },
    ];

    const recentTransactions = await fetchRecentTransactions(20);
    const totalValueUsd = balances.reduce((sum, b) => sum + b.valueUsd, 0).toFixed(2);

    return new Promise(resolve => setTimeout(() => resolve({
        address: address,
        balances: balances,
        recentTransactions: recentTransactions,
        totalValueUsd: totalValueUsd,
        transactionCount: Math.floor(Math.random() * 5000 + 100),
        firstSeenTimestamp: now - Math.floor(Math.random() * 365 * 24 * 3600), // Up to 1 year ago
    }), 1500 + Math.random() * 500));
};

/**
 * Simulates fetching current gas prices.
 */
export const fetchGasPriceInfo = async (): Promise<GasPriceInfo> => {
    return new Promise(resolve => setTimeout(() => resolve({
        standardGwei: Math.floor(Math.random() * 10) + 20,
        fastGwei: Math.floor(Math.random() * 10) + 30,
        rapidGwei: Math.floor(Math.random() * 10) + 40,
        baseFeeGwei: Math.floor(Math.random() * 5) + 15,
        priorityFeeGwei: Math.floor(Math.random() * 2) + 1,
        lastBlock: Math.floor(Math.random() * 100) + 18000000,
    }), 500 + Math.random() * 200));
};


// --- AI INTERACTION MODULES ---
/**
 * @typedef {object} WalletAnalysisResult
 * @property {string} summary - General overview of wallet activity.
 * @property {string[]} topTokens - List of top held tokens.
 * @property {string[]} topProtocols - List of top interacted DeFi protocols.
 * @property {string} riskScoreExplanation - Explanation of a hypothetical risk score.
 * @property {string[]} potentialAnomalies - List of detected anomalies.
 */
export interface WalletAnalysisResult {
    summary: string;
    topTokens: string[];
    topProtocols: string[];
    riskScoreExplanation: string;
    potentialAnomalies: string[];
}

/**
 * AI service to analyze a wallet's activity and holdings.
 * @param {string} address - Wallet address to analyze.
 * @param {WalletActivity} activityData - The fetched wallet activity data.
 */
export const analyzeWalletWithAI = async (address: string, activityData: WalletActivity): Promise<WalletAnalysisResult> => {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
    const prompt = `Analyze the Ethereum wallet "${address}" based on its recent activity:
    Total Value: ${activityData.totalValueUsd} USD
    Number of Transactions: ${activityData.transactionCount}
    Balances: ${activityData.balances.map(b => `${formatNumber(weiToEth(b.balance), 4)} ${b.symbol}`).join(', ')}
    Recent Transactions types: ${activityData.recentTransactions.map(tx => tx.type).join(', ')}.
    Provide a concise summary, identify top tokens and protocols, explain a hypothetical risk score, and list potential anomalies.`;

    console.log("AI Wallet Analysis Prompt:", prompt);
    
    return new Promise(resolve => setTimeout(() => {
        const mockSummary = `This wallet appears to be moderately active, holding a diversified portfolio of stablecoins and ETH. It engages in regular transfers and some DeFi interactions.`;
        const mockTopTokens = activityData.balances.filter(b => b.valueUsd > 100).sort((a,b) => b.valueUsd - a.valueUsd).map(b => b.name);
        const mockTopProtocols = ['Uniswap', 'Aave', 'OpenSea'];
        const mockRiskExplanation = `Risk score of 3/10: Low risk due to stablecoin dominance and no apparent interaction with high-risk smart contracts. Some exposure to volatile assets (ETH).`;
        const mockAnomalies: string[] = Math.random() > 0.7 ? [`Unusual large outgoing transfer of ${formatCurrency(Math.random()*1000+500, '$')} USDC detected on ${formatDate(activityData.recentTransactions[0]?.timestamp || Date.now()/1000)}.`] : [];

        resolve({
            summary: mockSummary,
            topTokens: mockTopTokens,
            topProtocols: mockTopProtocols,
            riskScoreExplanation: mockRiskExplanation,
            potentialAnomalies: mockAnomalies,
        });
    }, 2000 + Math.random() * 1000));
};

/**
 * @typedef {object} SmartContractAnalysisResult
 * @property {string} purpose - AI-generated description of the contract's main purpose.
 * @property {string[]} keyFunctions - List of important functions.
 * @property {string} securityInsights - AI-driven security review summary.
 * @property {string[]} knownVulnerabilities - Any known issues.
 * @property {string} commonInteractions - How users typically interact.
 */
export interface SmartContractAnalysisResult {
    purpose: string;
    keyFunctions: string[];
    securityInsights: string;
    knownVulnerabilities: string[];
    commonInteractions: string;
}

/**
 * AI service to analyze a smart contract.
 * @param {string} contractAddress - Address of the smart contract.
 * @param {string} abi - Contract ABI (simulated).
 */
export const analyzeSmartContractWithAI = async (contractAddress: string, abi: string): Promise<SmartContractAnalysisResult> => {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
    const prompt = `Analyze the Ethereum smart contract "${contractAddress}" with the following (simulated) ABI snippet: ${abi.substring(0, 200)}...
    Explain its main purpose, list key functions, provide security insights, known vulnerabilities (if any), and common user interactions.`;

    console.log("AI Contract Analysis Prompt:", prompt);

    return new Promise(resolve => setTimeout(() => {
        const mockPurpose = `This contract appears to be a token exchange contract, likely part of a decentralized exchange (DEX). It enables users to swap various ERC-20 tokens.`;
        const mockKeyFunctions = ['swapExactTokensForTokens', 'addLiquidity', 'removeLiquidity', 'getAmountsOut'];
        const mockSecurityInsights = `The contract seems to use standard DEX patterns. Audit reports are generally available for major DEXs. Users should be aware of potential slippage and impermanent loss in liquidity pools.`;
        const mockVulnerabilities: string[] = Math.random() > 0.8 ? ['Potential reentrancy vulnerability in `transferTokens` if not properly guarded. (Hypothetical)'] : [];
        const mockCommonInteractions = `Users typically interact with this contract to exchange tokens, provide liquidity, or withdraw liquidity from pools.`;

        resolve({
            purpose: mockPurpose,
            keyFunctions: mockKeyFunctions,
            securityInsights: mockSecurityInsights,
            knownVulnerabilities: mockVulnerabilities,
            commonInteractions: mockCommonInteractions,
        });
    }, 2500 + Math.random() * 1500));
};

/**
 * @typedef {object} TokenSentimentAnalysisResult
 * @property {string} sentimentScore - Overall sentiment (e.g., 'Positive', 'Neutral', 'Negative').
 * @property {string} explanation - Detailed explanation of the sentiment.
 * @property {string[]} keywords - Key positive/negative keywords identified.
 * @property {string[]} influentialSources - Where the sentiment was detected.
 */
export interface TokenSentimentAnalysisResult {
    sentimentScore: 'Positive' | 'Neutral' | 'Negative';
    explanation: string;
    keywords: string[];
    influentialSources: string[];
}

/**
 * AI service for token sentiment analysis (simulated).
 * @param {string} tokenSymbol - Symbol of the token (e.g., ETH, USDC).
 */
export const analyzeTokenSentimentWithAI = async (tokenSymbol: string): Promise<TokenSentimentAnalysisResult> => {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
    const prompt = `Perform a sentiment analysis for the token "${tokenSymbol}" based on recent news and social media trends.`;

    console.log("AI Token Sentiment Prompt:", prompt);

    return new Promise(resolve => setTimeout(() => {
        const scores: TokenSentimentAnalysisResult['sentimentScore'][] = ['Positive', 'Neutral', 'Negative'];
        const sentiment = scores[Math.floor(Math.random() * scores.length)];

        let explanation = '';
        let keywords: string[] = [];
        let sources = ['Twitter', 'Reddit', 'News Articles'];

        switch (sentiment) {
            case 'Positive':
                explanation = `${tokenSymbol} is currently experiencing strong positive sentiment driven by recent product updates and growing adoption. Community engagement is high.`;
                keywords = ['bullish', 'innovation', 'growth', 'adoption', 'strong'];
                break;
            case 'Neutral':
                explanation = `Sentiment for ${tokenSymbol} is largely neutral, with no significant news or events driving strong positive or negative emotions. Steady market performance.`;
                keywords = ['stable', 'steady', 'holding', 'wait-and-see'];
                break;
            case 'Negative':
                explanation = `${tokenSymbol} shows negative sentiment due to recent FUD (Fear, Uncertainty, Doubt) and a market downturn. Some concerns about regulatory pressure.`;
                keywords = ['bearish', 'concern', 'sell-off', 'regulatory', 'weak'];
                break;
        }

        resolve({
            sentimentScore: sentiment,
            explanation: explanation,
            keywords: keywords,
            influentialSources: sources,
        });
    }, 1800 + Math.random() * 800));
};


// --- DASHBOARD COMPONENTS ---
/**
 * Props for the ChartPlaceholder component.
 * @property {string} title - The title of the chart.
 * @property {ChartDataPoint[]} data - Array of data points for the chart.
 * @property {string} xLabel - Label for the x-axis.
 * @property {string} yLabel - Label for the y-axis.
 * @property {string} [color='cyan-500'] - Tailwind CSS color class for the line.
 */
export interface ChartProps {
    title: string;
    data: ChartDataPoint[];
    xLabel: string;
    yLabel: string;
    color?: string;
}

/**
 * A placeholder component that simulates a line chart using SVG and basic styling.
 * This avoids needing a heavy charting library for the given line count task.
 */
export const ChartPlaceholder: React.FC<ChartProps> = ({ title, data, xLabel, yLabel, color = 'cyan-500' }) => {
    if (!data || data.length === 0) {
        return <Card title={title}><div className="p-4 text-center text-gray-400">No data available for {title}.</div></Card>;
    }
    const maxVal = Math.max(...data.map(d => d.value));
    const minVal = Math.min(...data.map(d => d.value));

    // Prepare CSS variable for the stroke color
    const colorClassParts = color.split('-'); // e.g., ['cyan', '500']
    const cssVar = `var(--color-${colorClassParts[0]}-${colorClassParts[1]})`;

    // Simulate drawing a very simple line chart using divs and styling
    const points = data.map((d, i) => {
        const xPos = (i / (data.length - 1)) * 100;
        const yPos = 100 - ((d.value - minVal) / (maxVal - minVal)) * 100;
        return `${xPos}% ${yPos}%`;
    }).join(',');

    return (
        <Card title={title}>
            <div className="relative h-64 w-full bg-gray-900 rounded-lg p-2">
                <svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <polyline fill="none" stroke={cssVar} strokeWidth="1" points={points} />
                </svg>
                <div className="absolute bottom-0 left-0 right-0 text-center text-xs text-gray-500">{xLabel}</div>
                <div className="absolute top-0 left-0 bottom-0 text-left text-xs text-gray-500 transform -rotate-90 origin-bottom-left pt-2">{yLabel}</div>
                <div className="absolute top-2 right-2 text-xs text-gray-400">
                    Max: {formatNumber(maxVal, 2)} | Min: {formatNumber(minVal, 2)}
                </div>
            </div>
        </Card>
    );
};


/**
 * Props for the GlobalMetricsOverview component.
 * @property {Awaited<ReturnType<typeof fetchGlobalMetrics>> | null} metrics - Global metrics data.
 * @property {boolean} isLoading - Loading state.
 */
export interface GlobalMetricsProps {
    metrics: Awaited<ReturnType<typeof fetchGlobalMetrics>> | null;
    isLoading: boolean;
}

/**
 * Displays key global blockchain metrics in a card layout.
 */
export const GlobalMetricsOverview: React.FC<GlobalMetricsProps> = ({ metrics, isLoading }) => {
    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card title="24h Volume">
                {isLoading ? <div className="h-6 w-3/4 bg-gray-700 animate-pulse rounded"></div> : <div className="text-2xl font-bold text-white">{formatCurrency(metrics?.totalVolume24hUsd || 0, '$', 0)}</div>}
                <div className="text-sm text-gray-400 mt-1">Total traded across chains</div>
            </Card>
            <Card title="24h Transactions">
                {isLoading ? <div className="h-6 w-3/4 bg-gray-700 animate-pulse rounded"></div> : <div className="text-2xl font-bold text-white">{formatNumber(metrics?.totalTransactions24h || 0, 0)}</div>}
                <div className="text-sm text-gray-400 mt-1">Total transactions processed</div>
            </Card>
            <Card title="Active Wallets (24h)">
                {isLoading ? <div className="h-6 w-3/4 bg-gray-700 animate-pulse rounded"></div> : <div className="text-2xl font-bold text-white">{formatNumber(metrics?.activeWallets24h || 0, 0)}</div>}
                <div className="text-sm text-gray-400 mt-1">Unique active addresses</div>
            </Card>
            <Card title="Avg. Gas Price">
                {isLoading ? <div className="h-6 w-3/4 bg-gray-700 animate-pulse rounded"></div> : <div className="text-2xl font-bold text-white">{formatNumber(metrics?.averageGasPriceGwei || 0)} Gwei</div>}
                <div className="text-sm text-gray-400 mt-1">Ethereum network average</div>
            </Card>
        </div>
    );
};

/**
 * Props for the RecentTransactionsTable component.
 * @property {Transaction[]} transactions - Array of transaction data.
 * @property {boolean} isLoading - Loading state.
 */
export interface RecentTransactionsTableProps {
    transactions: Transaction[];
    isLoading: boolean;
}

/**
 * Displays a table of recent blockchain transactions.
 */
export const RecentTransactionsTable: React.FC<RecentTransactionsTableProps> = ({ transactions, isLoading }) => {
    return (
        <Card title="Recent Transactions">
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-800">
                        <tr>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Hash</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">From</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">To</th>
                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Value</th>
                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Fee</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Time Ago</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody className="bg-gray-800/50 divide-y divide-gray-700">
                        {isLoading ? (
                            Array.from({ length: 5 }).map((_, i) => (
                                <tr key={i}>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-24 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-16 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-20 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-20 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right"><div className="h-4 w-12 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right"><div className="h-4 w-10 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-16 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-12 bg-gray-700 animate-pulse rounded"></div></td>
                                </tr>
                            ))
                        ) : (
                            transactions.map(tx => (
                                <tr key={tx.hash} className="hover:bg-gray-700/50 transition-colors duration-150">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-cyan-400 cursor-pointer" onClick={() => window.open(`https://etherscan.io/tx/${tx.hash}`, '_blank')}>{shortenAddress(tx.hash, 8)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300 capitalize">{tx.type.replace('_', ' ')}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-green-400">{shortenAddress(tx.from)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-red-400">{shortenAddress(tx.to)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-white">{formatNumber(weiToEth(tx.value), 4)} {tx.tokenSymbol || 'ETH'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-400">{tx.fee} ETH</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{timeAgo(tx.timestamp)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tx.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                            {tx.status}
                                        </span>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </Card>
    );
};

/**
 * Props for the TopTokensTable component.
 * @property {TokenBalance[]} tokens - Array of top token data.
 * @property {boolean} isLoading - Loading state.
 */
export interface TopTokensTableProps {
    tokens: TokenBalance[];
    isLoading: boolean;
}

/**
 * Displays a table of top tokens by simulated market cap.
 */
export const TopTokensTable: React.FC<TopTokensTableProps> = ({ tokens, isLoading }) => {
    return (
        <Card title="Top Tokens by Market Cap (Simulated)">
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-800">
                        <tr>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Token</th>
                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Symbol</th>
                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Price (USD)</th>
                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Market Cap (Simulated)</th>
                        </tr>
                    </thead>
                    <tbody className="bg-gray-800/50 divide-y divide-gray-700">
                        {isLoading ? (
                            Array.from({ length: 5 }).map((_, i) => (
                                <tr key={i}>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-20 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap"><div className="h-4 w-12 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right"><div className="h-4 w-16 bg-gray-700 animate-pulse rounded"></div></td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right"><div className="h-4 w-24 bg-gray-700 animate-pulse rounded"></div></td>
                                </tr>
                            ))
                        ) : (
                            tokens.map(token => (
                                <tr key={token.address}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-white">
                                        <div className="flex items-center">
                                            {token.logoUrl && <img src={token.logoUrl} alt={token.symbol} className="h-6 w-6 mr-2 rounded-full" />}
                                            {token.name}
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300 uppercase">{token.symbol}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-white">{formatCurrency(token.priceUsd)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-white">{formatCurrency(token.valueUsd, '$', 0)}</td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </Card>
    );
};

/**
 * Props for the DeFiProtocolsOverview component.
 * @property {DeFiProtocol[]} protocols - Array of DeFi protocol data.
 * @property {boolean} isLoading - Loading state.
 */
export interface DeFiProtocolsOverviewProps {
    protocols: DeFiProtocol[];
    isLoading: boolean;
}

/**
 * Displays an overview of top DeFi protocols.
 */
export const DeFiProtocolsOverview: React.FC<DeFiProtocolsOverviewProps> = ({ protocols, isLoading }) => {
    return (
        <Card title="Top DeFi Protocols">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {isLoading ? (
                    Array.from({ length: 4 }).map((_, i) => (
                        <div key={i} className="flex items-center space-x-4 bg-gray-800/50 p-4 rounded-lg animate-pulse">
                            <div className="h-10 w-10 bg-gray-700 rounded-full"></div>
                            <div className="flex-1 space-y-2">
                                <div className="h-4 w-3/4 bg-gray-700 rounded"></div>
                                <div className="h-3 w-1/2 bg-gray-700 rounded"></div>
                            </div>
                            <div className="h-5 w-1/4 bg-gray-700 rounded"></div>
                        </div>
                    ))
                ) : (
                    protocols.map(protocol => (
                        <div key={protocol.address} className="flex items-center space-x-4 bg-gray-800/50 p-4 rounded-lg hover:bg-gray-700/50 transition-colors duration-150">
                            {protocol.logoUrl && <img src={protocol.logoUrl} alt={protocol.name} className="h-10 w-10 rounded-full" />}
                            <div className="flex-1">
                                <h4 className="text-white font-semibold">{protocol.name} <span className="text-xs text-gray-500">({protocol.category})</span></h4>
                                <p className="text-sm text-gray-400">TVL: {formatCurrency(protocol.tvlUsd, '$', 0)}</p>
                                <p className="text-xs text-gray-500">24h Vol: {formatCurrency(protocol.volume24hUsd, '$', 0)}</p>
                            </div>
                            <button className="text-cyan-400 hover:text-cyan-300 text-sm">Details</button>
                        </div>
                    ))
                )}
            </div>
        </Card>
    );
};

/**
 * Props for the NFTMarketOverview component.
 * @property {NFTCollection[]} collections - Array of NFT collection data.
 * @property {boolean} isLoading - Loading state.
 */
export interface NFTMarketOverviewProps {
    collections: NFTCollection[];
    isLoading: boolean;
}

/**
 * Displays an overview of top NFT collections.
 */
export const NFTMarketOverview: React.FC<NFTMarketOverviewProps> = ({ collections, isLoading }) => {
    return (
        <Card title="Top NFT Collections">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {isLoading ? (
                    Array.from({ length: 3 }).map((_, i) => (
                        <div key={i} className="bg-gray-800/50 p-4 rounded-lg animate-pulse">
                            <div className="h-32 w-full bg-gray-700 rounded mb-4"></div>
                            <div className="h-4 w-3/4 bg-gray-700 rounded mb-2"></div>
                            <div className="h-3 w-1/2 bg-gray-700 rounded"></div>
                        </div>
                    ))
                ) : (
                    collections.map(collection => (
                        <div key={collection.contractAddress} className="bg-gray-800/50 p-4 rounded-lg hover:bg-gray-700/50 transition-colors duration-150">
                            {collection.imageUrl && <img src={collection.imageUrl} alt={collection.name} className="h-32 w-full object-cover rounded mb-4" />}
                            <h4 className="text-white font-semibold">{collection.name}</h4>
                            <p className="text-sm text-gray-400">Floor Price: {formatNumber(collection.floorPriceEth, 2)} ETH ({formatCurrency(collection.floorPriceUsd, '$', 0)})</p>
                            <p className="text-xs text-gray-500">24h Volume: {formatNumber(collection.volume24hEth, 2)} ETH</p>
                            <p className="text-xs text-gray-500">Holders: {formatNumber(collection.uniqueHolders, 0)}</p>
                        </div>
                    ))
                )}
            </div>
        </Card>
    );
};

/**
 * Props for the GasPriceTracker component.
 * @property {GasPriceInfo | null} gasInfo - Gas price information.
 * @property {boolean} isLoading - Loading state.
 */
export interface GasPriceTrackerProps {
    gasInfo: GasPriceInfo | null;
    isLoading: boolean;
}

/**
 * Displays current Ethereum gas prices.
 */
export const GasPriceTracker: React.FC<GasPriceTrackerProps> = ({ gasInfo, isLoading }) => {
    return (
        <Card title="Ethereum Gas Price">
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div className="p-3 bg-gray-900 rounded-lg">
                    <p className="text-sm text-gray-400">Standard</p>
                    {isLoading ? <div className="h-6 w-1/2 mx-auto bg-gray-700 animate-pulse rounded mt-2"></div> : <p className="text-2xl font-bold text-white mt-1">{gasInfo?.standardGwei || '--'} Gwei</p>}
                </div>
                <div className="p-3 bg-gray-900 rounded-lg">
                    <p className="text-sm text-gray-400">Fast</p>
                    {isLoading ? <div className="h-6 w-1/2 mx-auto bg-gray-700 animate-pulse rounded mt-2"></div> : <p className="text-2xl font-bold text-white mt-1">{gasInfo?.fastGwei || '--'} Gwei</p>}
                </div>
                <div className="p-3 bg-gray-900 rounded-lg">
                    <p className="text-sm text-gray-400">Rapid</p>
                    {isLoading ? <div className="h-6 w-1/2 mx-auto bg-gray-700 animate-pulse rounded mt-2"></div> : <p className="text-2xl font-bold text-white mt-1">{gasInfo?.rapidGwei || '--'} Gwei</p>}
                </div>
            </div>
            <div className="text-xs text-gray-500 mt-4">
                {isLoading ? <div className="h-3 w-3/4 bg-gray-700 animate-pulse rounded mx-auto"></div> : `Base Fee: ${gasInfo?.baseFeeGwei || '--'} Gwei | Priority Fee: ${gasInfo?.priorityFeeGwei || '--'} Gwei (Last Block: ${gasInfo?.lastBlock || '--'})`}
            </div>
        </Card>
    );
};

/**
 * A component for analyzing a specific Ethereum wallet using AI.
 */
export const WalletAnalyzer: React.FC = () => {
    const [address, setAddress] = useState('');
    const [walletData, setWalletData] = useState<WalletActivity | null>(null);
    const [analysisResult, setAnalysisResult] = useState<WalletAnalysisResult | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const handleAnalyze = async () => {
        if (!address) {
            setError("Please enter a wallet address.");
            return;
        }
        setIsLoading(true);
        setError(null);
        setWalletData(null);
        setAnalysisResult(null);

        try {
            const fetchedData = await fetchWalletActivity(address);
            setWalletData(fetchedData);
            const result = await analyzeWalletWithAI(address, fetchedData);
            setAnalysisResult(result);

        } catch (err) {
            console.error("Wallet analysis error:", err);
            setError("Failed to analyze wallet. Please check the address or try again. (Simulated data/AI error)");
            setWalletData(null);
            setAnalysisResult(null);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Card title="AI Wallet Analyzer">
            <div className="space-y-4">
                <input
                    type="text"
                    value={address}
                    onChange={e => setAddress(e.target.value)}
                    placeholder="Enter Ethereum Wallet Address (e.g., 0x...)"
                    className="w-full bg-gray-700/50 p-2 rounded text-white font-mono placeholder-gray-500"
                />
                <button onClick={handleAnalyze} disabled={isLoading || !address} className="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded disabled:opacity-50">
                    {isLoading ? 'Analyzing Wallet...' : 'Analyze Wallet'}
                </button>

                {error && <div className="text-red-500 text-sm">{error}</div>}

                {isLoading && !walletData && !analysisResult && (
                    <div className="p-4 text-center text-gray-400">Fetching data and running AI analysis...</div>
                )}

                {walletData && (
                    <div className="bg-gray-900 p-4 rounded-lg space-y-3">
                        <h4 className="text-lg font-semibold text-white">Wallet Overview: {shortenAddress(walletData.address)}</h4>
                        <p className="text-gray-300">Total Value: <span className="font-bold">{formatCurrency(parseFloat(walletData.totalValueUsd))}</span></p>
                        <p className="text-gray-300">Total Transactions: {formatNumber(walletData.transactionCount, 0)}</p>
                        <p className="text-gray-300">First Seen: {formatDate(walletData.firstSeenTimestamp)}</p>
                        <h5 className="font-semibold text-gray-200 mt-3">Balances:</h5>
                        <ul className="list-disc list-inside text-sm text-gray-400">
                            {walletData.balances.map(b => (
                                <li key={b.symbol}>{formatNumber(weiToEth(b.balance), 4)} {b.symbol} ({formatCurrency(b.valueUsd)})</li>
                            ))}
                        </ul>
                    </div>
                )}

                {analysisResult && (
                    <div className="bg-gray-900 p-4 rounded-lg space-y-3">
                        <h4 className="text-lg font-semibold text-white">AI Analysis Insights:</h4>
                        <p className="text-gray-300"><span className="font-semibold">Summary:</span> {analysisResult.summary}</p>
                        <p className="text-gray-300"><span className="font-semibold">Risk Score:</span> {analysisResult.riskScoreExplanation}</p>
                        {analysisResult.topTokens.length > 0 && (
                            <p className="text-gray-300"><span className="font-semibold">Top Tokens:</span> {analysisResult.topTokens.join(', ')}</p>
                        )}
                        {analysisResult.topProtocols.length > 0 && (
                            <p className="text-gray-300"><span className="font-semibold">Top Protocols:</span> {analysisResult.topProtocols.join(', ')}</p>
                        )}
                        {analysisResult.potentialAnomalies.length > 0 && (
                            <div className="mt-3">
                                <h5 className="font-semibold text-red-400">Potential Anomalies:</h5>
                                <ul className="list-disc list-inside text-sm text-red-300">
                                    {analysisResult.potentialAnomalies.map((anomaly, i) => <li key={i}>{anomaly}</li>)}
                                </ul>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </Card>
    );
};

/**
 * A component for analyzing a specific smart contract using AI.
 */
export const SmartContractAnalyzer: React.FC = () => {
    const [contractAddress, setContractAddress] = useState('');
    const [abiInput, setAbiInput] = useState(''); // Simulated ABI input
    const [analysisResult, setAnalysisResult] = useState<SmartContractAnalysisResult | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const handleAnalyze = async () => {
        if (!contractAddress) {
            setError("Please enter a contract address.");
            return;
        }
        // In a real app, you'd fetch the ABI from Etherscan or similar
        const simulatedAbi = abiInput || `[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"}, {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}, {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}]`;

        setIsLoading(true);
        setError(null);
        setAnalysisResult(null);

        try {
            const result = await analyzeSmartContractWithAI(contractAddress, simulatedAbi);
            setAnalysisResult(result);
        } catch (err) {
            console.error("Smart contract analysis error:", err);
            setError("Failed to analyze smart contract. Please check the address or try again. (Simulated AI error)");
            setAnalysisResult(null);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Card title="AI Smart Contract Analyzer">
            <div className="space-y-4">
                <input
                    type="text"
                    value={contractAddress}
                    onChange={e => setContractAddress(e.target.value)}
                    placeholder="Enter Smart Contract Address (e.g., 0x...)"
                    className="w-full bg-gray-700/50 p-2 rounded text-white font-mono placeholder-gray-500"
                />
                <textarea
                    value={abiInput}
                    onChange={e => setAbiInput(e.target.value)}
                    placeholder="Optional: Paste ABI JSON here (e.g., from Etherscan)"
                    rows={4}
                    className="w-full bg-gray-700/50 p-2 rounded text-white font-mono placeholder-gray-500"
                ></textarea>
                <button onClick={handleAnalyze} disabled={isLoading || !contractAddress} className="w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded disabled:opacity-50">
                    {isLoading ? 'Analyzing Contract...' : 'Analyze Contract'}
                </button>

                {error && <div className="text-red-500 text-sm">{error}</div>}

                {isLoading && !analysisResult && (
                    <div className="p-4 text-center text-gray-400">Running AI analysis on contract...</div>
                )}

                {analysisResult && (
                    <div className="bg-gray-900 p-4 rounded-lg space-y-3">
                        <h4 className="text-lg font-semibold text-white">AI Contract Insights:</h4>
                        <p className="text-gray-300"><span className="font-semibold">Purpose:</span> {analysisResult.purpose}</p>
                        <p className="text-gray-300"><span className="font-semibold">Key Functions:</span> {analysisResult.keyFunctions.join(', ')}</p>
                        <p className="text-gray-300"><span className="font-semibold">Security Insights:</span> {analysisResult.securityInsights}</p>
                        {analysisResult.knownVulnerabilities.length > 0 && (
                            <div className="mt-3">
                                <h5 className="font-semibold text-red-400">Known Vulnerabilities:</h5>
                                <ul className="list-disc list-inside text-sm text-red-300">
                                    {analysisResult.knownVulnerabilities.map((vuln, i) => <li key={i}>{vuln}</li>)}
                                </ul>
                            </div>
                        )}
                        <p className="text-gray-300"><span className="font-semibold">Common Interactions:</span> {analysisResult.commonInteractions}</p>
                    </div>
                )}
            </div>
        </Card>
    );
};

/**
 * A component for analyzing token sentiment using AI.
 */
export const TokenSentimentAnalyzer: React.FC = () => {
    const [tokenSymbol, setTokenSymbol] = useState('');
    const [analysisResult, setAnalysisResult] = useState<TokenSentimentAnalysisResult | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const handleAnalyze = async () => {
        if (!tokenSymbol) {
            setError("Please enter a token symbol (e.g., ETH, USDC).");
            return;
        }
        setIsLoading(true);
        setError(null);
        setAnalysisResult(null);

        try {
            const result = await analyzeTokenSentimentWithAI(tokenSymbol);
            setAnalysisResult(result);
        } catch (err) {
            console.error("Token sentiment analysis error:", err);
            setError("Failed to analyze token sentiment. Please check the symbol or try again. (Simulated AI error)");
            setAnalysisResult(null);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Card title="AI Token Sentiment Analyzer">
            <div className="space-y-4">
                <input
                    type="text"
                    value={tokenSymbol}
                    onChange={e => setTokenSymbol(e.target.value.toUpperCase())}
                    placeholder="Enter Token Symbol (e.g., ETH, USDC)"
                    className="w-full bg-gray-700/50 p-2 rounded text-white font-mono placeholder-gray-500"
                />
                <button onClick={handleAnalyze} disabled={isLoading || !tokenSymbol} className="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded disabled:opacity-50">
                    {isLoading ? 'Analyzing Sentiment...' : 'Analyze Sentiment'}
                </button>

                {error && <div className="text-red-500 text-sm">{error}</div>}

                {isLoading && !analysisResult && (
                    <div className="p-4 text-center text-gray-400">Running AI sentiment analysis...</div>
                )}

                {analysisResult && (
                    <div className="bg-gray-900 p-4 rounded-lg space-y-3">
                        <h4 className="text-lg font-semibold text-white">AI Sentiment Insights for {tokenSymbol}:</h4>
                        <p className="text-gray-300"><span className="font-semibold">Overall Sentiment:</span> <span className={
                            analysisResult.sentimentScore === 'Positive' ? 'text-green-400' :
                            analysisResult.sentimentScore === 'Negative' ? 'text-red-400' : 'text-yellow-400'
                        }>{analysisResult.sentimentScore}</span></p>
                        <p className="text-gray-300"><span className="font-semibold">Explanation:</span> {analysisResult.explanation}</p>
                        {analysisResult.keywords.length > 0 && (
                            <p className="text-gray-300"><span className="font-semibold">Keywords:</span> {analysisResult.keywords.join(', ')}</p>
                        )}
                        {analysisResult.influentialSources.length > 0 && (
                            <p className="text-gray-300"><span className="font-semibold">Influential Sources:</span> {analysisResult.influentialSources.join(', ')}</p>
                        )}
                    </div>
                )}
            </div>
        </Card>
    );
};


/**
 * Props for the SearchFilterBar component.
 * @property {(query: string) => void} onSearch - Callback for search queries.
 * @property {(filters: { type?: string; status?: string; dateRange?: string }) => void} onFilterChange - Callback for filter changes.
 * @property {string} currentQuery - The current search query string.
 * @property {{ type?: string; status?: string; dateRange?: string }} currentFilters - The currently applied filters.
 */
export interface SearchFilterBarProps {
    onSearch: (query: string) => void;
    onFilterChange: (filters: { type?: string; status?: string; dateRange?: string }) => void;
    currentQuery: string;
    currentFilters: { type?: string; status?: string; dateRange?: string };
}

/**
 * A search and filter bar for transaction data.
 */
export const SearchFilterBar: React.FC<SearchFilterBarProps> = ({ onSearch, onFilterChange, currentQuery, currentFilters }) => {
    const [searchQuery, setSearchQuery] = useState(currentQuery);
    const [selectedType, setSelectedType] = useState(currentFilters.type || '');
    const [selectedStatus, setSelectedStatus] = useState(currentFilters.status || '');
    const [selectedDateRange, setSelectedDateRange] = useState(currentFilters.dateRange || '');

    useEffect(() => {
        setSearchQuery(currentQuery);
        setSelectedType(currentFilters.type || '');
        setSelectedStatus(currentFilters.status || '');
        setSelectedDateRange(currentFilters.dateRange || '');
    }, [currentQuery, currentFilters]);

    const handleSearchClick = () => {
        onSearch(searchQuery);
    };

    const handleFilterChangeInternal = (key: string, value: string) => {
        const newFilters = { ...currentFilters, [key]: value };
        onFilterChange(newFilters);
        if (key === 'type') setSelectedType(value);
        if (key === 'status') setSelectedStatus(value);
        if (key === 'dateRange') setSelectedDateRange(value);
    };

    return (
        <Card title="Analytics Search & Filters">
            <div className="space-y-4">
                <div className="flex flex-col sm:flex-row gap-2">
                    <input
                        type="text"
                        value={searchQuery}
                        onChange={e => setSearchQuery(e.target.value)}
                        placeholder="Search by address, hash, or block..."
                        className="flex-grow bg-gray-700/50 p-2 rounded text-white placeholder-gray-500"
                        onKeyPress={(e) => { if (e.key === 'Enter') handleSearchClick(); }}
                    />
                    <button onClick={handleSearchClick} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium">Search</button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label htmlFor="transaction-type" className="block text-sm font-medium text-gray-300 mb-1">Transaction Type</label>
                        <select
                            id="transaction-type"
                            value={selectedType}
                            onChange={e => handleFilterChangeInternal('type', e.target.value)}
                            className="w-full bg-gray-700/50 p-2 rounded text-white"
                        >
                            <option value="">All Types</option>
                            <option value="transfer">Transfer</option>
                            <option value="contract_call">Contract Call</option>
                            <option value="swap">Swap</option>
                            <option value="mint">Mint</option>
                            <option value="burn">Burn</option>
                        </select>
                    </div>
                    <div>
                        <label htmlFor="transaction-status" className="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <select
                            id="transaction-status"
                            value={selectedStatus}
                            onChange={e => handleFilterChangeInternal('status', e.target.value)}
                            className="w-full bg-gray-700/50 p-2 rounded text-white"
                        >
                            <option value="">All Statuses</option>
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div>
                        <label htmlFor="date-range" className="block text-sm font-medium text-gray-300 mb-1">Date Range</label>
                        <select
                            id="date-range"
                            value={selectedDateRange}
                            onChange={e => handleFilterChangeInternal('dateRange', e.target.value)}
                            className="w-full bg-gray-700/50 p-2 rounded text-white"
                        >
                            <option value="">All Time</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="1y">Last Year</option>
                        </select>
                    </div>
                </div>
            </div>
        </Card>
    );
};


/**
 * Props for the TransactionExplainerModal component.
 * @property {boolean} isOpen - Controls the visibility of the modal.
 * @property {() => void} onClose - Callback function to close the modal.
 * @property {string} [initialTxHash=""] - Optional initial transaction hash to pre-fill the input.
 */
export interface TransactionExplainerModalProps {
    isOpen: boolean;
    onClose: () => void;
    initialTxHash?: string;
}

/**
 * A modal component for AI-powered transaction explanation.
 */
export const TransactionExplainerModal: React.FC<TransactionExplainerModalProps> = ({ isOpen, onClose, initialTxHash = "" }) => {
    const [txHash, setTxHash] = useState(initialTxHash);
    const [explanation, setExplanation] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        if (isOpen) {
            setTxHash(initialTxHash);
            setExplanation(''); // Clear previous explanation
            setError(null);    // Clear previous error
        }
    }, [isOpen, initialTxHash]);

    const handleExplain = async () => {
        if (!txHash || txHash.trim() === "") {
            setError("Please enter a valid transaction hash.");
            return;
        }
        setIsLoading(true);
        setExplanation('');
        setError(null);
        try {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
            // Simulate fetching transaction data first (not implemented here, assumed successful)
            // In a real application, you would make an actual API call to Etherscan, Alchemy, etc.
            const mockTxData: Transaction = {
                hash: txHash,
                from: '0xabc123def4567890abc123def4567890abc123de',
                to: '0xdef456abc123def456abc123def456abc123de12',
                value: '1000000000000000000', // 1 ETH
                tokenSymbol: 'ETH',
                gasUsed: 21000,
                gasPrice: '20000000000', // 20 Gwei
                timestamp: Math.floor(Date.now() / 1000) - Math.floor(Math.random() * 3600 * 24 * 3), // within last 3 days
                status: Math.random() > 0.1 ? 'success' : 'failed',
                type: Math.random() > 0.7 ? 'swap' : (Math.random() > 0.5 ? 'contract_call' : 'transfer'),
                blockNumber: (Math.floor(Math.random() * 1000000) + 18000000).toString(),
                fee: calculateFeeEth(21000, '20000000000'),
            }; 
            
            const prompt = `Explain the following Ethereum transaction in simple terms, focusing on what it represents. If it's a common DeFi interaction like a swap, liquidity provision, or token transfer, describe that.
            
            Transaction Details:
            - Hash: ${mockTxData.hash}
            - From Address: ${mockTxData.from}
            - To Address: ${mockTxData.to}
            - Value: ${weiToEth(mockTxData.value)} ${mockTxData.tokenSymbol || 'ETH'}
            - Type: ${mockTxData.type.replace('_', ' ')}
            - Status: ${mockTxData.status}
            - Gas Fee: ${mockTxData.fee} ETH
            - Timestamp: ${formatDate(mockTxData.timestamp)}
            
            Based on these details, what did this transaction likely achieve on the Ethereum blockchain? Provide a clear, concise, and easy-to-understand explanation for a non-technical user. Assume context if it looks like a common protocol (e.g., Uniswap swap, Aave deposit).`;
            
            const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: [{text: prompt}] });
            setExplanation(response.text.replace(/(\*\*)/g, '')); // Remove markdown bold for simpler display
        } catch (err) {
            console.error("AI explanation error:", err);
            setError("Error explaining transaction. Please ensure the API key is valid and the transaction hash is correct. (Simulated AI error/API limit)");
            setExplanation("Could not generate explanation.");
        } finally {
            setIsLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
            <div className="bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full border border-gray-700" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-lg font-semibold text-white">AI Transaction Explainer</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white text-xl leading-none">&times;</button>
                </div>
                <div className="p-6 space-y-4">
                    <input
                        type="text"
                        value={txHash}
                        onChange={e => setTxHash(e.target.value)}
                        placeholder="Enter Transaction Hash (e.g., 0x123...abc)"
                        className="w-full bg-gray-700/50 p-2 rounded text-white font-mono placeholder-gray-500"
                    />
                    <button onClick={handleExplain} disabled={isLoading || !txHash.trim()} className="w-full py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded disabled:opacity-50">
                        {isLoading ? 'Analyzing...' : 'Explain Transaction'}
                    </button>
                    {error && <div className="text-red-500 text-sm">{error}</div>}
                    <Card title="Explanation">
                        <div className="min-h-[10rem] text-sm text-gray-300 whitespace-pre-line overflow-y-auto max-h-80">
                            {isLoading ? 'Generating AI explanation...' : (explanation || 'Enter a transaction hash and click "Explain Transaction" to get an AI-generated explanation.')}
                        </div>
                    </Card>
                </div>
            </div>
        </div>
    );
};


// Main OnChainAnalyticsView component - Orchestrates all other components
const OnChainAnalyticsView: React.FC = () => {
    // Original AI Explainer state
    const [isExplainerOpen, setExplainerOpen] = useState(false);
    const [explainerTxHash, setExplainerTxHash] = useState("0x272b16a4f91e984a9e574d618d350d7a22906ed28956973e87858c89b2767098"); // Example Uniswap Tx Hash

    // Global Metrics State
    const [globalMetrics, setGlobalMetrics] = useState<Awaited<ReturnType<typeof fetchGlobalMetrics>> | null>(null);
    const [isLoadingMetrics, setIsLoadingMetrics] = useState(true);

    // Transactions State
    const [recentTransactions, setRecentTransactions] = useState<Transaction[]>([]);
    const [isLoadingTransactions, setIsLoadingTransactions] = useState(true);
    const [transactionSearchQuery, setTransactionSearchQuery] = useState('');
    const [transactionFilters, setTransactionFilters] = useState<{ type?: string; status?: string; dateRange?: string }>({});

    // Top Tokens State
    const [topTokens, setTopTokens] = useState<TokenBalance[]>([]);
    const [isLoadingTopTokens, setIsLoadingTopTokens] = useState(true);

    // DeFi Protocols State
    const [defiProtocols, setDeFiProtocols] = useState<DeFiProtocol[]>([]);
    const [isLoadingDeFiProtocols, setIsLoadingDeFiProtocols] = useState(true);

    // NFT Collections State
    const [nftCollections, setNftCollections] = useState<NFTCollection[]>([]);
    const [isLoadingNftCollections, setIsLoadingNftCollections] = useState(true);

    // Gas Price State
    const [gasPriceInfo, setGasPriceInfo] = useState<GasPriceInfo | null>(null);
    const [isLoadingGasPrice, setIsLoadingGasPrice] = useState(true);

    // Chart Data States (ETH Price, Gas Price, Total Tx)
    const [ethPriceChartData, setEthPriceChartData] = useState<ChartDataPoint[]>([]);
    const [gasPriceChartData, setGasPriceChartData] = useState<ChartDataPoint[]>([]);
    const [totalTxChartData, setTotalTxChartData] = useState<ChartDataPoint[]>([]);
    const [isLoadingCharts, setIsLoadingCharts] = useState(true);
    const [chartDuration, setChartDuration] = useState<'7d' | '30d' | '90d' | '1y'>('30d');

    // Data Fetching Effects
    useEffect(() => {
        const loadAllData = async () => {
            // Global Metrics
            setIsLoadingMetrics(true);
            try {
                const metrics = await fetchGlobalMetrics();
                setGlobalMetrics(metrics);
            } catch (error) { console.error("Failed to fetch global metrics", error); }
            finally { setIsLoadingMetrics(false); }

            // Recent Transactions
            setIsLoadingTransactions(true);
            try {
                const txs = await fetchRecentTransactions(15);
                setRecentTransactions(txs);
            } catch (error) { console.error("Failed to fetch recent transactions", error); }
            finally { setIsLoadingTransactions(false); }

            // Top Tokens
            setIsLoadingTopTokens(true);
            try {
                const tokens = await fetchTopTokens(10);
                setTopTokens(tokens);
            } catch (error) { console.error("Failed to fetch top tokens", error); }
            finally { setIsLoadingTopTokens(false); }

            // DeFi Protocols
            setIsLoadingDeFiProtocols(true);
            try {
                const protocols = await fetchDeFiProtocols(6);
                setDeFiProtocols(protocols);
            } catch (error) { console.error("Failed to fetch DeFi protocols", error); }
            finally { setIsLoadingDeFiProtocols(false); }

            // NFT Collections
            setIsLoadingNftCollections(true);
            try {
                const nfts = await fetchNFTCollections(5);
                setNftCollections(nfts);
            } catch (error) { console.error("Failed to fetch NFT collections", error); }
            finally { setIsLoadingNftCollections(false); }

            // Gas Price
            setIsLoadingGasPrice(true);
            try {
                const gas = await fetchGasPriceInfo();
                setGasPriceInfo(gas);
            } catch (error) { console.error("Failed to fetch gas price", error); }
            finally { setIsLoadingGasPrice(false); }
        };
        loadAllData();

        // Refresh gas price every 30 seconds
        const gasRefreshInterval = setInterval(() => {
            fetchGasPriceInfo().then(setGasPriceInfo).catch(err => console.error("Failed to refresh gas price", err));
        }, 30000);

        return () => clearInterval(gasRefreshInterval);
    }, []);

    // Effect for Charts data based on duration
    useEffect(() => {
        setIsLoadingCharts(true);
        const loadChartData = async () => {
            try {
                const [ethData, gasData, txData] = await Promise.all([
                    fetchChartData('ethPrice', chartDuration),
                    fetchChartData('gas', chartDuration),
                    fetchChartData('totalTx', chartDuration)
                ]);
                setEthPriceChartData(ethData);
                setGasPriceChartData(gasData);
                setTotalTxChartData(txData);
            } catch (error) {
                console.error("Failed to fetch chart data:", error);
            } finally {
                setIsLoadingCharts(false);
            }
        };
        loadChartData();
    }, [chartDuration]);

    // Memoized and filtered transactions for the table
    const filteredTransactions = useMemo(() => {
        return recentTransactions.filter(tx => {
            let matches = true;
            // Search Query
            if (transactionSearchQuery) {
                const queryLower = transactionSearchQuery.toLowerCase();
                matches = matches && (
                    tx.hash.toLowerCase().includes(queryLower) ||
                    tx.from.toLowerCase().includes(queryLower) ||
                    tx.to.toLowerCase().includes(queryLower) ||
                    (tx.contractAddress && tx.contractAddress.toLowerCase().includes(queryLower)) ||
                    (tx.method && tx.method.toLowerCase().includes(queryLower))
                );
            }

            // Type Filter
            if (transactionFilters.type && transactionFilters.type !== '') {
                matches = matches && tx.type === transactionFilters.type;
            }

            // Status Filter
            if (transactionFilters.status && transactionFilters.status !== '') {
                matches = matches && tx.status === transactionFilters.status;
            }

            // Date Range Filter (simplistic, real implementation would convert range to timestamps)
            if (transactionFilters.dateRange && transactionFilters.dateRange !== '') {
                const now = Math.floor(Date.now() / 1000);
                let cutoffTimestamp = 0;
                switch (transactionFilters.dateRange) {
                    case '24h': cutoffTimestamp = now - 24 * 3600; break;
                    case '7d': cutoffTimestamp = now - 7 * 24 * 3600; break;
                    case '30d': cutoffTimestamp = now - 30 * 24 * 3600; break;
                    case '90d': cutoffTimestamp = now - 90 * 24 * 3600; break;
                    case '1y': cutoffTimestamp = now - 365 * 24 * 3600; break;
                    default: break;
                }
                matches = matches && tx.timestamp >= cutoffTimestamp;
            }

            return matches;
        });
    }, [recentTransactions, transactionSearchQuery, transactionFilters]);

    // Callback for search and filter bar
    const handleSearch = useCallback((query: string) => {
        setTransactionSearchQuery(query);
    }, []);

    const handleFilterChange = useCallback((filters: { type?: string; status?: string; dateRange?: string }) => {
        setTransactionFilters(filters);
    }, []);

    return (
        <>
            <div className="space-y-8 p-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 className="text-4xl font-extrabold text-white tracking-tight">On-Chain Analytics Hub</h2>
                    <div className="flex gap-3">
                        <button onClick={() => setExplainerOpen(true)} className="px-5 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-base font-semibold transition-transform transform hover:scale-105 shadow-lg">
                            AI Transaction Explainer
                        </button>
                    </div>
                </div>

                {/* Global Metrics Section */}
                <section>
                    <h3 className="text-2xl font-bold text-white mb-4">Global Overview</h3>
                    <GlobalMetricsOverview metrics={globalMetrics} isLoading={isLoadingMetrics} />
                </section>

                {/* Charts Section */}
                <section>
                    <h3 className="text-2xl font-bold text-white mb-4">Historical Trends</h3>
                    <div className="flex justify-end mb-4">
                        <select
                            value={chartDuration}
                            onChange={e => setChartDuration(e.target.value as '7d' | '30d' | '90d' | '1y')}
                            className="bg-gray-700/50 p-2 rounded text-white text-sm"
                        >
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="1y">Last Year</option>
                        </select>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <ChartPlaceholder title="ETH Price (USD)" data={ethPriceChartData} xLabel="Time" yLabel="Price ($)" color="green-500" />
                        <ChartPlaceholder title="Average Gas Price (Gwei)" data={gasPriceChartData} xLabel="Time" yLabel="Gwei" color="orange-500" />
                        <ChartPlaceholder title="Total Transactions" data={totalTxChartData} xLabel="Time" yLabel="Transactions" color="purple-500" />
                    </div>
                </section>

                {/* Transaction Explorer Section */}
                <section>
                    <h3 className="text-2xl font-bold text-white mb-4">Transaction Explorer</h3>
                    <SearchFilterBar
                        onSearch={handleSearch}
                        onFilterChange={handleFilterChange}
                        currentQuery={transactionSearchQuery}
                        currentFilters={transactionFilters}
                    />
                    <div className="mt-6">
                        <RecentTransactionsTable transactions={filteredTransactions} isLoading={isLoadingTransactions} />
                    </div>
                </section>

                {/* Top Assets and DeFi Section */}
                <section className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-2xl font-bold text-white mb-4">Top Digital Assets</h3>
                        <TopTokensTable tokens={topTokens} isLoading={isLoadingTopTokens} />
                    </div>
                    <div>
                        <h3 className="text-2xl font-bold text-white mb-4">Decentralized Finance</h3>
                        <DeFiProtocolsOverview protocols={defiProtocols} isLoading={isLoadingDeFiProtocols} />
                    </div>
                </section>

                {/* NFT and Gas Price Section */}
                <section className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-2xl font-bold text-white mb-4">NFT Market Insights</h3>
                        <NFTMarketOverview collections={nftCollections} isLoading={isLoadingNftCollections} />
                    </div>
                    <div>
                        <h3 className="text-2xl font-bold text-white mb-4">Network Health</h3>
                        <GasPriceTracker gasInfo={gasPriceInfo} isLoading={isLoadingGasPrice} />
                    </div>
                </section>

                {/* AI Powered Insights Section */}
                <section>
                    <h3 className="text-2xl font-bold text-white mb-4">AI-Powered Insights</h3>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <WalletAnalyzer />
                        <SmartContractAnalyzer />
                        <TokenSentimentAnalyzer />
                    </div>
                </section>
            </div>

            {/* AI Transaction Explainer Modal */}
            <TransactionExplainerModal isOpen={isExplainerOpen} onClose={() => setExplainerOpen(false)} initialTxHash={explainerTxHash} />
        </>
    );
};

export default OnChainAnalyticsView;

--- FILE: SmartContractsView.tsx ---

// components/views/megadashboard/digitalassets/SmartContractsView.tsx
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import Card from '../../../Card';
import { GoogleGenAI } from "@google/genai";

// --- START: Utility Types and Interfaces ---

// Represents a connected wallet
export interface WalletState {
    isConnected: boolean;
    address: string | null;
    balance: string | null; // e.g., "1.23 ETH"
    networkId: number | null;
    networkName: string | null;
}

// Represents a supported blockchain network
export interface NetworkConfig {
    id: number;
    name: string;
    rpcUrl: string;
    chainId: string; // Hex string e.g., "0x1"
    currency: string;
    explorerUrl: string;
}

// Represents a deployed smart contract
export interface DeployedContract {
    id: string; // Unique ID for the UI
    name: string;
    address: string;
    abi: any[]; // JSON ABI
    bytecode: string;
    deploymentTxHash: string;
    deployerAddress: string;
    network: NetworkConfig;
    timestamp: number;
    sourceCode: string;
    version: string;
}

// Represents a smart contract event
export interface ContractEvent {
    id: string;
    contractAddress: string;
    eventName: string;
    args: { [key: string]: any };
    blockNumber: number;
    transactionHash: string;
    timestamp: number;
}

// Represents a pending or completed transaction
export interface Transaction {
    hash: string;
    from: string;
    to: string;
    value: string; // In native currency units
    gasPrice: string;
    gasUsed: string;
    status: 'pending' | 'success' | 'failed';
    timestamp: number;
    description?: string;
}

// Represents a contract template
export interface ContractTemplate {
    id: string;
    name: string;
    description: string;
    solidityCode: string;
    tags: string[];
    author: string;
    version: string;
}

// Represents a DeFi staking position
export interface StakingPosition {
    id: string;
    contractAddress: string;
    tokenSymbol: string;
    stakedAmount: string;
    rewardsEarned: string;
    lastClaimed: number;
    apy: string;
    userAddress: string;
}

// Represents an NFT
export interface NFTAsset {
    id: string;
    tokenId: string;
    contractAddress: string;
    name: string;
    description: string;
    imageUrl: string;
    owner: string;
    mintedBy: string;
    mintTimestamp: number;
}

// AI Audit Report details
export interface AIAuditReport {
    summary: string;
    vulnerabilities: {
        type: string;
        severity: 'Critical' | 'High' | 'Medium' | 'Low' | 'Informational';
        description: string;
        lineNumbers: number[];
        recommendation: string;
    }[];
    gasOptimizations: string[];
    securityScore: number; // 0-100
    timestamp: number;
}

// AI Code Assistant response
export interface AICodeAssistantResponse {
    type: 'generate' | 'explain' | 'optimize' | 'debug';
    content: string;
    suggestions?: string[];
    timestamp: number;
}

// --- END: Utility Types and Interfaces ---

// --- START: Mock Data and Constants ---

export const SUPPORTED_NETWORKS: NetworkConfig[] = [
    { id: 1, name: 'Ethereum Mainnet', rpcUrl: 'https://mainnet.infura.io/v3/YOUR_INFURA_API_KEY', chainId: '0x1', currency: 'ETH', explorerUrl: 'https://etherscan.io' },
    { id: 137, name: 'Polygon Mainnet', rpcUrl: 'https://polygon-rpc.com', chainId: '0x89', currency: 'MATIC', explorerUrl: 'https://polygonscan.com' },
    { id: 43114, name: 'Avalanche C-Chain', rpcUrl: 'https://api.avax.network/ext/bc/C/rpc', chainId: '0xA86A', currency: 'AVAX', explorerUrl: 'https://snowtrace.io' },
    { id: 5, name: 'Goerli Testnet', rpcUrl: 'https://goerli.infura.io/v3/YOUR_INFURA_API_KEY', chainId: '0x5', currency: 'GoerliETH', explorerUrl: 'https://goerli.etherscan.io' },
];

export const CONTRACT_TEMPLATES: ContractTemplate[] = [
    {
        id: 'erc20',
        name: 'ERC-20 Standard Token',
        description: 'A standard fungible token contract, compatible with all ERC-20 wallets and exchanges.',
        solidityCode: `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract MyToken is ERC20, Ownable {
    constructor(string memory name, string memory symbol)
        ERC20(name, symbol)
    {
        _mint(msg.sender, 1000000 * 10 ** decimals()); // Mint 1,000,000 tokens to deployer
    }

    function mint(address to, uint256 amount) public onlyOwner {
        _mint(to, amount);
    }
}
        `,
        tags: ['token', 'erc20', 'openzeppelin'],
        author: 'OpenZeppelin / Modified',
        version: '0.8.0'
    },
    {
        id: 'erc721',
        name: 'ERC-721 NFT',
        description: 'A standard non-fungible token contract, ideal for digital art, collectibles, and gaming items.',
        solidityCode: `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract MyNFT is ERC721, Ownable {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIdCounter;

    string private _baseTokenURI;

    constructor(string memory name, string memory symbol, string memory baseTokenURI)
        ERC721(name, symbol)
    {
        _baseTokenURI = baseTokenURI;
    }

    function _baseURI() internal view override returns (string memory) {
        return _baseTokenURI;
    }

    function safeMint(address to) public onlyOwner {
        uint256 newItemId = _tokenIdCounter.current();
        _tokenIdCounter.increment();
        _safeMint(to, newItemId);
    }
}
        `,
        tags: ['nft', 'erc721', 'openzeppelin'],
        author: 'OpenZeppelin / Modified',
        version: '0.8.0'
    },
    {
        id: 'simple-dao',
        name: 'Simple DAO Governance',
        description: 'A basic contract for decentralized autonomous organization with proposal and voting features.',
        solidityCode: `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleDAO {
    struct Proposal {
        uint id;
        string description;
        uint voteCount;
        mapping(address => bool) voted;
        bool executed;
    }

    address public owner;
    uint public nextProposalId;
    mapping(uint => Proposal) public proposals;

    constructor() {
        owner = msg.sender;
        nextProposalId = 1;
    }

    modifier onlyOwner() {
        require(msg.sender == owner, "Only owner can call this function.");
        _;
    }

    function createProposal(string memory _description) public onlyOwner {
        proposals[nextProposalId].id = nextProposalId;
        proposals[nextProposalId].description = _description;
        nextProposalId++;
    }

    function vote(uint _proposalId) public {
        Proposal storage proposal = proposals[_proposalId];
        require(!proposal.voted[msg.sender], "Already voted.");
        proposal.voted[msg.sender] = true;
        proposal.voteCount++;
    }

    function executeProposal(uint _proposalId) public onlyOwner {
        Proposal storage proposal = proposals[_proposalId];
        require(!proposal.executed, "Proposal already executed.");
        require(proposal.voteCount >= 2, "Not enough votes to execute."); // Example threshold
        proposal.executed = true;
        // In a real DAO, this would trigger an action (e.g., call another contract)
        // For simplicity, we just mark it as executed here.
    }
}
        `,
        tags: ['dao', 'governance'],
        author: 'Community',
        version: '0.8.0'
    },
    {
        id: 'multisig',
        name: 'Simple Multi-Sig Wallet',
        description: 'A basic multi-signature wallet requiring multiple owners to confirm transactions.',
        solidityCode: `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleMultiSig {
    event Deposit(address indexed sender, uint amount);
    event Submission(uint indexed transactionId);
    event Confirmation(address indexed owner, uint indexed transactionId);
    event Execution(uint indexed transactionId);

    address[] public owners;
    mapping(address => bool) public isOwner;
    uint public required;

    struct Transaction {
        address destination;
        uint value;
        bytes data;
        bool executed;
        uint numConfirmations;
    }

    Transaction[] public transactions;
    mapping(uint => mapping(address => bool)) public confirmations;

    modifier onlyOwner() {
        require(isOwner[msg.sender], "Not an owner");
        _;
    }

    modifier txExists(uint _txId) {
        require(_txId < transactions.length, "Transaction does not exist");
        _;
    }

    modifier notExecuted(uint _txId) {
        require(!transactions[_txId].executed, "Transaction already executed");
        _;
    }

    modifier notConfirmed(uint _txId) {
        require(!confirmations[_txId][msg.sender], "Transaction already confirmed");
        _;
    }

    constructor(address[] memory _owners, uint _required) {
        require(_owners.length > 0, "Owners required");
        require(_required > 0 && _required <= _owners.length, "Invalid number of required confirmations");

        for (uint i = 0; i < _owners.length; i++) {
            require(!isOwner[_owners[i]], "Owner not unique");
            isOwner[_owners[i]] = true;
            owners.push(_owners[i]);
        }
        required = _required;
    }

    receive() external payable {
        emit Deposit(msg.sender, msg.value);
    }

    function submitTransaction(
        address _destination,
        uint _value,
        bytes memory _data
    ) public onlyOwner returns (uint transactionId) {
        transactionId = transactions.length;
        transactions.push(
            Transaction({
                destination: _destination,
                value: _value,
                data: _data,
                executed: false,
                numConfirmations: 0
            })
        );
        emit Submission(transactionId);
        return transactionId;
    }

    function confirmTransaction(uint _txId)
        public
        onlyOwner
        txExists(_txId)
        notExecuted(_txId)
        notConfirmed(_txId)
    {
        confirmations[_txId][msg.sender] = true;
        transactions[_txId].numConfirmations++;
        emit Confirmation(msg.sender, _txId);

        if (transactions[_txId].numConfirmations >= required) {
            executeTransaction(_txId);
        }
    }

    function executeTransaction(uint _txId)
        public
        onlyOwner
        txExists(_txId)
        notExecuted(_txId)
    {
        Transaction storage txn = transactions[_txId];
        require(txn.numConfirmations >= required, "Cannot execute tx");
        
        txn.executed = true;
        (bool success, ) = txn.destination.call{value: txn.value}(txn.data);
        require(success, "Tx failed");
        emit Execution(_txId);
    }

    function getTransactionCount() public view returns (uint) {
        return transactions.length;
    }

    function getOwners() public view returns (address[] memory) {
        return owners;
    }
}
        `,
        tags: ['wallet', 'multisig', 'security'],
        author: 'Community',
        version: '0.8.0'
    },
];

// --- END: Mock Data and Constants ---

// --- START: Mock API / Blockchain Interaction Functions ---

// Helper to simulate async operations
export const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Mock Wallet Connection
export const mockConnectWallet = async (): Promise<WalletState> => {
    await sleep(1500); // Simulate network latency
    const randomAddress = `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}`;
    const selectedNetwork = SUPPORTED_NETWORKS[0]; // Default to first network
    return {
        isConnected: true,
        address: randomAddress,
        balance: `${(Math.random() * 100).toFixed(4)} ${selectedNetwork.currency}`,
        networkId: selectedNetwork.id,
        networkName: selectedNetwork.name,
    };
};

// Mock Wallet Disconnection
export const mockDisconnectWallet = async (): Promise<WalletState> => {
    await sleep(500);
    return {
        isConnected: false,
        address: null,
        balance: null,
        networkId: null,
        networkName: null,
    };
};

// Mock Network Switching
export const mockSwitchNetwork = async (networkId: number): Promise<WalletState> => {
    await sleep(1000);
    const network = SUPPORTED_NETWORKS.find(n => n.id === networkId);
    if (!network) throw new Error('Network not found');

    const wallet = await mockConnectWallet(); // Re-connect wallet to new network
    return {
        ...wallet,
        networkId: network.id,
        networkName: network.name,
        balance: `${(Math.random() * 100).toFixed(4)} ${network.currency}`, // Simulate new balance for new network
    };
};


// Mock Contract Compilation (simplified, assumes success)
export const mockCompileContract = async (sourceCode: string): Promise<{ bytecode: string; abi: any[] }> => {
    await sleep(2000);
    // In a real app, this would call a Solidity compiler service (e.g., Hardhat, Remix API)
    // For now, generate mock data.
    const mockBytecode = `0x${Math.random().toString(16).slice(2, 600).padStart(598, '0')}`;
    const mockABI = [{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }, { "inputs": [], "name": "myNumber", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "x", "type": "uint256" }], "name": "set", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];
    return { bytecode: mockBytecode, abi: mockABI };
};

// Mock Contract Deployment
export const mockDeployContract = async (
    network: NetworkConfig,
    deployerAddress: string,
    contractName: string,
    bytecode: string,
    abi: any[],
    constructorArgs: any[] = []
): Promise<DeployedContract> => {
    await sleep(4000); // Simulate deployment time
    const newAddress = `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}`;
    const txHash = `0x${Math.random().toString(16).slice(2, 66).padStart(64, '0')}`;

    return {
        id: `contract-${Date.now()}`,
        name: contractName,
        address: newAddress,
        abi: abi,
        bytecode: bytecode,
        deploymentTxHash: txHash,
        deployerAddress: deployerAddress,
        network: network,
        timestamp: Date.now(),
        sourceCode: `// Placeholder source for ${contractName}`, // Source would typically be stored
        version: '1.0.0'
    };
};

// Mock Interaction with a Deployed Contract (read function)
export const mockCallContractReadMethod = async (
    contract: DeployedContract,
    methodName: string,
    args: any[]
): Promise<any> => {
    await sleep(1000);
    // In a real app, this would use ethers.js/web3.js to call a view/pure function
    console.log(`Mock calling ${methodName} on ${contract.name} with args:`, args);
    const mockResponses: { [key: string]: any } = {
        'myNumber': Math.floor(Math.random() * 1000),
        'name': `${contract.name} Token`,
        'symbol': contract.name.substring(0, 3).toUpperCase(),
        'balanceOf': Math.floor(Math.random() * 1000000),
        'totalSupply': 1000000000,
        'owner': contract.deployerAddress,
        'getOwners': [contract.deployerAddress, `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}`],
        'getTransactionCount': Math.floor(Math.random() * 50),
        'proposals': { id: 1, description: "Implement feature X", voteCount: 5, executed: false },
        'default': 'Mock response for ' + methodName + '(' + args.join(', ') + ')',
    };
    return mockResponses[methodName] || mockResponses['default'];
};

// Mock Interaction with a Deployed Contract (write function)
export const mockCallContractWriteMethod = async (
    contract: DeployedContract,
    methodName: string,
    args: any[],
    fromAddress: string,
    value: string = '0'
): Promise<Transaction> => {
    await sleep(3000);
    // In a real app, this would sign and send a transaction
    console.log(`Mock calling ${methodName} on ${contract.name} with args:`, args, `from: ${fromAddress}`);
    const txHash = `0x${Math.random().toString(16).slice(2, 66).padStart(64, '0')}`;
    const gasPrice = (Math.random() * 50 + 10).toFixed(0); // 10-60 Gwei
    const gasUsed = (Math.random() * 100000 + 21000).toFixed(0);

    // Simulate success/failure
    const success = Math.random() > 0.1; // 90% success rate

    return {
        hash: txHash,
        from: fromAddress,
        to: contract.address,
        value: value,
        gasPrice: gasPrice,
        gasUsed: gasUsed,
        status: success ? 'success' : 'failed',
        timestamp: Date.now(),
        description: `Call ${methodName} on ${contract.name}`,
    };
};

// Mock Fetching Contract Events
export const mockFetchContractEvents = async (contractAddress: string, network: NetworkConfig, eventName?: string): Promise<ContractEvent[]> => {
    await sleep(2500);
    const numEvents = Math.floor(Math.random() * 5) + 2; // 2-6 events
    const events: ContractEvent[] = [];
    for (let i = 0; i < numEvents; i++) {
        events.push({
            id: `${contractAddress}-${eventName || 'All'}-${Date.now()}-${i}`,
            contractAddress: contractAddress,
            eventName: eventName || (i % 2 === 0 ? 'Transfer' : 'Approval'),
            args: { from: `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}`, to: `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}`, value: (Math.random() * 1000).toFixed(2) },
            blockNumber: Math.floor(Math.random() * 10000000) + 12000000,
            transactionHash: `0x${Math.random().toString(16).slice(2, 66).padStart(64, '0')}`,
            timestamp: Date.now() - (i * 3600000) - (Math.random() * 86400000), // Events from last few days/hours
        });
    }
    return events;
};

// Mock Staking/Unstaking
export const mockStakeTokens = async (contractAddress: string, tokenSymbol: string, amount: string, userAddress: string): Promise<StakingPosition> => {
    await sleep(3000);
    console.log(`Mock staking ${amount} ${tokenSymbol} at ${contractAddress} by ${userAddress}`);
    return {
        id: `stake-${Date.now()}`,
        contractAddress,
        tokenSymbol,
        stakedAmount: amount,
        rewardsEarned: '0.00',
        lastClaimed: Date.now(),
        apy: `${(Math.random() * 50 + 5).toFixed(2)}%`,
        userAddress,
    };
};

export const mockUnstakeTokens = async (positionId: string, amount: string): Promise<void> => {
    await sleep(2000);
    console.log(`Mock unstaking ${amount} from position ${positionId}`);
    if (Math.random() < 0.1) throw new Error("Mock Unstake failed!"); // Simulate failure
};

// Mock NFT Minting
export const mockMintNFT = async (contractAddress: string, toAddress: string, tokenURI: string, minterAddress: string): Promise<NFTAsset> => {
    await sleep(4000);
    const tokenId = Math.floor(Math.random() * 1000000).toString();
    console.log(`Mock minting NFT ${tokenId} to ${toAddress} with URI ${tokenURI}`);
    return {
        id: `nft-${Date.now()}`,
        tokenId: tokenId,
        contractAddress: contractAddress,
        name: `MyNFT #${tokenId}`,
        description: `A unique digital collectible: ${tokenURI}`,
        imageUrl: `https://ipfs.io/ipfs/QmVG...mockimage.png`, // Placeholder image
        owner: toAddress,
        mintedBy: minterAddress,
        mintTimestamp: Date.now(),
    };
};

// Mock Transaction History Fetch
export const mockFetchTransactionHistory = async (address: string, network: NetworkConfig): Promise<Transaction[]> => {
    await sleep(2000);
    const numTxs = Math.floor(Math.random() * 10) + 5;
    const transactions: Transaction[] = [];
    for (let i = 0; i < numTxs; i++) {
        const isOutbound = Math.random() > 0.5;
        transactions.push({
            hash: `0x${Math.random().toString(16).slice(2, 66).padStart(64, '0')}`,
            from: isOutbound ? address : `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}`,
            to: isOutbound ? `0x${Math.random().toString(16).slice(2, 42).padStart(40, '0')}` : address,
            value: `${(Math.random() * 0.5).toFixed(4)}`,
            gasPrice: `${(Math.random() * 50 + 10).toFixed(0)}`,
            gasUsed: `${(Math.random() * 100000 + 21000).toFixed(0)}`,
            status: Math.random() > 0.1 ? 'success' : 'failed',
            timestamp: Date.now() - (i * 120000) - (Math.random() * 300000),
            description: `Transfer ${isOutbound ? 'out' : 'in'} on ${network.name}`,
        });
    }
    return transactions.sort((a, b) => b.timestamp - a.timestamp);
};


// --- END: Mock API / Blockchain Interaction Functions ---


// --- START: AI Integration (using GoogleGenAI) ---

export const analyzeSmartContractWithAI = async (code: string): Promise<AIAuditReport> => {
    try {
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
        const prompt = `You are a smart contract security auditor. Analyze the following Solidity code for potential vulnerabilities like reentrancy, integer overflow, access control issues, front-running, denial of service, timestamp dependency, and gas inefficiencies. Also identify potential gas optimizations. Provide a comprehensive report in a structured JSON-like format or clear paragraphs, including a security score out of 100, a summary, a list of specific vulnerabilities (type, severity, description, line numbers, recommendation), and a list of gas optimizations. 

        Example format (adapt as needed for clear parsing):
        \`\`\`json
        {
          "summary": "This contract is generally secure but has minor gas inefficiencies.",
          "securityScore": 85,
          "vulnerabilities": [
            {
              "type": "Reentrancy",
              "severity": "High",
              "description": "Potential reentrancy vulnerability in the withdraw function if external calls are not handled carefully.",
              "lineNumbers": [120, 125],
              "recommendation": "Implement Checks-Effects-Interactions pattern or use reentrancy guard."
            }
          ],
          "gasOptimizations": [
            "Use calldata instead of memory for external function parameters.",
            "Cache array length in loops."
          ]
        }
        \`\`\`

        If the code is simple and has no major issues, state that. For very simple contracts, provide a minimal, accurate report.

        Code: \`\`\`solidity\n${code}\n\`\`\``;

        const response = await ai.models.generateContent({ model: 'gemini-1.5-pro', contents: [{ text: prompt }] });
        const textResponse = response.text;

        // Attempt to parse JSON from the response, if the model provides it.
        // Otherwise, fallback to a generic audit report structure.
        let report: AIAuditReport;
        try {
            const jsonMatch = textResponse.match(/```json\n([\s\S]*?)\n```/);
            if (jsonMatch && jsonMatch[1]) {
                const parsedJson = JSON.parse(jsonMatch[1]);
                report = {
                    summary: parsedJson.summary || "AI audit completed.",
                    vulnerabilities: parsedJson.vulnerabilities || [],
                    gasOptimizations: parsedJson.gasOptimizations || [],
                    securityScore: parsedJson.securityScore || 75,
                    timestamp: Date.now(),
                };
            } else {
                // Fallback if AI doesn't return perfect JSON
                report = {
                    summary: textResponse.substring(0, 500) + (textResponse.length > 500 ? "..." : ""),
                    vulnerabilities: [{ type: "General Analysis", severity: "Informational", description: textResponse, lineNumbers: [], recommendation: "Review AI output carefully." }],
                    gasOptimizations: [],
                    securityScore: Math.max(50, 100 - (textResponse.split('vulnerability').length - 1) * 10), // Heuristic
                    timestamp: Date.now(),
                };
            }
        } catch (parseError) {
            console.warn("Failed to parse AI audit report JSON, using raw text.", parseError);
            report = {
                summary: textResponse.substring(0, 500) + (textResponse.length > 500 ? "..." : ""),
                vulnerabilities: [{ type: "Parsing Error", severity: "Informational", description: `Could not parse structured report. Raw output: ${textResponse}`, lineNumbers: [], recommendation: "Review AI output carefully." }],
                gasOptimizations: [],
                securityScore: 60,
                timestamp: Date.now(),
            };
        }
        return report;

    } catch (err) {
        console.error("AI Audit Error:", err);
        return {
            summary: "Error generating audit report due to AI service issue.",
            vulnerabilities: [{ type: "Service Error", severity: "Critical", description: `AI service failed: ${err instanceof Error ? err.message : String(err)}`, lineNumbers: [], recommendation: "Check API key and try again." }],
            gasOptimizations: [],
            securityScore: 0,
            timestamp: Date.now(),
        };
    }
};


export const getAICodeSuggestion = async (
    type: 'generate' | 'explain' | 'optimize' | 'debug',
    input: string,
    context?: string
): Promise<AICodeAssistantResponse> => {
    try {
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
        let prompt = '';
        const model = 'gemini-1.5-pro'; // Or 'gemini-1.5-flash' for quicker, less detailed responses

        switch (type) {
            case 'generate':
                prompt = `You are an expert Solidity developer. Generate a Solidity smart contract for the following description: "${input}". Ensure it is secure and follows best practices. ${context ? `Additional context: ${context}` : ''} Provide only the contract code within a markdown block.`;
                break;
            case 'explain':
                prompt = `You are a smart contract expert. Explain the following Solidity code in simple terms, highlighting its purpose, main functions, and any potential security considerations. Code: \`\`\`solidity\n${input}\n\`\`\` ${context ? `Additional context: ${context}` : ''}`;
                break;
            case 'optimize':
                prompt = `You are a Solidity gas optimization expert. Analyze the following Solidity code and suggest gas optimizations. Provide the optimized code snippet if applicable, or a list of concrete recommendations. Code: \`\`\`solidity\n${input}\n\`\`\` ${context ? `Additional context: ${context}` : ''}`;
                break;
            case 'debug':
                prompt = `You are a Solidity debugger. Identify potential bugs, errors, or logical flaws in the following Solidity code and suggest fixes. Code: \`\`\`solidity\n${input}\n\`\`\` ${context ? `Additional context: ${context}` : ''}`;
                break;
            default:
                throw new Error('Unknown AI assistant type');
        }

        const response = await ai.models.generateContent({ model: model, contents: [{ text: prompt }] });
        const textResponse = response.text;

        // Extract code block if present
        const codeMatch = textResponse.match(/```solidity\n([\s\S]*?)\n```/);
        const codeContent = codeMatch && codeMatch[1] ? codeMatch[1] : textResponse;

        return {
            type,
            content: codeContent,
            suggestions: codeMatch ? undefined : textResponse.split('\n').filter(line => line.trim().length > 0 && !line.startsWith('```')), // If no code block, split into suggestions
            timestamp: Date.now(),
        };

    } catch (err) {
        console.error(`AI Code Assistant Error (${type}):`, err);
        return {
            type,
            content: `Error communicating with AI service for ${type}: ${err instanceof Error ? err.message : String(err)}`,
            timestamp: Date.now(),
        };
    }
};

// --- END: AI Integration ---


// --- START: Reusable UI Components (internal to this file for now) ---

interface CodeEditorProps {
    value: string;
    onChange: (newValue: string) => void;
    readOnly?: boolean;
    height?: string;
    placeholder?: string;
}

export const CodeEditor: React.FC<CodeEditorProps> = ({ value, onChange, readOnly = false, height = 'h-64', placeholder = 'Enter Solidity code here...' }) => {
    return (
        <textarea
            value={value}
            onChange={e => onChange(e.target.value)}
            className={`w-full ${height} bg-gray-900/50 p-3 rounded-lg text-white font-mono text-sm border border-gray-700 focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 transition-all resize-y`}
            readOnly={readOnly}
            placeholder={placeholder}
            spellCheck="false"
        />
    );
};

interface LabeledInputProps {
    label: string;
    value: string;
    onChange: (newValue: string) => void;
    placeholder?: string;
    type?: string;
    id: string;
    disabled?: boolean;
}

export const LabeledInput: React.FC<LabeledInputProps> = ({ label, value, onChange, placeholder, type = 'text', id, disabled = false }) => (
    <div className="flex flex-col space-y-1">
        <label htmlFor={id} className="text-gray-300 text-sm font-medium">{label}</label>
        <input
            id={id}
            type={type}
            value={value}
            onChange={e => onChange(e.target.value)}
            placeholder={placeholder}
            className="w-full bg-gray-900/50 p-2 rounded-lg text-white font-mono text-sm border border-gray-700 focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            disabled={disabled}
        />
    </div>
);

interface LabeledSelectProps {
    label: string;
    value: string | number;
    onChange: (newValue: string) => void;
    options: { value: string | number; label: string; }[];
    id: string;
    disabled?: boolean;
}

export const LabeledSelect: React.FC<LabeledSelectProps> = ({ label, value, onChange, options, id, disabled = false }) => (
    <div className="flex flex-col space-y-1">
        <label htmlFor={id} className="text-gray-300 text-sm font-medium">{label}</label>
        <select
            id={id}
            value={value}
            onChange={e => onChange(e.target.value)}
            className="w-full bg-gray-900/50 p-2 rounded-lg text-white font-mono text-sm border border-gray-700 focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 transition-all appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
            disabled={disabled}
        >
            {options.map(option => (
                <option key={option.value} value={option.value}>{option.label}</option>
            ))}
        </select>
    </div>
);


interface TabProps {
    label: string;
    isActive: boolean;
    onClick: () => void;
    count?: number; // Optional count for notifications, etc.
}

export const Tab: React.FC<TabProps> = ({ label, isActive, onClick, count }) => (
    <button
        onClick={onClick}
        className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 flex items-center gap-2
            ${isActive
                ? 'bg-gray-700 text-cyan-400 border-b-2 border-cyan-500'
                : 'bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 border-b border-gray-700 hover:border-gray-600'
            }`}
    >
        {label}
        {count !== undefined && count > 0 && (
            <span className="ml-1 px-2 py-0.5 text-xs font-bold bg-cyan-600 text-white rounded-full">
                {count}
            </span>
        )}
    </button>
);

interface ModalProps {
    isOpen: boolean;
    onClose: () => void;
    title: string;
    children: React.ReactNode;
    maxWidth?: string; // e.g., 'max-w-2xl', 'max-w-4xl'
}

export const Modal: React.FC<ModalProps> = ({ isOpen, onClose, title, children, maxWidth = 'max-w-2xl' }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] backdrop-blur-sm" onClick={onClose}>
            <div className={`bg-gray-800 rounded-xl shadow-3xl ${maxWidth} w-full border border-gray-700`} onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 className="text-xl font-semibold text-white">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div className="p-6 space-y-6">
                    {children}
                </div>
            </div>
        </div>
    );
};

// --- END: Reusable UI Components ---


// --- START: Main SmartContractsView Component and its Sub-Sections ---

const SmartContractsView: React.FC = () => {
    // --- Global State Management ---
    const [activeTab, setActiveTab] = useState('dashboard');
    const [wallet, setWallet] = useState<WalletState>({
        isConnected: false,
        address: null,
        balance: null,
        networkId: null,
        networkName: null,
    });
    const [currentNetwork, setCurrentNetwork] = useState<NetworkConfig>(SUPPORTED_NETWORKS[0]);
    const [deployedContracts, setDeployedContracts] = useState<DeployedContract[]>([]);
    const [transactions, setTransactions] = useState<Transaction[]>([]);
    const [isLoadingGlobal, setIsLoadingGlobal] = useState(false); // For global actions like wallet connection


    // --- AI Security Auditor State ---
    const [isAuditorOpen, setAuditorOpen] = useState(false);
    const [auditCode, setAuditCode] = useState('contract SimpleStore { uint256 public myNumber; function set(uint256 x) public { myNumber = x; } }');
    const [auditReport, setAuditReport] = useState<AIAuditReport | null>(null);
    const [isAuditing, setIsAuditing] = useState(false);

    // --- Contract Deployment State ---
    const [isDeploymentModalOpen, setDeploymentModalOpen] = useState(false);
    const [deployContractName, setDeployContractName] = useState('');
    const [deploySourceCode, setDeploySourceCode] = useState(CONTRACT_TEMPLATES[0].solidityCode);
    const [deployConstructorArgs, setDeployConstructorArgs] = useState('[]'); // JSON string
    const [isCompiling, setIsCompiling] = useState(false);
    const [isDeploying, setIsDeploying] = useState(false);
    const [compiledBytecode, setCompiledBytecode] = useState('');
    const [compiledABI, setCompiledABI] = useState<any[]>([]);
    const [deploymentError, setDeploymentError] = useState('');

    // --- Contract Interaction State ---
    const [selectedContractId, setSelectedContractId] = useState<string | null>(null);
    const selectedContract = useMemo(() => deployedContracts.find(c => c.id === selectedContractId), [selectedContractId, deployedContracts]);
    const [interactionMethod, setInteractionMethod] = useState('');
    const [interactionArgs, setInteractionArgs] = useState('[]'); // JSON string
    const [interactionResult, setInteractionResult] = useState<any>(null);
    const [isInteracting, setIsInteracting] = useState(false);
    const [interactionError, setInteractionError] = useState('');
    const [readResultLoading, setReadResultLoading] = useState(false);

    // --- Event Monitoring State ---
    const [contractEvents, setContractEvents] = useState<ContractEvent[]>([]);
    const [isFetchingEvents, setIsFetchingEvents] = useState(false);
    const [eventMonitorContractId, setEventMonitorContractId] = useState<string | null>(null);
    const eventMonitorContract = useMemo(() => deployedContracts.find(c => c.id === eventMonitorContractId), [eventMonitorContractId, deployedContracts]);


    // --- AI Code Assistant State ---
    const [isAICodeAssistantOpen, setAICodeAssistantOpen] = useState(false);
    const [aiCodeAssistantMode, setAICodeAssistantMode] = useState<'generate' | 'explain' | 'optimize' | 'debug'>('generate');
    const [aiCodeAssistantInput, setAICodeAssistantInput] = useState('');
    const [aiCodeAssistantContext, setAICodeAssistantContext] = useState('');
    const [aiCodeAssistantOutput, setAICodeAssistantOutput] = useState<AICodeAssistantResponse | null>(null);
    const [isAICodeAssistantLoading, setIsAICodeAssistantLoading] = useState(false);
    const [showCopyMessage, setShowCopyMessage] = useState(false);


    // --- Contract Templates State ---
    const [isTemplateBrowserOpen, setTemplateBrowserOpen] = useState(false);
    const [selectedTemplate, setSelectedTemplate] = useState<ContractTemplate | null>(null);
    const [templatePreviewCode, setTemplatePreviewCode] = useState('');


    // --- DeFi Tools State ---
    const [stakingPositions, setStakingPositions] = useState<StakingPosition[]>([]);
    const [isStakingLoading, setIsStakingLoading] = useState(false);
    const [stakeContractAddress, setStakeContractAddress] = useState('');
    const [stakeTokenSymbol, setStakeTokenSymbol] = useState('');
    const [stakeAmount, setStakeAmount] = useState('');
    const [unstakePositionId, setUnstakePositionId] = useState('');
    const [unstakeAmount, setUnstakeAmount] = useState('');


    // --- NFT Minting State ---
    const [nftAssets, setNftAssets] = useState<NFTAsset[]>([]);
    const [isMintingNFT, setIsMintingNFT] = useState(false);
    const [mintNFTContractAddress, setMintNFTContractAddress] = useState('');
    const [mintNFTToAddress, setMintNFTToAddress] = useState('');
    const [mintNFTTokenURI, setMintNFTTokenURI] = useState('');


    // --- Settings State ---
    const [developerMode, setDeveloperMode] = useState(false);
    const [gasPriceGwei, setGasPriceGwei] = useState('50'); // Mock setting


    // --- Effects & Callbacks ---

    // Load initial wallet state (mock)
    useEffect(() => {
        const loadWallet = async () => {
            setIsLoadingGlobal(true);
            try {
                const initialWallet = await mockConnectWallet();
                setWallet(initialWallet);
                if (initialWallet.networkId) {
                    const network = SUPPORTED_NETWORKS.find(n => n.id === initialWallet.networkId);
                    if (network) setCurrentNetwork(network);
                }
            } catch (error) {
                console.error("Failed to connect wallet on load:", error);
            } finally {
                setIsLoadingGlobal(false);
            }
        };
        loadWallet();
    }, []);

    // Fetch transactions when wallet or network changes
    useEffect(() => {
        if (wallet.isConnected && wallet.address && currentNetwork) {
            const fetchTxs = async () => {
                setIsLoadingGlobal(true);
                try {
                    const txs = await mockFetchTransactionHistory(wallet.address!, currentNetwork);
                    setTransactions(txs);
                } catch (error) {
                    console.error("Failed to fetch transactions:", error);
                } finally {
                    setIsLoadingGlobal(false);
                }
            };
            fetchTxs();
        } else {
            setTransactions([]);
        }
    }, [wallet.isConnected, wallet.address, currentNetwork]);


    // Handles wallet connection
    const handleConnectWallet = useCallback(async () => {
        setIsLoadingGlobal(true);
        try {
            const newWallet = await mockConnectWallet();
            setWallet(newWallet);
            if (newWallet.networkId) {
                const network = SUPPORTED_NETWORKS.find(n => n.id === newWallet.networkId);
                if (network) setCurrentNetwork(network);
            }
        } catch (error) {
            console.error("Wallet connection failed:", error);
            alert("Failed to connect wallet. See console for details.");
        } finally {
            setIsLoadingGlobal(false);
        }
    }, []);

    // Handles wallet disconnection
    const handleDisconnectWallet = useCallback(async () => {
        setIsLoadingGlobal(true);
        try {
            const disconnectedWallet = await mockDisconnectWallet();
            setWallet(disconnectedWallet);
        } catch (error) {
            console.error("Wallet disconnection failed:", error);
            alert("Failed to disconnect wallet. See console for details.");
        } finally {
            setIsLoadingGlobal(false);
        }
    }, []);

    // Handles network switching
    const handleNetworkChange = useCallback(async (networkId: number) => {
        if (networkId === currentNetwork.id) return;

        setIsLoadingGlobal(true);
        try {
            const newWalletState = await mockSwitchNetwork(networkId);
            setWallet(newWalletState);
            const newNetwork = SUPPORTED_NETWORKS.find(n => n.id === networkId);
            if (newNetwork) {
                setCurrentNetwork(newNetwork);
            }
        } catch (error) {
            console.error("Failed to switch network:", error);
            alert(`Failed to switch to network ID ${networkId}.`);
        } finally {
            setIsLoadingGlobal(false);
        }
    }, [currentNetwork.id]);


    // --- AI Security Auditor Handlers ---
    const handleAudit = useCallback(async () => {
        setIsAuditing(true);
        setAuditReport(null);
        try {
            const report = await analyzeSmartContractWithAI(auditCode);
            setAuditReport(report);
        } catch (err) {
            console.error("Error during AI audit:", err);
            setAuditReport({
                summary: "Error generating audit report.",
                vulnerabilities: [{ type: "Application Error", severity: "Critical", description: `An unexpected error occurred: ${err instanceof Error ? err.message : String(err)}`, lineNumbers: [], recommendation: "Try again or check network." }],
                gasOptimizations: [],
                securityScore: 0,
                timestamp: Date.now(),
            });
        } finally {
            setIsAuditing(false);
        }
    }, [auditCode]);


    // --- Contract Deployment Handlers ---
    const handleOpenDeploymentModal = useCallback(() => {
        setDeploymentModalOpen(true);
        setDeploySourceCode(CONTRACT_TEMPLATES[0].solidityCode); // Default to a template
        setDeployContractName('');
        setDeployConstructorArgs('[]');
        setCompiledBytecode('');
        setCompiledABI([]);
        setDeploymentError('');
    }, []);

    const handleCompileAndDeploy = useCallback(async () => {
        if (!wallet.isConnected || !wallet.address || !currentNetwork) {
            setDeploymentError("Please connect your wallet and select a network first.");
            return;
        }

        setDeploymentError('');
        setIsCompiling(true);
        setIsDeploying(false); // Reset deploy state

        let bytecode: string = '';
        let abi: any[] = [];

        try {
            const compilationResult = await mockCompileContract(deploySourceCode);
            bytecode = compilationResult.bytecode;
            abi = compilationResult.abi;
            setCompiledBytecode(bytecode);
            setCompiledABI(abi);
        } catch (error) {
            setDeploymentError(`Compilation failed: ${error instanceof Error ? error.message : String(error)}`);
            setIsCompiling(false);
            return;
        } finally {
            setIsCompiling(false);
        }

        setIsDeploying(true);
        try {
            const args = JSON.parse(deployConstructorArgs);
            const newContract = await mockDeployContract(
                currentNetwork,
                wallet.address,
                deployContractName || 'NewContract',
                bytecode,
                abi,
                args
            );
            setDeployedContracts(prev => [...prev, newContract]);
            setSelectedContractId(newContract.id); // Auto-select new contract for interaction
            setDeploymentModalOpen(false); // Close modal on success
            alert(`Contract "${newContract.name}" deployed successfully at ${newContract.address}!`);
        } catch (error) {
            setDeploymentError(`Deployment failed: ${error instanceof Error ? error.message : String(error)}. Ensure constructor arguments are valid JSON and match ABI.`);
        } finally {
            setIsDeploying(false);
        }
    }, [wallet, currentNetwork, deploySourceCode, deployContractName, deployConstructorArgs]);


    // --- Contract Interaction Handlers ---
    const handleInteractWithContract = useCallback(async (isReadCall: boolean) => {
        if (!selectedContract) {
            setInteractionError("No contract selected for interaction.");
            return;
        }
        if (!interactionMethod) {
            setInteractionError("No method selected.");
            return;
        }
        if (!wallet.isConnected || !wallet.address) {
            setInteractionError("Connect wallet to interact with contract.");
            return;
        }

        setInteractionError('');
        setInteractionResult(null);

        const methodABI = selectedContract.abi.find(item => item.name === interactionMethod && (item.type === 'function'));
        if (!methodABI) {
            setInteractionError("Selected method not found in contract ABI.");
            return;
        }

        let parsedArgs: any[] = [];
        try {
            parsedArgs = JSON.parse(interactionArgs);
            if (!Array.isArray(parsedArgs)) {
                throw new Error("Arguments must be a JSON array.");
            }
            // Basic type checking - ensure args length matches ABI inputs
            if (methodABI.inputs && methodABI.inputs.length !== parsedArgs.length) {
                console.warn(`Mismatch in argument count: ABI expects ${methodABI.inputs.length}, provided ${parsedArgs.length}.`);
                // This might be acceptable for some overloaded functions, but for a simple UI, it's a warning.
            }
        } catch (e) {
            setInteractionError(`Invalid arguments: ${e instanceof Error ? e.message : String(e)}`);
            return;
        }

        if (isReadCall) {
            setReadResultLoading(true);
            try {
                const result = await mockCallContractReadMethod(selectedContract, interactionMethod, parsedArgs);
                setInteractionResult(JSON.stringify(result, null, 2));
            } catch (error) {
                setInteractionError(`Read call failed: ${error instanceof Error ? error.message : String(error)}`);
            } finally {
                setReadResultLoading(false);
            }
        } else { // Write call
            setIsInteracting(true);
            try {
                const tx = await mockCallContractWriteMethod(selectedContract, interactionMethod, parsedArgs, wallet.address);
                setInteractionResult(`Transaction sent! Hash: ${tx.hash}\nStatus: ${tx.status}`);
                setTransactions(prev => [tx, ...prev]); // Add to transaction history
                alert(`Transaction for ${selectedContract.name}.${interactionMethod} ${tx.status}! Hash: ${tx.hash}`);
            } catch (error) {
                setInteractionError(`Write call failed: ${error instanceof Error ? error.message : String(error)}`);
            } finally {
                setIsInteracting(false);
            }
        }
    }, [selectedContract, interactionMethod, interactionArgs, wallet]);


    // --- Event Monitoring Handlers ---
    const handleFetchContractEvents = useCallback(async () => {
        if (!eventMonitorContract) {
            setInteractionError("No contract selected for event monitoring."); // Reuse interactionError for simplicity
            return;
        }
        setIsFetchingEvents(true);
        setContractEvents([]);
        try {
            const events = await mockFetchContractEvents(eventMonitorContract.address, eventMonitorContract.network);
            setContractEvents(events);
        } catch (error) {
            console.error("Failed to fetch events:", error);
            alert(`Failed to fetch events: ${error instanceof Error ? error.message : String(error)}`);
        } finally {
            setIsFetchingEvents(false);
        }
    }, [eventMonitorContract]);

    // --- AI Code Assistant Handlers ---
    const handleAICodeAssistant = useCallback(async () => {
        if (!aiCodeAssistantInput.trim()) {
            alert('Please provide input for the AI assistant.');
            return;
        }
        setIsAICodeAssistantLoading(true);
        setAICodeAssistantOutput(null);
        try {
            const response = await getAICodeSuggestion(aiCodeAssistantMode, aiCodeAssistantInput, aiCodeAssistantContext);
            setAICodeAssistantOutput(response);
        } catch (error) {
            console.error("AI Code Assistant Error:", error);
            setAICodeAssistantOutput({
                type: aiCodeAssistantMode,
                content: `An error occurred: ${error instanceof Error ? error.message : String(error)}`,
                timestamp: Date.now(),
            });
        } finally {
            setIsAICodeAssistantLoading(false);
        }
    }, [aiCodeAssistantMode, aiCodeAssistantInput, aiCodeAssistantContext]);

    const handleCopyAICodeOutput = useCallback(() => {
        if (aiCodeAssistantOutput?.content) {
            navigator.clipboard.writeText(aiCodeAssistantOutput.content);
            setShowCopyMessage(true);
            setTimeout(() => setShowCopyMessage(false), 2000);
        }
    }, [aiCodeAssistantOutput]);

    // --- Template Browser Handlers ---
    const handleSelectTemplate = useCallback((template: ContractTemplate) => {
        setSelectedTemplate(template);
        setTemplatePreviewCode(template.solidityCode);
    }, []);

    const handleApplyTemplate = useCallback(() => {
        if (selectedTemplate) {
            setDeploySourceCode(selectedTemplate.solidityCode);
            setDeployContractName(selectedTemplate.name.replace(/[^a-zA-Z0-9]/g, '')); // Basic sanitization
            setTemplateBrowserOpen(false);
            setDeploymentModalOpen(true); // Open deployment modal with pre-filled code
            setSelectedTemplate(null); // Clear selected template
        }
    }, [selectedTemplate]);


    // --- DeFi Tools Handlers ---
    const handleStakeTokens = useCallback(async () => {
        if (!wallet.isConnected || !wallet.address || !stakeContractAddress || !stakeTokenSymbol || !stakeAmount) {
            alert('Please connect wallet and fill all staking fields.');
            return;
        }
        setIsStakingLoading(true);
        try {
            const newPosition = await mockStakeTokens(stakeContractAddress, stakeTokenSymbol, stakeAmount, wallet.address);
            setStakingPositions(prev => [...prev, newPosition]);
            alert(`Staked ${newPosition.stakedAmount} ${newPosition.tokenSymbol}!`);
            // Reset fields
            setStakeContractAddress('');
            setStakeTokenSymbol('');
            setStakeAmount('');
        } catch (error) {
            console.error("Staking failed:", error);
            alert(`Staking failed: ${error instanceof Error ? error.message : String(error)}`);
        } finally {
            setIsStakingLoading(false);
        }
    }, [wallet, stakeContractAddress, stakeTokenSymbol, stakeAmount]);

    const handleUnstakeTokens = useCallback(async () => {
        if (!unstakePositionId || !unstakeAmount) {
            alert('Please select a position and enter amount to unstake.');
            return;
        }
        setIsStakingLoading(true);
        try {
            await mockUnstakeTokens(unstakePositionId, unstakeAmount);
            setStakingPositions(prev => prev.filter(pos => pos.id !== unstakePositionId)); // Remove for simplicity
            alert(`Successfully unstaked from position ${unstakePositionId}!`);
            // Reset fields
            setUnstakePositionId('');
            setUnstakeAmount('');
        } catch (error) {
            console.error("Unstaking failed:", error);
            alert(`Unstaking failed: ${error instanceof Error ? error.message : String(error)}`);
        } finally {
            setIsStakingLoading(false);
        }
    }, [unstakePositionId, unstakeAmount]);


    // --- NFT Minting Handlers ---
    const handleMintNFT = useCallback(async () => {
        if (!wallet.isConnected || !wallet.address || !mintNFTContractAddress || !mintNFTToAddress || !mintNFTTokenURI) {
            alert('Please connect wallet and fill all NFT minting fields.');
            return;
        }
        setIsMintingNFT(true);
        try {
            const newNFT = await mockMintNFT(mintNFTContractAddress, mintNFTToAddress, mintNFTTokenURI, wallet.address);
            setNftAssets(prev => [...prev, newNFT]);
            alert(`Successfully minted NFT #${newNFT.tokenId} to ${newNFT.owner}!`);
            // Reset fields
            setMintNFTContractAddress('');
            setMintNFTToAddress('');
            setMintNFTTokenURI('');
        } catch (error) {
            console.error("NFT Minting failed:", error);
            alert(`NFT Minting failed: ${error instanceof Error ? error.message : String(error)}`);
        } finally {
            setIsMintingNFT(false);
        }
    }, [wallet, mintNFTContractAddress, mintNFTToAddress, mintNFTTokenURI]);


    // --- Render Logic ---

    // Filter available methods for interaction based on selected contract ABI
    const availableMethods = useMemo(() => {
        if (!selectedContract) return [];
        return selectedContract.abi
            .filter(item => item.type === 'function')
            .map(item => ({
                value: item.name,
                label: `${item.name}(${item.inputs.map((input: any) => `${input.type} ${input.name}`).join(', ')}) - ${item.stateMutability}`
            }));
    }, [selectedContract]);

    const currentMethodABI = useMemo(() => {
        if (!selectedContract || !interactionMethod) return null;
        return selectedContract.abi.find(item => item.name === interactionMethod && item.type === 'function');
    }, [selectedContract, interactionMethod]);


    return (
        <>
            <div className="space-y-6">
                <div className="flex justify-between items-center flex-wrap gap-4">
                    <h2 className="text-4xl font-extrabold text-white tracking-tight">Smart Contract Workbench</h2>
                    <div className="flex items-center space-x-3">
                        <LabeledSelect
                            id="network-selector"
                            label="Network"
                            value={currentNetwork.id}
                            onChange={(value) => handleNetworkChange(Number(value))}
                            options={SUPPORTED_NETWORKS.map(net => ({ value: net.id, label: net.name }))}
                            disabled={isLoadingGlobal}
                        />
                        {wallet.isConnected ? (
                            <button
                                onClick={handleDisconnectWallet}
                                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                disabled={isLoadingGlobal}
                            >
                                Disconnect Wallet ({wallet.address?.substring(0, 6)}...)
                            </button>
                        ) : (
                            <button
                                onClick={handleConnectWallet}
                                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors disabled:opacity-50"
                                disabled={isLoadingGlobal}
                            >
                                Connect Wallet
                            </button>
                        )}
                        <button onClick={() => setAuditorOpen(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium transition-colors">AI Security Auditor</button>
                    </div>
                </div>

                {wallet.isConnected && (
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                        <Card title="Wallet Address" className="bg-gray-800/50">
                            <span className="font-mono text-cyan-400 text-sm">{wallet.address}</span>
                        </Card>
                        <Card title="Balance" className="bg-gray-800/50">
                            <span className="font-bold text-green-400 text-lg">{wallet.balance || '0.00 ETH'}</span>
                        </Card>
                        <Card title="Connected Network" className="bg-gray-800/50">
                            <span className="font-semibold text-white text-md">{wallet.networkName} (ID: {wallet.networkId})</span>
                        </Card>
                        <Card title="Active Contracts" className="bg-gray-800/50">
                            <span className="font-bold text-purple-400 text-lg">{deployedContracts.length}</span>
                        </Card>
                    </div>
                )}


                {/* Tab Navigation */}
                <div className="flex border-b border-gray-700 overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <Tab label="Dashboard" isActive={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                    <Tab label="Deploy & Manage" isActive={activeTab === 'deploy'} onClick={() => setActiveTab('deploy')} count={deployedContracts.length} />
                    <Tab label="Interact" isActive={activeTab === 'interact'} onClick={() => setActiveTab('interact')} />
                    <Tab label="Monitor" isActive={activeTab === 'monitor'} onClick={() => setActiveTab('monitor')} count={contractEvents.length > 0 || transactions.length > 0 ? (contractEvents.length + transactions.length) : undefined} />
                    <Tab label="AI Tools" isActive={activeTab === 'ai-tools'} onClick={() => setActiveTab('ai-tools')} />
                    <Tab label="Templates" isActive={activeTab === 'templates'} onClick={() => setTemplateBrowserOpen(true)} />
                    <Tab label="DeFi Tools" isActive={activeTab === 'defi'} onClick={() => setActiveTab('defi')} />
                    <Tab label="NFT Tools" isActive={activeTab === 'nft'} onClick={() => setActiveTab('nft')} />
                    <Tab label="Settings" isActive={activeTab === 'settings'} onClick={() => setActiveTab('settings')} />
                </div>

                {/* Tab Content */}
                <div className="py-6 space-y-6">
                    {activeTab === 'dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <Card title="Recent Transactions" className="col-span-1 md:col-span-2">
                                {transactions.length === 0 ? (
                                    <p className="text-gray-400">No recent transactions found.</p>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full text-sm text-left text-gray-400">
                                            <thead className="text-xs text-gray-200 uppercase bg-gray-700">
                                                <tr>
                                                    <th scope="col" className="px-4 py-2">Hash</th>
                                                    <th scope="col" className="px-4 py-2">Type</th>
                                                    <th scope="col" className="px-4 py-2">Value</th>
                                                    <th scope="col" className="px-4 py-2">Status</th>
                                                    <th scope="col" className="px-4 py-2">Time</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {transactions.slice(0, 5).map(tx => (
                                                    <tr key={tx.hash} className="border-b border-gray-700 hover:bg-gray-800">
                                                        <td className="px-4 py-2 font-mono text-xs"><a href={`${currentNetwork.explorerUrl}/tx/${tx.hash}`} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">{tx.hash.substring(0, 10)}...</a></td>
                                                        <td className="px-4 py-2">{tx.from === wallet.address ? 'Outgoing' : 'Incoming'}</td>
                                                        <td className="px-4 py-2">{tx.value} {currentNetwork.currency}</td>
                                                        <td className="px-4 py-2">
                                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tx.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                {tx.status}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-2">{new Date(tx.timestamp).toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </Card>

                            <Card title="Deployed Contracts Overview">
                                <ul className="space-y-2 text-sm text-gray-300">
                                    {deployedContracts.length === 0 ? (
                                        <li className="text-gray-400">No contracts deployed yet.</li>
                                    ) : (
                                        deployedContracts.slice(0, 5).map(contract => (
                                            <li key={contract.id} className="flex justify-between items-center p-2 bg-gray-900/40 rounded-lg">
                                                <span className="font-semibold text-white">{contract.name}</span>
                                                <span className="font-mono text-cyan-300 text-xs">{contract.address.substring(0, 10)}...</span>
                                            </li>
                                        ))
                                    )}
                                </ul>
                                {deployedContracts.length > 5 && (
                                    <button onClick={() => setActiveTab('deploy')} className="mt-4 text-cyan-500 hover:text-cyan-400 text-sm">View all contracts &rarr;</button>
                                )}
                            </Card>

                            <Card title="Quick Actions" className="lg:col-span-3">
                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                    <button onClick={handleOpenDeploymentModal} className="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">Deploy New Contract</button>
                                    <button onClick={() => setAuditorOpen(true)} className="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors">AI Security Audit</button>
                                    <button onClick={() => { setAICodeAssistantOpen(true); setAICodeAssistantMode('generate'); }} className="w-full px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors">AI Code Generator</button>
                                    <button onClick={() => setActiveTab('defi')} className="w-full px-4 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium transition-colors">Explore DeFi Tools</button>
                                </div>
                            </Card>
                        </div>
                    )}

                    {activeTab === 'deploy' && (
                        <div className="space-y-8">
                            <Card title="Deployed Smart Contracts">
                                {deployedContracts.length === 0 ? (
                                    <div className="text-center py-8">
                                        <p className="text-gray-400 text-lg mb-4">No contracts deployed yet. Get started by deploying one!</p>
                                        <button onClick={handleOpenDeploymentModal} className="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-md font-medium transition-colors">
                                            Deploy Your First Contract
                                        </button>
                                        <p className="mt-4 text-gray-500 text-sm">Or explore <button onClick={() => setTemplateBrowserOpen(true)} className="text-cyan-500 hover:text-cyan-400 underline">Contract Templates</button></p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full text-sm text-left text-gray-400">
                                            <thead className="text-xs text-gray-200 uppercase bg-gray-700">
                                                <tr>
                                                    <th scope="col" className="px-4 py-2">Name</th>
                                                    <th scope="col" className="px-4 py-2">Address</th>
                                                    <th scope="col" className="px-4 py-2">Network</th>
                                                    <th scope="col" className="px-4 py-2">Deployer</th>
                                                    <th scope="col" className="px-4 py-2">Deployed On</th>
                                                    <th scope="col" className="px-4 py-2">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {deployedContracts.map(contract => (
                                                    <tr key={contract.id} className="border-b border-gray-700 hover:bg-gray-800">
                                                        <td className="px-4 py-2 font-semibold text-white">{contract.name}</td>
                                                        <td className="px-4 py-2 font-mono text-xs text-cyan-400">
                                                            <a href={`${contract.network.explorerUrl}/address/${contract.address}`} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                                                {contract.address.substring(0, 10)}...{contract.address.slice(-8)}
                                                            </a>
                                                        </td>
                                                        <td className="px-4 py-2">{contract.network.name}</td>
                                                        <td className="px-4 py-2 font-mono text-xs">{contract.deployerAddress.substring(0, 6)}...</td>
                                                        <td className="px-4 py-2 text-xs">{new Date(contract.timestamp).toLocaleString()}</td>
                                                        <td className="px-4 py-2 flex space-x-2">
                                                            <button
                                                                onClick={() => { setSelectedContractId(contract.id); setActiveTab('interact'); }}
                                                                className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded transition-colors"
                                                            >
                                                                Interact
                                                            </button>
                                                            <button
                                                                onClick={() => { setEventMonitorContractId(contract.id); setActiveTab('monitor'); handleFetchContractEvents(); }}
                                                                className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded transition-colors"
                                                            >
                                                                Monitor
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </Card>

                            <button onClick={handleOpenDeploymentModal} className="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-md font-medium transition-colors flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Deploy New Contract
                            </button>
                        </div>
                    )}

                    {activeTab === 'interact' && (
                        <div className="space-y-6">
                            <Card title="Interact with Smart Contract">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <LabeledSelect
                                        id="select-contract-to-interact"
                                        label="Select Deployed Contract"
                                        value={selectedContractId || ''}
                                        onChange={setSelectedContractId}
                                        options={[
                                            { value: '', label: '--- Select a contract ---' },
                                            ...deployedContracts.map(c => ({ value: c.id, label: `${c.name} (${c.address.substring(0, 6)}...)` }))
                                        ]}
                                        disabled={deployedContracts.length === 0}
                                    />
                                    <LabeledSelect
                                        id="select-method-to-call"
                                        label="Select Method"
                                        value={interactionMethod}
                                        onChange={setInteractionMethod}
                                        options={[
                                            { value: '', label: '--- Select a method ---' },
                                            ...availableMethods
                                        ]}
                                        disabled={!selectedContract}
                                    />
                                </div>

                                {selectedContract && interactionMethod && currentMethodABI && (
                                    <div className="mt-6 space-y-4">
                                        <LabeledInput
                                            id="interaction-args"
                                            label={`Arguments (JSON array for: ${currentMethodABI.inputs.map((input: any) => input.name || `arg${input.type}`).join(', ')})`}
                                            value={interactionArgs}
                                            onChange={setInteractionArgs}
                                            placeholder='e.g., ["value1", 123, true]'
                                            type="text"
                                        />

                                        {currentMethodABI.stateMutability === 'payable' && (
                                            <LabeledInput
                                                id="interaction-value"
                                                label={`Value (in ${currentNetwork.currency})`}
                                                value={'0'} // TODO: Add a state for this
                                                onChange={() => {}} // TODO: Implement value
                                                placeholder='e.g., 0.1'
                                                type="number"
                                            />
                                        )}

                                        <div className="flex gap-4 pt-2">
                                            {['view', 'pure'].includes(currentMethodABI.stateMutability) ? (
                                                <button
                                                    onClick={() => handleInteractWithContract(true)}
                                                    className="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                                    disabled={isInteracting || readResultLoading || !wallet.isConnected}
                                                >
                                                    {readResultLoading ? 'Reading...' : 'Read Contract State'}
                                                </button>
                                            ) : (
                                                <button
                                                    onClick={() => handleInteractWithContract(false)}
                                                    className="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                                    disabled={isInteracting || readResultLoading || !wallet.isConnected}
                                                >
                                                    {isInteracting ? 'Sending Transaction...' : 'Execute Transaction'}
                                                </button>
                                            )}
                                        </div>

                                        {interactionError && (
                                            <p className="text-red-400 text-sm bg-red-900/30 p-3 rounded-lg border border-red-800">Error: {interactionError}</p>
                                        )}

                                        {interactionResult && (
                                            <Card title="Interaction Result">
                                                <pre className="whitespace-pre-wrap text-sm font-mono bg-gray-900/50 p-3 rounded-lg text-cyan-300 overflow-x-auto min-h-[5rem]">
                                                    {interactionResult}
                                                </pre>
                                            </Card>
                                        )}
                                    </div>
                                )}
                                {!selectedContract && (
                                    <p className="text-gray-500 text-center py-4">Select a contract from your deployed list to interact.</p>
                                )}
                            </Card>
                        </div>
                    )}

                    {activeTab === 'monitor' && (
                        <div className="space-y-6">
                            <Card title="Contract Event Monitor">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <LabeledSelect
                                        id="select-contract-to-monitor"
                                        label="Select Deployed Contract"
                                        value={eventMonitorContractId || ''}
                                        onChange={setEventMonitorContractId}
                                        options={[
                                            { value: '', label: '--- Select a contract ---' },
                                            ...deployedContracts.map(c => ({ value: c.id, label: `${c.name} (${c.address.substring(0, 6)}...)` }))
                                        ]}
                                        disabled={deployedContracts.length === 0 || isFetchingEvents}
                                    />
                                    <button
                                        onClick={handleFetchContractEvents}
                                        className="mt-7 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                        disabled={!eventMonitorContract || isFetchingEvents}
                                    >
                                        {isFetchingEvents ? 'Fetching Events...' : 'Fetch Events'}
                                    </button>
                                </div>
                                <div className="mt-6">
                                    {eventMonitorContract && contractEvents.length === 0 && !isFetchingEvents ? (
                                        <p className="text-gray-400 text-center py-4">No events found for this contract.</p>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full text-sm text-left text-gray-400">
                                                <thead className="text-xs text-gray-200 uppercase bg-gray-700">
                                                    <tr>
                                                        <th scope="col" className="px-4 py-2">Event Name</th>
                                                        <th scope="col" className="px-4 py-2">Args</th>
                                                        <th scope="col" className="px-4 py-2">Block</th>
                                                        <th scope="col" className="px-4 py-2">Tx Hash</th>
                                                        <th scope="col" className="px-4 py-2">Timestamp</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {contractEvents.map(event => (
                                                        <tr key={event.id} className="border-b border-gray-700 hover:bg-gray-800">
                                                            <td className="px-4 py-2 font-semibold text-white">{event.eventName}</td>
                                                            <td className="px-4 py-2 font-mono text-xs">{JSON.stringify(event.args, null, 2)}</td>
                                                            <td className="px-4 py-2">{event.blockNumber}</td>
                                                            <td className="px-4 py-2 font-mono text-xs"><a href={`${currentNetwork.explorerUrl}/tx/${event.transactionHash}`} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">{event.transactionHash.substring(0, 10)}...</a></td>
                                                            <td className="px-4 py-2 text-xs">{new Date(event.timestamp).toLocaleString()}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                            </Card>

                            <Card title="Transaction History">
                                {transactions.length === 0 ? (
                                    <p className="text-gray-400 text-center py-4">No transactions found for the connected wallet.</p>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full text-sm text-left text-gray-400">
                                            <thead className="text-xs text-gray-200 uppercase bg-gray-700">
                                                <tr>
                                                    <th scope="col" className="px-4 py-2">Hash</th>
                                                    <th scope="col" className="px-4 py-2">From</th>
                                                    <th scope="col" className="px-4 py-2">To</th>
                                                    <th scope="col" className="px-4 py-2">Value</th>
                                                    <th scope="col" className="px-4 py-2">Status</th>
                                                    <th scope="col" className="px-4 py-2">Time</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {transactions.map(tx => (
                                                    <tr key={tx.hash} className="border-b border-gray-700 hover:bg-gray-800">
                                                        <td className="px-4 py-2 font-mono text-xs"><a href={`${currentNetwork.explorerUrl}/tx/${tx.hash}`} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">{tx.hash.substring(0, 10)}...</a></td>
                                                        <td className="px-4 py-2 font-mono text-xs">{tx.from.substring(0, 6)}...</td>
                                                        <td className="px-4 py-2 font-mono text-xs">{tx.to.substring(0, 6)}...</td>
                                                        <td className="px-4 py-2">{tx.value} {currentNetwork.currency}</td>
                                                        <td className="px-4 py-2">
                                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tx.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                {tx.status}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-2 text-xs">{new Date(tx.timestamp).toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </Card>
                        </div>
                    )}

                    {activeTab === 'ai-tools' && (
                        <div className="space-y-6">
                            <Card title="AI Code Assistant">
                                <div className="flex space-x-2 border-b border-gray-700 mb-4">
                                    <button
                                        className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${aiCodeAssistantMode === 'generate' ? 'bg-gray-700 text-cyan-400 border-b-2 border-cyan-500' : 'bg-gray-800 text-gray-400 hover:text-white'}`}
                                        onClick={() => setAICodeAssistantMode('generate')}
                                    >
                                        Generate Code
                                    </button>
                                    <button
                                        className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${aiCodeAssistantMode === 'explain' ? 'bg-gray-700 text-cyan-400 border-b-2 border-cyan-500' : 'bg-gray-800 text-gray-400 hover:text-white'}`}
                                        onClick={() => setAICodeAssistantMode('explain')}
                                    >
                                        Explain Code
                                    </button>
                                    <button
                                        className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${aiCodeAssistantMode === 'optimize' ? 'bg-gray-700 text-cyan-400 border-b-2 border-cyan-500' : 'bg-gray-800 text-gray-400 hover:text-white'}`}
                                        onClick={() => setAICodeAssistantMode('optimize')}
                                    >
                                        Optimize Code
                                    </button>
                                    <button
                                        className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 ${aiCodeAssistantMode === 'debug' ? 'bg-gray-700 text-cyan-400 border-b-2 border-cyan-500' : 'bg-gray-800 text-gray-400 hover:text-white'}`}
                                        onClick={() => setAICodeAssistantMode('debug')}
                                    >
                                        Debug Code
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    {aiCodeAssistantMode === 'generate' ? (
                                        <LabeledInput
                                            id="ai-generate-input"
                                            label="Describe the contract you want to generate"
                                            value={aiCodeAssistantInput}
                                            onChange={setAICodeAssistantInput}
                                            placeholder="e.g., An ERC-20 token with a fixed supply and a burn function."
                                        />
                                    ) : (
                                        <div className="flex flex-col space-y-1">
                                            <label htmlFor="ai-code-input" className="text-gray-300 text-sm font-medium">Solidity Code Input</label>
                                            <CodeEditor
                                                value={aiCodeAssistantInput}
                                                onChange={setAICodeAssistantInput}
                                                height="h-40"
                                                placeholder="Paste your Solidity code here..."
                                            />
                                        </div>
                                    )}

                                    <div className="flex flex-col space-y-1">
                                        <label htmlFor="ai-context-input" className="text-gray-300 text-sm font-medium">Additional Context (Optional)</label>
                                        <textarea
                                            id="ai-context-input"
                                            value={aiCodeAssistantContext}
                                            onChange={e => setAICodeAssistantContext(e.target.value)}
                                            className="w-full h-24 bg-gray-900/50 p-2 rounded-lg text-white font-mono text-sm border border-gray-700 focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 transition-all resize-y"
                                            placeholder="Any specific requirements, constraints, or areas to focus on."
                                        />
                                    </div>

                                    <button
                                        onClick={handleAICodeAssistant}
                                        className="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                        disabled={isAICodeAssistantLoading || !aiCodeAssistantInput.trim()}
                                    >
                                        {isAICodeAssistantLoading ? `Processing ${aiCodeAssistantMode}...` : `Get AI ${aiCodeAssistantMode} Suggestion`}
                                    </button>

                                    {aiCodeAssistantOutput && (
                                        <Card title="AI Output">
                                            <div className="relative">
                                                <CodeEditor
                                                    value={aiCodeAssistantOutput.content}
                                                    readOnly
                                                    height="h-64"
                                                    placeholder="AI generated content will appear here..."
                                                />
                                                <button
                                                    onClick={handleCopyAICodeOutput}
                                                    className="absolute top-3 right-3 p-2 bg-gray-700/80 hover:bg-gray-600 rounded-lg text-white text-sm"
                                                >
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-4 0a2 2 0 01-2 2H8a2 2 0 01-2-2"></path></svg>
                                                </button>
                                                {showCopyMessage && (
                                                    <span className="absolute top-10 right-20 bg-green-500 text-white text-xs px-2 py-1 rounded-md">Copied!</span>
                                                )}
                                            </div>
                                            {aiCodeAssistantOutput.suggestions && aiCodeAssistantOutput.suggestions.length > 0 && (
                                                <div className="mt-4">
                                                    <h4 className="text-md font-semibold text-white mb-2">Suggestions:</h4>
                                                    <ul className="list-disc list-inside text-sm text-gray-300 space-y-1">
                                                        {aiCodeAssistantOutput.suggestions.map((s, idx) => <li key={idx}>{s}</li>)}
                                                    </ul>
                                                </div>
                                            )}
                                        </Card>
                                    )}
                                </div>
                            </Card>
                        </div>
                    )}

                    {activeTab === 'defi' && (
                        <div className="space-y-6">
                            <Card title="DeFi Staking Tools">
                                <h3 className="text-xl font-semibold text-white mb-4">Stake Tokens</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <LabeledInput
                                        id="stake-contract-address"
                                        label="Staking Contract Address"
                                        value={stakeContractAddress}
                                        onChange={setStakeContractAddress}
                                        placeholder="0x..."
                                        disabled={isStakingLoading || !wallet.isConnected}
                                    />
                                    <LabeledInput
                                        id="stake-token-symbol"
                                        label="Token Symbol (e.g., USDC, DAI)"
                                        value={stakeTokenSymbol}
                                        onChange={setStakeTokenSymbol}
                                        placeholder="USDC"
                                        disabled={isStakingLoading || !wallet.isConnected}
                                    />
                                    <LabeledInput
                                        id="stake-amount"
                                        label="Amount to Stake"
                                        value={stakeAmount}
                                        onChange={setStakeAmount}
                                        type="number"
                                        placeholder="100.0"
                                        disabled={isStakingLoading || !wallet.isConnected}
                                    />
                                    <button
                                        onClick={handleStakeTokens}
                                        className="mt-7 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                        disabled={isStakingLoading || !wallet.isConnected || !stakeContractAddress || !stakeTokenSymbol || !stakeAmount}
                                    >
                                        {isStakingLoading ? 'Staking...' : 'Stake Tokens'}
                                    </button>
                                </div>

                                <h3 className="text-xl font-semibold text-white mt-8 mb-4">Your Staking Positions</h3>
                                {stakingPositions.length === 0 ? (
                                    <p className="text-gray-400">No active staking positions.</p>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full text-sm text-left text-gray-400">
                                            <thead className="text-xs text-gray-200 uppercase bg-gray-700">
                                                <tr>
                                                    <th scope="col" className="px-4 py-2">Contract</th>
                                                    <th scope="col" className="px-4 py-2">Token</th>
                                                    <th scope="col" className="px-4 py-2">Amount</th>
                                                    <th scope="col" className="px-4 py-2">APY</th>
                                                    <th scope="col" className="px-4 py-2">Rewards</th>
                                                    <th scope="col" className="px-4 py-2">Last Claimed</th>
                                                    <th scope="col" className="px-4 py-2">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {stakingPositions.map(pos => (
                                                    <tr key={pos.id} className="border-b border-gray-700 hover:bg-gray-800">
                                                        <td className="px-4 py-2 font-mono text-xs">{pos.contractAddress.substring(0, 10)}...</td>
                                                        <td className="px-4 py-2">{pos.tokenSymbol}</td>
                                                        <td className="px-4 py-2 font-bold text-white">{pos.stakedAmount}</td>
                                                        <td className="px-4 py-2 text-green-400">{pos.apy}</td>
                                                        <td className="px-4 py-2 text-yellow-400">{pos.rewardsEarned}</td>
                                                        <td className="px-4 py-2 text-xs">{new Date(pos.lastClaimed).toLocaleString()}</td>
                                                        <td className="px-4 py-2">
                                                            <button
                                                                onClick={() => { setUnstakePositionId(pos.id); setUnstakeAmount(pos.stakedAmount); }}
                                                                className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded transition-colors"
                                                            >
                                                                Unstake
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}

                                {stakingPositions.length > 0 && (
                                    <div className="mt-8 pt-6 border-t border-gray-700 space-y-4">
                                        <h3 className="text-xl font-semibold text-white">Unstake Tokens</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <LabeledSelect
                                                id="unstake-position-id"
                                                label="Select Position to Unstake From"
                                                value={unstakePositionId}
                                                onChange={setUnstakePositionId}
                                                options={[
                                                    { value: '', label: '--- Select a position ---' },
                                                    ...stakingPositions.map(pos => ({ value: pos.id, label: `${pos.tokenSymbol} - ${pos.stakedAmount} staked` }))
                                                ]}
                                                disabled={isStakingLoading || !wallet.isConnected}
                                            />
                                            <LabeledInput
                                                id="unstake-amount"
                                                label="Amount to Unstake"
                                                value={unstakeAmount}
                                                onChange={setUnstakeAmount}
                                                type="number"
                                                placeholder="Amount from position"
                                                disabled={isStakingLoading || !wallet.isConnected}
                                            />
                                            <button
                                                onClick={handleUnstakeTokens}
                                                className="md:col-span-2 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                                disabled={isStakingLoading || !wallet.isConnected || !unstakePositionId || !unstakeAmount}
                                            >
                                                {isStakingLoading ? 'Unstaking...' : 'Unstake Selected'}
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </Card>
                        </div>
                    )}

                    {activeTab === 'nft' && (
                        <div className="space-y-6">
                            <Card title="NFT Minting & Management">
                                <h3 className="text-xl font-semibold text-white mb-4">Mint New NFT</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <LabeledInput
                                        id="mint-nft-contract-address"
                                        label="NFT Contract Address (ERC-721)"
                                        value={mintNFTContractAddress}
                                        onChange={setMintNFTContractAddress}
                                        placeholder="0x..."
                                        disabled={isMintingNFT || !wallet.isConnected}
                                    />
                                    <LabeledInput
                                        id="mint-nft-to-address"
                                        label="Recipient Address"
                                        value={mintNFTToAddress}
                                        onChange={setMintNFTToAddress}
                                        placeholder="0x..."
                                        disabled={isMintingNFT || !wallet.isConnected}
                                    />
                                    <LabeledInput
                                        id="mint-nft-token-uri"
                                        label="Token URI (IPFS link to metadata)"
                                        value={mintNFTTokenURI}
                                        onChange={setMintNFTTokenURI}
                                        placeholder="ipfs://Qm..."
                                        disabled={isMintingNFT || !wallet.isConnected}
                                    />
                                    <button
                                        onClick={handleMintNFT}
                                        className="mt-7 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                                        disabled={isMintingNFT || !wallet.isConnected || !mintNFTContractAddress || !mintNFTToAddress || !mintNFTTokenURI}
                                    >
                                        {isMintingNFT ? 'Minting NFT...' : 'Mint NFT'}
                                    </button>
                                </div>

                                <h3 className="text-xl font-semibold text-white mt-8 mb-4">Your NFT Assets</h3>
                                {nftAssets.length === 0 ? (
                                    <p className="text-gray-400">No NFT assets found for your wallet.</p>
                                ) : (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                        {nftAssets.map(nft => (
                                            <Card key={nft.id} title={nft.name} className="relative group overflow-hidden">
                                                <img src={nft.imageUrl} alt={nft.name} className="w-full h-48 object-cover rounded-md mb-3" />
                                                <p className="text-sm text-gray-300 font-semibold">{nft.description.substring(0, 50)}...</p>
                                                <p className="text-xs text-gray-500 mt-1">Token ID: <span className="font-mono text-cyan-400">{nft.tokenId}</span></p>
                                                <p className="text-xs text-gray-500">Owner: <span className="font-mono text-gray-300">{nft.owner.substring(0, 8)}...</span></p>
                                                <div className="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity duration-300">
                                                    <button className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium text-sm">View Details</button>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                )}
                            </Card>
                        </div>
                    )}

                    {activeTab === 'settings' && (
                        <div className="space-y-6">
                            <Card title="Application Settings">
                                <div className="space-y-4">
                                    <div className="flex items-center justify-between p-3 bg-gray-900/50 rounded-lg">
                                        <label htmlFor="developer-mode-toggle" className="text-gray-300 font-medium">Developer Mode</label>
                                        <label className="relative inline-flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                id="developer-mode-toggle"
                                                className="sr-only peer"
                                                checked={developerMode}
                                                onChange={(e) => setDeveloperMode(e.target.checked)}
                                            />
                                            <div className="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                                            <span className="ml-3 text-sm font-medium text-gray-300">{developerMode ? 'Enabled' : 'Disabled'}</span>
                                        </label>
                                    </div>

                                    <LabeledInput
                                        id="gas-price-gwei"
                                        label="Default Gas Price (Gwei)"
                                        type="number"
                                        value={gasPriceGwei}
                                        onChange={setGasPriceGwei}
                                        placeholder="50"
                                        disabled={!developerMode}
                                    />

                                    <div className="p-3 bg-gray-900/50 rounded-lg">
                                        <h4 className="text-white text-md mb-2">Data Management</h4>
                                        <p className="text-sm text-gray-400 mb-3">Clear all locally stored application data, including deployed contracts and transaction history.</p>
                                        <button
                                            onClick={() => {
                                                if (window.confirm("Are you sure you want to clear all local data? This action cannot be undone.")) {
                                                    setDeployedContracts([]);
                                                    setTransactions([]);
                                                    setStakingPositions([]);
                                                    setNftAssets([]);
                                                    setContractEvents([]);
                                                    setSelectedContractId(null);
                                                    setAuditReport(null);
                                                    setAICodeAssistantOutput(null);
                                                    alert('All local data cleared!');
                                                }
                                            }}
                                            className="px-4 py-2 bg-red-700 hover:bg-red-800 text-white rounded-lg text-sm font-medium"
                                        >
                                            Clear All Local Data
                                        </button>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            </div>

            {/* AI Security Auditor Modal */}
            <Modal
                isOpen={isAuditorOpen}
                onClose={() => setAuditorOpen(false)}
                title="AI Smart Contract Security Auditor"
                maxWidth="max-w-4xl"
            >
                <div className="space-y-4">
                    <div className="flex flex-col space-y-1">
                        <label htmlFor="auditor-code" className="text-gray-300 text-sm font-medium">Solidity Code to Audit</label>
                        <CodeEditor
                            value={auditCode}
                            onChange={setAuditCode}
                            height="h-64"
                            placeholder="Paste your Solidity code here for AI analysis..."
                        />
                    </div>
                    <button
                        onClick={handleAudit}
                        disabled={isAuditing || !auditCode.trim()}
                        className="w-full py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        {isAuditing ? 'Auditing...' : 'Audit Code with AI'}
                    </button>
                    <Card title="Audit Report">
                        <div className="min-h-[10rem] text-sm text-gray-300 whitespace-pre-line bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                            {isAuditing ? (
                                <p className="text-center text-cyan-400">Analyzing code for vulnerabilities and optimizations...</p>
                            ) : auditReport ? (
                                <div className="space-y-4">
                                    <h4 className="text-lg font-semibold text-white">Summary: <span className="font-normal text-gray-300">{auditReport.summary}</span></h4>
                                    <p className="text-md font-semibold text-white">Security Score: <span className={`font-bold ${auditReport.securityScore > 80 ? 'text-green-400' : auditReport.securityScore > 60 ? 'text-yellow-400' : 'text-red-400'}`}>{auditReport.securityScore}/100</span></p>

                                    {auditReport.vulnerabilities.length > 0 && (
                                        <div>
                                            <h5 className="text-lg font-semibold text-white">Potential Vulnerabilities:</h5>
                                            <ul className="list-disc list-inside space-y-2 mt-2">
                                                {auditReport.vulnerabilities.map((vuln, index) => (
                                                    <li key={index} className="bg-gray-700/30 p-3 rounded-lg">
                                                        <p className={`font-semibold ${vuln.severity === 'Critical' ? 'text-red-400' : vuln.severity === 'High' ? 'text-orange-400' : vuln.severity === 'Medium' ? 'text-yellow-400' : 'text-white'}`}>
                                                            {vuln.type} (Severity: {vuln.severity})
                                                        </p>
                                                        <p className="text-sm text-gray-300">{vuln.description}</p>
                                                        {vuln.lineNumbers && vuln.lineNumbers.length > 0 && (
                                                            <p className="text-xs text-gray-400">Lines: {vuln.lineNumbers.join(', ')}</p>
                                                        )}
                                                        <p className="text-sm text-cyan-400 mt-1">Recommendation: {vuln.recommendation}</p>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}

                                    {auditReport.gasOptimizations.length > 0 && (
                                        <div>
                                            <h5 className="text-lg font-semibold text-white mt-4">Gas Optimizations:</h5>
                                            <ul className="list-disc list-inside space-y-1 mt-2">
                                                {auditReport.gasOptimizations.map((opt, index) => (
                                                    <li key={index} className="text-sm text-gray-300 bg-gray-700/30 p-2 rounded-lg">{opt}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                    <p className="text-xs text-gray-500 mt-4">Report generated on: {new Date(auditReport.timestamp).toLocaleString()}</p>
                                </div>
                            ) : (
                                <p className="text-gray-500">The audit report will appear here after analysis.</p>
                            )}
                        </div>
                    </Card>
                </div>
            </Modal>

            {/* Deploy New Contract Modal */}
            <Modal
                isOpen={isDeploymentModalOpen}
                onClose={() => setDeploymentModalOpen(false)}
                title="Deploy New Smart Contract"
                maxWidth="max-w-4xl"
            >
                <div className="space-y-4">
                    <LabeledInput
                        id="deploy-contract-name"
                        label="Contract Name"
                        value={deployContractName}
                        onChange={setDeployContractName}
                        placeholder="MyAwesomeContract"
                    />
                    <div className="flex flex-col space-y-1">
                        <label htmlFor="deploy-source-code" className="text-gray-300 text-sm font-medium">Solidity Source Code</label>
                        <CodeEditor
                            value={deploySourceCode}
                            onChange={setDeploySourceCode}
                            height="h-72"
                            placeholder="Paste your Solidity code here..."
                        />
                    </div>
                    <LabeledInput
                        id="deploy-constructor-args"
                        label="Constructor Arguments (JSON array)"
                        value={deployConstructorArgs}
                        onChange={setDeployConstructorArgs}
                        placeholder='e.g., ["MyToken", "MTK", 1000]'
                    />

                    {deploymentError && (
                        <p className="text-red-400 text-sm bg-red-900/30 p-3 rounded-lg border border-red-800">Deployment Error: {deploymentError}</p>
                    )}

                    <button
                        onClick={handleCompileAndDeploy}
                        disabled={isCompiling || isDeploying || !deploySourceCode.trim() || !wallet.isConnected}
                        className="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        {isCompiling ? 'Compiling...' : isDeploying ? 'Deploying...' : 'Compile & Deploy Contract'}
                    </button>
                    {!wallet.isConnected && <p className="text-red-400 text-sm text-center">Connect your wallet to deploy contracts.</p>}

                    {compiledABI.length > 0 && (
                        <Card title="Compiled ABI (JSON)" className="max-h-64 overflow-y-auto">
                            <pre className="text-xs text-gray-300 font-mono whitespace-pre-wrap">{JSON.stringify(compiledABI, null, 2)}</pre>
                        </Card>
                    )}
                    {compiledBytecode && (
                        <Card title="Compiled Bytecode" className="max-h-64 overflow-y-auto">
                            <pre className="text-xs text-gray-300 font-mono break-all">{compiledBytecode}</pre>
                        </Card>
                    )}
                </div>
            </Modal>

            {/* Contract Templates Browser Modal */}
            <Modal
                isOpen={isTemplateBrowserOpen}
                onClose={() => { setTemplateBrowserOpen(false); setSelectedTemplate(null); setTemplatePreviewCode(''); }}
                title="Browse Smart Contract Templates"
                maxWidth="max-w-6xl"
            >
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-4">
                        <h3 className="text-xl font-semibold text-white">Available Templates</h3>
                        <div className="space-y-3 max-h-[600px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800">
                            {CONTRACT_TEMPLATES.map(template => (
                                <button
                                    key={template.id}
                                    onClick={() => handleSelectTemplate(template)}
                                    className={`w-full text-left p-4 rounded-lg border transition-all duration-200
                                        ${selectedTemplate?.id === template.id
                                            ? 'bg-cyan-900/40 border-cyan-500 ring-1 ring-cyan-500'
                                            : 'bg-gray-800/50 border-gray-700 hover:bg-gray-700/60'
                                        }`}
                                >
                                    <h4 className="text-lg font-semibold text-white">{template.name}</h4>
                                    <p className="text-sm text-gray-400 mt-1">{template.description}</p>
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {template.tags.map(tag => (
                                            <span key={tag} className="px-2 py-0.5 bg-gray-700 text-gray-300 text-xs rounded-full">{tag}</span>
                                        ))}
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div>
                        <h3 className="text-xl font-semibold text-white">Template Preview</h3>
                        {selectedTemplate ? (
                            <div className="mt-4 space-y-4">
                                <Card title={selectedTemplate.name}>
                                    <p className="text-gray-300 text-sm mb-2">{selectedTemplate.description}</p>
                                    <p className="text-gray-400 text-xs">Author: {selectedTemplate.author} | Version: {selectedTemplate.version}</p>
                                </Card>
                                <CodeEditor
                                    value={templatePreviewCode}
                                    readOnly
                                    height="h-72"
                                />
                                <button
                                    onClick={handleApplyTemplate}
                                    className="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-50 transition-colors"
                                    disabled={!selectedTemplate}
                                >
                                    Use This Template for Deployment
                                </button>
                            </div>
                        ) : (
                            <p className="text-gray-500 mt-4 text-center py-10">Select a template from the list to view its code and details.</p>
                        )}
                    </div>
                </div>
            </Modal>
        </>
    );
};

export default SmartContractsView;

--- FILE: TokenIssuanceView.tsx ---

import React, { useState, useEffect, useCallback, createContext, useContext } from 'react';
import Card from '../../../Card';
import { GoogleGenAI, Type } from "@google/genai";
import { FaDollarSign, FaEthereum, FaClock, FaExchangeAlt, FaBurn, FaPlayCircle, FaPauseCircle, FaGraduationCap, FaNetworkWired, FaCode, FaChartLine, FaCloudDownloadAlt, FaFileCode, FaLock, FaGlobe, FaCogs, FaProjectDiagram, FaBalanceScale, FaUsers, FaHandshake, FaChartBar, FaWallet, FaSpinner, FaCheckCircle, FaTimesCircle, FaExclamationTriangle, FaBell } from 'react-icons/fa';

// --- Shared Types and Interfaces ---

export interface TokenConfig {
    id: string; // Unique ID for this token configuration
    name: string;
    symbol: string;
    description: string;
    type: 'ERC-20' | 'ERC-721' | 'ERC-1155' | 'Custom';
    totalSupply: number;
    decimals: number;
    initialSupply?: number; // For ERC-20, if different from total supply initially minted
    contractURI?: string; // For ERC-721/1155 metadata
    baseTokenURI?: string;
    logoUrl?: string;
    websiteUrl?: string;
    socialLinks: { twitter?: string; telegram?: string; discord?: string; github?: string; };
    features: {
        mintable: boolean;
        burnable: boolean;
        pausable: boolean;
        upgradable: boolean; // ERC-1967 Proxy
        snapshots: boolean;
        permit: boolean; // EIP-2612
        flashMint?: boolean; // ERC-3156
        erc1363?: boolean; // ERC-1363 payable token
        governanceModule?: boolean; // Placeholder for integration with governance contracts
    };
    aiGeneratedNotes?: string;
}

export type AllocationType = 'Team' | 'Investors (Seed)' | 'Investors (Private)' | 'Investors (Public)' | 'Ecosystem' | 'Treasury' | 'Advisors' | 'Marketing' | 'Liquidity' | 'Staking Rewards' | 'Community' | 'Airdrop';

export interface VestingSchedule {
    id: string; // Unique ID for this vesting schedule
    amount: number;
    cliff: number; // In months
    duration: number; // Total vesting duration in months
    releaseFrequency: 'monthly' | 'quarterly' | 'daily' | 'linear';
    startDate: string; // YYYY-MM-DD
    recipientAddresses: string[];
    description?: string;
}

export interface TokenAllocation {
    type: AllocationType;
    percentage: number;
    amount: number; // Calculated based on total supply
    vestingSchedule?: VestingSchedule;
    isLocked?: boolean; // If allocated tokens are initially locked without a vesting schedule
    lockUntil?: string; // YYYY-MM-DD
    details?: string;
}

export interface NetworkConfig {
    id: string;
    name: string;
    chainId: number;
    rpcUrl: string;
    blockExplorerUrl: string;
    isCustom?: boolean;
}

export interface DeploymentConfig {
    network: NetworkConfig;
    ownerAddress: string;
    gasPriceStrategy: 'standard' | 'fast' | 'custom';
    customGasPriceGwei?: number;
    frontRunProtection: boolean;
    proxyAdminAddress?: string; // For upgradable contracts
    salt?: string; // For create2 deployments
}

export interface DeploymentStatus {
    id: string;
    timestamp: string;
    status: 'pending' | 'deploying' | 'verifying' | 'completed' | 'failed';
    transactionHash?: string;
    contractAddress?: string;
    blockNumber?: number;
    error?: string;
    networkId: string;
    tokenConfigId: string;
}

export interface AirdropCampaign {
    id: string;
    name: string;
    tokenAddress: string;
    snapshotBlockNumber?: number;
    recipients: { address: string; amount: number; }[];
    totalAirdropAmount: number;
    status: 'draft' | 'scheduled' | 'active' | 'completed' | 'cancelled';
    scheduleDate?: string; // YYYY-MM-DD
    transactionHash?: string;
    description?: string;
    proofGenerationType: 'merkleTree' | 'directTransfer';
}

export interface GovernanceProposal {
    id: string;
    title: string;
    description: string;
    proposer: string;
    status: 'pending' | 'active' | 'executed' | 'defeated' | 'cancelled';
    startTime: string;
    endTime: string;
    snapshotBlock: number;
    quorum: number; // percentage
    threshold: number; // percentage
    votesFor: number;
    votesAgainst: number;
    votesAbstain: number;
    executedTransaction?: string;
}

export interface TokenSupplyMetric {
    date: string; // YYYY-MM-DD
    circulatingSupply: number;
    totalSupply: number;
    lockedSupply: number;
    burnedSupply: number;
}

// --- Context for Global State Management ---
interface TokenIssuanceContextType {
    currentTokenConfig: TokenConfig | null;
    setCurrentTokenConfig: React.Dispatch<React.SetStateAction<TokenConfig | null>>;
    tokenAllocations: TokenAllocation[];
    setTokenAllocations: React.Dispatch<React.SetStateAction<TokenAllocation[]>>;
    deploymentConfigs: DeploymentConfig[];
    setDeploymentConfigs: React.Dispatch<React.SetStateAction<DeploymentConfig[]>>;
    deploymentHistory: DeploymentStatus[];
    setDeploymentHistory: React.Dispatch<React.SetStateAction<DeploymentStatus[]>>;
    aiGeneratedTokenomics: any | null;
    setAiGeneratedTokenomics: React.Dispatch<React.SetStateAction<any | null>>;
    activeAirdropCampaigns: AirdropCampaign[];
    setActiveAirdropCampaigns: React.Dispatch<React.SetStateAction<AirdropCampaign[]>>;
    activeGovernanceProposals: GovernanceProposal[];
    setActiveGovernanceProposals: React.Dispatch<React.SetStateAction<GovernanceProposal[]>>;
    availableNetworks: NetworkConfig[];
    addCustomNetwork: (network: NetworkConfig) => void;
    showNotification: (message: string, type: 'success' | 'error' | 'info' | 'warning') => void;
}

const TokenIssuanceContext = createContext<TokenIssuanceContextType | undefined>(undefined);

export const useTokenIssuance = () => {
    const context = useContext(TokenIssuanceContext);
    if (!context) {
        throw new Error('useTokenIssuance must be used within a TokenIssuanceProvider');
    }
    return context;
};

export const TokenIssuanceProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [currentTokenConfig, setCurrentTokenConfig] = useState<TokenConfig | null>(null);
    const [tokenAllocations, setTokenAllocations] = useState<TokenAllocation[]>([]);
    const [deploymentConfigs, setDeploymentConfigs] = useState<DeploymentConfig[]>([]);
    const [deploymentHistory, setDeploymentHistory] = useState<DeploymentStatus[]>([]);
    const [aiGeneratedTokenomics, setAiGeneratedTokenomics] = useState<any>(null);
    const [activeAirdropCampaigns, setActiveAirdropCampaigns] = useState<AirdropCampaign[]>([]);
    const [activeGovernanceProposals, setActiveGovernanceProposals] = useState<GovernanceProposal[]>([]);
    const [notifications, setNotifications] = useState<{ id: string; message: string; type: 'success' | 'error' | 'info' | 'warning'; }[]>([]);

    const initialNetworks: NetworkConfig[] = [
        { id: 'eth-mainnet', name: 'Ethereum Mainnet', chainId: 1, rpcUrl: 'https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID', blockExplorerUrl: 'https://etherscan.io' },
        { id: 'goerli', name: 'Goerli Testnet', chainId: 5, rpcUrl: 'https://goerli.infura.io/v3/YOUR_INFURA_PROJECT_ID', blockExplorerUrl: 'https://goerli.etherscan.io' },
        { id: 'sepolia', name: 'Sepolia Testnet', chainId: 11155111, rpcUrl: 'https://sepolia.infura.io/v3/YOUR_INFURA_PROJECT_ID', blockExplorerUrl: 'https://sepolia.etherscan.io' },
        { id: 'polygon-mainnet', name: 'Polygon Mainnet', chainId: 137, rpcUrl: 'https://polygon-rpc.com', blockExplorerUrl: 'https://polygonscan.com' },
        { id: 'mumbai', name: 'Polygon Mumbai Testnet', chainId: 80001, rpcUrl: 'https://rpc-mumbai.maticvigil.com', blockExplorerUrl: 'https://mumbai.polygonscan.com' },
        // Add more networks as needed
    ];
    const [availableNetworks, setAvailableNetworks] = useState<NetworkConfig[]>(initialNetworks);

    const addCustomNetwork = useCallback((network: NetworkConfig) => {
        setAvailableNetworks(prev => [...prev, { ...network, isCustom: true }]);
        showNotification(`Custom network ${network.name} added!`, 'success');
    }, []);

    const showNotification = useCallback((message: string, type: 'success' | 'error' | 'info' | 'warning') => {
        const id = Date.now().toString();
        setNotifications(prev => [...prev, { id, message, type }]);
        setTimeout(() => {
            setNotifications(prev => prev.filter(n => n.id !== id));
        }, 5000);
    }, []);

    // Simulate loading existing data from a backend
    useEffect(() => {
        // NOTE: This is a simulated backend call
        const loadInitialData = async () => {
            await new Promise(resolve => setTimeout(resolve, 500)); // Simulate API delay
            // setCurrentTokenConfig(...);
            // setTokenAllocations(...);
            // setDeploymentHistory(...);
            // setAiGeneratedTokenomics(...);
        };
        loadInitialData();
    }, []);

    return (
        <TokenIssuanceContext.Provider
            value={{
                currentTokenConfig, setCurrentTokenConfig,
                tokenAllocations, setTokenAllocations,
                deploymentConfigs, setDeploymentConfigs,
                deploymentHistory, setDeploymentHistory,
                aiGeneratedTokenomics, setAiGeneratedTokenomics,
                activeAirdropCampaigns, setActiveAirdropCampaigns,
                activeGovernanceProposals, setActiveGovernanceProposals,
                availableNetworks, addCustomNetwork,
                showNotification,
            }}
        >
            {children}
            {/* Notification system display */}
            <div className="fixed bottom-4 right-4 z-[100] space-y-2">
                {notifications.map(note => (
                    <div key={note.id} className={`p-4 rounded-lg shadow-lg flex items-center space-x-3 
                        ${note.type === 'success' ? 'bg-green-600 text-white' : ''}
                        ${note.type === 'error' ? 'bg-red-600 text-white' : ''}
                        ${note.type === 'info' ? 'bg-blue-600 text-white' : ''}
                        ${note.type === 'warning' ? 'bg-yellow-600 text-white' : ''}
                    `}>
                        {note.type === 'success' && <FaCheckCircle className="text-xl" />}
                        {note.type === 'error' && <FaTimesCircle className="text-xl" />}
                        {note.type === 'info' && <FaBell className="text-xl" />}
                        {note.type === 'warning' && <FaExclamationTriangle className="text-xl" />}
                        <span>{note.message}</span>
                    </div>
                ))}
            </div>
        </TokenIssuanceContext.Provider>
    );
};

// --- Utility Components and Functions ---

export const ExportedProgressBar: React.FC<{ steps: string[]; currentStep: number }> = ({ steps, currentStep }) => {
    return (
        <div className="flex justify-between items-center w-full py-4">
            {steps.map((step, index) => (
                <div key={step} className="flex flex-col items-center flex-1">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm
                        ${index <= currentStep ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-400'}
                    `}>
                        {index + 1}
                    </div>
                    <span className={`mt-2 text-xs text-center ${index <= currentStep ? 'text-white' : 'text-gray-500'}`}>
                        {step}
                    </span>
                    {index < steps.length - 1 && (
                        <div className={`absolute left-0 right-0 h-1 bg-gray-700 top-1/2 -z-10 mx-2
                            ${index < currentStep ? 'bg-cyan-600' : 'bg-gray-700'}
                        `} style={{ width: `calc(100% / ${steps.length} - 1rem)` }}></div>
                    )}
                </div>
            ))}
        </div>
    );
};

export const ExportedTooltip: React.FC<{ content: string; children: React.ReactNode }> = ({ content, children }) => {
    return (
        <div className="relative flex items-center group">
            {children}
            <div className="absolute left-1/2 transform -translate-x-1/2 bottom-full mb-2 w-max p-2 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50">
                {content}
            </div>
        </div>
    );
};

export const ExportedSpinner: React.FC = () => (
    <div className="flex items-center justify-center">
        <FaSpinner className="animate-spin text-cyan-500 text-2xl" />
    </div>
);

export const ExportedChart: React.FC<{ title: string; data: { label: string; value: number; color: string }[]; type?: 'pie' | 'bar' | 'line'; }> = ({ title, data, type = 'pie' }) => {
    // This is a simplified chart visualization. In a real app, you'd use a charting library like Chart.js or Recharts.
    const total = data.reduce((acc, item) => acc + item.value, 0);

    return (
        <Card title={title}>
            <div className="relative w-full h-48 flex items-center justify-center">
                {type === 'pie' && (
                    <div className="relative w-32 h-32 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-xs">
                        {/* Simplified pie chart visual */}
                        <div className="absolute inset-0 rounded-full" style={{
                            background: `conic-gradient(
                                ${data.map((item, i) => `${item.color} 0 ${data.slice(0, i + 1).reduce((sum, d) => sum + d.value, 0) / total * 360}deg`).join(', ')}
                            )`
                        }}></div>
                        <span className="z-10 bg-gray-800 p-2 rounded-full">{(total).toFixed(0)}</span>
                    </div>
                )}
                {type === 'bar' && (
                    <div className="flex w-full h-full space-x-2 items-end">
                        {data.map((item, index) => (
                            <div key={index} className="flex flex-col items-center h-full justify-end flex-1">
                                <div className="w-8 rounded-t-md" style={{ height: `${(item.value / Math.max(...data.map(d => d.value))) * 100}%`, backgroundColor: item.color }}></div>
                                <span className="text-xs text-gray-400 mt-1">{item.label}</span>
                            </div>
                        ))}
                    </div>
                )}
                {type === 'line' && (
                    <div className="relative w-full h-full">
                        {/* Placeholder for line chart */}
                        <svg className="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <polyline
                                fill="none"
                                stroke="url(#gradient)"
                                strokeWidth="1"
                                points={data.map((item, i) => `${(i / (data.length - 1)) * 100},${100 - (item.value / Math.max(...data.map(d => d.value))) * 100}`).join(' ')}
                            />
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                {data.map((item, i) => (
                                    <stop key={i} offset={`${(i / (data.length - 1)) * 100}%`} stopColor={item.color} />
                                ))}
                            </linearGradient>
                        </svg>
                        <div className="absolute bottom-0 left-0 w-full h-1 bg-gray-700"></div>
                        <div className="absolute left-0 top-0 h-full w-1 bg-gray-700"></div>
                    </div>
                )}
            </div>
            <div className="mt-4 space-y-2">
                {data.map((item, index) => (
                    <div key={index} className="flex items-center justify-between text-sm text-gray-300">
                        <div className="flex items-center space-x-2">
                            <span className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }}></span>
                            <span>{item.label}</span>
                        </div>
                        <span>{item.value.toLocaleString()} ({((item.value / total) * 100).toFixed(2)}%)</span>
                    </div>
                ))}
            </div>
        </Card>
    );
};


export const ExportedInput: React.FC<React.InputHTMLAttributes<HTMLInputElement> & { label: string; error?: string; icon?: React.ReactNode; }> = ({ label, error, icon, ...props }) => (
    <div className="space-y-1">
        <label className="text-sm font-medium text-gray-300 flex items-center space-x-2">
            {icon && <span>{icon}</span>}
            <span>{label}</span>
        </label>
        <div className="relative">
            <input
                {...props}
                className={`w-full p-2 bg-gray-700/50 rounded text-white border ${error ? 'border-red-500' : 'border-gray-700'} focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 outline-none ${props.disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
            />
            {error && <p className="mt-1 text-xs text-red-500">{error}</p>}
        </div>
    </div>
);

export const ExportedTextArea: React.FC<React.TextareaHTMLAttributes<HTMLTextAreaElement> & { label: string; error?: string; }> = ({ label, error, ...props }) => (
    <div className="space-y-1">
        <label className="text-sm font-medium text-gray-300">{label}</label>
        <textarea
            {...props}
            className={`w-full p-2 bg-gray-700/50 rounded text-white border ${error ? 'border-red-500' : 'border-gray-700'} focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 outline-none resize-y ${props.disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
        />
        {error && <p className="mt-1 text-xs text-red-500">{error}</p>}
    </div>
);

export const ExportedSelect: React.FC<React.SelectHTMLAttributes<HTMLSelectElement> & { label: string; options: { value: string; label: string; }[]; error?: string; }> = ({ label, options, error, ...props }) => (
    <div className="space-y-1">
        <label className="text-sm font-medium text-gray-300">{label}</label>
        <select
            {...props}
            className={`w-full p-2 bg-gray-700/50 rounded text-white border ${error ? 'border-red-500' : 'border-gray-700'} focus:ring-1 focus:ring-cyan-500 focus:border-cyan-500 outline-none ${props.disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
        >
            {options.map(option => (
                <option key={option.value} value={option.value}>{option.label}</option>
            ))}
        </select>
        {error && <p className="mt-1 text-xs text-red-500">{error}</p>}
    </div>
);

export const ExportedCheckbox: React.FC<React.InputHTMLAttributes<HTMLInputElement> & { label: string; }> = ({ label, ...props }) => (
    <label className="flex items-center space-x-2 text-gray-300 cursor-pointer">
        <input type="checkbox" {...props} className="form-checkbox h-4 w-4 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500" />
        <span className="text-sm">{label}</span>
    </label>
);

export const ExportedButton: React.FC<React.ButtonHTMLAttributes<HTMLButtonElement> & { variant?: 'primary' | 'secondary' | 'danger'; loading?: boolean; icon?: React.ReactNode; }> = ({ children, variant = 'primary', loading, icon, ...props }) => {
    const baseClasses = "px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center space-x-2";
    let variantClasses = "";
    switch (variant) {
        case 'primary':
            variantClasses = "bg-cyan-600 hover:bg-cyan-700 text-white";
            break;
        case 'secondary':
            variantClasses = "bg-gray-700 hover:bg-gray-600 text-gray-300 border border-gray-600";
            break;
        case 'danger':
            variantClasses = "bg-red-600 hover:bg-red-700 text-white";
            break;
    }
    return (
        <button
            {...props}
            className={`${baseClasses} ${variantClasses} ${props.disabled || loading ? 'opacity-50 cursor-not-allowed' : ''}`}
            disabled={props.disabled || loading}
        >
            {loading && <FaSpinner className="animate-spin" />}
            {icon && !loading && <span>{icon}</span>}
            <span>{children}</span>
        </button>
    );
};

// --- Step 1: Token Definition Form ---

export const ExportedTokenDefinitionForm: React.FC<{ onNext: () => void }> = ({ onNext }) => {
    const { currentTokenConfig, setCurrentTokenConfig, aiGeneratedTokenomics, showNotification } = useTokenIssuance();

    const [formState, setFormState] = useState<TokenConfig>(currentTokenConfig || {
        id: 'new-token-' + Date.now(),
        name: '',
        symbol: '',
        description: '',
        type: 'ERC-20',
        totalSupply: 0,
        decimals: 18,
        socialLinks: {},
        features: {
            mintable: false,
            burnable: true,
            pausable: false,
            upgradable: false,
            snapshots: false,
            permit: false,
        },
    });

    const [errors, setErrors] = useState<Record<string, string>>({});

    useEffect(() => {
        if (aiGeneratedTokenomics && !currentTokenConfig) {
            setFormState(prev => ({
                ...prev,
                name: aiGeneratedTokenomics.name || prev.name,
                symbol: aiGeneratedTokenomics.symbol || prev.symbol,
                totalSupply: aiGeneratedTokenomics.totalSupply || prev.totalSupply,
                description: aiGeneratedTokenomics.description || prev.description,
                aiGeneratedNotes: JSON.stringify(aiGeneratedTokenomics, null, 2),
            }));
            showNotification('Token details pre-filled by AI!', 'info');
        }
    }, [aiGeneratedTokenomics, currentTokenConfig, showNotification]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormState(prev => ({ ...prev, [name]: value }));
        setErrors(prev => ({ ...prev, [name]: '' }));
    };

    const handleFeatureChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, checked } = e.target;
        setFormState(prev => ({
            ...prev,
            features: { ...prev.features, [name]: checked }
        }));
    };

    const handleSocialLinkChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setFormState(prev => ({
            ...prev,
            socialLinks: { ...prev.socialLinks, [name]: value }
        }));
    };

    const validateForm = () => {
        const newErrors: Record<string, string> = {};
        if (!formState.name.trim()) newErrors.name = 'Token name is required.';
        if (!formState.symbol.trim()) newErrors.symbol = 'Token symbol is required.';
        if (!/^[A-Z0-9]{2,10}$/.test(formState.symbol.trim())) newErrors.symbol = 'Symbol must be 2-10 uppercase alphanumeric characters.';
        if (formState.totalSupply <= 0) newErrors.totalSupply = 'Total supply must be greater than 0.';
        if (formState.decimals < 0 || formState.decimals > 18) newErrors.decimals = 'Decimals must be between 0 and 18.';
        if (!formState.description.trim()) newErrors.description = 'Description is required.';

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (validateForm()) {
            setCurrentTokenConfig(formState);
            showNotification('Token definition saved successfully!', 'success');
            onNext();
        } else {
            showNotification('Please correct the errors in the form.', 'error');
        }
    };

    return (
        <Card title="1. Define Your Token" icon={<FaDollarSign />}>
            <form onSubmit={handleSubmit} className="space-y-6">
                <ExportedInput
                    label="Token Name"
                    name="name"
                    value={formState.name}
                    onChange={handleChange}
                    placeholder="e.g., MegaCorp Utility Token"
                    error={errors.name}
                    icon={<FaDollarSign />}
                />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ExportedInput
                        label="Token Symbol"
                        name="symbol"
                        value={formState.symbol}
                        onChange={handleChange}
                        placeholder="e.g., MCT"
                        error={errors.symbol}
                        icon={<FaExchangeAlt />}
                    />
                    <ExportedSelect
                        label="Token Type"
                        name="type"
                        value={formState.type}
                        onChange={handleChange}
                        options={[
                            { value: 'ERC-20', label: 'ERC-20 (Fungible Token)' },
                            { value: 'ERC-721', label: 'ERC-721 (Non-Fungible Token - NFT)' },
                            { value: 'ERC-1155', label: 'ERC-1155 (Multi-Token Standard)' },
                            { value: 'Custom', label: 'Custom Standard' },
                        ]}
                        icon={<FaCode />}
                    />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {formState.type === 'ERC-20' && (
                        <>
                            <ExportedInput
                                label="Total Supply"
                                name="totalSupply"
                                type="number"
                                value={formState.totalSupply === 0 ? '' : formState.totalSupply}
                                onChange={handleChange}
                                placeholder="e.g., 100000000"
                                error={errors.totalSupply}
                                icon={<FaChartBar />}
                            />
                            <ExportedInput
                                label="Decimals"
                                name="decimals"
                                type="number"
                                value={formState.decimals}
                                onChange={handleChange}
                                placeholder="e.g., 18"
                                error={errors.decimals}
                                icon={<FaBalanceScale />}
                            />
                        </>
                    )}
                    {(formState.type === 'ERC-721' || formState.type === 'ERC-1155') && (
                        <ExportedInput
                            label="Base URI (for Metadata)"
                            name="baseTokenURI"
                            value={formState.baseTokenURI || ''}
                            onChange={handleChange}
                            placeholder="e.g., https://api.megacorp.com/tokens/"
                            icon={<FaCloudDownloadAlt />}
                        />
                    )}
                </div>
                <ExportedTextArea
                    label="Token Description"
                    name="description"
                    value={formState.description}
                    onChange={handleChange}
                    rows={4}
                    placeholder="Provide a detailed description of your token, its utility, and purpose."
                    error={errors.description}
                />
                <ExportedInput
                    label="Token Logo URL"
                    name="logoUrl"
                    type="url"
                    value={formState.logoUrl || ''}
                    onChange={handleChange}
                    placeholder="e.g., https://assets.megacorp.com/mct-logo.png"
                    icon={<FaGlobe />}
                />
                <ExportedInput
                    label="Official Website URL"
                    name="websiteUrl"
                    type="url"
                    value={formState.websiteUrl || ''}
                    onChange={handleChange}
                    placeholder="e.g., https://megacorp.com"
                    icon={<FaGlobe />}
                />

                <h3 className="text-lg font-semibold text-white mt-8 mb-4">Social Media Links</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ExportedInput label="Twitter URL" name="twitter" type="url" value={formState.socialLinks.twitter || ''} onChange={handleSocialLinkChange} placeholder="e.g., https://twitter.com/megacorp" />
                    <ExportedInput label="Telegram URL" name="telegram" type="url" value={formState.socialLinks.telegram || ''} onChange={handleSocialLinkChange} placeholder="e.g., https://t.me/megacorp_official" />
                    <ExportedInput label="Discord URL" name="discord" type="url" value={formState.socialLinks.discord || ''} onChange={handleSocialLinkChange} placeholder="e.g., https://discord.gg/megacorp" />
                    <ExportedInput label="GitHub URL" name="github" type="url" value={formState.socialLinks.github || ''} onChange={handleSocialLinkChange} placeholder="e.g., https://github.com/megacorp" />
                </div>

                <h3 className="text-lg font-semibold text-white mt-8 mb-4">Advanced Features (ERC-20 only)</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Allow new tokens to be created after initial deployment.">Mintable</ExportedTooltip>}
                        name="mintable"
                        checked={formState.features.mintable}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Allow tokens to be removed from circulation permanently.">Burnable</ExportedTooltip>}
                        name="burnable"
                        checked={formState.features.burnable}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Allow pausing and unpausing of all token transfers and approvals. Useful for emergencies.">Pausable</ExportedTooltip>}
                        name="pausable"
                        checked={formState.features.pausable}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Enable the contract to be upgraded in the future, typically via an ERC-1967 Proxy.">Upgradable (Proxy)</ExportedTooltip>}
                        name="upgradable"
                        checked={formState.features.upgradable}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Allow tracking of historical balances at specific block numbers. Useful for governance or airdrops.">Snapshots</ExportedTooltip>}
                        name="snapshots"
                        checked={formState.features.snapshots}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Enable gasless approvals for ERC-20 tokens using signed messages (EIP-2612).">Permit (EIP-2612)</ExportedTooltip>}
                        name="permit"
                        checked={formState.features.permit}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                    <ExportedCheckbox
                        label={<ExportedTooltip content="Integrate with a governance module for decentralized decision-making. (Requires additional setup)">Governance Module</ExportedTooltip>}
                        name="governanceModule"
                        checked={formState.features.governanceModule || false}
                        onChange={handleFeatureChange}
                        disabled={formState.type !== 'ERC-20'}
                    />
                </div>
                {formState.aiGeneratedNotes && (
                    <Card title="AI Generated Notes" className="mt-6">
                        <pre className="text-xs text-gray-300 overflow-auto max-h-40">{formState.aiGeneratedNotes}</pre>
                        <p className="mt-2 text-xs text-gray-400">Review and adjust these AI-suggested details as needed.</p>
                    </Card>
                )}
                <div className="flex justify-end pt-4">
                    <ExportedButton type="submit">
                        Save & Next <span className="ml-2">&rarr;</span>
                    </ExportedButton>
                </div>
            </form>
        </Card>
    );
};

// --- Step 2: Tokenomics Allocation Form ---

export const ExportedTokenomicsAllocationForm: React.FC<{ onNext: () => void; onPrev: () => void }> = ({ onNext, onPrev }) => {
    const { currentTokenConfig, tokenAllocations, setTokenAllocations, aiGeneratedTokenomics, showNotification } = useTokenIssuance();

    const [allocations, setAllocations] = useState<TokenAllocation[]>(tokenAllocations.length > 0 ? tokenAllocations : []);
    const [newAllocationType, setNewAllocationType] = useState<AllocationType>('Team');
    const [newAllocationPercentage, setNewAllocationPercentage] = useState<number>(0);

    const [errors, setErrors] = useState<Record<string, string>>({});

    useEffect(() => {
        if (aiGeneratedTokenomics && aiGeneratedTokenomics.allocation && allocations.length === 0 && currentTokenConfig?.totalSupply) {
            const aiAllocations: TokenAllocation[] = Object.entries(aiGeneratedTokenomics.allocation).map(([type, percentage]) => ({
                type: type as AllocationType,
                percentage: typeof percentage === 'number' ? percentage : 0,
                amount: typeof percentage === 'number' ? (percentage / 100) * currentTokenConfig.totalSupply : 0,
                vestingSchedule: type === 'Team' || type.includes('Investors') ? {
                    id: 'vesting-' + type.toLowerCase() + '-' + Date.now(),
                    amount: typeof percentage === 'number' ? (percentage / 100) * currentTokenConfig.totalSupply : 0,
                    cliff: type === 'Team' ? 12 : 6,
                    duration: type === 'Team' ? 36 : 24,
                    releaseFrequency: 'monthly',
                    startDate: new Date().toISOString().split('T')[0],
                    recipientAddresses: ['0xAIAutoGenAddressPlaceholder'],
                } : undefined,
                details: `AI-generated allocation for ${type}`,
            }));
            setAllocations(aiAllocations);
            showNotification('Tokenomics allocations pre-filled by AI!', 'info');
        }
    }, [aiGeneratedTokenomics, currentTokenConfig?.totalSupply, allocations.length, showNotification]);

    const calculateTotalPercentage = useCallback(() => {
        return allocations.reduce((sum, alloc) => sum + alloc.percentage, 0);
    }, [allocations]);

    const handleAddAllocation = () => {
        if (!currentTokenConfig?.totalSupply) {
            showNotification('Please define Token Supply in Step 1 first.', 'error');
            return;
        }

        if (newAllocationPercentage <= 0) {
            setErrors(prev => ({ ...prev, newAllocationPercentage: 'Percentage must be greater than 0.' }));
            return;
        }

        const currentTotal = calculateTotalPercentage();
        if (currentTotal + newAllocationPercentage > 100.01) { // Adding small buffer for floating point
            setErrors(prev => ({ ...prev, newAllocationPercentage: `Total percentage cannot exceed 100%. Remaining: ${100 - currentTotal.toFixed(2)}%` }));
            return;
        }

        const newAllocation: TokenAllocation = {
            type: newAllocationType,
            percentage: newAllocationPercentage,
            amount: (newAllocationPercentage / 100) * currentTokenConfig.totalSupply,
            details: '',
        };

        setAllocations(prev => [...prev, newAllocation]);
        setNewAllocationPercentage(0);
        setErrors(prev => ({ ...prev, newAllocationPercentage: '' }));
    };

    const handleRemoveAllocation = (index: number) => {
        setAllocations(prev => prev.filter((_, i) => i !== index));
    };

    const handleAllocationChange = (index: number, field: keyof TokenAllocation, value: any) => {
        if (!currentTokenConfig?.totalSupply) return;

        setAllocations(prev => {
            const updated = [...prev];
            if (field === 'percentage') {
                const newPercentage = parseFloat(value);
                if (isNaN(newPercentage)) return prev;

                const currentTotalExcludingThis = prev.filter((_, i) => i !== index).reduce((sum, alloc) => sum + alloc.percentage, 0);
                if (currentTotalExcludingThis + newPercentage > 100.01) {
                    showNotification(`Total percentage cannot exceed 100%. Remaining: ${100 - currentTotalExcludingThis.toFixed(2)}%`, 'warning');
                    return prev; // Prevent update
                }

                updated[index].percentage = newPercentage;
                updated[index].amount = (newPercentage / 100) * currentTokenConfig.totalSupply;
            } else {
                (updated[index] as any)[field] = value;
            }
            return updated;
        });
    };

    const handleVestingChange = (allocationIndex: number, field: keyof VestingSchedule, value: any) => {
        setAllocations(prev => {
            const updated = [...prev];
            const currentVesting = updated[allocationIndex].vestingSchedule;
            if (!currentVesting) return prev; // Should not happen if vesting is enabled

            (currentVesting as any)[field] = value;
            return updated;
        });
    };

    const validateForm = () => {
        const total = calculateTotalPercentage();
        if (total < 99.99 || total > 100.01) { // Allow slight floating point discrepancies
            showNotification('Total allocation percentage must be exactly 100%.', 'error');
            return false;
        }
        setErrors({});
        return true;
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (validateForm()) {
            setTokenAllocations(allocations);
            showNotification('Tokenomics allocations saved!', 'success');
            onNext();
        } else {
            showNotification('Please adjust allocations to total exactly 100%.', 'error');
        }
    };

    const allocationOptions = [
        { value: 'Team', label: 'Team' },
        { value: 'Investors (Seed)', label: 'Investors (Seed)' },
        { value: 'Investors (Private)', label: 'Investors (Private)' },
        { value: 'Investors (Public)', label: 'Investors (Public)' },
        { value: 'Ecosystem', label: 'Ecosystem' },
        { value: 'Treasury', label: 'Treasury' },
        { value: 'Advisors', label: 'Advisors' },
        { value: 'Marketing', label: 'Marketing' },
        { value: 'Liquidity', label: 'Liquidity' },
        { value: 'Staking Rewards', label: 'Staking Rewards' },
        { value: 'Community', label: 'Community' },
        { value: 'Airdrop', label: 'Airdrop' },
    ];

    const vestingReleaseFrequencyOptions = [
        { value: 'linear', label: 'Linear' },
        { value: 'monthly', label: 'Monthly' },
        { value: 'quarterly', label: 'Quarterly' },
        { value: 'daily', label: 'Daily' },
    ];

    const chartData = allocations.map(alloc => ({
        label: alloc.type,
        value: alloc.percentage,
        color: `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}` // Random color for now
    }));

    return (
        <Card title="2. Define Tokenomics & Allocations" icon={<FaProjectDiagram />}>
            <form onSubmit={handleSubmit} className="space-y-6">
                {!currentTokenConfig?.totalSupply && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Please complete "1. Define Your Token" to set the total supply before configuring allocations.</span>
                    </div>
                )}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 className="text-lg font-semibold text-white mb-4">Allocation Breakdown</h3>
                        <div className="space-y-4">
                            {allocations.length === 0 && (
                                <p className="text-gray-400">No allocations added yet. Use the form below to add your first allocation.</p>
                            )}
                            {allocations.map((alloc, index) => (
                                <div key={index} className="bg-gray-700/50 p-4 rounded-lg border border-gray-700 space-y-3">
                                    <div className="flex justify-between items-center">
                                        <h4 className="font-semibold text-white text-md">{alloc.type}</h4>
                                        <ExportedButton variant="danger" type="button" onClick={() => handleRemoveAllocation(index)} className="p-2 h-auto text-xs">Remove</ExportedButton>
                                    </div>
                                    <ExportedInput
                                        label="Percentage (%)"
                                        type="number"
                                        step="0.01"
                                        value={alloc.percentage}
                                        onChange={(e) => handleAllocationChange(index, 'percentage', parseFloat(e.target.value))}
                                        placeholder="e.g., 20"
                                        min="0"
                                        max="100"
                                        disabled={!currentTokenConfig?.totalSupply}
                                    />
                                    <p className="text-sm text-gray-400">Amount: {alloc.amount.toLocaleString(undefined, { maximumFractionDigits: currentTokenConfig?.decimals || 0 })} {currentTokenConfig?.symbol}</p>
                                    <ExportedTextArea
                                        label="Details/Purpose"
                                        value={alloc.details || ''}
                                        onChange={(e) => handleAllocationChange(index, 'details', e.target.value)}
                                        rows={2}
                                        placeholder="e.g., For core development team, 1-year cliff."
                                    />

                                    <ExportedCheckbox
                                        label="Enable Vesting Schedule"
                                        checked={!!alloc.vestingSchedule}
                                        onChange={(e) => handleAllocationChange(index, 'vestingSchedule', e.target.checked ? {
                                            id: `vesting-${alloc.type.toLowerCase().replace(/ /g, '-')}-${Date.now()}`,
                                            amount: alloc.amount,
                                            cliff: 0,
                                            duration: 0,
                                            releaseFrequency: 'linear',
                                            startDate: new Date().toISOString().split('T')[0],
                                            recipientAddresses: [],
                                        } : undefined)}
                                    />

                                    {alloc.vestingSchedule && (
                                        <div className="bg-gray-800 p-4 rounded-md space-y-3 border border-gray-700">
                                            <h5 className="font-semibold text-gray-200 text-sm">Vesting Details</h5>
                                            <ExportedInput
                                                label="Vesting Start Date"
                                                type="date"
                                                value={alloc.vestingSchedule.startDate}
                                                onChange={(e) => handleVestingChange(index, 'startDate', e.target.value)}
                                            />
                                            <ExportedInput
                                                label="Cliff (Months)"
                                                type="number"
                                                min="0"
                                                value={alloc.vestingSchedule.cliff}
                                                onChange={(e) => handleVestingChange(index, 'cliff', parseInt(e.target.value))}
                                            />
                                            <ExportedInput
                                                label="Total Vesting Duration (Months)"
                                                type="number"
                                                min="0"
                                                value={alloc.vestingSchedule.duration}
                                                onChange={(e) => handleVestingChange(index, 'duration', parseInt(e.target.value))}
                                            />
                                            <ExportedSelect
                                                label="Release Frequency"
                                                value={alloc.vestingSchedule.releaseFrequency}
                                                options={vestingReleaseFrequencyOptions}
                                                onChange={(e) => handleVestingChange(index, 'releaseFrequency', e.target.value as VestingSchedule['releaseFrequency'])}
                                            />
                                            <ExportedTextArea
                                                label="Recipient Wallet Addresses (one per line)"
                                                value={alloc.vestingSchedule.recipientAddresses.join('\n')}
                                                onChange={(e) => handleVestingChange(index, 'recipientAddresses', e.target.value.split('\n').map(addr => addr.trim()).filter(addr => addr))}
                                                rows={3}
                                                placeholder="0xabc...&#10;0xdef..."
                                            />
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="mt-8 pt-6 border-t border-gray-700 space-y-4">
                            <h3 className="text-lg font-semibold text-white">Add New Allocation</h3>
                            <ExportedSelect
                                label="Allocation Type"
                                value={newAllocationType}
                                options={allocationOptions.filter(opt => !allocations.some(a => a.type === opt.value))} // Prevent adding duplicate types for simplicity
                                onChange={(e) => setNewAllocationType(e.target.value as AllocationType)}
                            />
                            <ExportedInput
                                label="Percentage (%)"
                                type="number"
                                step="0.01"
                                value={newAllocationPercentage === 0 ? '' : newAllocationPercentage}
                                onChange={(e) => setNewAllocationPercentage(parseFloat(e.target.value))}
                                placeholder="e.g., 15"
                                min="0"
                                max="100"
                                error={errors.newAllocationPercentage}
                                disabled={!currentTokenConfig?.totalSupply}
                            />
                            <ExportedButton type="button" onClick={handleAddAllocation} disabled={!currentTokenConfig?.totalSupply || newAllocationPercentage <= 0}>
                                Add Allocation
                            </ExportedButton>
                            <p className="mt-4 text-sm text-gray-400">Total Allocated: {calculateTotalPercentage().toFixed(2)}%</p>
                            <p className={`text-sm ${calculateTotalPercentage().toFixed(2) === '100.00' ? 'text-green-500' : 'text-yellow-500'}`}>
                                Remaining: {(100 - calculateTotalPercentage()).toFixed(2)}%
                            </p>
                        </div>
                    </div>
                    <div>
                        <ExportedChart title="Token Allocation Distribution" data={chartData} />
                        <Card title="Token Supply Dynamics Simulator" className="mt-6">
                            <p className="text-sm text-gray-400 mb-4">Visualize how your token supply will evolve over time based on vesting schedules and planned releases.</p>
                            {/* Placeholder for interactive supply curve chart */}
                            <div className="w-full h-64 bg-gray-800 rounded flex items-center justify-center text-gray-500 text-sm">
                                <FaChartLine className="text-4xl mr-2" />
                                Interactive Supply Curve Chart (TODO)
                            </div>
                            <div className="mt-4 space-y-2 text-sm text-gray-300">
                                <p><strong>Estimated Initial Circulating Supply:</strong> {
                                    allocations.filter(a => !a.vestingSchedule && !a.isLocked).reduce((sum, a) => sum + a.amount, 0).toLocaleString()
                                } {currentTokenConfig?.symbol}</p>
                                <p><strong>Max Circulating Supply (at full vest):</strong> {currentTokenConfig?.totalSupply?.toLocaleString()} {currentTokenConfig?.symbol}</p>
                            </div>
                            <ExportedButton variant="secondary" className="w-full mt-4">Simulate Vesting & Supply</ExportedButton>
                        </Card>
                    </div>
                </div>

                <div className="flex justify-between pt-6 border-t border-gray-700">
                    <ExportedButton type="button" onClick={onPrev} variant="secondary">
                        &larr; Previous
                    </ExportedButton>
                    <ExportedButton type="submit">
                        Save & Next <span className="ml-2">&rarr;</span>
                    </ExportedButton>
                </div>
            </form>
        </Card>
    );
};

// --- Step 3: Smart Contract Configuration ---

export const ExportedSmartContractConfiguration: React.FC<{ onNext: () => void; onPrev: () => void }> = ({ onNext, onPrev }) => {
    const { currentTokenConfig, setCurrentTokenConfig, showNotification } = useTokenIssuance();
    const [gasEstimate, setGasEstimate] = useState<number | null>(null);
    const [isEstimating, setIsEstimating] = useState(false);

    const formState = currentTokenConfig || {
        id: '', name: '', symbol: '', description: '', type: 'ERC-20', totalSupply: 0, decimals: 18, socialLinks: {},
        features: { mintable: false, burnable: true, pausable: false, upgradable: false, snapshots: false, permit: false }
    };

    const handleFeatureChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, checked } = e.target;
        setCurrentTokenConfig(prev => prev ? {
            ...prev,
            features: { ...prev.features, [name]: checked }
        } : null);
    };

    const estimateGasCosts = async () => {
        setIsEstimating(true);
        setGasEstimate(null);
        // NOTE: This is a simulated gas estimation. In a real app, this would involve Web3 RPC calls.
        await new Promise(resolve => setTimeout(resolve, 1500));
        let estimate = 0;
        if (formState.type === 'ERC-20') {
            estimate += 250000; // Base ERC-20 deployment
            if (formState.features.mintable) estimate += 50000;
            if (formState.features.burnable) estimate += 20000;
            if (formState.features.pausable) estimate += 30000;
            if (formState.features.upgradable) estimate += 150000; // Proxy contract adds significant cost
            if (formState.features.snapshots) estimate += 40000;
            if (formState.features.permit) estimate += 30000;
        } else if (formState.type === 'ERC-721') {
            estimate += 400000; // Base ERC-721
            if (formState.features.upgradable) estimate += 150000;
        } else if (formState.type === 'ERC-1155') {
            estimate += 500000; // Base ERC-1155
            if (formState.features.upgradable) estimate += 150000;
        }
        setGasEstimate(estimate);
        setIsEstimating(false);
        showNotification('Gas estimation complete!', 'info');
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (!currentTokenConfig) {
            showNotification('Token configuration not found. Please complete previous steps.', 'error');
            return;
        }
        showNotification('Smart contract configuration saved!', 'success');
        onNext();
    };

    return (
        <Card title="3. Configure Smart Contract" icon={<FaFileCode />}>
            <form onSubmit={handleSubmit} className="space-y-6">
                {!currentTokenConfig && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Please complete "1. Define Your Token" before configuring the smart contract.</span>
                    </div>
                )}
                <h3 className="text-lg font-semibold text-white mb-4">Selected Token Type: {formState.type}</h3>
                <p className="text-gray-400 text-sm">
                    Based on your selected token type ({formState.type}), enable or disable specific functionalities for your smart contract.
                    These features directly impact the contract's code, complexity, and deployment gas costs.
                </p>

                {formState.type === 'ERC-20' ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Allow creating new tokens after initial deployment.">Mintable</ExportedTooltip>}
                            name="mintable"
                            checked={formState.features.mintable}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Allow token holders to permanently destroy their tokens.">Burnable</ExportedTooltip>}
                            name="burnable"
                            checked={formState.features.burnable}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Enable stopping/resuming all token transfers and approvals (e.g., in case of emergency).">Pausable</ExportedTooltip>}
                            name="pausable"
                            checked={formState.features.pausable}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Allows the contract logic to be upgraded in the future, typically via a proxy pattern.">Upgradable (Proxy)</ExportedTooltip>}
                            name="upgradable"
                            checked={formState.features.upgradable}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Allows querying historical balances at specific block numbers.">Snapshots</ExportedTooltip>}
                            name="snapshots"
                            checked={formState.features.snapshots}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Adds EIP-2612 permit function for gasless approvals.">Permit (EIP-2612)</ExportedTooltip>}
                            name="permit"
                            checked={formState.features.permit}
                            onChange={handleFeatureChange}
                        />
                         <ExportedCheckbox
                            label={<ExportedTooltip content="Enable the ERC-3156 standard for flash minting.">Flash Mint (ERC-3156)</ExportedTooltip>}
                            name="flashMint"
                            checked={formState.features.flashMint || false}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Implement ERC-1363 allowing tokens to be paid directly to a contract method.">ERC-1363 (Payable Token)</ExportedTooltip>}
                            name="erc1363"
                            checked={formState.features.erc1363 || false}
                            onChange={handleFeatureChange}
                        />
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Integrate a basic governance module to allow token holders to vote on proposals.">Governance Module</ExportedTooltip>}
                            name="governanceModule"
                            checked={formState.features.governanceModule || false}
                            onChange={handleFeatureChange}
                        />
                    </div>
                ) : (
                    <div className="bg-gray-800/50 p-4 rounded-lg text-gray-300">
                        <p>Advanced features are currently limited for {formState.type} token types.</p>
                        <p className="mt-2 text-xs">For ERC-721 and ERC-1155, options like "Upgradable" might be available, but other features like "Mintable" often depend on the specific NFT/multi-token implementation (e.g., lazyl minting, presales).</p>
                        <ExportedCheckbox
                            label={<ExportedTooltip content="Allows the contract logic to be upgraded in the future, typically via a proxy pattern.">Upgradable (Proxy)</ExportedTooltip>}
                            name="upgradable"
                            checked={formState.features.upgradable}
                            onChange={handleFeatureChange}
                        />
                    </div>
                )}

                <div className="mt-8 border-t border-gray-700 pt-6 space-y-4">
                    <h3 className="text-lg font-semibold text-white">Gas Cost Estimation</h3>
                    <p className="text-gray-400 text-sm">
                        Get an approximate estimate of the gas required to deploy your smart contract with the selected features.
                        Actual costs may vary depending on network congestion and chosen gas price.
                    </p>
                    <ExportedButton type="button" onClick={estimateGasCosts} loading={isEstimating} icon={<FaCalculator />}>
                        {isEstimating ? 'Estimating...' : 'Estimate Deployment Gas'}
                    </ExportedButton>
                    {gasEstimate !== null && (
                        <div className="mt-4 p-4 bg-gray-700/50 rounded-lg">
                            <p className="text-gray-300 text-sm">
                                Estimated Gas Units: <strong className="text-cyan-400">{gasEstimate.toLocaleString()}</strong>
                            </p>
                            <p className="text-gray-400 text-xs mt-1">
                                (Rough estimate, not including transaction costs like `gasPrice * gasUsed`)
                            </p>
                            <p className="text-gray-400 text-xs mt-2">
                                *Note: This is a simulated estimate. Real-world gas costs depend on the target network, current network conditions, and specific compiler optimizations.
                            </p>
                        </div>
                    )}
                </div>

                <div className="flex justify-between pt-6 border-t border-gray-700">
                    <ExportedButton type="button" onClick={onPrev} variant="secondary">
                        &larr; Previous
                    </ExportedButton>
                    <ExportedButton type="submit">
                        Save & Next <span className="ml-2">&rarr;</span>
                    </ExportedButton>
                </div>
            </form>
        </Card>
    );
};


// --- Step 4: Deployment Settings ---

export const ExportedDeploymentSettings: React.FC<{ onNext: () => void; onPrev: () => void }> = ({ onNext, onPrev }) => {
    const { currentTokenConfig, deploymentConfigs, setDeploymentConfigs, availableNetworks, addCustomNetwork, showNotification } = useTokenIssuance();
    const [selectedNetworkId, setSelectedNetworkId] = useState<string>(availableNetworks[0]?.id || '');
    const [ownerAddress, setOwnerAddress] = useState<string>('');
    const [gasPriceStrategy, setGasPriceStrategy] = useState<'standard' | 'fast' | 'custom'>('standard');
    const [customGasPriceGwei, setCustomGasPriceGwei] = useState<number>(30);
    const [frontRunProtection, setFrontRunProtection] = useState<boolean>(true);
    const [proxyAdminAddress, setProxyAdminAddress] = useState<string>('');
    const [showCustomNetworkModal, setShowCustomNetworkModal] = useState(false);
    const [customNetworkForm, setCustomNetworkForm] = useState<NetworkConfig>({ id: '', name: '', chainId: 0, rpcUrl: '', blockExplorerUrl: '' });
    const [customNetworkErrors, setCustomNetworkErrors] = useState<Record<string, string>>({});

    useEffect(() => {
        // Load existing deployment config if available or set defaults
        if (deploymentConfigs.length > 0) {
            const lastConfig = deploymentConfigs[deploymentConfigs.length - 1];
            setSelectedNetworkId(lastConfig.network.id);
            setOwnerAddress(lastConfig.ownerAddress);
            setGasPriceStrategy(lastConfig.gasPriceStrategy);
            setCustomGasPriceGwei(lastConfig.customGasPriceGwei || 30);
            setFrontRunProtection(lastConfig.frontRunProtection);
            setProxyAdminAddress(lastConfig.proxyAdminAddress || '');
        } else {
            // Simulate wallet connection to get owner address
            setOwnerAddress('0xYourConnectedWalletAddressGoesHere_Simulated');
        }
    }, [deploymentConfigs]);

    const handleCustomNetworkChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setCustomNetworkForm(prev => ({ ...prev, [name]: value }));
        setCustomNetworkErrors(prev => ({ ...prev, [name]: '' }));
    };

    const validateCustomNetworkForm = () => {
        const errors: Record<string, string> = {};
        if (!customNetworkForm.name.trim()) errors.name = 'Network name is required.';
        if (!customNetworkForm.chainId || customNetworkForm.chainId <= 0) errors.chainId = 'Valid Chain ID is required.';
        if (!customNetworkForm.rpcUrl.trim()) errors.rpcUrl = 'RPC URL is required.';
        if (!customNetworkForm.blockExplorerUrl.trim()) errors.blockExplorerUrl = 'Block Explorer URL is required.';
        setCustomNetworkErrors(errors);
        return Object.keys(errors).length === 0;
    };

    const handleAddCustomNetwork = () => {
        if (validateCustomNetworkForm()) {
            const newNetwork: NetworkConfig = {
                ...customNetworkForm,
                id: `custom-${customNetworkForm.chainId}-${Date.now()}`,
                chainId: parseInt(customNetworkForm.chainId as any) // Ensure chainId is number
            };
            addCustomNetwork(newNetwork);
            setSelectedNetworkId(newNetwork.id);
            setShowCustomNetworkModal(false);
            setCustomNetworkForm({ id: '', name: '', chainId: 0, rpcUrl: '', blockExplorerUrl: '' });
            setCustomNetworkErrors({});
        } else {
            showNotification('Please fill all required fields for custom network.', 'error');
        }
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (!currentTokenConfig) {
            showNotification('Token configuration not found. Please complete previous steps.', 'error');
            return;
        }
        if (!ownerAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
            showNotification('Please enter a valid owner wallet address.', 'error');
            return;
        }
        if (currentTokenConfig.features.upgradable && !proxyAdminAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
            showNotification('Please enter a valid proxy admin wallet address for upgradable contracts.', 'error');
            return;
        }

        const selectedNetwork = availableNetworks.find(net => net.id === selectedNetworkId);
        if (!selectedNetwork) {
            showNotification('Please select a valid network.', 'error');
            return;
        }

        const newDeploymentConfig: DeploymentConfig = {
            network: selectedNetwork,
            ownerAddress,
            gasPriceStrategy,
            customGasPriceGwei: gasPriceStrategy === 'custom' ? customGasPriceGwei : undefined,
            frontRunProtection,
            proxyAdminAddress: currentTokenConfig.features.upgradable ? proxyAdminAddress : undefined,
        };
        setDeploymentConfigs(prev => [...prev, newDeploymentConfig]);
        showNotification('Deployment settings saved!', 'success');
        onNext();
    };

    return (
        <Card title="4. Deployment Settings" icon={<FaNetworkWired />}>
            <form onSubmit={handleSubmit} className="space-y-6">
                {!currentTokenConfig && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Please complete "1. Define Your Token" before configuring deployment.</span>
                    </div>
                )}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ExportedSelect
                        label="Target Network"
                        value={selectedNetworkId}
                        onChange={(e) => setSelectedNetworkId(e.target.value)}
                        options={availableNetworks.map(net => ({ value: net.id, label: net.name }))}
                        icon={<FaEthereum />}
                    />
                    <div className="flex items-end">
                        <ExportedButton type="button" variant="secondary" onClick={() => setShowCustomNetworkModal(true)} className="w-full">
                            Add Custom Network <FaPlus className="ml-2" />
                        </ExportedButton>
                    </div>
                </div>

                <ExportedInput
                    label={<ExportedTooltip content="The wallet address that will own and control the deployed contract.">Contract Owner Address</ExportedTooltip>}
                    value={ownerAddress}
                    onChange={(e) => setOwnerAddress(e.target.value)}
                    placeholder="0x..."
                    icon={<FaWallet />}
                />
                {currentTokenConfig?.features.upgradable && (
                    <ExportedInput
                        label={<ExportedTooltip content="Address of the proxy admin contract or an EOA that will manage upgrades.">Proxy Admin Address</ExportedTooltip>}
                        value={proxyAdminAddress}
                        onChange={(e) => setProxyAdminAddress(e.target.value)}
                        placeholder="0x..."
                        icon={<FaCogs />}
                    />
                )}

                <h3 className="text-lg font-semibold text-white mt-8 mb-4">Gas Price Strategy</h3>
                <div className="space-y-3">
                    <ExportedSelect
                        label="Gas Price Strategy"
                        value={gasPriceStrategy}
                        onChange={(e) => setGasPriceStrategy(e.target.value as 'standard' | 'fast' | 'custom')}
                        options={[
                            { value: 'standard', label: 'Standard (Recommended)' },
                            { value: 'fast', label: 'Fast (Higher priority, higher cost)' },
                            { value: 'custom', label: 'Custom (Manual Gwei)' },
                        ]}
                    />
                    {gasPriceStrategy === 'custom' && (
                        <ExportedInput
                            label="Custom Gas Price (Gwei)"
                            type="number"
                            value={customGasPriceGwei}
                            onChange={(e) => setCustomGasPriceGwei(parseFloat(e.target.value))}
                            min="1"
                            step="1"
                            placeholder="e.g., 50"
                        />
                    )}
                </div>

                <ExportedCheckbox
                    label={<ExportedTooltip content="Attempt to prevent front-running attacks during deployment by using a private transaction relay or similar service.">Enable Front-Run Protection</ExportedTooltip>}
                    checked={frontRunProtection}
                    onChange={(e) => setFrontRunProtection(e.target.checked)}
                />

                <div className="flex justify-between pt-6 border-t border-gray-700">
                    <ExportedButton type="button" onClick={onPrev} variant="secondary">
                        &larr; Previous
                    </ExportedButton>
                    <ExportedButton type="submit">
                        Save & Next <span className="ml-2">&rarr;</span>
                    </ExportedButton>
                </div>
            </form>

            {/* Custom Network Modal */}
            {showCustomNetworkModal && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setShowCustomNetworkModal(false)}>
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-lg w-full border border-gray-700" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-700"><h3 className="text-lg font-semibold text-white">Add Custom Network</h3></div>
                        <div className="p-6 space-y-4">
                            <ExportedInput label="Network Name" name="name" value={customNetworkForm.name} onChange={handleCustomNetworkChange} error={customNetworkErrors.name} placeholder="e.g., Optimism Mainnet" />
                            <ExportedInput label="Chain ID" name="chainId" type="number" value={customNetworkForm.chainId === 0 ? '' : customNetworkForm.chainId} onChange={handleCustomNetworkChange} error={customNetworkErrors.chainId} placeholder="e.g., 10" />
                            <ExportedInput label="RPC URL" name="rpcUrl" type="url" value={customNetworkForm.rpcUrl} onChange={handleCustomNetworkChange} error={customNetworkErrors.rpcUrl} placeholder="e.g., https://mainnet.optimism.io" />
                            <ExportedInput label="Block Explorer URL" name="blockExplorerUrl" type="url" value={customNetworkForm.blockExplorerUrl} onChange={handleCustomNetworkChange} error={customNetworkErrors.blockExplorerUrl} placeholder="e.g., https://optimistic.etherscan.io" />
                            <div className="flex justify-end space-x-4 mt-6">
                                <ExportedButton type="button" variant="secondary" onClick={() => setShowCustomNetworkModal(false)}>Cancel</ExportedButton>
                                <ExportedButton type="button" onClick={handleAddCustomNetwork}>Add Network</ExportedButton>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </Card>
    );
};

// --- Step 5: Smart Contract Preview & Compile ---

export const ExportedSmartContractPreview: React.FC<{ onNext: () => void; onPrev: () => void }> = ({ onNext, onPrev }) => {
    const { currentTokenConfig, deploymentConfigs, showNotification } = useTokenIssuance();
    const [solidityCode, setSolidityCode] = useState<string>('// Generating contract code...');
    const [abi, setAbi] = useState<string>('// ABI will appear here after compilation...');
    const [bytecode, setBytecode] = useState<string>('// Bytecode will appear here after compilation...');
    const [isCompiling, setIsCompiling] = useState(false);
    const [compilationSuccess, setCompilationSuccess] = useState<boolean | null>(null);

    const generateSolidityCode = useCallback(() => {
        if (!currentTokenConfig) return '// No token configuration available.';

        let code = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
${currentTokenConfig.features.mintable ? 'import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Mintable.sol";' : ''}
${currentTokenConfig.features.burnable ? 'import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol";' : ''}
${currentTokenConfig.features.pausable ? 'import "@openzeppelin/contracts/security/Pausable.sol";' : ''}
${currentTokenConfig.features.upgradable ? 'import "@openzeppelin/contracts/proxy/utils/Initializable.sol";' : ''}
${currentTokenConfig.features.snapshots ? 'import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol";' : ''}
${currentTokenConfig.features.permit ? 'import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol";' : ''}
${currentTokenConfig.features.flashMint ? 'import "@openzeppelin/contracts/token/ERC20/extensions/ERC20FlashMint.sol";' : ''}
${currentTokenConfig.features.erc1363 ? 'import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Pausable.sol";' : ''} // ERC-1363 usually combined with pausable
import "@openzeppelin/contracts/access/Ownable.sol";

// For custom ERC-1363 (simplified)
${currentTokenConfig.features.erc1363 ? `
interface IERC1363Receiver {
    function onTokensReceived(address operator, address from, uint256 amount, bytes calldata data) external returns (bytes4);
}
interface IERC1363Spender {
    function onCallReceived(address operator, uint256 value, bytes calldata data) external returns (bytes4);
}
` : ''}

${currentTokenConfig.features.upgradable ? `contract ${currentTokenConfig.name.replace(/[^a-zA-Z0-9]/g, '')}V1 is Initializable, ERC20` : `contract ${currentTokenConfig.name.replace(/[^a-zA-Z0-9]/g, '')} is ERC20`}
${currentTokenConfig.features.mintable ? ', ERC20Mintable' : ''}
${currentTokenConfig.features.burnable ? ', ERC20Burnable' : ''}
${currentTokenConfig.features.pausable ? ', Pausable' : ''}
${currentTokenConfig.features.snapshots ? ', ERC20Snapshot' : ''}
${currentTokenConfig.features.permit ? ', ERC20Permit' : ''}
${currentTokenConfig.features.flashMint ? ', ERC20FlashMint' : ''}
${currentTokenConfig.features.erc1363 ? ', IERC1363Receiver, IERC1363Spender' : ''} // Simplified integration
, Ownable {

    string private _description;
    string private _websiteUrl;
    mapping(string => string) private _socialLinks;

    /// @custom:security-contact security@megacorp.com
    /// @dev This contract was generated by the MegaDashboard Token Issuance Platform.
    /// @notice A fungible token for ${currentTokenConfig.description || 'a decentralized application.'}

    ${currentTokenConfig.features.upgradable ? `
    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }

    function initialize(
        string memory name_,
        string memory symbol_,
        uint256 initialSupply_,
        address owner_
    ) public initializer {
        __ERC20_init(name_, symbol_);
        __Ownable_init(owner_);
        ${currentTokenConfig.features.pausable ? '__Pausable_init();' : ''}
        ${currentTokenConfig.features.snapshots ? '__ERC20Snapshot_init();' : ''}
        ${currentTokenConfig.features.permit ? `_deployer = msg.sender;` : ''} // Internal state for permit
        
        _mint(owner_, initialSupply_); // Mint initial supply to owner
        _description = "${currentTokenConfig.description.replace(/"/g, '\\"')}";
        _websiteUrl = "${currentTokenConfig.websiteUrl || ''}";
        // Populate social links
        ${Object.entries(currentTokenConfig.socialLinks).map(([platform, link]) => `_socialLinks["${platform}"] = "${link}";`).join('\n        ')}
    }
    ` : `
    constructor(uint256 initialSupply_, address owner_) ERC20("${currentTokenConfig.name}", "${currentTokenConfig.symbol}") {
        _mint(owner_, initialSupply_);
        _transferOwnership(owner_);
        _description = "${currentTokenConfig.description.replace(/"/g, '\\"')}";
        _websiteUrl = "${currentTokenConfig.websiteUrl || ''}";
        // Populate social links
        ${Object.entries(currentTokenConfig.socialLinks).map(([platform, link]) => `_socialLinks["${platform}"] = "${link}";`).join('\n        ')}
    }
    `}

    ${currentTokenConfig.features.pausable ? `
    function pause() public onlyOwner {
        _pause();
    }

    function unpause() public onlyOwner {
        _unpause();
    }

    function _beforeTokenTransfer(address from, address to, uint256 amount) internal virtual override(ERC20 ${currentTokenConfig.features.snapshots ? ', ERC20Snapshot' : ''} ${currentTokenConfig.features.flashMint ? ', ERC20FlashMint' : ''} ) {
        super._beforeTokenTransfer(from, to, amount);
        require(!paused(), "ERC20Pausable: token transfer while paused");
    }
    ` : `
    function _beforeTokenTransfer(address from, address to, uint256 amount) internal virtual override(ERC20 ${currentTokenConfig.features.snapshots ? ', ERC20Snapshot' : ''} ${currentTokenConfig.features.flashMint ? ', ERC20FlashMint' : ''} ) {
        super._beforeTokenTransfer(from, to, amount);
    }
    `}

    ${currentTokenConfig.features.mintable ? `
    function mint(address to, uint256 amount) public onlyOwner {
        _mint(to, amount);
    }
    ` : ''}

    ${currentTokenConfig.features.snapshots ? `
    function snapshot() public onlyOwner {
        _snapshot();
    }
    ` : ''}

    // Extended metadata functions
    function description() public view returns (string memory) {
        return _description;
    }

    function websiteUrl() public view returns (string memory) {
        return _websiteUrl;
    }

    function socialLink(string memory platform) public view returns (string memory) {
        return _socialLinks[platform];
    }

    // Custom ERC-1363 functions (simplified for demonstration)
    ${currentTokenConfig.features.erc1363 ? `
    function transferAndCall(address recipient, uint256 amount, bytes calldata data) public returns (bool) {
        _transfer(msg.sender, recipient, amount);
        require(recipient.code.length > 0, "ERC1363: transferAndCall to non-contract");
        bytes4 retval = IERC1363Receiver(recipient).onTokensReceived(msg.sender, address(this), amount, data);
        require(retval == IERC1363Receiver.onTokensReceived.selector, "ERC1363: onTokensReceived reverted");
        return true;
    }

    function approveAndCall(address spender, uint256 amount, bytes calldata data) public returns (bool) {
        _approve(msg.sender, spender, amount);
        require(spender.code.length > 0, "ERC1363: approveAndCall to non-contract");
        bytes4 retval = IERC1363Spender(spender).onCallReceived(msg.sender, amount, data);
        require(retval == IERC1363Spender.onCallReceived.selector, "ERC1363: onCallReceived reverted");
        return true;
    }

    function transferFromAndCall(address sender, address recipient, uint256 amount, bytes calldata data) public returns (bool) {
        _transfer(sender, recipient, amount);
        require(recipient.code.length > 0, "ERC1363: transferFromAndCall to non-contract");
        bytes4 retval = IERC1363Receiver(recipient).onTokensReceived(_msgSender(), sender, amount, data);
        require(retval == IERC1363Receiver.onTokensReceived.selector, "ERC1363: onTokensReceived reverted");
        return true;
    }
    ` : ''}
}
        `;

        // Add imports based on features (simplified, actual imports would be more complex)
        if (currentTokenConfig.type === 'ERC-721') {
            code = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
${currentTokenConfig.features.upgradable ? 'import "@openzeppelin/contracts/proxy/utils/Initializable.sol";' : ''}

${currentTokenConfig.features.upgradable ? `contract ${currentTokenConfig.name.replace(/[^a-zA-Z0-9]/g, '')}V1 is Initializable, ERC721` : `contract ${currentTokenConfig.name.replace(/[^a-zA-Z0-9]/g, '')} is ERC721`}
, Ownable {
    string private _baseTokenURI;

    ${currentTokenConfig.features.upgradable ? `
    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }

    function initialize(
        string memory name_,
        string memory symbol_,
        string memory baseTokenURI_,
        address owner_
    ) public initializer {
        __ERC721_init(name_, symbol_);
        __Ownable_init(owner_);
        _baseTokenURI = baseTokenURI_;
    }
    ` : `
    constructor(string memory name_, string memory symbol_, string memory baseTokenURI_, address owner_)
        ERC721(name_, symbol_) {
        _baseTokenURI = baseTokenURI_;
        _transferOwnership(owner_);
    }
    `}

    function _baseURI() internal view virtual override returns (string memory) {
        return _baseTokenURI;
    }

    function setBaseURI(string memory newBaseURI) public onlyOwner {
        _baseTokenURI = newBaseURI;
    }

    function safeMint(address to, uint256 tokenId) public onlyOwner {
        _safeMint(to, tokenId);
    }
}
            `;
        } else if (currentTokenConfig.type === 'ERC-1155') {
            code = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC1155/ERC1155.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
${currentTokenConfig.features.upgradable ? 'import "@openzeppelin/contracts/proxy/utils/Initializable.sol";' : ''}

${currentTokenConfig.features.upgradable ? `contract ${currentTokenConfig.name.replace(/[^a-zA-Z0-9]/g, '')}V1 is Initializable, ERC1155` : `contract ${currentTokenConfig.name.replace(/[^a-zA-Z0-9]/g, '')} is ERC1155`}
, Ownable {
    string private _uri;

    ${currentTokenConfig.features.upgradable ? `
    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }

    function initialize(
        string memory uri_,
        address owner_
    ) public initializer {
        __ERC1155_init(uri_);
        __Ownable_init(owner_);
        _uri = uri_;
    }
    ` : `
    constructor(string memory uri_, address owner_) ERC1155(uri_) {
        _uri = uri_;
        _transferOwnership(owner_);
    }
    `}

    function uri(uint256) public view override returns (string memory) {
        return _uri;
    }

    function setURI(string memory newuri) public onlyOwner {
        _uri = newuri;
    }

    function mint(address account, uint256 id, uint256 amount, bytes memory data)
        public
        onlyOwner
    {
        _mint(account, id, amount, data);
    }

    function mintBatch(address to, uint256[] memory ids, uint256[] memory amounts, bytes memory data)
        public
        onlyOwner
    {
        _mintBatch(to, ids, amounts, data);
    }
}
            `;
        }

        setSolidityCode(code);
    }, [currentTokenConfig]);

    useEffect(() => {
        generateSolidityCode();
    }, [generateSolidityCode]);

    const handleCompile = async () => {
        setIsCompiling(true);
        setCompilationSuccess(null);
        setAbi('// Compiling...');
        setBytecode('// Compiling...');

        // NOTE: This is a simulated compilation. In a real app, this would involve a Solidity compiler service.
        await new Promise(resolve => setTimeout(resolve, 2000));

        try {
            // Simulate successful compilation
            const dummyAbi = JSON.stringify([{ "inputs": [], "stateMutability": "nonpayable", "type": "constructor" }], null, 2);
            const dummyBytecode = `0x6080604052348015610010575f80fd5b50610...`; // Truncated dummy bytecode
            setAbi(dummyAbi);
            setBytecode(dummyBytecode);
            setCompilationSuccess(true);
            showNotification('Smart contract compiled successfully!', 'success');
        } catch (error) {
            console.error('Simulated compilation error:', error);
            setCompilationSuccess(false);
            setAbi('// Compilation failed.');
            setBytecode('// Compilation failed.');
            showNotification('Smart contract compilation failed. Please check the code for errors.', 'error');
        } finally {
            setIsCompiling(false);
        }
    };

    const handleDeploy = (e: React.FormEvent) => {
        e.preventDefault();
        if (!compilationSuccess) {
            showNotification('Please compile the contract successfully before deploying.', 'error');
            return;
        }
        onNext();
    };

    const hasErrors = !currentTokenConfig || !deploymentConfigs.length;

    return (
        <Card title="5. Smart Contract Preview & Compile" icon={<FaFileCode />}>
            <form onSubmit={handleDeploy} className="space-y-6">
                {hasErrors && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Please complete "1. Define Your Token" and "4. Deployment Settings" before reviewing and compiling.</span>
                    </div>
                )}
                <h3 className="text-lg font-semibold text-white mb-4">Generated Solidity Code</h3>
                <p className="text-gray-400 text-sm mb-4">
                    Review the automatically generated Solidity smart contract code based on your configurations.
                    Ensure it meets your requirements before proceeding to compilation.
                </p>
                <div className="bg-gray-900 rounded-lg p-4 font-mono text-xs text-green-300 overflow-auto max-h-96 border border-gray-700">
                    <pre><code>{solidityCode}</code></pre>
                </div>
                <ExportedButton type="button" onClick={handleCompile} loading={isCompiling} disabled={hasErrors} icon={<FaCogs />}>
                    {isCompiling ? 'Compiling...' : 'Compile Contract'}
                </ExportedButton>

                {compilationSuccess !== null && (
                    <div className={`mt-6 p-4 rounded-lg ${compilationSuccess ? 'bg-green-800/50 text-green-300' : 'bg-red-800/50 text-red-300'}`}>
                        {compilationSuccess ? (
                            <p className="flex items-center"><FaCheckCircle className="mr-2" /> Compilation Successful!</p>
                        ) : (
                            <p className="flex items-center"><FaTimesCircle className="mr-2" /> Compilation Failed. Check console for errors.</p>
                        )}
                    </div>
                )}

                {compilationSuccess && (
                    <div className="space-y-4 mt-6">
                        <h3 className="text-lg font-semibold text-white">Compiled Artifacts</h3>
                        <Card title="Contract ABI (Application Binary Interface)">
                            <div className="bg-gray-900 rounded-lg p-3 font-mono text-xs text-blue-300 overflow-auto max-h-48 border border-gray-700">
                                <pre><code>{abi}</code></pre>
                            </div>
                        </Card>
                        <Card title="Contract Bytecode">
                            <div className="bg-gray-900 rounded-lg p-3 font-mono text-xs text-yellow-300 overflow-auto max-h-48 border border-gray-700">
                                <pre><code>{bytecode}</code></pre>
                            </div>
                        </Card>
                        <p className="text-gray-400 text-sm">
                            These artifacts are essential for deploying and interacting with your smart contract on the blockchain.
                        </p>
                    </div>
                )}

                <div className="flex justify-between pt-6 border-t border-gray-700">
                    <ExportedButton type="button" onClick={onPrev} variant="secondary">
                        &larr; Previous
                    </ExportedButton>
                    <ExportedButton type="submit" disabled={!compilationSuccess}>
                        Deploy Contract <span className="ml-2">&rarr;</span>
                    </ExportedButton>
                </div>
            </form>
        </Card>
    );
};

// --- Step 6: Deployment Monitor ---

export const ExportedDeploymentMonitor: React.FC<{ onNext: () => void; onPrev: () => void }> = ({ onNext, onPrev }) => {
    const { currentTokenConfig, deploymentConfigs, deploymentHistory, setDeploymentHistory, showNotification } = useTokenIssuance();
    const [isDeploying, setIsDeploying] = useState(false);
    const [currentDeploymentStatus, setCurrentDeploymentStatus] = useState<DeploymentStatus | null>(null);

    const latestDeploymentConfig = deploymentConfigs[deploymentConfigs.length - 1];

    const simulateDeployment = useCallback(async () => {
        if (!currentTokenConfig || !latestDeploymentConfig) {
            showNotification('Missing token config or deployment settings.', 'error');
            return;
        }

        setIsDeploying(true);
        setDeploymentHistory(prev => []); // Clear previous for a new deployment simulation

        const deploymentId = `deploy-${Date.now()}`;
        const initialStatus: DeploymentStatus = {
            id: deploymentId,
            timestamp: new Date().toISOString(),
            status: 'pending',
            networkId: latestDeploymentConfig.network.id,
            tokenConfigId: currentTokenConfig.id,
        };
        setCurrentDeploymentStatus(initialStatus);
        setDeploymentHistory([initialStatus]);
        showNotification('Deployment initiated...', 'info');

        // Simulate deployment steps
        await new Promise(resolve => setTimeout(resolve, 3000));
        setCurrentDeploymentStatus(prev => prev ? { ...prev, status: 'deploying' } : null);
        setDeploymentHistory(prev => [{ ...initialStatus, status: 'deploying' }]);
        showNotification('Contract is being deployed to the network...', 'info');

        await new Promise(resolve => setTimeout(resolve, 5000));
        const transactionHash = `0x${Array(64).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`;
        const contractAddress = `0x${Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('')}`;
        setCurrentDeploymentStatus(prev => prev ? { ...prev, status: 'verifying', transactionHash, contractAddress } : null);
        setDeploymentHistory(prev => [{ ...initialStatus, status: 'verifying', transactionHash, contractAddress }]);
        showNotification('Transaction confirmed! Verifying contract...', 'info');

        await new Promise(resolve => setTimeout(resolve, 4000));
        const finalStatus: DeploymentStatus = {
            ...initialStatus,
            status: 'completed',
            transactionHash,
            contractAddress,
            blockNumber: Math.floor(Math.random() * 1000000) + 10000000,
        };
        setCurrentDeploymentStatus(finalStatus);
        setDeploymentHistory(prev => [{ ...finalStatus }]);
        setIsDeploying(false);
        showNotification('Contract deployed and verified successfully!', 'success');

        // Automatically move to the next step after a short delay
        setTimeout(() => onNext(), 2000);

    }, [currentTokenConfig, latestDeploymentConfig, setDeploymentHistory, showNotification, onNext]);

    useEffect(() => {
        // Trigger deployment automatically when component mounts, if not already deploying
        if (!isDeploying && latestDeploymentConfig && currentTokenConfig && deploymentHistory.length === 0) {
            simulateDeployment();
        }
    }, [isDeploying, latestDeploymentConfig, currentTokenConfig, deploymentHistory.length, simulateDeployment]);

    const deploymentSteps = [
        { label: 'Pending', status: 'pending' },
        { label: 'Deploying', status: 'deploying' },
        { label: 'Verifying', status: 'verifying' },
        { label: 'Completed', status: 'completed' },
    ];

    const currentStepIndex = deploymentSteps.findIndex(s => s.status === currentDeploymentStatus?.status);

    const blockExplorerLink = currentDeploymentStatus?.contractAddress && latestDeploymentConfig?.network.blockExplorerUrl
        ? `${latestDeploymentConfig.network.blockExplorerUrl}/address/${currentDeploymentStatus.contractAddress}`
        : '';
    const transactionLink = currentDeploymentStatus?.transactionHash && latestDeploymentConfig?.network.blockExplorerUrl
        ? `${latestDeploymentConfig.network.blockExplorerUrl}/tx/${currentDeploymentStatus.transactionHash}`
        : '';

    const hasErrors = !currentTokenConfig || !latestDeploymentConfig;

    return (
        <Card title="6. Deployment Monitor" icon={<FaEthereum />}>
            <div className="space-y-6">
                {hasErrors && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Please complete "1. Define Your Token" and "4. Deployment Settings" before deploying.</span>
                    </div>
                )}
                <h3 className="text-lg font-semibold text-white mb-4">Live Deployment Status</h3>
                <p className="text-gray-400 text-sm">
                    Your smart contract is currently being deployed to the <strong className="text-cyan-400">{latestDeploymentConfig?.network.name || 'selected'}</strong> network.
                    Please monitor the progress below. This process can take a few minutes depending on network conditions.
                </p>

                <div className="relative flex justify-between items-center w-full py-4 px-4 bg-gray-800 rounded-lg">
                    {deploymentSteps.map((step, index) => (
                        <div key={step.label} className="flex flex-col items-center flex-1 z-10">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300
                                ${index <= currentStepIndex ? 'bg-cyan-600 text-white' : 'bg-gray-700 text-gray-400'}
                            `}>
                                {index <= currentStepIndex && <FaCheckCircle />}
                                {index > currentStepIndex && index < deploymentSteps.length -1 && <FaClock />}
                                {index === deploymentSteps.length -1 && index > currentStepIndex && <FaPlayCircle />}
                            </div>
                            <span className={`mt-2 text-xs text-center ${index <= currentStepIndex ? 'text-white' : 'text-gray-500'}`}>
                                {step.label}
                            </span>
                        </div>
                    ))}
                    <div className="absolute left-0 right-0 h-1 bg-gray-700 top-[calc(50%-2px)] mx-8 -z-0">
                        <div className="h-full bg-cyan-600 transition-all duration-500" style={{ width: `${(currentStepIndex / (deploymentSteps.length - 1)) * 100}%` }}></div>
                    </div>
                </div>

                {currentDeploymentStatus && (
                    <div className="bg-gray-800 p-6 rounded-lg space-y-4 border border-gray-700">
                        <p className="flex items-center space-x-2 text-gray-300">
                            <FaSpinner className={isDeploying ? "animate-spin text-cyan-500" : "text-gray-500"} />
                            <span>Current Status: <strong className={`font-semibold ${isDeploying ? 'text-cyan-400' : currentDeploymentStatus.status === 'completed' ? 'text-green-500' : 'text-red-500'}`}>{currentDeploymentStatus.status.toUpperCase()}</strong></span>
                        </p>
                        {currentDeploymentStatus.transactionHash && (
                            <p className="text-gray-300 text-sm">
                                Transaction Hash: <a href={transactionLink} target="_blank" rel="noopener noreferrer" className="text-cyan-500 hover:underline break-all">{currentDeploymentStatus.transactionHash}</a>
                            </p>
                        )}
                        {currentDeploymentStatus.contractAddress && (
                            <p className="text-gray-300 text-sm">
                                Contract Address: <a href={blockExplorerLink} target="_blank" rel="noopener noreferrer" className="text-cyan-500 hover:underline break-all">{currentDeploymentStatus.contractAddress}</a>
                            </p>
                        )}
                        {currentDeploymentStatus.blockNumber && (
                            <p className="text-gray-300 text-sm">
                                Deployed at Block: <span className="text-cyan-400">{currentDeploymentStatus.blockNumber.toLocaleString()}</span>
                            </p>
                        )}
                        {currentDeploymentStatus.error && (
                            <p className="text-red-500 text-sm">Error: {currentDeploymentStatus.error}</p>
                        )}
                        <p className="text-gray-400 text-xs">Timestamp: {new Date(currentDeploymentStatus.timestamp).toLocaleString()}</p>
                    </div>
                )}

                {!isDeploying && currentDeploymentStatus?.status !== 'completed' && (
                    <div className="mt-8 pt-6 border-t border-gray-700 flex justify-center">
                        <ExportedButton type="button" onClick={simulateDeployment} disabled={hasErrors}>
                            Retry Deployment
                        </ExportedButton>
                    </div>
                )}

                <div className="flex justify-between pt-6 border-t border-gray-700">
                    <ExportedButton type="button" onClick={onPrev} variant="secondary" disabled={isDeploying || currentDeploymentStatus?.status === 'completed'}>
                        &larr; Previous
                    </ExportedButton>
                    <ExportedButton type="button" onClick={onNext} disabled={isDeploying || currentDeploymentStatus?.status !== 'completed'}>
                        Go to Dashboard <span className="ml-2">&rarr;</span>
                    </ExportedButton>
                </div>
            </div>
        </Card>
    );
};

// --- Step 7: Post-Issuance Dashboard ---

export const ExportedPostIssuanceDashboard: React.FC<{ onPrev: () => void }> = ({ onPrev }) => {
    const { currentTokenConfig, deploymentHistory, tokenAllocations, activeAirdropCampaigns, activeGovernanceProposals, showNotification } = useTokenIssuance();
    const latestDeployment = deploymentHistory.find(d => d.status === 'completed');

    const [currentSupply, setCurrentSupply] = useState<number>(currentTokenConfig?.totalSupply || 0);
    const [totalBurned, setTotalBurned] = useState<number>(0);
    const [currentHolders, setCurrentHolders] = useState<number>(1); // Owner is 1
    const [marketCap, setMarketCap] = useState<number | null>(null);
    const [price, setPrice] = useState<number | null>(null);

    const [isMinting, setIsMinting] = useState(false);
    const [mintAmount, setMintAmount] = useState<number>(0);
    const [mintRecipient, setMintRecipient] = useState<string>('');

    const [isBurning, setIsBurning] = useState(false);
    const [burnAmount, setBurnAmount] = useState<number>(0);

    const [isPausing, setIsPausing] = useState(false);
    const [isPaused, setIsPaused] = useState(false);

    useEffect(() => {
        if (currentTokenConfig) {
            // Simulate initial market data
            setPrice(Math.random() * 0.1 + 0.01); // Between 0.01 and 0.11
            setCurrentSupply(currentTokenConfig.totalSupply);
            // Simulate an initial distribution to a few holders
            setCurrentHolders(5 + Math.floor(Math.random() * 10));
        }
    }, [currentTokenConfig]);

    useEffect(() => {
        if (currentTokenConfig && price) {
            setMarketCap(currentSupply * price);
        }
    }, [currentSupply, price, currentTokenConfig]);

    const handleMint = async () => {
        if (!currentTokenConfig?.features.mintable) {
            showNotification('Minting is not enabled for this token.', 'error');
            return;
        }
        if (!mintAmount || mintAmount <= 0) {
            showNotification('Mint amount must be greater than 0.', 'error');
            return;
        }
        if (!mintRecipient.match(/^0x[a-fA-F0-9]{40}$/)) {
            showNotification('Please enter a valid recipient address.', 'error');
            return;
        }

        setIsMinting(true);
        showNotification(`Minting ${mintAmount} ${currentTokenConfig.symbol} to ${mintRecipient}...`, 'info');
        // Simulate transaction
        await new Promise(resolve => setTimeout(resolve, 3000));
        setCurrentSupply(prev => prev + mintAmount);
        setMintAmount(0);
        setMintRecipient('');
        setIsMinting(false);
        showNotification(`${mintAmount} ${currentTokenConfig.symbol} minted successfully!`, 'success');
        // Simulate holder increase
        setCurrentHolders(prev => prev + 1);
    };

    const handleBurn = async () => {
        if (!currentTokenConfig?.features.burnable) {
            showNotification('Burning is not enabled for this token.', 'error');
            return;
        }
        if (!burnAmount || burnAmount <= 0) {
            showNotification('Burn amount must be greater than 0.', 'error');
            return;
        }
        if (burnAmount > currentSupply) {
            showNotification('Cannot burn more tokens than currently exist.', 'error');
            return;
        }

        setIsBurning(true);
        showNotification(`Burning ${burnAmount} ${currentTokenConfig.symbol}...`, 'info');
        // Simulate transaction
        await new Promise(resolve => setTimeout(resolve, 3000));
        setCurrentSupply(prev => prev - burnAmount);
        setTotalBurned(prev => prev + burnAmount);
        setBurnAmount(0);
        setIsBurning(false);
        showNotification(`${burnAmount} ${currentTokenConfig.symbol} burned successfully!`, 'success');
    };

    const handleTogglePause = async () => {
        if (!currentTokenConfig?.features.pausable) {
            showNotification('Pausing is not enabled for this token.', 'error');
            return;
        }

        setIsPausing(true);
        showNotification(isPaused ? 'Unpausing token transfers...' : 'Pausing token transfers...', 'info');
        // Simulate transaction
        await new Promise(resolve => setTimeout(resolve, 3000));
        setIsPaused(prev => !prev);
        setIsPausing(false);
        showNotification(isPaused ? 'Token unpaused successfully!' : 'Token paused successfully!', 'success');
    };

    const supplyBreakdownData = [
        { label: 'Circulating Supply', value: currentSupply - totalBurned, color: '#34d399' },
        { label: 'Locked/Vesting Supply', value: tokenAllocations.filter(a => a.vestingSchedule || a.isLocked).reduce((sum, a) => sum + a.amount, 0), color: '#fbbf24' },
        { label: 'Burned Supply', value: totalBurned, color: '#ef4444' },
    ];
    // Adjust total to ensure it matches currentTokenConfig.totalSupply for percentages,
    // or currentSupply for actual breakdown. Let's use currentTokenConfig.totalSupply as base.
    const totalForChart = currentTokenConfig?.totalSupply || 1;

    return (
        <Card title="7. Post-Issuance Dashboard" icon={<FaChartLine />}>
            <div className="space-y-8">
                {(!currentTokenConfig || !latestDeployment) && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Please ensure token configuration is complete and the token has been deployed to view the dashboard.</span>
                    </div>
                )}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <DashboardMetric label="Contract Address" value={latestDeployment?.contractAddress || 'N/A'} isAddress={true} />
                    <DashboardMetric label="Total Supply" value={currentTokenConfig?.totalSupply.toLocaleString() || 'N/A'} suffix={currentTokenConfig?.symbol} />
                    <DashboardMetric label="Current Circulating Supply" value={(currentSupply - totalBurned).toLocaleString()} suffix={currentTokenConfig?.symbol} />
                    <DashboardMetric label="Total Burned" value={totalBurned.toLocaleString()} suffix={currentTokenConfig?.symbol} />
                    <DashboardMetric label="Current Price (Simulated)" value={price ? `$${price.toFixed(4)}` : 'N/A'} />
                    <DashboardMetric label="Market Cap (Simulated)" value={marketCap ? `$${marketCap.toLocaleString(undefined, { maximumFractionDigits: 0 })}` : 'N/A'} />
                    <DashboardMetric label="Total Holders (Simulated)" value={currentHolders.toLocaleString()} />
                    <DashboardMetric label="Status" value={isPaused ? 'Paused' : 'Active'} color={isPaused ? 'text-red-500' : 'text-green-500'} />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <ExportedChart
                        title="Token Supply Breakdown"
                        data={supplyBreakdownData.map(d => ({ ...d, value: d.value }))}
                    />
                    <Card title="Recent Activity (Simulated)" className="relative overflow-hidden">
                        <h3 className="text-lg font-semibold text-white mb-4">Recent Activity</h3>
                        <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                            <ActivityLogItem type="deployment" message={`Contract deployed to ${latestDeployment?.networkId || 'N/A'}`} timestamp={latestDeployment?.timestamp || new Date().toISOString()} />
                            <ActivityLogItem type="transfer" message={`0x... minted 10,000 ${currentTokenConfig?.symbol}`} timestamp={new Date(Date.now() - 3600000).toISOString()} />
                            <ActivityLogItem type="transfer" message={`0x... transferred 500 ${currentTokenConfig?.symbol} to 0x...`} timestamp={new Date(Date.now() - 7200000).toISOString()} />
                            <ActivityLogItem type="burn" message={`0x... burned 2,000 ${currentTokenConfig?.symbol}`} timestamp={new Date(Date.now() - 10800000).toISOString()} />
                            <ActivityLogItem type="mint" message={`Owner minted 5,000 ${currentTokenConfig?.symbol} for liquidity.`} timestamp={new Date(Date.now() - 14400000).toISOString()} />
                            <ActivityLogItem type="update" message={`Vesting schedule updated for Team allocation.`} timestamp={new Date(Date.now() - 18000000).toISOString()} />
                        </div>
                        <ExportedButton variant="secondary" className="w-full mt-4">View All Transactions</ExportedButton>
                    </Card>
                </div>

                {currentTokenConfig && latestDeployment && (
                    <div className="mt-8 space-y-6 pt-6 border-t border-gray-700">
                        <h2 className="text-2xl font-bold text-white">Token Management Panel</h2>
                        <p className="text-gray-400 text-sm">
                            Execute privileged operations on your deployed token contract.
                            <strong className="text-red-400"> Use with caution.</strong>
                        </p>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Card title="Mint Tokens" icon={<FaPlayCircle />}>
                                {currentTokenConfig.features.mintable ? (
                                    <div className="space-y-4">
                                        <ExportedInput
                                            label="Amount to Mint"
                                            type="number"
                                            value={mintAmount === 0 ? '' : mintAmount}
                                            onChange={(e) => setMintAmount(parseFloat(e.target.value))}
                                            placeholder="e.g., 10000"
                                            min="1"
                                        />
                                        <ExportedInput
                                            label="Recipient Address"
                                            value={mintRecipient}
                                            onChange={(e) => setMintRecipient(e.target.value)}
                                            placeholder="0x..."
                                        />
                                        <ExportedButton onClick={handleMint} loading={isMinting} disabled={isPaused || !currentTokenConfig.features.mintable} className="w-full">
                                            {isMinting ? 'Minting...' : 'Mint Tokens'}
                                        </ExportedButton>
                                        {isPaused && <p className="text-red-400 text-sm mt-2">Cannot mint while token is paused.</p>}
                                    </div>
                                ) : (
                                    <p className="text-gray-400">Minting is not enabled for this token contract.</p>
                                )}
                            </Card>

                            <Card title="Burn Tokens" icon={<FaBurn />}>
                                {currentTokenConfig.features.burnable ? (
                                    <div className="space-y-4">
                                        <ExportedInput
                                            label="Amount to Burn"
                                            type="number"
                                            value={burnAmount === 0 ? '' : burnAmount}
                                            onChange={(e) => setBurnAmount(parseFloat(e.target.value))}
                                            placeholder="e.g., 5000"
                                            min="1"
                                        />
                                        <ExportedButton onClick={handleBurn} loading={isBurning} disabled={isPaused || !currentTokenConfig.features.burnable} className="w-full" variant="danger">
                                            {isBurning ? 'Burning...' : 'Burn Tokens'}
                                        </ExportedButton>
                                        {isPaused && <p className="text-red-400 text-sm mt-2">Cannot burn while token is paused.</p>}
                                    </div>
                                ) : (
                                    <p className="text-gray-400">Burning is not enabled for this token contract.</p>
                                )}
                            </Card>

                            <Card title="Pause/Unpause Transfers" icon={isPaused ? <FaPlayCircle /> : <FaPauseCircle />}>
                                {currentTokenConfig.features.pausable ? (
                                    <div className="space-y-4">
                                        <p className="text-gray-300">Current Status: <strong className={isPaused ? 'text-red-500' : 'text-green-500'}>{isPaused ? 'PAUSED' : 'ACTIVE'}</strong></p>
                                        <ExportedButton onClick={handleTogglePause} loading={isPausing} disabled={isPausing || !currentTokenConfig.features.pausable} className="w-full" variant={isPaused ? 'primary' : 'danger'}>
                                            {isPausing ? 'Processing...' : (isPaused ? 'Unpause Transfers' : 'Pause Transfers')}
                                        </ExportedButton>
                                        {isPaused && <p className="text-yellow-400 text-sm mt-2">All token transfers and approvals are currently halted.</p>}
                                        {!isPaused && <p className="text-gray-400 text-sm mt-2">Token transfers are active.</p>}
                                    </div>
                                ) : (
                                    <p className="text-gray-400">Pausing functionality is not enabled for this token contract.</p>
                                )}
                            </Card>

                            <Card title="Manage Ownership" icon={<FaUsers />}>
                                <div className="space-y-4">
                                    <p className="text-gray-300 text-sm">Current Owner: <span className="text-cyan-400 break-all">{latestDeployment?.ownerAddress || 'N/A'}</span></p>
                                    <ExportedInput label="New Owner Address" placeholder="0x..." />
                                    <ExportedButton className="w-full" variant="secondary" disabled>
                                        Transfer Ownership (TODO)
                                    </ExportedButton>
                                </div>
                            </Card>
                        </div>
                    </div>
                )}

                <div className="flex justify-end pt-6 border-t border-gray-700">
                    <ExportedButton type="button" onClick={onPrev} variant="secondary">
                        &larr; Back to Deployment Monitor
                    </ExportedButton>
                </div>
            </div>
        </Card>
    );
};

export const DashboardMetric: React.FC<{ label: string; value: string | number; suffix?: string; isAddress?: boolean; color?: string; }> = ({ label, value, suffix, isAddress, color }) => (
    <div className="bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center text-center space-y-2 border border-gray-700">
        <p className="text-sm text-gray-400">{label}</p>
        {isAddress ? (
            <a href={`https://etherscan.io/address/${value}`} target="_blank" rel="noopener noreferrer" className="text-cyan-500 text-md font-semibold hover:underline break-all">
                {String(value).substring(0, 6)}...{String(value).substring(String(value).length - 4)}
            </a>
        ) : (
            <p className={`text-xl font-bold ${color || 'text-white'}`}>{value}{suffix && <span className="text-sm ml-1 text-gray-300">{suffix}</span>}</p>
        )}
    </div>
);

export const ActivityLogItem: React.FC<{ type: 'deployment' | 'transfer' | 'mint' | 'burn' | 'update'; message: string; timestamp: string }> = ({ type, message, timestamp }) => {
    let icon;
    let colorClass;
    switch (type) {
        case 'deployment': icon = <FaCheckCircle />; colorClass = 'text-green-500'; break;
        case 'transfer': icon = <FaExchangeAlt />; colorClass = 'text-blue-400'; break;
        case 'mint': icon = <FaPlayCircle />; colorClass = 'text-cyan-400'; break;
        case 'burn': icon = <FaBurn />; colorClass = 'text-red-400'; break;
        case 'update': icon = <FaCogs />; colorClass = 'text-yellow-400'; break;
        default: icon = <FaBell />; colorClass = 'text-gray-400';
    }

    return (
        <div className="flex items-start space-x-3 p-2 bg-gray-700/30 rounded-md">
            <span className={`flex-shrink-0 ${colorClass}`}>{icon}</span>
            <div className="flex-grow">
                <p className="text-sm text-gray-300">{message}</p>
                <p className="text-xs text-gray-500 mt-1">{new Date(timestamp).toLocaleString()}</p>
            </div>
        </div>
    );
};

// --- Additional Views/Components for a Real-World Application ---

export const ExportedAirdropManager: React.FC = () => {
    const { currentTokenConfig, activeAirdropCampaigns, setActiveAirdropCampaigns, latestDeployment, showNotification } = useTokenIssuance();
    const [campaignName, setCampaignName] = useState('');
    const [recipientsInput, setRecipientsInput] = useState(''); // CSV or JSON input
    const [totalAirdropAmount, setTotalAirdropAmount] = useState(0);
    const [proofType, setProofType] = useState<'merkleTree' | 'directTransfer'>('directTransfer');
    const [scheduleDate, setScheduleDate] = useState('');
    const [description, setDescription] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [errors, setErrors] = useState<Record<string, string>>({});

    const handleCreateAirdrop = async () => {
        if (!currentTokenConfig || !latestDeployment?.contractAddress) {
            showNotification('Token not deployed. Cannot create airdrop.', 'error');
            return;
        }

        const newErrors: Record<string, string> = {};
        if (!campaignName.trim()) newErrors.campaignName = 'Campaign name is required.';
        if (!recipientsInput.trim()) newErrors.recipientsInput = 'Recipient list is required.';
        if (totalAirdropAmount <= 0) newErrors.totalAirdropAmount = 'Total amount must be greater than 0.';

        if (Object.keys(newErrors).length > 0) {
            setErrors(newErrors);
            showNotification('Please fill all required fields.', 'error');
            return;
        }

        setIsLoading(true);
        // Simulate parsing recipients and amounts
        const recipientsArray: { address: string; amount: number; }[] = recipientsInput.split('\n').map(line => {
            const parts = line.split(',');
            return { address: parts[0].trim(), amount: parseFloat(parts[1].trim() || '0') };
        }).filter(r => r.address.match(/^0x[a-fA-F0-9]{40}$/) && r.amount > 0);

        if (recipientsArray.length === 0) {
            newErrors.recipientsInput = 'No valid recipients found. Format: address,amount per line.';
            setErrors(newErrors);
            setIsLoading(false);
            showNotification('Invalid recipient list format.', 'error');
            return;
        }
        const calculatedTotal = recipientsArray.reduce((sum, r) => sum + r.amount, 0);
        if (calculatedTotal !== totalAirdropAmount) {
            newErrors.totalAirdropAmount = `Sum of recipient amounts (${calculatedTotal}) does not match Total Airdrop Amount.`;
            setErrors(newErrors);
            setIsLoading(false);
            showNotification('Total airdrop amount mismatch.', 'error');
            return;
        }


        const newCampaign: AirdropCampaign = {
            id: `airdrop-${Date.now()}`,
            name: campaignName,
            tokenAddress: latestDeployment.contractAddress,
            recipients: recipientsArray,
            totalAirdropAmount: totalAirdropAmount,
            status: scheduleDate ? 'scheduled' : 'draft',
            scheduleDate: scheduleDate || undefined,
            description: description,
            proofGenerationType: proofType,
            snapshotBlockNumber: proofType === 'merkleTree' ? Math.floor(Math.random() * 100000) + 10000000 : undefined, // Simulate a snapshot block for merkle
        };

        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call
        setActiveAirdropCampaigns(prev => [...prev, newCampaign]);
        showNotification(`Airdrop campaign "${campaignName}" created successfully!`, 'success');
        setIsLoading(false);
        // Reset form
        setCampaignName('');
        setRecipientsInput('');
        setTotalAirdropAmount(0);
        setScheduleDate('');
        setDescription('');
        setErrors({});
    };

    const handleExecuteAirdrop = async (campaignId: string) => {
        setIsLoading(true);
        showNotification('Executing airdrop...', 'info');
        await new Promise(resolve => setTimeout(resolve, 5000)); // Simulate execution
        setActiveAirdropCampaigns(prev => prev.map(campaign =>
            campaign.id === campaignId ? { ...campaign, status: 'completed', transactionHash: `0x${Array(64).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('')}` } : campaign
        ));
        setIsLoading(false);
        showNotification('Airdrop executed successfully!', 'success');
    };

    const handleCancelAirdrop = async (campaignId: string) => {
        setIsLoading(true);
        showNotification('Cancelling airdrop...', 'warning');
        await new Promise(resolve => setTimeout(resolve, 2000));
        setActiveAirdropCampaigns(prev => prev.map(campaign =>
            campaign.id === campaignId ? { ...campaign, status: 'cancelled' } : campaign
        ));
        setIsLoading(false);
        showNotification('Airdrop cancelled.', 'info');
    };


    return (
        <Card title="Airdrop Manager" icon={<FaCloudDownloadAlt />} className="col-span-2">
            <div className="space-y-6">
                <h3 className="text-xl font-semibold text-white">Create New Airdrop Campaign</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ExportedInput
                        label="Campaign Name"
                        value={campaignName}
                        onChange={(e) => { setCampaignName(e.target.value); setErrors(p => ({ ...p, campaignName: '' })); }}
                        placeholder="e.g., Early Adopter Airdrop"
                        error={errors.campaignName}
                    />
                    <ExportedInput
                        label="Total Airdrop Amount"
                        type="number"
                        value={totalAirdropAmount === 0 ? '' : totalAirdropAmount}
                        onChange={(e) => { setTotalAirdropAmount(parseFloat(e.target.value)); setErrors(p => ({ ...p, totalAirdropAmount: '' })); }}
                        placeholder="e.g., 100000"
                        min="1"
                        error={errors.totalAirdropAmount}
                    />
                </div>
                <ExportedTextArea
                    label="Recipient Addresses & Amounts (Address,Amount per line)"
                    value={recipientsInput}
                    onChange={(e) => { setRecipientsInput(e.target.value); setErrors(p => ({ ...p, recipientsInput: '' })); }}
                    rows={6}
                    placeholder="0xabc...123,1000&#10;0xdef...456,500&#10;0xghi...789,250"
                    error={errors.recipientsInput}
                />
                <ExportedSelect
                    label={<ExportedTooltip content="Merkle Tree is gas-efficient for large recipient lists. Direct Transfer is simpler for small lists.">Airdrop Proof Type</ExportedTooltip>}
                    value={proofType}
                    options={[
                        { value: 'directTransfer', label: 'Direct Transfer (ERC-20)' },
                        { value: 'merkleTree', label: 'Merkle Tree (Gas Efficient)' },
                    ]}
                    onChange={(e) => setProofType(e.target.value as 'merkleTree' | 'directTransfer')}
                />
                {proofType === 'merkleTree' && (
                    <div className="bg-blue-800/50 p-3 rounded text-blue-300 text-sm flex items-center space-x-2">
                        <FaInfoCircle />
                        <span>A Merkle Tree will be generated for off-chain proofs, allowing users to claim their airdrop. This requires a claim smart contract.</span>
                    </div>
                )}
                <ExportedInput
                    label="Schedule Date (Optional)"
                    type="date"
                    value={scheduleDate}
                    onChange={(e) => setScheduleDate(e.target.value)}
                />
                <ExportedTextArea
                    label="Campaign Description (Optional)"
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    rows={3}
                    placeholder="Describe the purpose of this airdrop..."
                />
                <ExportedButton onClick={handleCreateAirdrop} loading={isLoading} disabled={isLoading || !currentTokenConfig || !latestDeployment?.contractAddress} className="w-full">
                    {isLoading ? 'Creating Campaign...' : 'Create Airdrop Campaign'}
                </ExportedButton>

                <h3 className="text-xl font-semibold text-white mt-8 pt-6 border-t border-gray-700">Active Campaigns</h3>
                {activeAirdropCampaigns.length === 0 ? (
                    <p className="text-gray-400">No active airdrop campaigns.</p>
                ) : (
                    <div className="space-y-4">
                        {activeAirdropCampaigns.map(campaign => (
                            <Card key={campaign.id} className="bg-gray-700/50">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-semibold text-white">{campaign.name}</h4>
                                    <span className={`px-2 py-1 text-xs rounded-full ${
                                        campaign.status === 'active' ? 'bg-green-600' :
                                        campaign.status === 'scheduled' ? 'bg-blue-600' :
                                        campaign.status === 'completed' ? 'bg-gray-600' :
                                        'bg-red-600'
                                    } text-white`}>{campaign.status.toUpperCase()}</span>
                                </div>
                                <p className="text-sm text-gray-300">Total Amount: {campaign.totalAirdropAmount.toLocaleString()} {currentTokenConfig?.symbol}</p>
                                <p className="text-sm text-gray-300">Recipients: {campaign.recipients.length}</p>
                                {campaign.scheduleDate && <p className="text-sm text-gray-300">Scheduled: {new Date(campaign.scheduleDate).toLocaleDateString()}</p>}
                                {campaign.transactionHash && <p className="text-sm text-gray-300 break-all">Tx Hash: <a href={`#`} className="text-cyan-400 hover:underline">{campaign.transactionHash}</a></p>}
                                <div className="mt-4 flex space-x-2">
                                    {campaign.status === 'draft' || campaign.status === 'scheduled' ? (
                                        <>
                                            <ExportedButton onClick={() => handleExecuteAirdrop(campaign.id)} disabled={isLoading} icon={<FaPlayCircle />}>
                                                Execute Now
                                            </ExportedButton>
                                            <ExportedButton variant="danger" onClick={() => handleCancelAirdrop(campaign.id)} disabled={isLoading} icon={<FaTimesCircle />}>
                                                Cancel
                                            </ExportedButton>
                                        </>
                                    ) : campaign.status === 'completed' && (
                                        <ExportedButton variant="secondary" disabled>View Report</ExportedButton>
                                    )}
                                </div>
                            </Card>
                        ))}
                    </div>
                )}
            </div>
        </Card>
    );
};


export const ExportedGovernanceSetup: React.FC = () => {
    const { currentTokenConfig, activeGovernanceProposals, setActiveGovernanceProposals, latestDeployment, showNotification } = useTokenIssuance();
    const [proposalTitle, setProposalTitle] = useState('');
    const [proposalDescription, setProposalDescription] = useState('');
    const [votingDurationDays, setVotingDurationDays] = useState(7);
    const [quorumPercentage, setQuorumPercentage] = useState(10);
    const [thresholdPercentage, setThresholdPercentage] = useState(50);
    const [isLoading, setIsLoading] = useState(false);
    const [errors, setErrors] = useState<Record<string, string>>({});

    const handleCreateProposal = async () => {
        if (!currentTokenConfig || !latestDeployment?.contractAddress) {
            showNotification('Token not deployed. Cannot create governance proposal.', 'error');
            return;
        }
        if (!currentTokenConfig.features.governanceModule) {
            showNotification('Governance module not enabled for this token.', 'error');
            return;
        }

        const newErrors: Record<string, string> = {};
        if (!proposalTitle.trim()) newErrors.proposalTitle = 'Proposal title is required.';
        if (!proposalDescription.trim()) newErrors.proposalDescription = 'Proposal description is required.';
        if (votingDurationDays <= 0) newErrors.votingDurationDays = 'Voting duration must be greater than 0.';
        if (quorumPercentage <= 0 || quorumPercentage > 100) newErrors.quorumPercentage = 'Quorum must be between 1-100.';
        if (thresholdPercentage <= 0 || thresholdPercentage > 100) newErrors.thresholdPercentage = 'Threshold must be between 1-100.';

        if (Object.keys(newErrors).length > 0) {
            setErrors(newErrors);
            showNotification('Please fill all required fields correctly.', 'error');
            return;
        }

        setIsLoading(true);
        const startTime = new Date().toISOString();
        const endTime = new Date(Date.now() + votingDurationDays * 24 * 60 * 60 * 1000).toISOString();
        const newProposal: GovernanceProposal = {
            id: `proposal-${Date.now()}`,
            title: proposalTitle,
            description: proposalDescription,
            proposer: latestDeployment.ownerAddress, // Simplified, would be connected wallet
            status: 'active',
            startTime,
            endTime,
            snapshotBlock: Math.floor(Math.random() * 100000) + 10000000, // Simulate snapshot block
            quorum: quorumPercentage,
            threshold: thresholdPercentage,
            votesFor: 0,
            votesAgainst: 0,
            votesAbstain: 0,
        };

        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call
        setActiveGovernanceProposals(prev => [...prev, newProposal]);
        showNotification(`Governance proposal "${proposalTitle}" created successfully!`, 'success');
        setIsLoading(false);
        // Reset form
        setProposalTitle('');
        setProposalDescription('');
        setVotingDurationDays(7);
        setQuorumPercentage(10);
        setThresholdPercentage(50);
        setErrors({});
    };

    const handleSimulateVote = (proposalId: string) => {
        setActiveGovernanceProposals(prev => prev.map(p =>
            p.id === proposalId && p.status === 'active' ? {
                ...p,
                votesFor: p.votesFor + Math.floor(Math.random() * 100) + 1,
                votesAgainst: p.votesAgainst + Math.floor(Math.random() * 50),
                votesAbstain: p.votesAbstain + Math.floor(Math.random() * 20),
            } : p
        ));
        showNotification('Simulated votes added.', 'info');
    };

    const handleEndVoting = (proposalId: string) => {
        setActiveGovernanceProposals(prev => prev.map(p => {
            if (p.id === proposalId) {
                const totalVotes = p.votesFor + p.votesAgainst + p.votesAbstain;
                const quorumMet = (totalVotes / (currentTokenConfig?.totalSupply || 1)) * 100 >= p.quorum;
                const passedThreshold = (p.votesFor / totalVotes) * 100 >= p.threshold;
                let status: GovernanceProposal['status'] = 'defeated';
                if (quorumMet && passedThreshold) {
                    status = 'executed'; // Simulate execution
                } else if (quorumMet && !passedThreshold) {
                    status = 'defeated';
                } else {
                    status = 'defeated'; // Quorum not met
                }

                return { ...p, status, endTime: new Date().toISOString() };
            }
            return p;
        }));
        showNotification('Voting ended for proposal.', 'info');
    };

    return (
        <Card title="Governance Setup" icon={<FaBalanceScale />} className="col-span-2">
            <div className="space-y-6">
                {!currentTokenConfig?.features.governanceModule && (
                    <div className="bg-yellow-800/50 p-4 rounded-lg text-yellow-300 flex items-center space-x-2">
                        <FaExclamationTriangle />
                        <span>Governance module is not enabled for this token in Step 3. Functionality will be limited.</span>
                    </div>
                )}
                <h3 className="text-xl font-semibold text-white">Create New Governance Proposal</h3>
                <ExportedInput
                    label="Proposal Title"
                    value={proposalTitle}
                    onChange={(e) => { setProposalTitle(e.target.value); setErrors(p => ({ ...p, proposalTitle: '' })); }}
                    placeholder="e.g., Implement Buyback Program"
                    error={errors.proposalTitle}
                    disabled={!currentTokenConfig?.features.governanceModule}
                />
                <ExportedTextArea
                    label="Proposal Description"
                    value={proposalDescription}
                    onChange={(e) => { setProposalDescription(e.target.value); setErrors(p => ({ ...p, proposalDescription: '' })); }}
                    rows={5}
                    placeholder="Provide detailed context, pros, cons, and implementation plan for the proposal..."
                    error={errors.proposalDescription}
                    disabled={!currentTokenConfig?.features.governanceModule}
                />
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <ExportedInput
                        label="Voting Duration (Days)"
                        type="number"
                        value={votingDurationDays}
                        onChange={(e) => { setVotingDurationDays(parseInt(e.target.value)); setErrors(p => ({ ...p, votingDurationDays: '' })); }}
                        min="1"
                        error={errors.votingDurationDays}
                        disabled={!currentTokenConfig?.features.governanceModule}
                    />
                    <ExportedInput
                        label="Quorum (%)"
                        type="number"
                        value={quorumPercentage}
                        onChange={(e) => { setQuorumPercentage(parseInt(e.target.value)); setErrors(p => ({ ...p, quorumPercentage: '' })); }}
                        min="1"
                        max="100"
                        error={errors.quorumPercentage}
                        disabled={!currentTokenConfig?.features.governanceModule}
                    />
                    <ExportedInput
                        label="Threshold (%) to Pass"
                        type="number"
                        value={thresholdPercentage}
                        onChange={(e) => { setThresholdPercentage(parseInt(e.target.value)); setErrors(p => ({ ...p, thresholdPercentage: '' })); }}
                        min="1"
                        max="100"
                        error={errors.thresholdPercentage}
                        disabled={!currentTokenConfig?.features.governanceModule}
                    />
                </div>
                <ExportedButton onClick={handleCreateProposal} loading={isLoading} disabled={isLoading || !currentTokenConfig?.features.governanceModule} className="w-full">
                    {isLoading ? 'Creating Proposal...' : 'Create Proposal'}
                </ExportedButton>

                <h3 className="text-xl font-semibold text-white mt-8 pt-6 border-t border-gray-700">Active & Past Proposals</h3>
                {activeGovernanceProposals.length === 0 ? (
                    <p className="text-gray-400">No governance proposals yet.</p>
                ) : (
                    <div className="space-y-4">
                        {activeGovernanceProposals.map(proposal => (
                            <Card key={proposal.id} className="bg-gray-700/50">
                                <div className="flex justify-between items-start mb-2">
                                    <h4 className="font-semibold text-white">{proposal.title}</h4>
                                    <span className={`px-2 py-1 text-xs rounded-full ${
                                        proposal.status === 'active' ? 'bg-green-600' :
                                        proposal.status === 'executed' ? 'bg-blue-600' :
                                        proposal.status === 'defeated' ? 'bg-red-600' :
                                        'bg-gray-600'
                                    } text-white`}>{proposal.status.toUpperCase()}</span>
                                </div>
                                <p className="text-sm text-gray-400 mb-2 max-h-24 overflow-y-auto">{proposal.description}</p>
                                <div className="grid grid-cols-2 gap-2 text-sm text-gray-300">
                                    <p>Proposer: <span className="text-cyan-400 break-all">{proposal.proposer.substring(0, 6)}...</span></p>
                                    <p>Voting Ends: {new Date(proposal.endTime).toLocaleDateString()} {new Date(proposal.endTime).toLocaleTimeString()}</p>
                                    <p>Quorum: {proposal.quorum}%</p>
                                    <p>Threshold: {proposal.threshold}%</p>
                                    <p className="flex items-center"><FaCheckCircle className="text-green-500 mr-1" /> For: {proposal.votesFor.toLocaleString()}</p>
                                    <p className="flex items-center"><FaTimesCircle className="text-red-500 mr-1" /> Against: {proposal.votesAgainst.toLocaleString()}</p>
                                    <p className="flex items-center"><FaBan className="text-yellow-500 mr-1" /> Abstain: {proposal.votesAbstain.toLocaleString()}</p>
                                    <p>Total Votes: {(proposal.votesFor + proposal.votesAgainst + proposal.votesAbstain).toLocaleString()}</p>
                                </div>
                                {proposal.status === 'active' && (
                                    <div className="mt-4 flex space-x-2">
                                        <ExportedButton onClick={() => handleSimulateVote(proposal.id)} icon={<FaVoteYea />}>
                                            Simulate Vote
                                        </ExportedButton>
                                        <ExportedButton onClick={() => handleEndVoting(proposal.id)} variant="secondary" icon={<FaFlag />}>
                                            End Voting Now
                                        </ExportedButton>
                                    </div>
                                )}
                            </Card>
                        ))}
                    </div>
                )}
            </div>
        </Card>
    );
};

export const ExportedAuditAndSecurityReport: React.FC = () => {
    const { currentTokenConfig, deploymentHistory } = useTokenIssuance();
    const latestDeployment = deploymentHistory.find(d => d.status === 'completed');

    const [auditResults, setAuditResults] = useState<{ id: string; type: 'info' | 'warning' | 'critical'; message: string; remediation?: string; }[]>([]);
    const [isLoading, setIsLoading] = useState(false);

    const runSimulatedAudit = async () => {
        setIsLoading(true);
        setAuditResults([]);
        await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate audit duration

        const results: typeof auditResults = [];

        // General checks
        if (!currentTokenConfig?.description) {
            results.push({ id: 'D001', type: 'warning', message: 'Token description is missing. This can impact investor clarity.', remediation: 'Add a comprehensive token description in the token definition step.' });
        }
        if (!currentTokenConfig?.websiteUrl) {
            results.push({ id: 'D002', type: 'warning', message: 'Official website URL is missing. Important for legitimacy and information.', remediation: 'Add an official website URL in the token definition step.' });
        }
        if (!currentTokenConfig?.socialLinks || Object.keys(currentTokenConfig.socialLinks).length === 0) {
            results.push({ id: 'D003', type: 'info', message: 'No social media links provided. Consider adding them for community engagement.', remediation: 'Add relevant social media links in the token definition step.' });
        }

        // ERC-20 specific checks
        if (currentTokenConfig?.type === 'ERC-20') {
            if (currentTokenConfig.totalSupply === 0) {
                results.push({ id: 'T001', type: 'critical', message: 'Total supply is 0. Token will be unusable.', remediation: 'Set a valid total supply in the token definition step.' });
            }
            if (currentTokenConfig.decimals > 18 || currentTokenConfig.decimals < 0) {
                results.push({ id: 'T002', type: 'warning', message: 'Uncommon decimal count. Standard is 18.', remediation: 'Consider setting decimals to 18 for broad compatibility, or justify a different value.' });
            }
            if (currentTokenConfig.features.mintable && latestDeployment?.ownerAddress) {
                results.push({ id: 'F001', type: 'warning', message: 'Mintable token with single owner control. Centralized minting carries risk.', remediation: 'Consider implementing multi-sig for minting or decentralized governance for minting authorization.' });
            }
            if (currentTokenConfig.features.pausable && latestDeployment?.ownerAddress) {
                results.push({ id: 'F002', type: 'warning', message: 'Pausable token with single owner control. Centralized pause/unpause carries risk.', remediation: 'Consider implementing multi-sig for pausing or decentralized governance for pause authorization.' });
            }
            if (currentTokenConfig.features.upgradable && !latestDeployment?.proxyAdminAddress) { // Simplified check
                results.push({ id: 'F003', type: 'critical', message: 'Upgradable contract selected but no proxy admin address defined or recognized. This could lead to a non-upgradable or unmanaged proxy.', remediation: 'Ensure a valid proxy admin address is specified and properly configured for upgradable contracts.' });
            }
            if (currentTokenConfig.features.erc1363 && !currentTokenConfig.features.pausable) {
                 results.push({ id: 'F004', type: 'info', message: 'ERC-1363 is often combined with Pausable to prevent malicious contract interactions during a pause.', remediation: 'Consider enabling Pausable feature for ERC-1363 token for enhanced security.' });
            }
        }

        // Deployment checks
        if (!latestDeployment) {
            results.push({ id: 'D004', type: 'critical', message: 'Token has not been deployed yet. No live contract to audit.', remediation: 'Complete the deployment process to run a full audit.' });
        } else {
            if (latestDeployment.gasPriceStrategy === 'custom' && latestDeployment.customGasPriceGwei && latestDeployment.customGasPriceGwei > 200) { // Arbitrary high value
                results.push({ id: 'D005', type: 'warning', message: 'High custom gas price (over 200 Gwei) used for deployment. Could indicate excessive transaction cost or network congestion.', remediation: 'Review network gas prices before deploying with custom settings.' });
            }
            if (!latestDeployment.frontRunProtection) {
                results.push({ id: 'D006', type: 'info', message: 'Front-run protection was not enabled. While not always critical, it can be beneficial for fair launch and avoiding MEV attacks.', remediation: 'Consider enabling front-run protection for sensitive deployments.' });
            }
            if (latestDeployment.ownerAddress === '0x0000000000000000000000000000000000000000') {
                results.push({ id: 'D007', type: 'critical', message: 'Contract deployed with zero address as owner. This effectively relinquishes ownership, making the contract unmanageable.', remediation: 'Ensure a valid, controlled owner address is set for deployment.' });
            }
        }

        // Tokenomics checks (simplified)
        // NOTE: A real audit would deeply analyze vesting, distribution, etc.
        const totalAllocPercentage = 100; // Assuming it sums to 100 from previous step
        if (totalAllocPercentage !== 100) {
            results.push({ id: 'A001', type: 'critical', message: 'Total allocation percentage is not 100%. This will result in an incorrect token distribution.', remediation: 'Adjust token allocations to sum exactly 100% in the tokenomics step.' });
        }
        if (currentTokenConfig?.type === 'ERC-20' && currentTokenConfig.totalSupply > 10**27) { // Extremely large number for example
            results.push({ id: 'A002', type: 'warning', message: 'Extremely high total supply (e.g., more than 10^27). May lead to precision issues or unexpected behavior in some dApps.', remediation: 'Review and consider reducing total supply or adjusting decimals.' });
        }


        setAuditResults(results);
        setIsLoading(false);
    };

    return (
        <Card title="Audit & Security Report" icon={<FaLock />} className="col-span-2">
            <div className="space-y-6">
                <h3 className="text-xl font-semibold text-white">Simulated Smart Contract Audit</h3>
                <p className="text-gray-400 text-sm">
                    This report provides a simulated security audit and best practice recommendations based on your token configuration and deployment settings.
                    <strong className="text-red-400"> This is NOT a real audit and does not replace professional security assessments.</strong>
                </p>

                <ExportedButton onClick={runSimulatedAudit} loading={isLoading} icon={<FaShieldAlt />}>
                    {isLoading ? 'Running Audit...' : 'Run Simulated Audit'}
                </ExportedButton>

                {auditResults.length > 0 && (
                    <div className="mt-8 pt-6 border-t border-gray-700 space-y-4">
                        <h4 className="text-lg font-semibold text-white">Audit Findings ({auditResults.length} issues)</h4>
                        {auditResults.map(finding => (
                            <div key={finding.id} className={`p-4 rounded-lg border-l-4 ${
                                finding.type === 'critical' ? 'bg-red-800/50 border-red-500' :
                                finding.type === 'warning' ? 'bg-yellow-800/50 border-yellow-500' :
                                'bg-blue-800/50 border-blue-500'
                            } `}>
                                <div className="flex items-center space-x-2 text-sm font-semibold">
                                    {finding.type === 'critical' && <FaExclamationTriangle className="text-red-400" />}
                                    {finding.type === 'warning' && <FaExclamationTriangle className="text-yellow-400" />}
                                    {finding.type === 'info' && <FaInfoCircle className="text-blue-400" />}
                                    <span className="text-gray-200">[{finding.id}] {finding.type.toUpperCase()}:</span>
                                </div>
                                <p className="text-gray-300 mt-2 text-sm">{finding.message}</p>
                                {finding.remediation && (
                                    <p className="text-gray-400 text-xs mt-2"><strong>Remediation:</strong> {finding.remediation}</p>
                                )}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </Card>
    );
};

// --- Main Token Issuance View Component ---

const TokenIssuanceView: React.FC = () => {
    const { aiGeneratedTokenomics, setAiGeneratedTokenomics, isLoading, setIsLoading, showNotification } = useTokenIssuance();
    const [isGeneratorOpen, setGeneratorOpen] = useState(false);
    const [prompt, setPrompt] = useState("a utility token for a decentralized cloud storage network");
    const [currentStep, setCurrentStep] = useState(0);

    const steps = [
        "Token Definition",
        "Tokenomics & Allocation",
        "Contract Configuration",
        "Deployment Settings",
        "Code Review & Compile",
        "Deployment Monitor",
        "Post-Issuance Dashboard",
        // Add more steps for Airdrop, Governance, Audit later as needed, or make them sub-modules of dashboard
    ];

    const handleGenerate = async () => {
        setIsLoading(true);
        setAiGeneratedTokenomics(null);
        try {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY as string });
            // Expanded schema for more detailed tokenomics generation
            const schema = {
                type: Type.OBJECT,
                properties: {
                    name: { type: Type.STRING, description: "Suggestive token name" },
                    symbol: { type: Type.STRING, description: "Suggestive token symbol (2-10 uppercase chars)" },
                    description: { type: Type.STRING, description: "Detailed token purpose and utility" },
                    totalSupply: { type: Type.NUMBER, description: "Total supply of the token" },
                    decimals: { type: Type.NUMBER, description: "Number of decimals, typically 18" },
                    allocation: {
                        type: Type.OBJECT,
                        properties: {
                            team: { type: Type.NUMBER, description: "Percentage for team, e.g., 20" },
                            investors: { type: Type.NUMBER, description: "Percentage for investors (seed, private, public combined), e.g., 30" },
                            ecosystem: { type: Type.NUMBER, description: "Percentage for ecosystem development and grants, e.g., 25" },
                            treasury: { type: Type.NUMBER, description: "Percentage for project treasury, e.g., 15" },
                            marketing: { type: Type.NUMBER, description: "Percentage for marketing and partnerships, e.g., 5" },
                            liquidity: { type: Type.NUMBER, description: "Percentage for initial liquidity provisioning, e.g., 5" },
                        },
                        required: ["team", "investors", "ecosystem", "treasury", "marketing", "liquidity"]
                    },
                    vestingRecommendations: {
                        type: Type.OBJECT,
                        properties: {
                            team: { type: Type.STRING, description: "Vesting recommendation for team, e.g., 3-year linear, 1-year cliff" },
                            investors: { type: Type.STRING, description: "Vesting recommendation for investors, e.g., 2-year linear, 6-month cliff" },
                        }
                    },
                    utilitySuggestions: {
                        type: Type.ARRAY,
                        items: { type: Type.STRING },
                        description: "Key utility features for the token"
                    }
                }
            };
            const fullPrompt = `Generate a detailed tokenomics model in JSON format for this token concept: "${prompt}". Include name, symbol, a detailed description, total supply (realistic number, e.g., 100M-1B), decimals (default 18), and a percentage allocation breakdown for team, investors, ecosystem, treasury, marketing, and liquidity. Ensure total allocation sums to 100%. Also provide vesting recommendations for team and investors, and a few utility suggestions.`;
            const response = await ai.models.generateContent({ model: 'gemini-1.5-flash', contents: [{ text: fullPrompt }], config: { responseMimeType: "application/json", responseSchema: schema } });
            const parsedResponse = JSON.parse(response.text);

            // Ensure allocations sum to 100%, adjust if needed (simple normalization)
            if (parsedResponse.allocation) {
                const totalAllocSum = Object.values(parsedResponse.allocation).reduce((sum: number, val) => sum + (typeof val === 'number' ? val : 0), 0);
                if (totalAllocSum !== 100 && totalAllocSum > 0) {
                    const factor = 100 / totalAllocSum;
                    for (const key in parsedResponse.allocation) {
                        if (typeof parsedResponse.allocation[key] === 'number') {
                            parsedResponse.allocation[key] = Math.round((parsedResponse.allocation[key] as number) * factor * 100) / 100; // Round to 2 decimal places
                        }
                    }
                    showNotification('AI tokenomics allocation adjusted to sum 100%.', 'warning');
                }
            }
            setAiGeneratedTokenomics(parsedResponse);
            setGeneratorOpen(false); // Close generator on success
            showNotification('AI tokenomics model generated successfully!', 'success');

        } catch (error) {
            console.error("AI Generation Error:", error);
            showNotification(`AI generation failed: ${error instanceof Error ? error.message : String(error)}`, 'error');
            setAiGeneratedTokenomics({ error: error instanceof Error ? error.message : String(error) });
        } finally {
            setIsLoading(false);
        }
    };

    const renderStepContent = () => {
        switch (currentStep) {
            case 0: return <ExportedTokenDefinitionForm onNext={() => setCurrentStep(1)} />;
            case 1: return <ExportedTokenomicsAllocationForm onNext={() => setCurrentStep(2)} onPrev={() => setCurrentStep(0)} />;
            case 2: return <ExportedSmartContractConfiguration onNext={() => setCurrentStep(3)} onPrev={() => setCurrentStep(1)} />;
            case 3: return <ExportedDeploymentSettings onNext={() => setCurrentStep(4)} onPrev={() => setCurrentStep(2)} />;
            case 4: return <ExportedSmartContractPreview onNext={() => setCurrentStep(5)} onPrev={() => setCurrentStep(3)} />;
            case 5: return <ExportedDeploymentMonitor onNext={() => setCurrentStep(6)} onPrev={() => setCurrentStep(4)} />;
            case 6: return (
                <>
                    <ExportedPostIssuanceDashboard onPrev={() => setCurrentStep(5)} />
                    <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <ExportedAirdropManager />
                        <ExportedGovernanceSetup />
                        <ExportedAuditAndSecurityReport />
                        {/* Placeholder for other management tools */}
                        <Card title="Token Treasury Management" icon={<FaBriefcase />} className="col-span-1">
                            <p className="text-gray-400 text-sm">
                                Manage the project's token treasury, including fund transfers, budget allocations, and reporting.
                                (Requires integration with a multi-sig or governance-controlled treasury contract).
                            </p>
                            <div className="space-y-3 mt-4">
                                <ExportedInput label="Treasury Balance (Simulated)" value="10,000,000 MCT" disabled />
                                <ExportedInput label="Recipient Address" placeholder="0x..." />
                                <ExportedInput label="Amount to Transfer" type="number" placeholder="e.g., 1000" />
                                <ExportedButton disabled className="w-full" variant="secondary">
                                    Propose Treasury Transfer (TODO)
                                </ExportedButton>
                                <ExportedButton disabled className="w-full" variant="secondary">
                                    View Treasury Reports (TODO)
                                </ExportedButton>
                            </div>
                        </Card>
                        <Card title="Staking & Rewards Management" icon={<FaLock />} className="col-span-1">
                            <p className="text-gray-400 text-sm">
                                Configure and monitor staking pools, distribute rewards, and manage liquidity mining programs.
                            </p>
                            <div className="space-y-3 mt-4">
                                <ExportedInput label="Staking Pool Balance (Simulated)" value="5,000,000 MCT" disabled />
                                <ExportedInput label="Reward Rate (%)" type="number" placeholder="e.g., 10" />
                                <ExportedButton disabled className="w-full" variant="secondary">
                                    Configure Staking Pool (TODO)
                                </ExportedButton>
                                <ExportedButton disabled className="w-full" variant="secondary">
                                    Distribute Rewards (TODO)
                                </ExportedButton>
                            </div>
                        </Card>
                        <Card title="Legal & Compliance" icon={<FaBalanceScale />} className="col-span-1">
                            <p className="text-gray-400 text-sm">
                                Tools and resources to ensure your token adheres to relevant legal and regulatory frameworks.
                                <strong className="text-red-400"> This is critical for real-world applications.</strong>
                            </p>
                            <div className="space-y-3 mt-4">
                                <ExportedCheckbox label="KYC/AML Integration (Simulated)" checked disabled />
                                <ExportedCheckbox label="Accredited Investor Verification (Simulated)" checked disabled />
                                <ExportedButton disabled className="w-full" variant="secondary">
                                    Generate Legal Disclaimers (TODO)
                                </ExportedButton>
                                <ExportedButton disabled className="w-full" variant="secondary">
                                    Security Token Offering (STO) Tools (TODO)
                                </ExportedButton>
                            </div>
                        </Card>
                    </div>
                </>
            );
            default: return <p>Unknown Step</p>;
        }
    };
    
    return (
        <TokenIssuanceProvider>
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h2 className="text-3xl font-bold text-white tracking-wider">Token Issuance Platform</h2>
                    <ExportedButton onClick={() => setGeneratorOpen(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-sm font-medium">AI Tokenomics Modeler</ExportedButton>
                </div>

                <div className="relative">
                    <ExportedProgressBar steps={steps} currentStep={currentStep} />
                </div>

                {renderStepContent()}
            </div>
            {isGeneratorOpen && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setGeneratorOpen(false)}>
                    <div className="bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full border border-gray-700" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-white">AI Tokenomics Modeler</h3>
                            <button onClick={() => setGeneratorOpen(false)} className="text-gray-400 hover:text-white"><FaTimes /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <ExportedTextArea
                                label="Describe your token concept (e.g., utility, industry, target users)..."
                                value={prompt}
                                onChange={e => setPrompt(e.target.value)}
                                placeholder="a utility token for a decentralized cloud storage network"
                                rows={4}
                            />
                            <ExportedButton onClick={handleGenerate} loading={isLoading} className="w-full">
                                {isLoading ? 'Generating...' : 'Generate Model'}
                            </ExportedButton>
                            {aiGeneratedTokenomics && aiGeneratedTokenomics.error && (
                                <Card title="AI Error" className="bg-red-800/50 border-red-700">
                                    <pre className="text-xs text-red-300">{aiGeneratedTokenomics.error}</pre>
                                </Card>
                            )}
                            {aiGeneratedTokenomics && !aiGeneratedTokenomics.error && (
                                <Card title="Generated Tokenomics Preview">
                                    <pre className="text-xs text-gray-300 overflow-auto max-h-60">{JSON.stringify(aiGeneratedTokenomics, null, 2)}</pre>
                                    <p className="mt-2 text-xs text-gray-400">This model will be used to pre-fill the token definition and allocation forms.</p>
                                </Card>
                            )}
                        </div>
                    </div>
                </div>
            )}
        </TokenIssuanceProvider>
    );
};

export default TokenIssuanceView;
