name: Reusable Workflow Steps and Jobs

# This workflow defines a comprehensive collection of reusable GitHub Actions workflow steps and jobs.
# It is designed to promote modularity, reduce duplication, and standardize common CI/CD practices
# across different projects and repositories within an organization.
# This file is intended to be called by other workflows using `uses: owner/repo/.github/workflows/reusable-steps.yml@main`.

on:
  workflow_call:
    # Inputs allow the calling workflow to configure the behavior of these reusable jobs.
    inputs:
      #########################################################################
      #                  General Workflow Configuration                       #
      #########################################################################
      runner-os:
        required: false
        type: string
        default: 'ubuntu-latest'
        description: 'The operating system for the GitHub Actions runner. Options include ubuntu-latest, windows-latest, macos-latest.'
      working-directory:
        required: false
        type: string
        default: '.'
        description: 'The working directory where commands (e.g., npm, docker) will be executed. Defaults to the repository root.'
      github-token:
        required: false
        type: string
        default: ${{ github.token }}
        description: 'GitHub token for actions that require authentication, e.g., actions/checkout, artifact upload. Defaults to the current workflow token.'

      #########################################################################
      #                   Node.js CI Pipeline Configuration                   #
      #########################################################################
      should-run-node-ci:
        required: false
        type: boolean
        default: true
        description: 'Boolean flag to determine if the Node.js CI pipeline job should be executed.'
      node-version:
        required: false
        type: string
        default: '20'
        description: 'Specifies the Node.js version to be used for the Node.js CI pipeline (e.g., 18, 20, 22). Default is 20.'
      npm-cache-dependency-path:
        required: false
        type: string
        default: 'package-lock.json'
        description: 'The dependency file to hash for npm cache. Typically package-lock.json or yarn.lock. Used for caching node_modules.'
      
      should-run-npm-install:
        required: false
        type: boolean
        default: true
        description: 'Boolean flag to determine if `npm ci` should be executed to install dependencies. Default is true.'
      should-run-npm-build:
        required: false
        type: boolean
        default: false
        description: 'Boolean flag to determine if `npm run build` should be executed. Default is false.'
      should-run-npm-test:
        required: false
        type: boolean
        default: true
        description: 'Boolean flag to determine if `npm test` should be executed. Default is true.'
      should-run-npm-lint:
        required: false
        type: boolean
        default: false
        description: 'Boolean flag to determine if `npm run lint` should be executed. Default is false.'
      should-run-npm-audit:
        required: false
        type: boolean
        default: false
        description: 'Boolean flag to determine if `npm audit` should be executed to check for vulnerabilities. Default is false.'
      npm-audit-level:
        required: false
        type: string
        default: 'moderate'
        description: 'Minimum severity level for npm audit (info, low, moderate, high, critical). Defaults to moderate.'

      artifact-upload-path:
        required: false
        type: string
        description: 'Path to upload build artifacts from. Artifact upload is only performed if this input is provided and non-empty.'
      artifact-name:
        required: false
        type: string
        default: 'build-artifacts'
        description: 'Name of the artifact to upload. Defaults to "build-artifacts".'
      artifact-retention-days:
        required: false
        type: number
        default: 7
        description: 'Number of days to retain the uploaded artifact. Defaults to 7 days.'

      #########################################################################
      #                    Docker Build/Push Configuration                    #
      #########################################################################
      should-run-docker-build-and-push:
        required: false
        type: boolean
        default: false
        description: 'Boolean flag to determine if the Docker image build and push job should be executed.'
      docker-image-name:
        required: false
        type: string
        description: 'Name of the Docker image to build and push. Required if should-run-docker-build-and-push is true.'
      docker-image-tag:
        required: false
        type: string
        default: 'latest'
        description: 'Tag for the Docker image. Default is "latest". Multiple tags can be provided, comma-separated.'
      dockerfile-path:
        required: false
        type: string
        default: './Dockerfile'
        description: 'Path to the Dockerfile relative to the working directory. Default is "./Dockerfile".'
      docker-build-context:
        required: false
        type: string
        default: '.'
        description: 'Build context path for the Docker image relative to the working directory. Default is ".". '
      docker-registry-username:
        required: false
        type: string
        description: 'Username for the Docker registry. Can be passed directly or via a GitHub secret (e.g., secrets.DOCKER_USERNAME).'
      docker-registry-password:
        required: false
        type: string
        description: 'Password or Access Token for the Docker registry. Can be passed directly or via a GitHub secret (e.g., secrets.DOCKER_TOKEN).'

      #########################################################################
      #                       Notification Configuration                      #
      #########################################################################
      should-send-notification:
        required: false
        type: boolean
        default: false
        description: 'Boolean flag to determine if a notification job should be executed after workflow completion.'
      notification-webhook-url:
        required: false
        type: string
        description: 'Webhook URL for sending notifications (e.g., Slack, Microsoft Teams). Required if should-send-notification is true.'
      notification-custom-message:
        required: false
        type: string
        default: "CI/CD Workflow Update"
        description: 'Custom introductory message for the notification. This will be prepended to the default message.'
      notify-on-success:
        required: false
        type: boolean
        default: true
        description: 'Send notification if the overall workflow completes successfully. Only applicable if should-send-notification is true.'
      notify-on-failure:
        required: false
        type: boolean
        default: true
        description: 'Send notification if the overall workflow fails. Only applicable if should-send-notification is true.'
      notify-on-cancelled:
        required: false
        type: boolean
        default: false
        description: 'Send notification if the overall workflow is cancelled. Only applicable if should-send-notification is true.'

    # Outputs allow the calling workflow to receive information back from these reusable jobs.
    outputs:
      ci-pipeline-status:
        description: "The overall outcome of the Node.js CI pipeline job (success, failure, cancelled, skipped)."
        value: ${{ jobs.node_ci_pipeline.outputs.job_result }}
      ci-tests-passed:
        description: "Boolean indicating if the test step executed successfully within the CI pipeline."
        value: ${{ jobs.node_ci_pipeline.outputs.test_success }}
      ci-build-success:
        description: "Boolean indicating if the build step executed successfully within the CI pipeline."
        value: ${{ jobs.node_ci_pipeline.outputs.build_success }}
      ci-artifacts-uploaded-status:
        description: "Boolean indicating if build artifacts were successfully uploaded from the CI pipeline."
        value: ${{ jobs.node_ci_pipeline.outputs.artifacts_uploaded }}
      docker-image-pushed-status:
        description: "Boolean indicating if the Docker image was successfully built and pushed."
        value: ${{ jobs.docker_build_and_push.outputs.docker_push_success }}
      notification-sent:
        description: "Boolean indicating if a notification was attempted to be sent."
        value: ${{ jobs.send_workflow_notification.outputs.notification_attempted }}

jobs:
  #############################################################################
  #                         Node.js CI Pipeline Job                           #
  #############################################################################
  node_ci_pipeline:
    name: 'Node.js CI Pipeline'
    runs-on: ${{ inputs.runner-os }}
    if: ${{ inputs.should-run-node-ci }} # Only run if explicitly enabled
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      job_result: ${{ steps.pipeline_final_status.outcome }} # Overall job outcome
      test_success: ${{ steps.run_tests_step.outcome == 'success' }}
      build_success: ${{ steps.run_build_step.outcome == 'success' }}
      artifacts_uploaded: ${{ steps.upload_build_artifacts_step.outcome == 'success' }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.github-token }}
      # This step ensures that the workflow has access to the repository code
      # which is essential for any build or test process.

    - name: Set up Node.js Environment (${{ inputs.node-version }})
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm' # Configures npm caching to speed up dependency installation.
        cache-dependency-path: ${{ inputs.npm-cache-dependency-path }}
      # Configures the specified Node.js version and sets up npm caching
      # to significantly reduce build times by reusing installed dependencies.

    - name: Display Node.js and npm versions
      run: |
        echo "Node.js version: $(node -v)"
        echo "npm version: $(npm -v)"
      # Provides clarity on the exact Node.js and npm environment being used
      # for debugging and reproducibility.

    - name: Install Dependencies with npm ci
      id: install_dependencies_step
      if: ${{ inputs.should-run-npm-install }}
      run: |
        npm ci # `npm ci` is preferred over `npm install` in CI for speed and reliability.
               # It ensures a clean install based strictly on package-lock.json.
      env:
        # Example: if you have private npm registries, you might need to pass a token.
        # This assumes a token might be passed as github-token if it's a GitHub Packages registry.
        NODE_AUTH_TOKEN: ${{ inputs.github-token }}
      # Installs all project dependencies. This step is crucial for ensuring
      # all required libraries are available for subsequent build and test stages.

    - name: Run Linters
      id: run_lint_step
      if: ${{ inputs.should-run-npm-lint }}
      run: |
        npm run lint || true # `|| true` allows linting failures to not block the pipeline.
                             # For stricter CI, remove `|| true` to fail on lint errors.
      # Executes linting checks to enforce code quality, style consistency,
      # and identify potential programming errors early in the development cycle.

    - name: Run Build Command
      id: run_build_step
      if: ${{ inputs.should-run-npm-build }}
      run: |
        npm run build
      # Executes the project's build script, typically compiling source code
      # into a distributable format (e.g., JavaScript bundles, executables).

    - name: Run Tests
      id: run_tests_step
      if: ${{ inputs.should-run-npm-test }}
      run: |
        npm test
      # Runs automated tests to verify the correctness, functionality,
      # and integrity of the code changes. Essential for quality assurance.

    - name: Perform Security Audit
      id: run_audit_step
      if: ${{ inputs.should-run-npm-audit }}
      run: |
        npm audit --audit-level=${{ inputs.npm-audit-level }}
      # Checks for known vulnerabilities in project dependencies.
      # The audit level can be configured to focus on more severe issues.

    - name: Upload Build Artifacts
      id: upload_build_artifacts_step
      if: ${{ inputs.artifact-upload-path != '' && inputs.artifact-upload-path != null }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.artifact-upload-path }}
        retention-days: ${{ inputs.artifact-retention-days }}
      # Uploads specified files or directories as workflow artifacts.
      # These artifacts can be downloaded and used by subsequent jobs, workflows,
      # or by users for deployment and debugging.

    - name: Final CI Pipeline Status Capture
      id: pipeline_final_status
      run: echo "CI pipeline job finished."
      # A symbolic step to explicitly capture the overall outcome of this job,
      # which is then exposed as a workflow output.

  #############################################################################
  #                     Docker Build and Push Job                             #
  #############################################################################
  docker_build_and_push:
    name: 'Docker Build and Push Image'
    runs-on: ${{ inputs.runner-os }}
    needs: node_ci_pipeline # This job depends on the CI pipeline finishing.
    # The 'if' condition ensures this job runs only if enabled and
    # if the previous Node.js CI job either succeeded or was skipped.
    if: |
      ${{ inputs.should-run-docker-build-and-push && (needs.node_ci_pipeline.result == 'success' || needs.node_ci_pipeline.result == 'skipped') }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      docker_push_success: ${{ steps.build_and_push_image_step.outcome == 'success' }}

    steps:
    - name: Checkout Repository for Docker Build
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.github-token }}
      # Ensures that the Docker build process has access to the repository files.

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      # Sets up Docker Buildx, an extension to Docker for enhanced image building capabilities,
      # including multi-platform builds and caching.

    - name: Log in to Docker Registry
      id: login_docker_registry_step
      uses: docker/login-action@v3
      with:
        username: ${{ inputs.docker-registry-username }}
        password: ${{ inputs.docker-registry-password }}
      if: ${{ inputs.docker-registry-username != '' && inputs.docker-registry-password != '' }}
      # Authenticates with the specified Docker registry (e.g., Docker Hub, GitHub Container Registry)
      # using provided credentials, allowing images to be pushed.

    - name: Build and Push Docker Image
      id: build_and_push_image_step
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.docker-build-context }}
        file: ${{ inputs.dockerfile-path }}
        push: true # Set to true to push the image to the registry.
        tags: ${{ inputs.docker-image-name }}:${{ inputs.docker-image-tag }}
        cache-from: type=gha # Leverages GitHub Actions cache for Docker layers to speed up builds.
        cache-to: type=gha,mode=max # Stores new Docker layers in the GHA cache.
      # Builds the Docker image based on the Dockerfile and context, then pushes
      # it to the authenticated Docker registry.

  #############################################################################
  #                        Send Workflow Notification Job                     #
  #############################################################################
  send_workflow_notification:
    name: 'Send Workflow Status Notification'
    runs-on: ubuntu-latest
    needs: [node_ci_pipeline, docker_build_and_push] # This job depends on all previous jobs completing.
    if: ${{ always() && inputs.should-send-notification }} # Always run this job if notifications are enabled.
    outputs:
      notification_attempted: ${{ steps.send_notification_step.outcome != 'skipped' }} # True if notification was attempted.

    steps:
    - name: Determine Overall Workflow Status
      id: workflow_status_check
      run: |
        # Determine the individual results of the jobs this notification depends on.
        CI_PIPELINE_RESULT="${{ needs.node_ci_pipeline.result }}"
        DOCKER_BUILD_RESULT="${{ needs.docker_build_and_push.result }}"
        
        # Initialize overall status and details.
        OVERALL_STATUS="unknown"
        STATUS_EMOJI=":question:"
        STATUS_COLOR="#d3d3d3" # Light Grey

        # Logic to determine the overall workflow status for a meaningful notification.
        # This considers success only if all enabled preceding jobs succeeded.
        # Failure if any enabled job failed.
        # Cancelled if any enabled job was cancelled.
        if [ "$CI_PIPELINE_RESULT" == "failure" ] || [ "$DOCKER_BUILD_RESULT" == "failure" ]; then
          OVERALL_STATUS="failure"
          STATUS_EMOJI=":x:"
          STATUS_COLOR="#cb2431" # Red
        elif [ "$CI_PIPELINE_RESULT" == "cancelled" ] || [ "$DOCKER_BUILD_RESULT" == "cancelled" ]; then
          OVERALL_STATUS="cancelled"
          STATUS_EMOJI=":no_entry_sign:"
          STATUS_COLOR="#6a737d" # Grey
        elif [ "$CI_PIPELINE_RESULT" == "success" ] && [ "$DOCKER_BUILD_RESULT" == "success" ]; then
          OVERALL_STATUS="success"
          STATUS_EMOJI=":white_check_mark:"
          STATUS_COLOR="#28a745" # Green
        elif [ "$CI_PIPELINE_RESULT" == "success" ] && [ "$DOCKER_BUILD_RESULT" == "skipped" ]; then
          OVERALL_STATUS="success" # Docker build was skipped but CI succeeded.
          STATUS_EMOJI=":white_check_mark:"
          STATUS_COLOR="#28a745" # Green
        elif [ "$CI_PIPELINE_RESULT" == "skipped" ] && [ "$DOCKER_BUILD_RESULT" == "success" ]; then
          OVERALL_STATUS="success" # CI was skipped but Docker build succeeded.
          STATUS_EMOJI=":white_check_mark:"
          STATUS_COLOR="#28a745" # Green
        elif [ "$CI_PIPELINE_RESULT" == "skipped" ] && [ "$DOCKER_BUILD_RESULT" == "skipped" ]; then
          OVERALL_STATUS="skipped" # All relevant jobs were skipped.
          STATUS_EMOJI=":fast_forward:"
          STATUS_COLOR="#f6bf00" # Yellow/Orange
        else
          OVERALL_STATUS="unknown"
          STATUS_EMOJI=":question:"
          STATUS_COLOR="#d3d3d3" # Light Grey
        fi

        # Output the determined status for subsequent steps.
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
        echo "status_color=$STATUS_COLOR" >> $GITHUB_OUTPUT
        echo "ci_pipeline_result=$CI_PIPELINE_RESULT" >> $GITHUB_OUTPUT
        echo "docker_build_result=$DOCKER_BUILD_RESULT" >> $GITHUB_OUTPUT
      # This step aggregates the outcomes of all preceding jobs to determine
      # an overall status for the workflow run, which is then used to craft
      # a relevant notification message.

    - name: Send Notification (e.g., to Slack/Teams)
      id: send_notification_step
      # Conditional check to send notification based on overall status and user preferences.
      if: |
        (steps.workflow_status_check.outputs.overall_status == 'success' && inputs.notify-on-success) ||
        (steps.workflow_status_check.outputs.overall_status == 'failure' && inputs.notify-on-failure) ||
        (steps.workflow_status_check.outputs.overall_status == 'cancelled' && inputs.notify-on-cancelled)
      uses: slackapi/slack-github-action@v1.24.0 # Using Slack action as an example.
      # For Microsoft Teams, a different action or custom script would be required,
      # typically using a general HTTP POST action.
      with:
        webhook-url: ${{ inputs.notification-webhook-url }}
        payload: |
          {
            "text": "${{ inputs.notification-custom-message }} - Workflow Run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}> for *${{ github.repository }}* branch *${{ github.ref_name }}*",
            "attachments": [
              {
                "color": "${{ steps.workflow_status_check.outputs.status_color }}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Workflow:* `${{ github.workflow }}` ${{ steps.workflow_status_check.outputs.status_emoji }}\n" +
                              "*Overall Status:* `${{ steps.workflow_status_check.outputs.overall_status }}`\n" +
                              "*Triggered by:* `${{ github.actor }}`\n" +
                              "*CI Pipeline Result:* `${{ steps.workflow_status_check.outputs.ci_pipeline_result }}`\n" +
                              "*Docker Build Result:* `${{ steps.workflow_status_check.outputs.docker_build_result }}`\n" +
                              "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run Details>"
                    }
                  }
                ]
              }
            ]
          }
      env:
        # It's good practice to also set the webhook URL as an environment variable for the action.
        SLACK_WEBHOOK_URL: ${{ inputs.notification-webhook-url }}
      # Sends a formatted notification message to a configured communication channel (e.g., Slack),
      # providing a quick summary of the workflow's execution status and a link to the run details.