name: Auto Update Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC

jobs:
  auto-update:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [ 22 ]

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT_FOR_WORKFLOWS }} # Requires a PAT with 'repo' scope

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Dependencies
      run: npm install

    - name: Try to Update Dependencies
      id: update_deps
      run: |
        npm update
        git diff --quiet || echo "::set-output name=changes_made::true"

    - name: Configure Git User
      if: steps.update_deps.outputs.changes_made == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Create New Branch
      id: create_branch
      if: steps.update_deps.outputs.changes_made == 'true'
      run: |
        BRANCH_NAME="auto-update-deps/$(date +'%Y-%m-%d-%H%M%S')"
        git checkout -b "$BRANCH_NAME"
        echo "::set-output name=branch_name::$BRANCH_NAME"

    - name: Commit Changes
      if: steps.update_deps.outputs.changes_made == 'true'
      run: |
        git add package.json package-lock.json
        git commit -m "chore(deps): auto-update dependencies"

    - name: Push Changes
      if: steps.update_deps.outputs.changes_made == 'true'
      run: |
        git push origin ${{ steps.create_branch.outputs.branch_name }}

    - name: Open Pull Request
      if: steps.update_deps.outputs.changes_made == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GH_PAT_FOR_WORKFLOWS }}
        commit-message: "chore(deps): auto-update dependencies"
        title: "chore(deps): Auto-update dependencies"
        body: |
          This PR was automatically generated by the 'Auto Update Dependencies' workflow.
          
          It updates project dependencies to their latest compatible versions.
          Please review the changes and merge if everything looks good.
          
          ðŸ¤– Dependency update bot
        branch: ${{ steps.create_branch.outputs.branch_name }}
        base: main
        labels: |
          dependencies
          automated pr
        draft: false
        reviewers: # Optional: Add your team's reviewers here, e.g., 'your-username'