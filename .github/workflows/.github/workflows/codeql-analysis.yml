name: CodeQL

# Controls when the workflow will run.
on:
  push:
    branches: [ "main" ] # Trigger on push to the main branch
  pull_request:
    branches: [ "main" ] # Trigger on pull requests targeting the main branch
  schedule:
    # Run CodeQL analysis once a week on Sunday at 03:00 UTC.
    # This helps catch issues that might have been missed by push/PR triggers,
    # or detect new vulnerabilities introduced by updates to dependencies.
    - cron: '0 3 * * SUN'
  workflow_dispatch: # Allows manual triggering of the workflow from the GitHub UI

jobs:
  analyze:
    name: Analyze
    # Configure the runner environment for the job.
    # `ubuntu-latest` is a standard and recommended runner for CodeQL analysis.
    runs-on: ubuntu-latest

    # Permissions required for the CodeQL workflow.
    # `contents: read` is needed to checkout the repository code for analysis.
    # `security-events: write` is required to upload the CodeQL SARIF (Static Analysis Results Interchange Format)
    # results to GitHub's Security tab, where vulnerabilities and alerts can be reviewed.
    permissions:
      contents: read
      security-events: write
      # Optionally, if your workflow uses other actions that require specific permissions,
      # such as modifying issues or creating releases, you would add them here.
      # For a standard CodeQL setup, 'contents: read' and 'security-events: write' are sufficient.

    # Strategy defines a matrix for running the job with different configurations.
    # This allows analyzing multiple languages or using different CodeQL CLI versions within a single workflow run.
    strategy:
      fail-fast: false # Do not cancel other matrix jobs if one fails; allow all analyses to complete independently.
      matrix:
        # Define the languages to analyze. CodeQL supports a wide range of programming languages.
        # Based on the seed file suggesting a Node.js project, 'javascript' is the primary language.
        # If your repository contains code written in multiple languages, list them here.
        # Example for a multi-language repository:
        # language: [ 'javascript', 'python', 'go', 'java', 'csharp', 'cpp', 'ruby', 'swift' ]
        language: [ 'javascript' ]

        # You can add other matrix dimensions for advanced use cases, for example:
        # cli_version: [ 'latest', '2.14.6' ] # To test against different CodeQL CLI versions.
        # query_suite: [ 'default', 'security-extended' ] # To run different sets of queries.

    steps:
    - name: Checkout repository
      # Uses the GitHub Actions 'checkout' action to fetch the repository code.
      # This is a fundamental first step in almost all GitHub Actions workflows.
      uses: actions/checkout@v4
      with:
        # Fetch entire history for more accurate analysis.
        # For deep static analysis like CodeQL, fetching full history (`fetch-depth: 0`)
        # provides more context for data flow analysis and historical tracking of issues.
        fetch-depth: 0

    - name: Initialize CodeQL
      # This step initializes the CodeQL toolchain and creates a CodeQL database.
      # The `languages` parameter specifies which languages' source code to prepare for analysis.
      # This involves downloading the necessary CodeQL CLI and language-specific extractors.
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # Query packs can be specified here to run custom queries or predefined query suites.
        # Example: `packs: github/codeql-javascript-queries/security-extended`
        # Example: `queries: +security-and-quality` to run all default security and quality queries.
        # Example: `queries: +security-extended` for a more extensive set of security queries.
        # Refer to CodeQL documentation for available query packs and suites:
        # https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#specifying-which-queries-to-run

        # A custom CodeQL configuration file (`codeql-config.yml`) can be used to manage
        # queries, packs, exclusions, and other advanced settings for your analysis.
        # Example: `config-file: ./.github/codeql/codeql-config.yml`
        # Learn more about custom configurations:
        # https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-a-custom-configuration-file

    # For compiled languages (e.g., Java, C++, C#, Go), this step attempts to automatically build the project.
    # CodeQL monitors the build process to extract comprehensive data flow and semantic information from the code.
    # For interpreted languages (e.g., JavaScript, Python, Ruby), this step might be a no-op or
    # is less critical if the analysis doesn't depend on a 'build' step producing compile artifacts.
    # If your project has a custom or complex build process (e.g., `npm run build`, `webpack`),
    # you should replace or supplement this `autobuild` step with your specific build commands.
    # These custom build commands must be placed *after* `Initialize CodeQL` and *before* `Perform CodeQL Analysis`.
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
      # Example of custom build commands for a JavaScript project if autobuild isn't sufficient:
      # run: |
      #   echo "Running custom build commands for JavaScript..."
      #   npm install --prefer-offline --no-audit
      #   npm run build --if-present # Only run if a 'build' script is defined in package.json
      #   # Add any other build or transpilation steps necessary for your project to be fully prepared for analysis.

    - name: Perform CodeQL Analysis
      # This step performs the actual CodeQL analysis on the database created in the 'Initialize CodeQL' step.
      # It runs the configured queries against the database to find vulnerabilities and coding errors.
      # After analysis, it generates SARIF results and uploads them to GitHub's Security tab.
      uses: github/codeql-action/analyze@v3
      with:
        # The `category` parameter can be used to differentiate analysis results if multiple CodeQL workflows
        # run on the same repository with different configurations (e.g., different languages or query suites).
        # Example: `category: "/language:${{ matrix.language }}"`
        # This helps in filtering and managing alerts in the Security tab.
        # Learn more: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-a-category-to-differentiate-multiple-codeql-analyses-for-the-same-language

    # Additional steps can be added here for further processing or notifications.
    # For example:
    # - name: Post-analysis actions
    #   if: always() # Run this step regardless of previous step success/failure
    #   run: |
    #     echo "CodeQL analysis workflow completed."
    #     echo "Check the 'Security' tab > 'Code scanning alerts' for detailed results."
    #     # You could integrate with other tools here, e.g., send a notification to a Slack channel
    #     # if new critical alerts are found, or open issues for specific types of findings.
    #     # Example for notification on failure:
    #     # if: failure()
    #     # uses: some-github-action/slack-notification@v1
    #     # with:
    #     #   message: "CodeQL analysis failed for ${{ github.repository }} on branch ${{ github.ref_name }}"
