name: Create Flaky Test Issue

on:
  workflow_run:
    # Trigger this workflow when the 'Rerun Flaky Tests' workflow completes.
    # This allows us to react to the outcome of the flaky test detection.
    workflows: ["Rerun Flaky Tests"] # Refers to the 'name' of the workflow defined in test-flaky-rerun.yml
    types:
      - completed # We only care about the run finishing, successfully or not (checked later).

jobs:
  create_flaky_issue:
    runs-on: ubuntu-latest
    # This job will only run if the 'Rerun Flaky Tests' workflow completed successfully.
    # A successful completion of 'Rerun Flaky Tests' implies that the tests eventually passed
    # after retries, which is indicative of flakiness as per its logic in the seed file.
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      # Although not strictly necessary for creating an issue, checking out
      # is a common first step in most workflows and good practice.
      uses: actions/checkout@v4

    - name: Prepare workflow run details for issue creation
      id: prepare_details
      run: |
        # Extract relevant details from the triggering workflow_run event
        # These will be used in the issue title and body to provide context
        # about where and when the flakiness was detected.
        echo "RERUN_WORKFLOW_URL=${{ github.event.workflow_run.html_url }}" >> "$GITHUB_ENV"
        echo "RERUN_WORKFLOW_ID=${{ github.event.workflow_run.id }}" >> "$GITHUB_ENV"
        echo "RERUN_WORKFLOW_BRANCH=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_ENV"
        echo "RERUN_WORKFLOW_COMMIT_SHA=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_ENV"
        echo "RERUN_WORKFLOW_TRIGGERER=${{ github.event.workflow_run.triggering_actor.login }}" >> "$GITHUB_ENV"
        # The timestamp of when the triggering workflow run was updated (finished).
        echo "RERUN_WORKFLOW_UPDATED_AT=${{ github.event.workflow_run.updated_at }}" >> "$GITHUB_ENV"

    - name: Create new GitHub Issue for flaky test
      # Uses a third-party action to create a new issue.
      # This action is chosen for its simplicity and direct functionality for issue management.
      uses: peter-evans/create-or-update-issue@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        # The issue title identifies the specific flaky test pattern (as defined in the rerun workflow)
        # and includes the ID of the workflow run that detected the flakiness.
        # This helps in tracking individual instances of flakiness detection.
        title: 'Flaky Test Detected: `flaky-tests/.*.test.js` (Run #${{ env.RERUN_WORKFLOW_ID }})'
        body: |
          A flaky test has been consistently detected in the pattern `flaky-tests/.*.test.js`.
          
          The `Rerun Flaky Tests` workflow completed successfully after retries,
          which indicates the test eventually passed but is prone to intermittent failures.
          
          **Details of the Flaky Detection Run:**
          - **Timestamp:** `${{ env.RERUN_WORKFLOW_UPDATED_AT }}`
          - **Workflow Run:** [Link to Run](${{ env.RERUN_WORKFLOW_URL }})
          - **Branch:** `${{ env.RERUN_WORKFLOW_BRANCH }}`
          - **Commit SHA:** `${{ env.RERUN_WORKFLOW_COMMIT_SHA }}`
          - **Triggered by:** `@${{ env.RERUN_WORKFLOW_TRIGGERER }}`
          
          ---
          
          **Action Required:**
          Please investigate the root cause of this flakiness.
          Possible causes include:
          - Race conditions or timing issues
          - External service dependencies or network instability
          - Environment inconsistencies between runs
          - Improper test setup/teardown causing residual state
          - Unreliable assertions or test data
        labels: |
          bug
          flaky-test
          investigation-required
        assignees: |
          # Add GitHub usernames here to automatically assign to individuals or a team
          # responsible for test maintenance or incident response.
          # For example: your-github-username
          # This can be configured based on project team structure or expertise.