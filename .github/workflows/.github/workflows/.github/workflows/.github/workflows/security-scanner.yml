name: Security Scanner

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  codeql_analysis:
    name: CodeQL Static Analysis
    runs-on: ubuntu-latest

    permissions:
      security-events: write # Required to upload SARIF results to GitHub Security tab
      contents: read         # Required to checkout the repository

    steps:
    - uses: actions/checkout@v4

    # Initializes the CodeQL Action.
    # This step checks out the repository and initializes the CodeQL environment.
    # For a multi-language codebase, you can specify a list of languages.
    # Refer to https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#specifying-languages-and-configurations
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        # Assuming a JavaScript/TypeScript project based on the Node.js context from the seed file.
        # Adjust 'languages' as per your project's primary development languages.
        languages: javascript

    # If your project requires a specific build process for CodeQL to analyze,
    # specify the build step here. For interpreted languages like JavaScript,
    # this step is often not strictly required unless there's a complex build
    # that generates code CodeQL should analyze (e.g., transpilation).
    # - name: Autobuild (optional for compiled languages)
    #   uses: github/codeql-action/autobuild@v3

    # Performs the CodeQL analysis and uploads the generated SARIF results to GitHub.
    # These results will be visible in the Security tab of your repository.
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      # Optionally, you can specify configurations or queries here to customize the analysis.
      # Example: with:
      #            category: "/language:javascript"


  dependency_vulnerability_scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read # Required to checkout the repository

    strategy:
      matrix:
        node-version: [ 22 ] # Consistent with the Node.js version used in the code-smell-analyzer workflow

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm' # Caches npm dependencies to speed up subsequent runs

    - name: Install dependencies
      run: npm install

    - name: Run npm audit for known vulnerabilities
      # npm audit checks for known vulnerabilities in your project's dependencies
      # against the npm public registry.
      # The '--audit-level=high' flag reports issues with a high or critical severity.
      # If high or critical vulnerabilities are found, this step will cause the
      # workflow to fail, indicating that immediate action is required.
      run: npm audit --audit-level=high

    # Optional: Integrate other dependency scanning tools for a more comprehensive approach.
    # For example, Snyk provides more in-depth analysis, context, and remediation advice.
    # - name: Run Snyk for comprehensive dependency scanning
    #   uses: snyk/actions/node@master
    #   env:
    #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }} # Ensure SNYK_TOKEN is configured as a repository secret
    #   with:
    #     args: --all-projects --fail-on=high # Fail the build on high severity issues detected by Snyk