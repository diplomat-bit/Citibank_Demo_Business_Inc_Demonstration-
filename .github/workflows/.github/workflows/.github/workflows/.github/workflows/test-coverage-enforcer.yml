name: Test Coverage Enforcer

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  enforce_coverage:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [ 22 ]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run unit tests and calculate code coverage
      # This step executes the project's unit tests and generates a code coverage report.
      # It typically involves a script defined in `package.json` (e.g., "test:coverage")
      # or a direct command to your test runner (e.g., Jest, Vitest, Mocha, Karma)
      # configured to output coverage information.
      #
      # Common commands include:
      # - `npm test -- --coverage`: For Jest, where `--coverage` flag enables coverage collection.
      # - `npm run test:coverage`: If a dedicated script is defined in `package.json` like `"test:coverage": "jest --coverage"`.
      # - `npx nyc mocha`: Using the `nyc` (Istanbul) wrapper for Mocha or other test runners.
      #
      # Ensure your test runner is configured to output coverage reports in a format
      # like LCOV, Cobertura, or JSON, as these can be used by subsequent steps or actions.
      # The `--coverage` flag or equivalent setup should ensure these reports are generated.
      run: npm test -- --coverage

    - name: Enforce minimum code coverage threshold
      # This step enforces a minimum code coverage threshold.
      # In many modern JavaScript testing frameworks (e.g., Jest, Vitest) and coverage tools (e.g., nyc),
      # thresholds can be configured directly in their configuration files (e.g., `jest.config.js`, `.nycrc`)
      # or in `package.json`.
      #
      # When configured, the test command executed in the previous step (`npm test -- --coverage`)
      # will automatically fail if the actual code coverage falls below the specified percentages
      # for statements, branches, functions, or lines.
      #
      # Therefore, if this step is reached, it implies that the previous "Run unit tests and calculate code coverage"
      # step completed successfully, meaning the coverage thresholds were met (or no thresholds were configured to fail the build).
      #
      # If you need to enforce thresholds without relying on the test runner's built-in features,
      # or if you want to explicitly check a generated report, you can use:
      # 1. A dedicated GitHub Action for coverage checking (e.g., `codecov/codecov-action` with `fail_ci_if_error: true`).
      # 2. A custom shell script that parses the coverage report (e.g., `lcov.info`) and exits with a non-zero code
      #    if thresholds are not met.
      #
      # For this workflow, we assume thresholds are configured within the test runner's setup,
      # and the `npm test -- --coverage` command will handle the enforcement by failing the job directly.
      # If the previous step succeeds, this step effectively confirms the coverage passed the configured checks.
      run: echo "Code coverage thresholds are enforced by the test runner configuration. If this step is reached, thresholds were met."