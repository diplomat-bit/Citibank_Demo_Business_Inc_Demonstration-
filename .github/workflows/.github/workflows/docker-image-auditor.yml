name: Docker Image Auditor

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker Image
      run: |
        # Assume Dockerfile is in the root of the repository
        # Tag the image for easier reference in subsequent steps
        docker build -t app-image .

    - name: Scan Docker Image for Vulnerabilities
      uses: aquasecurity/trivy-action@v0.20.0
      with:
        image-ref: 'app-image'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        # Exit code 1 if vulnerabilities of specified severity are found,
        # otherwise exit code 0. This makes the job fail on high-severity findings.
        exit-code: '1'

    - name: Upload Trivy SARIF results to GitHub Security tab
      # This step will run even if the previous step failed due to found vulnerabilities,
      # ensuring the results are always uploaded for review.
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
        # The upload will automatically link to the correct commit/PR context.