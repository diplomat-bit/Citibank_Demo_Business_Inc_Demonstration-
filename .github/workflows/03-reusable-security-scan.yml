# === Reusable Security Workflow ===
# This is a REUSABLE workflow. It can be called by other workflows.
# It encapsulates all standard security scanning logic, ensuring that
# every service is scanned consistently.

name: 'Reusable: Security Scan'

on:
  workflow_call:
    inputs:
      service-path:
        description: 'The path to the service to scan'
        required: true
        type: string
      docker-image-name:
        description: 'The name of the Docker image to scan (if applicable)'
        required: false
        type: string

jobs:
  security-analysis:
    name: 'Security Analysis'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # 1. Static Application Security Testing (SAST) with CodeQL
      - name: 'Initialize CodeQL'
        uses: github/codeql-action/init@v3
        with:
          languages: go, javascript # Add other languages as needed

      - name: 'Perform CodeQL Analysis'
        uses: github/codeql-action/analyze@v3

      # 2. Dependency Scanning with Snyk
      - name: 'Run Snyk to check for vulnerabilities'
        uses: snyk/actions/golang@master
        continue-on-error: true # Don't fail the build, just report
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --file=${{ inputs.service-path }}/go.mod

      # 3. Container Image Scanning with Trivy (if image name is provided)
      - name: 'Scan Container Image'
        if: ${{ inputs.docker-image-name != '' }}
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ inputs.docker-image-name }}
          format: 'table'
          exit-code: '0' # Don't fail build, just log vulnerabilities
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
