name: Security Vulnerability Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Run once a week on Sunday at 3:00 AM UTC
    - cron: '0 3 * * SUN'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [ 22 ]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm install

    - name: Perform Audit for Security Vulnerabilities
      id: npm_audit_scan
      run: |
        # Run npm audit to check for vulnerabilities
        # Using --json to easily parse output and --production to only scan production dependencies
        # Exclude 'npm audit fix' as it might introduce breaking changes without proper review.
        NPM_AUDIT_OUTPUT=$(npm audit --json --production || true)
        
        echo "$NPM_AUDIT_OUTPUT" > npm-audit-report.json
        
        # Check if the audit found any vulnerabilities.
        # The 'npm audit' command itself exits with a non-zero status if vulnerabilities are found,
        # but we captured its output even on failure with '|| true'.
        # Now we parse the JSON output to determine if there are actual advisories.
        VULNERABILITIES_FOUND=$(echo "$NPM_AUDIT_OUTPUT" | jq '.metadata.vulnerabilities | del(.info) | map_values(.) | add')
        
        echo "Total vulnerabilities found: $VULNERABILITIES_FOUND"
        
        if [ "$VULNERABILITIES_FOUND" -gt 0 ]; then
          echo "::error::Security vulnerabilities detected. Please review 'npm-audit-report.json' and take action."
          echo "::notice file=npm-audit-report.json::Security vulnerabilities found. See report for details."
          echo "VULNERABILITIES_DETECTED=true" >> "$GITHUB_OUTPUT"
          # Optionally, fail the workflow. For now, just report.
          # exit 1
        else
          echo "No security vulnerabilities detected."
          echo "VULNERABILITIES_DETECTED=false" >> "$GITHUB_OUTPUT"
        fi
      shell: bash

    - name: Upload Security Report
      if: always() && steps.npm_audit_scan.outputs.VULNERABILITIES_DETECTED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit-report
        path: npm-audit-report.json
        retention-days: 7

    - name: Check for Trivy installation
      id: check_trivy
      run: |
        if command -v trivy &> /dev/null; then
          echo "Trivy is already installed."
          echo "TRIVY_INSTALLED=true" >> "$GITHUB_OUTPUT"
        else
          echo "Trivy not found. Will proceed with installation."
          echo "TRIVY_INSTALLED=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Install Trivy
      if: steps.check_trivy.outputs.TRIVY_INSTALLED == 'false'
      run: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy

    - name: Scan Project with Trivy
      id: trivy_scan
      run: |
        TRIVY_SCAN_OUTPUT=$(trivy fs --format json --output trivy-scan-report.json . || true)
        
        echo "$TRIVY_SCAN_OUTPUT" > trivy-scan-report.json
        
        # Parse Trivy JSON output to check for vulnerabilities
        # This is a simplification; a more robust check would iterate through results
        VULNERABILITIES_COUNT=$(jq -r '[.Results[]?.Vulnerabilities[]?] | length' trivy-scan-report.json)
        
        echo "Total Trivy vulnerabilities found: $VULNERABILITIES_COUNT"
        
        if [ "$VULNERABILITIES_COUNT" -gt 0 ]; then
          echo "::error::Trivy detected security vulnerabilities. Review 'trivy-scan-report.json'."
          echo "::notice file=trivy-scan-report.json::Trivy vulnerabilities found. See report for details."
          echo "TRIVY_VULNERABILITIES_DETECTED=true" >> "$GITHUB_OUTPUT"
          # Optionally, fail the workflow.
          # exit 1
        else
          echo "No Trivy security vulnerabilities detected."
          echo "TRIVY_VULNERABILITIES_DETECTED=false" >> "$GITHUB_OUTPUT"
        fi
      shell: bash
      
    - name: Upload Trivy Security Report
      if: always() && steps.trivy_scan.outputs.TRIVY_VULNERABILITIES_DETECTED == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: trivy-scan-report
        path: trivy-scan-report.json
        retention-days: 7

    - name: Summarize and Fail if High Severity Vulnerabilities Exist
      run: |
        NPM_AUDIT_HIGH=$(jq '.metadata.vulnerabilities.high + .metadata.vulnerabilities.critical' npm-audit-report.json)
        TRIVY_CRITICAL_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH")] | length' trivy-scan-report.json)

        echo "npm audit high/critical vulnerabilities: $NPM_AUDIT_HIGH"
        echo "Trivy high/critical vulnerabilities: $TRIVY_CRITICAL_HIGH"

        if [ "$NPM_AUDIT_HIGH" -gt 0 ] || [ "$TRIVY_CRITICAL_HIGH" -gt 0 ]; then
          echo "::error::Critical or High severity security vulnerabilities detected. Failing workflow."
          exit 1
        else
          echo "No critical or high severity vulnerabilities found by npm audit or Trivy."
        fi
      shell: bash
      if: (steps.npm_audit_scan.outputs.VULNERABILITIES_DETECTED == 'true') || (steps.trivy_scan.outputs.TRIVY_VULNERABILITIES_DETECTED == 'true')