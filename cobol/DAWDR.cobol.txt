
       IDENTIFICATION DIVISION.
       PROGRAM-ID. DAWDR.
       AUTHOR. LIVE-BANK-ARCHITECTS.
       DATE-WRITTEN. 1989-01-16.
      ******************************************************************
      * LIVE BANK - PROCESS WITHDRAWAL
      *
      * PROCESSES A WITHDRAWAL, VALIDATING AVAILABLE FUNDS.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT DEPOSIT-ACCOUNT-FILE ASSIGN TO DEPMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS DA-ACCOUNT-NUMBER
               FILE STATUS IS WS-DEPMAST-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD DEPOSIT-ACCOUNT-FILE.
       01 DEPOSIT-FILE-RECORD    PIC X(201).

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-DEPMAST-STATUS     PIC X(02).
             88 DEPMAST-OK            VALUE '00'.
             88 DEPMAST-NOT-FOUND     VALUE '23'.

       01 WS-INPUT-FIELDS.
          05 WS-INPUT-ACCT-NUM    PIC 9(12).
          05 WS-INPUT-WDR-AMT     PIC S9(13)V99.

       COPY CPDA01 REPLACING ==DEPOSIT-ACCOUNT-RECORD== BY
                             ==WS-DEPOSIT-ACCOUNT==.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           PERFORM 1000-INITIALIZATION.
           PERFORM 2000-PROCESS-WITHDRAWAL.
           PERFORM 9999-TERMINATION.
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY " ".
           DISPLAY "INITIALIZING DAWDR - WITHDRAWAL PROCESSING MODULE.".
           OPEN I-O DEPOSIT-ACCOUNT-FILE.

       2000-PROCESS-WITHDRAWAL.
           DISPLAY "ENTER ACCOUNT NUMBER: ".
           ACCEPT WS-INPUT-ACCT-NUM.
           DISPLAY "ENTER WITHDRAWAL AMOUNT: ".
           ACCEPT WS-INPUT-WDR-AMT.

           IF WS-INPUT-WDR-AMT <= 0
              DISPLAY "ERROR: WITHDRAWAL AMOUNT MUST BE POSITIVE."
              GO TO 2000-EXIT
           END-IF.

           MOVE WS-INPUT-ACCT-NUM TO DA-ACCOUNT-NUMBER.
           READ DEPOSIT-ACCOUNT-FILE INTO WS-DEPOSIT-ACCOUNT
               INVALID KEY MOVE '23' TO WS-DEPMAST-STATUS.

           IF DEPMAST-NOT-FOUND
              DISPLAY "ERROR: ACCOUNT NUMBER NOT FOUND."
           ELSE
              PERFORM 2100-VALIDATE-AND-UPDATE
           END-IF.
       2000-EXIT.
           EXIT.

       2100-VALIDATE-AND-UPDATE.
           IF WS-INPUT-WDR-AMT > DA-AVAILABLE-BAL
              DISPLAY "ERROR: INSUFFICIENT FUNDS."
              DISPLAY "AVAILABLE: " DA-AVAILABLE-BAL
              DISPLAY "REQUESTED: " WS-INPUT-WDR-AMT
           ELSE
              SUBTRACT WS-INPUT-WDR-AMT FROM DA-CURRENT-BALANCE
              SUBTRACT WS-INPUT-WDR-AMT FROM DA-AVAILABLE-BAL
              REWRITE DEPOSIT-FILE-RECORD FROM WS-DEPOSIT-ACCOUNT
              IF DEPMAST-OK
                 DISPLAY "WITHDRAWAL PROCESSED. PLEASE TAKE CASH."
                 DISPLAY "NEW BALANCE: " DA-CURRENT-BALANCE
              ELSE
                 DISPLAY "CRITICAL ERROR: FAILED TO UPDATE ACCOUNT."
              END-IF
           END-IF.

       9999-TERMINATION.
           CLOSE DEPOSIT-ACCOUNT-FILE.
           DISPLAY "DAWDR MODULE TERMINATED.".
           DISPLAY " ".
