               IDENTIFICATION DIVISION.
       PROGRAM-ID. DAWDR.
       AUTHOR. SYSTEMS-DEVELOPMENT.
       DATE-WRITTEN. 1989-01-16.
      ******************************************************************
      * WITHDRAWAL PROCESSING MODULE (DAWDR)
      *
      * This module processes withdrawal requests. It includes automated
      * checks for high-risk transaction patterns and provides rule-based
      * notifications to the user.
      * It validates available funds, enforces daily limits, logs all
      * transactions, and provides contextual feedback.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT DEPOSIT-ACCOUNT-FILE ASSIGN TO DEPMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS DA-ACCOUNT-NUMBER
               FILE STATUS IS WS-DEPMAST-STATUS.

           SELECT TRANSACTION-LOG-FILE ASSIGN TO TRANLOG
               ORGANIZATION IS LINE SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL
               FILE STATUS IS WS-TRANLOG-STATUS.

           SELECT DAILY-LIMITS-FILE ASSIGN TO DAILYLIM
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS DL-ACCOUNT-NUMBER
               FILE STATUS IS WS-DAILYLIM-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD DEPOSIT-ACCOUNT-FILE.
       01 DEPOSIT-FILE-RECORD    PIC X(201).

       FD TRANSACTION-LOG-FILE.
       01 TRANSACTION-RECORD.
          05 TR-TRANSACTION-ID       PIC X(20).
          05 TR-ACCOUNT-NUMBER       PIC 9(12).
          05 TR-TRANSACTION-TYPE     PIC X(10).
          05 TR-AMOUNT               PIC S9(13)V99.
          05 TR-DATE                 PIC 9(08).
          05 TR-TIME                 PIC 9(06).
          05 TR-STATUS               PIC X(20).
          05 TR-AI-MESSAGE           PIC X(50).

       FD DAILY-LIMITS-FILE.
       01 DAILY-LIMITS-RECORD.
          05 DL-ACCOUNT-NUMBER       PIC 9(12).
          05 DL-DATE                 PIC 9(08).
          05 DL-DAILY-WDR-TOTAL      PIC S9(13)V99.

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-DEPMAST-STATUS     PIC X(02).
             88 DEPMAST-OK            VALUE '00'.
             88 DEPMAST-NOT-FOUND     VALUE '23'.
          05 WS-TRANLOG-STATUS     PIC X(02).
             88 TRANLOG-OK            VALUE '00'.
             88 TRANLOG-NOT-OPEN      VALUE '99'. *> Custom status for initial open failure
          05 WS-DAILYLIM-STATUS    PIC X(02).
             88 DAILYLIM-OK           VALUE '00'.
             88 DAILYLIM-NOT-FOUND    VALUE '23'.
          05 WS-CONTINUE-PROCESSING PIC X(01) VALUE 'Y'.
             88 CONTINUE-YES          VALUE 'Y'.
             88 CONTINUE-NO           VALUE 'N'.

       01 WS-INPUT-FIELDS.
          05 WS-INPUT-ACCT-NUM    PIC 9(12).
          05 WS-INPUT-WDR-AMT     PIC S9(13)V99.
          05 WS-USER-CHOICE       PIC X(01).

       01 WS-DATE-TIME-FIELDS.
          05 WS-CURRENT-DATE-TIME.
             10 WS-CURRENT-DATE.
                15 WS-YEAR          PIC 9(04).
                15 WS-MONTH         PIC 9(02).
                15 WS-DAY           PIC 9(02).
             10 WS-CURRENT-TIME.
                15 WS-HOUR          PIC 9(02).
                15 WS-MINUTE        PIC 9(02).
                15 WS-SECOND        PIC 9(02).
                15 WS-MILLISECONDS  PIC 9(02).

       01 WS-TRANSACTION-DATA.
          05 WS-TRANSACTION-ID      PIC X(20).
          05 WS-TRANSACTION-STATUS  PIC X(20) VALUE SPACES.
          05 WS-AI-MESSAGE          PIC X(50) VALUE SPACES.
          05 WS-AI-FRAUD-FLAG       PIC X(01) VALUE 'N'.
             88 AI-FRAUD-DETECTED     VALUE 'Y'.
             88 NO-FRAUD-DETECTED     VALUE 'N'.
          05 WS-AI-ADVICE-FLAG      PIC X(01) VALUE 'N'.
             88 AI-ADVICE-PENDING     VALUE 'Y'.
          05 WS-DAILY-WDR-LIMIT     PIC S9(13)V99 VALUE 5000.00.  *> Default $5000.00
          05 WS-LARGE-WDR-THRESHOLD PIC S9(13)V99 VALUE 1000.00.  *> Default $1000.00
          05 WS-HIGH-RISK-AMT-THRESHOLD PIC S9(13)V99 VALUE 2000.00. *> Amount over which AI raises high risk
          05 WS-LOW-BALANCE-THRESHOLD PIC S9(13)V99 VALUE 100.00.   *> Balance under which AI advises
          05 WS-TEMP-DAILY-WDR-TOTAL PIC S9(13)V99 VALUE ZERO.

       COPY CPDA01 REPLACING ==DEPOSIT-ACCOUNT-RECORD== BY
                             ==WS-DEPOSIT-ACCOUNT==.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           PERFORM 1000-INITIALIZATION.
           IF CONTINUE-YES
               PERFORM 2000-PROCESS-WITHDRAWAL-LOOP UNTIL CONTINUE-NO
           END-IF.
           PERFORM 9999-TERMINATION.
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY " ".
           DISPLAY "INITIALIZING DAWDR - ADVANCED WITHDRAWAL PROCESSING MODULE.".
           OPEN I-O DEPOSIT-ACCOUNT-FILE.
           IF NOT DEPMAST-OK
               DISPLAY "ERROR: FAILED TO OPEN DEPOSIT-ACCOUNT-FILE."
               MOVE 'N' TO WS-CONTINUE-PROCESSING
               GO TO 1000-EXIT
           END-IF.

           OPEN EXTEND TRANSACTION-LOG-FILE.
           IF NOT TRANLOG-OK
               DISPLAY "WARNING: FAILED TO OPEN TRANSACTION-LOG-FILE. Transactions will not be logged."
               MOVE '99' TO WS-TRANLOG-STATUS
           END-IF.

           OPEN I-O DAILY-LIMITS-FILE.
           IF NOT DAILYLIM-OK
               DISPLAY "ERROR: FAILED TO OPEN DAILY-LIMITS-FILE."
               MOVE 'N' TO WS-CONTINUE-PROCESSING
               GO TO 1000-EXIT
           END-IF.

           DISPLAY "System ready for transactions.".
       1000-EXIT.
           EXIT.

       2000-PROCESS-WITHDRAWAL-LOOP.
           PERFORM 2010-GET-SYSTEM-DATE-TIME.
           PERFORM 2020-GET-TRANSACTION-ID.
           INITIALIZE WS-INPUT-FIELDS
                      WS-TRANSACTION-DATA
                      WS-DEPOSIT-ACCOUNT.
           MOVE 'N' TO WS-AI-FRAUD-FLAG
           MOVE 'N' TO WS-AI-ADVICE-FLAG.

           DISPLAY " ".
           DISPLAY "--- NEW WITHDRAWAL TRANSACTION ---".
           PERFORM 2030-GET-USER-INPUT.
           IF WS-INPUT-ACCT-NUM = ZEROES
              DISPLAY "Transaction cancelled by user. Exiting processing loop."
              MOVE 'N' TO WS-CONTINUE-PROCESSING
              GO TO 2000-EXIT-LOOP
           END-IF.

           PERFORM 2040-VALIDATE-INPUT.
           IF WS-TRANSACTION-STATUS NOT EQUAL SPACES
               PERFORM 4000-LOG-TRANSACTION
               GO TO 2000-EXIT-LOOP
           END-IF.

           MOVE WS-INPUT-ACCT-NUM TO DA-ACCOUNT-NUMBER.
           READ DEPOSIT-ACCOUNT-FILE INTO WS-DEPOSIT-ACCOUNT
               INVALID KEY MOVE '23' TO WS-DEPMAST-STATUS.

           IF DEPMAST-NOT-FOUND
              DISPLAY "ERROR: ACCOUNT NUMBER " WS-INPUT-ACCT-NUM " NOT FOUND."
              MOVE "ACCOUNT NOT FOUND" TO WS-TRANSACTION-STATUS
              PERFORM 4000-LOG-TRANSACTION
           ELSE
              PERFORM 2050-AI-PRE-CHECK-FRAUD
              IF AI-FRAUD-DETECTED
                 DISPLAY "WARNING: AUTOMATED SYSTEM FLAGGED THIS TRANSACTION."
                 DISPLAY "         Transaction placed on hold for review."
                 MOVE "FRAUD FLAGGED" TO WS-TRANSACTION-STATUS
                 PERFORM 4000-LOG-TRANSACTION
              ELSE
                 PERFORM 2060-CHECK-DAILY-LIMITS
                 IF WS-TRANSACTION-STATUS NOT EQUAL SPACES
                    PERFORM 4000-LOG-TRANSACTION
                 ELSE
                    PERFORM 2100-VALIDATE-AND-UPDATE
                    IF WS-TRANSACTION-STATUS = "PROCESSED"
                       PERFORM 3100-AI-POST-ADVICE
                    END-IF
                    PERFORM 4000-LOG-TRANSACTION
                 END-IF
              END-IF
           END-IF.

           DISPLAY "Do you want to process another withdrawal? (Y/N)".
           ACCEPT WS-USER-CHOICE.
           IF WS-USER-CHOICE NOT EQUAL 'Y' AND
              WS-USER-CHOICE NOT EQUAL 'y'
              MOVE 'N' TO WS-CONTINUE-PROCESSING
           END-IF.
       2000-EXIT-LOOP.
           EXIT.

       2010-GET-SYSTEM-DATE-TIME.
           ACCEPT WS-CURRENT-DATE FROM DATE YYYYMMDD.
           ACCEPT WS-CURRENT-TIME FROM TIME.

       2020-GET-TRANSACTION-ID.
           COMPUTE WS-TRANSACTION-ID = FUNCTION CONCATENATE(
               "WDR-", WS-YEAR, WS-MONTH, WS-DAY,
               WS-HOUR, WS-MINUTE, WS-SECOND,
               FUNCTION RANDOM * 10000).
           *> For actual systems, use a unique sequence generator or GUID.
           *> This is a simplified simulation for uniqueness within this context.

       2030-GET-USER-INPUT.
           DISPLAY "ENTER ACCOUNT NUMBER (12 digits, 0 to exit): ".
           ACCEPT WS-INPUT-ACCT-NUM.
           IF WS-INPUT-ACCT-NUM = ZEROES
               GO TO 2030-EXIT
           END-IF.
           DISPLAY "ENTER WITHDRAWAL AMOUNT (e.g., 100.00): ".
           ACCEPT WS-INPUT-WDR-AMT.
       2030-EXIT.
           EXIT.

       2040-VALIDATE-INPUT.
           IF WS-INPUT-ACCT-NUM IS NOT NUMERIC OR
              LENGTH OF WS-INPUT-ACCT-NUM NOT EQUAL 12
              DISPLAY "ERROR: INVALID ACCOUNT NUMBER FORMAT. Must be 12 digits."
              MOVE "INVALID ACCT NUM" TO WS-TRANSACTION-STATUS
              GO TO 2040-EXIT
           END-IF.

           IF WS-INPUT-WDR-AMT <= 0
              DISPLAY "ERROR: WITHDRAWAL AMOUNT MUST BE POSITIVE."
              MOVE "INVALID AMOUNT" TO WS-TRANSACTION-STATUS
              GO TO 2040-EXIT
           END-IF.
       2040-EXIT.
           EXIT.

       2050-AI-PRE-CHECK-FRAUD.
           MOVE 'N' TO WS-AI-FRAUD-FLAG.
           INITIALIZE WS-AI-MESSAGE.

           *> Simulate basic automated fraud detection rules:
           *> Rule 1: Very large single withdrawal relative to balance.
           IF WS-INPUT-WDR-AMT > (DA-AVAILABLE-BAL * 0.50) AND
              WS-INPUT-WDR-AMT > WS-LARGE-WDR-THRESHOLD
              DISPLAY "NOTICE: Withdrawal is >50% of balance. Flagged for review."
              MOVE "FLAG: WDR >50% OF BALANCE" TO WS-AI-MESSAGE
              MOVE 'Y' TO WS-AI-FRAUD-FLAG
           END-IF.

           *> Rule 2: Withdrawal amount exceeds a fixed high-risk threshold for any account.
           IF WS-INPUT-WDR-AMT > WS-HIGH-RISK-AMT-THRESHOLD
              DISPLAY "NOTICE: Withdrawal exceeds high-risk threshold. Flagged for review."
              IF NO-FRAUD-DETECTED
                 MOVE "FLAG: WDR > HIGH-RISK THRESHOLD" TO WS-AI-MESSAGE
                 MOVE 'Y' TO WS-AI-FRAUD-FLAG
              END-IF
           END-IF.

           *> Rule 3: Account has unusual activity (simulated by a very low balance after hypothetical withdrawal)
           IF (DA-AVAILABLE-BAL - WS-INPUT-WDR-AMT) < 0 AND
              DA-AVAILABLE-BAL > 0  *> If it would overdraw and wasn't already 0
              DISPLAY "NOTICE: Withdrawal exceeds available funds. Flagged for review."
              IF NO-FRAUD-DETECTED
                 MOVE "FLAG: WDR > AVAILABLE BALANCE" TO WS-AI-MESSAGE
                 MOVE 'Y' TO WS-AI-FRAUD-FLAG
              END-IF
           END-IF.

           *> In a real scenario, this would involve calling an external service
           *> with transaction context, account history, location data, etc.,
           *> for a more sophisticated analysis.
       2050-EXIT.
           EXIT.

       2060-CHECK-DAILY-LIMITS.
           MOVE WS-INPUT-ACCT-NUM TO DL-ACCOUNT-NUMBER.
           MOVE WS-CURRENT-DATE TO DL-DATE.

           READ DAILY-LIMITS-FILE INTO DAILY-LIMITS-RECORD
               INVALID KEY MOVE '23' TO WS-DAILYLIM-STATUS.

           IF DAILYLIM-NOT-FOUND
               MOVE WS-INPUT-ACCT-NUM TO DL-ACCOUNT-NUMBER
               MOVE WS-CURRENT-DATE TO DL-DATE
               MOVE ZERO TO DL-DAILY-WDR-TOTAL
               PERFORM 2061-CREATE-DAILY-LIMIT-RECORD
               IF WS-TRANSACTION-STATUS NOT EQUAL SPACES *> If create failed
                   GO TO 2060-EXIT
               END-IF
           END-IF.

           MOVE DL-DAILY-WDR-TOTAL TO WS-TEMP-DAILY-WDR-TOTAL.
           ADD WS-INPUT-WDR-AMT TO WS-TEMP-DAILY-WDR-TOTAL.

           IF WS-TEMP-DAILY-WDR-TOTAL > WS-DAILY-WDR-LIMIT
              DISPLAY "ERROR: DAILY WITHDRAWAL LIMIT EXCEEDED."
              DISPLAY "DAILY LIMIT: " WS-DAILY-WDR-LIMIT
              DISPLAY "REQUESTED:   " WS-INPUT-WDR-AMT
              DISPLAY "CURRENT DAY TOTAL (incl. this): " WS-TEMP-DAILY-WDR-TOTAL
              MOVE "DAILY_LIMIT_EXCD" TO WS-TRANSACTION-STATUS
              MOVE "Daily withdrawal limit exceeded" TO WS-AI-MESSAGE
           ELSE
              MOVE WS-TEMP-DAILY-WDR-TOTAL TO DL-DAILY-WDR-TOTAL
              PERFORM 2062-UPDATE-DAILY-LIMIT-RECORD
              IF WS-TRANSACTION-STATUS NOT EQUAL SPACES *> If update failed
                 GO TO 2060-EXIT
              END-IF
           END-IF.
       2060-EXIT.
           EXIT.

       2061-CREATE-Daily-limit-RECORD.
           WRITE DAILY-LIMITS-RECORD
               INVALID KEY
                   DISPLAY "CRITICAL ERROR: FAILED TO CREATE DAILY LIMIT RECORD FOR " DL-ACCOUNT-NUMBER
                   MOVE "DL_CREATE_FAILED" TO WS-TRANSACTION-STATUS
           END-WRITE.
           IF NOT DAILYLIM-OK
               DISPLAY "Failed to write new daily limit record."
           END-IF.
       2061-EXIT.
           EXIT.

       2062-UPDATE-DAILY-LIMIT-RECORD.
           REWRITE DAILY-LIMITS-RECORD
               INVALID KEY
                   DISPLAY "CRITICAL ERROR: FAILED TO REWRITE DAILY LIMIT RECORD FOR " DL-ACCOUNT-NUMBER
                   MOVE "DL_UPDATE_FAILED" TO WS-TRANSACTION-STATUS
           END-REWRITE.
           IF NOT DAILYLIM-OK
               DISPLAY "Failed to update daily limit record."
           END-IF.
       2062-EXIT.
           EXIT.

       2100-VALIDATE-AND-UPDATE.
           IF WS-INPUT-WDR-AMT > DA-AVAILABLE-BAL
              DISPLAY "ERROR: INSUFFICIENT FUNDS."
              DISPLAY "AVAILABLE: " DA-AVAILABLE-BAL
              DISPLAY "REQUESTED: " WS-INPUT-WDR-AMT
              MOVE "INSUFFICIENT FUNDS" TO WS-TRANSACTION-STATUS
           ELSE
              PERFORM 2200-CONFIRM-LARGE-WITHDRAWAL
              IF WS-TRANSACTION-STATUS EQUAL "USER_CANCELLED"
                  *> Revert daily limit if user cancelled large withdrawal
                  COMPUTE DL-DAILY-WDR-TOTAL = DL-DAILY-WDR-TOTAL - WS-INPUT-WDR-AMT
                  PERFORM 2062-UPDATE-DAILY-LIMIT-RECORD
                  GO TO 2100-EXIT
              END-IF

              SUBTRACT WS-INPUT-WDR-AMT FROM DA-CURRENT-BALANCE
              SUBTRACT WS-INPUT-WDR-AMT FROM DA-AVAILABLE-BAL
              REWRITE DEPOSIT-FILE-RECORD FROM WS-DEPOSIT-ACCOUNT
              IF DEPMAST-OK
                 DISPLAY "WITHDRAWAL PROCESSED. PLEASE TAKE CASH."
                 DISPLAY "NEW BALANCE: " DA-CURRENT-BALANCE
                 MOVE "PROCESSED" TO WS-TRANSACTION-STATUS
              ELSE
                 DISPLAY "CRITICAL ERROR: FAILED TO UPDATE ACCOUNT " DA-ACCOUNT-NUMBER "."
                 MOVE "ACCOUNT_UPDATE_FAIL" TO WS-TRANSACTION-STATUS
                 *> Revert daily limit if account update failed
                 COMPUTE DL-DAILY-WDR-TOTAL = DL-DAILY-WDR-TOTAL - WS-INPUT-WDR-AMT
                 PERFORM 2062-UPDATE-DAILY-LIMIT-RECORD
              END-IF
           END-IF.
       2100-EXIT.
           EXIT.

       2200-CONFIRM-LARGE-WITHDRAWAL.
           IF WS-INPUT-WDR-AMT > WS-LARGE-WDR-THRESHOLD
              DISPLAY " ".
              DISPLAY "WARNING: This is a large withdrawal (" WS-INPUT-WDR-AMT ")."
              DISPLAY "Do you wish to proceed? (Y/N)".
              ACCEPT WS-USER-CHOICE.
              IF WS-USER-CHOICE NOT EQUAL 'Y' AND
                 WS-USER-CHOICE NOT EQUAL 'y'
                 DISPLAY "Withdrawal cancelled by user."
                 MOVE "USER_CANCELLED" TO WS-TRANSACTION-STATUS
                 MOVE "User cancelled large withdrawal" TO WS-AI-MESSAGE
              END-IF
           END-IF.
       2200-EXIT.
           EXIT.

       3100-AI-POST-ADVICE.
           MOVE 'N' TO WS-AI-ADVICE-FLAG.
           INITIALIZE WS-AI-MESSAGE.

           IF WS-TRANSACTION-STATUS EQUAL "PROCESSED"
              *> Simulate rule-based financial notifications
              IF DA-CURRENT-BALANCE < WS-LOW-BALANCE-THRESHOLD
                 DISPLAY "NOTICE: Account balance is below the low-balance threshold."
                 MOVE "INFO: BALANCE BELOW THRESHOLD" TO WS-AI-MESSAGE
                 MOVE 'Y' TO WS-AI-ADVICE-FLAG
              ELSE IF WS-INPUT-WDR-AMT > WS-LARGE-WDR-THRESHOLD
                 DISPLAY "INFO: Large withdrawal recorded. Refer to documentation for savings/investment options."
                 MOVE "INFO: LARGE WDR PROCESSED" TO WS-AI-MESSAGE
                 MOVE 'Y' TO WS-AI-ADVICE-FLAG
              END-IF
           END-IF.

           *> In a real system, this would trigger a more sophisticated model
           *> to provide personalized financial insights or product recommendations
           *> based on a broader analysis of user history and market data.
       3100-EXIT.
           EXIT.

       4000-LOG-TRANSACTION.
           IF NOT TRANLOG-OK THEN
               IF WS-TRANLOG-STATUS = '99'
                  DISPLAY "WARNING: Transaction logging file was not opened successfully. Cannot log."
               ELSE
                  DISPLAY "WARNING: Transaction logging file not available (status: " WS-TRANLOG-STATUS "). Cannot log transaction."
               END-IF
               GO TO 4000-EXIT
           END-IF.

           MOVE WS-TRANSACTION-ID    TO TR-TRANSACTION-ID.
           MOVE WS-INPUT-ACCT-NUM    TO TR-ACCOUNT-NUMBER.
           MOVE "WITHDRAWAL"         TO TR-TRANSACTION-TYPE.
           MOVE WS-INPUT-WDR-AMT     TO TR-AMOUNT.
           MOVE WS-CURRENT-DATE      TO TR-DATE.
           MOVE WS-CURRENT-TIME(1:6) TO TR-TIME.
           MOVE WS-TRANSACTION-STATUS TO TR-STATUS.
           IF WS-AI-MESSAGE NOT EQUAL SPACES
               MOVE WS-AI-MESSAGE TO TR-AI-MESSAGE
           ELSE
               MOVE "N/A" TO TR-AI-MESSAGE
           END-IF.

           WRITE TRANSACTION-RECORD.
           IF NOT TRANLOG-OK
               DISPLAY "CRITICAL ERROR: FAILED TO WRITE TO TRANSACTION LOG."
               DISPLAY "FILE STATUS: " WS-TRANLOG-STATUS
           END-IF.
       4000-EXIT.
           EXIT.

       9999-TERMINATION.
           CLOSE DEPOSIT-ACCOUNT-FILE.
           IF TRANLOG-OK
               CLOSE TRANSACTION-LOG-FILE
           END-IF.
           CLOSE DAILY-LIMITS-FILE.
           DISPLAY "DAWDR MODULE TERMINATED. All files closed.".
           DISPLAY " ".