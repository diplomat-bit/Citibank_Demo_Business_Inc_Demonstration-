       IDENTIFICATION DIVISION.
       PROGRAM-ID. TMOPEN.
       AUTHOR. PROGRAMMER.
      ******************************************************************
      * TELLER OPEN DRAWER
      * This program facilitates the opening of a teller's cash drawer
      * at the beginning of a shift. It validates the teller ID,
      * checks the drawer status, accepts a starting cash amount,
      * and updates the teller master record. It also integrates
      * with an AI component for cash flow predictions and audit trails.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TELLER-MASTER-FILE ASSIGN TO TELLMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS TM-TELLER-ID
               FILE STATUS IS WS-TELLER-FILE-STATUS.

           SELECT TELLER-AUDIT-FILE  ASSIGN TO TELLAUDT
               ORGANIZATION IS SEQUENTIAL
               ACCESS MODE IS SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD TELLER-MASTER-FILE.
       01 TELLER-FILE-RECORD          PIC X(158).

       FD TELLER-AUDIT-FILE.
       01 TELLER-AUDIT-RECORD.
           05 TA-TIMESTAMP            PIC X(14).
           05 TA-TELLER-ID            PIC X(08).
           05 TA-EVENT-TYPE           PIC X(15).
           05 TA-DETAIL-AMOUNT        PIC S9(9)V99.
           05 TA-AI-REC-AMOUNT        PIC S9(9)V99.
           05 TA-DESCRIPTION          PIC X(80).

       WORKING-STORAGE SECTION.
      *
      * CPTM01 is expected to contain the Teller Master Record structure.
      * For expansion purposes, its assumed content is defined here.
      * In a real system, this would be in a separate copybook file.
      *
       COPY CPTM01.
      * Assumed content of CPTM01:
       01 TELLER-MASTER-RECORD REDEFINES TELLER-FILE-RECORD.
           05 TM-TELLER-ID           PIC X(08).
           05 TM-TELLER-NAME         PIC X(30).
           05 TM-DRAWER-STATUS       PIC X(01).
              88 DRAWER-OPEN         VALUE 'O'.
              88 DRAWER-CLOSED       VALUE 'C'.
           05 TM-CURRENT-BALANCE     PIC S9(9)V99 COMP-3.
           05 TM-DAILY-TOTALS.
              10 TM-DEPOSITS-TOTAL   PIC S9(9)V99 COMP-3.
              10 TM-WITHDRAW-TOTAL   PIC S9(9)V99 COMP-3.
              10 TM-ADJUSTMENTS-TOTAL PIC S9(9)V99 COMP-3.
           05 TM-LAST-OPEN-DATE      PIC X(08).  *> YYYYMMDD
           05 TM-LAST-OPEN-TIME      PIC X(06).  *> HHMMSS
           05 TM-LAST-CLOSE-DATE     PIC X(08).
           05 TM-LAST-CLOSE-TIME     PIC X(06).
           05 TM-AI-RECOMMENDED-CASH PIC S9(9)V99 COMP-3.
           05 TM-DRAWER-OPEN-COUNT   PIC 9(05) COMP-3.
           05 TM-FILLER              PIC X(53). *> Total 158 bytes

       01 WS-INPUT-TELLER-ID     PIC X(08).
       01 WS-STARTING-CASH       PIC S9(9)V99.
       01 WS-AI-RECOMMENDATION   PIC S9(9)V99 VALUE ZEROS.
       01 WS-STARTING-CASH-DISPLAY PIC ZZZ,ZZZ,ZZ9.99.
       01 WS-AI-RECOMM-DISPLAY   PIC ZZZ,ZZZ,ZZ9.99.
       01 WS-CURRENT-DATE-TIME.
           05 WS-CURRENT-DATE.
               10 WS-CURRENT-YEAR    PIC X(04).
               10 WS-CURRENT-MONTH   PIC X(02).
               10 WS-CURRENT-DAY     PIC X(02).
           05 WS-CURRENT-TIME.
               10 WS-CURRENT-HOUR    PIC X(02).
               10 WS-CURRENT-MINUTE  PIC X(02).
               10 WS-CURRENT-SECOND  PIC X(02).
               10 WS-CURRENT-MSEC    PIC X(02).

       01 WS-TELLER-FILE-STATUS  PIC X(02).
           88 FILE-OK             VALUE '00'.
           88 FILE-NOT-FOUND      VALUE '23'.
           88 DUP-KEY             VALUE '22'.

       01 WS-RESPONSE-CODE       PIC S9(04) COMP.
           88 WS-SUCCESS         VALUE 0.
           88 WS-ERROR           VALUE 1.

       01 WS-PROMPT-OVERRIDE     PIC X(01).
           88 OVERRIDE-YES        VALUE 'Y', 'y'.
           88 OVERRIDE-NO         VALUE 'N', 'n'.

       PROCEDURE DIVISION.
       MAIN-LOGIC.
           PERFORM INITIALIZE-SYSTEM.
           PERFORM PROCESS-DRAWER-OPENING
               THRU PROCESS-DRAWER-OPENING-EXIT.
           PERFORM TERMINATE-SYSTEM.
           STOP RUN.

       INITIALIZE-SYSTEM.
           DISPLAY "TMOPEN - TELLER DRAWER OPENING PROCEDURE.".
           OPEN I-O TELLER-MASTER-FILE.
           IF NOT FILE-OK
               DISPLAY "ERROR: UNABLE TO OPEN TELLER MASTER FILE. STATUS: "
                   WS-TELLER-FILE-STATUS
               PERFORM TERMINATE-SYSTEM
               STOP RUN
           END-IF.

           OPEN EXTEND TELLER-AUDIT-FILE.
           IF FILE-STATUS NOT = '00' AND FILE-STATUS NOT = '10'
               DISPLAY "WARNING: UNABLE TO OPEN TELLER AUDIT FILE. STATUS: "
                   FILE-STATUS OF TELLER-AUDIT-FILE
               MOVE 'WARNING: AUDIT LOG UNAVAILABLE.' TO TA-DESCRIPTION
               PERFORM WRITE-AUDIT-LOG
           END-IF.
           MOVE ZEROS TO WS-AI-RECOMMENDATION.
           MOVE SPACES TO WS-INPUT-TELLER-ID.

       PROCESS-DRAWER-OPENING.
           PERFORM GET-TELLER-ID.
           IF WS-RESPONSE-CODE = WS-ERROR
               GO TO PROCESS-DRAWER-OPENING-EXIT
           END-IF.

           PERFORM CHECK-DRAWER-STATUS.
           IF WS-RESPONSE-CODE = WS-ERROR
               GO TO PROCESS-DRAWER-OPENING-EXIT
           END-IF.

           PERFORM GET-STARTING-CASH.
           IF WS-RESPONSE-CODE = WS-ERROR
               GO TO PROCESS-DRAWER-OPENING-EXIT
           END-IF.

           PERFORM UPDATE-TELLER-RECORD.
           IF WS-RESPONSE-CODE = WS-ERROR
               GO TO PROCESS-DRAWER-OPENING-EXIT
           END-IF.

           DISPLAY "DRAWER OPEN AND READY FOR TRANSACTIONS. "
               "STARTING BALANCE: " WS-STARTING-CASH-DISPLAY.
           MOVE 'DRAWER OPENED' TO TA-EVENT-TYPE.
           MOVE WS-STARTING-CASH TO TA-DETAIL-AMOUNT.
           MOVE WS-AI-RECOMMENDATION TO TA-AI-REC-AMOUNT.
           MOVE 'SUCCESSFUL DRAWER OPENING' TO TA-DESCRIPTION.
           PERFORM WRITE-AUDIT-LOG.
           GO TO PROCESS-DRAWER-OPENING-EXIT.

       PROCESS-DRAWER-OPENING-EXIT.
           EXIT.

       GET-TELLER-ID.
           MOVE WS-SUCCESS TO WS-RESPONSE-CODE.
           DISPLAY "ENTER TELLER ID (8 characters): ".
           ACCEPT WS-INPUT-TELLER-ID.

           IF WS-INPUT-TELLER-ID IS NOT ALPHANUMERIC OR
              FUNCTION LENGTH(TRIM(WS-INPUT-TELLER-ID)) NOT = 8
               DISPLAY "ERROR: INVALID TELLER ID FORMAT. Must be 8 characters."
               MOVE WS-ERROR TO WS-RESPONSE-CODE
               MOVE WS-INPUT-TELLER-ID TO TA-TELLER-ID
               MOVE 'OPEN_DRAWER_FAIL' TO TA-EVENT-TYPE
               MOVE ZEROS TO TA-DETAIL-AMOUNT
               MOVE ZEROS TO TA-AI-REC-AMOUNT
               MOVE 'Invalid Teller ID format' TO TA-DESCRIPTION
               PERFORM WRITE-AUDIT-LOG
               EXIT PARAGRAPH
           END-IF.

           MOVE WS-INPUT-TELLER-ID TO TM-TELLER-ID.
           READ TELLER-MASTER-FILE
               INVALID KEY
                   DISPLAY "ERROR: TELLER ID " WS-INPUT-TELLER-ID " NOT FOUND."
                   MOVE WS-ERROR TO WS-RESPONSE-CODE
                   MOVE WS-INPUT-TELLER-ID TO TA-TELLER-ID
                   MOVE 'OPEN_DRAWER_FAIL' TO TA-EVENT-TYPE
                   MOVE ZEROS TO TA-DETAIL-AMOUNT
                   MOVE ZEROS TO TA-AI-REC-AMOUNT
                   MOVE 'Teller ID not found' TO TA-DESCRIPTION
                   PERFORM WRITE-AUDIT-LOG
           END-READ.

       CHECK-DRAWER-STATUS.
           MOVE WS-SUCCESS TO WS-RESPONSE-CODE.
           IF DRAWER-OPEN
              DISPLAY "ERROR: DRAWER FOR TELLER " TM-TELLER-ID
                  " IS ALREADY OPEN."
              MOVE WS-ERROR TO WS-RESPONSE-CODE
              MOVE TM-TELLER-ID TO TA-TELLER-ID
              MOVE 'OPEN_DRAWER_FAIL' TO TA-EVENT-TYPE
              MOVE TM-CURRENT-BALANCE TO TA-DETAIL-AMOUNT
              MOVE TM-AI-RECOMMENDED-CASH TO TA-AI-REC-AMOUNT
              MOVE 'Drawer already open' TO TA-DESCRIPTION
              PERFORM WRITE-AUDIT-LOG
           END-IF.

       GET-STARTING-CASH.
           MOVE WS-SUCCESS TO WS-RESPONSE-CODE.
           PERFORM CALL-AI-CASH-PREDICTOR.

           MOVE WS-AI-RECOMMENDATION TO WS-AI-RECOMM-DISPLAY.
           DISPLAY "AI suggests starting cash: " WS-AI-RECOMM-DISPLAY.
           DISPLAY "ENTER STARTING CASH AMOUNT (e.g., 1000.00): ".
           ACCEPT WS-STARTING-CASH.

           IF WS-STARTING-CASH IS NOT NUMERIC OR
              WS-STARTING-CASH < 0
               DISPLAY "ERROR: INVALID CASH AMOUNT ENTERED. Please enter a positive numeric value."
               MOVE WS-ERROR TO WS-RESPONSE-CODE
               MOVE TM-TELLER-ID TO TA-TELLER-ID
               MOVE 'OPEN_DRAWER_FAIL' TO TA-EVENT-TYPE
               MOVE WS-STARTING-CASH TO TA-DETAIL-AMOUNT
               MOVE WS-AI-RECOMMENDATION TO TA-AI-REC-AMOUNT
               MOVE 'Invalid starting cash input' TO TA-DESCRIPTION
               PERFORM WRITE-AUDIT-LOG
               EXIT PARAGRAPH
           END-IF.

           IF WS-STARTING-CASH NOT = WS-AI-RECOMMENDATION
               MOVE WS-STARTING-CASH TO WS-STARTING-CASH-DISPLAY
               DISPLAY "WARNING: Entered cash " WS-STARTING-CASH-DISPLAY
                   " differs from AI recommendation " WS-AI-RECOMM-DISPLAY " by "
                   (WS-STARTING-CASH - WS-AI-RECOMMENDATION) AS CURRENCY ". "
                   "Do you wish to proceed? (Y/N)"
               ACCEPT WS-PROMPT-OVERRIDE
               IF NOT OVERRIDE-YES
                   DISPLAY "Drawer opening cancelled by teller."
                   MOVE WS-ERROR TO WS-RESPONSE-CODE
                   MOVE TM-TELLER-ID TO TA-TELLER-ID
                   MOVE 'OPEN_DRAWER_FAIL' TO TA-EVENT-TYPE
                   MOVE WS-STARTING-CASH TO TA-DETAIL-AMOUNT
                   MOVE WS-AI-RECOMMENDATION TO TA-AI-REC-AMOUNT
                   MOVE 'Teller chose not to override AI recommendation' TO TA-DESCRIPTION
                   PERFORM WRITE-AUDIT-LOG
               ELSE
                   DISPLAY "Proceeding with manual cash amount. This action will be logged."
                   MOVE TM-TELLER-ID TO TA-TELLER-ID
                   MOVE 'AI_OVERRIDE_WARN' TO TA-EVENT-TYPE
                   MOVE WS-STARTING-CASH TO TA-DETAIL-AMOUNT
                   MOVE WS-AI-RECOMMENDATION TO TA-AI-REC-AMOUNT
                   MOVE 'Teller overrode AI cash recommendation' TO TA-DESCRIPTION
                   PERFORM WRITE-AUDIT-LOG
               END-IF
           END-IF.

       CALL-AI-CASH-PREDICTOR.
      ******************************************************************
      * This paragraph simulates an interaction with an external AI
      * service. In a real mainframe environment, this might be a CALL
      * to another program or a web service invocation via a middleware.
      * The "AI Cash Flow Predictor" analyzes historical transaction
      * data, current branch activity, and even external economic
      * indicators to suggest an optimal starting cash amount for
      * the teller's drawer. This helps minimize excess cash holding
      * while ensuring sufficient funds for daily operations.
      *
      * For this example, we'll simulate a dynamic recommendation.
      ******************************************************************
           DISPLAY "Consulting AI Cash Flow Predictor for optimal starting cash...".

           *> Simulate AI processing based on teller ID or other factors
           *> For now, a simple mock recommendation:
           IF TM-TELLER-ID = 'TELLER01'
               MOVE 25000.00 TO WS-AI-RECOMMENDATION
           ELSE IF TM-TELLER-ID = 'TELLER02'
               MOVE 30000.00 TO WS-AI-RECOMMENDATION
           ELSE
               MOVE 20000.00 TO WS-AI-RECOMMENDATION
           END-IF.

           DISPLAY "AI analysis complete. Recommendation received.".
           MOVE WS-AI-RECOMMENDATION TO TM-AI-RECOMMENDED-CASH.

       UPDATE-TELLER-RECORD.
           MOVE WS-SUCCESS TO WS-RESPONSE-CODE.
           SET DRAWER-OPEN TO TRUE.
           MOVE WS-STARTING-CASH TO TM-CURRENT-BALANCE.
           MOVE ZEROS TO TM-DEPOSITS-TOTAL.
           MOVE ZEROS TO TM-WITHDRAW-TOTAL.
           MOVE ZEROS TO TM-ADJUSTMENTS-TOTAL.

           PERFORM GET-CURRENT-DATE-TIME.
           MOVE WS-CURRENT-DATE TO TM-LAST-OPEN-DATE.
           MOVE WS-CURRENT-TIME(1:6) TO TM-LAST-OPEN-TIME.

           ADD 1 TO TM-DRAWER-OPEN-COUNT.

           REWRITE TELLER-FILE-RECORD
               INVALID KEY
                   DISPLAY "ERROR: UNABLE TO REWRITE TELLER MASTER FILE. STATUS: "
                       WS-TELLER-FILE-STATUS
                   MOVE WS-ERROR TO WS-RESPONSE-CODE
                   MOVE TM-TELLER-ID TO TA-TELLER-ID
                   MOVE 'OPEN_DRAWER_FAIL' TO TA-EVENT-TYPE
                   MOVE WS-STARTING-CASH TO TA-DETAIL-AMOUNT
                   MOVE WS-AI-RECOMMENDATION TO TA-AI-REC-AMOUNT
                   MOVE 'Failed to update teller record' TO TA-DESCRIPTION
                   PERFORM WRITE-AUDIT-LOG
           END-REWRITE.

       GET-CURRENT-DATE-TIME.
           ACCEPT WS-CURRENT-DATE-TIME FROM DATE YYYYMMDD.
           ACCEPT WS-CURRENT-TIME FROM TIME.

       WRITE-AUDIT-LOG.
      ******************************************************************
      * This procedure logs significant events to the TELLER-AUDIT-FILE.
      * This log serves as an immutable record of actions, crucial for
      * regulatory compliance, internal audits, and also for feeding
      * data to an "AI Anomaly Detection System". The AI system can
      * analyze these logs in real-time or batch to identify unusual
      * patterns, such as frequent drawer openings/closings,
      * inconsistent cash amounts, or deviations from standard operating
      * procedures, thereby enhancing security and operational integrity.
      ******************************************************************
           PERFORM GET-CURRENT-DATE-TIME.
           STRING WS-CURRENT-YEAR DELIMITED BY SIZE
                  WS-CURRENT-MONTH DELIMITED BY SIZE
                  WS-CURRENT-DAY DELIMITED BY SIZE
                  WS-CURRENT-HOUR DELIMITED BY SIZE
                  WS-CURRENT-MINUTE DELIMITED BY SIZE
                  WS-CURRENT-SECOND DELIMITED BY SIZE
                  INTO TA-TIMESTAMP.

           WRITE TELLER-AUDIT-RECORD
               INVALID KEY
                   DISPLAY "WARNING: UNABLE TO WRITE TO AUDIT LOG. "
                           "TELLER: " TA-TELLER-ID " EVENT: " TA-EVENT-TYPE
           END-WRITE.

       TERMINATE-SYSTEM.
           CLOSE TELLER-MASTER-FILE.
           CLOSE TELLER-AUDIT-FILE.
           DISPLAY "TMOPEN - DRAWER OPENING PROCEDURE ENDED.".

       END PROGRAM TMOPEN.