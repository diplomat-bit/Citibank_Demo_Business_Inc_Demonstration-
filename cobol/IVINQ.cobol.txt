       IDENTIFICATION DIVISION.
       PROGRAM-ID. IVINQ.
       AUTHOR. AI-ASSISTANT.
      ******************************************************************
      * INQUIRE INVESTMENT POSITION - ENHANCED WITH IDGAFAI INSIGHTS
      * This program allows users to inquire about investment positions
      * by CUSIP, integrating the IDGAFAI Analytics Engine for clear,
      * evidence-based analysis (System Instruction: prompts/idgafai_full.txt).
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT INVESTMENT-FILE ASSIGN TO INVMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS INV-CUSIP
               FILE STATUS IS WS-INVESTMENT-FILE-STATUS.
       DATA DIVISION.
       FILE SECTION.
       FD INVESTMENT-FILE.
       01 INVESTMENT-RECORD.
          05 INV-CUSIP                 PIC X(09).
          05 INV-ACCOUNT-NO            PIC X(12).
          05 INV-SECURITY-NAME         PIC X(40).
          05 INV-QTY                   PIC S9(11)V9(4) COMP-3.
          05 INV-COST                  PIC S9(15)V9(2) COMP-3.
          05 INV-MARKET-VAL            PIC S9(15)V9(2) COMP-3.
          05 INV-LAST-UPDATE-DATE      PIC 9(08).
          05 INV-LAST-UPDATE-TIME      PIC 9(06).
          05 INV-RISK-RATING           PIC X(01).  *> A=Low, B=Medium, C=High
          05 INV-PERFORMANCE-HISTORY   PIC X(50). *> Placeholder for historical performance data
          05 FILLER                    PIC X(10). *> For future expansion

       WORKING-STORAGE SECTION.
      *----------------------------------------------------------------*
      * FILE STATUS AND CONTROL                                        *
      *----------------------------------------------------------------*
       01 WS-FILE-STATUS-FIELDS.
          05 WS-INVESTMENT-FILE-STATUS PIC X(02) VALUE SPACES.
             88 INVESTMENT-FILE-OK     VALUE '00'.
             88 INVESTMENT-FILE-EOF    VALUE '10'.
             88 INVESTMENT-FILE-NOT-FOUND VALUE '23'.

      *----------------------------------------------------------------*
      * INQUIRY CRITERIA AND FLAGS                                     *
      *----------------------------------------------------------------*
       01 WS-INQUIRY-FIELDS.
          05 WS-INQUIRY-CUSIP         PIC X(09).
          05 WS-RECORD-FOUND-FLAG     PIC X(01) VALUE 'N'.
             88 RECORD-FOUND           VALUE 'Y'.
             88 RECORD-NOT-FOUND       VALUE 'N'.
          05 WS-CONTINUE-INQUIRY-FLAG PIC X(01) VALUE 'Y'.
             88 CONTINUE-INQUIRY       VALUE 'Y'.
             88 STOP-INQUIRY           VALUE 'N'.

       COPY CPVI01.
      * Assuming CPVI01 defines:
      * 01 COMMON-INVESTMENT-DATA.
      *    05 IV-QUANTITY             PIC S9(11)V9(4) COMP-3.
      *    05 IV-COST-BASIS           PIC S9(15)V9(2) COMP-3.
      *    05 IV-MARKET-VALUE         PIC S9(15)V9(2) COMP-3.

      *----------------------------------------------------------------*
      * FORMATTED DISPLAY FIELDS                                       *
      *----------------------------------------------------------------*
       01 WS-DISPLAY-FIELDS.
          05 WS-DISPLAY-QUANTITY       PIC Z,ZZZ,ZZZ,ZZ9.9999.
          05 WS-DISPLAY-COST-BASIS     PIC $Z,ZZZ,ZZZ,ZZZ,ZZ9.99.
          05 WS-DISPLAY-MARKET-VALUE   PIC $Z,ZZZ,ZZZ,ZZZ,ZZ9.99.
          05 WS-DISPLAY-LAST-DATE      PIC 99/99/9999.
          05 WS-DISPLAY-LAST-TIME      PIC 99:99:99.
          05 WS-DISPLAY-RISK-RATING    PIC X.
          05 WS-DISPLAY-PERF-HISTORY   PIC X(50).

      *----------------------------------------------------------------*
      * IDGAFAI ANALYTICS ENGINE INTERFACE FIELDS                      *
      * These fields are used to communicate with the IDGAFAI system.  *
      * The underlying AI adheres to the idgafai_full.txt specification.*
      *----------------------------------------------------------------*
       01 WS-AI-REQUEST-DATA.
          05 AI-REQ-CUSIP              PIC X(09).
          05 AI-REQ-QUANTITY           PIC S9(11)V9(4) COMP-3.
          05 AI-REQ-MARKET-VALUE       PIC S9(15)V9(2) COMP-3.
          05 AI-REQ-RISK-RATING        PIC X(01).
          05 AI-REQ-PERFORMANCE-HISTORY PIC X(50).

       01 WS-AI-RESPONSE-DATA.
          05 AI-RESP-STATUS            PIC X(01). *> '0'=Success, '1'=Error
          05 AI-RESP-SENTIMENT-SCORE   PIC S9(03)V9(2) COMP-3. *> e.g., 0.00 to 100.00
          05 AI-RESP-TREND-INDICATION  PIC X(15). *> e.g., 'Uptrend', 'Downtrend', 'Stable'
          05 AI-RESP-RECOMMENDATION    PIC X(50). *> e.g., 'Monitor Closely', 'Hold', 'Evaluate Sell'


       PROCEDURE DIVISION.
       MAIN-LOGIC SECTION.
           PERFORM 1000-INITIALIZE-PROGRAM.
           PERFORM 2000-OPEN-INVESTMENT-FILE.
           IF NOT INVESTMENT-FILE-OK
               PERFORM 9000-ERROR-FILE-OPEN
               PERFORM 9999-END-PROGRAM
           END-IF.

           PERFORM UNTIL STOP-INQUIRY
               PERFORM 3000-GET-INQUIRY-CRITERIA
               IF WS-INQUIRY-CUSIP = SPACES
                   SET STOP-INQUIRY TO TRUE
               ELSE
                   PERFORM 4000-READ-INVESTMENT-RECORD
                   IF RECORD-FOUND
                       PERFORM 5000-DISPLAY-INVESTMENT-DETAILS
                       PERFORM 6000-CALL-AI-ANALYTICS-ENGINE
                       PERFORM 7000-DISPLAY-AI-INSIGHTS
                   ELSE
                       DISPLAY "ERROR: Investment with CUSIP "
                               WS-INQUIRY-CUSIP " not found."
                   END-IF
                   PERFORM 8000-PROMPT-FOR-CONTINUE
               END-IF
           END-PERFORM.

           PERFORM 2900-CLOSE-INVESTMENT-FILE.
           PERFORM 9999-END-PROGRAM.

      *----------------------------------------------------------------*
      * 1000-INITIALIZE-PROGRAM: Initializes variables.                *
      *----------------------------------------------------------------*
       1000-INITIALIZE-PROGRAM.
           INITIALIZE WS-INQUIRY-FIELDS
                      WS-DISPLAY-FIELDS
                      WS-AI-REQUEST-DATA
                      WS-AI-RESPONSE-DATA.
           *> Initialize CPVI01 fields (assuming COMMON-INVESTMENT-DATA is the group name).
           INITIALIZE COMMON-INVESTMENT-DATA.
           SET CONTINUE-INQUIRY TO TRUE.
           DISPLAY "IVINQ - ADVANCED INVESTMENT POSITION INQUIRY SYSTEM".
           DISPLAY "---------------------------------------------------".

      *----------------------------------------------------------------*
      * 2000-OPEN-INVESTMENT-FILE: Opens the master investment file.   *
      *----------------------------------------------------------------*
       2000-OPEN-INVESTMENT-FILE.
           OPEN INPUT INVESTMENT-FILE.
           IF NOT INVESTMENT-FILE-OK
               DISPLAY "CRITICAL ERROR: Failed to open INVESTMENT-FILE. Status: "
                       WS-INVESTMENT-FILE-STATUS
               MOVE 'N' TO WS-CONTINUE-INQUIRY-FLAG
           END-IF.

      *----------------------------------------------------------------*
      * 2900-CLOSE-INVESTMENT-FILE: Closes the master investment file. *
      *----------------------------------------------------------------*
       2900-CLOSE-INVESTMENT-FILE.
           CLOSE INVESTMENT-FILE.
           IF NOT INVESTMENT-FILE-OK AND NOT INVESTMENT-FILE-EOF
               DISPLAY "WARNING: Error closing INVESTMENT-FILE. Status: "
                       WS-INVESTMENT-FILE-STATUS
           END-IF.

      *----------------------------------------------------------------*
      * 3000-GET-INQUIRY-CRITERIA: Prompts user for CUSIP.             *
      *----------------------------------------------------------------*
       3000-GET-INQUIRY-CRITERIA.
           MOVE 'N' TO WS-RECORD-FOUND-FLAG.
           DISPLAY SPACE.
           DISPLAY "---------------------------------------------------".
           DISPLAY "ENTER CUSIP for position inquiry (or blank to exit): ".
           ACCEPT WS-INQUIRY-CUSIP.
           IF WS-INQUIRY-CUSIP = SPACES
               SET STOP-INQUIRY TO TRUE
           END-IF.

      *----------------------------------------------------------------*
      * 4000-READ-INVESTMENT-RECORD: Reads investment record by CUSIP. *
      *----------------------------------------------------------------*
       4000-READ-INVESTMENT-RECORD.
           MOVE WS-INQUIRY-CUSIP TO INV-CUSIP.
           READ INVESTMENT-FILE
               INVALID KEY
                   SET RECORD-NOT-FOUND TO TRUE
                   DISPLAY "CUSIP " WS-INQUIRY-CUSIP " not found."
               NOT INVALID KEY
                   SET RECORD-FOUND TO TRUE
                   *> Move data from file record to CPVI01 fields
                   MOVE INV-QTY        TO IV-QUANTITY
                   MOVE INV-COST       TO IV-COST-BASIS
                   MOVE INV-MARKET-VAL TO IV-MARKET-VALUE
                   DISPLAY "Investment record found for CUSIP: " INV-CUSIP
           END-READ.

      *----------------------------------------------------------------*
      * 5000-DISPLAY-INVESTMENT-DETAILS: Displays found record details.*
      * Uses CPVI01 fields for consistency with original program.      *
      *----------------------------------------------------------------*
       5000-DISPLAY-INVESTMENT-DETAILS.
           DISPLAY SPACE.
           DISPLAY "--- INVESTMENT DETAILS ---".
           DISPLAY "CUSIP:             " INV-CUSIP.
           DISPLAY "Account No:        " INV-ACCOUNT-NO.
           DISPLAY "Security Name:     " INV-SECURITY-NAME.

           MOVE IV-QUANTITY      TO WS-DISPLAY-QUANTITY.
           MOVE IV-COST-BASIS    TO WS-DISPLAY-COST-BASIS.
           MOVE IV-MARKET-VALUE  TO WS-DISPLAY-MARKET-VALUE.
           MOVE INV-LAST-UPDATE-DATE TO WS-DISPLAY-LAST-DATE.
           MOVE INV-LAST-UPDATE-TIME TO WS-DISPLAY-LAST-TIME.
           MOVE INV-RISK-RATING  TO WS-DISPLAY-RISK-RATING.
           MOVE INV-PERFORMANCE-HISTORY TO WS-DISPLAY-PERF-HISTORY.

           DISPLAY "Quantity:          " WS-DISPLAY-QUANTITY.
           DISPLAY "Cost Basis:        " WS-DISPLAY-COST-BASIS.
           DISPLAY "Market Value:      " WS-DISPLAY-MARKET-VALUE.
           DISPLAY "Last Updated:      " WS-DISPLAY-LAST-DATE " at " WS-DISPLAY-LAST-TIME.
           DISPLAY "Risk Rating:       " WS-DISPLAY-RISK-RATING.
           DISPLAY "Performance:       " WS-DISPLAY-PERF-HISTORY.

      *----------------------------------------------------------------*
      * 6000-CALL-AI-ANALYTICS-ENGINE: Simulates call to IDGAFAI for insights. *
      * This routine calls an external AI service that is strictly     *
      * constrained by the idgafAI canonical prompt (prompts/idgafai_full.txt).*
      * It provides disciplined, evidence-based recommendations.       *
      * For this demonstration, we'll simulate its output.             *
      *----------------------------------------------------------------*
       6000-CALL-AI-ANALYTICS-ENGINE.
           DISPLAY SPACE.
           DISPLAY "--- CONSULTING IDGAFAI ANALYTICS ENGINE FOR INSIGHTS ---".

           MOVE INV-CUSIP             TO AI-REQ-CUSIP.
           MOVE IV-QUANTITY           TO AI-REQ-QUANTITY.
           MOVE IV-MARKET-VALUE       TO AI-REQ-MARKET-VALUE.
           MOVE INV-RISK-RATING       TO AI-REQ-RISK-RATING.
           MOVE INV-PERFORMANCE-HISTORY TO AI-REQ-PERFORMANCE-HISTORY.

           *> Simulate the call to an external AI subprogram.
           *> In a real mainframe environment, this might be:
           *> CALL 'AIANLYS' USING WS-AI-REQUEST-DATA, WS-AI-RESPONSE-DATA.
           *> For this expanded example, we simulate the AI's logic directly.
           DISPLAY "Simulating IDGAFAI analysis for " INV-SECURITY-NAME "...".

           *> Simulate AI's sentiment score based on market value vs cost basis
           IF IV-MARKET-VALUE > IV-COST-BASIS
               IF IV-COST-BASIS > 0 AND (IV-MARKET-VALUE / IV-COST-BASIS) > 1.10  *> >10% gain
                   MOVE 85.50 TO AI-RESP-SENTIMENT-SCORE
                   MOVE 'Uptrend' TO AI-RESP-TREND-INDICATION
                   MOVE 'Strong Positive Outlook' TO AI-RESP-RECOMMENDATION
               ELSE
                   MOVE 65.25 TO AI-RESP-SENTIMENT-SCORE
                   MOVE 'Stable' TO AI-RESP-TREND-INDICATION
                   MOVE 'Positive Outlook' TO AI-RESP-RECOMMENDATION
               END-IF
           ELSE IF IV-MARKET-VALUE < IV-COST-BASIS
               IF IV-COST-BASIS > 0 AND (IV-MARKET-VALUE / IV-COST-BASIS) < 0.90  *> >10% loss
                   MOVE 25.10 TO AI-RESP-SENTIMENT-SCORE
                   MOVE 'Downtrend' TO AI-RESP-TREND-INDICATION
                   MOVE 'Evaluate Position Closely' TO AI-RESP-RECOMMENDATION
               ELSE
                   MOVE 45.75 TO AI-RESP-SENTIMENT-SCORE
                   MOVE 'Stable' TO AI-RESP-TREND-INDICATION
                   MOVE 'Monitor for Recovery' TO AI-RESP-RECOMMENDATION
               END-IF
           ELSE
               MOVE 50.00 TO AI-RESP-SENTIMENT-SCORE
               MOVE 'Neutral' TO AI-RESP-TREND-INDICATION
               MOVE 'No Significant Change Expected' TO AI-RESP-RECOMMENDATION
           END-IF.

           MOVE '0' TO AI-RESP-STATUS. *> Indicate success of AI call.

      *----------------------------------------------------------------*
      * 7000-DISPLAY-AI-INSIGHTS: Displays insights from the IDGAFAI engine. *
      *----------------------------------------------------------------*
       7000-DISPLAY-AI-INSIGHTS.
           DISPLAY "--- IDGAFAI ANALYTICS INSIGHTS ---".
           IF AI-RESP-STATUS = '0'
               DISPLAY "Sentiment Score (0-100): " AI-RESP-SENTIMENT-SCORE.
               DISPLAY "Projected Trend:         " AI-RESP-TREND-INDICATION.
               DISPLAY "IDGAFAI Recommendation:  " AI-RESP-RECOMMENDATION.
           ELSE
               DISPLAY "IDGAFAI Analytics Engine encountered an error.".
               DISPLAY "Please try again later or contact support.".
           END-IF.
           DISPLAY "---------------------------------------------------".

      *----------------------------------------------------------------*
      * 8000-PROMPT-FOR-CONTINUE: Asks user to continue or exit.       *
      *----------------------------------------------------------------*
       8000-PROMPT-FOR-CONTINUE.
           DISPLAY SPACE.
           DISPLAY "Perform another inquiry (Y/N)? ".
           ACCEPT WS-CONTINUE-INQUIRY-FLAG.
           MOVE FUNCTION UPPER-CASE(WS-CONTINUE-INQUIRY-FLAG)
                TO WS-CONTINUE-INQUIRY-FLAG.
           IF WS-CONTINUE-INQUIRY-FLAG NOT EQUAL 'Y'
               SET STOP-INQUIRY TO TRUE
           END-IF.

      *----------------------------------------------------------------*
      * 9000-ERROR-FILE-OPEN: Handles critical file open error.        *
      *----------------------------------------------------------------*
       9000-ERROR-FILE-OPEN.
           DISPLAY "ERROR: Program terminating due to critical file open issue.".
           DISPLAY "File Status: " WS-INVESTMENT-FILE-STATUS.

      *----------------------------------------------------------------*
      * 9999-END-PROGRAM: Terminates the program.                      *
      *----------------------------------------------------------------*
       9999-END-PROGRAM.
           DISPLAY "IVINQ - Program terminated. Goodbye.".
           STOP RUN.