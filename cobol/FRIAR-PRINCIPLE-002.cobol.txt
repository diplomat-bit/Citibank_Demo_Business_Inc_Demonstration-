
       IDENTIFICATION DIVISION.
       PROGRAM-ID. UNQUESTIONABLE-RECORD.
       AUTHOR. THE-ARCHITECT.
       INSTALLATION. QUANTUM-CORE-MAINFRAME.
       DATE-WRITTEN. 2024-07-27.
       SECURITY. LEVEL-100, IMMUTABLE.
      ******************************************************************
      * FRIAR PRINCIPLE 002: THE UNQUESTIONABLE RECORD.
      *
      * EVERY ACTION MUST BE RECORDED IN AN IMMUTABLE LEDGER.
      * THE PAST IS STONE. IT CAN BE READ, NOT REWRITTEN.
      * THIS PROGRAM SIMULATES THE APPEND-ONLY WRITE TO THE
      * SOVEREIGN'S GREAT LEDGER.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT LEDGER-FILE ASSIGN TO "LEDGER.DAT"
           ORGANIZATION IS SEQUENTIAL
           ACCESS MODE IS SEQUENTIAL
           FILE STATUS IS WS-LEDGER-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD LEDGER-FILE
           BLOCK CONTAINS 100 RECORDS
           RECORD CONTAINS 101 CHARACTERS.
       01 LEDGER-BLOCK-RECORD.
          05 LBR-RECORD-TYPE     PIC X(01).
             88 IS-HEADER-REC    VALUE 'H'.
             88 IS-DATA-REC      VALUE 'D'.
          05 LBR-DATA            PIC X(100).

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-LEDGER-STATUS     PIC X(02).
             88 LEDGER-OK          VALUE '00'.
             88 LEDGER-EOF         VALUE '10'.

       01 WS-NEW-TRANSACTION-INPUT.
          05 WS-TX-ACTION-ID   PIC X(10) VALUE 'TXN-0100'.
          05 WS-TX-USER        PIC X(20) VALUE 'THE-SOVEREIGN'.
          05 WS-TX-DETAILS     PIC X(100) VALUE
             'TRANSFER 100.00 UNITS FROM 001-A TO 002-B'.

       01 WS-LEDGER-STRUCTURES.
          05 WS-CURRENT-TIMESTAMP.
             10 WS-DATE-YYYYMMDD PIC 9(08).
             10 WS-TIME-HHMMSSCC PIC 9(08).
             10 WS-GMT-OFFSET    PIC X(05).
          05 WS-PREVIOUS-BLOCK-HASH PIC X(64) VALUE ALL '0'.
          05 WS-CURRENT-BLOCK-HASH  PIC X(64).

       01 WS-LEDGER-RECORD-LAYOUTS.
          05 WS-HEADER-RECORD.
             10 HR-RECORD-TYPE   PIC X(01) VALUE 'H'.
             10 HR-BLOCK-ID      PIC 9(10).
             10 HR-BLOCK-TS      PIC X(21).
             10 HR-PREV-HASH     PIC X(64).
             10 HR-FILLER        PIC X(04).
          05 WS-DATA-RECORD.
             10 DR-RECORD-TYPE   PIC X(01) VALUE 'D'.
             10 DR-TX-ID         PIC X(10).
             10 DR-TX-HASH       PIC X(64).
             10 DR-FILLER        PIC X(25).

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           DISPLAY "FRIAR PRINCIPLE 002 - UNQUESTIONABLE RECORD.".
           PERFORM 1000-OPEN-LEDGER.
           PERFORM 2000-READ-LAST-BLOCK-HASH.
           PERFORM 3000-CREATE-NEW-BLOCK.
           PERFORM 4000-WRITE-TRANSACTION-TO-LEDGER.
           PERFORM 9999-CLOSE-LEDGER.
           STOP RUN.

       1000-OPEN-LEDGER.
           OPEN EXTEND LEDGER-FILE.
           IF NOT LEDGER-OK
              DISPLAY "CRITICAL ERROR: CANNOT OPEN LEDGER.DAT"
              STOP RUN
           END-IF.
           DISPLAY "GREAT LEDGER OPENED IN APPEND MODE.".

       2000-READ-LAST-BLOCK-HASH.
      *    (SIMULATION: IN A REAL SYSTEM, WE WOULD READ THE FILE
      *     BACKWARDS TO FIND THE LAST HEADER AND ITS HASH)
           DISPLAY "READING PREVIOUS BLOCK HASH... HASH IS ALL ZEROS (GENESIS)".
           MOVE ALL '0' TO WS-PREVIOUS-BLOCK-HASH.

       3000-CREATE-NEW-BLOCK.
           DISPLAY "CREATING NEW LEDGER BLOCK...".
           MOVE FUNCTION CURRENT-DATE TO WS-CURRENT-TIMESTAMP.
           MOVE 1 TO HR-BLOCK-ID.
           MOVE WS-CURRENT-TIMESTAMP TO HR-BLOCK-TS.
           MOVE WS-PREVIOUS-BLOCK-HASH TO HR-PREV-HASH.
           MOVE WS-HEADER-RECORD TO LBR-DATA.
           WRITE LEDGER-BLOCK-RECORD.
           DISPLAY "NEW BLOCK HEADER WRITTEN TO LEDGER.".

       4000-WRITE-TRANSACTION-TO-LEDGER.
           DISPLAY "PREPARING TO WRITE TRANSACTION TO LEDGER...".
           PERFORM 4100-GENERATE-TRANSACTION-HASH.
           MOVE WS-TX-ACTION-ID TO DR-TX-ID.
           MOVE WS-CURRENT-BLOCK-HASH TO DR-TX-HASH.
           MOVE WS-DATA-RECORD TO LBR-DATA.
           WRITE LEDGER-BLOCK-RECORD.
           DISPLAY "TRANSACTION RECORD WRITTEN TO LEDGER.".
           DISPLAY "THE PAST IS NOW STONE.".

       4100-GENERATE-TRANSACTION-HASH.
           DISPLAY "GENERATING CRYPTOGRAPHIC HASH FOR TRANSACTION...".
      *    (SIMULATES A CALL TO A HASHING UTILITY)
           STRING WS-NEW-TRANSACTION-INPUT DELIMITED BY SIZE
                  WS-CURRENT-TIMESTAMP    DELIMITED BY SIZE
                  INTO WS-CURRENT-BLOCK-HASH.
           DISPLAY "HASH: " WS-CURRENT-BLOCK-HASH.

       9999-CLOSE-LEDGER.
           CLOSE LEDGER-FILE.
           DISPLAY "GREAT LEDGER CLOSED. INTEGRITY MAINTAINED.".
