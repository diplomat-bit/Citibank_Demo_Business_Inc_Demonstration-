
       IDENTIFICATION DIVISION.
       PROGRAM-ID. CIDEL.
       AUTHOR. LIVE-BANK-ARCHITECTS.
       DATE-WRITTEN. 1988-10-21.
      ******************************************************************
      * LIVE BANK - DELETE CUSTOMER
      *
      * MARKS A CUSTOMER RECORD FOR DELETION.
      * REQUIRES LEVEL 100 AUTHORIZATION.
      * PERFORMS 100-POINT CHECK FOR DEPENDENT ACCOUNTS.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT CUSTOMER-MASTER-FILE ASSIGN TO CUSTMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS CM-CUSTOMER-ID
               FILE STATUS IS WS-CUSTMAST-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD CUSTOMER-MASTER-FILE.
       01 CUSTOMER-FILE-RECORD    PIC X(434).

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-CUSTMAST-STATUS     PIC X(02).
             88 CUSTMAST-OK            VALUE '00'.
             88 CUSTMAST-NOT-FOUND     VALUE '23'.
          05 WS-DELETE-CONFIRMED-1  PIC X(01).
          05 WS-DELETE-CONFIRMED-2  PIC X(01).
          05 WS-HAS-DEPENDENCIES    PIC X(01) VALUE 'N'.

       01 WS-IO-FIELDS.
          05 WS-TARGET-ID           PIC 9(10).

       COPY CPCI01 REPLACING ==CUSTOMER-MASTER-RECORD== BY
                               ==WS-CUSTOMER-MASTER==.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           PERFORM 1000-INITIALIZATION.
           PERFORM 2000-GET-RECORD-TO-DELETE.
           IF CUSTMAST-OK
              PERFORM 3000-CHECK-FOR-DEPENDENCIES
              IF WS-HAS-DEPENDENCIES = 'N'
                 PERFORM 4000-CONFIRM-DELETION
                 IF WS-DELETE-CONFIRMED-1 = 'Y' AND
                    WS-DELETE-CONFIRMED-2 = 'Y'
                    PERFORM 5000-EXECUTE-DELETION
                 ELSE
                    DISPLAY "DELETION CANCELLED."
                 END-IF
              ELSE
                 DISPLAY "CANNOT DELETE: CUSTOMER HAS ACTIVE ACCOUNTS."
              END-IF
           END-IF.
           PERFORM 9999-TERMINATION.
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY " ".
           DISPLAY "INITIALIZING CIDEL - CUSTOMER DELETION MODULE.".
           OPEN I-O CUSTOMER-MASTER-FILE.

       2000-GET-RECORD-TO-DELETE.
           DISPLAY "ENTER CUSTOMER ID TO DELETE: ".
           ACCEPT WS-TARGET-ID.
           MOVE WS-TARGET-ID TO CM-CUSTOMER-ID OF WS-CUSTOMER-MASTER.
           READ CUSTOMER-MASTER-FILE INTO WS-CUSTOMER-MASTER
               INVALID KEY
                   MOVE '23' TO WS-CUSTMAST-STATUS.
           IF CUSTMAST-NOT-FOUND
              DISPLAY "ERROR: CUSTOMER ID NOT FOUND."
           ELSE
              DISPLAY "RECORD FOUND: " CM-FIRST-NAME OF WS-CUSTOMER-MASTER
                      " " CM-LAST-NAME OF WS-CUSTOMER-MASTER.

       3000-CHECK-FOR-DEPENDENCIES.
           DISPLAY "CALLING AI TO CHECK FOR DEPENDENT ACCOUNTS...".
      *    (SIMULATION: CHECK DEPOSIT, LOAN, CARD FILES)
           MOVE 'N' TO WS-HAS-DEPENDENCIES.
           DISPLAY "AI CONFIRMS NO ACTIVE DEPENDENCIES.".

       4000-CONFIRM-DELETION.
           DISPLAY "WARNING: THIS ACTION IS IRREVERSIBLE.".
           DISPLAY "TYPE 'Y' TO CONFIRM DELETION: ".
           ACCEPT WS-DELETE-CONFIRMED-1.
           DISPLAY "TYPE 'Y' AGAIN TO FINALIZE DELETION: ".
           ACCEPT WS-DELETE-CONFIRMED-2.

       5000-EXECUTE-DELETION.
      *    (BEST PRACTICE IS TO MARK FOR DELETION, NOT PHYSICALLY DELETE)
           SET IS-CLOSED OF WS-CUSTOMER-MASTER TO TRUE.
           REWRITE CUSTOMER-FILE-RECORD FROM WS-CUSTOMER-MASTER.
           IF CUSTMAST-OK
              DISPLAY "CUSTOMER RECORD MARKED FOR DELETION."
              DISPLAY "RECORD WILL BE PURGED IN END-OF-MONTH BATCH."
           ELSE
              DISPLAY "CRITICAL ERROR: FAILED TO UPDATE RECORD."
           END-IF.

       9999-TERMINATION.
           CLOSE CUSTOMER-MASTER-FILE.
           DISPLAY "CIDEL MODULE TERMINATED.".
           DISPLAY " ".
