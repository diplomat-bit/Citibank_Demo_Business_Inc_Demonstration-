
       IDENTIFICATION DIVISION.
       PROGRAM-ID. LAOPEN.
       AUTHOR. LIVE-BANK-ARCHITECTS.
       DATE-WRITTEN. 1990-03-01.
      ******************************************************************
      * LIVE BANK - OPEN NEW LOAN
      *
      * ORIGINATES A NEW LOAN, PERFORMS 100-POINT RISK ASSESSMENT,
      * AND WRITES THE RECORD TO THE LOAN MASTER FILE.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT LOAN-MASTER-FILE ASSIGN TO LOANMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS LM-LOAN-ID
               FILE STATUS IS WS-LOANMAST-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD LOAN-MASTER-FILE.
       01 LOAN-FILE-RECORD    PIC X(131).

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-LOANMAST-STATUS   PIC X(02).
             88 LOANMAST-OK          VALUE '00'.

       01 WS-INPUT-FIELDS.
          05 WS-INPUT-CUST-ID     PIC 9(10).
          05 WS-INPUT-PRINCIPAL   PIC S9(13)V99.
          05 WS-INPUT-TERM        PIC 9(03).
          05 WS-INPUT-LOAN-TYPE   PIC X(04).

       01 WS-CALCULATED-FIELDS.
          05 WS-NEW-LOAN-ID       PIC 9(12).
          05 WS-INTEREST-RATE     PIC S9(03)V99.
          05 WS-MONTHLY-RATE      PIC S9(1)V9(6).
          05 WS-MONTHLY-PAYMENT   PIC S9(7)V99.

       COPY CPLA01 REPLACING ==LOAN-MASTER-RECORD== BY ==WS-LOAN-MASTER==.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           PERFORM 1000-INITIALIZATION.
           PERFORM 2000-ACCEPT-LOAN-DATA.
           PERFORM 3000-UNDERWRITE-LOAN.
           PERFORM 4000-WRITE-LOAN-RECORD.
           PERFORM 9999-TERMINATION.
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY " ".
           DISPLAY "INITIALIZING LAOPEN - LOAN ORIGINATION MODULE.".
           OPEN I-O LOAN-MASTER-FILE.

       2000-ACCEPT-LOAN-DATA.
           DISPLAY "ENTER CUSTOMER ID: ".
           ACCEPT WS-INPUT-CUST-ID.
           DISPLAY "ENTER LOAN TYPE (AUTO/PERS/MORT): ".
           ACCEPT WS-INPUT-LOAN-TYPE.
           DISPLAY "ENTER PRINCIPAL AMOUNT: ".
           ACCEPT WS-INPUT-PRINCIPAL.
           DISPLAY "ENTER TERM (IN MONTHS): ".
           ACCEPT WS-INPUT-TERM.

       3000-UNDERWRITE-LOAN.
           DISPLAY "SUBMITTING APPLICATION TO AI UNDERWRITING ENGINE...".
           CALL "AI-INTEGRATION-LAYER" USING WS-INPUT-FIELDS
                                       GIVING WS-INTEREST-RATE.
           DISPLAY "AI RECOMMENDED INTEREST RATE: " WS-INTEREST-RATE "%".
           
      *    CALCULATE MONTHLY PAYMENT USING AMORTIZATION FORMULA
      *    M = P * [i(1+i)^n] / [(1+i)^n - 1]
           COMPUTE WS-MONTHLY-RATE = (WS-INTEREST-RATE / 100) / 12.
           COMPUTE WS-MONTHLY-PAYMENT ROUNDED =
               WS-INPUT-PRINCIPAL * (WS-MONTHLY-RATE *
               (1 + WS-MONTHLY-RATE) ** WS-INPUT-TERM) /
               (((1 + WS-MONTHLY-RATE) ** WS-INPUT-TERM) - 1).

           DISPLAY "CALCULATED MONTHLY PAYMENT: " WS-MONTHLY-PAYMENT.

       4000-WRITE-LOAN-RECORD.
           MOVE 987654321098 TO WS-NEW-LOAN-ID. *> SIMULATED
           MOVE WS-NEW-LOAN-ID TO LM-LOAN-ID OF WS-LOAN-MASTER.
           MOVE WS-INPUT-CUST-ID TO LM-CUSTOMER-ID OF WS-LOAN-MASTER.
           MOVE WS-INPUT-PRINCIPAL TO LM-ORIGINAL-PRINCIPAL OF
                                       WS-LOAN-MASTER.
           MOVE WS-INPUT-PRINCIPAL TO LM-CURRENT-PRINCIPAL OF
                                       WS-LOAN-MASTER.
           MOVE WS-INTEREST-RATE TO LM-INTEREST-RATE OF WS-LOAN-MASTER.
           MOVE WS-INPUT-TERM TO LM-TERM-MONTHS OF WS-LOAN-MASTER.
           MOVE WS-MONTHLY-PAYMENT TO LM-NEXT-PAYMENT-AMT OF
                                       WS-LOAN-MASTER.
           SET LOAN-ACTIVE OF WS-LOAN-MASTER TO TRUE.

           WRITE LOAN-FILE-RECORD FROM WS-LOAN-MASTER
               INVALID KEY
                   DISPLAY "CRITICAL ERROR: DUPLICATE LOAN ID."
                   PERFORM 9999-TERMINATION
                   STOP RUN
           END-WRITE.

           IF LOANMAST-OK
              DISPLAY "LOAN " WS-NEW-LOAN-ID " OPENED AND FUNDED."
           ELSE
              DISPLAY "ERROR WRITING TO LOAN MASTER FILE."
           END-IF.

       9999-TERMINATION.
           CLOSE LOAN-MASTER-FILE.
           DISPLAY "LAOPEN MODULE TERMINATED.".
           DISPLAY " ".
