
       IDENTIFICATION DIVISION.
       PROGRAM-ID. DAOPEN.
       AUTHOR. LIVE-BANK-ARCHITECTS.
       DATE-WRITTEN. 1989-01-10.
      ******************************************************************
      * LIVE BANK - OPEN NEW DEPOSIT ACCOUNT
      *
      * CREATES A NEW ACCOUNT RECORD IN THE DEPOSIT ACCOUNT MASTER FILE.
      * PERFORMS 100-POINT KYC AND CUSTOMER VERIFICATION.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT DEPOSIT-ACCOUNT-FILE ASSIGN TO DEPMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS DA-ACCOUNT-NUMBER
               FILE STATUS IS WS-DEPMAST-STATUS.
           SELECT CUSTOMER-MASTER-FILE ASSIGN TO CUSTMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS CM-CUSTOMER-ID
               FILE STATUS IS WS-CUSTMAST-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD DEPOSIT-ACCOUNT-FILE.
       01 DEPOSIT-FILE-RECORD    PIC X(201).
       FD CUSTOMER-MASTER-FILE.
       01 CUSTOMER-FILE-RECORD   PIC X(434).

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-DEPMAST-STATUS      PIC X(02).
             88 DEPMAST-OK             VALUE '00'.
          05 WS-CUSTMAST-STATUS     PIC X(02).
             88 CUSTMAST-OK            VALUE '00'.
             88 CUSTMAST-NOT-FOUND     VALUE '23'.
          05 WS-VALIDATION-FLAG     PIC X(01) VALUE 'N'.
             88 VALIDATION-PASSED      VALUE 'Y'.

       01 WS-INPUT-FIELDS.
          05 WS-INPUT-CUST-ID       PIC 9(10).
          05 WS-INPUT-ACCT-TYPE     PIC X(04).
          05 WS-INPUT-INIT-DEPOSIT  PIC S9(13)V99.

       01 WS-GENERATED-FIELDS.
          05 WS-NEW-ACCT-NUM        PIC 9(12).

       COPY CPDA01 REPLACING ==DEPOSIT-ACCOUNT-RECORD== BY
                             ==WS-DEPOSIT-ACCOUNT==.
       COPY CPCI01.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           PERFORM 1000-INITIALIZATION.
           PERFORM 2000-ACCEPT-NEW-ACCOUNT-DATA.
           PERFORM 3000-VALIDATE-CUSTOMER.
           IF VALIDATION-PASSED
              PERFORM 4000-GENERATE-ACCOUNT-NUMBER
              PERFORM 5000-WRITE-NEW-ACCOUNT-RECORD
           END-IF.
           PERFORM 9999-TERMINATION.
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY " ".
           DISPLAY "INITIALIZING DAOPEN - NEW DEPOSIT ACCOUNT MODULE.".
           OPEN I-O DEPOSIT-ACCOUNT-FILE.
           OPEN INPUT CUSTOMER-MASTER-FILE.

       2000-ACCEPT-NEW-ACCOUNT-DATA.
           DISPLAY "ENTER CUSTOMER ID FOR NEW ACCOUNT: ".
           ACCEPT WS-INPUT-CUST-ID.
           DISPLAY "ENTER ACCOUNT TYPE (CHKG/SAVG): ".
           ACCEPT WS-INPUT-ACCT-TYPE.
           DISPLAY "ENTER INITIAL DEPOSIT AMOUNT: ".
           ACCEPT WS-INPUT-INIT-DEPOSIT.

       3000-VALIDATE-CUSTOMER.
           DISPLAY "VALIDATING CUSTOMER ID " WS-INPUT-CUST-ID "...".
           MOVE WS-INPUT-CUST-ID TO CM-CUSTOMER-ID.
           READ CUSTOMER-MASTER-FILE
               INVALID KEY MOVE '23' TO WS-CUSTMAST-STATUS.
           
           IF CUSTMAST-OK
              SET VALIDATION-PASSED TO TRUE
              DISPLAY "CUSTOMER ID VERIFIED."
           ELSE
              DISPLAY "ERROR: CUSTOMER ID NOT FOUND ON MASTER FILE."
           END-IF.

       4000-GENERATE-ACCOUNT-NUMBER.
           DISPLAY "GENERATING SECURE ACCOUNT NUMBER...".
      *    (SIMULATION OF ACCOUNT NUMBER GENERATION)
           MOVE 123456789012 TO WS-NEW-ACCT-NUM.

       5000-WRITE-NEW-ACCOUNT-RECORD.
           MOVE WS-NEW-ACCT-NUM TO DA-ACCOUNT-NUMBER OF WS-DEPOSIT-ACCOUNT.
           MOVE WS-INPUT-CUST-ID TO DA-CUSTOMER-ID OF WS-DEPOSIT-ACCOUNT.
           MOVE WS-INPUT-ACCT-TYPE TO DA-ACCOUNT-TYPE OF
                                      WS-DEPOSIT-ACCOUNT.
           MOVE WS-INPUT-INIT-DEPOSIT TO DA-CURRENT-BALANCE OF
                                         WS-DEPOSIT-ACCOUNT.
           MOVE WS-INPUT-INIT-DEPOSIT TO DA-AVAILABLE-BAL OF
                                         WS-DEPOSIT-ACCOUNT.
           MOVE ZERO TO DA-HOLD-AMOUNT OF WS-DEPOSIT-ACCOUNT.
           SET DA-IS-ACTIVE OF WS-DEPOSIT-ACCOUNT TO TRUE.

           WRITE DEPOSIT-FILE-RECORD FROM WS-DEPOSIT-ACCOUNT
               INVALID KEY
                   DISPLAY "CRITICAL ERROR: DUPLICATE ACCOUNT NUMBER."
                   PERFORM 9999-TERMINATION
                   STOP RUN
           END-WRITE.

           IF DEPMAST-OK
              DISPLAY "ACCOUNT " WS-NEW-ACCT-NUM " OPENED SUCCESSFULLY."
           ELSE
              DISPLAY "ERROR WRITING TO DEPOSIT ACCOUNT FILE."
           END-IF.

       9999-TERMINATION.
           CLOSE DEPOSIT-ACCOUNT-FILE, CUSTOMER-MASTER-FILE.
           DISPLAY "DAOPEN MODULE TERMINATED.".
           DISPLAY " ".
