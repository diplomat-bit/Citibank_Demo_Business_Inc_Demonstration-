
       IDENTIFICATION DIVISION.
       PROGRAM-ID. CRSTMT.
       AUTHOR. LIVE-BANK-ARCHITECTS.
       DATE-WRITTEN. 1992-01-20.
      ******************************************************************
      * LIVE BANK - GENERATE CARDHOLDER STATEMENT
      *
      * GENERATES A MONTHLY STATEMENT FOR A GIVEN CARDHOLDER,
      * INCLUDING ALL TRANSACTIONS AND A SUMMARY OF CHARGES.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT CARDHOLDER-MASTER-FILE ASSIGN TO CARDMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS CR-CARD-NUMBER.
           SELECT TRANSACTION-FILE ASSIGN TO TRANLOG.
           SELECT STATEMENT-FILE ASSIGN TO STMTOUT.

       DATA DIVISION.
       FILE SECTION.
       FD CARDHOLDER-MASTER-FILE.
       01 CARD-FILE-RECORD    PIC X(114).
       FD TRANSACTION-FILE.
       01 TX-RECORD-IN.
          05 TX-CARD-NUMBER     PIC 9(16).
          05 TX-DATE            PIC X(10).
          05 TX-DESCRIPTION     PIC X(50).
          05 TX-AMOUNT          PIC S9(7)V99.
       FD STATEMENT-FILE.
       01 STMT-LINE           PIC X(132).

       WORKING-STORAGE SECTION.
       01 WS-INPUT-CARD-NUMBER   PIC 9(16).
       01 WS-EOF-FLAG            PIC X(01) VALUE 'N'.
          88 END-OF-TRANSACTIONS  VALUE 'Y'.
       01 WS-STATEMENT-DATES.
          05 WS-START-DATE      PIC X(10) VALUE "2024-07-01".
          05 WS-END-DATE        PIC X(10) VALUE "2024-07-31".
       01 WS-REPORT-TOTALS.
          05 WS-TOTAL-CHARGES   PIC S9(9)V99 VALUE 0.
          05 WS-TOTAL-PAYMENTS  PIC S9(9)V99 VALUE 0.
          05 WS-NEW-BALANCE     PIC S9(9)V99.
       COPY CPCR01.
       01 WS-STATEMENT-HEADER.
          05 FILLER             PIC X(20) VALUE 'STATEMENT FOR CARD: '.
          05 ST-CARD-NUM        PIC 9(16).
       01 WS-TRANSACTION-LINE.
          05 ST-TX-DATE         PIC X(10).
          05 FILLER             PIC X(05) VALUE SPACES.
          05 ST-TX-DESC         PIC X(50).
          05 ST-TX-AMOUNT       PIC $$$,$$9.99.
       01 WS-SUMMARY-LINE.
          05 SL-LABEL           PIC X(20).
          05 SL-AMOUNT          PIC $$$,$$$,$$9.99.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           OPEN INPUT CARDHOLDER-MASTER-FILE, TRANSACTION-FILE.
           OPEN OUTPUT STATEMENT-FILE.
           DISPLAY "ENTER CARD NUMBER FOR STATEMENT GENERATION: ".
           ACCEPT WS-INPUT-CARD-NUMBER.
           PERFORM 1000-READ-CARDHOLDER.
           PERFORM 2000-WRITE-STATEMENT-HEADER.
           PERFORM 3000-PROCESS-TRANSACTIONS
               UNTIL END-OF-TRANSACTIONS.
           PERFORM 4000-WRITE-SUMMARY.
           CLOSE CARDHOLDER-MASTER-FILE, TRANSACTION-FILE, STATEMENT-FILE.
           DISPLAY "STATEMENT GENERATED.".
           STOP RUN.

       1000-READ-CARDHOLDER.
           MOVE WS-INPUT-CARD-NUMBER TO CR-CARD-NUMBER.
           READ CARDHOLDER-MASTER-FILE
               INVALID KEY DISPLAY "CARD NOT FOUND" STOP RUN.

       2000-WRITE-STATEMENT-HEADER.
           MOVE CR-CARD-NUMBER TO ST-CARD-NUM.
           WRITE STMT-LINE FROM WS-STATEMENT-HEADER.
           WRITE STMT-LINE FROM " ".
           WRITE STMT-LINE FROM "DATE         DESCRIPTION".

       3000-PROCESS-TRANSACTIONS.
           READ TRANSACTION-FILE
               AT END SET END-OF-TRANSACTIONS TO TRUE
           END-READ.
           IF NOT END-OF-TRANSACTIONS
              IF (TX-CARD-NUMBER = WS-INPUT-CARD-NUMBER) AND
                 (TX-DATE >= WS-START-DATE) AND (TX-DATE <= WS-END-DATE)
                 PERFORM 3100-FORMAT-AND-WRITE-LINE
              END-IF
           END-IF.

       3100-FORMAT-AND-WRITE-LINE.
           MOVE TX-DATE TO ST-TX-DATE.
           MOVE TX-DESCRIPTION TO ST-TX-DESC.
           MOVE TX-AMOUNT TO ST-TX-AMOUNT.
           WRITE STMT-LINE FROM WS-TRANSACTION-LINE.

           IF TX-AMOUNT > 0
              ADD TX-AMOUNT TO WS-TOTAL-CHARGES
           ELSE
              ADD TX-AMOUNT TO WS-TOTAL-PAYMENTS
           END-IF.

       4000-WRITE-SUMMARY.
           WRITE STMT-LINE FROM " ".
           WRITE STMT-LINE FROM "--- SUMMARY ---".
           MOVE "Previous Balance: " TO SL-LABEL.
           MOVE CR-CURRENT-BALANCE TO SL-AMOUNT.
           WRITE STMT-LINE FROM WS-SUMMARY-LINE.

           MOVE "Total Charges: " TO SL-LABEL.
           MOVE WS-TOTAL-CHARGES TO SL-AMOUNT.
           WRITE STMT-LINE FROM WS-SUMMARY-LINE.

           MOVE "Total Payments: " TO SL-LABEL.
           MOVE WS-TOTAL-PAYMENTS TO SL-AMOUNT.
           WRITE STMT-LINE FROM WS-SUMMARY-LINE.

           COMPUTE WS-NEW-BALANCE = CR-CURRENT-BALANCE +
               WS-TOTAL-CHARGES + WS-TOTAL-PAYMENTS.
           MOVE "New Balance: " TO SL-LABEL.
           MOVE WS-NEW-BALANCE TO SL-AMOUNT.
           WRITE STMT-LINE FROM WS-SUMMARY-LINE.
