
       IDENTIFICATION DIVISION.
       PROGRAM-ID. LAPAY.
       AUTHOR. LIVE-BANK-ARCHITECTS.
       DATE-WRITTEN. 1990-03-10.
      ******************************************************************
      * LIVE BANK - PROCESS LOAN PAYMENT
      *
      * APPLIES A PAYMENT TO A LOAN, CALCULATING THE SPLIT
      * BETWEEN PRINCIPAL AND INTEREST.
      ******************************************************************
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT LOAN-MASTER-FILE ASSIGN TO LOANMAST
               ORGANIZATION IS INDEXED
               ACCESS MODE IS DYNAMIC
               RECORD KEY IS LM-LOAN-ID
               FILE STATUS IS WS-LOANMAST-STATUS.

       DATA DIVISION.
       FILE SECTION.
       FD LOAN-MASTER-FILE.
       01 LOAN-FILE-RECORD    PIC X(131).

       WORKING-STORAGE SECTION.
       01 WS-PROGRAM-SWITCHES.
          05 WS-LOANMAST-STATUS     PIC X(02).
             88 LOANMAST-OK            VALUE '00'.
             88 LOANMAST-NOT-FOUND     VALUE '23'.

       01 WS-INPUT-FIELDS.
          05 WS-INPUT-LOAN-ID       PIC 9(12).
          05 WS-INPUT-PAYMENT-AMT   PIC S9(7)V99.

       01 WS-CALCULATION-FIELDS.
          05 WS-CALC-INTEREST-DUE   PIC S9(7)V99.
          05 WS-CALC-PRINCIPAL-PAID PIC S9(7)V99.

       COPY CPLA01 REPLACING ==LOAN-MASTER-RECORD== BY
                               ==WS-LOAN-MASTER==.

       PROCEDURE DIVISION.
       0000-MAIN-LOGIC.
           PERFORM 1000-INITIALIZATION.
           PERFORM 2000-PROCESS-PAYMENT.
           PERFORM 9999-TERMINATION.
           STOP RUN.

       1000-INITIALIZATION.
           DISPLAY " ".
           DISPLAY "INITIALIZING LAPAY - LOAN PAYMENT MODULE.".
           OPEN I-O LOAN-MASTER-FILE.

       2000-PROCESS-PAYMENT.
           DISPLAY "ENTER LOAN ID: ".
           ACCEPT WS-INPUT-LOAN-ID.
           DISPLAY "ENTER PAYMENT AMOUNT: ".
           ACCEPT WS-INPUT-PAYMENT-AMT.

           MOVE WS-INPUT-LOAN-ID TO LM-LOAN-ID OF WS-LOAN-MASTER.
           READ LOAN-MASTER-FILE INTO WS-LOAN-MASTER
               INVALID KEY MOVE '23' TO WS-LOANMAST-STATUS.

           IF LOANMAST-NOT-FOUND
              DISPLAY "ERROR: LOAN ID NOT FOUND."
           ELSE
              PERFORM 2100-CALCULATE-SPLIT
              PERFORM 2200-UPDATE-LOAN-RECORD
           END-IF.

       2100-CALCULATE-SPLIT.
           DISPLAY "CALCULATING INTEREST AND PRINCIPAL...".
      *    (SIMPLIFIED CALCULATION FOR DEMO)
           COMPUTE WS-CALC-INTEREST-DUE =
               LM-CURRENT-PRINCIPAL OF WS-LOAN-MASTER *
               (LM-INTEREST-RATE OF WS-LOAN-MASTER / 12).

           IF WS-INPUT-PAYMENT-AMT > WS-CALC-INTEREST-DUE
              COMPUTE WS-CALC-PRINCIPAL-PAID =
                  WS-INPUT-PAYMENT-AMT - WS-CALC-INTEREST-DUE
           ELSE
              MOVE WS-INPUT-PAYMENT-AMT TO WS-CALC-INTEREST-DUE
              MOVE ZERO TO WS-CALC-PRINCIPAL-PAID
           END-IF.

           DISPLAY "INTEREST PAID: " WS-CALC-INTEREST-DUE.
           DISPLAY "PRINCIPAL PAID: " WS-CALC-PRINCIPAL-PAID.

       2200-UPDATE-LOAN-RECORD.
           SUBTRACT WS-CALC-PRINCIPAL-PAID FROM
               LM-CURRENT-PRINCIPAL OF WS-LOAN-MASTER.

           REWRITE LOAN-FILE-RECORD FROM WS-LOAN-MASTER.

           IF LOANMAST-OK
              DISPLAY "PAYMENT PROCESSED. NEW BALANCE: "
                      LM-CURRENT-PRINCIPAL OF WS-LOAN-MASTER
           ELSE
              DISPLAY "ERROR: FAILED TO UPDATE LOAN RECORD."
           END-IF.

       9999-TERMINATION.
           CLOSE LOAN-MASTER-FILE.
           DISPLAY "LAPAY MODULE TERMINATED.".
           DISPLAY " ".
