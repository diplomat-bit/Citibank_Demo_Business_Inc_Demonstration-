
--- FILE: AccessControlsView.tsx ---

import React, { useContext, useMemo, useState, useCallback, useEffect, createContext } from 'react';
import Card from '../../../Card';
import { DataContext } from '../../../../context/DataContext';
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend, BarChart, Bar, PieChart, Pie, Cell } from 'recharts';
import { AccessLog } from '../../../../types';

// --- NEW TYPES FOR EXPANSION ---
/**
 * Represents a user within the system, potentially with linked roles.
 */
export interface User {
    id: string;
    username: string;
    email: string;
    status: 'Active' | 'Inactive' | 'Locked';
    lastLogin: string; // ISO string
    roles: string[]; // IDs of roles
    department: string;
    title: string;
    mfaEnabled: boolean;
    location: string; // Geographical location (e.g., "New York, USA")
    ipWhitelist: string[]; // List of allowed IP addresses for this user
    riskScore: number; // Calculated risk score for the user (0-100)
    creationDate: string; // ISO string
    lastActivity: string; // ISO string
    permissions: string[]; // Direct permissions assigned to user, not via roles
}

/**
 * Represents a role with a set of permissions.
 */
export interface Role {
    id: string;
    name: string;
    description: string;
    permissions: string[]; // List of permission IDs
    users: string[]; // List of user IDs assigned to this role
    creationDate: string; // ISO string
    lastModified: string; // ISO string
    isActive: boolean;
    level: 'System' | 'Admin' | 'User' | 'Guest' | 'Custom';
}

/**
 * Represents a specific permission that can be assigned to roles or users.
 */
export interface Permission {
    id: string;
    name: string;
    description: string;
    category: string; // e.g., 'Dashboard', 'Reports', 'User Management'
    module: string; // e.g., 'Access Control', 'Data Analytics'
}

/**
 * Represents an active user session.
 */
export interface ActiveSession {
    id: string;
    userId: string;
    username: string;
    loginTime: string; // ISO string
    lastActivity: string; // ISO string
    ipAddress: string;
    location: string;
    device: string; // e.g., 'Chrome on Windows 10'
    browser: string;
    os: string;
    status: 'Active' | 'Idle' | 'Terminated';
    tokenExpiry: string; // ISO string
}

/**
 * Represents a security policy.
 */
export interface SecurityPolicy {
    id: string;
    name: string;
    type: 'Password' | 'MFA' | 'Session' | 'IP Restriction' | 'Data Access' | 'Custom';
    description: string;
    isEnabled: boolean;
    parameters: Record<string, any>; // JSON object for policy-specific parameters
    creationDate: string; // ISO string
    lastModified: string; // ISO string
    enforcementScope: 'Global' | 'Department' | 'Role' | 'User'; // Who the policy applies to
    targetIds?: string[]; // IDs of departments, roles, or users if scope is not global
}

/**
 * Represents a detected anomaly.
 */
export interface SecurityAnomaly {
    id: string;
    type: 'Unusual Login Location' | 'Brute Force Attempt' | 'Privilege Escalation' | 'Data Exfiltration' | 'Login Spike';
    timestamp: string; // ISO string
    description: string;
    severity: 'Low' | 'Medium' | 'High' | 'Critical';
    relatedUserId?: string;
    relatedIpAddress?: string;
    status: 'New' | 'Investigating' | 'Resolved' | 'False Positive';
    triggeredRules: string[];
    resolutionNotes?: string;
    assignedTo?: string; // User ID of the analyst
}

/**
 * Represents a global threat intelligence alert.
 */
export interface ThreatIntelligenceAlert {
    id: string;
    title: string;
    description: string;
    severity: 'Low' | 'Medium' | 'High' | 'Critical';
    source: string; // e.g., 'CyberSecurity News', 'Internal Sensor', 'Threat Feed X'
    timestamp: string; // ISO string
    relatedCVEs?: string[];
    recommendedActions: string[];
    status: 'Active' | 'Archived' | 'Mitigated';
    detectionVector: string; // How the threat might manifest or was detected
}

// --- MOCK DATA GENERATION UTILITIES ---
const generateId = () => Math.random().toString(36).substr(2, 9);
const getRandomInt = (min: number, max: number) => Math.floor(Math.random() * (max - min + 1)) + min;
const getRandomElement = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)];

const USERNAMES = ['alice', 'bob', 'charlie', 'diana', 'eve', 'frank', 'grace', 'heidi', 'ivan', 'judy', 'ken', 'lisa'];
const IPS = ['192.168.1.1', '10.0.0.5', '172.16.0.10', '203.0.113.45', '198.51.100.12', '203.0.113.100', '198.51.100.200'];
const LOCATIONS = ['New York, USA', 'London, UK', 'Berlin, DE', 'Tokyo, JP', 'Sydney, AU', 'Mumbai, IN', 'Paris, FR'];
const DEVICES = ['Chrome on Windows 10', 'Firefox on macOS', 'Safari on iOS', 'Edge on Android'];
const DEPARTMENTS = ['Engineering', 'Marketing', 'Sales', 'HR', 'Finance', 'Operations', 'IT'];
const TITLES = ['Software Engineer', 'Product Manager', 'Marketing Specialist', 'Sales Manager', 'HR Generalist', 'Accountant', 'IT Support'];
const PERMISSION_CATEGORIES = ['User Management', 'Role Management', 'Policy Management', 'Audit Logging', 'Dashboard Analytics', 'System Configuration'];
const RISK_LEVELS: AccessLog['riskLevel'][] = ['Low', 'Medium', 'High'];
const ANOMALY_TYPES: SecurityAnomaly['type'][] = ['Unusual Login Location', 'Brute Force Attempt', 'Login Spike', 'Privilege Escalation'];
const THREAT_SOURCES = ['DarkWeb Monitor', 'CVE Database', 'Internal Security Team', 'Industry Report'];

const generateMockPermissions = (): Permission[] => {
    const permissions: Permission[] = [];
    let idCounter = 1;
    for (const cat of PERMISSION_CATEGORIES) {
        for (let i = 1; i <= 5; i++) {
            permissions.push({
                id: `perm-${idCounter++}`,
                name: `Can ${cat.replace(' ', '')}Action${i}`,
                description: `Allows specific action ${i} within the ${cat} category.`,
                category: cat,
                module: 'Access Control',
            });
        }
    }
    return permissions;
};

export const MOCK_PERMISSIONS = generateMockPermissions();

const generateMockRoles = (permissions: Permission[]): Role[] => {
    const allPermIds = permissions.map(p => p.id);
    return [
        {
            id: 'role-admin',
            name: 'Administrator',
            description: 'Full system access with all management capabilities.',
            permissions: allPermIds,
            users: [],
            creationDate: new Date(Date.now() - getRandomInt(365, 730) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            isActive: true,
            level: 'Admin',
        },
        {
            id: 'role-user',
            name: 'Standard User',
            description: 'Basic access to dashboards and personal settings.',
            permissions: allPermIds.filter(p => p.includes('Action1') || p.includes('Dashboard')),
            users: [],
            creationDate: new Date(Date.now() - getRandomInt(180, 500) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            isActive: true,
            level: 'User',
        },
        {
            id: 'role-auditor',
            name: 'Security Auditor',
            description: 'Read-only access to all logs and security configurations.',
            permissions: allPermIds.filter(p => p.includes('Audit') || p.includes('Analytics')),
            users: [],
            creationDate: new Date(Date.now() - getRandomInt(90, 300) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            isActive: true,
            level: 'System',
        },
    ];
};

export const MOCK_ROLES = generateMockRoles(MOCK_PERMISSIONS);

const generateMockUsers = (roles: Role[], count: number): User[] => {
    const users: User[] = [];
    const roleIds = roles.map(r => r.id);
    for (let i = 0; i < count; i++) {
        const userId = generateId();
        const userRoles = [getRandomElement(roleIds)];
        if (Math.random() > 0.7) userRoles.push(getRandomElement(roleIds)); // Assign a second role sometimes

        const creationDate = new Date(Date.now() - getRandomInt(30, 730) * 24 * 60 * 60 * 1000);
        const lastLoginDate = new Date(creationDate.getTime() + getRandomInt(1, 30) * 24 * 60 * 60 * 1000);
        const lastActivityDate = new Date(Date.now() - getRandomInt(1, 7) * 24 * 60 * 60 * 1000);

        users.push({
            id: userId,
            username: `${getRandomElement(USERNAMES)}${i}`,
            email: `${getRandomElement(USERNAMES)}${i}@example.com`,
            status: getRandomElement(['Active', 'Active', 'Inactive', 'Locked']),
            lastLogin: lastLoginDate.toISOString(),
            roles: userRoles,
            department: getRandomElement(DEPARTMENTS),
            title: getRandomElement(TITLES),
            mfaEnabled: Math.random() > 0.3,
            location: getRandomElement(LOCATIONS),
            ipWhitelist: Math.random() > 0.8 ? [getRandomElement(IPS)] : [],
            riskScore: getRandomInt(10, 90),
            creationDate: creationDate.toISOString(),
            lastActivity: lastActivityDate.toISOString(),
            permissions: Math.random() > 0.9 ? [getRandomElement(MOCK_PERMISSIONS).id] : [], // Direct permissions
        });

        // Update roles with user IDs
        userRoles.forEach(roleId => {
            const role = roles.find(r => r.id === roleId);
            if (role && !role.users.includes(userId)) {
                role.users.push(userId);
            }
        });
    }
    return users;
};

export const MOCK_USERS = generateMockUsers(MOCK_ROLES, 150); // 150 mock users

const generateMockAccessLogs = (users: User[], count: number): AccessLog[] => {
    const logs: AccessLog[] = [];
    for (let i = 0; i < count; i++) {
        const user = getRandomElement(users);
        const status = Math.random() > 0.2 ? 'Success' : 'Failed'; // 80% success
        const timestamp = new Date(Date.now() - getRandomInt(0, 24 * 60 * 60 * 1000)).toISOString();
        const riskLevel = status === 'Failed' && Math.random() > 0.5 ? getRandomElement(['Medium', 'High']) : 'Low';

        logs.push({
            id: generateId(),
            user: user.username,
            ip: getRandomElement(IPS),
            location: getRandomElement(LOCATIONS),
            timestamp: timestamp,
            status: status,
            riskLevel: riskLevel,
            action: getRandomElement(['Login', 'Dashboard Access', 'Report Generation', 'User Update', 'Policy Change']),
            device: getRandomElement(DEVICES),
        });
    }
    return logs;
};

export const MOCK_ACCESS_LOGS = generateMockAccessLogs(MOCK_USERS, 2000); // 2000 access logs

const generateMockActiveSessions = (users: User[], count: number): ActiveSession[] => {
    const sessions: ActiveSession[] = [];
    for (let i = 0; i < count; i++) {
        const user = getRandomElement(users);
        const loginTime = new Date(Date.now() - getRandomInt(1, 24) * 60 * 60 * 1000).toISOString();
        const lastActivity = new Date(Date.parse(loginTime) + getRandomInt(5, 60) * 60 * 1000).toISOString();
        const tokenExpiry = new Date(Date.parse(loginTime) + getRandomInt(2, 8) * 60 * 60 * 1000).toISOString();

        sessions.push({
            id: generateId(),
            userId: user.id,
            username: user.username,
            loginTime: loginTime,
            lastActivity: lastActivity,
            ipAddress: getRandomElement(IPS),
            location: getRandomElement(LOCATIONS),
            device: getRandomElement(DEVICES),
            browser: getRandomElement(['Chrome', 'Firefox', 'Safari', 'Edge']),
            os: getRandomElement(['Windows 10', 'macOS', 'iOS', 'Android', 'Linux']),
            status: getRandomElement(['Active', 'Idle']),
            tokenExpiry: tokenExpiry,
        });
    }
    return sessions;
};

export const MOCK_ACTIVE_SESSIONS = generateMockActiveSessions(MOCK_USERS, 50);

const generateMockSecurityPolicies = (roles: Role[]): SecurityPolicy[] => {
    const policies: SecurityPolicy[] = [
        {
            id: generateId(),
            name: 'Strong Password Policy',
            type: 'Password',
            description: 'Requires passwords to be at least 12 characters, with uppercase, lowercase, numbers, and symbols. Expires every 90 days.',
            isEnabled: true,
            parameters: { minLength: 12, requireUpper: true, requireLower: true, requireNumber: true, requireSymbol: true, expiryDays: 90, historyCount: 5 },
            creationDate: new Date(Date.now() - getRandomInt(180, 365) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            enforcementScope: 'Global',
        },
        {
            id: generateId(),
            name: 'MFA Enforcement',
            type: 'MFA',
            description: 'Multi-factor authentication required for all login attempts.',
            isEnabled: true,
            parameters: { required: true, methods: ['TOTP', 'SMS', 'Email'], gracePeriodDays: 7 },
            creationDate: new Date(Date.now() - getRandomInt(90, 200) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            enforcementScope: 'Global',
        },
        {
            id: generateId(),
            name: 'Session Inactivity Timeout',
            type: 'Session',
            description: 'Automatically logs out users after 30 minutes of inactivity.',
            isEnabled: true,
            parameters: { inactivityTimeoutMinutes: 30, maxSessionDurationHours: 8 },
            creationDate: new Date(Date.now() - getRandomInt(60, 150) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            enforcementScope: 'Global',
        },
        {
            id: generateId(),
            name: 'Admin Role IP Restriction',
            type: 'IP Restriction',
            description: 'Limits login for Administrator role to corporate network IPs.',
            isEnabled: false, // Currently disabled for flexibility
            parameters: { allowedIPs: ['192.168.1.0/24', '10.0.0.0/8'], action: 'Deny_Others' },
            creationDate: new Date(Date.now() - getRandomInt(30, 90) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            enforcementScope: 'Role',
            targetIds: [roles.find(r => r.name === 'Administrator')?.id || ''],
        },
        {
            id: generateId(),
            name: 'Data Access for Finance',
            type: 'Data Access',
            description: 'Specific data access rules for Finance department users.',
            isEnabled: true,
            parameters: { accessLevel: 'Restricted', sensitiveDataTags: ['Financial', 'PII'], readOnly: true },
            creationDate: new Date(Date.now() - getRandomInt(10, 40) * 24 * 60 * 60 * 1000).toISOString(),
            lastModified: new Date().toISOString(),
            enforcementScope: 'Department',
            targetIds: ['Finance'], // Assuming departments are identified by name/ID
        },
    ];
    return policies;
};

export const MOCK_SECURITY_POLICIES = generateMockSecurityPolicies(MOCK_ROLES);

const generateMockAnomalies = (users: User[], count: number): SecurityAnomaly[] => {
    const anomalies: SecurityAnomaly[] = [];
    for (let i = 0; i < count; i++) {
        const user = getRandomElement(users);
        const type = getRandomElement(ANOMALY_TYPES);
        const timestamp = new Date(Date.now() - getRandomInt(0, 7) * 24 * 60 * 60 * 1000 - getRandomInt(0, 60) * 60 * 1000).toISOString();
        const severity = getRandomElement(['Low', 'Medium', 'High', 'Critical']);

        anomalies.push({
            id: generateId(),
            type: type,
            timestamp: timestamp,
            description: `Detected ${type.toLowerCase()} involving user ${user.username} from ${getRandomElement(IPS)}.`,
            severity: severity,
            relatedUserId: user.id,
            relatedIpAddress: getRandomElement(IPS),
            status: getRandomElement(['New', 'Investigating', 'Resolved', 'False Positive']),
            triggeredRules: [`Rule-${getRandomInt(100, 999)}`, `Rule-${getRandomInt(100, 999)}`],
            assignedTo: Math.random() > 0.5 ? getRandomElement(users).id : undefined,
        });
    }
    return anomalies;
};

export const MOCK_SECURITY_ANOMALIES = generateMockAnomalies(MOCK_USERS, 80);

const generateMockThreatAlerts = (count: number): ThreatIntelligenceAlert[] => {
    const alerts: ThreatIntelligenceAlert[] = [];
    for (let i = 0; i < count; i++) {
        const timestamp = new Date(Date.now() - getRandomInt(0, 14) * 24 * 60 * 60 * 1000 - getRandomInt(0, 60) * 60 * 1000).toISOString();
        const severity = getRandomElement(['Low', 'Medium', 'High', 'Critical']);
        const title = getRandomElement(['New Ransomware Variant', 'Zero-Day Exploit Detected', 'Phishing Campaign Active', 'DDoS Attack Imminent']);
        alerts.push({
            id: generateId(),
            title: title,
            description: `A new ${severity.toLowerCase()} threat, "${title}", reported by ${getRandomElement(THREAT_SOURCES)}. Immediate action advised.`,
            severity: severity,
            source: getRandomElement(THREAT_SOURCES),
            timestamp: timestamp,
            relatedCVEs: Math.random() > 0.5 ? [`CVE-${getRandomInt(2020, 2023)}-${getRandomInt(1000, 9999)}`] : [],
            recommendedActions: [`Patch systems`, `Educate users`, `Block IPs`],
            status: getRandomElement(['Active', 'Active', 'Archived']),
            detectionVector: getRandomElement(['Email', 'Network Intrusion', 'Software Vulnerability', 'Endpoint Detection']),
        });
    }
    return alerts;
};

export const MOCK_THREAT_ALERTS = generateMockThreatAlerts(30);

// --- HELPER COMPONENTS (for reuse in new sections) ---

/**
 * Renders a customizable badge for status or risk levels.
 */
export const StatusBadge: React.FC<{ status: string; type?: 'status' | 'risk' | 'severity' }> = ({ status, type = 'status' }) => {
    let colors = '';
    switch (type) {
        case 'status':
            switch (status) {
                case 'Active': colors = 'bg-green-500/20 text-green-300'; break;
                case 'Success': colors = 'bg-green-500/20 text-green-300'; break;
                case 'Inactive': colors = 'bg-gray-500/20 text-gray-300'; break;
                case 'Locked': colors = 'bg-red-500/20 text-red-300'; break;
                case 'Failed': colors = 'bg-red-500/20 text-red-300'; break;
                case 'Idle': colors = 'bg-yellow-500/20 text-yellow-300'; break;
                case 'New': colors = 'bg-blue-500/20 text-blue-300'; break;
                case 'Investigating': colors = 'bg-orange-500/20 text-orange-300'; break;
                case 'Resolved': colors = 'bg-green-600/20 text-green-400'; break;
                case 'False Positive': colors = 'bg-gray-600/20 text-gray-400'; break;
                case 'Terminated': colors = 'bg-red-600/20 text-red-400'; break;
                case 'Mitigated': colors = 'bg-green-700/20 text-green-500'; break;
                default: colors = 'bg-gray-500/20 text-gray-300'; break;
            }
            break;
        case 'risk':
        case 'severity':
            switch (status) {
                case 'Low': colors = 'bg-green-500/20 text-green-300'; break;
                case 'Medium': colors = 'bg-yellow-500/20 text-yellow-300'; break;
                case 'High': colors = 'bg-red-500/20 text-red-300'; break;
                case 'Critical': colors = 'bg-purple-500/20 text-purple-300'; break;
                default: colors = 'bg-gray-500/20 text-gray-300'; break;
            }
            break;
    }
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors}`}>{status}</span>;
};

/**
 * A generic pagination component.
 */
export const Pagination: React.FC<{
    currentPage: number;
    totalPages: number;
    onPageChange: (page: number) => void;
}> = ({ currentPage, totalPages, onPageChange }) => {
    const pageNumbers = useMemo(() => {
        const pages: (number | '...')[] = [];
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) {
                pages.push(i);
            }
        } else {
            pages.push(1);
            if (currentPage > 4) pages.push('...');
            for (let i = Math.max(2, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
                pages.push(i);
            }
            if (currentPage < totalPages - 3) pages.push('...');
            pages.push(totalPages);
        }
        return Array.from(new Set(pages)); // Remove duplicates from '...'
    }, [currentPage, totalPages]);

    return (
        <div className="flex items-center justify-center space-x-2 mt-4">
            <button
                onClick={() => onPageChange(currentPage - 1)}
                disabled={currentPage === 1}
                className="px-3 py-1 text-sm rounded-md bg-gray-900/50 hover:bg-cyan-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Previous
            </button>
            {pageNumbers.map((page, index) => (
                <button
                    key={index}
                    onClick={() => typeof page === 'number' && onPageChange(page)}
                    className={`px-3 py-1 text-sm rounded-md ${
                        page === currentPage ? 'bg-cyan-600' : typeof page === 'number' ? 'bg-gray-900/50 hover:bg-cyan-700' : 'bg-transparent'
                    } ${typeof page !== 'number' ? 'cursor-default' : ''}`}
                    disabled={typeof page !== 'number'}
                >
                    {page}
                </button>
            ))}
            <button
                onClick={() => onPageChange(currentPage + 1)}
                disabled={currentPage === totalPages}
                className="px-3 py-1 text-sm rounded-md bg-gray-900/50 hover:bg-cyan-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Next
            </button>
        </div>
    );
};

/**
 * Generic modal component for forms/details.
 */
export const Modal: React.FC<{ isOpen: boolean; onClose: () => void; title: string; children: React.ReactNode }> = ({
    isOpen,
    onClose,
    title,
    children,
}) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h3 className="text-xl font-semibold text-white">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">
                        &times;
                    </button>
                </div>
                <div className="p-4">{children}</div>
            </div>
        </div>
    );
};

// --- DATA CONTEXT & API SIMULATION ---
interface AccessControlContextType {
    users: User[];
    roles: Role[];
    permissions: Permission[];
    policies: SecurityPolicy[];
    activeSessions: ActiveSession[];
    anomalies: SecurityAnomaly[];
    threatAlerts: ThreatIntelligenceAlert[];
    updateUser: (user: User) => Promise<void>;
    createUser: (user: Omit<User, 'id' | 'creationDate' | 'lastActivity' | 'riskScore'>) => Promise<User>;
    deleteUser: (userId: string) => Promise<void>;
    updateRole: (role: Role) => Promise<void>;
    createRole: (role: Omit<Role, 'id' | 'creationDate' | 'lastModified' | 'users'>) => Promise<Role>;
    deleteRole: (roleId: string) => Promise<void>;
    updatePolicy: (policy: SecurityPolicy) => Promise<void>;
    createPolicy: (policy: Omit<SecurityPolicy, 'id' | 'creationDate' | 'lastModified'>) => Promise<SecurityPolicy>;
    deletePolicy: (policyId: string) => Promise<void>;
    terminateSession: (sessionId: string) => Promise<void>;
    updateAnomalyStatus: (anomalyId: string, status: SecurityAnomaly['status'], notes?: string, assignedTo?: string) => Promise<void>;
    archiveThreatAlert: (alertId: string) => Promise<void>;
}

export const AccessControlContext = createContext<AccessControlContextType | undefined>(undefined);

export const AccessControlProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [users, setUsers] = useState<User[]>(MOCK_USERS);
    const [roles, setRoles] = useState<Role[]>(MOCK_ROLES);
    const [permissions] = useState<Permission[]>(MOCK_PERMISSIONS);
    const [policies, setPolicies] = useState<SecurityPolicy[]>(MOCK_SECURITY_POLICIES);
    const [activeSessions, setActiveSessions] = useState<ActiveSession[]>(MOCK_ACTIVE_SESSIONS);
    const [anomalies, setAnomalies] = useState<SecurityAnomaly[]>(MOCK_SECURITY_ANOMALIES);
    const [threatAlerts, setThreatAlerts] = useState<ThreatIntelligenceAlert[]>(MOCK_THREAT_ALERTS);

    const simulateApiCall = useCallback(<T>(data: T, delay = 500): Promise<T> => {
        return new Promise(resolve => setTimeout(() => resolve(data), delay));
    }, []);

    const updateUser = useCallback(async (updatedUser: User) => {
        const result = await simulateApiCall(updatedUser);
        setUsers(prev => prev.map(u => (u.id === result.id ? result : u)));
        console.log('User updated:', result.username);
    }, [simulateApiCall]);

    const createUser = useCallback(async (newUser: Omit<User, 'id' | 'creationDate' | 'lastActivity' | 'riskScore'>) => {
        const userWithDefaults: User = {
            ...newUser,
            id: generateId(),
            creationDate: new Date().toISOString(),
            lastActivity: new Date().toISOString(),
            riskScore: getRandomInt(20, 70),
        };
        const result = await simulateApiCall(userWithDefaults);
        setUsers(prev => [...prev, result]);
        console.log('User created:', result.username);
        return result;
    }, [simulateApiCall]);

    const deleteUser = useCallback(async (userId: string) => {
        await simulateApiCall(userId); // Simulate deletion
        setUsers(prev => prev.filter(u => u.id !== userId));
        // Also remove user from any roles
        setRoles(prev => prev.map(r => ({ ...r, users: r.users.filter(id => id !== userId) })));
        console.log('User deleted:', userId);
    }, [simulateApiCall]);

    const updateRole = useCallback(async (updatedRole: Role) => {
        const result = await simulateApiCall(updatedRole);
        setRoles(prev => prev.map(r => (r.id === result.id ? result : r)));
        console.log('Role updated:', result.name);
    }, [simulateApiCall]);

    const createRole = useCallback(async (newRole: Omit<Role, 'id' | 'creationDate' | 'lastModified' | 'users'>) => {
        const roleWithDefaults: Role = {
            ...newRole,
            id: generateId(),
            creationDate: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            users: [],
        };
        const result = await simulateApiCall(roleWithDefaults);
        setRoles(prev => [...prev, result]);
        console.log('Role created:', result.name);
        return result;
    }, [simulateApiCall]);

    const deleteRole = useCallback(async (roleId: string) => {
        await simulateApiCall(roleId);
        setRoles(prev => prev.filter(r => r.id !== roleId));
        // Remove role from any users
        setUsers(prev => prev.map(u => ({ ...u, roles: u.roles.filter(id => id !== roleId) })));
        console.log('Role deleted:', roleId);
    }, [simulateApiCall]);

    const updatePolicy = useCallback(async (updatedPolicy: SecurityPolicy) => {
        const result = await simulateApiCall(updatedPolicy);
        setPolicies(prev => prev.map(p => (p.id === result.id ? result : result)));
        console.log('Policy updated:', result.name);
    }, [simulateApiCall]);

    const createPolicy = useCallback(async (newPolicy: Omit<SecurityPolicy, 'id' | 'creationDate' | 'lastModified'>) => {
        const policyWithDefaults: SecurityPolicy = {
            ...newPolicy,
            id: generateId(),
            creationDate: new Date().toISOString(),
            lastModified: new Date().toISOString(),
        };
        const result = await simulateApiCall(policyWithDefaults);
        setPolicies(prev => [...prev, result]);
        console.log('Policy created:', result.name);
        return result;
    }, [simulateApiCall]);

    const deletePolicy = useCallback(async (policyId: string) => {
        await simulateApiCall(policyId);
        setPolicies(prev => prev.filter(p => p.id !== policyId));
        console.log('Policy deleted:', policyId);
    }, [simulateApiCall]);

    const terminateSession = useCallback(async (sessionId: string) => {
        await simulateApiCall(sessionId);
        setActiveSessions(prev => prev.map(s => (s.id === sessionId ? { ...s, status: 'Terminated', lastActivity: new Date().toISOString() } : s)));
        console.log('Session terminated:', sessionId);
    }, [simulateApiCall]);

    const updateAnomalyStatus = useCallback(async (anomalyId: string, status: SecurityAnomaly['status'], notes?: string, assignedTo?: string) => {
        const updatedAnomaly = { status, resolutionNotes: notes, assignedTo };
        const result = await simulateApiCall(updatedAnomaly);
        setAnomalies(prev => prev.map(a => (a.id === anomalyId ? { ...a, ...result } : a)));
        console.log('Anomaly status updated:', anomalyId, status);
    }, [simulateApiCall]);

    const archiveThreatAlert = useCallback(async (alertId: string) => {
        await simulateApiCall(alertId);
        setThreatAlerts(prev => prev.map(a => (a.id === alertId ? { ...a, status: 'Archived' } : a)));
        console.log('Threat alert archived:', alertId);
    }, [simulateApiCall]);

    const value = useMemo(() => ({
        users, roles, permissions, policies, activeSessions, anomalies, threatAlerts,
        updateUser, createUser, deleteUser,
        updateRole, createRole, deleteRole,
        updatePolicy, createPolicy, deletePolicy,
        terminateSession, updateAnomalyStatus, archiveThreatAlert,
    }), [
        users, roles, permissions, policies, activeSessions, anomalies, threatAlerts,
        updateUser, createUser, deleteUser,
        updateRole, createRole, deleteRole,
        updatePolicy, createPolicy, deletePolicy,
        terminateSession, updateAnomalyStatus, archiveThreatAlert,
    ]);

    return <AccessControlContext.Provider value={value}>{children}</AccessControlContext.Provider>;
};

export const useAccessControl = () => {
    const context = useContext(AccessControlContext);
    if (!context) {
        throw new Error('useAccessControl must be used within an AccessControlProvider');
    }
    return context;
};

// --- NEW COMPONENT SECTIONS ---

/**
 * User Management Section Component.
 */
export const UserManagement: React.FC = () => {
    const { users, roles, updateUser, createUser, deleteUser } = useAccessControl();
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState<'all' | User['status']>('all');
    const [sortBy, setSortBy] = useState<keyof User | null>('username');
    const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');
    const [isUserModalOpen, setIsUserModalOpen] = useState(false);
    const [editingUser, setEditingUser] = useState<User | null>(null);

    const [currentPage, setCurrentPage] = useState(1);
    const itemsPerPage = 10;

    const filteredAndSortedUsers = useMemo(() => {
        let filtered = users.filter(user =>
            user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.department.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (filterStatus !== 'all') {
            filtered = filtered.filter(user => user.status === filterStatus);
        }

        if (sortBy) {
            filtered.sort((a, b) => {
                const aValue = a[sortBy];
                const bValue = b[sortBy];

                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return sortOrder === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                }
                if (typeof aValue === 'number' && typeof bValue === 'number') {
                    return sortOrder === 'asc' ? aValue - bValue : bValue - aValue;
                }
                // Fallback for other types or null
                return 0;
            });
        }
        return filtered;
    }, [users, searchTerm, filterStatus, sortBy, sortOrder]);

    const totalPages = Math.ceil(filteredAndSortedUsers.length / itemsPerPage);
    const paginatedUsers = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        return filteredAndSortedUsers.slice(startIndex, startIndex + itemsPerPage);
    }, [filteredAndSortedUsers, currentPage, itemsPerPage]);

    const handleSort = (key: keyof User) => {
        if (sortBy === key) {
            setSortOrder(prev => (prev === 'asc' ? 'desc' : 'asc'));
        } else {
            setSortBy(key);
            setSortOrder('asc');
        }
    };

    const handleEditUser = (user: User) => {
        setEditingUser(user);
        setIsUserModalOpen(true);
    };

    const handleCreateUser = () => {
        setEditingUser(null);
        setIsUserModalOpen(true);
    };

    const handleSaveUser = async (formData: Omit<User, 'id' | 'creationDate' | 'lastActivity' | 'riskScore'> | User) => {
        if ('id' in formData) { // Existing user
            await updateUser(formData as User);
        } else { // New user
            await createUser(formData);
        }
        setIsUserModalOpen(false);
        setEditingUser(null);
    };

    return (
        <Card title="User Management">
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                <input
                    type="text"
                    placeholder="Search users..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                />
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value as 'all' | User['status'])}
                    className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                >
                    <option value="all">All Statuses</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Locked">Locked</option>
                </select>
                <button
                    onClick={handleCreateUser}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm"
                >
                    Add New User
                </button>
            </div>

            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-400">
                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('username')}>
                                Username {sortBy === 'username' && (sortOrder === 'asc' ? '▲' : '▼')}
                            </th>
                            <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('email')}>
                                Email {sortBy === 'email' && (sortOrder === 'asc' ? '▲' : '▼')}
                            </th>
                            <th scope="col" className="px-6 py-3">Roles</th>
                            <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('status')}>
                                Status {sortBy === 'status' && (sortOrder === 'asc' ? '▲' : '▼')}
                            </th>
                            <th scope="col" className="px-6 py-3">Last Login</th>
                            <th scope="col" className="px-6 py-3">MFA</th>
                            <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedUsers.length === 0 ? (
                            <tr>
                                <td colSpan={7} className="px-6 py-4 text-center">No users found.</td>
                            </tr>
                        ) : (
                            paginatedUsers.map(user => (
                                <tr key={user.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white">{user.username}</td>
                                    <td className="px-6 py-4">{user.email}</td>
                                    <td className="px-6 py-4">
                                        {user.roles.map(roleId => roles.find(r => r.id === roleId)?.name).join(', ') || 'N/A'}
                                    </td>
                                    <td className="px-6 py-4"><StatusBadge status={user.status} type="status" /></td>
                                    <td className="px-6 py-4">{new Date(user.lastLogin).toLocaleString()}</td>
                                    <td className="px-6 py-4">{user.mfaEnabled ? 'Enabled' : 'Disabled'}</td>
                                    <td className="px-6 py-4 space-x-2">
                                        <button onClick={() => handleEditUser(user)} className="text-blue-400 hover:text-blue-300">Edit</button>
                                        <button onClick={() => deleteUser(user.id)} className="text-red-400 hover:text-red-300">Delete</button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
            <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />

            <UserFormModal
                isOpen={isUserModalOpen}
                onClose={() => setIsUserModalOpen(false)}
                user={editingUser}
                onSave={handleSaveUser}
                allRoles={roles}
                allPermissions={permissions}
            />
        </Card>
    );
};

/**
 * User Form Modal for creating/editing users.
 */
export const UserFormModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    user: User | null;
    onSave: (user: Omit<User, 'id' | 'creationDate' | 'lastActivity' | 'riskScore'> | User) => Promise<void>;
    allRoles: Role[];
    allPermissions: Permission[];
}> = ({ isOpen, onClose, user, onSave, allRoles, allPermissions }) => {
    const [formData, setFormData] = useState<Partial<User>>({});
    const [selectedRoles, setSelectedRoles] = useState<string[]>([]);
    const [selectedPermissions, setSelectedPermissions] = useState<string[]>([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (user) {
            setFormData(user);
            setSelectedRoles(user.roles);
            setSelectedPermissions(user.permissions || []);
        } else {
            setFormData({});
            setSelectedRoles([]);
            setSelectedPermissions([]);
        }
        setError('');
    }, [user, isOpen]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value, type, checked } = e.target as HTMLInputElement;
        setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    };

    const handleRoleChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const options = Array.from(e.target.selectedOptions).map(opt => opt.value);
        setSelectedRoles(options);
    };

    const handlePermissionChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const options = Array.from(e.target.selectedOptions).map(opt => opt.value);
        setSelectedPermissions(options);
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        const payload: Omit<User, 'id' | 'creationDate' | 'lastActivity' | 'riskScore'> | User = {
            ...formData,
            roles: selectedRoles,
            permissions: selectedPermissions,
        } as User;

        if (!payload.username || !payload.email || !payload.department) {
            setError('Username, Email, and Department are required.');
            setLoading(false);
            return;
        }
        if (user) { // Existing user
            payload.id = user.id;
            payload.creationDate = user.creationDate;
            payload.lastActivity = user.lastActivity;
            payload.riskScore = user.riskScore;
            // Ensure MFA is boolean
            payload.mfaEnabled = formData.mfaEnabled ?? user.mfaEnabled;
        } else { // New user, ensure essential properties
            payload.status = payload.status || 'Active';
            payload.lastLogin = payload.lastLogin || new Date().toISOString();
            payload.mfaEnabled = formData.mfaEnabled ?? false;
            payload.ipWhitelist = payload.ipWhitelist || [];
            payload.location = payload.location || getRandomElement(LOCATIONS);
        }

        try {
            await onSave(payload);
            onClose();
        } catch (err) {
            setError('Failed to save user.');
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={user ? 'Edit User' : 'Add New User'}>
            <form onSubmit={handleSubmit} className="space-y-4 text-gray-300">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <div>
                    <label htmlFor="username" className="block text-sm font-medium">Username:</label>
                    <input
                        type="text"
                        id="username"
                        name="username"
                        value={formData.username || ''}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="email" className="block text-sm font-medium">Email:</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        value={formData.email || ''}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="department" className="block text-sm font-medium">Department:</label>
                    <input
                        type="text"
                        id="department"
                        name="department"
                        value={formData.department || ''}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="title" className="block text-sm font-medium">Title:</label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        value={formData.title || ''}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    />
                </div>
                <div>
                    <label htmlFor="status" className="block text-sm font-medium">Status:</label>
                    <select
                        id="status"
                        name="status"
                        value={formData.status || 'Active'}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Locked">Locked</option>
                    </select>
                </div>
                <div>
                    <label htmlFor="roles" className="block text-sm font-medium">Roles:</label>
                    <select
                        multiple
                        id="roles"
                        name="roles"
                        value={selectedRoles}
                        onChange={handleRoleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 h-24 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        {allRoles.map(role => (
                            <option key={role.id} value={role.id}>{role.name}</option>
                        ))}
                    </select>
                    <p className="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple roles.</p>
                </div>
                <div>
                    <label htmlFor="permissions" className="block text-sm font-medium">Direct Permissions:</label>
                    <select
                        multiple
                        id="permissions"
                        name="permissions"
                        value={selectedPermissions}
                        onChange={handlePermissionChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 h-24 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        {allPermissions.map(perm => (
                            <option key={perm.id} value={perm.id}>{perm.name} ({perm.category})</option>
                        ))}
                    </select>
                    <p className="text-xs text-gray-500 mt-1">These permissions are assigned directly, bypassing roles. Hold Ctrl/Cmd to select multiple.</p>
                </div>
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        id="mfaEnabled"
                        name="mfaEnabled"
                        checked={formData.mfaEnabled || false}
                        onChange={handleChange}
                        className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500"
                    />
                    <label htmlFor="mfaEnabled" className="text-sm font-medium">MFA Enabled</label>
                </div>
                <div className="flex justify-end space-x-2 mt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white text-sm"
                        disabled={loading}
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm disabled:opacity-50"
                        disabled={loading}
                    >
                        {loading ? 'Saving...' : 'Save User'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

/**
 * Role Management Section Component.
 */
export const RoleManagement: React.FC = () => {
    const { roles, permissions, users, updateRole, createRole, deleteRole } = useAccessControl();
    const [searchTerm, setSearchTerm] = useState('');
    const [isRoleModalOpen, setIsRoleModalOpen] = useState(false);
    const [editingRole, setEditingRole] = useState<Role | null>(null);

    const filteredRoles = useMemo(() => {
        return roles.filter(role =>
            role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            role.description.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }, [roles, searchTerm]);

    const handleEditRole = (role: Role) => {
        setEditingRole(role);
        setIsRoleModalOpen(true);
    };

    const handleCreateRole = () => {
        setEditingRole(null);
        setIsRoleModalOpen(true);
    };

    const handleSaveRole = async (formData: Omit<Role, 'id' | 'creationDate' | 'lastModified' | 'users'> | Role) => {
        if ('id' in formData) { // Existing role
            await updateRole(formData as Role);
        } else { // New role
            await createRole(formData);
        }
        setIsRoleModalOpen(false);
        setEditingRole(null);
    };

    return (
        <Card title="Role Management">
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                <input
                    type="text"
                    placeholder="Search roles..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                />
                <button
                    onClick={handleCreateRole}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm"
                >
                    Add New Role
                </button>
            </div>

            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-400">
                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" className="px-6 py-3">Role Name</th>
                            <th scope="col" className="px-6 py-3">Description</th>
                            <th scope="col" className="px-6 py-3">Permissions Count</th>
                            <th scope="col" className="px-6 py-3">Users Count</th>
                            <th scope="col" className="px-6 py-3">Status</th>
                            <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredRoles.length === 0 ? (
                            <tr>
                                <td colSpan={6} className="px-6 py-4 text-center">No roles found.</td>
                            </tr>
                        ) : (
                            filteredRoles.map(role => (
                                <tr key={role.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white">{role.name}</td>
                                    <td className="px-6 py-4">{role.description}</td>
                                    <td className="px-6 py-4">{role.permissions.length}</td>
                                    <td className="px-6 py-4">{role.users.length}</td>
                                    <td className="px-6 py-4"><StatusBadge status={role.isActive ? 'Active' : 'Inactive'} type="status" /></td>
                                    <td className="px-6 py-4 space-x-2">
                                        <button onClick={() => handleEditRole(role)} className="text-blue-400 hover:text-blue-300">Edit</button>
                                        <button onClick={() => deleteRole(role.id)} className="text-red-400 hover:text-red-300">Delete</button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            <RoleFormModal
                isOpen={isRoleModalOpen}
                onClose={() => setIsRoleModalOpen(false)}
                role={editingRole}
                onSave={handleSaveRole}
                allPermissions={permissions}
            />
        </Card>
    );
};

/**
 * Role Form Modal for creating/editing roles.
 */
export const RoleFormModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    role: Role | null;
    onSave: (role: Omit<Role, 'id' | 'creationDate' | 'lastModified' | 'users'> | Role) => Promise<void>;
    allPermissions: Permission[];
}> = ({ isOpen, onClose, role, onSave, allPermissions }) => {
    const [formData, setFormData] = useState<Partial<Role>>({});
    const [selectedPermissions, setSelectedPermissions] = useState<string[]>([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (role) {
            setFormData(role);
            setSelectedPermissions(role.permissions);
        } else {
            setFormData({});
            setSelectedPermissions([]);
        }
        setError('');
    }, [role, isOpen]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type, checked } = e.target as HTMLInputElement;
        setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    };

    const handlePermissionChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const options = Array.from(e.target.selectedOptions).map(opt => opt.value);
        setSelectedPermissions(options);
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        const payload: Omit<Role, 'id' | 'creationDate' | 'lastModified' | 'users'> | Role = {
            ...formData,
            permissions: selectedPermissions,
        } as Role;

        if (!payload.name || !payload.description) {
            setError('Role Name and Description are required.');
            setLoading(false);
            return;
        }

        if (role) { // Existing role
            payload.id = role.id;
            payload.creationDate = role.creationDate;
            payload.lastModified = role.lastModified;
            payload.users = role.users;
            payload.isActive = formData.isActive ?? role.isActive;
        } else { // New role
            payload.users = [];
            payload.isActive = formData.isActive ?? true;
            payload.level = payload.level || 'Custom';
        }

        try {
            await onSave(payload);
            onClose();
        } catch (err) {
            setError('Failed to save role.');
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={role ? 'Edit Role' : 'Add New Role'}>
            <form onSubmit={handleSubmit} className="space-y-4 text-gray-300">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <div>
                    <label htmlFor="name" className="block text-sm font-medium">Role Name:</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        value={formData.name || ''}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="description" className="block text-sm font-medium">Description:</label>
                    <textarea
                        id="description"
                        name="description"
                        value={formData.description || ''}
                        onChange={handleChange}
                        rows={3}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="level" className="block text-sm font-medium">Role Level:</label>
                    <select
                        id="level"
                        name="level"
                        value={formData.level || 'Custom'}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        <option value="System">System</option>
                        <option value="Admin">Admin</option>
                        <option value="User">User</option>
                        <option value="Guest">Guest</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div>
                    <label htmlFor="permissions" className="block text-sm font-medium">Permissions:</label>
                    <select
                        multiple
                        id="permissions"
                        name="permissions"
                        value={selectedPermissions}
                        onChange={handlePermissionChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 h-48 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        {allPermissions.map(perm => (
                            <option key={perm.id} value={perm.id}>{perm.name} ({perm.category})</option>
                        ))}
                    </select>
                    <p className="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple permissions.</p>
                </div>
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        id="isActive"
                        name="isActive"
                        checked={formData.isActive ?? true}
                        onChange={handleChange}
                        className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500"
                    />
                    <label htmlFor="isActive" className="text-sm font-medium">Is Active</label>
                </div>
                <div className="flex justify-end space-x-2 mt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white text-sm"
                        disabled={loading}
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm disabled:opacity-50"
                        disabled={loading}
                    >
                        {loading ? 'Saving...' : 'Save Role'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

/**
 * Security Policy Management Component.
 */
export const PolicyManagement: React.FC = () => {
    const { policies, updatePolicy, createPolicy, deletePolicy, roles, users } = useAccessControl();
    const [searchTerm, setSearchTerm] = useState('');
    const [isPolicyModalOpen, setIsPolicyModalOpen] = useState(false);
    const [editingPolicy, setEditingPolicy] = useState<SecurityPolicy | null>(null);

    const filteredPolicies = useMemo(() => {
        return policies.filter(policy =>
            policy.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            policy.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
            policy.type.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }, [policies, searchTerm]);

    const handleEditPolicy = (policy: SecurityPolicy) => {
        setEditingPolicy(policy);
        setIsPolicyModalOpen(true);
    };

    const handleCreatePolicy = () => {
        setEditingPolicy(null);
        setIsPolicyModalOpen(true);
    };

    const handleSavePolicy = async (formData: Omit<SecurityPolicy, 'id' | 'creationDate' | 'lastModified'> | SecurityPolicy) => {
        if ('id' in formData) { // Existing policy
            await updatePolicy(formData as SecurityPolicy);
        } else { // New policy
            await createPolicy(formData);
        }
        setIsPolicyModalOpen(false);
        setEditingPolicy(null);
    };

    const getTargetName = useCallback((scope: SecurityPolicy['enforcementScope'], targetId?: string) => {
        if (!targetId) return 'N/A';
        switch (scope) {
            case 'Role': return roles.find(r => r.id === targetId)?.name || targetId;
            case 'User': return users.find(u => u.id === targetId)?.username || targetId;
            case 'Department': return targetId; // Assuming department name is the ID
            default: return 'N/A';
        }
    }, [roles, users]);

    return (
        <Card title="Security Policy Management">
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                <input
                    type="text"
                    placeholder="Search policies..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                />
                <button
                    onClick={handleCreatePolicy}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm"
                >
                    Add New Policy
                </button>
            </div>

            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-400">
                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" className="px-6 py-3">Policy Name</th>
                            <th scope="col" className="px-6 py-3">Type</th>
                            <th scope="col" className="px-6 py-3">Scope</th>
                            <th scope="col" className="px-6 py-3">Targets</th>
                            <th scope="col" className="px-6 py-3">Status</th>
                            <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredPolicies.length === 0 ? (
                            <tr>
                                <td colSpan={6} className="px-6 py-4 text-center">No policies found.</td>
                            </tr>
                        ) : (
                            filteredPolicies.map(policy => (
                                <tr key={policy.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white">{policy.name}</td>
                                    <td className="px-6 py-4">{policy.type}</td>
                                    <td className="px-6 py-4">{policy.enforcementScope}</td>
                                    <td className="px-6 py-4">
                                        {policy.enforcementScope !== 'Global' && policy.targetIds && policy.targetIds.length > 0
                                            ? policy.targetIds.map(id => getTargetName(policy.enforcementScope, id)).join(', ')
                                            : 'Global'}
                                    </td>
                                    <td className="px-6 py-4"><StatusBadge status={policy.isEnabled ? 'Enabled' : 'Disabled'} type="status" /></td>
                                    <td className="px-6 py-4 space-x-2">
                                        <button onClick={() => handleEditPolicy(policy)} className="text-blue-400 hover:text-blue-300">Edit</button>
                                        <button onClick={() => deletePolicy(policy.id)} className="text-red-400 hover:text-red-300">Delete</button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            <PolicyFormModal
                isOpen={isPolicyModalOpen}
                onClose={() => setIsPolicyModalOpen(false)}
                policy={editingPolicy}
                onSave={handleSavePolicy}
                allRoles={roles}
                allUsers={users}
                allDepartments={DEPARTMENTS} // Using mock departments
            />
        </Card>
    );
};

/**
 * Policy Form Modal for creating/editing policies.
 */
export const PolicyFormModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    policy: SecurityPolicy | null;
    onSave: (policy: Omit<SecurityPolicy, 'id' | 'creationDate' | 'lastModified'> | SecurityPolicy) => Promise<void>;
    allRoles: Role[];
    allUsers: User[];
    allDepartments: string[];
}> = ({ isOpen, onClose, policy, onSave, allRoles, allUsers, allDepartments }) => {
    const [formData, setFormData] = useState<Partial<SecurityPolicy>>({});
    const [selectedTargets, setSelectedTargets] = useState<string[]>([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        if (policy) {
            setFormData(policy);
            setSelectedTargets(policy.targetIds || []);
        } else {
            setFormData({
                type: 'Password',
                enforcementScope: 'Global',
                isEnabled: true,
                parameters: {},
            });
            setSelectedTargets([]);
        }
        setError('');
    }, [policy, isOpen]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        const { name, value, type, checked } = e.target as HTMLInputElement;
        setFormData(prev => {
            const newFormData = { ...prev, [name]: type === 'checkbox' ? checked : value };
            // Reset targets if scope changes to Global
            if (name === 'enforcementScope' && value === 'Global') {
                setSelectedTargets([]);
                newFormData.targetIds = [];
            }
            // Clear parameters if type changes
            if (name === 'type' && value !== prev.type) {
                newFormData.parameters = {};
            }
            return newFormData;
        });
    };

    const handleParameterChange = (key: string, value: string | boolean | number) => {
        setFormData(prev => ({
            ...prev,
            parameters: {
                ...prev.parameters,
                [key]: value,
            },
        }));
    };

    const handleTargetChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const options = Array.from(e.target.selectedOptions).map(opt => opt.value);
        setSelectedTargets(options);
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        const payload: Omit<SecurityPolicy, 'id' | 'creationDate' | 'lastModified'> | SecurityPolicy = {
            ...formData,
            targetIds: formData.enforcementScope === 'Global' ? undefined : selectedTargets,
        } as SecurityPolicy;

        if (!payload.name || !payload.type || !payload.enforcementScope) {
            setError('Policy Name, Type, and Enforcement Scope are required.');
            setLoading(false);
            return;
        }

        if (payload.enforcementScope !== 'Global' && (!payload.targetIds || payload.targetIds.length === 0)) {
            setError('Please select at least one target for non-global policies.');
            setLoading(false);
            return;
        }

        if (policy) { // Existing policy
            payload.id = policy.id;
            payload.creationDate = policy.creationDate;
            payload.lastModified = policy.lastModified;
            payload.isEnabled = formData.isEnabled ?? policy.isEnabled;
        } else { // New policy
            payload.isEnabled = formData.isEnabled ?? true;
        }

        try {
            await onSave(payload);
            onClose();
        } catch (err) {
            setError('Failed to save policy.');
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    const renderParameterFields = () => {
        const currentParams = formData.parameters || {};
        switch (formData.type) {
            case 'Password':
                return (
                    <>
                        <label className="block text-sm font-medium mt-2">Password Policy Parameters:</label>
                        <input type="number" placeholder="Min Length" value={currentParams.minLength || ''} onChange={(e) => handleParameterChange('minLength', parseInt(e.target.value) || 0)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                        <label className="flex items-center mt-1"><input type="checkbox" checked={currentParams.requireUpper || false} onChange={(e) => handleParameterChange('requireUpper', e.target.checked)} className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded" /> Require Uppercase</label>
                        <label className="flex items-center mt-1"><input type="checkbox" checked={currentParams.requireLower || false} onChange={(e) => handleParameterChange('requireLower', e.target.checked)} className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded" /> Require Lowercase</label>
                        <label className="flex items-center mt-1"><input type="checkbox" checked={currentParams.requireNumber || false} onChange={(e) => handleParameterChange('requireNumber', e.target.checked)} className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded" /> Require Number</label>
                        <label className="flex items-center mt-1"><input type="checkbox" checked={currentParams.requireSymbol || false} onChange={(e) => handleParameterChange('requireSymbol', e.target.checked)} className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded" /> Require Symbol</label>
                        <input type="number" placeholder="Expiry Days (0 for never)" value={currentParams.expiryDays || ''} onChange={(e) => handleParameterChange('expiryDays', parseInt(e.target.value) || 0)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                        <input type="number" placeholder="History Count" value={currentParams.historyCount || ''} onChange={(e) => handleParameterChange('historyCount', parseInt(e.target.value) || 0)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                    </>
                );
            case 'MFA':
                return (
                    <>
                        <label className="block text-sm font-medium mt-2">MFA Policy Parameters:</label>
                        <label className="flex items-center mt-1"><input type="checkbox" checked={currentParams.required || false} onChange={(e) => handleParameterChange('required', e.target.checked)} className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded" /> MFA Required</label>
                        <input type="text" placeholder="Allowed Methods (comma separated: TOTP,SMS,Email)" value={currentParams.methods?.join(',') || ''} onChange={(e) => handleParameterChange('methods', e.target.value.split(',').map(s => s.trim()))} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                        <input type="number" placeholder="Grace Period Days" value={currentParams.gracePeriodDays || ''} onChange={(e) => handleParameterChange('gracePeriodDays', parseInt(e.target.value) || 0)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                    </>
                );
            case 'Session':
                return (
                    <>
                        <label className="block text-sm font-medium mt-2">Session Policy Parameters:</label>
                        <input type="number" placeholder="Inactivity Timeout (minutes)" value={currentParams.inactivityTimeoutMinutes || ''} onChange={(e) => handleParameterChange('inactivityTimeoutMinutes', parseInt(e.target.value) || 0)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                        <input type="number" placeholder="Max Session Duration (hours)" value={currentParams.maxSessionDurationHours || ''} onChange={(e) => handleParameterChange('maxSessionDurationHours', parseInt(e.target.value) || 0)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                    </>
                );
            case 'IP Restriction':
                return (
                    <>
                        <label className="block text-sm font-medium mt-2">IP Restriction Parameters:</label>
                        <textarea placeholder="Allowed IPs (one per line, CIDR notation supported)" value={currentParams.allowedIPs?.join('\n') || ''} onChange={(e) => handleParameterChange('allowedIPs', e.target.value.split('\n').map(s => s.trim()).filter(Boolean))} rows={3} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                        <select value={currentParams.action || 'Deny_Others'} onChange={(e) => handleParameterChange('action', e.target.value)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1">
                            <option value="Deny_Others">Deny Others</option>
                            <option value="Allow_Others">Allow Others (Blacklist)</option>
                        </select>
                    </>
                );
            case 'Data Access':
                return (
                    <>
                        <label className="block text-sm font-medium mt-2">Data Access Parameters:</label>
                        <select value={currentParams.accessLevel || 'Restricted'} onChange={(e) => handleParameterChange('accessLevel', e.target.value)} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1">
                            <option value="Full">Full</option>
                            <option value="Restricted">Restricted</option>
                            <option value="Read_Only">Read-Only</option>
                            <option value="No_Access">No Access</option>
                        </select>
                        <input type="text" placeholder="Sensitive Data Tags (comma separated)" value={currentParams.sensitiveDataTags?.join(',') || ''} onChange={(e) => handleParameterChange('sensitiveDataTags', e.target.value.split(',').map(s => s.trim()))} className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500 mt-1" />
                        <label className="flex items-center mt-1"><input type="checkbox" checked={currentParams.readOnly || false} onChange={(e) => handleParameterChange('readOnly', e.target.checked)} className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded" /> Read Only Access</label>
                    </>
                );
            default:
                return (
                    <div className="text-gray-500 text-sm italic mt-2">No specific parameters for this policy type or Custom policy.</div>
                );
        }
    };

    const targetOptions = useMemo(() => {
        switch (formData.enforcementScope) {
            case 'Role': return allRoles.map(r => ({ value: r.id, label: r.name }));
            case 'User': return allUsers.map(u => ({ value: u.id, label: u.username }));
            case 'Department': return allDepartments.map(d => ({ value: d, label: d }));
            default: return [];
        }
    }, [formData.enforcementScope, allRoles, allUsers, allDepartments]);

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={policy ? 'Edit Security Policy' : 'Add New Security Policy'}>
            <form onSubmit={handleSubmit} className="space-y-4 text-gray-300">
                {error && <p className="text-red-500 text-sm">{error}</p>}
                <div>
                    <label htmlFor="name" className="block text-sm font-medium">Policy Name:</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        value={formData.name || ''}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="description" className="block text-sm font-medium">Description:</label>
                    <textarea
                        id="description"
                        name="description"
                        value={formData.description || ''}
                        onChange={handleChange}
                        rows={3}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="type" className="block text-sm font-medium">Policy Type:</label>
                    <select
                        id="type"
                        name="type"
                        value={formData.type || 'Password'}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        <option value="Password">Password</option>
                        <option value="MFA">MFA</option>
                        <option value="Session">Session</option>
                        <option value="IP Restriction">IP Restriction</option>
                        <option value="Data Access">Data Access</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>

                {renderParameterFields()}

                <div>
                    <label htmlFor="enforcementScope" className="block text-sm font-medium">Enforcement Scope:</label>
                    <select
                        id="enforcementScope"
                        name="enforcementScope"
                        value={formData.enforcementScope || 'Global'}
                        onChange={handleChange}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        <option value="Global">Global</option>
                        <option value="Department">Department</option>
                        <option value="Role">Role</option>
                        <option value="User">User</option>
                    </select>
                </div>
                {formData.enforcementScope !== 'Global' && (
                    <div>
                        <label htmlFor="targetIds" className="block text-sm font-medium">Policy Targets ({formData.enforcementScope}):</label>
                        <select
                            multiple
                            id="targetIds"
                            name="targetIds"
                            value={selectedTargets}
                            onChange={handleTargetChange}
                            className="w-full p-2 rounded bg-gray-700 border border-gray-600 h-24 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        >
                            {targetOptions.map(option => (
                                <option key={option.value} value={option.value}>{option.label}</option>
                            ))}
                        </select>
                        <p className="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple targets.</p>
                    </div>
                )}
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        id="isEnabled"
                        name="isEnabled"
                        checked={formData.isEnabled ?? true}
                        onChange={handleChange}
                        className="mr-2 text-cyan-600 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500"
                    />
                    <label htmlFor="isEnabled" className="text-sm font-medium">Is Enabled</label>
                </div>
                <div className="flex justify-end space-x-2 mt-4">
                    <button
                        type="button"
                        onClick={onClose}
                        className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white text-sm"
                        disabled={loading}
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm disabled:opacity-50"
                        disabled={loading}
                    >
                        {loading ? 'Saving...' : 'Save Policy'}
                    </button>
                </div>
            </form>
        </Modal>
    );
};

/**
 * Active Sessions Section Component.
 */
export const ActiveSessionsView: React.FC = () => {
    const { activeSessions, terminateSession, users } = useAccessControl();
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState<'all' | ActiveSession['status']>('all');
    const [currentPage, setCurrentPage] = useState(1);
    const itemsPerPage = 10;

    const filteredSessions = useMemo(() => {
        let filtered = activeSessions.filter(session =>
            session.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
            session.ipAddress.toLowerCase().includes(searchTerm.toLowerCase()) ||
            session.location.toLowerCase().includes(searchTerm.toLowerCase()) ||
            session.device.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (filterStatus !== 'all') {
            filtered = filtered.filter(session => session.status === filterStatus);
        }
        return filtered;
    }, [activeSessions, searchTerm, filterStatus]);

    const totalPages = Math.ceil(filteredSessions.length / itemsPerPage);
    const paginatedSessions = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        return filteredSessions.slice(startIndex, startIndex + itemsPerPage);
    }, [filteredSessions, currentPage, itemsPerPage]);

    return (
        <Card title="Active User Sessions">
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                <input
                    type="text"
                    placeholder="Search sessions..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                />
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value as 'all' | ActiveSession['status'])}
                    className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                >
                    <option value="all">All Statuses</option>
                    <option value="Active">Active</option>
                    <option value="Idle">Idle</option>
                    <option value="Terminated">Terminated</option>
                </select>
            </div>

            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-400">
                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" className="px-6 py-3">User</th>
                            <th scope="col" className="px-6 py-3">IP Address</th>
                            <th scope="col" className="px-6 py-3">Location</th>
                            <th scope="col" className="px-6 py-3">Device</th>
                            <th scope="col" className="px-6 py-3">Login Time</th>
                            <th scope="col" className="px-6 py-3">Last Activity</th>
                            <th scope="col" className="px-6 py-3">Status</th>
                            <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedSessions.length === 0 ? (
                            <tr>
                                <td colSpan={8} className="px-6 py-4 text-center">No active sessions found.</td>
                            </tr>
                        ) : (
                            paginatedSessions.map(session => (
                                <tr key={session.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4 font-medium text-white">{session.username}</td>
                                    <td className="px-6 py-4 font-mono">{session.ipAddress}</td>
                                    <td className="px-6 py-4">{session.location}</td>
                                    <td className="px-6 py-4">{session.device}</td>
                                    <td className="px-6 py-4">{new Date(session.loginTime).toLocaleString()}</td>
                                    <td className="px-6 py-4">{new Date(session.lastActivity).toLocaleString()}</td>
                                    <td className="px-6 py-4"><StatusBadge status={session.status} type="status" /></td>
                                    <td className="px-6 py-4">
                                        {session.status !== 'Terminated' ? (
                                            <button
                                                onClick={() => terminateSession(session.id)}
                                                className="text-red-400 hover:text-red-300"
                                            >
                                                Terminate
                                            </button>
                                        ) : (
                                            <span className="text-gray-500">N/A</span>
                                        )}
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
            <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
        </Card>
    );
};

/**
 * Anomaly Detection Section Component.
 */
export const AnomalyDetectionView: React.FC = () => {
    const { anomalies, updateAnomalyStatus, users } = useAccessControl();
    const [searchTerm, setSearchTerm] = useState('');
    const [filterSeverity, setFilterSeverity] = useState<'all' | SecurityAnomaly['severity']>('all');
    const [filterStatus, setFilterStatus] = useState<'all' | SecurityAnomaly['status']>('all');
    const [currentPage, setCurrentPage] = useState(1);
    const itemsPerPage = 10;
    const [isAnomalyModalOpen, setIsAnomalyModalOpen] = useState(false);
    const [selectedAnomaly, setSelectedAnomaly] = useState<SecurityAnomaly | null>(null);

    const filteredAnomalies = useMemo(() => {
        let filtered = anomalies.filter(anomaly =>
            anomaly.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
            anomaly.type.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (anomaly.relatedIpAddress?.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (users.find(u => u.id === anomaly.relatedUserId)?.username.toLowerCase().includes(searchTerm.toLowerCase()))
        );

        if (filterSeverity !== 'all') {
            filtered = filtered.filter(anomaly => anomaly.severity === filterSeverity);
        }
        if (filterStatus !== 'all') {
            filtered = filtered.filter(anomaly => anomaly.status === filterStatus);
        }
        return filtered;
    }, [anomalies, searchTerm, filterSeverity, filterStatus, users]);

    const totalPages = Math.ceil(filteredAnomalies.length / itemsPerPage);
    const paginatedAnomalies = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        return filteredAnomalies.slice(startIndex, startIndex + itemsPerPage);
    }, [filteredAnomalies, currentPage, itemsPerPage]);

    const handleViewAnomaly = (anomaly: SecurityAnomaly) => {
        setSelectedAnomaly(anomaly);
        setIsAnomalyModalOpen(true);
    };

    const handleUpdateAnomaly = async (anomalyId: string, status: SecurityAnomaly['status'], notes?: string, assignedTo?: string) => {
        await updateAnomalyStatus(anomalyId, status, notes, assignedTo);
        setIsAnomalyModalOpen(false); // Close after update
    };

    return (
        <Card title="Anomaly Detection">
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                <input
                    type="text"
                    placeholder="Search anomalies..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                />
                <select
                    value={filterSeverity}
                    onChange={(e) => setFilterSeverity(e.target.value as 'all' | SecurityAnomaly['severity'])}
                    className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                >
                    <option value="all">All Severities</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value as 'all' | SecurityAnomaly['status'])}
                    className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                >
                    <option value="all">All Statuses</option>
                    <option value="New">New</option>
                    <option value="Investigating">Investigating</option>
                    <option value="Resolved">Resolved</option>
                    <option value="False Positive">False Positive</option>
                </select>
            </div>

            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-gray-400">
                    <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                        <tr>
                            <th scope="col" className="px-6 py-3">Timestamp</th>
                            <th scope="col" className="px-6 py-3">Type</th>
                            <th scope="col" className="px-6 py-3">Description</th>
                            <th scope="col" className="px-6 py-3">Severity</th>
                            <th scope="col" className="px-6 py-3">User/IP</th>
                            <th scope="col" className="px-6 py-3">Status</th>
                            <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {paginatedAnomalies.length === 0 ? (
                            <tr>
                                <td colSpan={7} className="px-6 py-4 text-center">No anomalies found.</td>
                            </tr>
                        ) : (
                            paginatedAnomalies.map(anomaly => (
                                <tr key={anomaly.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-6 py-4">{new Date(anomaly.timestamp).toLocaleString()}</td>
                                    <td className="px-6 py-4">{anomaly.type}</td>
                                    <td className="px-6 py-4 max-w-xs truncate">{anomaly.description}</td>
                                    <td className="px-6 py-4"><StatusBadge status={anomaly.severity} type="severity" /></td>
                                    <td className="px-6 py-4">
                                        {anomaly.relatedUserId ? users.find(u => u.id === anomaly.relatedUserId)?.username : anomaly.relatedIpAddress || 'N/A'}
                                    </td>
                                    <td className="px-6 py-4"><StatusBadge status={anomaly.status} type="status" /></td>
                                    <td className="px-6 py-4">
                                        <button
                                            onClick={() => handleViewAnomaly(anomaly)}
                                            className="text-blue-400 hover:text-blue-300"
                                        >
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
            <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />

            {selectedAnomaly && (
                <AnomalyDetailModal
                    isOpen={isAnomalyModalOpen}
                    onClose={() => setIsAnomalyModalOpen(false)}
                    anomaly={selectedAnomaly}
                    onUpdate={handleUpdateAnomaly}
                    allUsers={users}
                />
            )}
        </Card>
    );
};

/**
 * Anomaly Detail Modal.
 */
export const AnomalyDetailModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    anomaly: SecurityAnomaly;
    onUpdate: (anomalyId: string, status: SecurityAnomaly['status'], notes?: string, assignedTo?: string) => Promise<void>;
    allUsers: User[];
}> = ({ isOpen, onClose, anomaly, onUpdate, allUsers }) => {
    const [currentStatus, setCurrentStatus] = useState<SecurityAnomaly['status']>(anomaly.status);
    const [resolutionNotes, setResolutionNotes] = useState(anomaly.resolutionNotes || '');
    const [assignedToUser, setAssignedToUser] = useState(anomaly.assignedTo || '');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        setCurrentStatus(anomaly.status);
        setResolutionNotes(anomaly.resolutionNotes || '');
        setAssignedToUser(anomaly.assignedTo || '');
    }, [anomaly]);

    const handleSave = async () => {
        setLoading(true);
        try {
            await onUpdate(anomaly.id, currentStatus, resolutionNotes, assignedToUser || undefined);
            onClose();
        } catch (error) {
            console.error('Failed to update anomaly:', error);
        } finally {
            setLoading(false);
        }
    };

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`Anomaly Details: ${anomaly.type}`}>
            <div className="space-y-4 text-gray-300">
                <p><strong>Timestamp:</strong> {new Date(anomaly.timestamp).toLocaleString()}</p>
                <p><strong>Severity:</strong> <StatusBadge status={anomaly.severity} type="severity" /></p>
                <p><strong>Description:</strong> {anomaly.description}</p>
                {anomaly.relatedUserId && <p><strong>Related User:</strong> {allUsers.find(u => u.id === anomaly.relatedUserId)?.username || anomaly.relatedUserId}</p>}
                {anomaly.relatedIpAddress && <p><strong>Related IP:</strong> {anomaly.relatedIpAddress}</p>}
                <p><strong>Triggered Rules:</strong> {anomaly.triggeredRules.join(', ')}</p>

                <div>
                    <label htmlFor="status" className="block text-sm font-medium">Status:</label>
                    <select
                        id="status"
                        value={currentStatus}
                        onChange={(e) => setCurrentStatus(e.target.value as SecurityAnomaly['status'])}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        <option value="New">New</option>
                        <option value="Investigating">Investigating</option>
                        <option value="Resolved">Resolved</option>
                        <option value="False Positive">False Positive</option>
                    </select>
                </div>
                <div>
                    <label htmlFor="assignedTo" className="block text-sm font-medium">Assigned To:</label>
                    <select
                        id="assignedTo"
                        value={assignedToUser}
                        onChange={(e) => setAssignedToUser(e.target.value)}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                    >
                        <option value="">Unassigned</option>
                        {allUsers.map(user => (
                            <option key={user.id} value={user.id}>{user.username}</option>
                        ))}
                    </select>
                </div>
                <div>
                    <label htmlFor="resolutionNotes" className="block text-sm font-medium">Resolution Notes:</label>
                    <textarea
                        id="resolutionNotes"
                        value={resolutionNotes}
                        onChange={(e) => setResolutionNotes(e.target.value)}
                        rows={4}
                        className="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                        placeholder="Add notes about investigation and resolution..."
                    />
                </div>
            </div>
            <div className="flex justify-end space-x-2 mt-4">
                <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white text-sm"
                    disabled={loading}
                >
                    Cancel
                </button>
                <button
                    type="button"
                    onClick={handleSave}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded text-white text-sm disabled:opacity-50"
                    disabled={loading}
                >
                    {loading ? 'Saving...' : 'Save Changes'}
                </button>
            </div>
        </Modal>
    );
};

/**
 * Threat Intelligence Feed Component.
 */
export const ThreatIntelligenceFeed: React.FC = () => {
    const { threatAlerts, archiveThreatAlert } = useAccessControl();
    const [searchTerm, setSearchTerm] = useState('');
    const [filterSeverity, setFilterSeverity] = useState<'all' | ThreatIntelligenceAlert['severity']>('all');
    const [filterStatus, setFilterStatus] = useState<'all' | ThreatIntelligenceAlert['status']>('all');
    const [currentPage, setCurrentPage] = useState(1);
    const itemsPerPage = 7;

    const filteredAlerts = useMemo(() => {
        let filtered = threatAlerts.filter(alert =>
            alert.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
            alert.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
            alert.source.toLowerCase().includes(searchTerm.toLowerCase()) ||
            alert.relatedCVEs?.some(cve => cve.toLowerCase().includes(searchTerm.toLowerCase()))
        );

        if (filterSeverity !== 'all') {
            filtered = filtered.filter(alert => alert.severity === filterSeverity);
        }
        if (filterStatus !== 'all') {
            filtered = filtered.filter(alert => alert.status === filterStatus);
        }
        return filtered;
    }, [threatAlerts, searchTerm, filterSeverity, filterStatus]);

    const totalPages = Math.ceil(filteredAlerts.length / itemsPerPage);
    const paginatedAlerts = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        return filteredAlerts.slice(startIndex, startIndex + itemsPerPage);
    }, [filteredAlerts, currentPage, itemsPerPage]);

    return (
        <Card title="Threat Intelligence Feed">
            <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                <input
                    type="text"
                    placeholder="Search threats..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                />
                <select
                    value={filterSeverity}
                    onChange={(e) => setFilterSeverity(e.target.value as 'all' | ThreatIntelligenceAlert['severity'])}
                    className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                >
                    <option value="all">All Severities</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
                <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value as 'all' | ThreatIntelligenceAlert['status'])}
                    className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                >
                    <option value="all">All Statuses</option>
                    <option value="Active">Active</option>
                    <option value="Archived">Archived</option>
                    <option value="Mitigated">Mitigated</option>
                </select>
            </div>

            <div className="space-y-4">
                {paginatedAlerts.length === 0 ? (
                    <p className="text-center py-4 text-gray-500">No threat alerts found matching criteria.</p>
                ) : (
                    paginatedAlerts.map(alert => (
                        <div key={alert.id} className="bg-gray-800/50 p-4 rounded-lg border border-gray-700 hover:border-cyan-600 transition-colors duration-200">
                            <div className="flex justify-between items-start mb-2">
                                <h4 className="text-lg font-semibold text-white">{alert.title}</h4>
                                <div className="flex space-x-2">
                                    <StatusBadge status={alert.severity} type="severity" />
                                    <StatusBadge status={alert.status} type="status" />
                                </div>
                            </div>
                            <p className="text-gray-400 text-sm mb-2">{alert.description}</p>
                            <div className="flex flex-wrap items-center text-xs text-gray-500 gap-x-4 gap-y-2">
                                <span>Source: <span className="text-white">{alert.source}</span></span>
                                <span>Detected: <span className="text-white">{new Date(alert.timestamp).toLocaleString()}</span></span>
                                {alert.relatedCVEs && alert.relatedCVEs.length > 0 && (
                                    <span>CVEs: <span className="text-white">{alert.relatedCVEs.join(', ')}</span></span>
                                )}
                                <span>Vector: <span className="text-white">{alert.detectionVector}</span></span>
                            </div>
                            <div className="mt-3 flex justify-end">
                                {alert.status !== 'Archived' && (
                                    <button
                                        onClick={() => archiveThreatAlert(alert.id)}
                                        className="px-3 py-1 bg-red-600/30 text-red-300 hover:bg-red-700/50 rounded text-xs"
                                    >
                                        Archive Alert
                                    </button>
                                )}
                            </div>
                        </div>
                    ))
                )}
            </div>
            <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
        </Card>
    );
};

// --- GLOBAL SECURITY OVERVIEW KPIs ---
export const SecurityOverviewKPIs: React.FC = () => {
    const { users, roles, policies, activeSessions, anomalies, threatAlerts } = useAccessControl();

    const currentKPIData = useMemo(() => ({
        totalUsers: users.length,
        activeUsers: users.filter(u => u.status === 'Active').length,
        totalRoles: roles.length,
        enabledPolicies: policies.filter(p => p.isEnabled).length,
        activeSessionsCount: activeSessions.filter(s => s.status === 'Active').length,
        newAnomalies: anomalies.filter(a => a.status === 'New').length,
        activeThreatAlerts: threatAlerts.filter(t => t.status === 'Active').length,
        usersWithoutMFA: users.filter(u => !u.mfaEnabled && u.status === 'Active').length,
        highRiskUsers: users.filter(u => u.riskScore >= 70 && u.status === 'Active').length,
    }), [users, roles, policies, activeSessions, anomalies, threatAlerts]);

    return (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
            <Card className="text-center">
                <p className="text-4xl font-bold text-white">{currentKPIData.totalUsers}</p>
                <p className="text-sm text-gray-400 mt-1">Total Users</p>
                <p className="text-xs text-green-400">{currentKPIData.activeUsers} Active</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-white">{currentKPIData.totalRoles}</p>
                <p className="text-sm text-gray-400 mt-1">Defined Roles</p>
                <p className="text-xs text-gray-400">{roles.filter(r => r.isActive).length} Active Roles</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-green-400">{currentKPIData.enabledPolicies}</p>
                <p className="text-sm text-gray-400 mt-1">Enabled Security Policies</p>
                <p className="text-xs text-gray-400">{policies.length} Total Policies</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-cyan-400">{currentKPIData.activeSessionsCount}</p>
                <p className="text-sm text-gray-400 mt-1">Active Sessions</p>
                <p className="text-xs text-gray-400">{activeSessions.length - currentKPIData.activeSessionsCount} Idle</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-orange-400">{currentKPIData.newAnomalies}</p>
                <p className="text-sm text-gray-400 mt-1">New Anomalies</p>
                <p className="text-xs text-red-400">{anomalies.filter(a => a.status === 'Investigating').length} Investigating</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-red-400">{currentKPIData.activeThreatAlerts}</p>
                <p className="text-sm text-gray-400 mt-1">Active Threat Alerts</p>
                <p className="text-xs text-gray-400">{threatAlerts.filter(t => t.status === 'Archived').length} Archived</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-yellow-400">{currentKPIData.usersWithoutMFA}</p>
                <p className="text-sm text-gray-400 mt-1">Users w/o MFA</p>
                <p className="text-xs text-gray-400">{users.filter(u => u.mfaEnabled).length} MFA Enabled</p>
            </Card>
            <Card className="text-center">
                <p className="text-4xl font-bold text-red-500">{currentKPIData.highRiskUsers}</p>
                <p className="text-sm text-gray-400 mt-1">High-Risk Users</p>
                <p className="text-xs text-gray-400">Review Required</p>
            </Card>
        </div>
    );
};

// --- ADDITIONAL CHARTS AND VISUALIZATIONS ---

export const AccessStatusPieChart: React.FC<{ logs: AccessLog[] }> = ({ logs }) => {
    const data = useMemo(() => {
        const success = logs.filter(log => log.status === 'Success').length;
        const failed = logs.filter(log => log.status === 'Failed').length;
        return [
            { name: 'Successful', value: success, color: '#10b981' },
            { name: 'Failed', value: failed, color: '#ef4444' },
        ];
    }, [logs]);

    const RADIAN = Math.PI / 180;
    const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, index }: any) => {
        const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
        const x = cx + radius * Math.cos(-midAngle * RADIAN);
        const y = cy + radius * Math.sin(-midAngle * RADIAN);

        return (
            <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central">
                {`${(percent * 100).toFixed(0)}%`}
            </text>
        );
    };

    return (
        <Card title="Access Status Breakdown">
            <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                    <Pie
                        data={data}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={renderCustomizedLabel}
                        outerRadius={100}
                        fill="#8884d8"
                        dataKey="value"
                    >
                        {data.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.color} />
                        ))}
                    </Pie>
                    <Tooltip contentStyle={{ backgroundColor: 'rgba(31, 41, 55, 0.8)', borderColor: '#4b5563' }} />
                    <Legend />
                </PieChart>
            </ResponsiveContainer>
        </Card>
    );
};

export const AnomalySeverityBarChart: React.FC = () => {
    const { anomalies } = useAccessControl();
    const data = useMemo(() => {
        const counts: { [key: string]: number } = {
            Critical: 0, High: 0, Medium: 0, Low: 0
        };
        anomalies.filter(a => a.status !== 'Resolved' && a.status !== 'False Positive').forEach(anomaly => {
            counts[anomaly.severity]++;
        });
        return Object.entries(counts).map(([severity, count]) => ({ severity, count }));
    }, [anomalies]);

    const getSeverityColor = (severity: string) => {
        switch (severity) {
            case 'Critical': return '#9a2e2e'; // Darker red
            case 'High': return '#ef4444'; // Red
            case 'Medium': return '#f59e0b'; // Orange
            case 'Low': return '#22c55e'; // Green
            default: return '#6b7280'; // Gray
        }
    };

    return (
        <Card title="Anomalies by Severity (Open)">
            <ResponsiveContainer width="100%" height={300}>
                <BarChart data={data}>
                    <XAxis dataKey="severity" stroke="#9ca3af" fontSize={12} />
                    <YAxis stroke="#9ca3af" />
                    <Tooltip contentStyle={{ backgroundColor: 'rgba(31, 41, 55, 0.8)', borderColor: '#4b5563' }} />
                    <Legend />
                    <Bar dataKey="count" name="Count" fill="#8884d8">
                        {data.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={getSeverityColor(entry.severity)} />
                        ))}
                    </Bar>
                </BarChart>
            </ResponsiveContainer>
        </Card>
    );
};

// --- MAIN ACCESS CONTROLS VIEW COMPONENT ---

/**
 * The primary Access Controls Dashboard view component.
 * This component orchestrates various security and access management features.
 */
const AccessControlsView: React.FC = () => {
    const context = useContext(DataContext);
    if (!context) throw new Error("AccessControlsView must be within a DataProvider");

    const { accessLogs } = context;
    const [filter, setFilter] = useState<'all' | 'Success' | 'Failed'>('all');
    const [activeTab, setActiveTab] = useState<string>('Overview'); // For tabbed navigation

    const filteredLogs = useMemo(() => {
        return accessLogs.filter(log => filter === 'all' || log.status === filter);
    }, [accessLogs, filter]);

    const kpiData = useMemo(() => ({
        totalUsers: new Set(accessLogs.map(log => log.user)).size,
        failedLogins24h: accessLogs.filter(log => log.status === 'Failed' && (Date.now() - new Date(log.timestamp).getTime() < 24 * 60 * 60 * 1000)).length,
        highRiskEvents: accessLogs.filter(log => log.riskLevel === 'High' && (Date.now() - new Date(log.timestamp).getTime() < 24 * 60 * 60 * 1000)).length,
    }), [accessLogs]);

    const chartData = useMemo(() => {
        const dataByHour: { [key: string]: { success: number, failed: number } } = {};
        const now = new Date();
        const startOf24hAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

        // Initialize data for the last 24 hours
        for (let i = 0; i <= 24; i++) {
            const date = new Date(startOf24hAgo.getTime() + i * 60 * 60 * 1000);
            const hourKey = `${String(date.getHours()).padStart(2, '0')}:00`;
            dataByHour[hourKey] = { success: 0, failed: 0 };
        }

        accessLogs.forEach(log => {
            const logDate = new Date(log.timestamp);
            if (logDate.getTime() >= startOf24hAgo.getTime()) {
                const hourKey = `${String(logDate.getHours()).padStart(2, '0')}:00`;
                if (!dataByHour[hourKey]) dataByHour[hourKey] = { success: 0, failed: 0 }; // Fallback, though initialized
                if (log.status === 'Success') dataByHour[hourKey].success++;
                else dataByHour[hourKey].failed++;
            }
        });

        // Ensure sorted by hour
        return Object.entries(dataByHour)
            .map(([hour, counts]) => ({ hour, ...counts }))
            .sort((a, b) => {
                const hourA = parseInt(a.hour.split(':')[0]);
                const hourB = parseInt(b.hour.split(':')[0]);
                return (hourA < (new Date().getHours()) ? hourA + 24 : hourA) - (hourB < (new Date().getHours()) ? hourB + 24 : hourB);
            });
    }, [accessLogs]);

    // This is the original RiskBadge, renamed to avoid conflict and used directly.
    const RiskBadge: React.FC<{ level: AccessLog['riskLevel'] }> = ({ level }) => {
        const colors = {
            'Low': 'bg-green-500/20 text-green-300',
            'Medium': 'bg-yellow-500/20 text-yellow-300',
            'High': 'bg-red-500/20 text-red-300',
        };
        return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[level]}`}>{level}</span>;
    };

    const tabs = [
        'Overview', 'User Management', 'Role Management', 'Policies',
        'Active Sessions', 'Anomaly Detection', 'Threat Intelligence', 'Audit Logs'
    ];

    const [auditLogSearchTerm, setAuditLogSearchTerm] = useState('');
    const [auditLogFilterUser, setAuditLogFilterUser] = useState('all');
    const [auditLogFilterAction, setAuditLogFilterAction] = useState('all');
    const [auditLogCurrentPage, setAuditLogCurrentPage] = useState(1);
    const auditLogItemsPerPage = 15;

    const auditLogData = useMemo(() => {
        // We'll use accessLogs as a stand-in for detailed audit logs
        const mockAuditLogs: AccessLog[] = MOCK_ACCESS_LOGS.map(log => ({
            ...log,
            action: log.action || 'Unknown Action', // Ensure action property
            details: `Accessed ${log.action} from ${log.ip} using ${log.device}. Status: ${log.status}.`
        })).sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()); // Newest first

        let filtered = mockAuditLogs.filter(log =>
            (log.user.toLowerCase().includes(auditLogSearchTerm.toLowerCase()) ||
            log.ip.toLowerCase().includes(auditLogSearchTerm.toLowerCase()) ||
            log.action.toLowerCase().includes(auditLogSearchTerm.toLowerCase()) ||
            log.details?.toLowerCase().includes(auditLogSearchTerm.toLowerCase()))
        );

        if (auditLogFilterUser !== 'all') {
            filtered = filtered.filter(log => log.user === auditLogFilterUser);
        }
        if (auditLogFilterAction !== 'all') {
            filtered = filtered.filter(log => log.action === auditLogFilterAction);
        }
        return filtered;
    }, [MOCK_ACCESS_LOGS, auditLogSearchTerm, auditLogFilterUser, auditLogFilterAction]);

    const auditLogTotalPages = Math.ceil(auditLogData.length / auditLogItemsPerPage);
    const paginatedAuditLogs = useMemo(() => {
        const startIndex = (auditLogCurrentPage - 1) * auditLogItemsPerPage;
        return auditLogData.slice(startIndex, startIndex + auditLogItemsPerPage);
    }, [auditLogData, auditLogCurrentPage, auditLogItemsPerPage]);

    // Unique users and actions for filters
    const uniqueAuditUsers = useMemo(() => ['all', ...new Set(MOCK_ACCESS_LOGS.map(log => log.user))].sort(), []);
    const uniqueAuditActions = useMemo(() => ['all', ...new Set(MOCK_ACCESS_LOGS.map(log => log.action))].sort(), []);


    return (
        <AccessControlProvider>
            <div className="space-y-6">
                <h2 className="text-3xl font-bold text-white tracking-wider">Access Controls Dashboard</h2>

                <nav className="flex space-x-2 border-b border-gray-700 mb-6 overflow-x-auto">
                    {tabs.map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200
                                ${activeTab === tab ? 'bg-cyan-600 text-white' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`}
                        >
                            {tab}
                        </button>
                    ))}
                </nav>

                {activeTab === 'Overview' && (
                    <>
                        <SecurityOverviewKPIs />

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <Card className="text-center"><p className="text-3xl font-bold text-white">{kpiData.totalUsers}</p><p className="text-sm text-gray-400 mt-1">Total Users (Access Logs)</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-red-400">{kpiData.failedLogins24h}</p><p className="text-sm text-gray-400 mt-1">Failed Logins (24h)</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-orange-400">{kpiData.highRiskEvents}</p><p className="text-sm text-gray-400 mt-1">High-Risk Events (24h)</p></Card>
                            <Card className="text-center"><p className="text-3xl font-bold text-yellow-400">{(MOCK_SECURITY_POLICIES.filter(p => !p.isEnabled).length)}</p><p className="text-sm text-gray-400 mt-1">Disabled Policies</p></Card>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card title="Login Attempts (Last 24 hours)">
                                <ResponsiveContainer width="100%" height={300}>
                                    <LineChart data={chartData}>
                                        <XAxis dataKey="hour" stroke="#9ca3af" fontSize={12} />
                                        <YAxis stroke="#9ca3af" />
                                        <Tooltip contentStyle={{ backgroundColor: 'rgba(31, 41, 55, 0.8)', borderColor: '#4b5563' }} />
                                        <Legend />
                                        <Line type="monotone" dataKey="success" name="Successful" stroke="#10b981" dot={false} />
                                        <Line type="monotone" dataKey="failed" name="Failed" stroke="#ef4444" dot={false} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </Card>
                            <AccessStatusPieChart logs={accessLogs} />
                            <AnomalySeverityBarChart />
                            <Card title="Recent Access Events">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold text-white"></h3>
                                    <div className="flex space-x-1 p-1 bg-gray-900/50 rounded-lg">
                                        {(['all', 'Success', 'Failed'] as const).map(status => (
                                            <button key={status} onClick={() => setFilter(status)} className={`px-3 py-1 text-sm rounded-md ${filter === status ? 'bg-cyan-600' : ''}`}>{status}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-gray-400">
                                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                            <tr>
                                                <th scope="col" className="px-6 py-3">User</th>
                                                <th scope="col" className="px-6 py-3">IP Address</th>
                                                <th scope="col" className="px-6 py-3">Location</th>
                                                <th scope="col" className="px-6 py-3">Time</th>
                                                <th scope="col" className="px-6 py-3">Status</th>
                                                <th scope="col" className="px-6 py-3">Risk Level</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredLogs.slice(0, 5).map(log => ( // Show only top 5 for overview
                                                <tr key={log.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                                    <td className="px-6 py-4 font-medium text-white">{log.user}</td>
                                                    <td className="px-6 py-4 font-mono">{log.ip}</td>
                                                    <td className="px-6 py-4">{log.location}</td>
                                                    <td className="px-6 py-4">{log.timestamp}</td>
                                                    <td className="px-6 py-4"><span className={log.status === 'Success' ? 'text-green-400' : 'text-red-400'}>{log.status}</span></td>
                                                    <td className="px-6 py-4"><RiskBadge level={log.riskLevel} /></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    </>
                )}

                {activeTab === 'User Management' && <UserManagement />}
                {activeTab === 'Role Management' && <RoleManagement />}
                {activeTab === 'Policies' && <PolicyManagement />}
                {activeTab === 'Active Sessions' && <ActiveSessionsView />}
                {activeTab === 'Anomaly Detection' && <AnomalyDetectionView />}
                {activeTab === 'Threat Intelligence' && <ThreatIntelligenceFeed />}

                {activeTab === 'Audit Logs' && (
                    <Card title="Comprehensive Audit Logs">
                        <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                            <input
                                type="text"
                                placeholder="Search logs (user, IP, action, details)..."
                                value={auditLogSearchTerm}
                                onChange={(e) => setAuditLogSearchTerm(e.target.value)}
                                className="flex-1 min-w-[200px] p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                            />
                            <select
                                value={auditLogFilterUser}
                                onChange={(e) => setAuditLogFilterUser(e.target.value)}
                                className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                            >
                                {uniqueAuditUsers.map(user => (
                                    <option key={user} value={user}>{user === 'all' ? 'All Users' : user}</option>
                                ))}
                            </select>
                            <select
                                value={auditLogFilterAction}
                                onChange={(e) => setAuditLogFilterAction(e.target.value)}
                                className="p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-1 focus:ring-cyan-500"
                            >
                                {uniqueAuditActions.map(action => (
                                    <option key={action} value={action}>{action === 'all' ? 'All Actions' : action}</option>
                                ))}
                            </select>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-gray-400">
                                <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                                    <tr>
                                        <th scope="col" className="px-6 py-3">Timestamp</th>
                                        <th scope="col" className="px-6 py-3">User</th>
                                        <th scope="col" className="px-6 py-3">Action</th>
                                        <th scope="col" className="px-6 py-3">Status</th>
                                        <th scope="col" className="px-6 py-3">IP Address</th>
                                        <th scope="col" className="px-6 py-3">Location</th>
                                        <th scope="col" className="px-6 py-3">Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {paginatedAuditLogs.length === 0 ? (
                                        <tr>
                                            <td colSpan={7} className="px-6 py-4 text-center">No audit logs found matching criteria.</td>
                                        </tr>
                                    ) : (
                                        paginatedAuditLogs.map(log => (
                                            <tr key={log.id} className="border-b border-gray-800 hover:bg-gray-800/50">
                                                <td className="px-6 py-4">{new Date(log.timestamp).toLocaleString()}</td>
                                                <td className="px-6 py-4 font-medium text-white">{log.user}</td>
                                                <td className="px-6 py-4">{log.action}</td>
                                                <td className="px-6 py-4"><span className={log.status === 'Success' ? 'text-green-400' : 'text-red-400'}>{log.status}</span></td>
                                                <td className="px-6 py-4 font-mono">{log.ip}</td>
                                                <td className="px-6 py-4">{log.location}</td>
                                                <td className="px-6 py-4 max-w-xs truncate">{log.details || 'N/A'}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                        <Pagination currentPage={auditLogCurrentPage} totalPages={auditLogTotalPages} onPageChange={setAuditLogCurrentPage} />
                    </Card>
                )}
            </div>
        </AccessControlProvider>
    );
};

export default AccessControlsView;

--- FILE: AuditLogsView.tsx ---

// components/views/megadashboard/security/AuditLogsView.tsx
import React from 'react';
import Card from '../../../Card';

const AuditLogsView: React.FC = () => {
    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Immutable Audit Logs</h2>
            <Card title="Mission Brief">
                <p className="text-gray-400">An immutable, cryptographically-secured log of all critical activities within the Demo Bank platform. Use natural language queries to investigate complex events and generate compliance reports instantly.</p>
            </Card>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <Card title="Natural Language Query"><p>Investigate security and system events by asking questions in plain English. Our AI translates your intent into a precise query.</p></Card>
                 <Card title="AI Anomaly Summarization"><p>Automatically receive AI-generated summaries of suspicious or anomalous event clusters, cutting down investigation time by 90%.</p></Card>
                 <Card title="Predictive Breach Indicators"><p>Our system analyzes log patterns against global threat models to predict potential security breaches before they happen.</p></Card>
            </div>
        </div>
    );
};

export default AuditLogsView;

--- FILE: FraudDetectionView.tsx ---

import React, { useContext, useMemo, useState, useEffect, useCallback, createContext } from 'react';
import Card from '../../../Card';
import { DataContext } from '../../../../context/DataContext';
import { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend, BarChart, Bar, PieChart, Pie, Cell, LineChart, Line, ScatterChart, Scatter, ZAxis } from 'recharts';
import { FraudCase } from '../../../../types'; // Original FraudCase type
import { GoogleGenAI } from '@google/genai';

// --- NEW TYPES AND INTERFACES (approx. 200-300 lines) ---
/**
 * @typedef {Object} TransactionDetail Represents a single transaction associated with a fraud case.
 * This provides granular data for forensic analysis.
 */
export interface TransactionDetail {
    transactionId: string;
    amount: number;
    currency: string;
    timestamp: string;
    merchantId: string;
    merchantName: string;
    paymentMethod: string; // e.g., 'Credit Card', 'PayPal', 'Bitcoin'
    cardType?: string; // e.g., 'Visa', 'Mastercard'
    cardNumberLast4?: string;
    billingAddress: {
        street: string;
        city: string;
        state: string;
        zip: string;
        country: string;
    };
    shippingAddress?: {
        street: string;
        city: string;
        state: string;
        zip: string;
        country: string;
    };
    ipAddress: string;
    deviceInfo: string; // e.g., 'Chrome on Windows 10', 'iOS Safari'
    geolocation: {
        latitude: number;
        longitude: number;
        city: string;
        country: string;
    };
    status: 'Approved' | 'Declined' | 'Pending'; // Transaction status
    riskScore: number; // Transaction-specific risk score
    fraudModelScores?: { // Scores from various internal/external fraud models
        modelA: number;
        modelB: number;
        modelC: number;
    };
    flags?: string[]; // e.g., 'HighVelocity', 'IPMismatch', 'NewDevice', 'CardTesting'
}

/**
 * @typedef {Object} UserProfile Represents the profile details of the user involved in a fraud case.
 */
export interface UserProfile {
    userId: string;
    username: string;
    email: string;
    accountCreationDate: string;
    lastLoginDate: string;
    totalTransactions: number;
    totalAmountSpent: number;
    associatedAccounts: string[]; // Other accounts linked to this user
    KYCStatus: 'Verified' | 'Pending' | 'Unverified' | 'Failed';
    loyaltyTier: 'Bronze' | 'Silver' | 'Gold' | 'Platinum';
    reputationScore: number; // Internal reputation score based on past behavior
    phoneNumber?: string;
    addressHistory?: Array<{ street: string; city: string; state: string; zip: string; country: string; validFrom: string; validTo?: string }>;
}

/**
 * @typedef {Object} DeviceFingerprint Stores details about the device used for the transaction.
 */
export interface DeviceFingerprint {
    fingerprintId: string;
    browser: string;
    os: string;
    deviceType: string; // 'Mobile', 'Desktop', 'Tablet'
    screenWidth: number;
    screenHeight: number;
    plugins: string[]; // List of browser plugins detected
    userAgent: string;
    firstSeen: string; // Timestamp when this device was first seen
    lastSeen: string; // Timestamp when this device was last seen
    associatedUserIds: string[]; // Other users linked to this device
    vpnDetected?: boolean;
    proxyDetected?: boolean;
    timezoneOffset?: number;
    language?: string;
}

/**
 * @typedef {Object} Comment Represents a comment or note added by an analyst to a fraud case.
 */
export interface Comment {
    id: string;
    analystId: string;
    analystName: string;
    timestamp: string;
    content: string;
    edited?: boolean; // Indicates if the comment was later edited
}

/**
 * @typedef {Object} Attachment Represents a document or file attached to a fraud case.
 */
export interface Attachment {
    id: string;
    filename: string;
    fileType: string;
    url: string; // URL to access the attachment
    uploadedBy: string;
    uploadedAt: string;
}

/**
 * @typedef {Object} AuditLogEntry Records a significant action or change related to a fraud case.
 */
export interface AuditLogEntry {
    id: string;
    timestamp: string;
    action: string; // e.g., 'Status Changed', 'Analyst Assigned', 'Comment Added', 'Rule Applied'
    analystId: string;
    analystName: string;
    details: Record<string, any>; // Specific details about the action
}

/**
 * @typedef {Object} RiskFactorBreakdown Provides a granular view of different risk contributors.
 */
export interface RiskFactorBreakdown {
    ipVelocity: number; // Score based on IP address usage velocity
    deviceVelocity: number; // Score based on device usage velocity
    geoMismatch: number; // Score for IP vs. billing/shipping address mismatch
    amountThreshold: number; // Score for transaction amount exceeding thresholds
    newAccount: number; // Score for new accounts showing risky behavior
    suspiciousPattern: number; // Score for general suspicious patterns
    identityVerification: number; // Score from ID verification services
    paymentMethodRisk: number; // Risk associated with the payment method
    behavioralAnalytics: number; // Score from user behavioral analytics
    totalScore: number; // Overall aggregated risk score
}

/**
 * @typedef {Object} FraudRule Defines a specific rule for fraud detection.
 */
export interface FraudRule {
    id: string;
    name: string;
    description: string;
    status: 'Active' | 'Inactive' | 'Draft';
    severity: 'Low' | 'Medium' | 'High' | 'Critical';
    condition: string; // e.g., "transaction.amount > 1000 && user.country != transaction.ip.country"
    action: 'Flag' | 'Deny' | 'Review' | 'Escalate';
    createdBy: string;
    createdAt: string;
    lastUpdatedBy: string;
    lastUpdatedAt: string;
    hitCount: number; // Number of times this rule has triggered an alert
    falsePositiveRate?: number; // % of false positives
    falseNegativeRate?: number; // % of false negatives (missed fraud)
    priorityOrder: number; // Order in which rules are evaluated
    tags?: string[]; // e.g., 'High-Value', 'IP-Risk', 'New-User'
}

/**
 * @typedef {Object} Analyst Represents a fraud analyst user in the system.
 */
export interface Analyst {
    id: string;
    name: string;
    role: 'Junior Analyst' | 'Senior Analyst' | 'Lead Investigator' | 'Admin';
    email: string;
    assignedCases: string[]; // List of case IDs assigned to this analyst
    active: boolean; // Account active status
    photoUrl: string;
    lastLogin?: string;
    teamId?: string;
    teamName?: string;
}

/**
 * @typedef {Object} AlertNotification Represents an alert generated by the system or a rule.
 */
export interface AlertNotification {
    id: string;
    caseId?: string; // Optional: ID of the fraud case linked to this alert
    ruleId?: string; // Optional: ID of the rule that triggered this alert
    type: 'System' | 'Rule Trigger' | 'Manual' | 'Anomaly';
    message: string;
    severity: 'Info' | 'Warning' | 'Critical';
    timestamp: string;
    read: boolean;
    actionTaken?: string; // e.g., 'Reviewed', 'Dismissed'
    category?: 'Transaction' | 'Login' | 'Account' | 'System';
}

/**
 * @typedef {Object} FraudTrendData Data point for historical fraud trends.
 */
export interface FraudTrendData {
    date: string; // YYYY-MM-DD
    newCases: number;
    resolvedCases: number;
    amountFlagged: number;
    averageRiskScore: number;
    falsePositives: number;
}

/**
 * @typedef {Object} GeoFraudData Data point for geographical fraud distribution.
 */
export interface GeoFraudData {
    country: string;
    cases: number;
    amount: number;
    riskScore: number;
    coordinates: {
        latitude: number;
        longitude: number;
    };
}

/**
 * @typedef {Object} ReportDefinition Defines the structure for a predefined or custom report.
 */
export interface ReportDefinition {
    id: string;
    name: string;
    description: string;
    type: 'summary' | 'trend' | 'geographic' | 'custom' | 'performance';
    params: Record<string, any>;
    lastGenerated: string;
    generatedBy: string;
    status: 'Generated' | 'Pending' | 'Failed';
    downloadLink?: string;
}

// Extend the original FraudCase type conceptually for this file's usage.
// In a real app, FraudCase in types.ts would be updated or a new type would inherit.
export interface ExtendedFraudCase extends FraudCase {
    caseId: string; // Adding explicit caseId for consistency
    analystId?: string;
    analystName?: string;
    priority: 'Low' | 'Medium' | 'High' | 'Critical';
    fraudType: 'Account Takeover' | 'Synthetic ID' | 'Chargeback Fraud' | 'Friendly Fraud' | 'Phishing' | 'Mule Account' | 'Refund Abuse';
    transactionDetails: TransactionDetail[];
    userProfile: UserProfile;
    deviceFingerprint: DeviceFingerprint;
    riskFactors: RiskFactorBreakdown;
    comments: Comment[];
    attachments: Attachment[];
    auditLog: AuditLogEntry[];
    recommendedAction?: string; // AI recommendation for next steps
    resolutionNotes?: string;
    resolutionDate?: string;
    relatedCases?: string[]; // Other cases potentially linked to this one
    decisionHistory?: {
        decidedBy: string;
        decidedAt: string;
        decision: 'Investigate' | 'Resolve' | 'Dismiss' | 'Escalate' | 'Approve';
        reason?: string;
    }[];
    lastUpdatedBy?: string;
    lastUpdatedAt?: string;
    sourceRuleId?: string; // If flagged by a specific rule
    modelPredictionConfidence?: number; // AI model's confidence in fraud prediction
}


// --- UTILITY FUNCTIONS (approx. 300-400 lines) ---
/**
 * Generates a unique ID.
 * @returns {string} A unique identifier.
 */
export const generateId = (): string => Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

/**
 * Formats a number as currency.
 * @param {number} amount - The amount to format.
 * @param {string} currency - The currency symbol (e.g., '$').
 * @returns {string} Formatted currency string.
 */
export const formatCurrency = (amount: number, currency: string = '$'): string => `${currency}${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

/**
 * Formats a date string into a more readable format.
 * @param {string} dateString - The date string to format.
 * @returns {string} Formatted date string.
 */
export const formatDate = (dateString: string): string => {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString; // Return original if invalid
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
};

/**
 * Calculates a color based on risk score (red for high, green for low).
 * @param {number} score - The risk score (0-100).
 * @returns {string} Tailwind CSS class for text color.
 */
export const getRiskScoreColor = (score: number): string => {
    if (score > 85) return 'text-red-400';
    if (score > 70) return 'text-orange-400';
    if (score > 55) return 'text-yellow-400';
    return 'text-green-400';
};

/**
 * Capitalizes the first letter of a string.
 * @param {string} str - The input string.
 * @returns {string} The string with the first letter capitalized.
 */
export const capitalize = (str: string): string => {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
};

/**
 * Generates a random number within a range.
 * @param {number} min - Minimum value.
 * @param {number} max - Maximum value.
 * @returns {number} Random number.
 */
export const getRandom = (min: number, max: number): number => Math.floor(Math.random() * (max - min + 1)) + min;

/**
 * Generates a random date within a range.
 * @param {Date} start - Start date.
 * @param {Date} end - End date.
 * @returns {string} Random date as ISO string.
 */
export const getRandomDate = (start: Date, end: Date): string => {
    const date = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
    return date.toISOString();
};

/**
 * Helper to get a random item from an array.
 * @param {Array<T>} arr - The array.
 * @returns {T} A random item from the array.
 */
export const getRandomItem = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)];

// Mock geo coordinates for major cities
const MOCK_CITIES = [
    { city: 'New York', country: 'USA', lat: 40.7128, lon: -74.0060 },
    { city: 'London', country: 'UK', lat: 51.5074, lon: -0.1278 },
    { city: 'Tokyo', country: 'Japan', lat: 35.6895, lon: 139.6917 },
    { city: 'Paris', country: 'France', lat: 48.8566, lon: 2.3522 },
    { city: 'Sydney', country: 'Australia', lat: -33.8688, lon: 151.2093 },
    { city: 'Berlin', country: 'Germany', lat: 52.5200, lon: 13.4050 },
    { city: 'Dubai', country: 'UAE', lat: 25.2048, lon: 55.2708 },
    { city: 'Singapore', country: 'Singapore', lat: 1.3521, lon: 103.8198 },
    { city: 'San Francisco', country: 'USA', lat: 37.7749, lon: -122.4194 },
    { city: 'Mumbai', country: 'India', lat: 19.0760, lon: 72.8777 },
    { city: 'Shanghai', country: 'China', lat: 31.2304, lon: 121.4737 },
    { city: 'Sao Paulo', country: 'Brazil', lat: -23.5505, lon: -46.6333 },
    { city: 'Mexico City', country: 'Mexico', lat: 19.4326, lon: -99.1332 },
    { city: 'Cairo', country: 'Egypt', lat: 30.0444, lon: 31.2357 },
    { city: 'Moscow', country: 'Russia', lat: 55.7558, lon: 37.6173 },
];

/**
 * Generates mock transaction details.
 */
export const generateMockTransactionDetails = (userId: string, timestamp: string): TransactionDetail => {
    const amount = parseFloat((Math.random() * 5000 + 50).toFixed(2));
    const merchantName = getRandomItem(['Amazon', 'eBay', 'PayPal', 'Stripe', 'Walmart', 'Target', 'BestBuy', 'Shein', 'Alibaba', 'Zara', 'Steam', 'Netflix']);
    const paymentMethod = getRandomItem(['Credit Card', 'Debit Card', 'PayPal', 'Bank Transfer', 'Bitcoin', 'Apple Pay', 'Google Pay']);
    const cardType = paymentMethod.includes('Card') ? getRandomItem(['Visa', 'Mastercard', 'Amex', 'Discover']) : undefined;
    const cardNumberLast4 = cardType ? String(getRandom(1000, 9999)) : undefined;
    const cityData = getRandomItem(MOCK_CITIES);
    const ip = `${getRandom(1, 255)}.${getRandom(1, 255)}.${getRandom(1, 255)}.${getRandom(1, 255)}`;
    const device = getRandomItem(['Chrome on Windows 10', 'Safari on iOS', 'Firefox on MacOS', 'Edge on Android', 'Brave on Linux', 'Opera on ChromeOS']);

    return {
        transactionId: `TXN-${generateId().toUpperCase()}`,
        amount: amount,
        currency: 'USD',
        timestamp: timestamp,
        merchantId: `M-${getRandom(10000, 99999)}`,
        merchantName: merchantName,
        paymentMethod: paymentMethod,
        cardType: cardType,
        cardNumberLast4: cardNumberLast4,
        billingAddress: {
            street: `${getRandom(100, 999)} Main St`,
            city: cityData.city,
            state: 'CA', // Simplified
            zip: String(getRandom(10000, 99999)),
            country: cityData.country,
        },
        ipAddress: ip,
        deviceInfo: device,
        geolocation: {
            latitude: cityData.lat + (Math.random() - 0.5) * 0.1, // Small variation
            longitude: cityData.lon + (Math.random() - 0.5) * 0.1,
            city: cityData.city,
            country: cityData.country,
        },
        status: getRandomItem(['Approved', 'Declined', 'Pending']),
        riskScore: getRandom(30, 99),
        fraudModelScores: {
            modelA: getRandom(20, 95),
            modelB: getRandom(20, 95),
            modelC: getRandom(20, 95),
        },
        flags: getRandomItem([
            [], ['HighVelocity'], ['IPMismatch'], ['NewDevice'], ['HighVelocity', 'IPMismatch'], ['CardTesting', 'NewDevice']
        ]),
    };
};

/**
 * Generates mock user profile.
 */
export const generateMockUserProfile = (baseId: string): UserProfile => {
    const creationDate = getRandomDate(new Date(2020, 0, 1), new Date());
    const lastLogin = getRandomDate(new Date(creationDate), new Date());
    return {
        userId: `USR-${baseId}`,
        username: `user_${baseId}`,
        email: `user.${baseId}@example.com`,
        accountCreationDate: creationDate,
        lastLoginDate: lastLogin,
        totalTransactions: getRandom(10, 500),
        totalAmountSpent: parseFloat((Math.random() * 100000 + 500).toFixed(2)),
        associatedAccounts: Array.from({ length: getRandom(0, 2) }).map(() => `ACC-${generateId().substring(0, 8)}`),
        KYCStatus: getRandomItem(['Verified', 'Pending', 'Unverified', 'Failed']),
        loyaltyTier: getRandomItem(['Bronze', 'Silver', 'Gold', 'Platinum']),
        reputationScore: getRandom(300, 900),
        phoneNumber: `+1-${getRandom(200, 999)}-${getRandom(200, 999)}-${getRandom(1000, 9999)}`,
        addressHistory: Array.from({ length: getRandom(1, 2) }).map((_, idx) => ({
            street: `${getRandom(100, 999)} Oak Ave`,
            city: getRandomItem(MOCK_CITIES).city,
            state: 'TX',
            zip: String(getRandom(10000, 99999)),
            country: getRandomItem(['USA', 'Canada']).country,
            validFrom: getRandomDate(new Date(2018, 0, 1), new Date(2022, 0, 1)),
            validTo: idx === 0 ? getRandomDate(new Date(2022, 1, 1), new Date(2023, 0, 1)) : undefined,
        }))
    };
};

/**
 * Generates mock device fingerprint.
 */
export const generateMockDeviceFingerprint = (): DeviceFingerprint => {
    const browsers = ['Chrome', 'Safari', 'Firefox', 'Edge'];
    const oses = ['Windows 10', 'macOS', 'iOS', 'Android', 'Linux'];
    const deviceTypes = ['Mobile', 'Desktop', 'Tablet'];
    const plugins = ['Flash', 'Java', 'PDF Viewer', 'AdBlocker', 'WebRTC'];

    const firstSeen = getRandomDate(new Date(2021, 0, 1), new Date());
    const lastSeen = getRandomDate(new Date(firstSeen), new Date());

    return {
        fingerprintId: `FP-${generateId().toUpperCase()}`,
        browser: getRandomItem(browsers),
        os: getRandomItem(oses),
        deviceType: getRandomItem(deviceTypes),
        screenWidth: getRandomItem([1920, 1440, 1366, 375, 414, 768]),
        screenHeight: getRandomItem([1080, 900, 768, 667, 896, 1024]),
        plugins: Array.from({ length: getRandom(1, 3) }).map(() => getRandomItem(plugins)),
        userAgent: `Mozilla/5.0 (${getRandomItem(oses)}) AppleWebKit/537.36 (KHTML, like Gecko) ${getRandomItem(browsers)}`,
        firstSeen: firstSeen,
        lastSeen: lastSeen,
        associatedUserIds: [], // To be filled later if needed
        vpnDetected: Math.random() > 0.7,
        proxyDetected: Math.random() > 0.8,
        timezoneOffset: getRandom(-12 * 60, 12 * 60), // In minutes
        language: getRandomItem(['en-US', 'es-ES', 'fr-FR', 'de-DE']),
    };
};

/**
 * Generates mock comments.
 */
export const generateMockComments = (num: number, analystIds: string[], analystNames: string[]): Comment[] => {
    return Array.from({ length: num }).map(() => {
        const analystIndex = getRandom(0, analystIds.length - 1);
        return {
            id: generateId(),
            analystId: analystIds[analystIndex],
            analystName: analystNames[analystIndex],
            timestamp: getRandomDate(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), new Date()),
            content: getRandomItem([
                'Initial review suggests potential IP spoofing due to multiple login attempts from different geos.',
                'Cross-referenced with internal watchlist. User has previous suspicious activity flags.',
                'Requested additional documentation from user. Awaiting response.',
                'Transaction velocity is unusually high for this account profile.',
                'Fraudulent chargeback pattern detected in associated transactions.',
                'Seems to be a legitimate transaction after further investigation. Lowering priority.',
                'Escalated to senior analyst due to high amount and complex pattern.',
                'Confirmed identity via third-party IDV service. Transaction appears legitimate.',
                'Blocked associated IPs and devices. Notifying user of account compromise.',
            ]),
            edited: Math.random() > 0.8,
        };
    });
};

/**
 * Generates mock attachments.
 */
export const generateMockAttachments = (num: number, uploadedBy: string[]): Attachment[] => {
    return Array.from({ length: num }).map(() => ({
        id: generateId(),
        filename: getRandomItem(['invoice.pdf', 'screenshot.png', 'bank_statement.jpg', 'chat_log.txt', 'id_document.jpeg', 'transaction_receipt.pdf']),
        fileType: getRandomItem(['application/pdf', 'image/png', 'image/jpeg', 'text/plain']),
        url: `https://example.com/attachments/${generateId()}`,
        uploadedBy: getRandomItem(uploadedBy),
        uploadedAt: getRandomDate(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), new Date()),
    }));
};

/**
 * Generates mock audit log entries for a case.
 */
export const generateMockAuditLog = (caseId: string, analystIds: string[], analystNames: string[], creationDate: string): AuditLogEntry[] => {
    const logs: AuditLogEntry[] = [];
    const initialTimestamp = new Date(creationDate).getTime();

    // Initial creation log
    logs.push({
        id: generateId(),
        timestamp: creationDate,
        action: 'Case Created',
        analystId: analystIds[0],
        analystName: analystNames[0],
        details: { caseId: caseId, initialStatus: 'New' },
    });

    // Simulate status changes
    const statuses: Array<ExtendedFraudCase['status']> = ['New', 'Investigating', 'Resolved', 'Dismissed'];
    let currentStatus = 'New';
    let currentTimestamp = initialTimestamp;

    for (let i = 0; i < getRandom(1, 3); i++) {
        const nextStatus = getRandomItem(statuses.filter(s => s !== currentStatus));
        currentTimestamp += getRandom(1, 7) * 24 * 60 * 60 * 1000; // Add 1-7 days
        if (currentTimestamp > Date.now()) break; // Don't generate future logs
        const analystIndex = getRandom(0, analystIds.length - 1);
        logs.push({
            id: generateId(),
            timestamp: new Date(currentTimestamp).toISOString(),
            action: 'Status Changed',
            analystId: analystIds[analystIndex],
            analystName: analystNames[analystIndex],
            details: { from: currentStatus, to: nextStatus },
        });
        currentStatus = nextStatus;
    }

    // Simulate analyst assignment
    if (Math.random() > 0.5) {
        currentTimestamp += getRandom(1, 3) * 24 * 60 * 60 * 1000;
        if (currentTimestamp < Date.now()) {
            const analystIndex = getRandom(0, analystIds.length - 1);
            logs.push({
                id: generateId(),
                timestamp: new Date(currentTimestamp).toISOString(),
                action: 'Analyst Assigned',
                analystId: analystIds[analystIndex],
                analystName: analystNames[analystIndex],
                details: { assignedTo: analystNames[analystIndex], analystId: analystIds[analystIndex] },
            });
        }
    }

    // Simulate other actions
    if (Math.random() > 0.4) {
        currentTimestamp += getRandom(1, 2) * 24 * 60 * 60 * 1000;
        if (currentTimestamp < Date.now()) {
            const analystIndex = getRandom(0, analystIds.length - 1);
            logs.push({
                id: generateId(),
                timestamp: new Date(currentTimestamp).toISOString(),
                action: 'Comment Added',
                analystId: analystIds[analystIndex],
                analystName: analystNames[analystIndex],
                details: { contentPreview: "Added initial findings." },
            });
        }
    }

    if (Math.random() > 0.6) {
        currentTimestamp += getRandom(1, 2) * 24 * 60 * 60 * 1000;
        if (currentTimestamp < Date.now()) {
            const analystIndex = getRandom(0, analystIds.length - 1);
            logs.push({
                id: generateId(),
                timestamp: new Date(currentTimestamp).toISOString(),
                action: 'Evidence Attached',
                analystId: analystIds[analystIndex],
                analystName: analystNames[analystIndex],
                details: { filename: "screenshot.png", type: "image/png" },
            });
        }
    }

    return logs.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
};

/**
 * Generates a mock extended fraud case.
 */
export const generateMockExtendedFraudCase = (index: number, analysts: Analyst[], rules: FraudRule[]): ExtendedFraudCase => {
    const analystIds = analysts.map(a => a.id);
    const analystNames = analysts.map(a => a.name);
    const id = `CASE-${generateId().substring(0, 8).toUpperCase()}`;
    const timestamp = getRandomDate(new Date(Date.now() - 60 * 24 * 60 * 60 * 1000), new Date()); // Last 60 days
    const riskScore = getRandom(50, 99);
    const amount = parseFloat((Math.random() * 10000 + 100).toFixed(2));
    const status: ExtendedFraudCase['status'] = getRandomItem(['New', 'Investigating', 'Resolved', 'Dismissed']);
    const priority: ExtendedFraudCase['priority'] = getRandomItem(['Low', 'Medium', 'High', 'Critical']);
    const fraudType: ExtendedFraudCase['fraudType'] = getRandomItem([
        'Account Takeover', 'Synthetic ID', 'Chargeback Fraud', 'Friendly Fraud', 'Phishing', 'Mule Account', 'Refund Abuse'
    ]);
    const caseAnalyst = getRandomItem(analysts);

    const description = getRandomItem([
        'Multiple failed login attempts followed by a successful login from a new IP and device.',
        'High value transaction to a new merchant, inconsistent with past user behavior and geolocation.',
        'Customer claims unrecognized transaction on statement, potential card compromise or friendly fraud.',
        'Account created with suspicious personal details (e.g., disposable email), attempting large purchases immediately.',
        'Multiple small transactions rapidly, potentially card testing, followed by a large purchase.',
        'Large international wire transfer from a recently created account with unverified KYC.',
        'User complaint about unauthorized access to their email, leading to password reset and subsequent transactions.',
        'Suspicious pattern of gift card purchases followed by immediate redemption from a different region.',
        'Identity details used across multiple accounts, potential synthetic identity fraud or account farming.',
        'Repeated refund requests on digital goods without clear reason, potential refund abuse.',
        'Unusual spending pattern: sudden spike in luxury item purchases after prolonged inactivity.',
    ]);

    const transactionDetails = Array.from({ length: getRandom(1, 3) }).map(() => generateMockTransactionDetails(caseAnalyst.userId, timestamp));
    const userProfile = generateMockUserProfile(caseAnalyst.userId);
    const deviceFingerprint = generateMockDeviceFingerprint();

    // Link device fingerprint to user
    deviceFingerprint.associatedUserIds.push(userProfile.userId);

    const riskFactors: RiskFactorBreakdown = {
        ipVelocity: getRandom(10, 90),
        deviceVelocity: getRandom(10, 90),
        geoMismatch: getRandom(10, 90),
        amountThreshold: getRandom(10, 90),
        newAccount: getRandom(10, 90),
        suspiciousPattern: getRandom(10, 90),
        identityVerification: getRandom(10, 90),
        paymentMethodRisk: getRandom(10, 90),
        behavioralAnalytics: getRandom(10, 90),
        totalScore: riskScore,
    };

    const comments = generateMockComments(getRandom(0, 3), analystIds, analystNames);
    const attachments = generateMockAttachments(getRandom(0, 2), analystNames);
    const auditLog = generateMockAuditLog(id, analystIds, analystNames, timestamp);

    const resolved = status === 'Resolved' || status === 'Dismissed';
    const resolutionDate = resolved ? getRandomDate(new Date(new Date(timestamp).getTime() + 2 * 24 * 60 * 60 * 1000), new Date()) : undefined; // 2 days after creation
    const resolutionNotes = resolved ? getRandomItem([
        'Investigation complete. Funds recovered and account secured.',
        'Case dismissed due to insufficient evidence. Account placed under enhanced monitoring.',
        'Transaction confirmed as legitimate after user verification. False positive.',
        'User confirmed transaction was authorized after initial dispute, closed as friendly fraud.',
        'Account locked, fraudulent transactions reversed. User notified.',
        'Resolved after successfully challenging chargeback. Merchant protected.',
    ]) : undefined;

    const sourceRule = Math.random() > 0.5 ? getRandomItem(rules) : undefined;

    return {
        id: id,
        caseId: id,
        timestamp: timestamp,
        description: description,
        amount: amount,
        riskScore: riskScore,
        status: status,
        analystId: caseAnalyst.id,
        analystName: caseAnalyst.name,
        priority: priority,
        fraudType: fraudType,
        transactionDetails: transactionDetails,
        userProfile: userProfile,
        deviceFingerprint: deviceFingerprint,
        riskFactors: riskFactors,
        comments: comments,
        attachments: attachments,
        auditLog: auditLog,
        recommendedAction: riskScore > 80 ? 'Escalate to Senior Analyst for deeper investigation' : riskScore > 60 ? 'Review associated transactions and user activity' : 'Monitor account for further suspicious patterns',
        resolutionNotes: resolutionNotes,
        resolutionDate: resolutionDate,
        relatedCases: Array.from({ length: getRandom(0, 1) }).map(() => `CASE-${generateId().substring(0, 8).toUpperCase()}`),
        decisionHistory: auditLog
            .filter(log => log.action === 'Status Changed')
            .map(log => ({
                decidedBy: log.analystName,
                decidedAt: log.timestamp,
                decision: log.details.to === 'Investigating' ? 'Investigate' : log.details.to === 'Resolved' ? 'Resolve' : log.details.to === 'Dismissed' ? 'Dismiss' : 'Approve', // Add 'Approve' for initial acceptance
                reason: `Status changed from ${log.details.from} to ${log.details.to}`,
            })),
        lastUpdatedBy: caseAnalyst.name,
        lastUpdatedAt: new Date().toISOString(),
        sourceRuleId: sourceRule?.id,
        modelPredictionConfidence: parseFloat((Math.random() * (0.99 - 0.5) + 0.5).toFixed(2)), // 50-99% confidence
    };
};

/**
 * Generates mock analysts.
 */
export const generateMockAnalysts = (num: number): Analyst[] => {
    const roles: Analyst['role'][] = ['Junior Analyst', 'Senior Analyst', 'Lead Investigator', 'Admin'];
    const names = [
        'Alice Johnson', 'Bob Smith', 'Charlie Brown', 'Diana Prince', 'Eve Adams',
        'Frank White', 'Grace Hoppe', 'Harry Potter', 'Ivy Green', 'Jack Black',
        'Karen Miller', 'Liam Nelson', 'Mia Wilson', 'Noah Davis', 'Olivia Taylor'
    ];
    const teamNames = ['Blue Team', 'Red Team', 'Green Team', 'Yellow Team'];
    return Array.from({ length: num }).map((_, i) => ({
        id: `ANL-${i + 1}`,
        name: names[i % names.length],
        role: getRandomItem(roles),
        email: `analyst${i + 1}@megacorp.com`,
        assignedCases: [], // Filled dynamically if needed
        active: true,
        photoUrl: `https://i.pravatar.cc/150?img=${getRandom(1, 70)}`, // Mock avatar
        lastLogin: getRandomDate(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), new Date()),
        teamId: `TEAM-${getRandom(1, 4)}`,
        teamName: getRandomItem(teamNames),
    }));
};

/**
 * Generates mock fraud rules.
 */
export const generateMockFraudRules = (num: number, analysts: Analyst[]): FraudRule[] => {
    const conditions = [
        "transaction.amount > 5000 && transaction.ip.country != user.country",
        "user.accountAge < 7 days && transaction.count > 3 in 24h",
        "device.fingerprint.new && user.loginAttemptsFailed > 5",
        "paymentMethod == 'Bitcoin' && transaction.amount > 1000",
        "riskScore > 90",
        "user.reputationScore < 400 && user.kycStatus == 'Unverified'",
        "shippingAddress != billingAddress && transaction.geolocation.distance > 500km",
        "multiple credit cards used within 1 hour across different geographical locations",
        "chargeback rate for merchant exceeds 5%",
        "sequential transactions of identical amounts in short intervals",
        "transaction.productCategory == 'Gift Cards' && transaction.amount > 500",
        "user.lastLoginDate < 90 days ago && new_device_detected",
        "geolocation.city changed by > 500km in 10 minutes",
        "billingAddress.zipCode mismatch with card issuer region",
        "transaction.currency mismatch with user.country currency and large amount"
    ];
    const actions = ['Flag', 'Deny', 'Review', 'Escalate'];
    const severities = ['Low', 'Medium', 'High', 'Critical'];
    const statuses = ['Active', 'Inactive', 'Draft'];
    const tags = ['High-Value', 'IP-Risk', 'New-User', 'Card-Fraud', 'Account-Takeover', 'Geo-Anomaly'];
    const createdByAnalysts = analysts.map(a => a.name);

    return Array.from({ length: num }).map((_, i) => {
        const creator = getRandomItem(createdByAnalysts);
        const createdAt = getRandomDate(new Date(2022, 0, 1), new Date());
        const lastUpdatedBy = Math.random() > 0.3 ? getRandomItem(createdByAnalysts) : creator;
        const lastUpdatedAt = Math.random() > 0.3 ? getRandomDate(new Date(createdAt), new Date()) : createdAt;

        return {
            id: `RULE-${generateId().substring(0, 8).toUpperCase()}`,
            name: `Rule ${i + 1}: ${getRandomItem(['High Risk IP Geo', 'New Account Velocity', 'Suspicious Payment Method', 'High Risk Score Threshold', 'KYC & Reputation Check', 'Gift Card Abuse Detector'])}`,
            description: getRandomItem(conditions),
            status: getRandomItem(statuses),
            severity: getRandomItem(severities),
            condition: getRandomItem(conditions),
            action: getRandomItem(actions),
            createdBy: creator,
            createdAt: createdAt,
            lastUpdatedBy: lastUpdatedBy,
            lastUpdatedAt: lastUpdatedAt,
            hitCount: getRandom(10, 15000),
            falsePositiveRate: parseFloat((Math.random() * 0.1).toFixed(3)), // 0-10%
            falseNegativeRate: parseFloat((Math.random() * 0.05).toFixed(3)), // 0-5%
            priorityOrder: getRandom(1, 100),
            tags: Array.from({ length: getRandom(1, 3) }).map(() => getRandomItem(tags))
        };
    });
};

/**
 * Generates mock alert notifications.
 */
export const generateMockAlerts = (num: number, caseIds: string[]): AlertNotification[] => {
    const types = ['System', 'Rule Trigger', 'Manual', 'Anomaly'];
    const severities = ['Info', 'Warning', 'Critical'];
    const messages = [
        'New high-risk case detected. Risk score: 92.',
        'Rule "High Value International Transfer" triggered for TXN-12345.',
        'System anomaly detected in payment gateway transactions volume.',
        'Unusual login activity detected on multiple accounts from same IP range.',
        'Case status updated to "Investigating" by Alice Johnson.',
        'Attachment "proof_of_id.pdf" added to case by Bob Smith.',
        'High velocity of transactions from a new device fingerprint detected.',
        'Payment method changed on account USR-7890 after suspicious login attempt.',
        'Potential synthetic identity detected with multiple matching parameters.',
    ];
    const categories = ['Transaction', 'Login', 'Account', 'System'];

    return Array.from({ length: num }).map(() => ({
        id: generateId(),
        caseId: Math.random() > 0.3 ? getRandomItem(caseIds) : undefined,
        type: getRandomItem(types),
        message: getRandomItem(messages),
        severity: getRandomItem(severities),
        timestamp: getRandomDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), new Date()),
        read: Math.random() > 0.5,
        actionTaken: Math.random() > 0.7 ? 'Reviewed' : undefined,
        category: getRandomItem(categories)
    }));
};

/**
 * Generates mock fraud trend data.
 */
export const generateMockFraudTrendData = (days: number): FraudTrendData[] => {
    const data: FraudTrendData[] = [];
    let currentDate = new Date();
    currentDate.setDate(currentDate.getDate() - days);

    for (let i = 0; i <= days; i++) {
        const date = new Date(currentDate);
        date.setDate(currentDate.getDate() + i);
        data.push({
            date: date.toISOString().split('T')[0],
            newCases: getRandom(10, 50),
            resolvedCases: getRandom(5, 40),
            amountFlagged: getRandom(5000, 50000),
            averageRiskScore: parseFloat(getRandom(60, 95).toFixed(2)),
            falsePositives: getRandom(1, 10)
        });
    }
    return data;
};

/**
 * Generates mock geographical fraud data.
 */
export const generateMockGeoFraudData = (): GeoFraudData[] => {
    return MOCK_CITIES.map(city => ({
        country: city.country,
        cases: getRandom(50, 500),
        amount: getRandom(10000, 500000),
        riskScore: parseFloat(getRandom(70, 90).toFixed(2)),
        coordinates: { latitude: city.lat, longitude: city.lon }
    }));
};

/**
 * Generates mock report definitions.
 */
export const generateMockReportDefinitions = (analysts: Analyst[]): ReportDefinition[] => {
    const analystNames = analysts.map(a => a.name);
    return [
        {
            id: 'RPT-001',
            name: 'Monthly Fraud Summary',
            description: 'Overview of fraud activities for the last month, including new cases, resolved cases, and total amount at risk.',
            type: 'summary',
            params: { timeframe: 'Last 30 days', severity: ['High', 'Critical'] },
            lastGenerated: getRandomDate(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), new Date()),
            generatedBy: getRandomItem(analystNames),
            status: 'Generated',
            downloadLink: 'https://mockcdn.com/reports/monthly_summary.pdf',
        },
        {
            id: 'RPT-002',
            name: 'Quarterly Fraud Trends',
            description: 'Long-term trends of new cases, resolved cases, and average risk scores over the last quarter.',
            type: 'trend',
            params: { timeframe: 'Last 90 days' },
            lastGenerated: getRandomDate(new Date(Date.now() - 90 * 24 * 60 * 60 * 1000), new Date(Date.now() - 60 * 24 * 60 * 60 * 1000)),
            generatedBy: getRandomItem(analystNames),
            status: 'Generated',
            downloadLink: 'https://mockcdn.com/reports/quarterly_trends.pdf',
        },
        {
            id: 'RPT-003',
            name: 'Geographic Fraud Hotspots',
            description: 'Identification of top countries by fraud volume and amount, with average risk scores.',
            type: 'geographic',
            params: { topN: 10 },
            lastGenerated: getRandomDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), new Date()),
            generatedBy: getRandomItem(analystNames),
            status: 'Generated',
            downloadLink: 'https://mockcdn.com/reports/geo_hotspots.pdf',
        },
        {
            id: 'RPT-004',
            name: 'High-Risk Transaction Breakdown',
            description: 'Detailed analysis of individual transactions with risk scores above a certain threshold.',
            type: 'custom',
            params: { minRiskScore: 80, limit: 100, fraudType: 'Account Takeover' },
            lastGenerated: getRandomDate(new Date(Date.now() - 14 * 24 * 60 * 60 * 1000), new Date()),
            generatedBy: getRandomItem(analystNames),
            status: 'Generated',
            downloadLink: 'https://mockcdn.com/reports/high_risk_txns.pdf',
        },
        {
            id: 'RPT-005',
            name: 'Rule Performance Metrics',
            description: 'Evaluation of fraud detection rules including hit count, false positive, and false negative rates.',
            type: 'performance',
            params: { timeframe: 'Last 30 days', ruleStatus: 'Active' },
            lastGenerated: getRandomDate(new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), new Date()),
            generatedBy: getRandomItem(analystNames),
            status: 'Generated',
            downloadLink: 'https://mockcdn.com/reports/rule_performance.pdf',
        }
    ];
};

// --- MOCK DATA GENERATION (approx. 500-1000 lines for a good set) ---
// Generate a large set of mock data to simulate a real-world application.
// This data will be used throughout the expanded view.

const MOCK_ANALYSTS: Analyst[] = generateMockAnalysts(15);
const MOCK_FRAUD_RULES: FraudRule[] = generateMockFraudRules(70, MOCK_ANALYSTS);
const MOCK_EXTENDED_FRAUD_CASES: ExtendedFraudCase[] = Array.from({ length: 1200 }).map((_, i) => generateMockExtendedFraudCase(i, MOCK_ANALYSTS, MOCK_FRAUD_RULES));
const MOCK_ALERT_NOTIFICATIONS: AlertNotification[] = generateMockAlerts(250, MOCK_EXTENDED_FRAUD_CASES.map(c => c.id));
const MOCK_FRAUD_TREND_DATA: FraudTrendData[] = generateMockFraudTrendData(180); // Last 180 days
const MOCK_GEO_FRAUD_DATA: GeoFraudData[] = generateMockGeoFraudData();
const MOCK_REPORT_DEFINITIONS: ReportDefinition[] = generateMockReportDefinitions(MOCK_ANALYSTS);


// --- CONTEXT EXTENSION (conceptual for this file) ---
// In a real app, DataContext would be updated. Here, we'll simulate the richer data.
// We assume context.fraudCases actually contains ExtendedFraudCase data.
interface DataContextExtension {
    fraudCases: ExtendedFraudCase[];
    updateFraudCaseStatus: (id: string, status: FraudCase['status']) => void;
    // New functions to update extended data
    updateFraudCaseDetails: (id: string, updates: Partial<ExtendedFraudCase>) => void;
    addFraudCaseComment: (caseId: string, comment: Comment) => void;
    addFraudCaseAttachment: (caseId: string, attachment: Attachment) => void;
    updateFraudRule: (id: string, updates: Partial<FraudRule>) => void;
    addFraudRule: (rule: FraudRule) => void;
    deleteFraudRule: (id: string) => void;
    markAlertAsRead: (alertId: string) => void;
    deleteAlert: (alertId: string) => void;
    updateReportDefinition: (id: string, updates: Partial<ReportDefinition>) => void;
    addReportDefinition: (report: ReportDefinition) => void;
    deleteReportDefinition: (id: string) => void;
}

// Mock implementation of extended context functions
const useExtendedDataContext = (): DataContextExtension => {
    const baseContext = useContext(DataContext);
    if (!baseContext) throw new Error("FraudDetectionView must be within a DataProvider");

    // We're casting and enhancing the fraudCases provided by the base context.
    // In a real scenario, DataContext itself would provide the ExtendedFraudCase type.
    const [localFraudCases, setLocalFraudCases] = useState<ExtendedFraudCase[]>(MOCK_EXTENDED_FRAUD_CASES);
    const [localFraudRules, setLocalFraudRules] = useState<FraudRule[]>(MOCK_FRAUD_RULES);
    const [localAlerts, setLocalAlerts] = useState<AlertNotification[]>(MOCK_ALERT_NOTIFICATIONS);
    const [localReportDefinitions, setLocalReportDefinitions] = useState<ReportDefinition[]>(MOCK_REPORT_DEFINITIONS);


    const updateFraudCaseStatus = useCallback((id: string, status: FraudCase['status']) => {
        setLocalFraudCases(prevCases => prevCases.map(c => c.id === id ? { ...c, status, lastUpdatedAt: new Date().toISOString(), lastUpdatedBy: MOCK_ANALYSTS[0].name } : c));
        // Simulate adding to audit log
        const caseToUpdate = localFraudCases.find(c => c.id === id);
        if (caseToUpdate) {
            const analyst = MOCK_ANALYSTS[0]; // Assume first analyst for mock actions
            const newAuditLogEntry: AuditLogEntry = {
                id: generateId(),
                timestamp: new Date().toISOString(),
                action: 'Status Changed',
                analystId: analyst.id,
                analystName: analyst.name,
                details: { from: caseToUpdate.status, to: status },
            };
            setLocalFraudCases(prevCases => prevCases.map(c =>
                c.id === id ? { ...c, auditLog: [...c.auditLog, newAuditLogEntry] } : c
            ));
        }
    }, [localFraudCases]);

    const updateFraudCaseDetails = useCallback((id: string, updates: Partial<ExtendedFraudCase>) => {
        setLocalFraudCases(prevCases => prevCases.map(c => c.id === id ? { ...c, ...updates, lastUpdatedAt: new Date().toISOString(), lastUpdatedBy: MOCK_ANALYSTS[0].name } : c));
        const caseToUpdate = localFraudCases.find(c => c.id === id);
        if (caseToUpdate) {
            const analyst = MOCK_ANALYSTS[0];
            const newAuditLogEntry: AuditLogEntry = {
                id: generateId(),
                timestamp: new Date().toISOString(),
                action: 'Case Details Updated',
                analystId: analyst.id,
                analystName: analyst.name,
                details: { updatedFields: Object.keys(updates) },
            };
            setLocalFraudCases(prevCases => prevCases.map(c =>
                c.id === id ? { ...c, auditLog: [...c.auditLog, newAuditLogEntry] } : c
            ));
        }
    }, [localFraudCases]);

    const addFraudCaseComment = useCallback((caseId: string, comment: Comment) => {
        setLocalFraudCases(prevCases => prevCases.map(c =>
            c.id === caseId ? { ...c, comments: [...c.comments, comment], lastUpdatedAt: new Date().toISOString(), lastUpdatedBy: MOCK_ANALYSTS[0].name } : c
        ));
        const analyst = MOCK_ANALYSTS.find(a => a.id === comment.analystId) || MOCK_ANALYSTS[0];
        const newAuditLogEntry: AuditLogEntry = {
            id: generateId(),
            timestamp: new Date().toISOString(),
            action: 'Comment Added',
            analystId: analyst.id,
            analystName: analyst.name,
            details: { commentId: comment.id, contentPreview: comment.content.substring(0, 50) + '...' },
        };
        setLocalFraudCases(prevCases => prevCases.map(c =>
            c.id === caseId ? { ...c, auditLog: [...c.auditLog, newAuditLogEntry] } : c
        ));
    }, []);

    const addFraudCaseAttachment = useCallback((caseId: string, attachment: Attachment) => {
        setLocalFraudCases(prevCases => prevCases.map(c =>
            c.id === caseId ? { ...c, attachments: [...c.attachments, attachment], lastUpdatedAt: new Date().toISOString(), lastUpdatedBy: MOCK_ANALYSTS[0].name } : c
        ));
        const analyst = MOCK_ANALYSTS.find(a => a.name === attachment.uploadedBy) || MOCK_ANALYSTS[0];
        const newAuditLogEntry: AuditLogEntry = {
            id: generateId(),
            timestamp: new Date().toISOString(),
            action: 'Attachment Added',
            analystId: analyst.id,
            analystName: analyst.name,
            details: { filename: attachment.filename, fileType: attachment.fileType },
        };
        setLocalFraudCases(prevCases => prevCases.map(c =>
            c.id === caseId ? { ...c, auditLog: [...c.auditLog, newAuditLogEntry] } : c
        ));
    }, []);

    const updateFraudRule = useCallback((id: string, updates: Partial<FraudRule>) => {
        setLocalFraudRules(prevRules => prevRules.map(r => r.id === id ? { ...r, ...updates, lastUpdatedAt: new Date().toISOString(), lastUpdatedBy: MOCK_ANALYSTS[0].name } : r));
    }, []);

    const addFraudRule = useCallback((rule: FraudRule) => {
        setLocalFraudRules(prevRules => [...prevRules, { ...rule, id: `RULE-${generateId().substring(0, 8).toUpperCase()}`, createdAt: new Date().toISOString(), createdBy: MOCK_ANALYSTS[0].name, lastUpdatedAt: new Date().toISOString(), lastUpdatedBy: MOCK_ANALYSTS[0].name, hitCount: 0 }]);
    }, []);

    const deleteFraudRule = useCallback((id: string) => {
        setLocalFraudRules(prevRules => prevRules.filter(r => r.id !== id));
    }, []);

    const markAlertAsRead = useCallback((alertId: string) => {
        setLocalAlerts(prevAlerts => prevAlerts.map(a => a.id === alertId ? { ...a, read: true } : a));
    }, []);

    const deleteAlert = useCallback((alertId: string) => {
        setLocalAlerts(prevAlerts => prevAlerts.filter(a => a.id !== alertId));
    }, []);

    const updateReportDefinition = useCallback((id: string, updates: Partial<ReportDefinition>) => {
        setLocalReportDefinitions(prevReports => prevReports.map(r => r.id === id ? { ...r, ...updates } : r));
    }, []);

    const addReportDefinition = useCallback((report: ReportDefinition) => {
        setLocalReportDefinitions(prevReports => [...prevReports, { ...report, id: `RPT-${generateId().substring(0, 8).toUpperCase()}`, generatedBy: MOCK_ANALYSTS[0].name, lastGenerated: new Date().toISOString(), status: 'Generated' }]);
    }, []);

    const deleteReportDefinition = useCallback((id: string) => {
        setLocalReportDefinitions(prevReports => prevReports.filter(r => r.id !== id));
    }, []);

    useEffect(() => {
        // This effect makes sure that if the original DataContext's fraudCases were to change,
        // our local state would update. For this exercise, it will just initialize.
        if (baseContext.fraudCases.length === 0) {
            // This branch is unlikely to be hit if DataContext itself has mock data.
            // We'll rely on localFraudCases as the primary source for this heavily extended view.
        }
    }, [baseContext.fraudCases]);


    return {
        fraudCases: localFraudCases,
        updateFraudCaseStatus,
        updateFraudCaseDetails,
        addFraudCaseComment,
        addFraudCaseAttachment,
        updateFraudRule,
        addFraudRule,
        deleteFraudRule,
        markAlertAsRead,
        deleteAlert,
        updateReportDefinition,
        addReportDefinition,
        deleteReportDefinition,
    };
};

// --- REUSABLE UI COMPONENTS (approx. 100-200 lines each, many components) ---

/**
 * @typedef {Object} StatusBadgeProps
 * @property {FraudCase['status']} status - The status of the fraud case.
 */
export const StatusBadge: React.FC<{ status: FraudCase['status'] }> = ({ status }) => {
    const colors = {
        'New': 'bg-red-500/20 text-red-300',
        'Investigating': 'bg-yellow-500/20 text-yellow-300',
        'Resolved': 'bg-green-500/20 text-green-300',
        'Dismissed': 'bg-gray-500/20 text-gray-300',
    };
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[status]}`}>{status}</span>;
};

/**
 * @typedef {Object} PriorityBadgeProps
 * @property {ExtendedFraudCase['priority']} priority - The priority of the fraud case.
 */
export const PriorityBadge: React.FC<{ priority: ExtendedFraudCase['priority'] }> = ({ priority }) => {
    const colors = {
        'Low': 'bg-green-600/20 text-green-400',
        'Medium': 'bg-blue-600/20 text-blue-400',
        'High': 'bg-orange-600/20 text-orange-400',
        'Critical': 'bg-red-600/20 text-red-400',
    };
    return <span className={`px-2 py-1 text-xs font-medium rounded-full ${colors[priority]}`}>{priority}</span>;
};

/**
 * @typedef {Object} LoadingSpinnerProps
 * @property {string} [message='Loading...'] - Message to display while loading.
 */
export const LoadingSpinner: React.FC<{ message?: string }> = ({ message = 'Loading...' }) => (
    <div className="flex items-center justify-center p-4">
        <svg className="animate-spin h-5 w-5 mr-3 text-cyan-400" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span className="text-gray-400">{message}</span>
    </div>
);

/**
 * @typedef {Object} ErrorMessageProps
 * @property {string} message - The error message to display.
 */
export const ErrorMessage: React.FC<{ message: string }> = ({ message }) => (
    <div className="bg-red-900/30 text-red-300 p-4 rounded border border-red-800 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
        </svg>
        <span>Error: {message}</span>
    </div>
);

/**
 * A tab navigation component.
 * @typedef {Object} TabsProps
 * @property {string[]} tabs - Array of tab titles.
 * @property {string} activeTab - The currently active tab title.
 * @property {(tab: string) => void} onTabChange - Callback when a tab is clicked.
 */
export const Tabs: React.FC<{ tabs: string[]; activeTab: string; onTabChange: (tab: string) => void }> = ({ tabs, activeTab, onTabChange }) => (
    <div className="flex border-b border-gray-700 mb-4 -mx-4 px-4">
        {tabs.map(tab => (
            <button
                key={tab}
                className={`py-2 px-4 -mb-px border-b-2 text-sm font-medium focus:outline-none transition duration-150 ease-in-out ${
                    activeTab === tab
                        ? 'border-cyan-500 text-cyan-400'
                        : 'border-transparent text-gray-500 hover:text-gray-200 hover:border-gray-500'
                }`}
                onClick={() => onTabChange(tab)}
            >
                {tab}
            </button>
        ))}
    </div>
);


// --- NEW COMPONENT: CASE DETAILS MODAL (approx. 500-1000 lines, very detailed) ---
/**
 * FraudCaseDetailModalProps interface defines the props for the FraudCaseDetailModal component.
 * @typedef {Object} FraudCaseDetailModalProps
 * @property {ExtendedFraudCase} fraudCase - The fraud case to display details for.
 * @property {() => void} onClose - Callback function to close the modal.
 * @property {(id: string, status: FraudCase['status']) => void} onUpdateStatus - Callback to update case status.
 * @property {(id: string, updates: Partial<ExtendedFraudCase>) => void} onUpdateDetails - Callback to update case details.
 * @property {(caseId: string, comment: Comment) => void} onAddComment - Callback to add a new comment.
 * @property {(caseId: string, attachment: Attachment) => void} onAddAttachment - Callback to add a new attachment.
 * @property {string} aiSummary - The AI generated summary for the case.
 * @property {boolean} isSummaryLoading - Loading state for AI summary.
 * @property {(fraudCase: FraudCase) => Promise<void>} getAiSummary - Function to fetch AI summary.
 * @property {Analyst[]} analysts - List of available analysts for assignment.
 * @property {(caseItem: ExtendedFraudCase) => void} onOpenRelatedCase - Callback to open a related case in the modal.
 */
interface FraudCaseDetailModalProps {
    fraudCase: ExtendedFraudCase;
    onClose: () => void;
    onUpdateStatus: (id: string, status: FraudCase['status']) => void;
    onUpdateDetails: (id: string, updates: Partial<ExtendedFraudCase>) => void;
    onAddComment: (caseId: string, comment: Comment) => void;
    onAddAttachment: (caseId: string, attachment: Attachment) => void;
    aiSummary: string;
    isSummaryLoading: boolean;
    getAiSummary: (fraudCase: FraudCase) => Promise<void>;
    analysts: Analyst[];
    onOpenRelatedCase: (caseItem: ExtendedFraudCase) => void; // Added for opening related cases
}

export const FraudCaseDetailModal: React.FC<FraudCaseDetailModalProps> = ({
    fraudCase,
    onClose,
    onUpdateStatus,
    onUpdateDetails,
    onAddComment,
    onAddAttachment,
    aiSummary,
    isSummaryLoading,
    getAiSummary,
    analysts,
    onOpenRelatedCase,
}) => {
    const [activeTab, setActiveTab] = useState('Overview');
    const [newCommentText, setNewCommentText] = useState('');
    const [newAttachmentFile, setNewAttachmentFile] = useState<File | null>(null);
    const [isUploadingAttachment, setIsUploadingAttachment] = useState(false);
    const [isUpdatingCase, setIsUpdatingCase] = useState(false);
    const [selectedAnalystId, setSelectedAnalystId] = useState(fraudCase.analystId || '');

    // Current user for mock actions (assume first analyst is logged in)
    const currentUser = MOCK_ANALYSTS[0];

    useEffect(() => {
        // Automatically fetch AI summary when case changes
        getAiSummary(fraudCase);
        setSelectedAnalystId(fraudCase.analystId || ''); // Reset analyst selection
        setActiveTab('Overview'); // Reset tab when case changes
    }, [fraudCase, getAiSummary]);

    const handleStatusUpdate = async (status: FraudCase['status']) => {
        setIsUpdatingCase(true);
        try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 500));
            onUpdateStatus(fraudCase.id, status);
            // Optionally, add a decision history entry
            onUpdateDetails(fraudCase.id, {
                decisionHistory: [
                    ...(fraudCase.decisionHistory || []),
                    {
                        decidedBy: currentUser.name,
                        decidedAt: new Date().toISOString(),
                        decision: status === 'Investigating' ? 'Investigate' : status === 'Resolved' ? 'Resolve' : 'Dismiss',
                        reason: `Status manually changed to ${status}`,
                    }
                ]
            });
        } finally {
            setIsUpdatingCase(false);
        }
    };

    const handleAddComment = async () => {
        if (!newCommentText.trim()) return;
        const newComment: Comment = {
            id: generateId(),
            analystId: currentUser.id,
            analystName: currentUser.name,
            timestamp: new Date().toISOString(),
            content: newCommentText.trim(),
        };
        setIsUpdatingCase(true);
        try {
            await new Promise(resolve => setTimeout(resolve, 300)); // Simulate API call
            onAddComment(fraudCase.id, newComment);
            setNewCommentText('');
        } finally {
            setIsUpdatingCase(false);
        }
    };

    const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
        if (event.target.files && event.target.files[0]) {
            setNewAttachmentFile(event.target.files[0]);
        }
    };

    const handleUploadAttachment = async () => {
        if (!newAttachmentFile) return;

        setIsUploadingAttachment(true);
        try {
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate file upload
            const newAttachment: Attachment = {
                id: generateId(),
                filename: newAttachmentFile.name,
                fileType: newAttachmentFile.type,
                url: `https://mock-cdn.com/${generateId()}/${newAttachmentFile.name}`,
                uploadedBy: currentUser.name,
                uploadedAt: new Date().toISOString(),
            };
            onAddAttachment(fraudCase.id, newAttachment);
            setNewAttachmentFile(null);
        } finally {
            setIsUploadingAttachment(false);
        }
    };

    const handleAnalystAssignment = async () => {
        if (selectedAnalystId === fraudCase.analystId) return; // No change
        const assignedAnalyst = analysts.find(a => a.id === selectedAnalystId);
        if (assignedAnalyst) {
            setIsUpdatingCase(true);
            try {
                await new Promise(resolve => setTimeout(resolve, 500));
                onUpdateDetails(fraudCase.id, {
                    analystId: assignedAnalyst.id,
                    analystName: assignedAnalyst.name,
                });
            } finally {
                setIsUpdatingCase(false);
            }
        }
    };

    const OverviewTab: React.FC = () => (
        <div className="space-y-4">
            <h4 className="text-lg font-semibold text-white mb-2">Case Summary</h4>
            <div className="grid grid-cols-2 gap-4 text-sm">
                <div><span className="text-gray-400">Case ID:</span> <span className="text-white">{fraudCase.caseId}</span></div>
                <div><span className="text-gray-400">Timestamp:</span> <span className="text-white">{formatDate(fraudCase.timestamp)}</span></div>
                <div><span className="text-gray-400">Amount:</span> <span className="text-white">{formatCurrency(fraudCase.amount)}</span></div>
                <div><span className="text-gray-400">Risk Score:</span> <span className={`font-mono ${getRiskScoreColor(fraudCase.riskScore)}`}>{fraudCase.riskScore}</span></div>
                <div><span className="text-gray-400">Status:</span> <StatusBadge status={fraudCase.status} /></div>
                <div><span className="text-gray-400">Priority:</span> <PriorityBadge priority={fraudCase.priority} /></div>
                <div><span className="text-gray-400">Fraud Type:</span> <span className="text-white">{fraudCase.fraudType}</span></div>
                <div><span className="text-gray-400">Model Confidence:</span> <span className="text-white">{fraudCase.modelPredictionConfidence ? `${(fraudCase.modelPredictionConfidence * 100).toFixed(1)}%` : 'N/A'}</span></div>
                <div><span className="text-gray-400">Last Updated:</span> <span className="text-white">{fraudCase.lastUpdatedAt ? formatDate(fraudCase.lastUpdatedAt) : 'N/A'} by {fraudCase.lastUpdatedBy || 'System'}</span></div>
                <div><span className="text-gray-400">Assigned Analyst:</span>
                    <select
                        className="bg-gray-700 border border-gray-600 text-white text-xs rounded-lg p-1 ml-2 focus:ring-cyan-500 focus:border-cyan-500"
                        value={selectedAnalystId}
                        onChange={(e) => setSelectedAnalystId(e.target.value)}
                        onBlur={handleAnalystAssignment} // Save on blur
                        disabled={isUpdatingCase}
                    >
                        <option value="">Unassigned</option>
                        {analysts.map(analyst => (
                            <option key={analyst.id} value={analyst.id}>{analyst.name} ({analyst.role})</option>
                        ))}
                    </select>
                    {isUpdatingCase && <span className="text-cyan-400 ml-2">Updating...</span>}
                </div>
            </div>
            <p className="text-gray-300 mt-4">{fraudCase.description}</p>

            <Card title="AI Summary & Recommended Actions" className="mt-4">
                {isSummaryLoading ? <LoadingSpinner message="Generating AI summary..." /> : (
                    <>
                        <p className="text-sm text-gray-300 whitespace-pre-line mb-2">{aiSummary || "No AI summary available."}</p>
                        {fraudCase.recommendedAction && (
                            <div className="text-sm text-cyan-300 mt-2 p-2 bg-gray-900 rounded-md border border-gray-700">
                                <strong>AI Recommendation:</strong> {fraudCase.recommendedAction}
                            </div>
                        )}
                    </>
                )}
            </Card>

            <h4 className="text-lg font-semibold text-white mt-6 mb-2">Key Risk Factors Breakdown</h4>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm text-gray-300">
                {Object.entries(fraudCase.riskFactors).map(([key, value]) => (
                    <div key={key} className="flex items-center">
                        <span className="font-medium mr-2">{capitalize(key.replace(/([A-Z])/g, ' $1'))}:</span>
                        <span className={`${getRiskScoreColor(value)} font-mono`}>{value}</span>
                    </div>
                ))}
            </div>

            {fraudCase.resolutionNotes && (
                <Card title="Resolution Details" className="mt-4 bg-green-900/10 border-green-800">
                    <p className="text-sm text-green-300">{fraudCase.resolutionNotes}</p>
                    <p className="text-xs text-green-500 mt-2">Resolved on: {formatDate(fraudCase.resolutionDate!)} by {fraudCase.decisionHistory?.[0]?.decidedBy || 'System'}</p>
                </Card>
            )}

            <h4 className="text-lg font-semibold text-white mt-6 mb-2">Case Actions</h4>
            <div className="flex gap-2 flex-wrap">
                <button onClick={() => handleStatusUpdate('Investigating')} disabled={isUpdatingCase || fraudCase.status === 'Investigating'} className="text-sm px-3 py-1 bg-yellow-600/50 hover:bg-yellow-600 rounded disabled:opacity-50">
                    {isUpdatingCase && fraudCase.status === 'Investigating' ? 'Updating...' : 'Set Investigating'}
                </button>
                <button onClick={() => handleStatusUpdate('Resolved')} disabled={isUpdatingCase || fraudCase.status === 'Resolved'} className="text-sm px-3 py-1 bg-green-600/50 hover:bg-green-600 rounded disabled:opacity-50">
                    {isUpdatingCase && fraudCase.status === 'Resolved' ? 'Updating...' : 'Mark Resolved'}
                </button>
                <button onClick={() => handleStatusUpdate('Dismissed')} disabled={isUpdatingCase || fraudCase.status === 'Dismissed'} className="text-sm px-3 py-1 bg-gray-600/50 hover:bg-gray-600 rounded disabled:opacity-50">
                    {isUpdatingCase && fraudCase.status === 'Dismissed' ? 'Updating...' : 'Dismiss Case'}
                </button>
                <button onClick={() => onUpdateDetails(fraudCase.id, { priority: getRandomItem(['Low', 'Medium', 'High', 'Critical']) })} className="text-sm px-3 py-1 bg-purple-600/50 hover:bg-purple-600 rounded">
                    Random Priority
                </button>
            </div>
            {fraudCase.relatedCases && fraudCase.relatedCases.length > 0 && (
                <div className="mt-4">
                    <h4 className="text-lg font-semibold text-white mb-2">Related Cases</h4>
                    <div className="flex flex-wrap gap-2">
                        {fraudCase.relatedCases.map(relatedCaseId => (
                            <button
                                key={relatedCaseId}
                                onClick={() => {
                                    const relatedCase = MOCK_EXTENDED_FRAUD_CASES.find(c => c.id === relatedCaseId);
                                    if (relatedCase) onOpenRelatedCase(relatedCase);
                                }}
                                className="text-sm px-3 py-1 bg-blue-600/50 hover:bg-blue-600 rounded text-white"
                            >
                                {relatedCaseId}
                            </button>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );

    const TransactionsTab: React.FC = () => (
        <div className="space-y-4">
            <h4 className="text-lg font-semibold text-white mb-2">Associated Transactions ({fraudCase.transactionDetails.length})</h4>
            {fraudCase.transactionDetails.length === 0 ? (
                <p className="text-gray-500">No associated transactions found.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full text-sm text-left text-gray-400">
                        <thead className="text-xs text-gray-300 uppercase bg-gray-900/30">
                            <tr>
                                <th scope="col" className="px-4 py-2">ID</th>
                                <th scope="col" className="px-4 py-2">Amount</th>
                                <th scope="col" className="px-4 py-2">Merchant</th>
                                <th scope="col" className="px-4 py-2">Method</th>
                                <th scope="col" className="px-4 py-2">Risk</th>
                                <th scope="col" className="px-4 py-2">IP</th>
                                <th scope="col" className="px-4 py-2">Geo</th>
                                <th scope="col" className="px-4 py-2">Status</th>
                                <th scope="col" className="px-4 py-2">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            {fraudCase.transactionDetails.map((tx, idx) => (
                                <tr key={tx.transactionId} className="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td className="px-4 py-2 font-medium text-white">{tx.transactionId}</td>
                                    <td className="px-4 py-2 font-mono">{formatCurrency(tx.amount, tx.currency)}</td>
                                    <td className="px-4 py-2">{tx.merchantName}</td>
                                    <td className="px-4 py-2">{tx.paymentMethod}</td>
                                    <td className={`px-4 py-2 font-mono ${getRiskScoreColor(tx.riskScore)}`}>{tx.riskScore}</td>
                                    <td className="px-4 py-2">{tx.ipAddress}</td>
                                    <td className="px-4 py-2">{tx.geolocation.city}, {tx.geolocation.country}</td>
                                    <td className="px-4 py-2"><span className={`px-2 py-1 text-xs font-medium rounded-full ${tx.status === 'Approved' ? 'bg-green-500/20 text-green-300' : tx.status === 'Declined' ? 'bg-red-500/20 text-red-300' : 'bg-yellow-500/20 text-yellow-300'}`}>{tx.status}</span></td>
                                    <td className="px-4 py-2 text-xs">{formatDate(tx.timestamp)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
            <h4 className="text-lg font-semibold

--- FILE: RoleManagementView.tsx ---

import React, { useState, useEffect, useCallback, useMemo, createContext, useContext, useRef } from 'react';
import Card from '../../../Card';
import { Button } from '../../../../components/ui/button';
import { Input } from '../../../../components/ui/input';
import { Checkbox } from '../../../../components/ui/checkbox';
import { Label } from '../../../../components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../../../../components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '../../../../components/ui/table';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '../../../../components/ui/dialog';
import { Textarea } from '../../../../components/ui/textarea';
import { Popover, PopoverContent, PopoverTrigger } from '../../../../components/ui/popover';
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '../../../../components/ui/command';
import { Calendar } from '../../../../components/ui/calendar';
import { CalendarIcon, CheckIcon, ChevronsUpDown, Eye, EyeOff, PlusCircle, Search, Trash2, Edit2, Info, XCircle, AlertCircle, RefreshCcw, Save, Loader2, Link, Unlink } from 'lucide-react';
import { cn } from '../../../../lib/utils';
import { format } from 'date-fns';
import { Toggle } from '../../../../components/ui/toggle';
import { Switch } from '../../../../components/ui/switch';
import { toast } from '../../../../components/ui/use-toast';
import { Separator } from '../../../../components/ui/separator';
import { Slider } from '../../../../components/ui/slider';
import { Progress } from '../../../../components/ui/progress';

// --- Utility Types and Interfaces ---

/**
 * Represents a unique identifier for any entity.
 */
export type EntityId = string;

/**
 * Base interface for audit trail information.
 */
export interface AuditMeta {
    createdAt: string; // ISO string
    updatedAt: string; // ISO string
    createdBy: EntityId;
    updatedBy: EntityId;
    version: number;
}

/**
 * Represents a permission that can be assigned to a role.
 */
export interface Permission {
    id: EntityId;
    name: string;
    description: string;
    resource: string; // e.g., 'accounts', 'transactions', 'users'
    action: string;   // e.g., 'read', 'write', 'delete', 'approve'
    level?: 'global' | 'organizational' | 'departmental' | 'individual'; // Scope of the permission
    tags: string[]; // e.g., ['finance', 'sensitive', 'PII']
    deprecated?: boolean;
    audit: AuditMeta;
}

/**
 * Represents a security role.
 */
export interface Role {
    id: EntityId;
    name: string;
    description: string;
    permissions: EntityId[]; // Array of permission IDs
    users: EntityId[];       // Array of user IDs assigned to this role
    parentRoleId?: EntityId; // For role hierarchy
    isSystemRole: boolean; // Roles created by the system, cannot be deleted
    status: 'active' | 'inactive' | 'pending_review' | 'deprecated';
    reviewDate?: string; // Next scheduled review date
    aiSuggestions?: AISuggestion[]; // AI-driven recommendations
    audit: AuditMeta;
}

/**
 * Represents a user in the system (simplified for role management context).
 */
export interface User {
    id: EntityId;
    username: string;
    email: string;
    firstName: string;
    lastName: string;
    department: string;
    status: 'active' | 'inactive' | 'locked';
    lastLogin: string; // ISO string
    roles: EntityId[]; // Roles assigned to this user
    audit: AuditMeta;
}

/**
 * Represents an AI-driven suggestion related to roles or permissions.
 */
export interface AISuggestion {
    id: EntityId;
    type: 'least_privilege' | 'role_clustering' | 'drift_detection' | 'compliance_violation';
    targetId: EntityId; // Role ID or User ID
    message: string;
    details: Record<string, any>; // JSON object with specific details
    severity: 'low' | 'medium' | 'high' | 'critical';
    status: 'pending' | 'accepted' | 'rejected' | 'dismissed';
    generatedAt: string; // ISO string
    acceptedBy?: EntityId; // User who accepted the suggestion
    acceptedAt?: string; // ISO string
    audit: AuditMeta;
}

/**
 * Represents an audit log entry for security-related actions.
 */
export interface AuditLogEntry {
    id: EntityId;
    timestamp: string; // ISO string
    actorId: EntityId; // User ID performing the action
    action: string; // e.g., 'ROLE_CREATED', 'PERMISSION_UPDATED', 'USER_ROLE_ASSIGNED'
    targetType: 'role' | 'permission' | 'user';
    targetId: EntityId;
    details: Record<string, any>; // Old/New values, context, etc.
    ipAddress?: string;
    userAgent?: string;
}

/**
 * Context for managing global settings and state.
 */
export interface GlobalSecurityContextType {
    isSimulationMode: boolean;
    toggleSimulationMode: () => void;
    // Add other global settings if needed
}

export const GlobalSecurityContext = createContext<GlobalSecurityContextType | undefined>(undefined);

export const useGlobalSecurityContext = () => {
    const context = useContext(GlobalSecurityContext);
    if (!context) {
        throw new Error('useGlobalSecurityContext must be used within a GlobalSecurityProvider');
    }
    return context;
};

// --- Mock Data Service (Replace with actual API calls) ---
// In a real application, these would be API calls to a backend.
// For this extensive example, we'll simulate async behavior.

const MOCK_CURRENT_USER_ID: EntityId = 'user-admin-123';

let mockRoles: Role[] = [
    {
        id: 'role-admin',
        name: 'System Administrator',
        description: 'Grants full administrative access across the platform. Use with extreme caution.',
        permissions: ['perm-all', 'perm-user-mgmt', 'perm-role-mgmt', 'perm-audit-view'],
        users: ['user-admin-123'],
        isSystemRole: true,
        status: 'active',
        audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 }
    },
    {
        id: 'role-finance-manager',
        name: 'Finance Manager',
        description: 'Manages financial transactions, approvals, and reporting.',
        permissions: ['perm-tx-read', 'perm-tx-write', 'perm-tx-approve', 'perm-report-finance'],
        users: ['user-finance-mgr-1'],
        isSystemRole: false,
        status: 'active',
        reviewDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now
        aiSuggestions: [],
        audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 }
    },
    {
        id: 'role-customer-service',
        name: 'Customer Service Agent',
        description: 'Handles customer inquiries and basic account modifications.',
        permissions: ['perm-user-read', 'perm-user-update-basic', 'perm-tx-read'],
        users: ['user-cs-1', 'user-cs-2'],
        isSystemRole: false,
        status: 'active',
        audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 }
    },
    {
        id: 'role-auditor',
        name: 'Security Auditor',
        description: 'Grants read-only access to audit logs and security configurations.',
        permissions: ['perm-audit-view', 'perm-role-read', 'perm-user-read'],
        users: [],
        isSystemRole: true,
        status: 'active',
        audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 }
    },
    {
        id: 'role-developer',
        name: 'Developer',
        description: 'Access for development environments and API usage.',
        permissions: ['perm-api-read', 'perm-api-write'],
        users: ['user-dev-1'],
        isSystemRole: false,
        status: 'pending_review',
        aiSuggestions: [
            {
                id: 'ai-sugg-1',
                type: 'least_privilege',
                targetId: 'role-developer',
                message: 'Consider removing "perm-api-write" if only read access is needed for monitoring.',
                details: { recommendedPermissions: ['perm-api-read'], unnecessaryPermissions: ['perm-api-write'] },
                severity: 'medium',
                status: 'pending',
                generatedAt: new Date().toISOString(),
                audit: { createdAt: new Date().toISOString(), createdBy: 'AI-system', updatedAt: new Date().toISOString(), updatedBy: 'AI-system', version: 1 }
            }
        ],
        audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 }
    }
];

let mockPermissions: Permission[] = [
    { id: 'perm-all', name: 'All Access', description: 'Grants all possible permissions.', resource: '*', action: '*', tags: ['dangerous', 'privileged'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-user-mgmt', name: 'User Management', description: 'Create, update, delete users.', resource: 'users', action: 'manage', tags: ['admin', 'PII'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-role-mgmt', name: 'Role Management', description: 'Create, update, delete roles and assign permissions.', resource: 'roles', action: 'manage', tags: ['admin', 'security'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-audit-view', name: 'View Audit Logs', description: 'Read all audit log entries.', resource: 'audit_logs', action: 'read', tags: ['security', 'compliance'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-tx-read', name: 'Read Transactions', description: 'View all transaction details.', resource: 'transactions', action: 'read', tags: ['finance'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-tx-write', name: 'Write Transactions', description: 'Create or modify transaction details.', resource: 'transactions', action: 'write', tags: ['finance', 'sensitive'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-tx-approve', name: 'Approve Transactions', description: 'Approve pending financial transactions.', resource: 'transactions', action: 'approve', tags: ['finance', 'privileged'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-report-finance', name: 'View Finance Reports', description: 'Access financial reports and analytics.', resource: 'reports_finance', action: 'read', tags: ['finance', 'reporting'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-user-read', name: 'Read User Profiles', description: 'View basic user profile information.', resource: 'users', action: 'read_basic', tags: ['PII'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-user-update-basic', name: 'Update Basic User Info', description: 'Modify non-sensitive user profile data.', resource: 'users', action: 'update_basic', tags: ['PII'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-api-read', name: 'API Read Access', description: 'Read data via API endpoints.', resource: 'api', action: 'read', tags: ['developer', 'technical'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'perm-api-write', name: 'API Write Access', description: 'Write data via API endpoints.', resource: 'api', action: 'write', tags: ['developer', 'technical', 'sensitive'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
];

let mockUsers: User[] = [
    { id: 'user-admin-123', username: 'john.doe', email: 'john.doe@example.com', firstName: 'John', lastName: 'Doe', department: 'IT Security', status: 'active', lastLogin: new Date().toISOString(), roles: ['role-admin'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'user-finance-mgr-1', username: 'jane.smith', email: 'jane.smith@example.com', firstName: 'Jane', lastName: 'Smith', department: 'Finance', status: 'active', lastLogin: new Date().toISOString(), roles: ['role-finance-manager'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'user-cs-1', username: 'peter.jones', email: 'peter.jones@example.com', firstName: 'Peter', lastName: 'Jones', department: 'Customer Service', status: 'active', lastLogin: new Date().toISOString(), roles: ['role-customer-service'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'user-cs-2', username: 'alice.brown', email: 'alice.brown@example.com', firstName: 'Alice', lastName: 'Brown', department: 'Customer Service', status: 'active', lastLogin: new Date().toISOString(), roles: ['role-customer-service'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
    { id: 'user-dev-1', username: 'bob.developer', email: 'bob.developer@example.com', firstName: 'Bob', lastName: 'Developer', department: 'Engineering', status: 'active', lastLogin: new Date().toISOString(), roles: ['role-developer'], audit: { createdAt: new Date().toISOString(), createdBy: 'system', updatedAt: new Date().toISOString(), updatedBy: 'system', version: 1 } },
];

let mockAuditLogs: AuditLogEntry[] = [];

// Helper to simulate API delay
const simulateApiCall = <T>(data: T, delay: number = 500): Promise<T> => {
    return new Promise(resolve => setTimeout(() => resolve(data), delay));
};

// MOCK API LAYER
export const RoleAPI = {
    getRoles: async (): Promise<Role[]> => simulateApiCall(mockRoles),
    getRoleById: async (id: EntityId): Promise<Role | undefined> => simulateApiCall(mockRoles.find(r => r.id === id)),
    createRole: async (role: Omit<Role, 'id' | 'audit' | 'users' | 'isSystemRole' | 'status'>): Promise<Role> => {
        const newRole: Role = {
            ...role,
            id: `role-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            users: [],
            isSystemRole: false,
            status: 'active',
            audit: {
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: MOCK_CURRENT_USER_ID,
                updatedBy: MOCK_CURRENT_USER_ID,
                version: 1
            }
        };
        mockRoles.push(newRole);
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'ROLE_CREATED',
            targetType: 'role', targetId: newRole.id, details: { newRole: newRole.name }
        });
        toast({ title: 'Role Created', description: `Role "${newRole.name}" successfully created.`, variant: 'success' });
        return simulateApiCall(newRole);
    },
    updateRole: async (id: EntityId, updates: Partial<Omit<Role, 'id' | 'audit' | 'isSystemRole'>>): Promise<Role> => {
        const index = mockRoles.findIndex(r => r.id === id);
        if (index === -1) throw new Error('Role not found');
        const oldRole = mockRoles[index];
        const updatedRole: Role = {
            ...oldRole,
            ...updates,
            audit: {
                ...oldRole.audit,
                updatedAt: new Date().toISOString(),
                updatedBy: MOCK_CURRENT_USER_ID,
                version: oldRole.audit.version + 1
            }
        };
        mockRoles[index] = updatedRole;
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'ROLE_UPDATED',
            targetType: 'role', targetId: updatedRole.id, details: { old: oldRole, new: updates }
        });
        toast({ title: 'Role Updated', description: `Role "${updatedRole.name}" successfully updated.`, variant: 'success' });
        return simulateApiCall(updatedRole);
    },
    deleteRole: async (id: EntityId): Promise<void> => {
        const roleToDelete = mockRoles.find(r => r.id === id);
        if (!roleToDelete) throw new Error('Role not found');
        if (roleToDelete.isSystemRole) throw new Error('Cannot delete system roles');
        if (roleToDelete.users.length > 0) throw new Error('Cannot delete role with assigned users. Unassign users first.');

        mockRoles = mockRoles.filter(r => r.id !== id);
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'ROLE_DELETED',
            targetType: 'role', targetId: id, details: { roleName: roleToDelete.name }
        });
        toast({ title: 'Role Deleted', description: `Role "${roleToDelete.name}" successfully deleted.`, variant: 'success' });
        return simulateApiCall(undefined);
    },
    assignUserToRole: async (userId: EntityId, roleId: EntityId): Promise<void> => {
        const user = mockUsers.find(u => u.id === userId);
        const role = mockRoles.find(r => r.id === roleId);
        if (!user) throw new Error('User not found');
        if (!role) throw new Error('Role not found');

        if (!user.roles.includes(roleId)) {
            user.roles.push(roleId);
        }
        if (!role.users.includes(userId)) {
            role.users.push(userId);
        }
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'USER_ROLE_ASSIGNED',
            targetType: 'user', targetId: userId, details: { roleId, roleName: role.name }
        });
        toast({ title: 'User Assigned', description: `User "${user.username}" assigned to role "${role.name}".`, variant: 'success' });
        return simulateApiCall(undefined);
    },
    unassignUserFromRole: async (userId: EntityId, roleId: EntityId): Promise<void> => {
        const user = mockUsers.find(u => u.id === userId);
        const role = mockRoles.find(r => r.id === roleId);
        if (!user) throw new Error('User not found');
        if (!role) throw new Error('Role not found');

        user.roles = user.roles.filter(r => r !== roleId);
        role.users = role.users.filter(u => u !== userId);
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'USER_ROLE_UNASSIGNED',
            targetType: 'user', targetId: userId, details: { roleId, roleName: role.name }
        });
        toast({ title: 'User Unassigned', description: `User "${user.username}" unassigned from role "${role.name}".`, variant: 'success' });
        return simulateApiCall(undefined);
    },
    getRoleHistory: async (roleId: EntityId): Promise<AuditLogEntry[]> => {
        return simulateApiCall(mockAuditLogs.filter(log => log.targetType === 'role' && log.targetId === roleId));
    },
    getSuggestionsForRole: async (roleId: EntityId): Promise<AISuggestion[]> => {
        const role = mockRoles.find(r => r.id === roleId);
        return simulateApiCall(role?.aiSuggestions || []);
    },
    acceptSuggestion: async (suggestionId: EntityId): Promise<void> => {
        for (const role of mockRoles) {
            const suggestionIndex = role.aiSuggestions?.findIndex(s => s.id === suggestionId);
            if (suggestionIndex !== undefined && suggestionIndex !== -1 && role.aiSuggestions) {
                const suggestion = role.aiSuggestions[suggestionIndex];
                suggestion.status = 'accepted';
                suggestion.acceptedBy = MOCK_CURRENT_USER_ID;
                suggestion.acceptedAt = new Date().toISOString();

                // Apply the suggestion (mock logic)
                if (suggestion.type === 'least_privilege' && suggestion.details.unnecessaryPermissions) {
                    const permissionsToRemove = suggestion.details.unnecessaryPermissions as EntityId[];
                    role.permissions = role.permissions.filter(p => !permissionsToRemove.includes(p));
                    toast({
                        title: 'Suggestion Accepted',
                        description: `Least-privilege suggestion applied for role "${role.name}". Permissions removed.`,
                        variant: 'success'
                    });
                } else {
                    toast({ title: 'Suggestion Accepted', description: `Suggestion "${suggestion.id}" for role "${role.name}" accepted.`, variant: 'success' });
                }

                mockAuditLogs.push({
                    id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'AI_SUGGESTION_ACCEPTED',
                    targetType: 'role', targetId: role.id, details: { suggestionId, suggestionType: suggestion.type, message: suggestion.message }
                });
                return simulateApiCall(undefined);
            }
        }
        throw new Error('Suggestion not found');
    },
    rejectSuggestion: async (suggestionId: EntityId): Promise<void> => {
        for (const role of mockRoles) {
            const suggestionIndex = role.aiSuggestions?.findIndex(s => s.id === suggestionId);
            if (suggestionIndex !== undefined && suggestionIndex !== -1 && role.aiSuggestions) {
                role.aiSuggestions[suggestionIndex].status = 'rejected';
                mockAuditLogs.push({
                    id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'AI_SUGGESTION_REJECTED',
                    targetType: 'role', targetId: role.id, details: { suggestionId, suggestionType: role.aiSuggestions[suggestionIndex].type }
                });
                toast({ title: 'Suggestion Rejected', description: `Suggestion "${suggestionId}" for role "${role.name}" rejected.`, variant: 'warning' });
                return simulateApiCall(undefined);
            }
        }
        throw new Error('Suggestion not found');
    }
};

export const PermissionAPI = {
    getPermissions: async (): Promise<Permission[]> => simulateApiCall(mockPermissions),
    getPermissionById: async (id: EntityId): Promise<Permission | undefined> => simulateApiCall(mockPermissions.find(p => p.id === id)),
    createPermission: async (permission: Omit<Permission, 'id' | 'audit'>): Promise<Permission> => {
        const newPermission: Permission = {
            ...permission,
            id: `perm-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            audit: {
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: MOCK_CURRENT_USER_ID,
                updatedBy: MOCK_CURRENT_USER_ID,
                version: 1
            }
        };
        mockPermissions.push(newPermission);
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'PERMISSION_CREATED',
            targetType: 'permission', targetId: newPermission.id, details: { newPermission: newPermission.name }
        });
        toast({ title: 'Permission Created', description: `Permission "${newPermission.name}" successfully created.`, variant: 'success' });
        return simulateApiCall(newPermission);
    },
    updatePermission: async (id: EntityId, updates: Partial<Omit<Permission, 'id' | 'audit'>>): Promise<Permission> => {
        const index = mockPermissions.findIndex(p => p.id === id);
        if (index === -1) throw new Error('Permission not found');
        const oldPermission = mockPermissions[index];
        const updatedPermission: Permission = {
            ...oldPermission,
            ...updates,
            audit: {
                ...oldPermission.audit,
                updatedAt: new Date().toISOString(),
                updatedBy: MOCK_CURRENT_USER_ID,
                version: oldPermission.audit.version + 1
            }
        };
        mockPermissions[index] = updatedPermission;
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'PERMISSION_UPDATED',
            targetType: 'permission', targetId: updatedPermission.id, details: { old: oldPermission, new: updates }
        });
        toast({ title: 'Permission Updated', description: `Permission "${updatedPermission.name}" successfully updated.`, variant: 'success' });
        return simulateApiCall(updatedPermission);
    },
    deletePermission: async (id: EntityId): Promise<void> => {
        const permissionToDelete = mockPermissions.find(p => p.id === id);
        if (!permissionToDelete) throw new Error('Permission not found');

        // Check if any role is using this permission
        const rolesUsingPermission = mockRoles.filter(role => role.permissions.includes(id));
        if (rolesUsingPermission.length > 0) {
            const roleNames = rolesUsingPermission.map(r => r.name).join(', ');
            throw new Error(`Cannot delete permission "${permissionToDelete.name}" as it is currently assigned to roles: ${roleNames}. Please unassign it first.`);
        }

        mockPermissions = mockPermissions.filter(p => p.id !== id);
        mockAuditLogs.push({
            id: `audit-${Date.now()}`, timestamp: new Date().toISOString(), actorId: MOCK_CURRENT_USER_ID, action: 'PERMISSION_DELETED',
            targetType: 'permission', targetId: id, details: { permissionName: permissionToDelete.name }
        });
        toast({ title: 'Permission Deleted', description: `Permission "${permissionToDelete.name}" successfully deleted.`, variant: 'success' });
        return simulateApiCall(undefined);
    }
};

export const UserAPI = {
    getUsers: async (): Promise<User[]> => simulateApiCall(mockUsers),
    getUserById: async (id: EntityId): Promise<User | undefined> => simulateApiCall(mockUsers.find(u => u.id === id)),
    getUsersByRole: async (roleId: EntityId): Promise<User[]> => simulateApiCall(mockUsers.filter(u => u.roles.includes(roleId))),
};

export const AISuggestionAPI = {
    getAISuggestions: async (): Promise<AISuggestion[]> => {
        const allSuggestions: AISuggestion[] = [];
        mockRoles.forEach(role => {
            if (role.aiSuggestions) {
                allSuggestions.push(...role.aiSuggestions);
            }
        });
        return simulateApiCall(allSuggestions);
    },
    generateNewSuggestions: async (): Promise<AISuggestion[]> => {
        // Simulate AI generation logic
        const newSuggestions: AISuggestion[] = [];
        const now = new Date().toISOString();

        // Example: Generate a "role drift" suggestion for a random role
        if (Math.random() > 0.5 && mockRoles.length > 0) {
            const randomRole = mockRoles[Math.floor(Math.random() * mockRoles.length)];
            const existingDriftSuggestion = randomRole.aiSuggestions?.find(s => s.type === 'drift_detection' && s.status === 'pending');

            if (!existingDriftSuggestion) {
                const recentLogs = mockAuditLogs.filter(log => log.targetType === 'role' && log.targetId === randomRole.id && new Date(log.timestamp) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));
                if (recentLogs.length > 3) { // If role has had significant changes recently
                    const newId = `ai-sugg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    const driftSuggestion: AISuggestion = {
                        id: newId,
                        type: 'drift_detection',
                        targetId: randomRole.id,
                        message: `Role "${randomRole.name}" has experienced significant permission changes in the last 7 days. Review for potential drift.`,
                        details: { recentChanges: recentLogs.length, logs: recentLogs.map(l => ({ action: l.action, timestamp: l.timestamp })) },
                        severity: 'high',
                        status: 'pending',
                        generatedAt: now,
                        audit: { createdAt: now, createdBy: 'AI-System', updatedAt: now, updatedBy: 'AI-System', version: 1 }
                    };
                    randomRole.aiSuggestions = randomRole.aiSuggestions ? [...randomRole.aiSuggestions, driftSuggestion] : [driftSuggestion];
                    newSuggestions.push(driftSuggestion);
                }
            }
        }
        // Example: Generate a "least privilege" suggestion for a random role
        if (Math.random() > 0.5 && mockRoles.length > 0) {
            const randomRole = mockRoles[Math.floor(Math.random() * mockRoles.length)];
            const existingLPSuggestion = randomRole.aiSuggestions?.find(s => s.type === 'least_privilege' && s.status === 'pending');

            if (!existingLPSuggestion && randomRole.permissions.length > 2) {
                const permissionToSuggestRemoval = randomRole.permissions[Math.floor(Math.random() * randomRole.permissions.length)];
                const permName = mockPermissions.find(p => p.id === permissionToSuggestRemoval)?.name || permissionToSuggestRemoval;
                const newId = `ai-sugg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const lpSuggestion: AISuggestion = {
                    id: newId,
                    type: 'least_privilege',
                    targetId: randomRole.id,
                    message: `Permission "${permName}" in role "${randomRole.name}" seems unused based on recent user activity. Consider removal.`,
                    details: { unnecessaryPermissions: [permissionToSuggestRemoval] },
                    severity: 'medium',
                    status: 'pending',
                    generatedAt: now,
                    audit: { createdAt: now, createdBy: 'AI-System', updatedAt: now, updatedBy: 'AI-System', version: 1 }
                };
                randomRole.aiSuggestions = randomRole.aiSuggestions ? [...randomRole.aiSuggestions, lpSuggestion] : [lpSuggestion];
                newSuggestions.push(lpSuggestion);
            }
        }

        toast({ title: 'AI Suggestions', description: `${newSuggestions.length} new suggestions generated.`, variant: 'info' });
        return simulateApiCall(newSuggestions);
    }
};

export const AuditLogAPI = {
    getAuditLogs: async (filters?: { targetType?: 'role' | 'permission' | 'user', targetId?: EntityId, action?: string }): Promise<AuditLogEntry[]> => {
        let logs = [...mockAuditLogs].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
        if (filters?.targetType) {
            logs = logs.filter(log => log.targetType === filters.targetType);
        }
        if (filters?.targetId) {
            logs = logs.filter(log => log.targetId === filters.targetId);
        }
        if (filters?.action) {
            logs = logs.filter(log => log.action.includes(filters.action));
        }
        return simulateApiCall(logs);
    }
};


// --- UI Components ---

interface RoleFormProps {
    role?: Role;
    onSave: (role: Omit<Role, 'id' | 'audit' | 'users' | 'isSystemRole' | 'status'> | Role) => Promise<void>;
    onClose: () => void;
    isLoading: boolean;
    allPermissions: Permission[];
}

export const RoleForm: React.FC<RoleFormProps> = ({ role, onSave, onClose, isLoading, allPermissions }) => {
    const [name, setName] = useState(role?.name || '');
    const [description, setDescription] = useState(role?.description || '');
    const [selectedPermissionIds, setSelectedPermissionIds] = useState<EntityId[]>(role?.permissions || []);
    const [status, setStatus] = useState<Role['status']>(role?.status || 'active');
    const [reviewDate, setReviewDate] = useState<Date | undefined>(role?.reviewDate ? new Date(role.reviewDate) : undefined);
    const [showPermissionSearch, setShowPermissionSearch] = useState(false);
    const inputRef = useRef<HTMLInputElement>(null);

    const isEditing = !!role;

    const handleSave = async () => {
        if (!name.trim()) {
            toast({ title: 'Error', description: 'Role name cannot be empty.', variant: 'destructive' });
            return;
        }

        const roleData: Omit<Role, 'id' | 'audit' | 'users' | 'isSystemRole' | 'status'> = {
            name,
            description,
            permissions: selectedPermissionIds,
            status: status,
            reviewDate: reviewDate?.toISOString()
        };

        await onSave(roleData);
        onClose();
    };

    const togglePermission = (permissionId: EntityId) => {
        setSelectedPermissionIds(prev =>
            prev.includes(permissionId)
                ? prev.filter(id => id !== permissionId)
                : [...prev, permissionId]
        );
    };

    useEffect(() => {
        if (showPermissionSearch) {
            inputRef.current?.focus();
        }
    }, [showPermissionSearch]);

    const availablePermissions = useMemo(() => {
        return allPermissions.filter(p => !p.deprecated);
    }, [allPermissions]);

    const selectedPermissions = useMemo(() => {
        return availablePermissions.filter(p => selectedPermissionIds.includes(p.id));
    }, [availablePermissions, selectedPermissionIds]);

    const unselectedPermissions = useMemo(() => {
        return availablePermissions.filter(p => !selectedPermissionIds.includes(p.id));
    }, [availablePermissions, selectedPermissionIds]);

    return (
        <div className="space-y-4">
            <div>
                <Label htmlFor="name" className="text-gray-300">Role Name</Label>
                <Input
                    id="name"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="e.g., Finance Manager"
                    className="mt-1"
                />
            </div>
            <div>
                <Label htmlFor="description" className="text-gray-300">Description</Label>
                <Textarea
                    id="description"
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="A brief description of the role's responsibilities and access."
                    className="mt-1"
                />
            </div>
            {!isEditing && ( // New roles are always active by default. Existing roles can change status.
                <div>
                    <Label htmlFor="status" className="text-gray-300">Status</Label>
                    <Select value={status} onValueChange={(value: Role['status']) => setStatus(value)}>
                        <SelectTrigger className="w-full mt-1">
                            <SelectValue placeholder="Select status" />
                        </SelectTrigger>
                        <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                            <SelectItem value="active">Active</SelectItem>
                            <SelectItem value="inactive">Inactive</SelectItem>
                            <SelectItem value="pending_review">Pending Review</SelectItem>
                            <SelectItem value="deprecated">Deprecated</SelectItem>
                        </SelectContent>
                    </Select>
                </div>
            )}
            <div>
                <Label htmlFor="reviewDate" className="text-gray-300 block mb-1">Next Review Date</Label>
                <Popover>
                    <PopoverTrigger asChild>
                        <Button
                            variant={"outline"}
                            className={cn(
                                "w-full justify-start text-left font-normal",
                                !reviewDate && "text-muted-foreground"
                            )}
                        >
                            <CalendarIcon className="mr-2 h-4 w-4" />
                            {reviewDate ? format(reviewDate, "PPP") : <span>Pick a date</span>}
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-auto p-0 bg-gray-800 border-gray-700 text-white" align="start">
                        <Calendar
                            mode="single"
                            selected={reviewDate}
                            onSelect={setReviewDate}
                            initialFocus
                        />
                    </PopoverContent>
                </Popover>
            </div>

            <div>
                <Label className="text-gray-300 block mb-2">Permissions</Label>
                <div className="border border-gray-700 rounded-md p-3 max-h-60 overflow-y-auto">
                    {selectedPermissions.length > 0 ? (
                        <div className="flex flex-wrap gap-2 mb-2">
                            {selectedPermissions.map(perm => (
                                <span key={perm.id} className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-600 text-white">
                                    {perm.name}
                                    <Button
                                        variant="ghost"
                                        size="sm"
                                        className="ml-1 h-auto p-0.5 text-white hover:text-red-300"
                                        onClick={() => togglePermission(perm.id)}
                                    >
                                        <XCircle className="h-3 w-3" />
                                    </Button>
                                </span>
                            ))}
                        </div>
                    ) : (
                        <p className="text-gray-500 text-sm italic">No permissions selected.</p>
                    )}
                    <Popover open={showPermissionSearch} onOpenChange={setShowPermissionSearch}>
                        <PopoverTrigger asChild>
                            <Button variant="outline" className="w-full justify-between" onClick={() => setShowPermissionSearch(true)}>
                                Add Permissions
                                <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                            </Button>
                        </PopoverTrigger>
                        <PopoverContent className="w-[var(--radix-popover-trigger-width)] p-0 bg-gray-800 border-gray-700 text-white">
                            <Command>
                                <CommandInput
                                    placeholder="Search permissions..."
                                    className="bg-gray-700 text-white placeholder-gray-400 border-gray-600"
                                    ref={inputRef}
                                />
                                <CommandList className="max-h-60 overflow-y-auto">
                                    <CommandEmpty>No permissions found.</CommandEmpty>
                                    <CommandGroup>
                                        {unselectedPermissions.map(perm => (
                                            <CommandItem
                                                key={perm.id}
                                                value={perm.name}
                                                onSelect={() => {
                                                    togglePermission(perm.id);
                                                    setShowPermissionSearch(false); // Close popover after selection
                                                }}
                                                className="hover:bg-gray-700 data-[state=selected]:bg-gray-600 cursor-pointer"
                                            >
                                                <CheckIcon
                                                    className={cn(
                                                        "mr-2 h-4 w-4",
                                                        selectedPermissionIds.includes(perm.id) ? "opacity-100" : "opacity-0"
                                                    )}
                                                />
                                                {perm.name} <span className="text-xs text-gray-500 ml-2">({perm.resource}:{perm.action})</span>
                                            </CommandItem>
                                        ))}
                                    </CommandGroup>
                                </CommandList>
                            </Command>
                        </PopoverContent>
                    </Popover>
                </div>
            </div>

            <DialogFooter className="mt-6">
                <Button variant="outline" onClick={onClose} disabled={isLoading}>
                    Cancel
                </Button>
                <Button onClick={handleSave} disabled={isLoading}>
                    {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                    {isEditing ? 'Update Role' : 'Create Role'}
                </Button>
            </DialogFooter>
        </div>
    );
};

interface PermissionFormProps {
    permission?: Permission;
    onSave: (permission: Omit<Permission, 'id' | 'audit'> | Permission) => Promise<void>;
    onClose: () => void;
    isLoading: boolean;
}

export const PermissionForm: React.FC<PermissionFormProps> = ({ permission, onSave, onClose, isLoading }) => {
    const [name, setName] = useState(permission?.name || '');
    const [description, setDescription] = useState(permission?.description || '');
    const [resource, setResource] = useState(permission?.resource || '');
    const [action, setAction] = useState(permission?.action || '');
    const [level, setLevel] = useState<Permission['level']>(permission?.level || 'global');
    const [tags, setTags] = useState(permission?.tags.join(', ') || '');
    const [deprecated, setDeprecated] = useState(permission?.deprecated || false);

    const isEditing = !!permission;

    const handleSave = async () => {
        if (!name.trim() || !resource.trim() || !action.trim()) {
            toast({ title: 'Error', description: 'Name, Resource, and Action are required.', variant: 'destructive' });
            return;
        }

        const permissionData: Omit<Permission, 'id' | 'audit'> = {
            name,
            description,
            resource,
            action,
            level,
            tags: tags.split(',').map(tag => tag.trim()).filter(Boolean),
            deprecated
        };

        await onSave(permissionData);
        onClose();
    };

    return (
        <div className="space-y-4">
            <div>
                <Label htmlFor="perm-name" className="text-gray-300">Permission Name</Label>
                <Input
                    id="perm-name"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    placeholder="e.g., Read Customer Data"
                    className="mt-1"
                />
            </div>
            <div>
                <Label htmlFor="perm-description" className="text-gray-300">Description</Label>
                <Textarea
                    id="perm-description"
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="Details what this permission grants access to."
                    className="mt-1"
                />
            </div>
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <Label htmlFor="perm-resource" className="text-gray-300">Resource</Label>
                    <Input
                        id="perm-resource"
                        value={resource}
                        onChange={(e) => setResource(e.target.value)}
                        placeholder="e.g., users, transactions"
                        className="mt-1"
                    />
                </div>
                <div>
                    <Label htmlFor="perm-action" className="text-gray-300">Action</Label>
                    <Input
                        id="perm-action"
                        value={action}
                        onChange={(e) => setAction(e.target.value)}
                        placeholder="e.g., read, write, approve"
                        className="mt-1"
                    />
                </div>
            </div>
            <div>
                <Label htmlFor="perm-level" className="text-gray-300">Scope Level</Label>
                <Select value={level} onValueChange={(value: Permission['level']) => setLevel(value)}>
                    <SelectTrigger className="w-full mt-1">
                        <SelectValue placeholder="Select scope" />
                    </SelectTrigger>
                    <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                        <SelectItem value="global">Global</SelectItem>
                        <SelectItem value="organizational">Organizational</SelectItem>
                        <SelectItem value="departmental">Departmental</SelectItem>
                        <SelectItem value="individual">Individual</SelectItem>
                    </SelectContent>
                </Select>
            </div>
            <div>
                <Label htmlFor="perm-tags" className="text-gray-300">Tags (comma-separated)</Label>
                <Input
                    id="perm-tags"
                    value={tags}
                    onChange={(e) => setTags(e.target.value)}
                    placeholder="e.g., finance, PII, sensitive"
                    className="mt-1"
                />
            </div>
            <div className="flex items-center space-x-2 mt-4">
                <Switch
                    id="perm-deprecated"
                    checked={deprecated}
                    onCheckedChange={setDeprecated}
                    disabled={permission?.id === 'perm-all' && !isEditing} // Prevent deprecating "All Access" if it's not the initial state
                />
                <Label htmlFor="perm-deprecated">Mark as Deprecated</Label>
                <Popover>
                    <PopoverTrigger asChild>
                        <Button variant="ghost" size="icon" className="h-6 w-6 text-gray-400 hover:text-white">
                            <Info className="h-4 w-4" />
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent className="text-sm bg-gray-800 border-gray-700 text-white">
                        Deprecated permissions are still functional but indicate they should be phased out.
                    </PopoverContent>
                </Popover>
            </div>

            <DialogFooter className="mt-6">
                <Button variant="outline" onClick={onClose} disabled={isLoading}>
                    Cancel
                </Button>
                <Button onClick={handleSave} disabled={isLoading}>
                    {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                    {isEditing ? 'Update Permission' : 'Create Permission'}
                </Button>
            </DialogFooter>
        </div>
    );
};

// --- Core Feature Components ---

export const RoleTable: React.FC<{ roles: Role[]; onEdit: (role: Role) => void; onDelete: (role: Role) => void; onViewUsers: (role: Role) => void; onViewDetails: (role: Role) => void }> = ({ roles, onEdit, onDelete, onViewUsers, onViewDetails }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState<string>('all');

    const filteredRoles = useMemo(() => {
        return roles.filter(role => {
            const matchesSearch = role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  role.description.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesStatus = filterStatus === 'all' || role.status === filterStatus;
            return matchesSearch && matchesStatus;
        });
    }, [roles, searchTerm, filterStatus]);

    return (
        <Card title="Roles">
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-grow">
                    <Input
                        placeholder="Search roles..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="max-w-sm"
                    />
                </div>
                <Select value={filterStatus} onValueChange={setFilterStatus}>
                    <SelectTrigger className="w-[180px]">
                        <SelectValue placeholder="Filter by Status" />
                    </SelectTrigger>
                    <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                        <SelectItem value="all">All Statuses</SelectItem>
                        <SelectItem value="active">Active</SelectItem>
                        <SelectItem value="inactive">Inactive</SelectItem>
                        <SelectItem value="pending_review">Pending Review</SelectItem>
                        <SelectItem value="deprecated">Deprecated</SelectItem>
                    </SelectContent>
                </Select>
            </div>
            <Table>
                <TableHeader>
                    <TableRow className="border-gray-700">
                        <TableHead className="w-[200px] text-gray-300">Name</TableHead>
                        <TableHead className="text-gray-300">Description</TableHead>
                        <TableHead className="w-[100px] text-gray-300">Users</TableHead>
                        <TableHead className="w-[120px] text-gray-300">Status</TableHead>
                        <TableHead className="w-[150px] text-gray-300 text-right">Actions</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {filteredRoles.length === 0 ? (
                        <TableRow>
                            <TableCell colSpan={5} className="text-center text-gray-500">No roles found.</TableCell>
                        </TableRow>
                    ) : (
                        filteredRoles.map((role) => (
                            <TableRow key={role.id} className="border-gray-800 hover:bg-gray-800">
                                <TableCell className="font-medium text-white">{role.name} {role.isSystemRole && <span className="text-xs text-blue-400">(System)</span>}</TableCell>
                                <TableCell className="text-gray-400">{role.description}</TableCell>
                                <TableCell className="text-gray-400">{role.users.length}</TableCell>
                                <TableCell>
                                    <span className={cn(
                                        "px-2 py-0.5 rounded-full text-xs font-medium",
                                        role.status === 'active' && 'bg-green-500/20 text-green-400',
                                        role.status === 'inactive' && 'bg-red-500/20 text-red-400',
                                        role.status === 'pending_review' && 'bg-yellow-500/20 text-yellow-400',
                                        role.status === 'deprecated' && 'bg-gray-500/20 text-gray-400',
                                    )}>
                                        {role.status.replace('_', ' ').split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}
                                    </span>
                                </TableCell>
                                <TableCell className="text-right">
                                    <div className="flex justify-end space-x-2">
                                        <Button variant="ghost" size="icon" onClick={() => onViewDetails(role)} title="View Details">
                                            <Eye className="h-4 w-4 text-blue-400" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => onViewUsers(role)} title="Manage Users">
                                            <Link className="h-4 w-4 text-purple-400" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => onEdit(role)} title="Edit Role">
                                            <Edit2 className="h-4 w-4 text-yellow-400" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => onDelete(role)} disabled={role.isSystemRole || role.users.length > 0} title={role.isSystemRole ? "Cannot delete system role" : role.users.length > 0 ? "Role has assigned users" : "Delete Role"}>
                                            <Trash2 className="h-4 w-4 text-red-400" />
                                        </Button>
                                    </div>
                                </TableCell>
                            </TableRow>
                        ))
                    )}
                </TableBody>
            </Table>
        </Card>
    );
};

export const PermissionTable: React.FC<{ permissions: Permission[]; onEdit: (permission: Permission) => void; onDelete: (permission: Permission) => void; }> = ({ permissions, onEdit, onDelete }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterDeprecated, setFilterDeprecated] = useState<boolean | 'all'>('all');

    const filteredPermissions = useMemo(() => {
        return permissions.filter(permission => {
            const matchesSearch = permission.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  permission.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  permission.resource.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  permission.action.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesDeprecated = filterDeprecated === 'all' || permission.deprecated === filterDeprecated;
            return matchesSearch && matchesDeprecated;
        });
    }, [permissions, searchTerm, filterDeprecated]);

    return (
        <Card title="Permissions">
            <div className="flex flex-col md:flex-row gap-4 mb-4">
                <div className="flex-grow">
                    <Input
                        placeholder="Search permissions..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="max-w-sm"
                    />
                </div>
                <Select value={filterDeprecated.toString()} onValueChange={(value) => setFilterDeprecated(value === 'all' ? 'all' : value === 'true')}>
                    <SelectTrigger className="w-[200px]">
                        <SelectValue placeholder="Filter by Deprecated" />
                    </SelectTrigger>
                    <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                        <SelectItem value="all">All</SelectItem>
                        <SelectItem value="true">Deprecated</SelectItem>
                        <SelectItem value="false">Active</SelectItem>
                    </SelectContent>
                </Select>
            </div>
            <Table>
                <TableHeader>
                    <TableRow className="border-gray-700">
                        <TableHead className="w-[200px] text-gray-300">Name</TableHead>
                        <TableHead className="text-gray-300">Description</TableHead>
                        <TableHead className="w-[120px] text-gray-300">Resource</TableHead>
                        <TableHead className="w-[100px] text-gray-300">Action</TableHead>
                        <TableHead className="w-[100px] text-gray-300">Level</TableHead>
                        <TableHead className="w-[80px] text-gray-300">Status</TableHead>
                        <TableHead className="w-[100px] text-gray-300 text-right">Actions</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {filteredPermissions.length === 0 ? (
                        <TableRow>
                            <TableCell colSpan={7} className="text-center text-gray-500">No permissions found.</TableCell>
                        </TableRow>
                    ) : (
                        filteredPermissions.map((permission) => (
                            <TableRow key={permission.id} className="border-gray-800 hover:bg-gray-800">
                                <TableCell className="font-medium text-white">{permission.name}</TableCell>
                                <TableCell className="text-gray-400">{permission.description}</TableCell>
                                <TableCell className="text-gray-400">{permission.resource}</TableCell>
                                <TableCell className="text-gray-400">{permission.action}</TableCell>
                                <TableCell className="text-gray-400">{permission.level?.charAt(0).toUpperCase() + permission.level?.slice(1)}</TableCell>
                                <TableCell>
                                    <span className={cn(
                                        "px-2 py-0.5 rounded-full text-xs font-medium",
                                        permission.deprecated ? 'bg-gray-500/20 text-gray-400' : 'bg-green-500/20 text-green-400'
                                    )}>
                                        {permission.deprecated ? 'Deprecated' : 'Active'}
                                    </span>
                                </TableCell>
                                <TableCell className="text-right">
                                    <div className="flex justify-end space-x-2">
                                        <Button variant="ghost" size="icon" onClick={() => onEdit(permission)} title="Edit Permission">
                                            <Edit2 className="h-4 w-4 text-yellow-400" />
                                        </Button>
                                        <Button variant="ghost" size="icon" onClick={() => onDelete(permission)} title="Delete Permission">
                                            <Trash2 className="h-4 w-4 text-red-400" />
                                        </Button>
                                    </div>
                                </TableCell>
                            </TableRow>
                        ))
                    )}
                </TableBody>
            </Table>
        </Card>
    );
};

export const AISuggestionsPanel: React.FC<{ suggestions: AISuggestion[]; onAccept: (id: EntityId) => void; onReject: (id: EntityId) => void; onRefresh: () => void; isLoading: boolean }> = ({ suggestions, onAccept, onReject, onRefresh, isLoading }) => {
    const pendingSuggestions = useMemo(() => suggestions.filter(s => s.status === 'pending'), [suggestions]);

    const getSeverityClass = (severity: AISuggestion['severity']) => {
        switch (severity) {
            case 'low': return 'text-gray-400 bg-gray-500/20';
            case 'medium': return 'text-yellow-400 bg-yellow-500/20';
            case 'high': return 'text-orange-400 bg-orange-500/20';
            case 'critical': return 'text-red-400 bg-red-500/20';
            default: return 'text-gray-400 bg-gray-500/20';
        }
    };

    const getTypeIcon = (type: AISuggestion['type']) => {
        switch (type) {
            case 'least_privilege': return <EyeOff className="h-4 w-4 mr-1" />;
            case 'role_clustering': return <Users className="h-4 w-4 mr-1" />;
            case 'drift_detection': return <AlertCircle className="h-4 w-4 mr-1" />;
            case 'compliance_violation': return <ShieldAlert className="h-4 w-4 mr-1" />;
            default: return <Info className="h-4 w-4 mr-1" />;
        }
    };

    return (
        <Card title="AI Security Suggestions">
            <div className="mb-4 flex justify-between items-center">
                <p className="text-gray-400">Review AI-powered recommendations to enhance your security posture.</p>
                <Button variant="outline" size="sm" onClick={onRefresh} disabled={isLoading}>
                    {isLoading ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : <RefreshCcw className="h-4 w-4 mr-2" />}
                    Refresh Suggestions
                </Button>
            </div>
            {pendingSuggestions.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                    <CheckCircle className="h-10 w-10 mx-auto mb-3 text-green-500" />
                    <p>No pending AI suggestions at the moment. Your security posture looks good!</p>
                </div>
            ) : (
                <div className="space-y-4">
                    {pendingSuggestions.map(suggestion => (
                        <div key={suggestion.id} className="bg-gray-800 p-4 rounded-md border border-gray-700">
                            <div className="flex justify-between items-start mb-2">
                                <div className="flex items-center">
                                    {getTypeIcon(suggestion.type)}
                                    <h4 className="font-semibold text-white mr-2">{suggestion.message}</h4>
                                    <span className={cn("px-2 py-0.5 rounded-full text-xs font-medium", getSeverityClass(suggestion.severity))}>
                                        {suggestion.severity.charAt(0).toUpperCase() + suggestion.severity.slice(1)}
                                    </span>
                                </div>
                                <div className="text-sm text-gray-500">
                                    Generated: {format(new Date(suggestion.generatedAt), 'PPP')}
                                </div>
                            </div>
                            <p className="text-sm text-gray-400 mb-3">{suggestion.details.recommendedAction || "Review role permissions or user assignments."}</p>
                            <div className="flex space-x-2">
                                <Button size="sm" variant="success" onClick={() => onAccept(suggestion.id)} disabled={isLoading}>
                                    Accept
                                </Button>
                                <Button size="sm" variant="destructive" onClick={() => onReject(suggestion.id)} disabled={isLoading}>
                                    Reject
                                </Button>
                                <Dialog>
                                    <DialogTrigger asChild>
                                        <Button size="sm" variant="outline">
                                            Details
                                        </Button>
                                    </DialogTrigger>
                                    <DialogContent className="sm:max-w-[425px] bg-gray-900 border-gray-700 text-white">
                                        <DialogHeader>
                                            <DialogTitle className="text-white">AI Suggestion Details</DialogTitle>
                                            <DialogDescription className="text-gray-400">
                                                Detailed information about the AI's recommendation.
                                            </DialogDescription>
                                        </DialogHeader>
                                        <div className="space-y-3 text-sm">
                                            <p><strong className="text-gray-300">Type:</strong> {suggestion.type.replace('_', ' ').split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}</p>
                                            <p><strong className="text-gray-300">Target:</strong> {mockRoles.find(r => r.id === suggestion.targetId)?.name || suggestion.targetId}</p>
                                            <p><strong className="text-gray-300">Severity:</strong> {suggestion.severity}</p>
                                            <p><strong className="text-gray-300">Message:</strong> {suggestion.message}</p>
                                            <Separator className="bg-gray-700" />
                                            <p className="text-gray-300 font-semibold">Additional Details:</p>
                                            <pre className="bg-gray-700 p-2 rounded text-xs overflow-auto max-h-40 text-gray-200">
                                                {JSON.stringify(suggestion.details, null, 2)}
                                            </pre>
                                        </div>
                                        <DialogFooter>
                                            <Button type="button" variant="outline">Close</Button>
                                        </DialogFooter>
                                    </DialogContent>
                                </Dialog>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </Card>
    );
};

export const RoleDetailsPanel: React.FC<{ role: Role; allPermissions: Permission[]; allUsers: User[]; onClose: () => void; }> = ({ role, allPermissions, allUsers, onClose }) => {
    const { isSimulationMode } = useGlobalSecurityContext();
    const [auditLogs, setAuditLogs] = useState<AuditLogEntry[]>([]);
    const [isLoadingLogs, setIsLoadingLogs] = useState(false);
    const [isAssigningUser, setIsAssigningUser] = useState(false);
    const [selectedUserToAssign, setSelectedUserToAssign] = useState<EntityId | null>(null);

    const rolePermissions = useMemo(() => {
        return allPermissions.filter(p => role.permissions.includes(p.id));
    }, [role.permissions, allPermissions]);

    const assignedUsers = useMemo(() => {
        return allUsers.filter(u => role.users.includes(u.id));
    }, [role.users, allUsers]);

    const unassignedUsers = useMemo(() => {
        return allUsers.filter(u => !role.users.includes(u.id));
    }, [role.users, allUsers]);

    const fetchAuditLogs = useCallback(async () => {
        setIsLoadingLogs(true);
        try {
            const logs = await AuditLogAPI.getAuditLogs({ targetType: 'role', targetId: role.id });
            setAuditLogs(logs);
        } catch (error) {
            toast({ title: 'Error', description: 'Failed to fetch audit logs.', variant: 'destructive' });
        } finally {
            setIsLoadingLogs(false);
        }
    }, [role.id]);

    useEffect(() => {
        fetchAuditLogs();
    }, [fetchAuditLogs]);

    const handleAssignUser = async () => {
        if (!selectedUserToAssign) return;
        setIsAssigningUser(true);
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "User assignment simulated successfully.", variant: "info" });
            } else {
                await RoleAPI.assignUserToRole(selectedUserToAssign, role.id);
                // Refetch roles and users in parent component
            }
            setSelectedUserToAssign(null);
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to assign user to role.', variant: 'destructive' });
        } finally {
            setIsAssigningUser(false);
        }
    };

    const handleUnassignUser = async (userId: EntityId) => {
        setIsAssigningUser(true); // Re-using loading state
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "User unassignment simulated successfully.", variant: "info" });
            } else {
                await RoleAPI.unassignUserFromRole(userId, role.id);
                // Refetch roles and users in parent component
            }
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to unassign user from role.', variant: 'destructive' });
        } finally {
            setIsAssigningUser(false);
        }
    };

    return (
        <Dialog open onOpenChange={onClose}>
            <DialogContent className="max-w-4xl bg-gray-900 border-gray-700 text-white p-6">
                <DialogHeader>
                    <DialogTitle className="text-white text-2xl">{role.name} Details</DialogTitle>
                    <DialogDescription className="text-gray-400">
                        Comprehensive view of role configurations, assigned users, and audit history.
                    </DialogDescription>
                </DialogHeader>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto max-h-[70vh] pr-4 custom-scrollbar">
                    {/* Role Information */}
                    <div className="space-y-4">
                        <h3 className="text-xl font-semibold text-gray-200">Basic Information</h3>
                        <p><strong className="text-gray-300">ID:</strong> <span className="text-sm bg-gray-800 px-2 py-0.5 rounded text-gray-400 font-mono">{role.id}</span></p>
                        <p><strong className="text-gray-300">Description:</strong> {role.description}</p>
                        <p><strong className="text-gray-300">Status:</strong>
                            <span className={cn(
                                "ml-2 px-2 py-0.5 rounded-full text-xs font-medium",
                                role.status === 'active' && 'bg-green-500/20 text-green-400',
                                role.status === 'inactive' && 'bg-red-500/20 text-red-400',
                                role.status === 'pending_review' && 'bg-yellow-500/20 text-yellow-400',
                                role.status === 'deprecated' && 'bg-gray-500/20 text-gray-400',
                            )}>
                                {role.status.replace('_', ' ').split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')}
                            </span>
                        </p>
                        <p><strong className="text-gray-300">System Role:</strong> {role.isSystemRole ? 'Yes' : 'No'}</p>
                        {role.reviewDate && <p><strong className="text-gray-300">Next Review:</strong> {format(new Date(role.reviewDate), 'PPP')}</p>}
                        <p className="text-sm text-gray-500">
                            Created: {format(new Date(role.audit.createdAt), 'PPP HH:mm')} by {role.audit.createdBy}<br />
                            Last Updated: {format(new Date(role.audit.updatedAt), 'PPP HH:mm')} by {role.audit.updatedBy} (v{role.audit.version})
                        </p>
                    </div>

                    {/* Permissions */}
                    <div className="space-y-4">
                        <h3 className="text-xl font-semibold text-gray-200">Permissions ({rolePermissions.length})</h3>
                        {rolePermissions.length === 0 ? (
                            <p className="text-gray-500 italic">No permissions assigned to this role.</p>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                {rolePermissions.map(perm => (
                                    <div key={perm.id} className="bg-gray-800 p-3 rounded-md border border-gray-700 flex flex-col justify-between">
                                        <div>
                                            <h4 className="font-semibold text-white text-sm">{perm.name}</h4>
                                            <p className="text-xs text-gray-400">{perm.resource}:{perm.action}</p>
                                        </div>
                                        {perm.deprecated && (
                                            <span className="text-xs text-gray-500 mt-1 italic flex items-center">
                                                <AlertCircle className="h-3 w-3 mr-1" /> Deprecated
                                            </span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Assigned Users */}
                    <div className="space-y-4 col-span-2">
                        <h3 className="text-xl font-semibold text-gray-200">Assigned Users ({assignedUsers.length})</h3>
                        <div className="flex items-center space-x-2">
                            <Select value={selectedUserToAssign || ''} onValueChange={setSelectedUserToAssign} disabled={unassignedUsers.length === 0}>
                                <SelectTrigger className="w-[200px] bg-gray-800 border-gray-700">
                                    <SelectValue placeholder="Select user to assign" />
                                </SelectTrigger>
                                <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                                    {unassignedUsers.length === 0 && <SelectItem value="no-users" disabled>No users available</SelectItem>}
                                    {unassignedUsers.map(user => (
                                        <SelectItem key={user.id} value={user.id}>{user.username} ({user.department})</SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                            <Button onClick={handleAssignUser} disabled={!selectedUserToAssign || isAssigningUser || unassignedUsers.length === 0}>
                                {isAssigningUser ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <PlusCircle className="mr-2 h-4 w-4" />}
                                Assign User
                            </Button>
                        </div>

                        {assignedUsers.length === 0 ? (
                            <p className="text-gray-500 italic">No users currently assigned to this role.</p>
                        ) : (
                            <Table className="bg-gray-800 border-gray-700 rounded-md">
                                <TableHeader>
                                    <TableRow className="border-gray-700">
                                        <TableHead className="text-gray-300">Username</TableHead>
                                        <TableHead className="text-gray-300">Department</TableHead>
                                        <TableHead className="text-gray-300">Email</TableHead>
                                        <TableHead className="text-gray-300 text-right">Action</TableHead>
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {assignedUsers.map(user => (
                                        <TableRow key={user.id} className="border-gray-800 hover:bg-gray-700">
                                            <TableCell className="font-medium text-white">{user.username}</TableCell>
                                            <TableCell className="text-gray-400">{user.department}</TableCell>
                                            <TableCell className="text-gray-400">{user.email}</TableCell>
                                            <TableCell className="text-right">
                                                <Button variant="ghost" size="icon" onClick={() => handleUnassignUser(user.id)} disabled={isAssigningUser} title="Unassign User">
                                                    <Unlink className="h-4 w-4 text-red-400" />
                                                </Button>
                                            </TableCell>
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>
                        )}
                    </div>

                    {/* Audit Trail */}
                    <div className="space-y-4 col-span-2">
                        <h3 className="text-xl font-semibold text-gray-200">Audit Trail ({auditLogs.length})</h3>
                        {isLoadingLogs ? (
                            <div className="flex justify-center items-center h-20">
                                <Loader2 className="h-6 w-6 animate-spin text-blue-500" />
                                <span className="ml-2 text-gray-400">Loading audit logs...</span>
                            </div>
                        ) : auditLogs.length === 0 ? (
                            <p className="text-gray-500 italic">No audit history for this role.</p>
                        ) : (
                            <div className="space-y-3">
                                {auditLogs.map((log, index) => (
                                    <div key={log.id} className="bg-gray-800 p-3 rounded-md border border-gray-700">
                                        <div className="flex justify-between items-center text-sm mb-1">
                                            <span className="font-semibold text-white">{log.action.replace(/_/g, ' ')}</span>
                                            <span className="text-gray-500">{format(new Date(log.timestamp), 'PPP HH:mm:ss')}</span>
                                        </div>
                                        <p className="text-xs text-gray-400">
                                            By: {mockUsers.find(u => u.id === log.actorId)?.username || log.actorId}
                                        </p>
                                        {Object.keys(log.details).length > 0 && (
                                            <Popover>
                                                <PopoverTrigger asChild>
                                                    <Button variant="link" size="sm" className="h-auto p-0 text-blue-400 text-xs">View Details</Button>
                                                </PopoverTrigger>
                                                <PopoverContent className="text-sm bg-gray-800 border-gray-700 text-white max-w-lg p-3">
                                                    <h5 className="font-semibold mb-1">Log Details</h5>
                                                    <pre className="bg-gray-700 p-2 rounded text-xs overflow-auto max-h-40 text-gray-200">
                                                        {JSON.stringify(log.details, null, 2)}
                                                    </pre>
                                                </PopoverContent>
                                            </Popover>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
                <DialogFooter className="mt-6">
                    <Button onClick={onClose} variant="outline">Close</Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};

export const GlobalSecurityProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [isSimulationMode, setIsSimulationMode] = useState(false);

    const toggleSimulationMode = useCallback(() => {
        setIsSimulationMode(prev => {
            const newState = !prev;
            toast({
                title: newState ? 'Simulation Mode ON' : 'Simulation Mode OFF',
                description: newState ? 'Changes will not be persisted to mock backend.' : 'Changes will be persisted to mock backend.',
                variant: newState ? 'info' : 'default',
            });
            return newState;
        });
    }, []);

    const contextValue = useMemo(() => ({
        isSimulationMode,
        toggleSimulationMode,
    }), [isSimulationMode, toggleSimulationMode]);

    return (
        <GlobalSecurityContext.Provider value={contextValue}>
            {children}
        </GlobalSecurityContext.Provider>
    );
};

// --- Main View Component ---

const RoleManagementView: React.FC = () => {
    const [roles, setRoles] = useState<Role[]>([]);
    const [permissions, setPermissions] = useState<Permission[]>([]);
    const [users, setUsers] = useState<User[]>([]);
    const [aiSuggestions, setAISuggestions] = useState<AISuggestion[]>([]);

    const [loadingRoles, setLoadingRoles] = useState(false);
    const [loadingPermissions, setLoadingPermissions] = useState(false);
    const [loadingSuggestions, setLoadingSuggestions] = useState(false);
    const [loadingUsers, setLoadingUsers] = useState(false);

    const [isRoleFormOpen, setIsRoleFormOpen] = useState(false);
    const [editingRole, setEditingRole] = useState<Role | undefined>(undefined);

    const [isPermissionFormOpen, setIsPermissionFormOpen] = useState(false);
    const [editingPermission, setEditingPermission] = useState<Permission | undefined>(undefined);

    const [viewingRoleDetails, setViewingRoleDetails] = useState<Role | undefined>(undefined);

    const { isSimulationMode } = useGlobalSecurityContext();

    // --- Data Fetching ---
    const fetchRoles = useCallback(async () => {
        setLoadingRoles(true);
        try {
            const data = await RoleAPI.getRoles();
            setRoles(data);
        } catch (error) {
            toast({ title: 'Error', description: 'Failed to fetch roles.', variant: 'destructive' });
        } finally {
            setLoadingRoles(false);
        }
    }, []);

    const fetchPermissions = useCallback(async () => {
        setLoadingPermissions(true);
        try {
            const data = await PermissionAPI.getPermissions();
            setPermissions(data);
        } catch (error) {
            toast({ title: 'Error', description: 'Failed to fetch permissions.', variant: 'destructive' });
        } finally {
            setLoadingPermissions(false);
        }
    }, []);

    const fetchUsers = useCallback(async () => {
        setLoadingUsers(true);
        try {
            const data = await UserAPI.getUsers();
            setUsers(data);
        } catch (error) {
            toast({ title: 'Error', description: 'Failed to fetch users.', variant: 'destructive' });
        } finally {
            setLoadingUsers(false);
        }
    }, []);

    const fetchAISuggestions = useCallback(async () => {
        setLoadingSuggestions(true);
        try {
            const data = await AISuggestionAPI.getAISuggestions();
            setAISuggestions(data);
        } catch (error) {
            toast({ title: 'Error', description: 'Failed to fetch AI suggestions.', variant: 'destructive' });
        } finally {
            setLoadingSuggestions(false);
        }
    }, []);

    useEffect(() => {
        fetchRoles();
        fetchPermissions();
        fetchUsers();
        fetchAISuggestions();
    }, [fetchRoles, fetchPermissions, fetchUsers, fetchAISuggestions]);

    // --- Role Management Handlers ---
    const handleCreateOrUpdateRole = async (roleData: Omit<Role, 'id' | 'audit' | 'users' | 'isSystemRole' | 'status'> | Role) => {
        setLoadingRoles(true); // Indicate saving process
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "Role save simulated successfully.", variant: "info" });
            } else {
                if ('id' in roleData && editingRole) {
                    await RoleAPI.updateRole(editingRole.id, roleData);
                } else {
                    await RoleAPI.createRole(roleData as Omit<Role, 'id' | 'audit' | 'users' | 'isSystemRole' | 'status'>);
                }
            }
            await fetchRoles(); // Refresh roles list
            setEditingRole(undefined);
            setIsRoleFormOpen(false);
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to save role.', variant: 'destructive' });
        } finally {
            setLoadingRoles(false);
        }
    };

    const handleDeleteRole = async (role: Role) => {
        if (role.isSystemRole) {
            toast({ title: 'Action Denied', description: 'Cannot delete system roles.', variant: 'destructive' });
            return;
        }
        if (role.users.length > 0) {
            toast({ title: 'Action Denied', description: `Role "${role.name}" has ${role.users.length} assigned users. Please unassign users first.`, variant: 'destructive' });
            return;
        }

        if (window.confirm(`Are you sure you want to delete the role "${role.name}"? This action cannot be undone.`)) {
            setLoadingRoles(true);
            try {
                if (isSimulationMode) {
                    toast({ title: "Simulation Mode", description: "Role deletion simulated successfully.", variant: "info" });
                } else {
                    await RoleAPI.deleteRole(role.id);
                }
                await fetchRoles();
            } catch (error: any) {
                toast({ title: 'Error', description: error.message || 'Failed to delete role.', variant: 'destructive' });
            } finally {
                setLoadingRoles(false);
            }
        }
    };

    const handleEditRole = (role: Role) => {
        setEditingRole(role);
        setIsRoleFormOpen(true);
    };

    const handleViewRoleDetails = (role: Role) => {
        setViewingRoleDetails(role);
    };

    // --- Permission Management Handlers ---
    const handleCreateOrUpdatePermission = async (permissionData: Omit<Permission, 'id' | 'audit'> | Permission) => {
        setLoadingPermissions(true); // Indicate saving process
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "Permission save simulated successfully.", variant: "info" });
            } else {
                if ('id' in permissionData && editingPermission) {
                    await PermissionAPI.updatePermission(editingPermission.id, permissionData);
                } else {
                    await PermissionAPI.createPermission(permissionData as Omit<Permission, 'id' | 'audit'>);
                }
            }
            await fetchPermissions(); // Refresh permissions list
            setEditingPermission(undefined);
            setIsPermissionFormOpen(false);
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to save permission.', variant: 'destructive' });
        } finally {
            setLoadingPermissions(false);
        }
    };

    const handleDeletePermission = async (permission: Permission) => {
        if (window.confirm(`Are you sure you want to delete the permission "${permission.name}"? This action cannot be undone and will fail if it's assigned to any roles.`)) {
            setLoadingPermissions(true);
            try {
                if (isSimulationMode) {
                    toast({ title: "Simulation Mode", description: "Permission deletion simulated successfully.", variant: "info" });
                } else {
                    await PermissionAPI.deletePermission(permission.id);
                }
                await fetchPermissions();
            } catch (error: any) {
                toast({ title: 'Error', description: error.message || 'Failed to delete permission.', variant: 'destructive' });
            } finally {
                setLoadingPermissions(false);
            }
        }
    };

    const handleEditPermission = (permission: Permission) => {
        setEditingPermission(permission);
        setIsPermissionFormOpen(true);
    };

    // --- AI Suggestion Handlers ---
    const handleAcceptSuggestion = async (suggestionId: EntityId) => {
        setLoadingSuggestions(true);
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "AI suggestion acceptance simulated.", variant: "info" });
            } else {
                await AISuggestionAPI.acceptSuggestion(suggestionId);
            }
            await fetchAISuggestions();
            await fetchRoles(); // Accepting suggestions might change roles
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to accept suggestion.', variant: 'destructive' });
        } finally {
            setLoadingSuggestions(false);
        }
    };

    const handleRejectSuggestion = async (suggestionId: EntityId) => {
        setLoadingSuggestions(true);
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "AI suggestion rejection simulated.", variant: "info" });
            } else {
                await AISuggestionAPI.rejectSuggestion(suggestionId);
            }
            await fetchAISuggestions();
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to reject suggestion.', variant: 'destructive' });
        } finally {
            setLoadingSuggestions(false);
        }
    };

    const handleGenerateNewSuggestions = async () => {
        setLoadingSuggestions(true);
        try {
            if (isSimulationMode) {
                toast({ title: "Simulation Mode", description: "AI suggestion generation simulated.", variant: "info" });
            } else {
                await AISuggestionAPI.generateNewSuggestions();
            }
            await fetchAISuggestions();
        } catch (error: any) {
            toast({ title: 'Error', description: error.message || 'Failed to generate new suggestions.', variant: 'destructive' });
        } finally {
            setLoadingSuggestions(false);
        }
    };


    return (
        <div className="space-y-6">
            <h2 className="text-3xl font-bold text-white tracking-wider">Identity & Role Command</h2>
            <Card title="Mission Brief">
                <p className="text-gray-400">Define and manage the nervous system of your organization. This is where you define user roles and permissions across the entire Demo Bank platform. Implement least-privilege access with AI-powered suggestions to ensure security by default.</p>
                <div className="mt-4 flex items-center space-x-2">
                    <Switch
                        id="simulation-mode"
                        checked={isSimulationMode}
                        onCheckedChange={useGlobalSecurityContext().toggleSimulationMode}
                    />
                    <Label htmlFor="simulation-mode">Simulation Mode</Label>
                    <Popover>
                        <PopoverTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-6 w-6 text-gray-400 hover:text-white">
                                <Info className="h-4 w-4" />
                            </Button>
                        </PopoverTrigger>
                        <PopoverContent className="text-sm bg-gray-800 border-gray-700 text-white">
                            When enabled, actions will be simulated and not persist changes to the mock backend. Ideal for testing configurations.
                        </PopoverContent>
                    </Popover>
                </div>
            </Card>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Card title="AI Role Clustering"><p>Our AI automatically groups users with similar access patterns to suggest new, optimized roles, reducing complexity and human error.</p></Card>
                <Card title="Least-Privilege Suggestions"><p>Receive continuous, AI-driven recommendations to remove unnecessary permissions from roles, hardening your security posture automatically.</p></Card>
                <Card title="Role Drift Detection"><p>Get alerted when a role's permissions have significantly changed over time, preventing unintended privilege escalation.</p></Card>
            </div>

            <Separator className="bg-gray-700" />

            {/* AI Suggestions Section */}
            <AISuggestionsPanel
                suggestions={aiSuggestions}
                onAccept={handleAcceptSuggestion}
                onReject={handleRejectSuggestion}
                onRefresh={handleGenerateNewSuggestions}
                isLoading={loadingSuggestions}
            />

            <Separator className="bg-gray-700" />

            {/* Role Management Section */}
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-2xl font-semibold text-white">Role Management</h3>
                <Dialog open={isRoleFormOpen} onOpenChange={setIsRoleFormOpen}>
                    <DialogTrigger asChild>
                        <Button onClick={() => { setEditingRole(undefined); setIsRoleFormOpen(true); }}>
                            <PlusCircle className="mr-2 h-4 w-4" /> Create New Role
                        </Button>
                    </DialogTrigger>
                    <DialogContent className="sm:max-w-[500px] bg-gray-900 border-gray-700 text-white">
                        <DialogHeader>
                            <DialogTitle className="text-white">{editingRole ? 'Edit Role' : 'Create New Role'}</DialogTitle>
                            <DialogDescription className="text-gray-400">
                                {editingRole ? 'Modify the details and permissions of this role.' : 'Define a new security role with specific permissions.'}
                            </DialogDescription>
                        </DialogHeader>
                        <RoleForm
                            role={editingRole}
                            onSave={handleCreateOrUpdateRole}
                            onClose={() => setIsRoleFormOpen(false)}
                            isLoading={loadingRoles}
                            allPermissions={permissions}
                        />
                    </DialogContent>
                </Dialog>
            </div>

            {loadingRoles ? (
                <div className="flex justify-center items-center h-40">
                    <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
                    <span className="ml-2 text-gray-400">Loading roles...</span>
                </div>
            ) : (
                <RoleTable
                    roles={roles}
                    onEdit={handleEditRole}
                    onDelete={handleDeleteRole}
                    onViewUsers={handleViewRoleDetails} // Re-using role details for user management
                    onViewDetails={handleViewRoleDetails}
                />
            )}

            {viewingRoleDetails && (
                <RoleDetailsPanel
                    role={viewingRoleDetails}
                    allPermissions={permissions}
                    allUsers={users}
                    onClose={() => { setViewingRoleDetails(undefined); fetchRoles(); fetchUsers(); }} // Refresh data when closing
                />
            )}

            <Separator className="bg-gray-700" />

            {/* Permission Management Section */}
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-2xl font-semibold text-white">Permission Management</h3>
                <Dialog open={isPermissionFormOpen} onOpenChange={setIsPermissionFormOpen}>
                    <DialogTrigger asChild>
                        <Button onClick={() => { setEditingPermission(undefined); setIsPermissionFormOpen(true); }}>
                            <PlusCircle className="mr-2 h-4 w-4" /> Create New Permission
                        </Button>
                    </DialogTrigger>
                    <DialogContent className="sm:max-w-[500px] bg-gray-900 border-gray-700 text-white">
                        <DialogHeader>
                            <DialogTitle className="text-white">{editingPermission ? 'Edit Permission' : 'Create New Permission'}</DialogTitle>
                            <DialogDescription className="text-gray-400">
                                {editingPermission ? 'Modify the details of this specific permission.' : 'Define a granular permission to control access to resources and actions.'}
                            </DialogDescription>
                        </DialogHeader>
                        <PermissionForm
                            permission={editingPermission}
                            onSave={handleCreateOrUpdatePermission}
                            onClose={() => setIsPermissionFormOpen(false)}
                            isLoading={loadingPermissions}
                        />
                    </DialogContent>
                </Dialog>
            </div>

            {loadingPermissions ? (
                <div className="flex justify-center items-center h-40">
                    <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
                    <span className="ml-2 text-gray-400">Loading permissions...</span>
                </div>
            ) : (
                <PermissionTable
                    permissions={permissions}
                    onEdit={handleEditPermission}
                    onDelete={handleDeletePermission}
                />
            )}

            <Separator className="bg-gray-700" />

            {/* AI Role Analyzer and Simulation (Advanced Section) */}
            <Card title="AI Role Analyzer & Simulation">
                <div className="space-y-4">
                    <p className="text-gray-400">Leverage advanced AI capabilities to analyze role effectiveness, simulate policy changes, and proactively identify security gaps.</p>

                    {/* Role Health Score */}
                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Role Health Score</h4>
                        <p className="text-gray-400 text-sm mb-2">An aggregated metric based on least-privilege adherence, usage patterns, and compliance. Higher is better.</p>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {roles.slice(0, 3).map(role => ( // Showing top 3 for brevity
                                <Card key={role.id} title={role.name} className="bg-gray-800 border-gray-700">
                                    <div className="flex items-center space-x-3">
                                        <Progress value={Math.min(100, 50 + role.permissions.length * 5)} className="w-full h-2 bg-gray-700" indicatorClassName="bg-blue-500" />
                                        <span className="text-white text-sm">{Math.min(100, 50 + role.permissions.length * 5)}%</span>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">Permissions: {role.permissions.length} | Users: {role.users.length}</p>
                                </Card>
                            ))}
                        </div>
                        <Button variant="link" className="text-blue-400 text-sm mt-2">View Full Role Health Report</Button>
                    </div>

                    <Separator className="bg-gray-700" />

                    {/* Policy Simulation */}
                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Policy Change Simulation</h4>
                        <p className="text-gray-400 text-sm mb-2">Simulate the impact of role or permission changes before applying them to production.</p>
                        <div className="flex space-x-4 items-center">
                            <Select defaultValue="role-finance-manager">
                                <SelectTrigger className="w-[240px]">
                                    <SelectValue placeholder="Select a role to simulate" />
                                </SelectTrigger>
                                <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                                    {roles.map(r => <SelectItem key={r.id} value={r.id}>{r.name}</SelectItem>)}
                                </SelectContent>
                            </Select>
                            <Select defaultValue="add-permission">
                                <SelectTrigger className="w-[240px]">
                                    <SelectValue placeholder="Select an action" />
                                </SelectTrigger>
                                <SelectContent className="bg-gray-800 text-gray-200 border-gray-700">
                                    <SelectItem value="add-permission">Add Permission</SelectItem>
                                    <SelectItem value="remove-permission">Remove Permission</SelectItem>
                                    <SelectItem value="change-status">Change Status</SelectItem>
                                </SelectContent>
                            </Select>
                            <Button variant="secondary">
                                <Loader2 className="h-4 w-4 mr-2 animate-spin hidden" /> {/* Show when simulating */}
                                Run Simulation
                            </Button>
                        </div>
                        <div className="mt-4 p-3 bg-gray-800 border border-gray-700 rounded-md text-sm text-gray-400">
                            <p className="font-semibold text-white mb-1">Simulation Results (Preview):</p>
                            <p><strong>Impact on Users:</strong> 5 users affected.</p>
                            <p><strong>Compliance Risk:</strong> Low (no new violations detected).</p>
                            <p><strong>Effective Permissions:</strong> 2 new permissions gained, 0 lost.</p>
                        </div>
                    </div>

                    <Separator className="bg-gray-700" />

                    {/* Role Hierarchies and Inheritance */}
                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">Role Hierarchy & Inheritance</h4>
                        <p className="text-gray-400 text-sm mb-2">Visualize and manage parent-child relationships between roles for easier permission inheritance.</p>
                        {/* This would typically be a complex graph visualization component */}
                        <div className="bg-gray-800 border border-gray-700 rounded-md p-4 h-48 flex items-center justify-center">
                            <p className="text-gray-500 italic">Role hierarchy visualization (e.g., D3.js graph) goes here.</p>
                        </div>
                        <Button variant="link" className="text-blue-400 text-sm mt-2">Manage Role Hierarchy</Button>
                    </div>

                    <Separator className="bg-gray-700" />

                    {/* AI-Powered Compliance Checks */}
                    <div>
                        <h4 className="font-semibold text-lg text-white mb-2">AI-Powered Compliance Checks</h4>
                        <p className="text-gray-400 text-sm mb-2">Automatically audit your role configurations against pre-defined compliance standards (e.g., GDPR, SOC2).</p>
                        <div className="flex justify-between items-center bg-gray-800 border border-gray-700 rounded-md p-4">
                            <div>
                                <p className="text-white font-medium">Last Compliance Scan: <span className="text-gray-400">{format(new Date(), 'PPP HH:mm')}</span></p>
                                <p className="text-gray-400 text-sm">Status: <span className="text-yellow-400">2 Minor Warnings</span></p>
                            </div>
                            <Button variant="secondary">
                                Run Compliance Scan
                            </Button>
                        </div>
                        <Button variant="link" className="text-blue-400 text-sm mt-2">View Compliance Report</Button>
                    </div>

                </div>
            </Card>

        </div>
    );
};

// Wrap the main component with the GlobalSecurityProvider
const RoleManagementViewWithProvider: React.FC = () => (
    <GlobalSecurityProvider>
        <RoleManagementView />
    </GlobalSecurityProvider>
);

export default RoleManagementViewWithProvider;

--- FILE: ThreatIntelligenceView.tsx ---

import React, { useState, useEffect, useCallback, useMemo, createContext, useContext } from 'react';
import Card from '../../../Card';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar, PieChart, Pie, Cell, AreaChart, Area, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';
import { ChevronDownIcon, ChevronUpIcon, PlusIcon, SearchIcon, FilterIcon, RefreshIcon, PlayIcon, PauseIcon, StopIcon, AlertTriangleIcon, CheckCircleIcon, XCircleIcon, InfoIcon, TargetIcon, EyeIcon, ZapIcon, LockIcon, ShieldIcon, DatabaseIcon, ServerIcon, CloudIcon, SettingsIcon, UserIcon, UsersIcon, GlobeIcon, BellIcon, MailIcon, ClockIcon, CalendarIcon, EditIcon, Trash2Icon, FileTextIcon, DownloadIcon, UploadIcon, CodeIcon, GitPullRequestIcon, TerminalIcon, CpuIcon, ActivityIcon, TrendingUpIcon, AlertOctagonIcon, BugIcon, HardDriveIcon, WifiIcon, MapPinIcon, MessageSquareIcon, BookmarkIcon, StarIcon, ThumbsUpIcon, ThumbsDownIcon, Share2Icon, LinkIcon, ExternalLinkIcon, ListIcon, GridIcon, LayoutDashboardIcon, SlidersIcon, TrendingDownIcon, UserPlusIcon, UserXIcon, KeyIcon, BoxIcon, BriefcaseIcon, DollarSignIcon, PercentIcon, GiftIcon, CreditCardIcon, LandmarkIcon, LayersIcon, PackageIcon, PhoneIcon, PrinterIcon, PuzzleIcon, RepeatIcon, RouterIcon, RssIcon, SaveIcon, ScissorsIcon, ScrollTextIcon, SendIcon, ShieldOffIcon, ShoppingBagIcon, ShoppingCartIcon, SitemapIcon, SpeakerIcon, SquareIcon, StickyNoteIcon, SunriseIcon, SunsetIcon, TabletIcon, TagIcon, TagsIcon, TextCursorIcon, ThermometerIcon, ThumbsUp, ThumbsDown, ToggleLeftIcon, ToggleRightIcon, ToolIcon, TrendingUp, TruckIcon, UmbrellaIcon, UnderlineIcon, UnlockIcon, UploadCloudIcon, UserCheckIcon, UserMinusIcon, UserX, VariableIcon, VideoIcon, Volume1Icon, Volume2Icon, VolumeXIcon, WalletIcon, WatchIcon, WebhookIcon, WheatIcon, WifiOffIcon, WindIcon, WineIcon, WrenchIcon, XIcon, ZapOffIcon, ZoomInIcon, ZoomOutIcon } from 'lucide-react';

// --- Utility Types and Interfaces ---
interface ThreatActor {
    id: string;
    name: string;
    description: string;
    origin: string;
    motives: string[];
    techniques: string[];
    severity: 'low' | 'medium' | 'high' | 'critical';
    lastActivity: string; // ISO date string
    tags: string[];
    associatedCampaigns: string[];
    mitigationStrategies: string[];
    confidence: number; // 0-100
    indicatorsOfCompromise: IoC[];
}

interface IoC {
    id: string;
    type: 'IP' | 'Domain' | 'Hash' | 'URL' | 'Email' | 'FilePath' | 'Mutex' | 'RegistryKey';
    value: string;
    severity: 'low' | 'medium' | 'high' | 'critical';
    source: string;
    timestamp: string; // ISO date string
    firstSeen: string;
    lastSeen: string;
    tags: string[];
    confidence: number;
    description?: string;
}

interface Vulnerability {
    cveId: string;
    name: string;
    description: string;
    severity: 'low' | 'medium' | 'high' | 'critical';
    cvssScore: number;
    publishedDate: string; // ISO date string
    updatedDate: string; // ISO date string
    exploitAvailable: boolean;
    patchAvailable: boolean;
    affectedProducts: string[];
    references: string[];
    tags: string[];
    remediationSteps: string[];
}

interface AttackSimulationResult {
    id: string;
    name: string;
    startTime: string; // ISO date string
    endTime: string; // ISO date string
    status: 'pending' | 'running' | 'completed' | 'failed' | 'cancelled';
    targetSystem: string;
    attackVector: string;
    adversaryEmulation: string; // e.g., "APT29"
    detectionRate: number; // 0-100%
    preventionRate: number; // 0-100%
    vulnerabilitiesExploited: string[]; // CVE IDs
    mitigationRecommendations: string[];
    reportUrl: string;
    logs: string[];
    riskScoreChange: number; // e.g., -5 (improvement) or +10 (degradation)
    tags: string[];
}

interface ThreatReport {
    id: string;
    title: string;
    author: string;
    publishDate: string; // ISO date string
    summary: string;
    fullReportContent: string;
    tags: string[];
    relatedIoCs: IoC[];
    relatedActors: ThreatActor[];
    relatedVulnerabilities: Vulnerability[];
    sentiment: 'positive' | 'neutral' | 'negative';
    confidence: number;
}

interface GlobalThreatSummary {
    totalActiveThreatActors: number;
    criticalVulnerabilities: number;
    newIoCsLast24h: number;
    ongoingCampaigns: number;
    sectorSpecificThreats: { [key: string]: number };
    topAttacksToday: { type: string; count: number }[];
    globalRiskScore: number; // 0-100
}

interface AIModelConfig {
    id: string;
    name: string;
    description: string;
    modelType: 'prediction' | 'detection' | 'simulation' | 'generative';
    status: 'active' | 'inactive' | 'training' | 'error';
    lastTrained: string;
    performanceMetrics: {
        accuracy: number;
        precision: number;
        recall: number;
        f1Score: number;
    };
    inputFeatures: string[];
    outputSchema: string;
    version: string;
    tags: string[];
}

interface SecurityPolicy {
    id: string;
    name: string;
    description: string;
    type: 'network' | 'endpoint' | 'access' | 'data' | 'application';
    status: 'active' | 'inactive' | 'draft';
    lastUpdatedBy: string;
    lastUpdatedDate: string;
    rules: string[]; // Simplified for example
    enforcementPoints: string[];
    riskLevel: 'low' | 'medium' | 'high' | 'critical';
    complianceStandards: string[];
}

interface Asset {
    id: string;
    name: string;
    type: 'server' | 'database' | 'application' | 'network_device' | 'cloud_instance';
    ipAddress: string;
    criticality: 'low' | 'medium' | 'high' | 'critical';
    owner: string;
    lastScanned: string;
    vulnerabilities: string[]; // CVE IDs
    associatedPolicies: string[]; // Policy IDs
    tags: string[];
    status: 'online' | 'offline' | 'compromised';
    geolocation: string;
    firmwareVersion?: string;
    osVersion?: string;
    installedSoftware?: string[];
}

interface UserBehaviorAnomaly {
    id: string;
    userId: string;
    username: string;
    anomalyType: 'login' | 'data_access' | 'resource_usage' | 'privilege_escalation';
    timestamp: string;
    description: string;
    severity: 'low' | 'medium' | 'high' | 'critical';
    confidence: number;
    status: 'new' | 'investigating' | 'resolved' | 'false_positive';
    associatedIoCs: IoC[];
    suggestedAction: string;
}

interface IncidentResponsePlaybook {
    id: string;
    name: string;
    description: string;
    triggerCondition: string; // e.g., "Critical Alert from SIEM"
    severityLevel: 'low' | 'medium' | 'high' | 'critical';
    steps: { order: number; action: string; assignee: string; status: 'todo' | 'in_progress' | 'completed' }[];
    lastUpdated: string;
    ownerTeam: string;
    tags: string[];
}

interface DataPrivacyRegulation {
    id: string;
    name: string;
    jurisdiction: string;
    description: string;
    keyRequirements: string[];
    complianceStatus: 'compliant' | 'non-compliant' | 'partial';
    lastAuditDate: string;
    riskOfNonCompliance: 'low' | 'medium' | 'high';
}

interface EventLog {
    id: string;
    timestamp: string;
    source: string;
    eventType: string;
    message: string;
    severity: 'info' | 'warning' | 'error' | 'critical';
    tags: string[];
    associatedIoC?: IoC;
    userId?: string;
    assetId?: string;
    details?: Record<string, any>;
}

interface ThreatFeedSource {
    id: string;
    name: string;
    url: string;
    format: string;
    lastIngested: string;
    status: 'active' | 'inactive' | 'error';
    refreshInterval: number; // in minutes
    category: 'OSINT' | 'commercial' | 'internal' | 'darkweb';
    confidenceScore: number; // 0-100, reliability of the source
}

// --- Dummy Data Generation Functions (for simulation) ---
const generateRandomId = () => Math.random().toString(36).substring(2, 15);
const getRandomDate = () => new Date(Date.now() - Math.floor(Math.random() * 365 * 24 * 60 * 60 * 1000)).toISOString();
const getRandomSeverity = (): 'low' | 'medium' | 'high' | 'critical' => ['low', 'medium', 'high', 'critical'][Math.floor(Math.random() * 4)] as any;
const getRandomStatus = (): 'pending' | 'running' | 'completed' | 'failed' | 'cancelled' => ['pending', 'running', 'completed', 'failed', 'cancelled'][Math.floor(Math.random() * 5)] as any;

const generateDummyIoC = (count: number = 10): IoC[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    type: ['IP', 'Domain', 'Hash', 'URL', 'Email', 'FilePath'][Math.floor(Math.random() * 6)] as any,
    value: Math.random() < 0.5 ? `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}` : `malicious-domain-${generateRandomId()}.com`,
    severity: getRandomSeverity(),
    source: `Feed-${Math.floor(Math.random() * 5) + 1}`,
    timestamp: getRandomDate(),
    firstSeen: getRandomDate(),
    lastSeen: getRandomDate(),
    tags: ['malware', 'phishing', 'ransomware', 'apt', 'exploit'].filter(() => Math.random() > 0.5),
    confidence: Math.floor(Math.random() * 100),
    description: `IoC description for ${generateRandomId()}`,
}));

const generateDummyThreatActor = (count: number = 5): ThreatActor[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `APT Group ${Math.floor(Math.random() * 100)}`,
    description: `Sophisticated threat actor group with a focus on ${Math.random() < 0.5 ? 'financial espionage' : 'critical infrastructure disruption'}.`,
    origin: ['Russia', 'China', 'North Korea', 'Iran', 'Eastern Europe'][Math.floor(Math.random() * 5)],
    motives: ['espionage', 'financial gain', 'sabotage', 'activism'].filter(() => Math.random() > 0.3),
    techniques: ['spear phishing', 'supply chain attacks', 'zero-day exploits', 'ransomware'].filter(() => Math.random() > 0.4),
    severity: getRandomSeverity(),
    lastActivity: getRandomDate(),
    tags: ['nation-state', 'criminal', 'insider'].filter(() => Math.random() > 0.5),
    associatedCampaigns: [`Campaign-${generateRandomId()}`, `Campaign-${generateRandomId()}`].filter(() => Math.random() > 0.5),
    mitigationStrategies: ['Enhanced MFA', 'Network Segmentation', 'Endpoint Detection'].filter(() => Math.random() > 0.5),
    confidence: Math.floor(Math.random() * 100),
    indicatorsOfCompromise: generateDummyIoC(Math.floor(Math.random() * 5)),
}));

const generateDummyVulnerability = (count: number = 15): Vulnerability[] => Array.from({ length: count }).map(() => ({
    cveId: `CVE-2023-${Math.floor(Math.random() * 10000)}`,
    name: `Vulnerability ${generateRandomId().substring(0, 8)}`,
    description: `A critical vulnerability found in ${Math.random() < 0.5 ? 'web servers' : 'operating systems'}.`,
    severity: getRandomSeverity(),
    cvssScore: parseFloat((Math.random() * (10 - 4) + 4).toFixed(1)),
    publishedDate: getRandomDate(),
    updatedDate: getRandomDate(),
    exploitAvailable: Math.random() > 0.3,
    patchAvailable: Math.random() > 0.6,
    affectedProducts: ['Apache HTTP Server', 'OpenSSL', 'Windows Server', 'Linux Kernel'].filter(() => Math.random() > 0.5),
    references: [`https://nvd.nist.gov/vuln/detail/${generateRandomId()}`],
    tags: ['web', 'server', 'os', 'cloud'].filter(() => Math.random() > 0.5),
    remediationSteps: ['Apply patch', 'Upgrade software', 'Implement WAF rules'].filter(() => Math.random() > 0.5),
}));

const generateDummySimulationResult = (count: number = 7): AttackSimulationResult[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `Red-Team Sim ${generateRandomId().substring(0, 8)}`,
    startTime: getRandomDate(),
    endTime: getRandomDate(),
    status: getRandomStatus(),
    targetSystem: ['Production API', 'Internal Database', 'Employee Workstations'][Math.floor(Math.random() * 3)],
    attackVector: ['Phishing Campaign', 'Web Application Exploit', 'Supply Chain Attack'][Math.floor(Math.random() * 3)],
    adversaryEmulation: ['APT29', 'FIN7', 'DarkSide'][Math.floor(Math.random() * 3)],
    detectionRate: Math.floor(Math.random() * 100),
    preventionRate: Math.floor(Math.random() * 100),
    vulnerabilitiesExploited: generateDummyVulnerability(Math.floor(Math.random() * 3)).map(v => v.cveId),
    mitigationRecommendations: ['Update WAF rules', 'Patch specific CVEs', 'Enhance EDR'].filter(() => Math.random() > 0.5),
    reportUrl: `/reports/sim-${generateRandomId()}.pdf`,
    logs: [`Log entry ${generateRandomId()}`, `Log entry ${generateRandomId()}`],
    riskScoreChange: Math.random() < 0.5 ? Math.floor(Math.random() * -10) : Math.floor(Math.random() * 10),
    tags: ['automated', 'critical', 'monthly'].filter(() => Math.random() > 0.5),
}));

const generateDummyThreatReport = (count: number = 8): ThreatReport[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    title: `Threat Report: ${generateRandomId().substring(0, 12)} - ${['New Malware Variant', 'Phishing Campaign Analysis', 'APT Activity Update'][Math.floor(Math.random() * 3)]}`,
    author: `Analyst ${generateRandomId().substring(0, 4)}`,
    publishDate: getRandomDate(),
    summary: `This report details the discovery of a new threat, its characteristics, and potential impact.`,
    fullReportContent: `Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.`,
    tags: ['malware', 'phishing', 'APT', 'exploit', 'industry-specific'].filter(() => Math.random() > 0.4),
    relatedIoCs: generateDummyIoC(Math.floor(Math.random() * 3)),
    relatedActors: generateDummyThreatActor(Math.floor(Math.random() * 2)),
    relatedVulnerabilities: generateDummyVulnerability(Math.floor(Math.random() * 2)),
    sentiment: ['positive', 'neutral', 'negative'][Math.floor(Math.random() * 3)] as any,
    confidence: Math.floor(Math.random() * 100),
}));

const generateDummyAIModelConfig = (count: number = 5): AIModelConfig[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `AI Model ${generateRandomId().substring(0, 8)}`,
    description: `An AI model for ${['threat prediction', 'vulnerability detection', 'anomaly detection', 'attack simulation'][Math.floor(Math.random() * 4)]}.`,
    modelType: ['prediction', 'detection', 'simulation', 'generative'][Math.floor(Math.random() * 4)] as any,
    status: ['active', 'inactive', 'training', 'error'][Math.floor(Math.random() * 4)] as any,
    lastTrained: getRandomDate(),
    performanceMetrics: {
        accuracy: parseFloat((Math.random() * (0.99 - 0.7) + 0.7).toFixed(2)),
        precision: parseFloat((Math.random() * (0.99 - 0.7) + 0.7).toFixed(2)),
        recall: parseFloat((Math.random() * (0.99 - 0.7) + 0.7).toFixed(2)),
        f1Score: parseFloat((Math.random() * (0.99 - 0.7) + 0.7).toFixed(2)),
    },
    inputFeatures: ['network_logs', 'endpoint_telemetry', 'threat_feed_data', 'user_activity'].filter(() => Math.random() > 0.5),
    outputSchema: `{ "threat_level": "number", "target_asset": "string" }`,
    version: `v1.${Math.floor(Math.random() * 10)}`,
    tags: ['deep learning', 'machine learning', 'nlp', 'graph analysis'].filter(() => Math.random() > 0.5),
}));

const generateDummySecurityPolicy = (count: number = 10): SecurityPolicy[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `Policy ${generateRandomId().substring(0, 8)}`,
    description: `Security policy for ${['network access', 'data encryption', 'endpoint protection', 'application security'][Math.floor(Math.random() * 4)]}.`,
    type: ['network', 'endpoint', 'access', 'data', 'application'][Math.floor(Math.random() * 5)] as any,
    status: ['active', 'inactive', 'draft'][Math.floor(Math.random() * 3)] as any,
    lastUpdatedBy: `User-${Math.floor(Math.random() * 5) + 1}`,
    lastUpdatedDate: getRandomDate(),
    rules: [`Rule-${generateRandomId()}`, `Rule-${generateRandomId()}`],
    enforcementPoints: ['Firewall', 'EDR', 'IAM', 'WAF'].filter(() => Math.random() > 0.5),
    riskLevel: getRandomSeverity(),
    complianceStandards: ['GDPR', 'HIPAA', 'ISO27001', 'PCI-DSS'].filter(() => Math.random() > 0.5),
}));

const generateDummyAsset = (count: number = 20): Asset[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `Asset-${generateRandomId().substring(0, 8)}`,
    type: ['server', 'database', 'application', 'network_device', 'cloud_instance'][Math.floor(Math.random() * 5)] as any,
    ipAddress: `10.0.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`,
    criticality: getRandomSeverity(),
    owner: `Team-${Math.floor(Math.random() * 3) + 1}`,
    lastScanned: getRandomDate(),
    vulnerabilities: generateDummyVulnerability(Math.floor(Math.random() * 3)).map(v => v.cveId),
    associatedPolicies: generateDummySecurityPolicy(Math.floor(Math.random() * 2)).map(p => p.id),
    tags: ['prod', 'dev', 'internal', 'external', 'hr'].filter(() => Math.random() > 0.5),
    status: ['online', 'offline', 'compromised'][Math.floor(Math.random() * 3)] as any,
    geolocation: ['US-East', 'EU-West', 'APAC-South'][Math.floor(Math.random() * 3)],
    firmwareVersion: Math.random() < 0.5 ? `v${Math.floor(Math.random() * 5)}.${Math.floor(Math.random() * 10)}` : undefined,
    osVersion: Math.random() < 0.5 ? `Linux Ubuntu 22.04` : `Windows Server 2022`,
    installedSoftware: ['Apache', 'Nginx', 'MongoDB', 'PostgreSQL', 'Node.js', 'Python'].filter(() => Math.random() > 0.6),
}));

const generateDummyUserBehaviorAnomaly = (count: number = 10): UserBehaviorAnomaly[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    userId: `user-${Math.floor(Math.random() * 1000)}`,
    username: `jsmith${Math.floor(Math.random() * 10)}`,
    anomalyType: ['login', 'data_access', 'resource_usage', 'privilege_escalation'][Math.floor(Math.random() * 4)] as any,
    timestamp: getRandomDate(),
    description: `Unusual activity detected: ${['failed login attempts', 'large data transfer', 'access to sensitive files', 'unauthorized privilege change'][Math.floor(Math.random() * 4)]}`,
    severity: getRandomSeverity(),
    confidence: Math.floor(Math.random() * 100),
    status: ['new', 'investigating', 'resolved', 'false_positive'][Math.floor(Math.random() * 4)] as any,
    associatedIoCs: generateDummyIoC(Math.floor(Math.random() * 2)),
    suggestedAction: ['Block user', 'Reset password', 'Forensic investigation'].filter(() => Math.random() > 0.5).join(', '),
}));

const generateDummyIncidentResponsePlaybook = (count: number = 5): IncidentResponsePlaybook[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `Playbook: ${['Phishing Incident', 'Data Breach', 'DDoS Attack', 'Malware Outbreak'][Math.floor(Math.random() * 4)]}`,
    description: `Steps to follow for a ${['phishing', 'data breach', 'DDoS', 'malware'][Math.floor(Math.random() * 4)]} incident.`,
    triggerCondition: `Critical Alert: ${['Phishing Detected', 'Unauthorized Data Exfil', 'High Network Traffic', 'New Malware Signature'][Math.floor(Math.random() * 4)]}`,
    severityLevel: getRandomSeverity(),
    steps: Array.from({ length: Math.floor(Math.random() * 5) + 3 }).map((_, i) => ({
        order: i + 1,
        action: `Step ${i + 1}: ${['Isolate system', 'Notify legal', 'Analyze logs', 'Restore backup', 'Communicate externally'][Math.floor(Math.random() * 5)]}`,
        assignee: `Team ${Math.floor(Math.random() * 3) + 1}`,
        status: ['todo', 'in_progress', 'completed'][Math.floor(Math.random() * 3)] as any,
    })),
    lastUpdated: getRandomDate(),
    ownerTeam: `Team-${Math.floor(Math.random() * 3) + 1}`,
    tags: ['automation', 'critical', 'compliance'].filter(() => Math.random() > 0.5),
}));

const generateDummyDataPrivacyRegulation = (count: number = 5): DataPrivacyRegulation[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: ['GDPR', 'CCPA', 'HIPAA', 'LGPD', 'NIST-CSF'][Math.floor(Math.random() * 5)],
    jurisdiction: ['EU', 'California, USA', 'USA', 'Brazil', 'Global'][Math.floor(Math.random() * 5)],
    description: `Regulation concerning data privacy and security.`,
    keyRequirements: ['Data minimization', 'Consent management', 'Right to be forgotten', 'Breach notification'].filter(() => Math.random() > 0.4),
    complianceStatus: ['compliant', 'non-compliant', 'partial'][Math.floor(Math.random() * 3)] as any,
    lastAuditDate: getRandomDate(),
    riskOfNonCompliance: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)] as any,
}));

const generateDummyEventLog = (count: number = 50): EventLog[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    timestamp: getRandomDate(),
    source: ['firewall', 'siem', 'edr', 'cloud-logs'][Math.floor(Math.random() * 4)],
    eventType: ['login_failure', 'data_exfiltration', 'malware_alert', 'policy_violation', 'system_restart'][Math.floor(Math.random() * 5)],
    message: `Event message for ${generateRandomId()}`,
    severity: ['info', 'warning', 'error', 'critical'][Math.floor(Math.random() * 4)] as any,
    tags: ['network', 'endpoint', 'security'].filter(() => Math.random() > 0.5),
    associatedIoC: Math.random() < 0.3 ? generateDummyIoC(1)[0] : undefined,
    userId: Math.random() < 0.5 ? `user-${Math.floor(Math.random() * 100)}` : undefined,
    assetId: Math.random() < 0.5 ? `asset-${Math.floor(Math.random() * 50)}` : undefined,
    details: Math.random() < 0.4 ? { ip: `192.168.1.${Math.floor(Math.random() * 255)}`, port: Math.floor(Math.random() * 65535) } : undefined,
}));

const generateDummyThreatFeedSource = (count: number = 8): ThreatFeedSource[] => Array.from({ length: count }).map(() => ({
    id: generateRandomId(),
    name: `Feed-${generateRandomId().substring(0, 8)}`,
    url: `https://threatfeed.example.com/${generateRandomId()}`,
    format: ['STIX/TAXII', 'MISP', 'CSV', 'JSON'][Math.floor(Math.random() * 4)],
    lastIngested: getRandomDate(),
    status: ['active', 'inactive', 'error'][Math.floor(Math.random() * 3)] as any,
    refreshInterval: [5, 15, 30, 60, 240, 1440][Math.floor(Math.random() * 6)],
    category: ['OSINT', 'commercial', 'internal', 'darkweb'][Math.floor(Math.random() * 4)] as any,
    confidenceScore: Math.floor(Math.random() * 100),
}));


// --- Dummy Global State Context ---
interface ThreatIntelligenceContextType {
    ioCs: IoC[];
    threatActors: ThreatActor[];
    vulnerabilities: Vulnerability[];
    attackSimulations: AttackSimulationResult[];
    threatReports: ThreatReport[];
    aiModelConfigs: AIModelConfig[];
    securityPolicies: SecurityPolicy[];
    assets: Asset[];
    userAnomalies: UserBehaviorAnomaly[];
    incidentPlaybooks: IncidentResponsePlaybook[];
    privacyRegulations: DataPrivacyRegulation[];
    eventLogs: EventLog[];
    threatFeedSources: ThreatFeedSource[];
    globalSummary: GlobalThreatSummary;
    refreshData: () => void;
    addIoC: (ioc: IoC) => void;
    updateIoC: (ioc: IoC) => void;
    deleteIoC: (id: string) => void;
    // ... more actions for other entities
}

const ThreatIntelligenceContext = createContext<ThreatIntelligenceContextType | undefined>(undefined);

export const ThreatIntelligenceProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [ioCs, setIoCs] = useState<IoC[]>([]);
    const [threatActors, setThreatActors] = useState<ThreatActor[]>([]);
    const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
    const [attackSimulations, setAttackSimulations] = useState<AttackSimulationResult[]>([]);
    const [threatReports, setThreatReports] = useState<ThreatReport[]>([]);
    const [aiModelConfigs, setAiModelConfigs] = useState<AIModelConfig[]>([]);
    const [securityPolicies, setSecurityPolicies] = useState<SecurityPolicy[]>([]);
    const [assets, setAssets] = useState<Asset[]>([]);
    const [userAnomalies, setUserAnomalies] = useState<UserBehaviorAnomaly[]>([]);
    const [incidentPlaybooks, setIncidentPlaybooks] = useState<IncidentResponsePlaybook[]>([]);
    const [privacyRegulations, setPrivacyRegulations] = useState<DataPrivacyRegulation[]>([]);
    const [eventLogs, setEventLogs] = useState<EventLog[]>([]);
    const [threatFeedSources, setThreatFeedSources] = useState<ThreatFeedSource[]>([]);
    const [globalSummary, setGlobalSummary] = useState<GlobalThreatSummary>({
        totalActiveThreatActors: 0,
        criticalVulnerabilities: 0,
        newIoCsLast24h: 0,
        ongoingCampaigns: 0,
        sectorSpecificThreats: {},
        topAttacksToday: [],
        globalRiskScore: 0,
    });

    const refreshData = useCallback(() => {
        // Simulate API calls
        setIoCs(generateDummyIoC(50));
        setThreatActors(generateDummyThreatActor(10));
        setVulnerabilities(generateDummyVulnerability(30));
        setAttackSimulations(generateDummySimulationResult(15));
        setThreatReports(generateDummyThreatReport(20));
        setAiModelConfigs(generateDummyAIModelConfig(8));
        setSecurityPolicies(generateDummySecurityPolicy(20));
        setAssets(generateDummyAsset(50));
        setUserAnomalies(generateDummyUserBehaviorAnomaly(25));
        setIncidentPlaybooks(generateDummyIncidentResponsePlaybook(10));
        setPrivacyRegulations(generateDummyDataPrivacyRegulation(7));
        setEventLogs(generateDummyEventLog(200));
        setThreatFeedSources(generateDummyThreatFeedSource(10));

        // Update global summary based on fresh data
        const newIoCs24h = ioCs.filter(ioc => (new Date().getTime() - new Date(ioc.timestamp).getTime()) < 24 * 60 * 60 * 1000).length;
        const criticalVulns = vulnerabilities.filter(v => v.severity === 'critical').length;
        const activeActors = threatActors.filter(ta => (new Date().getTime() - new Date(ta.lastActivity).getTime()) < 30 * 24 * 60 * 60 * 1000).length;
        const uniqueCampaigns = new Set(threatActors.flatMap(ta => ta.associatedCampaigns)).size;

        const sectorThreats: { [key: string]: number } = {};
        threatActors.forEach(ta => ta.tags.forEach(tag => {
            if (tag.includes('industry')) { // Simplified tag-to-sector mapping
                sectorThreats[tag] = (sectorThreats[tag] || 0) + 1;
            }
        }));

        const topAttacks: { [key: string]: number } = {};
        ioCs.forEach(ioc => {
            const attackType = ioc.tags.includes('phishing') ? 'Phishing' : ioc.tags.includes('ransomware') ? 'Ransomware' : 'Malware';
            topAttacks[attackType] = (topAttacks[attackType] || 0) + 1;
        });
        const sortedTopAttacks = Object.entries(topAttacks)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, 3)
            .map(([type, count]) => ({ type, count }));

        const calculateGlobalRiskScore = (): number => {
            const iocImpact = ioCs.filter(ioc => ioc.severity === 'critical').length * 2 + ioCs.filter(ioc => ioc.severity === 'high').length;
            const actorImpact = threatActors.filter(ta => ta.severity === 'critical').length * 3 + threatActors.filter(ta => ta.severity === 'high').length * 1.5;
            const vulnImpact = vulnerabilities.filter(v => v.severity === 'critical' && v.exploitAvailable).length * 4 + vulnerabilities.filter(v => v.severity === 'high' && v.exploitAvailable).length * 2;
            const anomalyImpact = userAnomalies.filter(ua => ua.severity === 'critical' && ua.status !== 'false_positive').length * 2;
            const simulationRisk = attackSimulations.reduce((acc, sim) => acc + (100 - sim.preventionRate) * (sim.vulnerabilitiesExploited.length > 0 ? 1 : 0.5), 0) / (attackSimulations.length || 1);

            let totalScore = iocImpact + actorImpact + vulnImpact + anomalyImpact + simulationRisk;
            totalScore = Math.min(100, Math.max(0, totalScore / 10)); // Scale to 0-100

            return parseFloat(totalScore.toFixed(1));
        };

        setGlobalSummary({
            totalActiveThreatActors: activeActors,
            criticalVulnerabilities: criticalVulns,
            newIoCsLast24h: newIoCs24h,
            ongoingCampaigns: uniqueCampaigns,
            sectorSpecificThreats: sectorThreats,
            topAttacksToday: sortedTopAttacks,
            globalRiskScore: calculateGlobalRiskScore(),
        });
    }, [ioCs, vulnerabilities, threatActors, userAnomalies, attackSimulations]); // Add relevant dependencies

    useEffect(() => {
        refreshData();
        const intervalId = setInterval(refreshData, 5 * 60 * 1000); // Refresh every 5 minutes
        return () => clearInterval(intervalId);
    }, [refreshData]);

    const addIoC = useCallback((ioc: IoC) => setIoCs(prev => [...prev, ioc]), []);
    const updateIoC = useCallback((updatedIoc: IoC) => setIoCs(prev => prev.map(ioc => ioc.id === updatedIoc.id ? updatedIoc : ioc)), []);
    const deleteIoC = useCallback((id: string) => setIoCs(prev => prev.filter(ioc => ioc.id !== id)), []);

    const contextValue = useMemo(() => ({
        ioCs, threatActors, vulnerabilities, attackSimulations, threatReports, aiModelConfigs,
        securityPolicies, assets, userAnomalies, incidentPlaybooks, privacyRegulations, eventLogs,
        threatFeedSources, globalSummary, refreshData, addIoC, updateIoC, deleteIoC
    }), [ioCs, threatActors, vulnerabilities, attackSimulations, threatReports, aiModelConfigs,
        securityPolicies, assets, userAnomalies, incidentPlaybooks, privacyRegulations, eventLogs,
        threatFeedSources, globalSummary, refreshData, addIoC, updateIoC, deleteIoC]);

    return (
        <ThreatIntelligenceContext.Provider value={contextValue}>
            {children}
        </ThreatIntelligenceContext.Provider>
    );
};

export const useThreatIntelligence = () => {
    const context = useContext(ThreatIntelligenceContext);
    if (context === undefined) {
        throw new Error('useThreatIntelligence must be used within a ThreatIntelligenceProvider');
    }
    return context;
};

// --- Reusable UI Components ---

interface SectionHeaderProps {
    title: string;
    description: string;
    icon: React.ElementType;
    onRefresh?: () => void;
    showRefresh?: boolean;
}

export const SectionHeader: React.FC<SectionHeaderProps> = ({ title, description, icon: Icon, onRefresh, showRefresh = true }) => (
    <div className="flex items-center justify-between p-4 bg-gray-800 rounded-lg shadow-lg">
        <div className="flex items-center">
            <Icon className="h-8 w-8 text-purple-400 mr-3" />
            <div>
                <h3 className="text-xl font-semibold text-white">{title}</h3>
                <p className="text-gray-400 text-sm">{description}</p>
            </div>
        </div>
        {showRefresh && onRefresh && (
            <button
                onClick={onRefresh}
                className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 ease-in-out"
            >
                <RefreshIcon className="h-5 w-5 mr-2" /> Refresh
            </button>
        )}
    </div>
);

interface FilterableTableProps<T> {
    data: T[];
    columns: { header: string; accessor: keyof T; render?: (item: T) => React.ReactNode }[];
    title: string;
    initialSortBy?: keyof T;
    initialSortDirection?: 'asc' | 'desc';
    searchPlaceholder?: string;
    onRowClick?: (item: T) => void;
    actionButtons?: (item: T) => React.ReactNode;
}

export const FilterableTable = <T extends { id?: string | number }>({
    data,
    columns,
    title,
    initialSortBy,
    initialSortDirection = 'asc',
    searchPlaceholder = "Search...",
    onRowClick,
    actionButtons
}: FilterableTableProps<T>) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [sortBy, setSortBy] = useState<keyof T | undefined>(initialSortBy);
    const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>(initialSortDirection);
    const [currentPage, setCurrentPage] = useState(1);
    const [itemsPerPage, setItemsPerPage] = useState(10);

    const filteredData = useMemo(() => {
        return data.filter(item =>
            Object.values(item).some(value =>
                String(value).toLowerCase().includes(searchTerm.toLowerCase())
            )
        );
    }, [data, searchTerm]);

    const sortedData = useMemo(() => {
        if (!sortBy) return filteredData;

        return [...filteredData].sort((a, b) => {
            const aValue = a[sortBy];
            const bValue = b[sortBy];

            if (typeof aValue === 'string' && typeof bValue === 'string') {
                return sortDirection === 'asc'
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            }
            if (typeof aValue === 'number' && typeof bValue === 'number') {
                return sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
            }
            // Fallback for other types
            return 0;
        });
    }, [filteredData, sortBy, sortDirection]);

    const totalPages = Math.ceil(sortedData.length / itemsPerPage);
    const paginatedData = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        return sortedData.slice(startIndex, endIndex);
    }, [sortedData, currentPage, itemsPerPage]);

    const handleSort = (columnAccessor: keyof T) => {
        if (sortBy === columnAccessor) {
            setSortDirection(prev => (prev === 'asc' ? 'desc' : 'asc'));
        } else {
            setSortBy(columnAccessor);
            setSortDirection('asc');
        }
    };

    const getSortIndicator = (columnAccessor: keyof T) => {
        if (sortBy === columnAccessor) {
            return sortDirection === 'asc' ? <ChevronUpIcon className="h-4 w-4 ml-1" /> : <ChevronDownIcon className="h-4 w-4 ml-1" />;
        }
        return null;
    };

    return (
        <Card title={title}>
            <div className="mb-4 flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0">
                <div className="flex items-center w-full md:w-1/2 relative">
                    <SearchIcon className="absolute left-3 text-gray-400 h-5 w-5" />
                    <input
                        type="text"
                        placeholder={searchPlaceholder}
                        className="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                </div>
                <div className="flex items-center space-x-2">
                    <span className="text-gray-400 text-sm">Items per page:</span>
                    <select
                        className="bg-gray-700 border border-gray-600 rounded-md text-white py-1 px-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        value={itemsPerPage}
                        onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); }}
                    >
                        {[5, 10, 25, 50, 100].map(num => (
                            <option key={num} value={num}>{num}</option>
                        ))}
                    </select>
                </div>
            </div>
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-700">
                    <thead className="bg-gray-800">
                        <tr>
                            {columns.map(col => (
                                <th
                                    key={String(col.accessor)}
                                    scope="col"
                                    className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer"
                                    onClick={() => handleSort(col.accessor)}
                                >
                                    <div className="flex items-center">
                                        {col.header}
                                        {getSortIndicator(col.accessor)}
                                    </div>
                                </th>
                            ))}
                            {actionButtons && <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>}
                        </tr>
                    </thead>
                    <tbody className="bg-gray-900 divide-y divide-gray-800">
                        {paginatedData.length === 0 ? (
                            <tr>
                                <td colSpan={columns.length + (actionButtons ? 1 : 0)} className="px-6 py-4 text-center text-gray-400">
                                    No data found.
                                </td>
                            </tr>
                        ) : (
                            paginatedData.map((item, rowIndex) => (
                                <tr
                                    key={item.id || rowIndex}
                                    className={`hover:bg-gray-800 transition duration-150 ease-in-out ${onRowClick ? 'cursor-pointer' : ''}`}
                                    onClick={() => onRowClick?.(item)}
                                >
                                    {columns.map(col => (
                                        <td key={String(col.accessor)} className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                            {col.render ? col.render(item) : String(item[col.accessor])}
                                        </td>
                                    ))}
                                    {actionButtons && (
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            {actionButtons(item)}
                                        </td>
                                    )}
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
            <div className="mt-4 flex flex-col md:flex-row items-center justify-between space-y-3 md:space-y-0">
                <span className="text-sm text-gray-400">
                    Showing {Math.min(sortedData.length, (currentPage - 1) * itemsPerPage + 1)} to {Math.min(sortedData.length, currentPage * itemsPerPage)} of {sortedData.length} entries
                </span>
                <div className="flex items-center space-x-1">
                    <button
                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                        disabled={currentPage === 1}
                        className="px-3 py-1 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Previous
                    </button>
                    {Array.from({ length: totalPages }).map((_, index) => {
                        const pageNum = index + 1;
                        if (totalPages <= 5 || (pageNum >= currentPage - 2 && pageNum <= currentPage + 2) || pageNum === 1 || pageNum === totalPages) {
                            if ((pageNum === currentPage - 3 && pageNum > 1) || (pageNum === currentPage + 3 && pageNum < totalPages)) {
                                return <span key={`ellipsis-${index}`} className="px-3 py-1 text-gray-400">...</span>;
                            }
                            return (
                                <button
                                    key={pageNum}
                                    onClick={() => setCurrentPage(pageNum)}
                                    className={`px-3 py-1 rounded-md ${currentPage === pageNum ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}
                                >
                                    {pageNum}
                                </button>
                            );
                        }
                        return null;
                    })}
                    <button
                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                        disabled={currentPage === totalPages}
                        className="px-3 py-1 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Next
                    </button>
                </div>
            </div>
        </Card>
    );
};

interface DetailPanelProps {
    title: string;
    children: React.ReactNode;
    onClose: () => void;
}

export const DetailPanel: React.FC<DetailPanelProps> = ({ title, children, onClose }) => {
    return (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex justify-end">
            <div className="relative w-full md:w-1/2 lg:w-1/3 bg-gray-800 shadow-xl flex flex-col">
                <div className="flex justify-between items-center p-6 border-b border-gray-700">
                    <h3 className="text-2xl font-bold text-white">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white transition duration-200">
                        <XIcon className="h-6 w-6" />
                    </button>
                </div>
                <div className="p-6 flex-grow overflow-y-auto custom-scrollbar">
                    {children}
                </div>
            </div>
        </div>
    );
};

export const LoadingSpinner: React.FC = () => (
    <div className="flex justify-center items-center h-full min-h-[200px]">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500"></div>
        <span className="ml-3 text-gray-400">Loading data...</span>
    </div>
);

// --- Dashboard Widgets ---

export const GlobalThreatSummaryWidget: React.FC = () => {
    const { globalSummary, refreshData } = useThreatIntelligence();
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        // Simulate loading
        const timer = setTimeout(() => setIsLoading(false), 1000);
        return () => clearTimeout(timer);
    }, [globalSummary]);

    const dataPoints = useMemo(() => [
        { label: "Active Threat Actors", value: globalSummary.totalActiveThreatActors, icon: UsersIcon, color: "text-red-400" },
        { label: "Critical Vulnerabilities", value: globalSummary.criticalVulnerabilities, icon: AlertOctagonIcon, color: "text-yellow-400" },
        { label: "New IoCs (24h)", value: globalSummary.newIoCsLast24h, icon: PlusIcon, color: "text-blue-400" },
        { label: "Ongoing Campaigns", value: globalSummary.ongoingCampaigns, icon: TargetIcon, color: "text-green-400" },
    ], [globalSummary]);

    const COLORS = ['#8884d8', '#82ca9d', '#ffc658', '#FF8042', '#AF19FF', '#FF0000'];

    if (isLoading) return <LoadingSpinner />;

    return (
        <Card title="Global Threat Summary" className="col-span-1 md:col-span-3 lg:col-span-2">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                {dataPoints.map((item, index) => (
                    <div key={index} className="flex items-center p-4 bg-gray-700 rounded-md shadow-md">
                        <item.icon className={`h-8 w-8 mr-3 ${item.color}`} />
                        <div>
                            <p className="text-xl font-bold text-white">{item.value}</p>
                            <p className="text-sm text-gray-400">{item.label}</p>
                        </div>
                    </div>
                ))}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 className="text-lg font-semibold text-white mb-3 flex items-center"><TrendingUpIcon className="h-5 w-5 mr-2 text-blue-400" />Global Risk Score: <span className="ml-2 text-xl font-bold" style={{ color: globalSummary.globalRiskScore > 70 ? '#EF4444' : globalSummary.globalRiskScore > 40 ? '#F59E0B' : '#34D399' }}>{globalSummary.globalRiskScore}</span></h4>
                    <ResponsiveContainer width="100%" height={200}>
                        <AreaChart
                            data={[{ name: 'Score', value: globalSummary.globalRiskScore }]} // Dynamic data for real-time would be better
                            margin={{ top: 10, right: 30, left: 0, bottom: 0 }}
                        >
                            <XAxis dataKey="name" stroke="#6b7280" />
                            <YAxis domain={[0, 100]} stroke="#6b7280" />
                            <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: 'none' }} itemStyle={{ color: '#e5e7eb' }} />
                            <Area type="monotone" dataKey="value" stroke="#8884d8" fill="#8884d8" fillOpacity={0.6} />
                        </AreaChart>
                    </ResponsiveContainer>
                    <p className="text-gray-400 text-sm mt-2">Overall platform risk level, calculated from aggregated threat data. </p>
                </div>

                <div>
                    <h4 className="text-lg font-semibold text-white mb-3 flex items-center"><ZapIcon className="h-5 w-5 mr-2 text-yellow-400" />Top Attack Types Today</h4>
                    <ResponsiveContainer width="100%" height={200}>
                        <PieChart>
                            <Pie
                                data={globalSummary.topAttacksToday}
                                cx="50%"
                                cy="50%"
                                labelLine={false}
                                outerRadius={80}
                                fill="#8884d8"
                                dataKey="count"
                                nameKey="type"
                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                            >
                                {globalSummary.topAttacksToday.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                            </Pie>
                            <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: 'none' }} itemStyle={{ color: '#e5e7eb' }} />
                            <Legend />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
            </div>
            <div className="mt-6 flex justify-end">
                <button
                    onClick={refreshData}
                    className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 ease-in-out"
                >
                    <RefreshIcon className="h-5 w-5 mr-2" /> Refresh Data
                </button>
            </div>
        </Card>
    );
};

export const IoCThreatFeedWidget: React.FC = () => {
    const { ioCs, addIoC, updateIoC, deleteIoC } = useThreatIntelligence();
    const [selectedIoC, setSelectedIoC] = useState<IoC | null>(null);
    const [isAddingNew, setIsAddingNew] = useState(false);
    const [formState, setFormState] = useState<Partial<IoC>>({});

    const handleFormChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target;
        setFormState(prev => ({ ...prev, [name]: value }));
    };

    const handleSaveIoC = () => {
        if (isAddingNew) {
            addIoC({
                id: generateRandomId(),
                timestamp: new Date().toISOString(),
                firstSeen: new Date().toISOString(),
                lastSeen: new Date().toISOString(),
                tags: (formState.tags as string[] | undefined) || [],
                confidence: formState.confidence || 0,
                description: formState.description || '',
                ...formState
            } as IoC);
        } else if (selectedIoC) {
            updateIoC({ ...selectedIoC, ...formState });
        }
        setSelectedIoC(null);
        setIsAddingNew(false);
        setFormState({});
    };

    const handleCancelEdit = () => {
        setSelectedIoC(null);
        setIsAddingNew(false);
        setFormState({});
    };

    const IoCDetailPanelContent: React.FC<{ ioc: IoC }> = ({ ioc }) => (
        <>
            <p className="text-gray-300 mb-4">{ioc.description || "No description available."}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Type:</span> <span className="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">{ioc.type}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Value:</span> <span className="font-mono text-purple-300 break-all">{ioc.value}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Severity:</span> <span className={`px-2 py-1 text-xs rounded-full ${ioc.severity === 'critical' ? 'bg-red-500' : ioc.severity === 'high' ? 'bg-orange-500' : ioc.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{ioc.severity}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Confidence:</span> <span className="text-white">{ioc.confidence}%</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Source:</span> <span className="text-white">{ioc.source}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">First Seen:</span> <span className="text-gray-400">{new Date(ioc.firstSeen).toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Seen:</span> <span className="text-gray-400">{new Date(ioc.lastSeen).toLocaleString()}</span></div>
                <div>
                    <span className="font-semibold text-gray-300">Tags:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {ioc.tags.map(tag => (
                            <span key={tag} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{tag}</span>
                        ))}
                    </div>
                </div>
            </div>
            <div className="mt-6 flex justify-end space-x-2">
                <button
                    onClick={() => { setFormState(ioc); setIsAddingNew(false); }}
                    className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300"
                >
                    <EditIcon className="h-4 w-4 mr-2" /> Edit
                </button>
                <button
                    onClick={() => { if (window.confirm(`Are you sure you want to delete IoC: ${ioc.value}?`)) deleteIoC(ioc.id); setSelectedIoC(null); }}
                    className="flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300"
                >
                    <Trash2Icon className="h-4 w-4 mr-2" /> Delete
                </button>
            </div>
        </>
    );

    const IoCForm: React.FC = () => (
        <div className="space-y-4">
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="type">Type</label>
                <select
                    id="type"
                    name="type"
                    value={formState.type || ''}
                    onChange={handleFormChange}
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                    required
                >
                    <option value="">Select Type</option>
                    {['IP', 'Domain', 'Hash', 'URL', 'Email', 'FilePath', 'Mutex', 'RegistryKey'].map(type => (
                        <option key={type} value={type}>{type}</option>
                    ))}
                </select>
            </div>
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="value">Value</label>
                <input
                    type="text"
                    id="value"
                    name="value"
                    value={formState.value || ''}
                    onChange={handleFormChange}
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                    required
                />
            </div>
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="severity">Severity</label>
                <select
                    id="severity"
                    name="severity"
                    value={formState.severity || ''}
                    onChange={handleFormChange}
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                    required
                >
                    <option value="">Select Severity</option>
                    {['low', 'medium', 'high', 'critical'].map(sev => (
                        <option key={sev} value={sev}>{sev}</option>
                    ))}
                </select>
            </div>
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="source">Source</label>
                <input
                    type="text"
                    id="source"
                    name="source"
                    value={formState.source || ''}
                    onChange={handleFormChange}
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                />
            </div>
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="confidence">Confidence (%)</label>
                <input
                    type="number"
                    id="confidence"
                    name="confidence"
                    value={formState.confidence || 0}
                    onChange={handleFormChange}
                    min="0"
                    max="100"
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                />
            </div>
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="description">Description</label>
                <textarea
                    id="description"
                    name="description"
                    value={formState.description || ''}
                    onChange={handleFormChange}
                    rows={3}
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                ></textarea>
            </div>
            <div>
                <label className="block text-gray-300 text-sm font-bold mb-2" htmlFor="tags">Tags (comma-separated)</label>
                <input
                    type="text"
                    id="tags"
                    name="tags"
                    value={(formState.tags as string[] || []).join(', ')}
                    onChange={(e) => setFormState(prev => ({ ...prev, tags: e.target.value.split(',').map(tag => tag.trim()).filter(tag => tag) }))}
                    className="bg-gray-700 border border-gray-600 rounded-md text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                />
            </div>

            <div className="flex justify-end space-x-2 mt-6">
                <button
                    onClick={handleCancelEdit}
                    className="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-300"
                >
                    Cancel
                </button>
                <button
                    onClick={handleSaveIoC}
                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300"
                >
                    Save IoC
                </button>
            </div>
        </div>
    );

    const iocColumns = useMemo(() => [
        { header: "Type", accessor: "type" },
        { header: "Value", accessor: "value", render: (ioc: IoC) => <span className="font-mono text-purple-300 break-all">{ioc.value}</span> },
        { header: "Severity", accessor: "severity", render: (ioc: IoC) => (
            <span className={`px-2 py-1 text-xs rounded-full ${ioc.severity === 'critical' ? 'bg-red-500' : ioc.severity === 'high' ? 'bg-orange-500' : ioc.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {ioc.severity}
            </span>
        )},
        { header: "Confidence", accessor: "confidence", render: (ioc: IoC) => `${ioc.confidence}%` },
        { header: "Source", accessor: "source" },
        { header: "Last Seen", accessor: "lastSeen", render: (ioc: IoC) => new Date(ioc.lastSeen).toLocaleDateString() },
    ], []);

    return (
        <Card title="Indicators of Compromise (IoCs)" className="col-span-1 md:col-span-3">
            <div className="mb-4 flex justify-end">
                <button
                    onClick={() => { setIsAddingNew(true); setFormState({}); setSelectedIoC(null); }}
                    className="flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300 ease-in-out"
                >
                    <PlusIcon className="h-5 w-5 mr-2" /> Add New IoC
                </button>
            </div>
            <FilterableTable
                data={ioCs}
                columns={iocColumns}
                title="IoC List"
                initialSortBy="lastSeen"
                initialSortDirection="desc"
                searchPlaceholder="Search IoCs..."
                onRowClick={setSelectedIoC}
                actionButtons={(ioc) => (
                    <div className="flex space-x-2">
                        <button onClick={(e) => { e.stopPropagation(); setFormState(ioc); setIsAddingNew(false); }} className="text-purple-400 hover:text-purple-300"><EditIcon className="h-4 w-4" /></button>
                        <button onClick={(e) => { e.stopPropagation(); if (window.confirm(`Delete ${ioc.value}?`)) deleteIoC(ioc.id); }} className="text-red-400 hover:text-red-300"><Trash2Icon className="h-4 w-4" /></button>
                    </div>
                )}
            />

            {(selectedIoC || isAddingNew || (formState.id && !isAddingNew)) && (
                <DetailPanel title={isAddingNew ? "Add New IoC" : (formState.id ? `Edit IoC: ${formState.value}` : `IoC Details: ${selectedIoC?.value}`)} onClose={handleCancelEdit}>
                    {isAddingNew || formState.id ? <IoCForm /> : (selectedIoC && <IoCDetailPanelContent ioc={selectedIoC} />)}
                </DetailPanel>
            )}
        </Card>
    );
};

export const ThreatActorProfiling: React.FC = () => {
    const { threatActors } = useThreatIntelligence();
    const [selectedActor, setSelectedActor] = useState<ThreatActor | null>(null);

    const actorColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Origin", accessor: "origin" },
        { header: "Motives", accessor: "motives", render: (actor: ThreatActor) => actor.motives.join(', ') },
        { header: "Severity", accessor: "severity", render: (actor: ThreatActor) => (
            <span className={`px-2 py-1 text-xs rounded-full ${actor.severity === 'critical' ? 'bg-red-500' : actor.severity === 'high' ? 'bg-orange-500' : actor.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {actor.severity}
            </span>
        )},
        { header: "Last Activity", accessor: "lastActivity", render: (actor: ThreatActor) => new Date(actor.lastActivity).toLocaleDateString() },
        { header: "Confidence", accessor: "confidence", render: (actor: ThreatActor) => `${actor.confidence}%` },
    ], []);

    const ActorDetailPanelContent: React.FC<{ actor: ThreatActor }> = ({ actor }) => (
        <>
            <p className="text-gray-300 mb-4">{actor.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Origin:</span> <span className="text-white">{actor.origin}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Severity:</span> <span className={`px-2 py-1 text-xs rounded-full ${actor.severity === 'critical' ? 'bg-red-500' : actor.severity === 'high' ? 'bg-orange-500' : actor.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{actor.severity}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Confidence:</span> <span className="text-white">{actor.confidence}%</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Activity:</span> <span className="text-gray-400">{new Date(actor.lastActivity).toLocaleString()}</span></div>
                <div>
                    <span className="font-semibold text-gray-300">Motives:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {actor.motives.map(m => <span key={m} className="bg-blue-700 text-white text-xs px-2 py-1 rounded-full">{m}</span>)}
                    </div>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Techniques:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {actor.techniques.map(t => <span key={t} className="bg-purple-700 text-white text-xs px-2 py-1 rounded-full">{t}</span>)}
                    </div>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Associated Campaigns:</span>
                    <ul className="list-disc list-inside text-gray-400 mt-1 pl-4">
                        {actor.associatedCampaigns.map(c => <li key={c}>{c}</li>)}
                    </ul>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Mitigation Strategies:</span>
                    <ul className="list-disc list-inside text-gray-400 mt-1 pl-4">
                        {actor.mitigationStrategies.map(m => <li key={m}>{m}</li>)}
                    </ul>
                </div>
                {actor.indicatorsOfCompromise.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Related IoCs:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {actor.indicatorsOfCompromise.map(ioc => (
                                <li key={ioc.id}>{ioc.type}: {ioc.value} <span className="text-xs text-gray-500">({ioc.severity})</span></li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>
            {/* Add edit/delete functionality here similar to IoC if needed */}
        </>
    );

    return (
        <Card title="Threat Actor Profiling" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={threatActors}
                columns={actorColumns}
                title="Known Threat Actors"
                initialSortBy="lastActivity"
                initialSortDirection="desc"
                searchPlaceholder="Search threat actors..."
                onRowClick={setSelectedActor}
            />

            {selectedActor && (
                <DetailPanel title={`Threat Actor: ${selectedActor.name}`} onClose={() => setSelectedActor(null)}>
                    <ActorDetailPanelContent actor={selectedActor} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const VulnerabilityManagement: React.FC = () => {
    const { vulnerabilities } = useThreatIntelligence();
    const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);

    const vulnColumns = useMemo(() => [
        { header: "CVE ID", accessor: "cveId" },
        { header: "Name", accessor: "name" },
        { header: "Severity", accessor: "severity", render: (vuln: Vulnerability) => (
            <span className={`px-2 py-1 text-xs rounded-full ${vuln.severity === 'critical' ? 'bg-red-500' : vuln.severity === 'high' ? 'bg-orange-500' : vuln.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {vuln.severity}
            </span>
        )},
        { header: "CVSS Score", accessor: "cvssScore" },
        { header: "Exploit Available", accessor: "exploitAvailable", render: (vuln: Vulnerability) => vuln.exploitAvailable ? <CheckCircleIcon className="h-5 w-5 text-red-500" /> : <XCircleIcon className="h-5 w-5 text-green-500" /> },
        { header: "Patch Available", accessor: "patchAvailable", render: (vuln: Vulnerability) => vuln.patchAvailable ? <CheckCircleIcon className="h-5 w-5 text-green-500" /> : <AlertTriangleIcon className="h-5 w-5 text-yellow-500" /> },
        { header: "Published Date", accessor: "publishedDate", render: (vuln: Vulnerability) => new Date(vuln.publishedDate).toLocaleDateString() },
    ], []);

    const VulnDetailPanelContent: React.FC<{ vuln: Vulnerability }> = ({ vuln }) => (
        <>
            <p className="text-gray-300 mb-4">{vuln.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">CVE ID:</span> <span className="text-white font-mono">{vuln.cveId}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Severity:</span> <span className={`px-2 py-1 text-xs rounded-full ${vuln.severity === 'critical' ? 'bg-red-500' : vuln.severity === 'high' ? 'bg-orange-500' : vuln.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{vuln.severity}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">CVSS Score:</span> <span className="text-white text-lg font-bold">{vuln.cvssScore}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Exploit Available:</span> {vuln.exploitAvailable ? <CheckCircleIcon className="h-5 w-5 text-red-500" /> : <XCircleIcon className="h-5 w-5 text-green-500" />}</div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Patch Available:</span> {vuln.patchAvailable ? <CheckCircleIcon className="h-5 w-5 text-green-500" /> : <AlertTriangleIcon className="h-5 w-5 text-yellow-500" />}</div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Published:</span> <span className="text-gray-400">{new Date(vuln.publishedDate).toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Updated:</span> <span className="text-gray-400">{new Date(vuln.updatedDate).toLocaleString()}</span></div>
                <div>
                    <span className="font-semibold text-gray-300">Affected Products:</span>
                    <ul className="list-disc list-inside text-gray-400 mt-1 pl-4">
                        {vuln.affectedProducts.map(p => <li key={p}>{p}</li>)}
                    </ul>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Remediation Steps:</span>
                    <ul className="list-disc list-inside text-gray-400 mt-1 pl-4">
                        {vuln.remediationSteps.map(step => <li key={step}>{step}</li>)}
                    </ul>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">References:</span>
                    <ul className="list-disc list-inside text-blue-400 mt-1 pl-4">
                        {vuln.references.map(ref => <li key={ref}><a href={ref} target="_blank" rel="noopener noreferrer" className="hover:underline flex items-center">{ref} <ExternalLinkIcon className="h-4 w-4 ml-1" /></a></li>)}
                    </ul>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Tags:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {vuln.tags.map(tag => <span key={tag} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{tag}</span>)}
                    </div>
                </div>
            </div>
        </>
    );

    return (
        <Card title="Vulnerability Management" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={vulnerabilities}
                columns={vulnColumns}
                title="Known Vulnerabilities"
                initialSortBy="cvssScore"
                initialSortDirection="desc"
                searchPlaceholder="Search vulnerabilities..."
                onRowClick={setSelectedVuln}
            />

            {selectedVuln && (
                <DetailPanel title={`Vulnerability: ${selectedVuln.cveId}`} onClose={() => setSelectedVuln(null)}>
                    <VulnDetailPanelContent vuln={selectedVuln} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const AttackSurfaceManagement: React.FC = () => {
    const { assets, vulnerabilities } = useThreatIntelligence();
    const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);

    const assetColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Type", accessor: "type" },
        { header: "IP Address", accessor: "ipAddress" },
        { header: "Criticality", accessor: "criticality", render: (asset: Asset) => (
            <span className={`px-2 py-1 text-xs rounded-full ${asset.criticality === 'critical' ? 'bg-red-500' : asset.criticality === 'high' ? 'bg-orange-500' : asset.criticality === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {asset.criticality}
            </span>
        )},
        { header: "Status", accessor: "status", render: (asset: Asset) => (
            <span className={`px-2 py-1 text-xs rounded-full ${asset.status === 'compromised' ? 'bg-red-500' : asset.status === 'online' ? 'bg-green-500' : 'bg-gray-500'} text-white`}>
                {asset.status}
            </span>
        )},
        { header: "Last Scanned", accessor: "lastScanned", render: (asset: Asset) => new Date(asset.lastScanned).toLocaleDateString() },
        { header: "Vulnerabilities", accessor: "vulnerabilities", render: (asset: Asset) => (
            <span className={`font-bold ${asset.vulnerabilities.length > 0 ? 'text-red-400' : 'text-green-400'}`}>
                {asset.vulnerabilities.length}
            </span>
        )},
    ], []);

    const AssetDetailPanelContent: React.FC<{ asset: Asset }> = ({ asset }) => {
        const assetVulns = vulnerabilities.filter(v => asset.vulnerabilities.includes(v.cveId));
        return (
            <>
                <p className="text-gray-300 mb-4">Detailed information about the asset, its configuration, and associated risks.</p>
                <div className="space-y-3 text-sm">
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Type:</span> <span className="text-white">{asset.type}</span></div>
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">IP Address:</span> <span className="text-white font-mono">{asset.ipAddress}</span></div>
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Criticality:</span> <span className={`px-2 py-1 text-xs rounded-full ${asset.criticality === 'critical' ? 'bg-red-500' : asset.criticality === 'high' ? 'bg-orange-500' : asset.criticality === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{asset.criticality}</span></div>
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Owner:</span> <span className="text-white">{asset.owner}</span></div>
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${asset.status === 'compromised' ? 'bg-red-500' : asset.status === 'online' ? 'bg-green-500' : 'bg-gray-500'} text-white`}>{asset.status}</span></div>
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Geolocation:</span> <span className="text-white">{asset.geolocation}</span></div>
                    <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Scanned:</span> <span className="text-gray-400">{new Date(asset.lastScanned).toLocaleString()}</span></div>
                    {asset.osVersion && <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">OS Version:</span> <span className="text-white">{asset.osVersion}</span></div>}
                    {asset.firmwareVersion && <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Firmware:</span> <span className="text-white">{asset.firmwareVersion}</span></div>}
                    {asset.installedSoftware && asset.installedSoftware.length > 0 && (
                        <div>
                            <span className="font-semibold text-gray-300">Installed Software:</span>
                            <ul className="list-disc list-inside text-gray-400 mt-1 pl-4">
                                {asset.installedSoftware.map(sw => <li key={sw}>{sw}</li>)}
                            </ul>
                        </div>
                    )}
                    {assetVulns.length > 0 && (
                        <div className="mt-4">
                            <h4 className="font-semibold text-white">Associated Vulnerabilities ({assetVulns.length}):</h4>
                            <ul className="list-disc list-inside text-red-400 pl-4">
                                {assetVulns.map(v => (
                                    <li key={v.cveId} className="hover:underline cursor-pointer" onClick={() => {/* Future: navigate to vuln detail */}}>
                                        {v.cveId} - {v.name} <span className="text-xs text-gray-500">({v.severity}, CVSS: {v.cvssScore})</span>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            </>
        );
    };

    return (
        <Card title="Attack Surface Management" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={assets}
                columns={assetColumns}
                title="Asset Inventory"
                initialSortBy="criticality"
                initialSortDirection="desc"
                searchPlaceholder="Search assets..."
                onRowClick={setSelectedAsset}
            />

            {selectedAsset && (
                <DetailPanel title={`Asset Details: ${selectedAsset.name}`} onClose={() => setSelectedAsset(null)}>
                    <AssetDetailPanelContent asset={selectedAsset} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const RedTeamSimulationDashboard: React.FC = () => {
    const { attackSimulations } = useThreatIntelligence();
    const [selectedSimulation, setSelectedSimulation] = useState<AttackSimulationResult | null>(null);

    const simulationColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Target System", accessor: "targetSystem" },
        { header: "Adversary", accessor: "adversaryEmulation" },
        { header: "Status", accessor: "status", render: (sim: AttackSimulationResult) => (
            <span className={`px-2 py-1 text-xs rounded-full ${sim.status === 'completed' ? 'bg-green-500' : sim.status === 'failed' ? 'bg-red-500' : sim.status === 'running' ? 'bg-blue-500' : 'bg-gray-500'} text-white`}>
                {sim.status}
            </span>
        )},
        { header: "Detection Rate", accessor: "detectionRate", render: (sim: AttackSimulationResult) => `${sim.detectionRate}%` },
        { header: "Prevention Rate", accessor: "preventionRate", render: (sim: AttackSimulationResult) => `${sim.preventionRate}%` },
        { header: "End Time", accessor: "endTime", render: (sim: AttackSimulationResult) => new Date(sim.endTime).toLocaleDateString() },
        { header: "Risk Score Change", accessor: "riskScoreChange", render: (sim: AttackSimulationResult) => (
            <span className={sim.riskScoreChange < 0 ? 'text-green-400' : sim.riskScoreChange > 0 ? 'text-red-400' : 'text-gray-400'}>
                {sim.riskScoreChange > 0 ? '+' : ''}{sim.riskScoreChange}
            </span>
        )},
    ], []);

    const SimulationDetailPanelContent: React.FC<{ simulation: AttackSimulationResult }> = ({ simulation }) => (
        <>
            <p className="text-gray-300 mb-4">Detailed results and recommendations from the simulated attack.</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Target System:</span> <span className="text-white">{simulation.targetSystem}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Attack Vector:</span> <span className="text-white">{simulation.attackVector}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Adversary Emulation:</span> <span className="text-white">{simulation.adversaryEmulation}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${simulation.status === 'completed' ? 'bg-green-500' : simulation.status === 'failed' ? 'bg-red-500' : simulation.status === 'running' ? 'bg-blue-500' : 'bg-gray-500'} text-white`}>{simulation.status}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Detection Rate:</span> <span className="text-white font-bold">{simulation.detectionRate}%</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Prevention Rate:</span> <span className="text-white font-bold">{simulation.preventionRate}%</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Risk Score Change:</span> <span className={simulation.riskScoreChange < 0 ? 'text-green-400 font-bold' : simulation.riskScoreChange > 0 ? 'text-red-400 font-bold' : 'text-gray-400 font-bold'}>{simulation.riskScoreChange > 0 ? '+' : ''}{simulation.riskScoreChange}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Start Time:</span> <span className="text-gray-400">{new Date(simulation.startTime).toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">End Time:</span> <span className="text-gray-400">{new Date(simulation.endTime).toLocaleString()}</span></div>
                {simulation.vulnerabilitiesExploited.length > 0 && (
                    <div>
                        <span className="font-semibold text-gray-300">Vulnerabilities Exploited:</span>
                        <ul className="list-disc list-inside text-red-400 mt-1 pl-4">
                            {simulation.vulnerabilitiesExploited.map(cve => <li key={cve}>{cve}</li>)}
                        </ul>
                    </div>
                )}
                <div>
                    <span className="font-semibold text-gray-300">Mitigation Recommendations:</span>
                    <ul className="list-disc list-inside text-gray-400 mt-1 pl-4">
                        {simulation.mitigationRecommendations.map(rec => <li key={rec}>{rec}</li>)}
                    </ul>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Report:</span>
                    <a href={simulation.reportUrl} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline flex items-center mt-1"><FileTextIcon className="h-4 w-4 mr-2" /> View Full Report <ExternalLinkIcon className="h-4 w-4 ml-1" /></a>
                </div>
                {simulation.logs.length > 0 && (
                    <div className="mt-4">
                        <span className="font-semibold text-gray-300">Simulation Logs (Excerpts):</span>
                        <div className="bg-gray-700 text-gray-300 p-3 rounded-md max-h-40 overflow-y-auto font-mono text-xs mt-1">
                            {simulation.logs.map((log, i) => <p key={i}>{log}</p>)}
                        </div>
                    </div>
                )}
            </div>
        </>
    );

    return (
        <Card title="Red-Team Simulation Dashboard" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={attackSimulations}
                columns={simulationColumns}
                title="Simulation Results"
                initialSortBy="endTime"
                initialSortDirection="desc"
                searchPlaceholder="Search simulations..."
                onRowClick={setSelectedSimulation}
            />

            {selectedSimulation && (
                <DetailPanel title={`Simulation: ${selectedSimulation.name}`} onClose={() => setSelectedSimulation(null)}>
                    <SimulationDetailPanelContent simulation={selectedSimulation} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const AITrainingAndPerformance: React.FC = () => {
    const { aiModelConfigs } = useThreatIntelligence();
    const [selectedModel, setSelectedModel] = useState<AIModelConfig | null>(null);

    const modelColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Type", accessor: "modelType" },
        { header: "Status", accessor: "status", render: (model: AIModelConfig) => (
            <span className={`px-2 py-1 text-xs rounded-full ${model.status === 'active' ? 'bg-green-500' : model.status === 'training' ? 'bg-blue-500' : model.status === 'error' ? 'bg-red-500' : 'bg-gray-500'} text-white`}>
                {model.status}
            </span>
        )},
        { header: "Accuracy", accessor: "performanceMetrics", render: (model: AIModelConfig) => `${(model.performanceMetrics.accuracy * 100).toFixed(1)}%` },
        { header: "Last Trained", accessor: "lastTrained", render: (model: AIModelConfig) => new Date(model.lastTrained).toLocaleDateString() },
        { header: "Version", accessor: "version" },
    ], []);

    const ModelDetailPanelContent: React.FC<{ model: AIModelConfig }> = ({ model }) => (
        <>
            <p className="text-gray-300 mb-4">{model.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Model Type:</span> <span className="text-white">{model.modelType}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${model.status === 'active' ? 'bg-green-500' : model.status === 'training' ? 'bg-blue-500' : model.status === 'error' ? 'bg-red-500' : 'bg-gray-500'} text-white`}>{model.status}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Version:</span> <span className="text-white">{model.version}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Trained:</span> <span className="text-gray-400">{new Date(model.lastTrained).toLocaleString()}</span></div>

                <div className="mt-4">
                    <h4 className="font-semibold text-white">Performance Metrics:</h4>
                    <div className="grid grid-cols-2 gap-2 text-gray-400">
                        <p>Accuracy: <span className="font-bold text-white">{(model.performanceMetrics.accuracy * 100).toFixed(1)}%</span></p>
                        <p>Precision: <span className="font-bold text-white">{(model.performanceMetrics.precision * 100).toFixed(1)}%</span></p>
                        <p>Recall: <span className="font-bold text-white">{(model.performanceMetrics.recall * 100).toFixed(1)}%</span></p>
                        <p>F1 Score: <span className="font-bold text-white">{(model.performanceMetrics.f1Score * 100).toFixed(1)}%</span></p>
                    </div>
                    <ResponsiveContainer width="100%" height={200}>
                        <RadarChart outerRadius={90} data={[
                            { subject: 'Accuracy', A: model.performanceMetrics.accuracy * 100, fullMark: 100 },
                            { subject: 'Precision', A: model.performanceMetrics.precision * 100, fullMark: 100 },
                            { subject: 'Recall', A: model.performanceMetrics.recall * 100, fullMark: 100 },
                            { subject: 'F1 Score', A: model.performanceMetrics.f1Score * 100, fullMark: 100 },
                        ]}>
                            <PolarGrid stroke="#4b5563" />
                            <PolarAngleAxis dataKey="subject" stroke="#e5e7eb" />
                            <PolarRadiusAxis angle={30} domain={[0, 100]} stroke="#6b7280" />
                            <Radar name={model.name} dataKey="A" stroke="#8884d8" fill="#8884d8" fillOpacity={0.6} />
                            <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: 'none' }} itemStyle={{ color: '#e5e7eb' }} />
                        </RadarChart>
                    </ResponsiveContainer>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Input Features:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {model.inputFeatures.map(f => <span key={f} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{f}</span>)}
                    </div>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Output Schema:</span>
                    <p className="bg-gray-700 text-gray-300 p-2 rounded-md font-mono text-xs mt-1">{model.outputSchema}</p>
                </div>
                <div>
                    <span className="font-semibold text-gray-300">Tags:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {model.tags.map(tag => <span key={tag} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{tag}</span>)}
                    </div>
                </div>
            </div>
            <div className="mt-6 flex justify-end space-x-2">
                <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                    <PlayIcon className="h-4 w-4 mr-2" /> Re-train Model
                </button>
                <button className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300">
                    <SettingsIcon className="h-4 w-4 mr-2" /> Configure
                </button>
            </div>
        </>
    );

    return (
        <Card title="AI Model Training & Performance" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={aiModelConfigs}
                columns={modelColumns}
                title="AI Models"
                initialSortBy="performanceMetrics"
                initialSortDirection="desc"
                searchPlaceholder="Search AI models..."
                onRowClick={setSelectedModel}
            />

            {selectedModel && (
                <DetailPanel title={`AI Model: ${selectedModel.name}`} onClose={() => setSelectedModel(null)}>
                    <ModelDetailPanelContent model={selectedModel} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const ThreatReportsAndAnalysis: React.FC = () => {
    const { threatReports } = useThreatIntelligence();
    const [selectedReport, setSelectedReport] = useState<ThreatReport | null>(null);

    const reportColumns = useMemo(() => [
        { header: "Title", accessor: "title" },
        { header: "Author", accessor: "author" },
        { header: "Publish Date", accessor: "publishDate", render: (report: ThreatReport) => new Date(report.publishDate).toLocaleDateString() },
        { header: "Sentiment", accessor: "sentiment", render: (report: ThreatReport) => (
            <span className={`px-2 py-1 text-xs rounded-full ${report.sentiment === 'negative' ? 'bg-red-500' : report.sentiment === 'positive' ? 'bg-green-500' : 'bg-gray-500'} text-white`}>
                {report.sentiment}
            </span>
        )},
        { header: "Confidence", accessor: "confidence", render: (report: ThreatReport) => `${report.confidence}%` },
    ], []);

    const ReportDetailPanelContent: React.FC<{ report: ThreatReport }> = ({ report }) => (
        <>
            <p className="text-gray-300 italic mb-4">{report.summary}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Author:</span> <span className="text-white">{report.author}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Publish Date:</span> <span className="text-gray-400">{new Date(report.publishDate).toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Sentiment:</span> <span className={`px-2 py-1 text-xs rounded-full ${report.sentiment === 'negative' ? 'bg-red-500' : report.sentiment === 'positive' ? 'bg-green-500' : 'bg-gray-500'} text-white`}>{report.sentiment}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Confidence:</span> <span className="text-white">{report.confidence}%</span></div>

                <div className="mt-4">
                    <h4 className="font-semibold text-white">Full Report Content:</h4>
                    <div className="bg-gray-700 text-gray-300 p-3 rounded-md max-h-60 overflow-y-auto custom-scrollbar text-sm">
                        {report.fullReportContent}
                    </div>
                </div>

                {report.relatedIoCs.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Related IoCs:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {report.relatedIoCs.map(ioc => (
                                <li key={ioc.id}>{ioc.type}: {ioc.value} <span className="text-xs text-gray-500">({ioc.severity})</span></li>
                            ))}
                        </ul>
                    </div>
                )}
                {report.relatedActors.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Related Threat Actors:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {report.relatedActors.map(actor => <li key={actor.id}>{actor.name} <span className="text-xs text-gray-500">({actor.origin})</span></li>)}
                        </ul>
                    </div>
                )}
                {report.relatedVulnerabilities.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Related Vulnerabilities:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {report.relatedVulnerabilities.map(vuln => <li key={vuln.cveId}>{vuln.cveId}: {vuln.name} <span className="text-xs text-gray-500">({vuln.severity})</span></li>)}
                        </ul>
                    </div>
                )}
                <div>
                    <span className="font-semibold text-gray-300">Tags:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {report.tags.map(tag => <span key={tag} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{tag}</span>)}
                    </div>
                </div>
            </div>
            <div className="mt-6 flex justify-end">
                <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                    <DownloadIcon className="h-4 w-4 mr-2" /> Download Report
                </button>
            </div>
        </>
    );

    return (
        <Card title="Threat Reports & Analysis" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={threatReports}
                columns={reportColumns}
                title="Threat Reports"
                initialSortBy="publishDate"
                initialSortDirection="desc"
                searchPlaceholder="Search reports..."
                onRowClick={setSelectedReport}
            />

            {selectedReport && (
                <DetailPanel title={`Threat Report: ${selectedReport.title}`} onClose={() => setSelectedReport(null)}>
                    <ReportDetailPanelContent report={selectedReport} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const SecurityPolicyDashboard: React.FC = () => {
    const { securityPolicies } = useThreatIntelligence();
    const [selectedPolicy, setSelectedPolicy] = useState<SecurityPolicy | null>(null);

    const policyColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Type", accessor: "type" },
        { header: "Status", accessor: "status", render: (policy: SecurityPolicy) => (
            <span className={`px-2 py-1 text-xs rounded-full ${policy.status === 'active' ? 'bg-green-500' : policy.status === 'inactive' ? 'bg-red-500' : 'bg-gray-500'} text-white`}>
                {policy.status}
            </span>
        )},
        { header: "Risk Level", accessor: "riskLevel", render: (policy: SecurityPolicy) => (
            <span className={`px-2 py-1 text-xs rounded-full ${policy.riskLevel === 'critical' ? 'bg-red-500' : policy.riskLevel === 'high' ? 'bg-orange-500' : policy.riskLevel === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {policy.riskLevel}
            </span>
        )},
        { header: "Last Updated", accessor: "lastUpdatedDate", render: (policy: SecurityPolicy) => new Date(policy.lastUpdatedDate).toLocaleDateString() },
        { header: "Compliance", accessor: "complianceStandards", render: (policy: SecurityPolicy) => policy.complianceStandards.join(', ') || 'N/A' },
    ], []);

    const PolicyDetailPanelContent: React.FC<{ policy: SecurityPolicy }> = ({ policy }) => (
        <>
            <p className="text-gray-300 mb-4">{policy.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Type:</span> <span className="text-white">{policy.type}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${policy.status === 'active' ? 'bg-green-500' : policy.status === 'inactive' ? 'bg-red-500' : 'bg-gray-500'} text-white`}>{policy.status}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Risk Level:</span> <span className={`px-2 py-1 text-xs rounded-full ${policy.riskLevel === 'critical' ? 'bg-red-500' : policy.riskLevel === 'high' ? 'bg-orange-500' : policy.riskLevel === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{policy.riskLevel}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Updated By:</span> <span className="text-white">{policy.lastUpdatedBy}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Updated Date:</span> <span className="text-gray-400">{new Date(policy.lastUpdatedDate).toLocaleString()}</span></div>

                {policy.rules.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Policy Rules:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {policy.rules.map((rule, i) => <li key={i}>{rule}</li>)}
                        </ul>
                    </div>
                )}
                {policy.enforcementPoints.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Enforcement Points:</h4>
                        <div className="flex flex-wrap gap-2 mt-1">
                            {policy.enforcementPoints.map(ep => <span key={ep} className="bg-blue-700 text-white text-xs px-2 py-1 rounded-full">{ep}</span>)}
                        </div>
                    </div>
                )}
                {policy.complianceStandards.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Compliance Standards:</h4>
                        <div className="flex flex-wrap gap-2 mt-1">
                            {policy.complianceStandards.map(cs => <span key={cs} className="bg-purple-700 text-white text-xs px-2 py-1 rounded-full">{cs}</span>)}
                        </div>
                    </div>
                )}
            </div>
            <div className="mt-6 flex justify-end">
                <button className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300">
                    <EditIcon className="h-4 w-4 mr-2" /> Edit Policy
                </button>
            </div>
        </>
    );

    return (
        <Card title="Security Policy Dashboard" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={securityPolicies}
                columns={policyColumns}
                title="Security Policies"
                initialSortBy="lastUpdatedDate"
                initialSortDirection="desc"
                searchPlaceholder="Search policies..."
                onRowClick={setSelectedPolicy}
            />

            {selectedPolicy && (
                <DetailPanel title={`Policy: ${selectedPolicy.name}`} onClose={() => setSelectedPolicy(null)}>
                    <PolicyDetailPanelContent policy={selectedPolicy} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const UserBehaviorAnalytics: React.FC = () => {
    const { userAnomalies } = useThreatIntelligence();
    const [selectedAnomaly, setSelectedAnomaly] = useState<UserBehaviorAnomaly | null>(null);

    const anomalyColumns = useMemo(() => [
        { header: "User ID", accessor: "userId" },
        { header: "Username", accessor: "username" },
        { header: "Anomaly Type", accessor: "anomalyType" },
        { header: "Severity", accessor: "severity", render: (anomaly: UserBehaviorAnomaly) => (
            <span className={`px-2 py-1 text-xs rounded-full ${anomaly.severity === 'critical' ? 'bg-red-500' : anomaly.severity === 'high' ? 'bg-orange-500' : anomaly.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {anomaly.severity}
            </span>
        )},
        { header: "Confidence", accessor: "confidence", render: (anomaly: UserBehaviorAnomaly) => `${anomaly.confidence}%` },
        { header: "Status", accessor: "status", render: (anomaly: UserBehaviorAnomaly) => (
            <span className={`px-2 py-1 text-xs rounded-full ${anomaly.status === 'new' ? 'bg-blue-500' : anomaly.status === 'investigating' ? 'bg-yellow-500' : anomaly.status === 'resolved' ? 'bg-green-500' : 'bg-gray-500'} text-white`}>
                {anomaly.status}
            </span>
        )},
        { header: "Timestamp", accessor: "timestamp", render: (anomaly: UserBehaviorAnomaly) => new Date(anomaly.timestamp).toLocaleString() },
    ], []);

    const AnomalyDetailPanelContent: React.FC<{ anomaly: UserBehaviorAnomaly }> = ({ anomaly }) => (
        <>
            <p className="text-gray-300 italic mb-4">{anomaly.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">User ID:</span> <span className="text-white">{anomaly.userId}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Username:</span> <span className="text-white">{anomaly.username}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Anomaly Type:</span> <span className="text-white">{anomaly.anomalyType}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Severity:</span> <span className={`px-2 py-1 text-xs rounded-full ${anomaly.severity === 'critical' ? 'bg-red-500' : anomaly.severity === 'high' ? 'bg-orange-500' : anomaly.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{anomaly.severity}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Confidence:</span> <span className="text-white">{anomaly.confidence}%</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${anomaly.status === 'new' ? 'bg-blue-500' : anomaly.status === 'investigating' ? 'bg-yellow-500' : anomaly.status === 'resolved' ? 'bg-green-500' : 'bg-gray-500'} text-white`}>{anomaly.status}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Timestamp:</span> <span className="text-gray-400">{new Date(anomaly.timestamp).toLocaleString()}</span></div>
                {anomaly.suggestedAction && <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Suggested Action:</span> <span className="text-white">{anomaly.suggestedAction}</span></div>}

                {anomaly.associatedIoCs.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Associated IoCs:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {anomaly.associatedIoCs.map(ioc => (
                                <li key={ioc.id}>{ioc.type}: {ioc.value} <span className="text-xs text-gray-500">({ioc.severity})</span></li>
                            ))}
                        </ul>
                    </div>
                )}
            </div>
            <div className="mt-6 flex justify-end space-x-2">
                <button className="flex items-center px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-300">
                    <EyeIcon className="h-4 w-4 mr-2" /> Investigate
                </button>
                <button className="flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">
                    <CheckCircleIcon className="h-4 w-4 mr-2" /> Resolve
                </button>
                <button className="flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">
                    <XCircleIcon className="h-4 w-4 mr-2" /> Mark False Positive
                </button>
            </div>
        </>
    );

    return (
        <Card title="User Behavior Analytics (UBA)" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={userAnomalies}
                columns={anomalyColumns}
                title="User Anomalies"
                initialSortBy="timestamp"
                initialSortDirection="desc"
                searchPlaceholder="Search anomalies..."
                onRowClick={setSelectedAnomaly}
            />

            {selectedAnomaly && (
                <DetailPanel title={`User Anomaly: ${selectedAnomaly.username}`} onClose={() => setSelectedAnomaly(null)}>
                    <AnomalyDetailPanelContent anomaly={selectedAnomaly} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const IncidentResponsePlaybooks: React.FC = () => {
    const { incidentPlaybooks } = useThreatIntelligence();
    const [selectedPlaybook, setSelectedPlaybook] = useState<IncidentResponsePlaybook | null>(null);

    const playbookColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Trigger Condition", accessor: "triggerCondition" },
        { header: "Severity", accessor: "severityLevel", render: (pb: IncidentResponsePlaybook) => (
            <span className={`px-2 py-1 text-xs rounded-full ${pb.severityLevel === 'critical' ? 'bg-red-500' : pb.severityLevel === 'high' ? 'bg-orange-500' : pb.severityLevel === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {pb.severityLevel}
            </span>
        )},
        { header: "Owner Team", accessor: "ownerTeam" },
        { header: "Last Updated", accessor: "lastUpdated", render: (pb: IncidentResponsePlaybook) => new Date(pb.lastUpdated).toLocaleDateString() },
    ], []);

    const PlaybookDetailPanelContent: React.FC<{ playbook: IncidentResponsePlaybook }> = ({ playbook }) => (
        <>
            <p className="text-gray-300 italic mb-4">{playbook.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Trigger:</span> <span className="text-white">{playbook.triggerCondition}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Severity:</span> <span className={`px-2 py-1 text-xs rounded-full ${playbook.severityLevel === 'critical' ? 'bg-red-500' : playbook.severityLevel === 'high' ? 'bg-orange-500' : playbook.severityLevel === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{playbook.severityLevel}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Owner Team:</span> <span className="text-white">{playbook.ownerTeam}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Updated:</span> <span className="text-gray-400">{new Date(playbook.lastUpdated).toLocaleString()}</span></div>

                {playbook.steps.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Execution Steps:</h4>
                        <ol className="list-decimal list-inside text-gray-400 pl-4">
                            {playbook.steps.map((step, i) => (
                                <li key={i} className="mb-1">
                                    <span className={`font-semibold ${step.status === 'completed' ? 'text-green-400' : step.status === 'in_progress' ? 'text-blue-400' : 'text-gray-400'}`}>
                                        Step {step.order}: {step.action}
                                    </span>
                                    <span className="ml-2 text-xs">({step.assignee} - {step.status})</span>
                                </li>
                            ))}
                        </ol>
                    </div>
                )}
                <div>
                    <span className="font-semibold text-gray-300">Tags:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {playbook.tags.map(tag => <span key={tag} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{tag}</span>)}
                    </div>
                </div>
            </div>
            <div className="mt-6 flex justify-end space-x-2">
                <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                    <PlayIcon className="h-4 w-4 mr-2" /> Initiate Playbook
                </button>
                <button className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300">
                    <EditIcon className="h-4 w-4 mr-2" /> Edit Playbook
                </button>
            </div>
        </>
    );

    return (
        <Card title="Incident Response Playbooks" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={incidentPlaybooks}
                columns={playbookColumns}
                title="Available Playbooks"
                initialSortBy="name"
                initialSortDirection="asc"
                searchPlaceholder="Search playbooks..."
                onRowClick={setSelectedPlaybook}
            />

            {selectedPlaybook && (
                <DetailPanel title={`Playbook: ${selectedPlaybook.name}`} onClose={() => setSelectedPlaybook(null)}>
                    <PlaybookDetailPanelContent playbook={selectedPlaybook} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const ComplianceAndPrivacy: React.FC = () => {
    const { privacyRegulations } = useThreatIntelligence();
    const [selectedRegulation, setSelectedRegulation] = useState<DataPrivacyRegulation | null>(null);

    const regulationColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "Jurisdiction", accessor: "jurisdiction" },
        { header: "Compliance Status", accessor: "complianceStatus", render: (reg: DataPrivacyRegulation) => (
            <span className={`px-2 py-1 text-xs rounded-full ${reg.complianceStatus === 'compliant' ? 'bg-green-500' : reg.complianceStatus === 'non-compliant' ? 'bg-red-500' : 'bg-yellow-500'} text-white`}>
                {reg.complianceStatus}
            </span>
        )},
        { header: "Risk of Non-Compliance", accessor: "riskOfNonCompliance", render: (reg: DataPrivacyRegulation) => (
            <span className={`px-2 py-1 text-xs rounded-full ${reg.riskOfNonCompliance === 'high' ? 'bg-red-500' : reg.riskOfNonCompliance === 'medium' ? 'bg-orange-500' : 'bg-green-500'} text-white`}>
                {reg.riskOfNonCompliance}
            </span>
        )},
        { header: "Last Audit", accessor: "lastAuditDate", render: (reg: DataPrivacyRegulation) => new Date(reg.lastAuditDate).toLocaleDateString() },
    ], []);

    const RegulationDetailPanelContent: React.FC<{ regulation: DataPrivacyRegulation }> = ({ regulation }) => (
        <>
            <p className="text-gray-300 italic mb-4">{regulation.description}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Name:</span> <span className="text-white">{regulation.name}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Jurisdiction:</span> <span className="text-white">{regulation.jurisdiction}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Compliance Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${regulation.complianceStatus === 'compliant' ? 'bg-green-500' : regulation.complianceStatus === 'non-compliant' ? 'bg-red-500' : 'bg-yellow-500'} text-white`}>{regulation.complianceStatus}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Risk of Non-Compliance:</span> <span className={`px-2 py-1 text-xs rounded-full ${regulation.riskOfNonCompliance === 'high' ? 'bg-red-500' : regulation.riskOfNonCompliance === 'medium' ? 'bg-orange-500' : 'bg-green-500'} text-white`}>{regulation.riskOfNonCompliance}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Audit Date:</span> <span className="text-gray-400">{new Date(regulation.lastAuditDate).toLocaleString()}</span></div>

                {regulation.keyRequirements.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Key Requirements:</h4>
                        <ul className="list-disc list-inside text-gray-400 pl-4">
                            {regulation.keyRequirements.map((req, i) => <li key={i}>{req}</li>)}
                        </ul>
                    </div>
                )}
            </div>
            <div className="mt-6 flex justify-end">
                <button className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300">
                    <CheckCircleIcon className="h-4 w-4 mr-2" /> Update Compliance
                </button>
            </div>
        </>
    );

    return (
        <Card title="Compliance & Privacy" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={privacyRegulations}
                columns={regulationColumns}
                title="Data Privacy Regulations"
                initialSortBy="name"
                initialSortDirection="asc"
                searchPlaceholder="Search regulations..."
                onRowClick={setSelectedRegulation}
            />

            {selectedRegulation && (
                <DetailPanel title={`Regulation: ${selectedRegulation.name}`} onClose={() => setSelectedRegulation(null)}>
                    <RegulationDetailPanelContent regulation={selectedRegulation} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const EventLogMonitoring: React.FC = () => {
    const { eventLogs } = useThreatIntelligence();
    const [selectedLog, setSelectedLog] = useState<EventLog | null>(null);

    const logColumns = useMemo(() => [
        { header: "Timestamp", accessor: "timestamp", render: (log: EventLog) => new Date(log.timestamp).toLocaleString() },
        { header: "Source", accessor: "source" },
        { header: "Event Type", accessor: "eventType" },
        { header: "Severity", accessor: "severity", render: (log: EventLog) => (
            <span className={`px-2 py-1 text-xs rounded-full ${log.severity === 'critical' ? 'bg-red-500' : log.severity === 'error' ? 'bg-orange-500' : log.severity === 'warning' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                {log.severity}
            </span>
        )},
        { header: "Message", accessor: "message" },
        { header: "User ID", accessor: "userId", render: (log: EventLog) => log.userId || 'N/A' },
        { header: "Asset ID", accessor: "assetId", render: (log: EventLog) => log.assetId || 'N/A' },
    ], []);

    const LogDetailPanelContent: React.FC<{ log: EventLog }> = ({ log }) => (
        <>
            <p className="text-gray-300 italic mb-4">{log.message}</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Timestamp:</span> <span className="text-gray-400">{new Date(log.timestamp).toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Source:</span> <span className="text-white">{log.source}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Event Type:</span> <span className="text-white">{log.eventType}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Severity:</span> <span className={`px-2 py-1 text-xs rounded-full ${log.severity === 'critical' ? 'bg-red-500' : log.severity === 'error' ? 'bg-orange-500' : log.severity === 'warning' ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>{log.severity}</span></div>
                {log.userId && <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">User ID:</span> <span className="text-white">{log.userId}</span></div>}
                {log.assetId && <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Asset ID:</span> <span className="text-white">{log.assetId}</span></div>}
                {log.associatedIoC && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Associated IoC:</h4>
                        <p className="text-gray-400 ml-4">{log.associatedIoC.type}: {log.associatedIoC.value} <span className="text-xs text-gray-500">({log.associatedIoC.severity})</span></p>
                    </div>
                )}
                {log.details && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-white">Details:</h4>
                        <pre className="bg-gray-700 text-gray-300 p-3 rounded-md max-h-40 overflow-y-auto font-mono text-xs mt-1">
                            {JSON.stringify(log.details, null, 2)}
                        </pre>
                    </div>
                )}
                <div>
                    <span className="font-semibold text-gray-300">Tags:</span>
                    <div className="flex flex-wrap gap-2 mt-1">
                        {log.tags.map(tag => <span key={tag} className="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full">{tag}</span>)}
                    </div>
                </div>
            </div>
            <div className="mt-6 flex justify-end">
                <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                    <SearchIcon className="h-4 w-4 mr-2" /> Investigate Event
                </button>
            </div>
        </>
    );

    return (
        <Card title="Event Log Monitoring" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={eventLogs}
                columns={logColumns}
                title="Recent Events"
                initialSortBy="timestamp"
                initialSortDirection="desc"
                searchPlaceholder="Search logs..."
                onRowClick={setSelectedLog}
            />

            {selectedLog && (
                <DetailPanel title={`Event Log: ${selectedLog.eventType}`} onClose={() => setSelectedLog(null)}>
                    <LogDetailPanelContent log={selectedLog} />
                </DetailPanel>
            )}
        </Card>
    );
};

export const ThreatFeedConfiguration: React.FC = () => {
    const { threatFeedSources } = useThreatIntelligence();
    const [selectedFeed, setSelectedFeed] = useState<ThreatFeedSource | null>(null);

    const feedColumns = useMemo(() => [
        { header: "Name", accessor: "name" },
        { header: "URL", accessor: "url", render: (feed: ThreatFeedSource) => <a href={feed.url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">{feed.url}</a> },
        { header: "Category", accessor: "category" },
        { header: "Status", accessor: "status", render: (feed: ThreatFeedSource) => (
            <span className={`px-2 py-1 text-xs rounded-full ${feed.status === 'active' ? 'bg-green-500' : feed.status === 'error' ? 'bg-red-500' : 'bg-gray-500'} text-white`}>
                {feed.status}
            </span>
        )},
        { header: "Last Ingested", accessor: "lastIngested", render: (feed: ThreatFeedSource) => new Date(feed.lastIngested).toLocaleString() },
        { header: "Refresh Interval", accessor: "refreshInterval", render: (feed: ThreatFeedSource) => `${feed.refreshInterval} min` },
        { header: "Confidence Score", accessor: "confidenceScore", render: (feed: ThreatFeedSource) => `${feed.confidenceScore}%` },
    ], []);

    const FeedDetailPanelContent: React.FC<{ feed: ThreatFeedSource }> = ({ feed }) => (
        <>
            <p className="text-gray-300 italic mb-4">Configuration details and status for this external threat intelligence feed.</p>
            <div className="space-y-3 text-sm">
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">URL:</span> <a href={feed.url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline flex items-center">{feed.url} <ExternalLinkIcon className="h-4 w-4 ml-1" /></a></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Format:</span> <span className="text-white">{feed.format}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Category:</span> <span className="text-white">{feed.category}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Status:</span> <span className={`px-2 py-1 text-xs rounded-full ${feed.status === 'active' ? 'bg-green-500' : feed.status === 'error' ? 'bg-red-500' : 'bg-gray-500'} text-white`}>{feed.status}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Last Ingested:</span> <span className="text-gray-400">{new Date(feed.lastIngested).toLocaleString()}</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Refresh Interval:</span> <span className="text-white">{feed.refreshInterval} minutes</span></div>
                <div className="flex justify-between items-center text-gray-300"><span className="font-semibold">Confidence Score:</span> <span className="text-white">{feed.confidenceScore}%</span></div>
            </div>
            <div className="mt-6 flex justify-end space-x-2">
                <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                    <RefreshIcon className="h-4 w-4 mr-2" /> Manual Sync
                </button>
                <button className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300">
                    <SettingsIcon className="h-4 w-4 mr-2" /> Configure
                </button>
            </div>
        </>
    );

    return (
        <Card title="Threat Feed Configuration" className="col-span-1 md:col-span-3">
            <FilterableTable
                data={threatFeedSources}
                columns={feedColumns}
                title="Configured Threat Feeds"
                initialSortBy="name"
                initialSortDirection="asc"
                searchPlaceholder="Search feeds..."
                onRowClick={setSelectedFeed}
            />

            {selectedFeed && (
                <DetailPanel title={`Threat Feed: ${selectedFeed.name}`} onClose={() => setSelectedFeed(null)}>
                    <FeedDetailPanelContent feed={selectedFeed} />
                </DetailPanel>
            )}
        </Card>
    );
};


// --- Main ThreatIntelligenceView Component ---
const ThreatIntelligenceView: React.FC = () => {
    const { refreshData } = useThreatIntelligence();

    return (
        <ThreatIntelligenceProvider>
            <div className="space-y-6 p-6 bg-gray-900 min-h-screen">
                <SectionHeader
                    title="Threat Intelligence Matrix"
                    description="A proactive security command center that aggregates global threat intelligence and uses proprietary AI to predict and mitigate potential attacks."
                    icon={ShieldIcon}
                    onRefresh={refreshData}
                />

                <GlobalThreatSummaryWidget />

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <Card title="Global Threat Forecasting" className="col-span-1">
                        <div className="flex items-center text-gray-400">
                            <CloudIcon className="h-6 w-6 mr-2 text-blue-400" />
                            <p>Our AI models predict emerging global cyber threats and their potential impact on the financial sector, allowing you to prepare defenses in advance.</p>
                        </div>
                    </Card>
                    <Card title="Automated Attack Surface Scans" className="col-span-1">
                        <div className="flex items-center text-gray-400">
                            <TargetIcon className="h-6 w-6 mr-2 text-red-400" />
                            <p>Continuously scan the platform for new vulnerabilities and misconfigurations using AI that thinks like an attacker.</p>
                        </div>
                    </Card>
                    <Card title="Generative Red-Team Simulations" className="col-span-1">
                        <div className="flex items-center text-gray-400">
                            <ZapIcon className="h-6 w-6 mr-2 text-yellow-400" />
                            <p>Use AI to generate and execute sophisticated, novel adversary attack simulations to continuously test and validate your defenses.</p>
                        </div>
                    </Card>
                    <Card title="Automated Incident Response" className="col-span-1">
                        <div className="flex items-center text-gray-400">
                            <ActivityIcon className="h-6 w-6 mr-2 text-green-400" />
                            <p>Automated playbooks triggered by high-severity threats for rapid, pre-approved incident containment and remediation.</p>
                        </div>
                    </Card>
                </div>

                <IoCThreatFeedWidget />
                <ThreatActorProfiling />
                <VulnerabilityManagement />
                <AttackSurfaceManagement />
                <RedTeamSimulationDashboard />
                <AITrainingAndPerformance />
                <ThreatReportsAndAnalysis />
                <SecurityPolicyDashboard />
                <UserBehaviorAnalytics />
                <IncidentResponsePlaybooks />
                <ComplianceAndPrivacy />
                <EventLogMonitoring />
                <ThreatFeedConfiguration />

                {/* Additional Placeholder Sections (could be expanded further) */}
                <SectionHeader
                    title="Advanced Threat Hunting"
                    description="Leverage AI-driven queries and behavioral analytics to proactively search for stealthy threats."
                    icon={SearchIcon}
                    showRefresh={false}
                />
                <Card title="Threat Hunting Workbench">
                    <p className="text-gray-400">Integrate with SIEM/EDR, build complex queries, visualize threat paths, and automate hunting playbooks.</p>
                    <div className="flex justify-end mt-4">
                        <button className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300">
                            <TerminalIcon className="h-5 w-5 mr-2" /> Launch Workbench
                        </button>
                    </div>
                </Card>

                <SectionHeader
                    title="Security Posture Management"
                    description="Gain continuous visibility into your security posture and identify areas for improvement."
                    icon={SlidersIcon}
                    showRefresh={false}
                />
                <Card title="Security Scorecard & Recommendations">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 className="text-lg font-semibold text-white mb-2">Overall Posture Score</h4>
                            <div className="text-5xl font-bold text-green-400">85%</div>
                            <p className="text-gray-400">Based on vulnerabilities, misconfigurations, and compliance adherence.</p>
                        </div>
                        <div>
                            <h4 className="text-lg font-semibold text-white mb-2">Top 3 Recommendations</h4>
                            <ul className="list-disc list-inside text-gray-400 space-y-2">
                                <li>Prioritize patching of 5 critical CVEs affecting production servers.</li>
                                <li>Review and enforce MFA policies for all administrative accounts.</li>
                                <li>Segment critical database networks from general access.</li>
                            </ul>
                        </div>
                    </div>
                    <div className="flex justify-end mt-4">
                        <button className="flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-300">
                            <SettingsIcon className="h-5 w-5 mr-2" /> View Full Report
                        </button>
                    </div>
                </Card>

            </div>
        </ThreatIntelligenceProvider>
    );
};

export default ThreatIntelligenceView;