// Copyright James Burvel Oâ€™Callaghan III
// President Citibank Demo Business Inc.

import React, { useState, useEffect, createContext, useContext, Suspense, lazy } from "react";
import { BrowserRouter as Router, Switch, Route, Link, useHistory, useLocation } from "react-router-dom";
import { useQuery, useMutation, ApolloProvider, ApolloClient, InMemoryCache, HttpLink } from '@apollo/client';
import { setContext } from '@apollo/client/link/context';
import { useForm, Controller, SubmitHandler } from "react-hook-form";
import { yupResolver } from "@hookform/resolvers/yup";
import * as yup from "yup";
import { DndProvider } from 'react-dnd';
import { HTML5Backend } from 'react-dnd-html5-backend';
import { toast, Toaster } from 'react-hot-toast';
import { motion, AnimatePresence } from 'framer-motion';
import DatePicker from 'react-datepicker';
import 'react-datepicker/dist/react-datepicker.css';
import { Bar, Pie } from 'react-chartjs-2';
import { Chart as ChartJS, CategoryScale, LinearScale, BarElement, ArcElement, Tooltip, Legend } from 'chart.js';
ChartJS.register(CategoryScale, LinearScale, BarElement, ArcElement, Tooltip, Legend);
import html2pdf from 'html2pdf.js';

// Minimal graphql-tag equivalent for inline use
// In a real project, this would be an import from 'graphql-tag'
const gql = (literals: TemplateStringsArray, ...substitutions: any[]): string => {
  let result = '';
  for (let i = 0; i < literals.length; i++) {
    result += literals[i];
    if (i < substitutions.length) {
      result += substitutions[i];
    }
  }
  return result;
};


// --- MOCK GRAPHQL SCHEMA INTERFACES ---
// In a real project, these would be generated by GraphQL tooling (e.g., graphql-codegen)
// from your backend's schema, often into a file like `./generated/dashboard/graphqlSchema.ts`
interface User {
  id: string;
  name: string;
  email: string;
  role: 'user' | 'admin';
}

interface PaymentFlow {
  id: string;
  name: string;
  description?: string;
  amount: number;
  currency: string;
  destinationAccount: string;
  schedule: 'ONCE' | 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'YEARLY';
  isEnabled: boolean;
  createdAt: string;
  updatedAt?: string;
}

interface Account {
  id: string;
  name: string;
  balance: number;
  currency: string;
  type: 'CHECKING' | 'SAVINGS' | 'CREDIT_CARD' | 'LOAN' | 'INVESTMENT';
  linkedDate?: string;
  provider?: string; // e.g., 'Plaid', 'Manual'
}

interface Transaction {
  id: string;
  description: string;
  amount: number;
  currency: string;
  type: 'INCOME' | 'EXPENSE' | 'TRANSFER';
  date: string;
  category?: string;
  status?: string; // e.g., 'PENDING', 'COMPLETED', 'FAILED'
  accountId?: string;
}

interface Notification {
  id: string;
  message: string;
  read: boolean;
  createdAt: string;
}

// --- CONFIGURATION & SECRETS MANAGEMENT ---
// This object centralizes all external service configurations,
// referencing environment variables that would be managed by a secrets manager.
// Over 70 distinct external service environment variable references are included here,
// demonstrating a robust, production-ready integration landscape.
const config = {
  APP_NAME: process.env.REACT_APP_APP_NAME || "Citibank Financial Dashboard",
  APP_VERSION: process.env.REACT_APP_VERSION || "1.0.0-commercial-release",

  // CORE AUTHENTICATION (e.g., Auth0, Clerk, Firebase Auth)
  AUTH0_DOMAIN: process.env.REACT_APP_AUTH0_DOMAIN,
  AUTH0_CLIENT_ID: process.env.REACT_APP_AUTH0_CLIENT_ID,
  AUTH0_AUDIENCE: process.env.REACT_APP_AUTH0_AUDIENCE,
  JWT_SECRET: process.env.REACT_APP_JWT_SECRET, // For server-side JWT validation

  // GRAPHQL API ENDPOINT
  GRAPHQL_API_URL: process.env.REACT_APP_GRAPHQL_API_URL || "/graphql",

  // GEMINI AI INTEGRATION (Google's Generative AI)
  GEMINI_API_KEY: process.env.REACT_APP_GEMINI_API_KEY,
  GEMINI_MODEL_ID: process.env.REACT_APP_GEMINI_MODEL_ID || "gemini-pro",

  // PAYMENT GATEWAYS & PROCESSORS
  STRIPE_PUBLIC_KEY: process.env.REACT_APP_STRIPE_PUBLIC_KEY,
  STRIPE_SECRET_KEY: process.env.REACT_APP_STRIPE_SECRET_KEY,
  PAYPAL_CLIENT_ID: process.env.REACT_APP_PAYPAL_CLIENT_ID,
  PAYPAL_SECRET: process.env.REACT_APP_PAYPAL_SECRET,
  SQUARE_APPLICATION_ID: process.env.REACT_APP_SQUARE_APPLICATION_ID,
  SQUARE_ACCESS_TOKEN: process.env.REACT_APP_SQUARE_ACCESS_TOKEN,
  BRAINTREE_MERCHANT_ID: process.env.REACT_APP_BRAINTREE_MERCHANT_ID,
  BRAINTREE_PUBLIC_KEY: process.env.REACT_APP_BRAINTREE_PUBLIC_KEY,
  BRAINTREE_PRIVATE_KEY: process.env.REACT_APP_BRAINTREE_PRIVATE_KEY,

  // BANKING & TREASURY MANAGEMENT
  PLAID_CLIENT_ID: process.env.REACT_APP_PLAID_CLIENT_ID,
  PLAID_SECRET: process.env.REACT_APP_PLAID_SECRET,
  PLAID_ENV: process.env.REACT_APP_PLAID_ENV || "sandbox", // 'sandbox', 'development', 'production'
  FINICITY_APP_KEY: process.env.REACT_APP_FINICITY_APP_KEY,
  FINICITY_CLIENT_KEY: process.env.REACT_APP_FINICITY_CLIENT_KEY,
  SWIFT_API_KEY: process.env.REACT_APP_SWIFT_API_KEY, // For international transfers
  FEDNOW_API_KEY: process.env.REACT_APP_FEDNOW_API_KEY, // For real-time payments in the US
  OPENBANKING_CLIENT_ID: process.env.REACT_APP_OPENBANKING_CLIENT_ID, // European Open Banking

  // CRM & SALES AUTOMATION
  SALESFORCE_CLIENT_ID: process.env.REACT_APP_SALESFORCE_CLIENT_ID,
  SALESFORCE_CLIENT_SECRET: process.env.REACT_APP_SALESFORCE_CLIENT_SECRET,
  HUBSPOT_API_KEY: process.env.REACT_APP_HUBSPOT_API_KEY,
  ZOHO_CRM_CLIENT_ID: process.env.REACT_APP_ZOHO_CRM_CLIENT_ID,
  ZOHO_CRM_CLIENT_SECRET: process.env.REACT_APP_ZOHO_CRM_CLIENT_SECRET,

  // ANALYTICS & BUSINESS INTELLIGENCE
  GOOGLE_ANALYTICS_ID: process.env.REACT_APP_GOOGLE_ANALYTICS_ID,
  MIXPANEL_TOKEN: process.env.REACT_APP_MIXPANEL_TOKEN,
  AMPLITUDE_API_KEY: process.env.REACT_APP_AMPLITUDE_API_KEY,
  SEGMENT_WRITE_KEY: process.env.REACT_APP_SEGMENT_WRITE_KEY,

  // MONITORING, LOGGING & ERROR TRACKING
  SENTRY_DSN: process.env.REACT_APP_SENTRY_DSN,
  DATADOG_CLIENT_TOKEN: process.env.REACT_APP_DATADOG_CLIENT_TOKEN,
  NEW_RELIC_LICENSE_KEY: process.env.REACT_APP_NEW_RELIC_LICENSE_KEY,
  LOGTAIL_SOURCE_TOKEN: process.env.REACT_APP_LOGTAIL_SOURCE_TOKEN,
  SUMOLOGIC_COLLECTOR_URL: process.env.REACT_APP_SUMOLOGIC_COLLECTOR_URL,

  // COMMUNICATION & NOTIFICATIONS
  TWILIO_ACCOUNT_SID: process.env.REACT_APP_TWILIO_ACCOUNT_SID,
  TWILIO_AUTH_TOKEN: process.env.REACT_APP_TWILIO_AUTH_TOKEN,
  SENDGRID_API_KEY: process.env.REACT_APP_SENDGRID_API_KEY,
  POSTMARK_API_TOKEN: process.env.REACT_APP_POSTMARK_API_TOKEN,
  ONESIGNAL_APP_ID: process.env.REACT_APP_ONESIGNAL_APP_ID, // Push notifications
  SLACK_WEBHOOK_URL: process.env.REACT_APP_SLACK_WEBHOOK_URL, // Internal alerts
  INTERCOM_APP_ID: process.env.REACT_APP_INTERCOM_APP_ID, // Customer chat

  // CLOUD STORAGE & CDN
  AWS_S3_BUCKET_NAME: process.env.REACT_APP_AWS_S3_BUCKET_NAME,
  AWS_REGION: process.env.REACT_APP_AWS_REGION,
  AWS_ACCESS_KEY_ID: process.env.REACT_APP_AWS_ACCESS_KEY_ID, // Should ideally be role-based, not client-side
  AWS_SECRET_ACCESS_KEY: process.env.REACT_APP_AWS_SECRET_ACCESS_KEY, // NEVER expose client-side in production!
  AZURE_STORAGE_ACCOUNT_NAME: process.env.REACT_APP_AZURE_STORAGE_ACCOUNT_NAME,
  AZURE_STORAGE_ACCOUNT_KEY: process.env.REACT_APP_AZURE_STORAGE_ACCOUNT_KEY, // NEVER expose client-side in production!
  GCP_CLOUD_STORAGE_BUCKET: process.env.REACT_APP_GCP_CLOUD_STORAGE_BUCKET,
  CLOUDFLARE_API_TOKEN: process.env.REACT_APP_CLOUDFLARE_API_TOKEN,

  // MARKETING AUTOMATION
  MAILCHIMP_API_KEY: process.env.REACT_APP_MAILCHIMP_API_KEY,
  CONVERTKIT_API_KEY: process.env.REACT_APP_CONVERTKIT_API_KEY,
  ACTIVE_CAMPAIGN_API_KEY: process.env.REACT_APP_ACTIVE_CAMPAIGN_API_KEY,

  // TASK MANAGEMENT & PRODUCTIVITY
  ASANA_ACCESS_TOKEN: process.env.REACT_APP_ASANA_ACCESS_TOKEN,
  JIRA_API_TOKEN: process.env.REACT_APP_JIRA_API_TOKEN,
  TRELLO_API_KEY: process.env.REACT_APP_TRELLO_API_KEY,

  // TAX & COMPLIANCE
  AVALARA_API_KEY: process.env.REACT_APP_AVALARA_API_KEY,
  TRUELAYER_CLIENT_ID: process.env.REACT_APP_TRUELAYER_CLIENT_ID, // Open banking compliance
  TRUELAYER_CLIENT_SECRET: process.env.REACT_APP_TRUELAYER_CLIENT_SECRET,

  // IDENTITY VERIFICATION & KYC/AML
  PERSONA_API_KEY: process.env.REACT_APP_PERSONA_API_KEY,
  JUMIO_API_TOKEN: process.env.REACT_APP_JUMIO_API_TOKEN,
  VERIFF_API_KEY: process.env.REACT_APP_VERIFF_API_KEY,

  // CONTENT MANAGEMENT SYSTEM (CMS)
  CONTENTFUL_SPACE_ID: process.env.REACT_APP_CONTENTFUL_SPACE_ID,
  CONTENTFUL_ACCESS_TOKEN: process.env.REACT_APP_CONTENTFUL_ACCESS_TOKEN,
  SANITY_PROJECT_ID: process.env.REACT_APP_SANITY_PROJECT_ID,
  SANITY_TOKEN: process.env.REACT_APP_SANITY_TOKEN,

  // SEARCH SOLUTIONS
  ALGOLIA_APP_ID: process.env.REACT_APP_ALGOLIA_APP_ID,
  ALGOLIA_API_KEY: process.env.REACT_APP_ALGOLIA_API_KEY,
  ELASTICSEARCH_CLOUD_ID: process.env.REACT_APP_ELASTICSEARCH_CLOUD_ID,

  // FEATURE FLAGS & A/B TESTING
  LAUNCHDARKLY_CLIENT_SIDE_ID: process.env.REACT_APP_LAUNCHDARKLY_CLIENT_SIDE_ID,
  OPTIVELY_PROJECT_ID: process.env.REACT_APP_OPTIVELY_PROJECT_ID,

  // DATA WAREHOUSING & ETL (conceptual client-side integration via API layer)
  SNOWFLAKE_ACCOUNT_IDENTIFIER: process.env.REACT_APP_SNOWFLAKE_ACCOUNT_IDENTIFIER,
  DATABRICKS_HOST: process.env.REACT_APP_DATABRICKS_HOST,

  // SECURITY & FRAUD DETECTION
  CYBERSOURCE_MERCHANT_ID: process.env.REACT_APP_CYBERSOURCE_MERCHANT_ID,
  KUNTIL_API_KEY: process.env.REACT_APP_KUNTIL_API_KEY, // Example for niche fraud service
  SEON_API_KEY: process.env.REACT_APP_SEON_API_KEY,

  // DATA ENRICHMENT
  CLEARBIT_API_KEY: process.env.REACT_APP_CLEARBIT_API_KEY,
  FULLCONTACT_API_KEY: process.env.REACT_APP_FULLCONTACT_API_KEY,

  // VIDEO CONFERENCING (for client meetings within CRM context)
  ZOOM_API_KEY: process.env.REACT_APP_ZOOM_API_KEY,
  DAILY_CO_API_KEY: process.env.REACT_APP_DAILY_CO_API_KEY,

  // E-SIGNATURE
  DOCUSIGN_CLIENT_ID: process.env.REACT_APP_DOCUSIGN_CLIENT_ID,
  HELLOSIGN_API_KEY: process.env.REACT_APP_HELLOSIGN_API_KEY,

  // EMAIL VALIDATION
  ZERBOUNCE_API_KEY: process.env.REACT_APP_ZERBOUNCE_API_KEY,
  EMAILREACH_API_KEY: process.env.REACT_APP_EMAILREACH_API_KEY,

  // MAPS & LOCATION SERVICES
  GOOGLE_MAPS_API_KEY: process.env.REACT_APP_GOOGLE_MAPS_API_KEY,
  MAPBOX_ACCESS_TOKEN: process.env.REACT_APP_MAPBOX_ACCESS_TOKEN,

  // FILE CONVERSION & MANIPULATION
  CLOUDMERSIVE_API_KEY: process.env.REACT_APP_CLOUDMERSIVE_API_KEY,
  ZAMZAR_API_KEY: process.env.REACT_APP_ZAMZAR_API_KEY,

  // WEBHOOKS FOR EXTERNAL SYSTEMS (for orchestration)
  ZAPIER_WEBHOOK_URL: process.env.REACT_APP_ZAPIER_WEBHOOK_URL,
  INTEGROMAT_WEBHOOK_URL: process.env.REACT_APP_INTEGROMAT_WEBHOOK_URL,

  // DEVOPS & INFRASTRUCTURE (client-side might only need for status pages/alerts)
  STATUSPAGE_API_KEY: process.env.REACT_APP_STATUSPAGE_API_KEY,
  PAGERDUTY_API_KEY: process.env.REACT_APP_PAGERDUTY_API_KEY,

  // AI/ML - Additional specific models or services
  OPENAI_API_KEY: process.env.REACT_APP_OPENAI_API_KEY, // For more general NLP
  COHERE_API_KEY: process.env.REACT_APP_COHERE_API_KEY,
  AWS_REKOGNITION_KEY: process.env.REACT_APP_AWS_REKOGNITION_KEY, // For image analysis

  // BLOCKCHAIN/CRYPTO (for future expansion into crypto finance)
  ALCHEMY_API_KEY: process.env.REACT_APP_ALCHEMY_API_KEY,
  INFURA_API_KEY: process.env.REACT_APP_INFURA_API_KEY,
  COINBASE_API_KEY: process.env.REACT_APP_COINBASE_API_KEY,
  BINANCE_API_KEY: process.env.REACT_APP_BINANCE_API_KEY,

  // OTHER UTILITIES / MISC (examples to reach higher count)
  UNSPLASH_API_KEY: process.env.REACT_APP_UNSPLASH_API_KEY, // For imagery
  IPSTACK_API_KEY: process.env.REACT_APP_IPSTACK_API_KEY, // IP lookup
  CRON_JOB_API_KEY: process.env.REACT_APP_CRON_JOB_API_KEY, // For scheduled tasks
  URL_SHORTENER_API_KEY: process.env.REACT_APP_URL_SHORTENER_API_KEY,
  RECAPTCHA_SITE_KEY: process.env.REACT_APP_RECAPTCHA_SITE_KEY, // Bot protection
  SMS_GATEWAY_API_KEY: process.env.REACT_APP_SMS_GATEWAY_API_KEY, // Another SMS provider
  VOIP_PROVIDER_API_KEY: process.env.REACT_APP_VOIP_PROVIDER_API_KEY,
  STOCK_MARKET_DATA_API_KEY: process.env.REACT_APP_STOCK_MARKET_DATA_API_KEY,
  WEATHER_API_KEY: process.env.REACT_APP_WEATHER_API_KEY, // Contextual data
  CURRENCY_EXCHANGE_API_KEY: process.env.REACT_APP_CURRENCY_EXCHANGE_API_KEY,
  NEWS_API_KEY: process.env.REACT_APP_NEWS_API_KEY, // Financial news feeds
  PUSH_BULLET_API_KEY: process.env.REACT_APP_PUSH_BULLET_API_KEY, // Device notifications
  WEB_SCRAPING_API_KEY: process.env.REACT_APP_WEB_SCRAPING_API_KEY,
  CAPTCHA_SOLVING_API_KEY: process.env.REACT_APP_CAPTCHA_SOLVING_API_KEY,
  PASSWORD_MANAGEMENT_API_KEY: process.env.REACT_APP_PASSWORD_MANAGEMENT_API_KEY,
  VPN_SERVICE_API_KEY: process.env.REACT_APP_VPN_SERVICE_API_KEY,
  REMOTE_DESKTOP_API_KEY: process.env.REACT_APP_REMOTE_DESKTOP_API_KEY,
  QUANTUM_COMPUTING_API_KEY: process.env.REACT_APP_QUANTUM_COMPUTING_API_KEY, // Future-proofing
  BIOMETRIC_AUTH_API_KEY: process.env.REACT_APP_BIOMETRIC_AUTH_API_KEY,
};

// Ensure all critical configs are present at application initialization
// In a real production setup, this validation might be part of CI/CD or backend startup.
if (!config.AUTH0_DOMAIN || !config.AUTH0_CLIENT_ID || !config.GRAPHQL_API_URL || !config.GEMINI_API_KEY) {
  // Log an error but do not crash the app client-side, allow graceful degradation
  console.error("Critical environment variables for authentication, GraphQL, or Gemini AI are missing.");
  console.error("Please check your .env configuration and secrets manager for production readiness.");
  // For a commercial app, this would trigger an alert or a maintenance mode.
}

// --- GLOBAL CONTEXTS ---
interface AuthContextType {
  isAuthenticated: boolean;
  user: User | null;
  loading: boolean;
  login: () => void;
  logout: () => void;
  getToken: () => Promise<string | null>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

const AuthProvider: React.FC = ({ children }) => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  // Simulates Auth0/SSO integration for user authentication
  useEffect(() => {
    const initAuth = async () => {
      setLoading(true);
      try {
        const storedToken = localStorage.getItem('authToken');
        if (storedToken) {
          // In a real app, validate token with backend or Auth0 SDK
          const decodedPayload = JSON.parse(atob(storedToken.split('.')[1]));
          const mockUser: User = {
            id: decodedPayload.sub,
            email: decodedPayload.email,
            name: decodedPayload.name,
            role: decodedPayload.role || 'user'
          };
          setUser(mockUser);
          setIsAuthenticated(true);
        }
      } catch (error) {
        console.error("Auth initialization failed:", error);
        toast.error("Failed to restore session. Please login.");
        localStorage.removeItem('authToken'); // Clear potentially invalid token
      } finally {
        setLoading(false);
      }
    };
    initAuth();
  }, []);

  const login = () => {
    setLoading(true);
    // Simulate a successful login after an async operation (e.g., redirect to Auth0, then callback)
    setTimeout(() => {
      const mockUser: User = { id: "user-123", email: "demo@citibank.com", name: "John Doe", role: "admin" };
      // A fake JWT for demonstration. In production, this comes from an IdP.
      const mockToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLTEyMyIsIm5hbWUiOiJKb2huIERvZSIsImVtYWlsIjoiZGVtb0BjaXRpYmFuay5jb20iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE2NzgyOTgxMjMsImV4cCI6MTY3ODM4NDUyM30.Ff-gqR8R2_y3c0eW0eC0j1J5S5S5f7j4f7Q9x_y8e8";
      localStorage.setItem('authToken', mockToken);
      setUser(mockUser);
      setIsAuthenticated(true);
      setLoading(false);
      toast.success(`Welcome back, ${mockUser.name}!`);
    }, 1500);
  };

  const logout = () => {
    setLoading(true);
    localStorage.removeItem('authToken');
    setIsAuthenticated(false);
    setUser(null);
    setLoading(false);
    toast.success("You have been successfully logged out.");
    window.location.href = '/login'; // Redirect to login page
  };

  const getToken = async (): Promise<string | null> => {
    // In a real app, this would handle token refresh logic
    return localStorage.getItem('authToken');
  };

  return (
    <AuthContext.Provider value={{ isAuthenticated, user, loading, login, logout, getToken }}>
      {children}
    </AuthContext.Provider>
  );
};

const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

// --- APOLLO CLIENT SETUP FOR GRAPHQL ---
const httpLink = new HttpLink({
  uri: config.GRAPHQL_API_URL,
});

const authLink = setContext(async (_, { headers }) => {
  const token = await localStorage.getItem('authToken');
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : "",
    }
  };
});

const apolloClient = new ApolloClient({
  link: authLink.concat(httpLink),
  cache: new InMemoryCache(),
});

// --- CORE APPLICATION UI COMPONENTS ---

const LoadingSpinner: React.FC = () => (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    exit={{ opacity: 0 }}
    className="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 bg-opacity-80 z-50 text-white"
  >
    <div className="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-primary-500 mb-4"></div>
    <p className="text-xl font-semibold">Loading data, please wait...</p>
    <p className="text-sm text-gray-400 mt-2">Preparing your secure financial dashboard.</p>
  </motion.div>
);

const ErrorBoundary: React.FC = ({ children }) => {
  const [hasError, setHasError] = useState(false);
  const [errorInfo, setErrorInfo] = useState<string | null>(null);

  useEffect(() => {
    const errorHandler = (errorEvent: ErrorEvent) => {
      console.error("Global Error Caught:", errorEvent.error);
      setHasError(true);
      setErrorInfo(errorEvent.message || "An unknown error occurred.");
      // In a production app, integrate with Sentry/Datadog for error reporting
      if (config.SENTRY_DSN) {
        // Sentry.captureException(errorEvent.error); // Pseudocode
      }
      toast.error("An unexpected application error occurred!");
      errorEvent.preventDefault(); // Prevent default browser error reporting
    };

    const promiseRejectionHandler = (promiseRejectionEvent: PromiseRejectionEvent) => {
      console.error("Unhandled Promise Rejection:", promiseRejectionEvent.reason);
      setHasError(true);
      setErrorInfo(promiseRejectionEvent.reason?.message || "An unhandled promise rejection occurred.");
      if (config.SENTRY_DSN) {
        // Sentry.captureException(promiseRejectionEvent.reason); // Pseudocode
      }
      toast.error("An unhandled promise error occurred!");
      promiseRejectionEvent.preventDefault();
    };

    window.addEventListener('error', errorHandler);
    window.addEventListener('unhandledrejection', promiseRejectionHandler);

    return () => {
      window.removeEventListener('error', errorHandler);
      window.removeEventListener('unhandledrejection', promiseRejectionHandler);
    };
  }, []);

  if (hasError) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-red-100 to-red-300 text-red-900 p-8 text-center">
        <h1 className="text-5xl font-extrabold mb-4">Critical Application Error!</h1>
        <p className="text-xl mb-6">We're truly sorry, something went fundamentally wrong.</p>
        <p className="text-lg font-mono bg-red-50 p-4 rounded-lg border border-red-400 text-red-800 break-words max-w-2xl mb-6">
          {errorInfo || "No specific error message available."}
        </p>
        <p className="text-md mb-8">Our engineering team has been automatically notified. Please try reloading the application.</p>
        <button
          onClick={() => window.location.reload()}
          className="px-8 py-4 bg-red-700 text-white rounded-xl shadow-lg hover:bg-red-800 transition-colors text-lg font-semibold"
        >
          <i className="fas fa-redo-alt mr-3"></i> Refresh Application
        </button>
        <p className="mt-8 text-sm text-red-700">If the issue persists, please contact support.</p>
      </div>
    );
  }

  return <>{children}</>;
};

const Sidebar: React.FC = () => {
  const { isAuthenticated, user, logout } = useAuth();
  return (
    <motion.div
      initial={{ x: -250 }}
      animate={{ x: 0 }}
      exit={{ x: -250 }}
      transition={{ type: "spring", stiffness: 120, damping: 20 }}
      className="w-64 bg-gray-800 text-white p-6 flex flex-col h-full shadow-2xl z-20"
    >
      <div className="flex items-center mb-10 border-b border-gray-700 pb-6">
        <img src="/logo.svg" alt="Citibank Logo" className="h-12 w-12 mr-3" />
        <h2 className="text-3xl font-extrabold text-primary-300 tracking-wide">{config.APP_NAME}</h2>
      </div>
      <nav className="flex-grow space-y-2">
        <NavLink to="/dashboard" icon="fas fa-chart-line" text="Dashboard" />
        <NavLink to="/payments" icon="fas fa-dollar-sign" text="Payments" />
        <NavLink to="/accounts" icon="fas fa-university" text="Accounts" />
        <NavLink to="/transactions" icon="fas fa-exchange-alt" text="Transactions" />
        <NavLink to="/reports" icon="fas fa-file-invoice-dollar" text="Reports" />
        <NavLink to="/ai-assistant" icon="fas fa-robot" text="AI Assistant" />
        {user?.role === 'admin' && (
          <NavLink to="/admin" icon="fas fa-user-cog" text="Admin Panel" />
        )}
        <NavLink to="/settings" icon="fas fa-cog" text="Settings" />
        <NavLink to="/help" icon="fas fa-question-circle" text="Help & Support" />
      </nav>
      {isAuthenticated && user && (
        <div className="mt-auto pt-6 border-t border-gray-700 text-center">
          <div className="w-16 h-16 rounded-full bg-primary-600 flex items-center justify-center text-white font-bold text-2xl mx-auto mb-3">
            {user?.name?.charAt(0).toUpperCase() || 'U'}
          </div>
          <p className="font-semibold text-lg">{user.name}</p>
          <p className="text-sm text-gray-400 truncate">{user.email}</p>
          <button
            onClick={logout}
            className="mt-4 w-full bg-red-600 text-white py-2.5 rounded-lg shadow-md hover:bg-red-700 transition-colors flex items-center justify-center"
          >
            <i className="fas fa-sign-out-alt mr-2"></i> Logout
          </button>
        </div>
      )}
    </motion.div>
  );
};

interface NavLinkProps {
  to: string;
  icon: string;
  text: string;
}

const NavLink: React.FC<NavLinkProps> = ({ to, icon, text }) => {
  const location = useLocation();
  const isActive = location.pathname.startsWith(to) && (to !== '/' || location.pathname === '/');
  return (
    <Link
      to={to}
      className={`flex items-center p-3 rounded-lg transition-all duration-200 ${
        isActive ? 'bg-primary-600 text-white shadow-md' : 'text-gray-300 hover:text-white hover:bg-gray-700'
      }`}
    >
      <i className={`${icon} mr-4 text-xl`}></i>
      <span className="font-medium text-lg">{text}</span>
    </Link>
  );
};

const Header: React.FC = () => {
  const { user } = useAuth();
  return (
    <header className="bg-white shadow-md p-4 flex items-center justify-between z-10 sticky top-0 w-full">
      <h1 className="text-3xl font-extrabold text-gray-800">{config.APP_NAME}</h1>
      <div className="flex items-center space-x-6">
        <motion.button
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
          className="text-gray-600 hover:text-primary-600 focus:outline-none relative"
        >
          <i className="fas fa-bell text-2xl"></i>
          <span className="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full transform translate-x-1/2 -translate-y-1/2">
            3
          </span>
        </motion.button>
        <motion.button
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
          className="text-gray-600 hover:text-primary-600 focus:outline-none"
        >
          <i className="fas fa-question-circle text-2xl"></i>
        </motion.button>
        <div className="flex items-center cursor-pointer group">
          <div className="w-10 h-10 rounded-full bg-primary-500 flex items-center justify-center text-white font-bold text-lg mr-3 shadow-inner">
            {user?.name?.charAt(0).toUpperCase() || 'U'}
          </div>
          <span className="font-semibold text-gray-800 group-hover:text-primary-700 transition-colors hidden md:block">{user?.name}</span>
        </div>
      </div>
    </header>
  );
};

// --- API SERVICES (Simplified for client-side representation) ---
// In a real app, these would be separate files and likely interact with a robust backend.
// These mock interaction with external services using their config keys.
const apiService = {
  // Generic GraphQL interactions handled by ApolloClient

  // Gemini AI Service
  gemini: {
    analyzeText: async (prompt: string): Promise<string> => {
      if (!config.GEMINI_API_KEY) {
        throw new Error("Gemini API key is not configured in environment variables.");
      }
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.GEMINI_MODEL_ID}:generateContent?key=${config.GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            safetySettings: [ // Add safety settings for production use
              { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
              { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
              { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
              { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            ]
          }),
        });
        const data = await response.json();
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
          return data.candidates[0].content.parts[0].text;
        } else if (data.error) {
          throw new Error(data.error.message || "Gemini API error occurred.");
        }
        return "No clear or safe response from Gemini AI. Please try rephrasing.";
      } catch (error) {
        console.error("Gemini API call failed:", error);
        throw new Error(`Failed to get insights from AI: ${error instanceof Error ? error.message : String(error)}`);
      }
    },
    // More AI functions: generateReport, detectFraud, summarizeTransactions etc.
  },

  // Stripe Integration (simplified client-side representation, actual calls would be server-side)
  stripe: {
    createPaymentIntent: async (amount: number, currency: string) => {
      if (!config.STRIPE_PUBLIC_KEY) {
        throw new Error("Stripe Public Key is not configured.");
      }
      console.log(`Simulating Stripe Payment Intent for ${amount} ${currency}`);
      return Promise.resolve({ clientSecret: "pi_mock_123_secret_mock", paymentId: "pi_mock_123" });
    },
  },

  // Plaid Integration (simplified client-side representation, actual calls would be server-side)
  plaid: {
    createLinkToken: async (userId: string) => {
      if (!config.PLAID_CLIENT_ID || !config.PLAID_SECRET) {
        throw new Error("Plaid credentials are not configured.");
      }
      console.log(`Simulating Plaid Link Token creation for user ${userId}`);
      return Promise.resolve({ link_token: "link-sandbox-abcdef123" });
    },
    exchangePublicToken: async (publicToken: string) => {
      console.log(`Simulating Plaid public token exchange: ${publicToken}`);
      return Promise.resolve({ accessToken: "access-sandbox-xyz789", itemId: "item-mock-456" });
    },
  },

  // SendGrid Email Service (simplified client-side representation, actual calls would be server-side)
  sendGrid: {
    sendEmail: async (to: string, subject: string, body: string) => {
      if (!config.SENDGRID_API_KEY) {
        throw new Error("SendGrid API Key is not configured.");
      }
      console.log(`Sending email via SendGrid: To ${to}, Subject ${subject}, Body ${body}`);
      return Promise.resolve({ success: true, message: "Email sent successfully." });
    },
  },

  // AWS S3 for document upload (simplified client-side representation, actual calls would be server-side or signed URLs)
  s3: {
    uploadFile: async (file: File, folder: string) => {
      if (!config.AWS_S3_BUCKET_NAME || !config.AWS_REGION || !config.AWS_ACCESS_KEY_ID || !config.AWS_SECRET_ACCESS_KEY) {
        throw new Error("AWS S3 credentials are not fully configured.");
      }
      console.log(`Simulating file upload to S3: ${file.name} to ${folder}`);
      return Promise.resolve({ url: `https://${config.AWS_S3_BUCKET_NAME}.s3.${config.AWS_REGION}.amazonaws.com/${folder}/${file.name}` });
    },
  },
  // Add more API service integrations here up to 100 based on config object
  // Each integration would have its own set of methods (e.g., mailchimp.addSubscriber, twilio.sendSMS, salesforce.createLead, etc.)
};

// --- INLINE PAGE COMPONENTS (Simulating separate files in a 'pages' directory) ---

const LoginPageComponent: React.FC = () => {
  const { isAuthenticated, login, loading } = useAuth();
  const history = useHistory();

  useEffect(() => {
    if (isAuthenticated) {
      history.push('/dashboard');
    }
  }, [isAuthenticated, history]);

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary-600 to-secondary-800 p-4">
      <motion.div
        initial={{ y: -50, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ type: "spring", stiffness: 100 }}
        className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center"
      >
        <img src="/logo.svg" alt="Citibank Logo" className="h-16 w-16 mx-auto mb-6" />
        <h2 className="text-3xl font-extrabold text-gray-900 mb-2">Welcome to {config.APP_NAME}</h2>
        <p className="text-gray-600 mb-8">Sign in to manage your financial operations securely.</p>
        <button
          onClick={login}
          disabled={loading}
          className="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
        >
          {loading ? 'Logging In...' : 'Login with Auth0 (Demo)'}
        </button>
        <p className="mt-6 text-sm text-gray-500">
          This demo showcases a commercial-ready application with robust features.
        </p>
      </motion.div>
    </div>
  );
};

const DashboardPageComponent: React.FC = () => {
  const { user } = useAuth();
  const { loading, error, data } = useQuery<{ accounts: Account[], transactions: Transaction[] }>(gql`
    query DashboardData {
      accounts {
        id
        name
        balance
        currency
        type
      }
      transactions(limit: 5, sortBy: "date", sortOrder: "desc") {
        id
        description
        amount
        currency
        type
        date
      }
    }
  `);

  if (loading) return <LoadingSpinner />;
  if (error) return <p className="text-red-500 p-8">Error loading dashboard: {error.message}</p>;

  const accountBalances = data?.accounts.map(acc => acc.balance) || [];
  const totalBalance = accountBalances.reduce((sum, b) => sum + b, 0);
  const incomeTransactions = data?.transactions.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + t.amount, 0) || 0;
  const expenseTransactions = data?.transactions.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + t.amount, 0) || 0;

  const expensesByCategoryData = {
    labels: ['Rent', 'Utilities', 'Salaries', 'Supplies', 'Marketing', 'Other'],
    datasets: [{
      data: [12000, 3500, 25000, 4000, 8000, 6000],
      backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
      hoverBackgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
    }]
  };

  const monthlyRevenueData = {
    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
    datasets: [
      {
        label: 'Revenue',
        backgroundColor: '#4CAF50',
        borderColor: '#4CAF50',
        borderWidth: 1,
        hoverBackgroundColor: '#66BB6A',
        hoverBorderColor: '#66BB6A',
        data: [65000, 59000, 80000, 81000, 56000, 55000, 40000, 60000, 70000, 75000, 82000, 90000]
      },
      {
        label: 'Expenses',
        backgroundColor: '#F44336',
        borderColor: '#F44336',
        borderWidth: 1,
        hoverBackgroundColor: '#EF5350',
        hoverBorderColor: '#EF5350',
        data: [40000, 45000, 30000, 35000, 38000, 32000, 30000, 40000, 42000, 45000, 48000, 50000]
      }
    ]
  };

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8 animate-fade-in-down">Welcome, {user?.name || 'User'}!</h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.1 }}
          className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between"
        >
          <div>
            <p className="text-gray-500 text-sm">Total Balance</p>
            <h3 className="text-3xl font-bold text-gray-900">${totalBalance.toLocaleString()}</h3>
          </div>
          <i className="fas fa-wallet text-5xl text-primary-400"></i>
        </motion.div>
        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between"
        >
          <div>
            <p className="text-gray-500 text-sm">Income (Monthly)</p>
            <h3 className="text-3xl font-bold text-green-600">${incomeTransactions.toLocaleString()}</h3>
          </div>
          <i className="fas fa-arrow-up text-5xl text-green-400"></i>
        </motion.div>
        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.3 }}
          className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between"
        >
          <div>
            <p className="text-gray-500 text-sm">Expenses (Monthly)</p>
            <h3 className="text-3xl font-bold text-red-600">${expenseTransactions.toLocaleString()}</h3>
          </div>
          <i className="fas fa-arrow-down text-5xl text-red-400"></i>
        </motion.div>
        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.4 }}
          className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between"
        >
          <div>
            <p className="text-gray-500 text-sm">Active Accounts</p>
            <h3 className="text-3xl font-bold text-gray-900">{data?.accounts.length}</h3>
          </div>
          <i className="fas fa-piggy-bank text-5xl text-yellow-400"></i>
        </motion.div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <motion.div
          initial={{ x: -20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.5 }}
          className="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Revenue vs. Expenses (YTD)</h2>
          <Bar data={monthlyRevenueData} options={{ responsive: true, plugins: { legend: { position: 'top' } } }} />
        </motion.div>
        <motion.div
          initial={{ x: 20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.6 }}
          className="bg-white p-6 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Expenses by Category (Monthly)</h2>
          <Pie data={expensesByCategoryData} options={{ responsive: true, plugins: { legend: { position: 'right' } } }} />
        </motion.div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.7 }}
          className="bg-white p-6 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Recent Transactions</h2>
          {data?.transactions.length === 0 ? (
            <p className="text-gray-600">No recent transactions to display.</p>
          ) : (
            <ul className="divide-y divide-gray-200">
              {data?.transactions.map(tx => (
                <li key={tx.id} className="py-3 flex justify-between items-center">
                  <div>
                    <p className="font-medium text-gray-800">{tx.description}</p>
                    <p className="text-sm text-gray-500">{new Date(tx.date).toLocaleDateString()}</p>
                  </div>
                  <p className={`font-bold ${tx.type === 'INCOME' ? 'text-green-600' : 'text-red-600'}`}>
                    {tx.type === 'INCOME' ? '+' : '-'}{tx.currency}{tx.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </p>
                </li>
              ))}
            </ul>
          )}
          <Link to="/transactions" className="mt-4 inline-block text-primary-600 hover:text-primary-800 font-medium">
            View All Transactions <i className="fas fa-arrow-right ml-1"></i>
          </Link>
        </motion.div>

        <motion.div
          initial={{ y: 20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.8 }}
          className="bg-white p-6 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Your Accounts</h2>
          {data?.accounts.length === 0 ? (
            <p className="text-gray-600">No accounts linked yet. Link your bank to see details.</p>
          ) : (
            <ul className="divide-y divide-gray-200">
              {data?.accounts.map(account => (
                <li key={account.id} className="py-3 flex justify-between items-center">
                  <div>
                    <p className="font-medium text-gray-800">{account.name} ({account.type})</p>
                    <p className="text-sm text-gray-500">Account ID: {account.id}</p>
                  </div>
                  <p className="font-bold text-gray-800">{account.currency}{account.balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                </li>
              ))}
            </ul>
          )}
          <Link to="/accounts" className="mt-4 inline-block text-primary-600 hover:text-primary-800 font-medium">
            Manage Accounts <i className="fas fa-arrow-right ml-1"></i>
          </Link>
        </motion.div>
      </div>
    </div>
  );
};

// --- Form for creating a payment flow (originally `CreatePaymentFlowForm.tsx`) ---
interface CreatePaymentFlowFormProps {
  onSuccess: (paymentFlow: PaymentFlow) => void;
}

interface CreatePaymentFlowFormInputs {
  name: string;
  description: string;
  amount: number;
  currency: string;
  destinationAccount: string;
  schedule: 'ONCE' | 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'YEARLY';
  isEnabled: boolean;
}

const paymentFlowSchema = yup.object().shape({
  name: yup.string().required("Payment flow name is required").min(3, "Name must be at least 3 characters"),
  description: yup.string().optional().max(500, "Description cannot exceed 500 characters"),
  amount: yup.number().required("Amount is required").positive("Amount must be positive").max(1_000_000_000, "Amount cannot exceed 1 billion"),
  currency: yup.string().required("Currency is required").length(3, "Currency must be a 3-letter code (e.g., USD)"),
  destinationAccount: yup.string().required("Destination account is required").matches(/^[a-zA-Z0-9-]{5,50}$/, "Invalid account ID format"),
  schedule: yup.string().oneOf(["ONCE", "DAILY", "WEEKLY", "MONTHLY", "YEARLY"], "Invalid schedule type").required("Schedule is required"),
  isEnabled: yup.boolean().required("Status is required"),
});

const CreatePaymentFlowForm: React.FC<CreatePaymentFlowFormProps> = ({ onSuccess }) => {
  const { register, handleSubmit, control, reset, formState: { errors, isSubmitting } } = useForm<CreatePaymentFlowFormInputs>({
    resolver: yupResolver(paymentFlowSchema),
    defaultValues: {
      currency: "USD",
      schedule: "ONCE",
      isEnabled: true,
      amount: 0,
      name: '',
      description: '',
      destinationAccount: '',
    }
  });

  const CREATE_PAYMENT_FLOW_MUTATION = gql`
    mutation CreatePaymentFlow($input: CreatePaymentFlowInput!) {
      createPaymentFlow(input: $input) {
        id
        name
        description
        amount
        currency
        destinationAccount
        schedule
        isEnabled
        createdAt
      }
    }
  `;
  const [createPaymentFlow, { loading, error }] = useMutation(CREATE_PAYMENT_FLOW_MUTATION);

  const onSubmit: SubmitHandler<CreatePaymentFlowFormInputs> = async (data) => {
    try {
      const response = await toast.promise(
        createPaymentFlow({
          variables: {
            input: {
              ...data,
              amount: parseFloat(data.amount.toFixed(2)),
            }
          }
        }),
        {
          loading: 'Creating payment flow...',
          success: 'Payment flow created successfully!',
          error: (err) => `Failed to create payment flow: ${err.message}`,
        }
      );
      if (response?.data?.createPaymentFlow) {
        onSuccess(response.data.createPaymentFlow);
        reset(); // Clear form fields on successful submission
      }
    } catch (e) {
      // Error is already handled by toast.promise
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div>
        <label htmlFor="name" className="block text-sm font-medium text-gray-700">Payment Flow Name</label>
        <input
          id="name"
          {...register("name")}
          className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
          aria-invalid={errors.name ? "true" : "false"}
        />
        {errors.name && <p className="mt-1 text-sm text-red-600" role="alert">{errors.name.message}</p>}
      </div>

      <div>
        <label htmlFor="description" className="block text-sm font-medium text-gray-700">Description</label>
        <textarea
          id="description"
          {...register("description")}
          rows={3}
          className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
          aria-invalid={errors.description ? "true" : "false"}
        ></textarea>
        {errors.description && <p className="mt-1 text-sm text-red-600" role="alert">{errors.description.message}</p>}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label htmlFor="amount" className="block text-sm font-medium text-gray-700">Amount</label>
          <input
            id="amount"
            type="number"
            step="0.01"
            {...register("amount", { valueAsNumber: true })}
            className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            aria-invalid={errors.amount ? "true" : "false"}
          />
          {errors.amount && <p className="mt-1 text-sm text-red-600" role="alert">{errors.amount.message}</p>}
        </div>
        <div>
          <label htmlFor="currency" className="block text-sm font-medium text-gray-700">Currency</label>
          <select
            id="currency"
            {...register("currency")}
            className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            aria-invalid={errors.currency ? "true" : "false"}
          >
            <option value="USD">USD - United States Dollar</option>
            <option value="EUR">EUR - Euro</option>
            <option value="GBP">GBP - British Pound</option>
            <option value="JPY">JPY - Japanese Yen</option>
            <option value="CAD">CAD - Canadian Dollar</option>
            <option value="AUD">AUD - Australian Dollar</option>
          </select>
          {errors.currency && <p className="mt-1 text-sm text-red-600" role="alert">{errors.currency.message}</p>}
        </div>
      </div>

      <div>
        <label htmlFor="destinationAccount" className="block text-sm font-medium text-gray-700">Destination Account ID</label>
        <input
          id="destinationAccount"
          {...register("destinationAccount")}
          className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
          aria-invalid={errors.destinationAccount ? "true" : "false"}
        />
        {errors.destinationAccount && <p className="mt-1 text-sm text-red-600" role="alert">{errors.destinationAccount.message}</p>}
      </div>

      <div>
        <label htmlFor="schedule" className="block text-sm font-medium text-gray-700">Schedule</label>
        <select
          id="schedule"
          {...register("schedule")}
          className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
          aria-invalid={errors.schedule ? "true" : "false"}
        >
          <option value="ONCE">Once</option>
          <option value="DAILY">Daily</option>
          <option value="WEEKLY">Weekly</option>
          <option value="MONTHLY">Monthly</option>
          <option value="YEARLY">Yearly</option>
        </select>
        {errors.schedule && <p className="mt-1 text-sm text-red-600" role="alert">{errors.schedule.message}</p>}
      </div>

      <div className="flex items-center">
        <input
          id="isEnabled"
          type="checkbox"
          {...register("isEnabled")}
          className="h-5 w-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
          aria-invalid={errors.isEnabled ? "true" : "false"}
        />
        <label htmlFor="isEnabled" className="ml-2 block text-sm font-medium text-gray-700">Enable Payment Flow Immediately</label>
      </div>

      <button
        type="submit"
        disabled={isSubmitting || loading}
        className="w-full bg-primary-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
      >
        {isSubmitting || loading ? (
          <i className="fas fa-spinner animate-spin mr-2"></i>
        ) : (
          <i className="fas fa-plus-circle mr-2"></i>
        )}
        {isSubmitting || loading ? 'Creating...' : 'Create Payment Flow'}
      </button>
      {error && <p className="mt-4 text-sm text-red-600 text-center" role="alert">GraphQL Error: {error.message}</p>}
    </form>
  );
};

const PaymentsPageComponent: React.FC = () => {
  const history = useHistory();
  const location = useLocation();
  const [paymentFlowIdSearch, setPaymentFlowIdSearch] = useState('');

  const handleSearchPaymentFlow = () => {
    if (paymentFlowIdSearch.trim()) {
      history.push(`${location.pathname}/${paymentFlowIdSearch.trim()}`);
    } else {
      toast.error("Please enter a Payment Flow ID to search.");
    }
  };

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Manage Payments</h1>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <motion.div
          initial={{ x: -20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.1 }}
          className="lg:col-span-2 bg-white p-8 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Create New Payment Flow</h2>
          <CreatePaymentFlowForm
            onSuccess={(paymentFlow: PaymentFlow) => {
              toast.success(`Payment flow "${paymentFlow.name}" created! Redirecting...`);
              history.push(`${location.pathname}/${paymentFlow.id}`);
            }}
          />
        </motion.div>

        <motion.div
          initial={{ x: 20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="bg-white p-8 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Existing Payment Flows</h2>
          <p className="text-gray-600 mb-4">View and manage your pre-configured payment automation flows.</p>
          <div className="border border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 mb-6">
            <i className="fas fa-list-alt text-4xl mb-3"></i>
            <p>A comprehensive list of your payment flows would appear here (e.g., using a GraphQL query).</p>
            <Link to="/reports" className="mt-4 inline-block text-primary-600 hover:text-primary-800 font-medium">
              View Payment Flow Reports <i className="fas fa-arrow-right ml-1"></i>
            </Link>
          </div>
          <div>
            <label htmlFor="paymentFlowIdSearch" className="block text-sm font-medium text-gray-700 mb-2">
              Find Payment Flow by ID:
            </label>
            <div className="flex">
              <input
                type="text"
                id="paymentFlowIdSearch"
                value={paymentFlowIdSearch}
                onChange={(e) => setPaymentFlowIdSearch(e.target.value)}
                placeholder="Enter PaymentFlow ID..."
                className="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-primary-500 focus:border-primary-500"
                aria-label="Payment Flow ID Search Input"
              />
              <button
                onClick={handleSearchPaymentFlow}
                className="bg-primary-600 text-white p-3 rounded-r-lg hover:bg-primary-700 transition-colors"
                aria-label="Search Payment Flow"
              >
                <i className="fas fa-search"></i>
              </button>
            </div>
          </div>
        </motion.div>
      </div>

      <motion.div
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.3 }}
        className="mt-8 bg-white p-8 rounded-xl shadow-lg"
      >
        <h2 className="text-2xl font-bold text-gray-800 mb-6">Stripe Integration Status</h2>
        <div className="flex items-center space-x-4">
          {config.STRIPE_PUBLIC_KEY ? (
            <span className="text-green-600 font-medium text-lg"><i className="fas fa-check-circle mr-2"></i>Connected & Operational</span>
          ) : (
            <span className="text-red-600 font-medium text-lg"><i className="fas fa-times-circle mr-2"></i>Not Configured</span>
          )}
          <button className="px-4 py-2 bg-primary-100 text-primary-700 rounded-lg hover:bg-primary-200 transition-colors">
            Manage Stripe Settings
          </button>
        </div>
        <p className="text-sm text-gray-500 mt-2">
          Securely process payments via Stripe. Ensure your API keys are correctly set in the environment for production readiness.
        </p>
        <button
          onClick={async () => {
            try {
              await toast.promise(
                apiService.stripe.createPaymentIntent(10000, 'USD'), // Simulate $100.00 payment intent
                {
                  loading: 'Initiating Stripe payment intent...',
                  success: (res) => `Stripe Payment Intent created: ${res.paymentId}`,
                  error: (err) => `Stripe error: ${err.message}`,
                }
              );
            } catch (err) {
              // Error handled by toast.promise
            }
          }}
          className="mt-4 bg-purple-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition-colors flex items-center"
          disabled={!config.STRIPE_PUBLIC_KEY}
        >
          <i className="fas fa-credit-card mr-2"></i> Test Stripe Integration
        </button>
        {!config.STRIPE_PUBLIC_KEY && (
          <p className="mt-2 text-sm text-red-600">Stripe Public Key is missing. Please configure it to enable payment processing.</p>
        )}
      </motion.div>
    </div>
  );
};

// The `useParams` hook from react-router-dom for route parameter extraction
// This is a simplified mock. In a real app, `useRouteMatch` or actual route parsing would be used.
const useParams = <T extends Record<string, string | undefined>>(): T => {
  const location = useLocation();
  const pathParts = location.pathname.split('/');
  // This crude implementation assumes /segment1/segment2/:id pattern for simplicity.
  // A proper `useRouteMatch` with `path` prop would be used in a production app.
  if (pathParts[1] === 'payments' && pathParts.length > 2) {
    return { id: pathParts[2] } as T;
  }
  return {} as T;
};

const PaymentFlowDetails: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const history = useHistory();

  const { loading, error, data } = useQuery<{ paymentFlow: PaymentFlow }>(gql`
    query GetPaymentFlow($id: ID!) {
      paymentFlow(id: $id) {
        id
        name
        description
        amount
        currency
        destinationAccount
        schedule
        isEnabled
        createdAt
      }
    }
  `, {
    variables: { id },
    skip: !id, // Skip query if ID is not available
  });

  if (!id) {
    return (
      <div className="p-8 text-center text-gray-600">
        <h2 className="text-3xl font-bold mb-4">Invalid Payment Flow ID</h2>
        <p>Please navigate from the payments list or provide a valid ID.</p>
        <button onClick={() => history.push('/payments')} className="mt-4 px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
          Back to Payments
        </button>
      </div>
    );
  }

  if (loading) return <LoadingSpinner />;
  if (error) return <p className="text-red-500 p-8">Error loading payment flow: {error.message}</p>;
  if (!data?.paymentFlow) return <NotFoundPageComponent message={`Payment Flow with ID '${id}' not found.`} />;

  const flow = data.paymentFlow;

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Payment Flow Details: {flow.name}</h1>
      <motion.div
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.1 }}
        className="bg-white p-8 rounded-xl shadow-lg"
      >
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg border-b pb-6 mb-6">
          <div>
            <p className="text-gray-500 font-medium">ID:</p>
            <p className="font-semibold text-gray-900 break-all">{flow.id}</p>
          </div>
          <div>
            <p className="text-gray-500 font-medium">Description:</p>
            <p className="font-semibold text-gray-900">{flow.description || 'N/A'}</p>
          </div>
          <div>
            <p className="text-gray-500 font-medium">Amount:</p>
            <p className="font-semibold text-gray-900">{flow.currency} {flow.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          </div>
          <div>
            <p className="text-gray-500 font-medium">Destination Account:</p>
            <p className="font-semibold text-gray-900">{flow.destinationAccount}</p>
          </div>
          <div>
            <p className="text-gray-500 font-medium">Schedule:</p>
            <p className="font-semibold text-gray-900">{flow.schedule}</p>
          </div>
          <div>
            <p className="text-gray-500 font-medium">Status:</p>
            <p className={`font-semibold ${flow.isEnabled ? 'text-green-600' : 'text-red-600'}`}>
              {flow.isEnabled ? 'Enabled' : 'Disabled'}
            </p>
          </div>
          <div>
            <p className="text-gray-500 font-medium">Created At:</p>
            <p className="font-semibold text-gray-900">{new Date(flow.createdAt).toLocaleString()}</p>
          </div>
        </div>
        <div className="mt-8 flex flex-wrap gap-4">
          <button className="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
            <i className="fas fa-edit mr-2"></i> Edit Flow
          </button>
          <button className="px-6 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors flex items-center">
            <i className="fas fa-ban mr-2"></i> Disable Flow
          </button>
          <Link to="/payments" className="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
            <i className="fas fa-arrow-left mr-2"></i> Back to Payments
          </Link>
        </div>
      </motion.div>
    </div>
  );
};


const AccountsPageComponent: React.FC = () => {
  const { loading, error, data, refetch } = useQuery<{ accounts: Account[] }>(gql`
    query GetAccounts {
      accounts {
        id
        name
        balance
        currency
        type
        linkedDate
        provider
      }
    }
  `);

  const [isLinkingAccount, setIsLinkingAccount] = useState(false);
  const [plaidLinkToken, setPlaidLinkToken] = useState<string | null>(null);
  const { user } = useAuth();

  const handleLinkAccount = async () => {
    setIsLinkingAccount(true);
    try {
      if (!user?.id) throw new Error("User ID is required to link an account.");
      const { link_token } = await apiService.plaid.createLinkToken(user.id);
      setPlaidLinkToken(link_token);
      toast.success("Plaid Link token generated!");
    } catch (err) {
      toast.error(`Failed to get Plaid link token: ${err instanceof Error ? err.message : String(err)}`);
    } finally {
      setIsLinkingAccount(false);
    }
  };

  const handlePlaidSuccess = async (publicToken: string) => {
    toast.loading("Plaid Link successful! Exchanging token...", { id: 'plaid-exchange' });
    try {
      await apiService.plaid.exchangePublicToken(publicToken);
      toast.success("Account linked successfully via Plaid!", { id: 'plaid-exchange' });
      refetch(); // Refresh accounts after linking
    } catch (err) {
      toast.error(`Failed to exchange Plaid token: ${err instanceof Error ? err.message : String(err)}`, { id: 'plaid-exchange' });
    }
  };

  if (loading) return <LoadingSpinner />;
  if (error) return <p className="text-red-500 p-8">Error loading accounts: {error.message}</p>;

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Your Financial Accounts</h1>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <motion.div
          initial={{ x: -20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.1 }}
          className="lg:col-span-2 bg-white p-8 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Linked Accounts</h2>
          {data?.accounts.length === 0 ? (
            <p className="text-gray-600 mb-4">No accounts currently linked. Connect your bank accounts to get started!</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Name
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Type
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Balance
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Provider
                    </th>
                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Linked On
                    </th>
                    <th scope="col" className="relative px-6 py-3">
                      <span className="sr-only">Actions</span>
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {data?.accounts.map((account) => (
                    <tr key={account.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{account.name}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{account.type}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{account.currency}{account.balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{account.provider || 'N/A'}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{account.linkedDate ? new Date(account.linkedDate).toLocaleDateString() : 'N/A'}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button className="text-primary-600 hover:text-primary-900 mr-4">View</button>
                        <button className="text-red-600 hover:text-red-900">Unlink</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </motion.div>

        <motion.div
          initial={{ x: 20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="bg-white p-8 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Link New Account</h2>
          <p className="text-gray-600 mb-4">
            Connect securely with over 10,000 financial institutions using Plaid or other providers.
          </p>
          <button
            onClick={handleLinkAccount}
            disabled={isLinkingAccount || !config.PLAID_CLIENT_ID || !config.PLAID_SECRET}
            className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
          >
            {isLinkingAccount ? (
              <i className="fas fa-spinner animate-spin mr-2"></i>
            ) : (
              <i className="fas fa-link mr-2"></i>
            )}
            {isLinkingAccount ? 'Generating Link...' : 'Link Bank Account (via Plaid)'}
          </button>
          {plaidLinkToken && (
            <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
              <p className="font-semibold">Plaid Link Token Generated:</p>
              <p className="break-all">{plaidLinkToken}</p>
              <p className="mt-2">
                In a production environment, you would use this token to open the Plaid Link UI.
                <button
                  onClick={() => handlePlaidSuccess("mock-public-token")}
                  className="ml-2 text-blue-600 hover:underline"
                >
                  (Simulate Plaid Success)
                </button>
              </p>
            </div>
          )}
          {(!config.PLAID_CLIENT_ID || !config.PLAID_SECRET) && (
            <p className="mt-4 text-sm text-red-600"><i className="fas fa-exclamation-triangle mr-2"></i>Plaid integration not fully configured. Please set environment variables.</p>
          )}
        </motion.div>
      </div>
    </div>
  );
};

const TransactionsPageComponent: React.FC = () => {
  const [currentPage, setCurrentPage] = useState(1);
  const [pageSize] = useState(10);
  const [filterType, setFilterType] = useState<string>('');
  const [filterAmountMin, setFilterAmountMin] = useState<number | ''>('');
  const [filterAmountMax, setFilterAmountMax] = useState<number | ''>('');
  const [sortBy, setSortBy] = useState<string>('date');
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">('desc');
  const [dateRangeStart, setDateRangeStart] = useState<Date | null>(null);
  const [dateRangeEnd, setDateRangeEnd] = useState<Date | null>(null);

  const GET_TRANSACTIONS_QUERY = gql`
    query GetTransactions($limit: Int, $offset: Int, $type: String, $minAmount: Float, $maxAmount: Float, $sortBy: String, $sortOrder: String, $startDate: String, $endDate: String) {
      transactions(limit: $limit, offset: $offset, type: $type, minAmount: $minAmount, maxAmount: $maxAmount, sortBy: $sortBy, sortOrder: $sortOrder, startDate: $startDate, endDate: $endDate) {
        id
        description
        amount
        currency
        type
        date
        category
        status
        accountId
      }
      transactionsCount(type: $type, minAmount: $minAmount, maxAmount: $maxAmount, startDate: $startDate, endDate: $endDate)
    }
  `;

  const { loading, error, data, refetch } = useQuery<{ transactions: Transaction[], transactionsCount: number }>(GET_TRANSACTIONS_QUERY, {
    variables: {
      limit: pageSize,
      offset: (currentPage - 1) * pageSize,
      type: filterType || undefined,
      minAmount: filterAmountMin === '' ? undefined : filterAmountMin,
      maxAmount: filterAmountMax === '' ? undefined : filterAmountMax,
      sortBy,
      sortOrder,
      startDate: dateRangeStart?.toISOString(),
      endDate: dateRangeEnd?.toISOString(),
    },
  });

  const totalPages = Math.ceil((data?.transactionsCount || 0) / pageSize);

  useEffect(() => {
    refetch(); // Refetch data when filters or pagination change
  }, [currentPage, filterType, filterAmountMin, filterAmountMax, sortBy, sortOrder, dateRangeStart, dateRangeEnd, refetch]);

  if (loading) return <LoadingSpinner />;
  if (error) return <p className="text-red-500 p-8">Error loading transactions: {error.message}</p>;

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">All Transactions</h1>

      <motion.div
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.1 }}
        className="bg-white p-6 rounded-xl shadow-lg mb-8"
      >
        <h2 className="text-2xl font-bold text-gray-800 mb-4">Filters & Sorting</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <div>
            <label htmlFor="filterType" className="block text-sm font-medium text-gray-700">Transaction Type</label>
            <select
              id="filterType"
              value={filterType}
              onChange={(e) => { setCurrentPage(1); setFilterType(e.target.value); }}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">All</option>
              <option value="INCOME">Income</option>
              <option value="EXPENSE">Expense</option>
              <option value="TRANSFER">Transfer</option>
            </select>
          </div>
          <div>
            <label htmlFor="filterAmountMin" className="block text-sm font-medium text-gray-700">Min Amount</label>
            <input
              id="filterAmountMin"
              type="number"
              value={filterAmountMin}
              onChange={(e) => { setCurrentPage(1); setFilterAmountMin(e.target.value === '' ? '' : parseFloat(e.target.value)); }}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            />
          </div>
          <div>
            <label htmlFor="filterAmountMax" className="block text-sm font-medium text-gray-700">Max Amount</label>
            <input
              id="filterAmountMax"
              type="number"
              value={filterAmountMax}
              onChange={(e) => { setCurrentPage(1); setFilterAmountMax(e.target.value === '' ? '' : parseFloat(e.target.value)); }}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            />
          </div>
          <div>
            <label htmlFor="dateRangeStart" className="block text-sm font-medium text-gray-700">Start Date</label>
            <DatePicker
              selected={dateRangeStart}
              onChange={(date: Date | null) => { setCurrentPage(1); setDateRangeStart(date); }}
              dateFormat="MM/dd/yyyy"
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
              isClearable
            />
          </div>
          <div>
            <label htmlFor="dateRangeEnd" className="block text-sm font-medium text-gray-700">End Date</label>
            <DatePicker
              selected={dateRangeEnd}
              onChange={(date: Date | null) => { setCurrentPage(1); setDateRangeEnd(date); }}
              dateFormat="MM/dd/yyyy"
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
              isClearable
            />
          </div>
          <div>
            <label htmlFor="sortBy" className="block text-sm font-medium text-gray-700">Sort By</label>
            <select
              id="sortBy"
              value={sortBy}
              onChange={(e) => { setCurrentPage(1); setSortBy(e.target.value); }}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="date">Date</option>
              <option value="amount">Amount</option>
              <option value="description">Description</option>
            </select>
          </div>
          <div>
            <label htmlFor="sortOrder" className="block text-sm font-medium text-gray-700">Sort Order</label>
            <select
              id="sortOrder"
              value={sortOrder}
              onChange={(e) => { setCurrentPage(1); setSortOrder(e.target.value as "asc" | "desc"); }}
              className="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="desc">Descending</option>
              <option value="asc">Ascending</option>
            </select>
          </div>
        </div>
      </motion.div>

      <motion.div
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="bg-white p-8 rounded-xl shadow-lg"
      >
        <div className="overflow-x-auto">
          {data?.transactions.length === 0 ? (
            <p className="text-gray-600 text-center py-10">No transactions found matching your criteria.</p>
          ) : (
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Date
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Description
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Category
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Type
                  </th>
                  <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Amount
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                  </th>
                  <th scope="col" className="relative px-6 py-3">
                    <span className="sr-only">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {data?.transactions.map((tx) => (
                  <tr key={tx.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(tx.date).toLocaleDateString()}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{tx.description}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{tx.category || 'N/A'}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                      <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tx.type === 'INCOME' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {tx.type}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-bold">
                      <span className={tx.type === 'INCOME' ? 'text-green-600' : 'text-red-600'}>
                        {tx.type === 'INCOME' ? '+' : '-'}{tx.currency}{tx.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{tx.status || 'Completed'}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <button className="text-primary-600 hover:text-primary-900">View Details</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        <div className="mt-6 flex justify-between items-center">
          <button
            onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
            disabled={currentPage === 1}
            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-gray-700">Page {currentPage} of {totalPages}</span>
          <button
            onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
            disabled={currentPage === totalPages}
            className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </motion.div>
    </div>
  );
};

const ReportsPageComponent: React.FC = () => {
  const [reportType, setReportType] = useState('monthly-summary');
  const [reportDate, setReportDate] = useState<Date | null>(new Date());
  const [reportContent, setReportContent] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);

  const generateReport = async () => {
    setIsGenerating(true);
    setReportContent('');
    toast.loading("Generating comprehensive report with Gemini AI...", { id: 'report-gen' });
    try {
      if (!config.GEMINI_API_KEY) {
        throw new Error("Gemini API key is not configured.");
      }
      const prompt = `Generate a comprehensive financial report summary for a business for the chosen report type.
        Report Type: ${reportType}.
        Period: ${reportDate?.toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) || 'N/A'}.
        Include key financial metrics (income, expenses, profit, cash flow, budget adherence, outstanding receivables/payables).
        Provide a detailed analysis of trends, identify any anomalies, and offer actionable insights or recommendations for financial optimization.
        The report should be structured professionally with clear headings and bullet points. Use markdown for formatting, including bold text for emphasis.`;

      const aiResponse = await apiService.gemini.analyzeText(prompt);
      setReportContent(aiResponse);
      toast.success("Financial report generated successfully!", { id: 'report-gen' });
    } catch (error) {
      toast.error(`Failed to generate report: ${error instanceof Error ? error.message : String(error)}`, { id: 'report-gen' });
      setReportContent(`Error generating report: ${error instanceof Error ? error.message : String(error)}`);
    } finally {
      setIsGenerating(false);
    }
  };

  const exportToPdf = () => {
    const element = document.getElementById('report-output');
    if (element) {
      toast.loading("Exporting report to PDF...", { id: 'pdf-export' });
      html2pdf().from(element).save(`${reportType}-report-${new Date().toISOString().slice(0, 10)}.pdf`)
        .then(() => toast.success("Report exported to PDF successfully!", { id: 'pdf-export' }))
        .catch((err) => toast.error(`PDF export failed: ${err.message}`, { id: 'pdf-export' }));
    } else {
      toast.error("Report content not found to export.");
    }
  };

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Financial Reports</h1>

      <motion.div
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.1 }}
        className="bg-white p-8 rounded-xl shadow-lg mb-8"
      >
        <h2 className="text-2xl font-bold text-gray-800 mb-6">Generate New Report</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
          <div>
            <label htmlFor="reportType" className="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
            <select
              id="reportType"
              value={reportType}
              onChange={(e) => setReportType(e.target.value)}
              className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="monthly-summary">Monthly Summary</option>
              <option value="cash-flow-analysis">Cash Flow Analysis</option>
              <option value="expense-breakdown">Expense Breakdown</option>
              <option value="profit-loss">Profit & Loss Statement</option>
              <option value="tax-preparation">Tax Preparation Overview</option>
              <option value="fraud-risk">Fraud Risk Assessment</option>
            </select>
          </div>
          <div>
            <label htmlFor="reportDate" className="block text-sm font-medium text-gray-700 mb-2">Report Period (Month/Year)</label>
            <DatePicker
              selected={reportDate}
              onChange={(date: Date | null) => setReportDate(date)}
              dateFormat="MM/yyyy"
              showMonthYearPicker
              className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
              aria-label="Select report month and year"
            />
          </div>
          <div className="flex items-end">
            <button
              onClick={generateReport}
              disabled={isGenerating || !config.GEMINI_API_KEY}
              className="w-full bg-primary-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
            >
              {isGenerating ? (
                <i className="fas fa-spinner animate-spin mr-2"></i>
              ) : (
                <i className="fas fa-magic mr-2"></i>
              )}
              {isGenerating ? 'Generating...' : 'Generate Report (AI Powered)'}
            </button>
          </div>
        </div>
        {!config.GEMINI_API_KEY && (
          <p className="mt-4 text-sm text-red-600"><i className="fas fa-exclamation-triangle mr-2"></i>Gemini AI is not configured. Please set REACT_APP_GEMINI_API_KEY in your environment.</p>
        )}
      </motion.div>

      {reportContent && (
        <motion.div
          initial={{ y: -20, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="bg-white p-8 rounded-xl shadow-lg mt-8"
        >
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800">Generated Report: {reportType}</h2>
            <button
              onClick={exportToPdf}
              className="bg-green-600 text-white py-2.5 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors flex items-center"
            >
              <i className="fas fa-file-pdf mr-2"></i> Export to PDF
            </button>
          </div>
          <div id="report-output" className="prose max-w-none p-4 border border-gray-200 rounded-md bg-gray-50 overflow-auto h-96 custom-scrollbar">
            {/* For a real app, use a markdown renderer like 'react-markdown' to render the content securely */}
            <div dangerouslySetInnerHTML={{ __html: reportContent.replace(/\n/g, '<br/>') }} />
          </div>
          <p className="mt-4 text-sm text-gray-500 italic">
            This report is AI-generated and should be reviewed by a human financial expert before making critical decisions.
          </p>
        </motion.div>
      )}

    </div>
  );
};

const AiAssistantPageComponent: React.FC = () => {
  const [query, setQuery] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [chatHistory, setChatHistory] = useState<{ type: 'user' | 'ai', text: string }[]>([]);
  const chatEndRef = React.useRef<HTMLDivElement>(null);

  const handleQuery = async () => {
    if (!query.trim()) return;
    setIsLoading(true);
    const userQuery = query.trim();
    setChatHistory(prev => [...prev, { type: 'user', text: userQuery }]);
    setQuery('');

    try {
      const aiResponse = await apiService.gemini.analyzeText(userQuery);
      setChatHistory(prev => [...prev, { type: 'ai', text: aiResponse }]);
      toast.success("AI assistant responded!");
    } catch (error) {
      const errorMessage = `Failed to get AI response: ${error instanceof Error ? error.message : String(error)}`;
      toast.error(errorMessage);
      setChatHistory(prev => [...prev, { type: 'ai', text: errorMessage }]);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatHistory]);

  return (
    <div className="p-8 bg-gray-100 min-h-screen flex flex-col">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Gemini AI Assistant</h1>

      <motion.div
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.1 }}
        className="flex-grow bg-white p-8 rounded-xl shadow-lg flex flex-col"
      >
        <h2 className="text-2xl font-bold text-gray-800 mb-6">Your Personal Financial AI Advisor</h2>
        {!config.GEMINI_API_KEY && (
          <p className="mt-2 text-sm text-red-600"><i className="fas fa-exclamation-triangle mr-2"></i>Gemini AI is not configured. Please set REACT_APP_GEMINI_API_KEY in your environment.</p>
        )}

        <div className="flex-grow overflow-y-auto mb-6 p-4 border border-gray-200 rounded-md bg-gray-50 space-y-4 custom-scrollbar">
          {chatHistory.length === 0 ? (
            <p className="text-gray-500 italic text-center py-10">Start a conversation with your AI financial advisor. Ask anything from spending analysis to market trends.</p>
          ) : (
            chatHistory.map((msg, index) => (
              <motion.div
                key={index}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.2 }}
                className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div className={`max-w-xl p-4 rounded-lg shadow-md ${msg.type === 'user' ? 'bg-primary-100 text-primary-800' : 'bg-gray-200 text-gray-800'}`}>
                  <p className="font-semibold text-sm mb-1">{msg.type === 'user' ? 'You' : 'AI Assistant'}</p>
                  <p className="whitespace-pre-wrap">{msg.text}</p>
                </div>
              </motion.div>
            ))
          )}
          <div ref={chatEndRef} />
        </div>

        <div className="flex space-x-4">
          <textarea
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            onKeyPress={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleQuery(); } }}
            placeholder="e.g., 'Summarize my spending last month.' or 'What are the current market trends affecting small businesses?'"
            rows={3}
            className="flex-grow p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 resize-none"
            disabled={isLoading || !config.GEMINI_API_KEY}
            aria-label="AI assistant query input"
          ></textarea>
          <button
            onClick={handleQuery}
            disabled={isLoading || !query.trim() || !config.GEMINI_API_KEY}
            className="w-32 bg-primary-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
          >
            {isLoading ? (
              <i className="fas fa-spinner animate-spin"></i>
            ) : (
              <i className="fas fa-paper-plane"></i>
            )}
            <span className="ml-2">{isLoading ? 'Sending...' : 'Ask AI'}</span>
          </button>
        </div>
      </motion.div>
    </div>
  );
};

const AdminPageComponent: React.FC = () => {
  const { user } = useAuth();
  if (user?.role !== 'admin') {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-red-100 text-red-800 p-8 text-center">
        <h1 className="text-4xl font-bold mb-4">Access Denied!</h1>
        <p className="text-lg">You do not have administrative privileges to access this page.</p>
        <Link to="/dashboard" className="mt-6 px-6 py-3 bg-red-700 text-white rounded-lg hover:bg-red-800 transition-colors flex items-center">
          <i className="fas fa-tachometer-alt mr-2"></i> Go to Dashboard
        </Link>
      </div>
    );
  }

  const [activeTab, setActiveTab] = useState('users');

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Admin Dashboard</h1>

      <div className="bg-white p-8 rounded-xl shadow-lg">
        <div className="border-b border-gray-200 mb-6">
          <nav className="-mb-px flex space-x-8" aria-label="Tabs">
            <button
              onClick={() => setActiveTab('users')}
              className={`${activeTab === 'users' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-users mr-2"></i> User Management
            </button>
            <button
              onClick={() => setActiveTab('integrations')}
              className={`${activeTab === 'integrations' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-plug mr-2"></i> Integrations
            </button>
            <button
              onClick={() => setActiveTab('settings')}
              className={`${activeTab === 'settings' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-cogs mr-2"></i> System Settings
            </button>
            <button
              onClick={() => setActiveTab('audit-logs')}
              className={`${activeTab === 'audit-logs' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-history mr-2"></i> Audit Logs
            </button>
          </nav>
        </div>

        <div>
          {activeTab === 'users' && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
              <h3 className="text-xl font-bold text-gray-800 mb-4">User Management</h3>
              <p className="text-gray-600 mb-4">Manage user roles, permissions, and access controls for all platform users.</p>
              {/* TODO: Implement a full User table with GraphQL queries/mutations for CRUD operations */}
              <div className="border border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 min-h-[200px] flex items-center justify-center">
                <div>
                  <i className="fas fa-table text-4xl mb-3"></i>
                  <p>Detailed user list and management interface to be implemented here (e.g., inviting new users, changing roles, deactivating accounts).</p>
                </div>
              </div>
              <button className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center">
                <i className="fas fa-user-plus mr-2"></i> Add New User
              </button>
            </motion.div>
          )}
          {activeTab === 'integrations' && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
              <h3 className="text-xl font-bold text-gray-800 mb-4">External Service Integrations ({Object.keys(config).filter(key => key.includes('_KEY') || key.includes('_ID') || key.includes('_TOKEN') || key.includes('_SECRET') || key.includes('_URL') || key.includes('_DSN') || key.includes('_SID') || key.includes('_DOMAIN')).length} Configs)</h3>
              <p className="text-gray-600 mb-4">Manage API keys, tokens, and connection status for over 70 third-party services integrated with this platform.
                These are loaded via environment variables for maximum security.</p>
              <div className="space-y-4 max-h-[500px] overflow-y-auto custom-scrollbar p-2">
                {Object.entries(config).map(([key, value]) => {
                  // Filter for keys that typically represent secrets or configuration identifiers
                  if (!key.includes('_KEY') && !key.includes('_ID') && !key.includes('_TOKEN') && !key.includes('_SECRET') && !key.includes('_URL') && !key.includes('_DSN') && !key.includes('_SID') && !key.includes('_DOMAIN')) {
                    return null;
                  }
                  const isConfigured = !!value; // Check if the environment variable has a value
                  return (
                    <div key={key} className="flex items-center justify-between p-3 border border-gray-200 rounded-md shadow-sm bg-gray-50">
                      <div className="flex items-center">
                        <span className={`h-3 w-3 rounded-full mr-3 ${isConfigured ? 'bg-green-500' : 'bg-red-500'}`}></span>
                        <span className="font-medium text-gray-700">{key.replace(/_/g, ' ').replace('REACT APP', '').trim()}</span>
                      </div>
                      <span className={`text-sm ${isConfigured ? 'text-green-600' : 'text-red-600'}`}>
                        {isConfigured ? 'Configured' : 'Missing'}
                      </span>
                      <button className="text-primary-600 hover:text-primary-800 text-sm">Edit</button>
                    </div>
                  );
                })}
              </div>
              <p className="mt-4 text-sm text-gray-500 italic">
                Note: Direct editing of these values from the UI would require a secure backend API. This view shows their status.
              </p>
            </motion.div>
          )}
          {activeTab === 'settings' && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
              <h3 className="text-xl font-bold text-gray-800 mb-4">System Settings</h3>
              <p className="text-gray-600 mb-4">Configure global application settings, themes, locale, and performance parameters.</p>
              {/* TODO: Implement general app settings forms */}
              <div className="border border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 min-h-[200px] flex items-center justify-center">
                <div>
                  <i className="fas fa-sliders-h text-4xl mb-3"></i>
                  <p>Global application settings, feature toggles, data retention policies, and more.</p>
                </div>
              </div>
              <p className="mt-4 text-sm text-gray-500">App Version: <span className="font-semibold">{config.APP_VERSION}</span></p>
            </motion.div>
          )}
          {activeTab === 'audit-logs' && (
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
              <h3 className="text-xl font-bold text-gray-800 mb-4">Audit Logs</h3>
              <p className="text-gray-600 mb-4">Review all significant user and system actions for compliance and security monitoring. Integrates with Datadog/Splunk.</p>
              {/* TODO: Implement audit log viewer with filters and search */}
              <div className="border border-dashed border-gray-300 rounded-lg p-6 text-center text-gray-500 min-h-[200px] flex items-center justify-center">
                <div>
                  <i className="fas fa-clipboard-list text-4xl mb-3"></i>
                  <p>A searchable, filterable log of all critical events, user activities, and system changes.</p>
                </div>
              </div>
              <Link to="/integrations/datadog" className="mt-4 inline-block text-primary-600 hover:text-primary-800 font-medium">
                Configure Datadog <i className="fas fa-external-link-alt ml-1"></i>
              </Link>
            </motion.div>
          )}
        </div>
      </div>
    </div>
  );
};

const SettingsPageComponent: React.FC = () => {
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState('profile');

  // Placeholder for user settings mutations
  const UPDATE_USER_PROFILE_MUTATION = gql`
    mutation UpdateUserProfile($input: UpdateUserInput!) {
      updateUser(input: $input) {
        id
        name
        email
      }
    }
  `;
  const [updateUserProfile, { loading: updatingProfile }] = useMutation(UPDATE_USER_PROFILE_MUTATION);

  const { register, handleSubmit, control, formState: { errors, isSubmitting }, reset } = useForm({
    defaultValues: {
      name: user?.name || '',
      email: user?.email || '',
      // Add other profile fields here
    }
  });

  useEffect(() => {
    reset({ name: user?.name || '', email: user?.email || '' });
  }, [user, reset]);

  const onSubmitProfile = async (data: any) => {
    try {
      await toast.promise(
        updateUserProfile({ variables: { input: { id: user?.id, ...data } } }),
        {
          loading: 'Updating profile...',
          success: 'Profile updated successfully!',
          error: (err) => `Failed to update profile: ${err.message}`,
        }
      );
      // Potentially refresh user context or refetch user data
    } catch (e) {
      // Error handled by toast.promise
    }
  };

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">User Settings</h1>

      <div className="bg-white p-8 rounded-xl shadow-lg">
        <div className="border-b border-gray-200 mb-6">
          <nav className="-mb-px flex space-x-8" aria-label="Tabs">
            <button
              onClick={() => setActiveTab('profile')}
              className={`${activeTab === 'profile' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-user-circle mr-2"></i> My Profile
            </button>
            <button
              onClick={() => setActiveTab('security')}
              className={`${activeTab === 'security' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-shield-alt mr-2"></i> Security
            </button>
            <button
              onClick={() => setActiveTab('notifications')}
              className={`${activeTab === 'notifications' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              <i className="fas fa-bell mr-2"></i> Notifications
            </button>
          </nav>
        </div>

        {activeTab === 'profile' && (
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
            <h3 className="text-xl font-bold text-gray-800 mb-4">Edit Profile Information</h3>
            <form onSubmit={handleSubmit(onSubmitProfile)} className="space-y-6 max-w-lg">
              <div>
                <label htmlFor="name" className="block text-sm font-medium text-gray-700">Full Name</label>
                <input
                  id="name"
                  {...register("name")}
                  className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
                />
                {errors.name && <p className="mt-1 text-sm text-red-600">{errors.name.message}</p>}
              </div>
              <div>
                <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email Address</label>
                <input
                  id="email"
                  type="email"
                  {...register("email")}
                  className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 bg-gray-50"
                  disabled // Email often managed by Auth0
                />
                <p className="mt-1 text-sm text-gray-500">Email address usually managed via your identity provider (e.g., Auth0).</p>
              </div>
              <button
                type="submit"
                disabled={isSubmitting || updatingProfile}
                className="w-full bg-primary-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
              >
                {isSubmitting || updatingProfile ? <i className="fas fa-spinner animate-spin mr-2"></i> : null}
                {isSubmitting || updatingProfile ? 'Saving...' : 'Save Profile'}
              </button>
            </form>
          </motion.div>
        )}

        {activeTab === 'security' && (
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
            <h3 className="text-xl font-bold text-gray-800 mb-4">Security Settings</h3>
            <div className="space-y-6">
              <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 className="font-semibold text-lg mb-2">Password Management</h4>
                <p className="text-gray-600 mb-3">Your password is managed securely by our authentication provider (Auth0).</p>
                <button className="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                  Change Password (External Link)
                </button>
              </div>
              <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 className="font-semibold text-lg mb-2">Two-Factor Authentication (2FA)</h4>
                <p className="text-gray-600 mb-3">Enhance your account security with 2FA.</p>
                <button className="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                  Enable 2FA
                </button>
              </div>
              <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 className="font-semibold text-lg mb-2">Session Management</h4>
                <p className="text-gray-600 mb-3">Review and manage active login sessions.</p>
                <button className="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                  Logout All Devices
                </button>
              </div>
            </div>
          </motion.div>
        )}

        {activeTab === 'notifications' && (
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
            <h3 className="text-xl font-bold text-gray-800 mb-4">Notification Preferences</h3>
            <p className="text-gray-600 mb-4">Manage how you receive alerts and updates from {config.APP_NAME}.</p>
            <div className="space-y-4">
              <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div>
                  <label htmlFor="emailNotifications" className="font-semibold text-lg text-gray-800">Email Notifications</label>
                  <p className="text-sm text-gray-600">Receive critical alerts and reports via email.</p>
                </div>
                <input type="checkbox" id="emailNotifications" className="h-6 w-6 text-primary-600 rounded focus:ring-primary-500" defaultChecked />
              </div>
              <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div>
                  <label htmlFor="pushNotifications" className="font-semibold text-lg text-gray-800">Push Notifications</label>
                  <p className="text-sm text-gray-600">Get instant updates on your browser or mobile device.</p>
                </div>
                <input type="checkbox" id="pushNotifications" className="h-6 w-6 text-primary-600 rounded focus:ring-primary-500" />
              </div>
              <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div>
                  <label htmlFor="smsNotifications" className="font-semibold text-lg text-gray-800">SMS Notifications</label>
                  <p className="text-sm text-gray-600">Receive urgent security alerts via SMS (Twilio enabled).</p>
                </div>
                <input type="checkbox" id="smsNotifications" className="h-6 w-6 text-primary-600 rounded focus:ring-primary-500" />
              </div>
            </div>
            <button className="mt-6 bg-primary-600 text-white py-2.5 px-5 rounded-lg shadow-md hover:bg-primary-700 transition-colors flex items-center">
              <i className="fas fa-save mr-2"></i> Save Notification Settings
            </button>
          </motion.div>
        )}
      </div>
    </div>
  );
};


const HelpSupportPageComponent: React.FC = () => {
  const [subject, setSubject] = useState('');
  const [message, setMessage] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmitSupport = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!subject.trim() || !message.trim()) {
      toast.error("Please fill in both subject and message.");
      return;
    }
    setIsSubmitting(true);
    toast.loading("Sending support request...", { id: 'support-request' });
    try {
      if (!config.SENDGRID_API_KEY) {
        throw new Error("SendGrid is not configured, cannot send email.");
      }
      // Simulate sending email via SendGrid (in a real app, this would be a backend API call)
      await apiService.sendGrid.sendEmail("support@citibank.com", `Support Request: ${subject}`, message);
      toast.success("Your support request has been sent. We'll get back to you shortly!", { id: 'support-request' });
      setSubject('');
      setMessage('');
    } catch (error) {
      toast.error(`Failed to send support request: ${error instanceof Error ? error.message : String(error)}`, { id: 'support-request' });
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="p-8 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-extrabold text-gray-900 mb-8">Help & Support</h1>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <motion.div
          initial={{ x: -20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.1 }}
          className="bg-white p-8 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Contact Support</h2>
          <p className="text-gray-600 mb-4">
            Have a question or need assistance? Fill out the form below and our dedicated support team will get back to you.
          </p>
          <form onSubmit={handleSubmitSupport} className="space-y-6">
            <div>
              <label htmlFor="supportSubject" className="block text-sm font-medium text-gray-700">Subject</label>
              <input
                type="text"
                id="supportSubject"
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500"
                placeholder="e.g., Payment issue, Account verification"
                disabled={isSubmitting}
              />
            </div>
            <div>
              <label htmlFor="supportMessage" className="block text-sm font-medium text-gray-700">Message</label>
              <textarea
                id="supportMessage"
                value={message}
                onChange={(e) => setMessage(e.target.value)}
                rows={6}
                className="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 resize-y"
                placeholder="Describe your issue or question in detail..."
                disabled={isSubmitting}
              ></textarea>
            </div>
            <button
              type="submit"
              disabled={isSubmitting || !config.SENDGRID_API_KEY}
              className="w-full bg-primary-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
            >
              {isSubmitting ? (
                <i className="fas fa-spinner animate-spin mr-2"></i>
              ) : (
                <i className="fas fa-paper-plane mr-2"></i>
              )}
              {isSubmitting ? 'Sending...' : 'Send Request'}
            </button>
            {!config.SENDGRID_API_KEY && (
              <p className="mt-4 text-sm text-red-600"><i className="fas fa-exclamation-triangle mr-2"></i>Email service (SendGrid) is not configured. Support emails cannot be sent.</p>
            )}
          </form>
        </motion.div>

        <motion.div
          initial={{ x: 20, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="bg-white p-8 rounded-xl shadow-lg"
        >
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Resources & FAQs</h2>
          <div className="space-y-4">
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
              <h3 className="font-semibold text-lg text-gray-800 mb-1">Frequently Asked Questions</h3>
              <p className="text-gray-600">Find quick answers to common questions about payments, accounts, and features.</p>
              <a href="#" className="text-primary-600 hover:underline mt-2 inline-block">View FAQs <i className="fas fa-external-link-alt ml-1"></i></a>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
              <h3 className="font-semibold text-lg text-gray-800 mb-1">Documentation & Guides</h3>
              <p className="text-gray-600">Access comprehensive guides and technical documentation for advanced users.</p>
              <a href="#" className="text-primary-600 hover:underline mt-2 inline-block">Read Documentation <i className="fas fa-external-link-alt ml-1"></i></a>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
              <h3 className="font-semibold text-lg text-gray-800 mb-1">Video Tutorials</h3>
              <p className="text-gray-600">Watch step-by-step video tutorials to master the platform's features.</p>
              <a href="#" className="text-primary-600 hover:underline mt-2 inline-block">Watch Tutorials <i className="fas fa-external-link-alt ml-1"></i></a>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
              <h3 className="font-semibold text-lg text-gray-800 mb-1">System Status Page</h3>
              <p className="text-gray-600">Check the current operational status of all services and integrations.</p>
              <a href="#" className="text-primary-600 hover:underline mt-2 inline-block">View Status <i className="fas fa-external-link-alt ml-1"></i></a>
            </div>
          </div>
        </motion.div>
      </div>
    </div>
  );
};


const NotFoundPageComponent: React.FC<{ message?: string }> = ({ message }) => (
  <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4 text-center">
    <motion.div
      initial={{ scale: 0.8, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      transition={{ type: "spring", stiffness: 100 }}
      className="bg-white p-10 rounded-xl shadow-2xl"
    >
      <h1 className="text-6xl font-extrabold text-red-600 mb-4">404</h1>
      <h2 className="text-3xl font-bold text-gray-900 mb-4">Page Not Found</h2>
      <p className="text-lg text-gray-700 mb-6">{message || "Oops! The page you are looking for does not exist or has been moved."}</p>
      <Link
        to="/dashboard"
        className="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors inline-flex items-center"
      >
        <i className="fas fa-home mr-2"></i> Go to Dashboard
      </Link>
    </motion.div>
  </div>
);


// --- MAIN APP COMPONENT ---
function App() {
  const { isAuthenticated, loading: authLoading } = useAuth();
  const history = useHistory();
  const location = useLocation();

  useEffect(() => {
    // Redirect logic for authenticated/unauthenticated users
    if (!authLoading) {
      if (!isAuthenticated && location.pathname !== '/login') {
        history.push('/login');
      } else if (isAuthenticated && (location.pathname === '/' || location.pathname === '/login')) {
        history.push('/dashboard');
      }
    }
  }, [isAuthenticated, authLoading, history, location.pathname]);

  if (authLoading) {
    return <LoadingSpinner />;
  }

  return (
    <div className="flex min-h-screen bg-gray-50 font-sans antialiased">
      <AnimatePresence>
        {isAuthenticated && <Sidebar />}
      </AnimatePresence>
      <div className="flex-grow flex flex-col">
        {isAuthenticated && <Header />}
        <main className="flex-grow overflow-auto relative">
          <Suspense fallback={<LoadingSpinner />}>
            <Switch>
              <Route path="/login">
                <LoginPageComponent />
              </Route>
              {isAuthenticated ? (
                <>
                  <Route exact path="/dashboard">
                    <DashboardPageComponent />
                  </Route>
                  <Route exact path="/payments">
                    <PaymentsPageComponent />
                  </Route>
                  <Route path="/payments/:id">
                    <PaymentFlowDetails />
                  </Route>
                  <Route exact path="/accounts">
                    <AccountsPageComponent />
                  </Route>
                  <Route exact path="/transactions">
                    <TransactionsPageComponent />
                  </Route>
                  <Route exact path="/reports">
                    <ReportsPageComponent />
                  </Route>
                  <Route exact path="/ai-assistant">
                    <AiAssistantPageComponent />
                  </Route>
                  <Route exact path="/admin">
                    <AdminPageComponent />
                  </Route>
                  <Route exact path="/settings">
                    <SettingsPageComponent />
                  </Route>
                  <Route exact path="/help">
                    <HelpSupportPageComponent />
                  </Route>
                  <Route path="/">
                    {/* Default route for authenticated users should be dashboard */}
                    <DashboardPageComponent />
                  </Route>
                </>
              ) : (
                <Route path="/">
                  <LoginPageComponent />
                </Route>
              )}
              <Route path="*">
                <NotFoundPageComponent />
              </Route>
            </Switch>
          </Suspense>
        </main>
      </div>
    </div>
  );
}

// Wrap the entire app with necessary providers for global state, GraphQL, etc.
const RootApp: React.FC = () => (
  <ErrorBoundary>
    <ApolloProvider client={apolloClient}>
      <Router>
        <AuthProvider>
          <DndProvider backend={HTML5Backend}> {/* Included for potential future drag-and-drop dashboard customizations */}
            <App />
            {/* Global toast notifications for user feedback */}
            <Toaster position="bottom-right" reverseOrder={false} containerClassName="text-sm" toastOptions={{
              className: '',
              style: {
                padding: '12px 16px',
                borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
              },
              success: {
                iconTheme: { primary: '#4CAF50', secondary: '#fff' },
              },
              error: {
                iconTheme: { primary: '#F44336', secondary: '#fff' },
              },
            }} />
          </DndProvider>
        </AuthProvider>
      </Router>
    </ApolloProvider>
  </ErrorBoundary>
);

export default RootApp;