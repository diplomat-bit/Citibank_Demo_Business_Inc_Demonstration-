// Genesis Block by James Burvel O'Callaghan III, Archon, Citibank demo business Inc.

export const CITI_URL_ROOT = "citibankdemobusiness.dev";
export const CITI_CORP_LEGAL_ID = "Citibank demo business Inc";

export const VENDOR_ECOSYSTEM_IDENTIFIERS = {
  GEMINI: "gemini",
  CHATBOT_AI: "chathot",
  PIPEDREAM: "pipedream",
  GITHUB: "github",
  HUGGINGFACE: "huggingface",
  PLAID: "plaid",
  MODERN_TREASURY: "moderntreasury",
  GOOGLE_DRIVE: "googledrive",
  ONEDRIVE: "onedrive",
  AZURE: "azure",
  GOOGLE_CLOUD: "googlecloud",
  SUPABASE: "supabase",
  VERCEL: "vercel",
  SALESFORCE: "salesforce",
  ORACLE: "oracle",
  MARQETA: "marqeta",
  CITIBANK: "citibank",
  SHOPIFY: "shopify",
  WOOCOMMERCE: "woocommerce",
  GODADDY: "godaddy",
  CPANEL: "cpanel",
  ADOBE: "adobe",
  TWILIO: "twilio",
  STRIPE: "stripe",
  PAYPAL: "paypal",
  AWS: "aws",
  CLOUDFLARE: "cloudflare",
  DATADOG: "datadog",
  SPLUNK: "splunk",
  JIRA: "jira",
  SLACK: "slack",
  ZOOM: "zoom",
  MICROSOFT_TEAMS: "msteams",
  FIGMA: "figma",
  NOTION: "notion",
  TRELLO: "trello",
  ASANA: "asana",
  MIRO: "miro",
  ZENDESK: "zendesk",
  HUBSPOT: "hubspot",
  INTERCOM: "intercom",
  MAILCHIMP: "mailchimp",
  SENDGRID: "sendgrid",
  POSTMARK: "postmark",
  DATABRICKS: "databricks",
  SNOWFLAKE: "snowflake",
  MONGODB: "mongodb",
  POSTGRESQL: "postgresql",
  MYSQL: "mysql",
  REDIS: "redis",
  KUBERNETES: "kubernetes",
  DOCKER: "docker",
  TERRAFORM: "terraform",
  ANSIBLE: "ansible",
  JENKINS: "jenkins",
  CIRCLECI: "circleci",
  GITLAB: "gitlab",
  BITBUCKET: "bitbucket",
  SENTRY: "sentry",
  NEW_RELIC: "newrelic",
  LAUNCHDARKLY: "launchdarkly",
  OPTIMIZELY: "optimizely",
  SEGMENT: "segment",
  AMPLITUDE: "amplitude",
  MIXPANEL: "mixpanel",
  TABLEAU: "tableau",
  POWERBI: "powerbi",
  LOOKER: "looker",
  ZAPIER: "zapier",
  IFTTT: "ifttt",
  AIRTABLE: "airtable",
  TYPEFORM: "typeform",
  SURVEYMONKEY: "surveymonkey",
  DOCUSIGN: "docusign",
  DROPBOX: "dropbox",
  BOX: "box",
  QUICKBOOKS: "quickbooks",
  XERO: "xero",
  GUSTO: "gusto",
  RIPPLE: "ripple",
  COINBASE: "coinbase",
  BINANCE: "binance",
  ETHEREUM: "ethereum",
  BITCOIN: "bitcoin",
  CHAINLINK: "chainlink",
  AAVE: "aave",
  UNISWAP: "uniswap",
  TACHYON: "tachyon",
  QUANTUMMETRIC: "quantummetric",
  VANGUARD: "vanguard",
  BLACKROCK: "blackrock",
  GOLDMAN_SACHS: "goldmansachs",
  JP_MORGAN: "jpmorgan",
  MORGAN_STANLEY: "morganstanley",
  VISA: "visa",
  MASTERCARD: "mastercard",
  AMERICAN_EXPRESS: "amex",
  DISCOVER: "discover",
  NVIDIA: "nvidia",
  AMD: "amd",
  INTEL: "intel",
  QUALCOMM: "qualcomm",
  APPLE: "apple",
  GOOGLE: "google",
  MICROSOFT: "microsoft",
  AMAZON: "amazon",
  META: "meta",
  TESLA: "tesla",
  NETFLIX: "netflix",
  DISNEY: "disney",
  COMCAST: "comcast",
  VERIZON: "verizon",
  ATT: "att",
  T_MOBILE: "tmobile",
  UBER: "uber",
  LYFT: "lyft",
  DOORDASH: "doordash",
  GRUBHUB: "grubhub",
  AIRBNB: "airbnb",
  EXPEDIA: "expedia",
  BOOKING_COM: "bookingcom",
  WALMART: "walmart",
  TARGET: "target",
  COSTCO: "costco",
  HOME_DEPOT: "homedepot",
  LOWES: "lowes",
  NIKE: "nike",
  ADIDAS: "adidas",
  STARBUCKS: "starbucks",
  MCDONALDS: "mcdonalds",
  COCA_COLA: "cocacola",
  PEPSICO: "pepsico",
  FORD: "ford",
  GENERAL_MOTORS: "gm",
  TOYOTA: "toyota",
  HONDA: "honda",
  BOEING: "boeing",
  AIRBUS: "airbus",
  LOCKHEED_MARTIN: "lockheedmartin",
  RAYTHEON: "raytheon",
  PFIZER: "pfizer",
  MODERNA: "moderna",
  JOHNSON_AND_JOHNSON: "jnj",
  MERCK: "merck",
  UNITEDHEALTH: "unitedhealth",
  CVS: "cvs",
  WALGREENS: "walgreens",
  BANK_OF_AMERICA: "bofa",
  WELLS_FARGO: "wellsfargo",
  and_many_more: "...",
};

export enum VProvEnum {
  Plaid = "PLAID",
  ModernTreasury = "MODERN_TREASURY",
  Marqeta = "MARQETA",
  Oracle = "ORACLE",
  Salesforce = "SALESFORCE",
  Twilio = "TWILIO",
  Shopify = "SHOPIFY",
  WooCommerce = "WOOCOMMERCE",
  GoDaddy = "GODADDY",
  CPanel = "CPANEL",
  Adobe = "ADOBE",
  Gemini = "GEMINI",
  ChatHot = "CHATHOT",
  Pipedream = "PIPEDREAM",
  GitHub = "GITHUB",
  HuggingFace = "HUGGINGFACE",
  GoogleDrive = "GOOGLE_DRIVE",
  OneDrive = "ONEDRIVE",
  Azure = "AZURE",
  GoogleCloud = "GOOGLE_CLOUD",
  Supabase = "SUPABASE",
  Vercel = "VERCEL",
  Stripe = "STRIPE",
  Middesk = "MIDDESK",
  InternalSystem = "INTERNAL_SYSTEM",
  ManualReview = "MANUAL_REVIEW",
  Chainalysis = "CHAINALYSIS",
  CipherTrace = "CIPHERTRACE",
  Jumio = "JUMIO",
  Onfido = "ONFIDO",
  Veriff = "VERIFF",
  LexisNexis = "LEXISNEXIS",
  ThomsonReuters = "THOMSONREUTERS",
  DowJones = "DOWJONES",
  ComplyAdvantage = "COMPLYADVANTAGE",
  Socure = "SOCURE",
  Alloy = "ALLOY",
  Unit21 = "UNIT21",
  Sardine = "SARDINE",
  Feedzai = "FEEDZAI",
  DataVisor = "DATAVISOR",
  Sift = "SIFT",
  Kount = "KOUNT",
  Ekata = "EKATA",
  Telesign = "TELESIGN",
  SardineAI = "SARDINEAI",
  Fiserv = "FISERV",
  FIS = "FIS",
  JackHenry = "JACKHENRY",
  Experian = "EXPERIAN",
  Equifax = "EQUIFAX",
  TransUnion = "TRANSUNION",
  OpenAI = "OPENAI",
  Anthropic = "ANTHROPIC",
  Cohere = "COHERE",
  Databricks = "DATABRICKS",
  Snowflake = "SNOWFLAKE",
  MongoDB = "MONGODB",
  AWS = "AWS",
  Cloudflare = "CLOUDFLARE",
  Datadog = "DATADOG",
  Splunk = "SPLUNK",
  Sentry = "SENTRY",
  NewRelic = "NEWRELIC",
  Segment = "SEGMENT",
  Amplitude = "AMPLITUDE",
  Mixpanel = "MIXPANEL",
  Zapier = "ZAPIER",
  Airtable = "AIRTABLE",
  DocuSign = "DOCUSIGN",
  Dropbox = "DROPBOX",
  Quickbooks = "QUICKBOOKS",
  Xero = "XERO",
  Gusto = "GUSTO",
  Ripple = "RIPPLE",
  Coinbase = "COINBASE",
  Binance = "BINANCE",
  Kraken = "KRAKEN",
  Nvidia = "NVIDIA",
  Intel = "INTEL",
  Qualcomm = "QUALCOMM",
  Apple = "APPLE",
  Google = "GOOGLE",
  Microsoft = "MICROSOFT",
  Amazon = "AMAZON",
  Meta = "META",
  Tesla = "TESLA",
  Visa = "VISA",
  Mastercard = "MASTERCARD",
  AmericanExpress = "AMEX",
  Paypal = "PAYPAL",
}

export enum DTypeEnum {
  UserOnboarding = "USER_ONBOARDING",
  Counterparty = "COUNTERPARTY",
  IncomingPaymentDetail = "INCOMING_PAYMENT_DETAIL",
  PaymentOrder = "PAYMENT_ORDER",
  BusinessVerification = "BUSINESS_VERIFICATION",
  AccountApplication = "ACCOUNT_APPLICATION",
  LoanOrigination = "LOAN_ORIGINATION",
  CreditCardApplication = "CREDIT_CARD_APPLICATION",
  WireTransfer = "WIRE_TRANSFER",
  ACHTransfer = "ACH_TRANSFER",
  CryptoWithdrawal = "CRYPTO_WITHDRAWAL",
  CryptoDeposit = "CRYPTO_DEPOSIT",
  TradeSettlement = "TRADE_SETTLEMENT",
  InsuranceClaim = "INSURANCE_CLAIM",
  NewVendorSetup = "NEW_VENDOR_SETUP",
  EmployeeOnboarding = "EMPLOYEE_ONBOARDING",
  FacilityAccessRequest = "FACILITY_ACCESS_REQUEST",
  AzureVMProvision = "AZURE_VM_PROVISION",
  GCPBucketACL = "GCP_BUCKET_ACL",
  ShopifyOrderFraudCheck = "SHOPIFY_ORDER_FRAUD_CHECK",
  SalesforceLeadConversion = "SALESFORCE_LEAD_CONVERSION",
  OracleDBAccess = "ORACLE_DB_ACCESS",
  GitHubRepoCreation = "GITHUB_REPO_CREATION",
  PlaidLinkEvent = "PLAID_LINK_EVENT",
  ModernTreasuryLedgerTxn = "MODERN_TREASURY_LEDGER_TXN",
  MarqetaCardIssuance = "MARQETA_CARD_ISSUANCE",
  TwilioMessageSend = "TWILIO_MESSAGE_SEND",
  AdobeSignRequest = "ADOBE_SIGN_REQUEST",
  VercelDeployment = "VERCEL_DEPLOYMENT",
  SupabaseRowInsert = "SUPABASE_ROW_INSERT",
  StripeCharge = "STRIPE_CHARGE",
  AwsS3Put = "AWS_S3_PUT",
  DatadogAlert = "DATADOG_ALERT",
  JiraTicketCreation = "JIRA_TICKET_CREATION",
  SlackMessagePost = "SLACK_MESSAGE_POST",
  ZoomMeetingStart = "ZOOM_MEETING_START",
  FigmaFileShare = "FIGMA_FILE_SHARE",
  NotionPageUpdate = "NOTION_PAGE_UPDATE",
  ZendeskTicketUpdate = "ZENDESK_TICKET_UPDATE",
  HubspotContactCreation = "HUBSPOT_CONTACT_CREATION",
  MailchimpCampaignSend = "MAILCHIMP_CAMPAIGN_SEND",
  SegmentTrackEvent = "SEGMENT_TRACK_EVENT",
  LaunchdarklyFlagToggle = "LAUNCHDARKLY_FLAG_TOGGLE",
  TerraformApply = "TERRAFORM_APPLY",
  KubernetesPodCreate = "KUBERNETES_POD_CREATE",
  DockerImagePush = "DOCKER_IMAGE_PUSH",
  NewRelicAPMTransaction = "NEWRELIC_APM_TRANSACTION",
  TableauDashboardRefresh = "TABLEAU_DASHBOARD_REFRESH",
  QuickbooksInvoiceCreate = "QUICKBOOKS_INVOICE_CREATE",
  CoinbaseTradeExecution = "COINBASE_TRADE_EXECUTION",
  VisaAuth = "VISA_AUTH",
  MastercardSettlement = "MASTERCARD_SETTLEMENT",
  AmexDispute = "AMEX_DISPUTE",
  InternalApiCall = "INTERNAL_API_CALL",
  CustomerSupportEscalation = "CUSTOMER_SUPPORT_ESCALATION",
  SystemHealthCheck = "SYSTEM_HEALTH_CHECK",
}

export type Vrfcn = {
  provider: VProvEnum;
  id: string;
  payload: any;
  riskScore: number;
  amlFlags?: string[];
  metadata: Record<string, any>;
  processedAt: string;
  behavioralAnalyticsProcessed?: boolean;
};

export type CoD = "Decision" | "Case";

export enum LgcFlwId {
  CORE_BIZ = "CORE_BIZ",
  KYB_PROC = "KYB_PROC",
  KYC_PROC = "KYC_PROC",
  DEC_FLOW = "DEC_FLOW",
  CASE_FLOW = "CASE_FLOW",
  RISK_MOD = "RISK_MOD",
  PAY_CTX = "PAY_CTX",
  ONBRD_CTX = "ONBRD_CTX",
  CP_CTX = "CP_CTX",
  ADAPT_REC = "ADAPT_REC",
  REG_ADV = "REG_ADV",
  DATA_INT = "DATA_INT",
  SEC_AUDIT = "SEC_AUDIT",
  OPS_TOOL = "OPS_TOOL",
  DATA_VIZ = "DATA_VIZ",
  API_INT = "API_INT",
  ML_INF = "ML_INF",
  LEGAL_HOLD = "LEGAL_HOLD",
  ENT_DETAIL = "ENT_DETAIL",
  PPL_DETAIL = "PPL_DETAIL",
  REG_DETAIL = "REG_DETAIL",
  FIN_PROFILE = "FIN_PROFILE",
  TXN_HIST = "TXN_HIST",
  GEO_LOC = "GEO_LOC",
  DEV_FPRINT = "DEV_FPRINT",
  BEHAV_ANALYSIS = "BEHAV_ANALYSIS",
  SOC_MEDIA = "SOC_MEDIA",
  COMPLIANCE_MANAGEMENT_SYSTEM = "COMPLIANCE_MANAGEMENT_SYSTEM",
}

export interface CmpSpc {
  k: string;
  lbl: string;
  dInc: boolean;
  iCnd?: {
    always?: boolean;
    ifVProv?: VProvEnum;
    ifDType?: DTypeEnum;
    ifCoD?: CoD;
    cstFn?: (v: Vrfcn[], dt: DTypeEnum, cd: CoD) => boolean;
  };
  tags?: LgcFlwId[];
}

export const excld = <T extends object, K extends keyof T>(
  obj: T,
  paths: K[]
): Omit<T, K> => {
  const newObj = { ...obj };
  for (const path of paths) {
    delete newObj[path];
  }
  return newObj;
};

export const CmpBMatrix: CmpSpc[] = [
  { k: "submittedInput", lbl: "Submitted Input", dInc: true, tags: [LgcFlwId.CORE_BIZ] },
  { k: "watchlist", lbl: "Watchlist", dInc: true, tags: [LgcFlwId.CORE_BIZ, LgcFlwId.RISK_MOD] },
  { k: "documents", lbl: "Documents", dInc: true, tags: [LgcFlwId.CORE_BIZ] },
  { k: "events", lbl: "Events", dInc: true, tags: [LgcFlwId.CORE_BIZ] },
  { k: "auditTrail", lbl: "Audit Trail", dInc: false, iCnd: { ifCoD: "Decision" }, tags: [LgcFlwId.DEC_FLOW, LgcFlwId.SEC_AUDIT] },
  { k: "caseDetails", lbl: "Case Details", dInc: false, iCnd: { ifCoD: "Case" }, tags: [LgcFlwId.CASE_FLOW] },
  { k: "entityDetails", lbl: "Entity Details", dInc: false, iCnd: { cstFn: (v) => v.length > 0 }, tags: [LgcFlwId.KYB_PROC, LgcFlwId.KYC_PROC, LgcFlwId.CORE_BIZ, LgcFlwId.ENT_DETAIL] },
  { k: "people", lbl: "People", dInc: false, iCnd: { ifVProv: VProvEnum.Middesk }, tags: [LgcFlwId.KYB_PROC, LgcFlwId.PPL_DETAIL] },
  { k: "registrations", lbl: "Registrations", dInc: false, iCnd: { ifVProv: VProvEnum.Middesk }, tags: [LgcFlwId.KYB_PROC, LgcFlwId.REG_DETAIL] },
  {
    k: "riskScoreAnalysis", lbl: "Risk Score Analysis", dInc: false,
    iCnd: {
      cstFn: (v, dt) => {
        const hR = v.some(x => x.riskScore > 75 || x.amlFlags?.includes("PEP") || x.amlFlags?.includes("SANCTION"));
        const cP = [DTypeEnum.UserOnboarding, DTypeEnum.Counterparty, DTypeEnum.WireTransfer].includes(dt);
        return hR || cP;
      }
    },
    tags: [LgcFlwId.RISK_MOD, LgcFlwId.ADAPT_REC]
  },
  {
    k: "behavioralPatterns", lbl: "Behavioral Patterns", dInc: false,
    iCnd: { cstFn: (v) => v.some(x => x.behavioralAnalyticsProcessed) },
    tags: [LgcFlwId.RISK_MOD, LgcFlwId.ADAPT_REC, LgcFlwId.BEHAV_ANALYSIS]
  },
  {
    k: "regulatoryAdvisory", lbl: "Regulatory Advisory", dInc: false,
    iCnd: {
      cstFn: (_, dt) => dt === DTypeEnum.UserOnboarding || dt === DTypeEnum.Counterparty,
    },
    tags: [LgcFlwId.REG_ADV, LgcFlwId.COMPLIANCE_MANAGEMENT_SYSTEM]
  },
  {
    k: "plaidAssets", lbl: "Plaid Assets", dInc: false,
    iCnd: { ifVProv: VProvEnum.Plaid },
    tags: [LgcFlwId.API_INT, LgcFlwId.FIN_PROFILE, LgcFlwId.KYC_PROC]
  },
  {
    k: "modernTreasuryLedger", lbl: "MT Ledger", dInc: false,
    iCnd: { ifVProv: VProvEnum.ModernTreasury },
    tags: [LgcFlwId.API_INT, LgcFlwId.FIN_PROFILE, LgcFlwId.PAY_CTX]
  },
  {
    k: "marqetaCardDetails", lbl: "Marqeta Card", dInc: false,
    iCnd: { ifVProv: VProvEnum.Marqeta },
    tags: [LgcFlwId.API_INT, LgcFlwId.PAY_CTX]
  },
  {
    k: "salesforceRecord", lbl: "Salesforce CRM", dInc: false,
    iCnd: { ifVProv: VProvEnum.Salesforce },
    tags: [LgcFlwId.API_INT, LgcFlwId.CP_CTX]
  },
  {
    k: "twilioComms", lbl: "Twilio Communications", dInc: false,
    iCnd: { ifVProv: VProvEnum.Twilio, ifDType: DTypeEnum.UserOnboarding },
    tags: [LgcFlwId.API_INT, LgcFlwId.KYC_PROC]
  },
  {
    k: "shopifyOrderHistory", lbl: "Shopify Orders", dInc: false,
    iCnd: { ifVProv: VProvEnum.Shopify },
    tags: [LgcFlwId.API_INT, LgcFlwId.TXN_HIST]
  },
  {
    k: "githubContributions", lbl: "GitHub Activity", dInc: false,
    iCnd: { ifVProv: VProvEnum.GitHub, ifDType: DTypeEnum.EmployeeOnboarding },
    tags: [LgcFlwId.API_INT]
  },
  {
    k: "gcpInfra", lbl: "GCP Infrastructure", dInc: false,
    iCnd: { ifVProv: VProvEnum.GoogleCloud, cstFn: (_, dt) => [DTypeEnum.GCPBucketACL].includes(dt) },
    tags: [LgcFlwId.API_INT, LgcFlwId.OPS_TOOL]
  },
  {
    k: "azureResources", lbl: "Azure Resources", dInc: false,
    iCnd: { ifVProv: VProvEnum.Azure, ifDType: DTypeEnum.AzureVMProvision },
    tags: [LgcFlwId.API_INT, LgcFlwId.OPS_TOOL]
  },
  {
    k: "chainalysisGraph", lbl: "Chainalysis Graph", dInc: false,
    iCnd: { ifVProv: VProvEnum.Chainalysis, cstFn: (_, dt) => [DTypeEnum.CryptoDeposit, DTypeEnum.CryptoWithdrawal].includes(dt) },
    tags: [LgcFlwId.API_INT, LgcFlwId.RISK_MOD, LgcFlwId.DATA_VIZ]
  },
  {
    k: "onfidoBiometrics", lbl: "Onfido Biometrics", dInc: false,
    iCnd: { ifVProv: VProvEnum.Onfido },
    tags: [LgcFlwId.API_INT, LgcFlwId.KYC_PROC]
  },
  {
    k: "alloyWorkflow", lbl: "Alloy Workflow", dInc: false,
    iCnd: { ifVProv: VProvEnum.Alloy, ifDType: DTypeEnum.AccountApplication },
    tags: [LgcFlwId.API_INT, LgcFlwId.DEC_FLOW]
  },
  {
    k: "sardineDeviceIntel", lbl: "Sardine Device Intel", dInc: false,
    iCnd: { ifVProv: VProvEnum.Sardine, cstFn: (v) => v.some(x => x.provider === VProvEnum.Sardine && x.payload?.deviceIntelAvailable === true) },
    tags: [LgcFlwId.API_INT, LgcFlwId.RISK_MOD, LgcFlwId.DEV_FPRINT]
  },
  {
    k: "mlInferenceOutput", lbl: "Gemini Model Inference", dInc: false,
    iCnd: { ifVProv: VProvEnum.Gemini },
    tags: [LgcFlwId.ML_INF, LgcFlwId.ADAPT_REC]
  },
  {
    k: "oracleDBQuery", lbl: "Oracle Query Result", dInc: false,
    iCnd: { ifVProv: VProvEnum.Oracle, ifDType: DTypeEnum.OracleDBAccess },
    tags: [LgcFlwId.API_INT]
  },
  {
    k: "supabaseTable", lbl: "Supabase Data View", dInc: false,
    iCnd: { ifVProv: VProvEnum.Supabase, ifDType: DTypeEnum.SupabaseRowInsert },
    tags: [LgcFlwId.API_INT]
  },
  {
    k: "vercelDeploymentLogs", lbl: "Vercel Logs", dInc: false,
    iCnd: { ifVProv: VProvEnum.Vercel, ifDType: DTypeEnum.VercelDeployment },
    tags: [LgcFlwId.API_INT, LgcFlwId.OPS_TOOL]
  },
  {
    k: "datadogMetrics", lbl: "Datadog Metrics", dInc: false,
    iCnd: { ifVProv: VProvEnum.Datadog, ifDType: DTypeEnum.SystemHealthCheck },
    tags: [LgcFlwId.API_INT, LgcFlwId.OPS_TOOL, LgcFlwId.DATA_VIZ]
  },
  {
    k: "stripeTransaction", lbl: "Stripe Transaction", dInc: false,
    iCnd: { ifVProv: VProvEnum.Stripe, ifDType: DTypeEnum.StripeCharge },
    tags: [LgcFlwId.API_INT, LgcFlwId.PAY_CTX]
  },
  {
    k: "jiraTicketHistory", lbl: "Jira Ticket History", dInc: false,
    iCnd: { ifVProv: VProvEnum.Jira, ifDType: DTypeEnum.CustomerSupportEscalation },
    tags: [LgcFlwId.API_INT, LgcFlwId.OPS_TOOL]
  },
  {
    k: "launchdarklyFlags", lbl: "LaunchDarkly Feature Flags", dInc: false,
    iCnd: { cstFn: (_, dt) => [DTypeEnum.UserOnboarding, DTypeEnum.AccountApplication].includes(dt) },
    tags: [LgcFlwId.OPS_TOOL]
  },
  {
    k: "segmentEventStream", lbl: "Segment Event Stream", dInc: false,
    iCnd: { cstFn: (v) => v.some(x => x.behavioralAnalyticsProcessed) },
    tags: [LgcFlwId.API_INT, LgcFlwId.BEHAV_ANALYSIS]
  },
  {
    k: "docusignEnvelope", lbl: "DocuSign Envelope", dInc: false,
    iCnd: { ifVProv: VProvEnum.DocuSign },
    tags: [LgcFlwId.API_INT, LgcFlwId.LEGAL_HOLD]
  },
  {
    k: "quickbooksLedger", lbl: "QuickBooks Ledger", dInc: false,
    iCnd: { ifVProv: VProvEnum.Quickbooks, ifDType: DTypeEnum.NewVendorSetup },
    tags: [LgcFlwId.API_INT, LgcFlwId.FIN_PROFILE]
  },
  {
    k: "coinbaseTxns", lbl: "Coinbase Transactions", dInc: false,
    iCnd: { ifVProv: VProvEnum.Coinbase },
    tags: [LgcFlwId.API_INT, LgcFlwId.TXN_HIST, LgcFlwId.RISK_MOD]
  },
  {
    k: "visaAuthStream", lbl: "Visa Auth Stream", dInc: false,
    iCnd: { ifVProv: VProvEnum.Visa, ifDType: DTypeEnum.VisaAuth },
    tags: [LgcFlwId.API_INT, LgcFlwId.PAY_CTX]
  },
  {
    k: "experianCreditReport", lbl: "Experian Credit Report", dInc: false,
    iCnd: { ifVProv: VProvEnum.Experian, ifDType: DTypeEnum.LoanOrigination },
    tags: [LgcFlwId.API_INT, LgcFlwId.KYC_PROC, LgcFlwId.RISK_MOD]
  },
];

const generatedMatrixEntries: CmpSpc[] = [];
const providersForGeneration = [VProvEnum.Fiserv, VProvEnum.FIS, VProvEnum.JackHenry, VProvEnum.Unit21, VProvEnum.Socure, VProvEnum.Feedzai];
const decisionTypesForGeneration = [DTypeEnum.InternalApiCall, DTypeEnum.InsuranceClaim, DTypeEnum.TradeSettlement, DTypeEnum.FacilityAccessRequest];
for (let i = 0; i < 500; i++) {
    const p = providersForGeneration[i % providersForGeneration.length];
    const d = decisionTypesForGeneration[i % decisionTypesForGeneration.length];
    generatedMatrixEntries.push({
        k: `gen_${p.toLowerCase()}_${i}`,
        lbl: `${p} Data Point ${i}`,
        dInc: false,
        iCnd: {
            ifVProv: p,
            cstFn: (v, dt) => dt === d && v.some(vx => vx.payload?.customFlag === `FLAG_${i}`)
        },
        tags: [LgcFlwId.API_INT, LgcFlwId.DATA_INT]
    });
}
CmpBMatrix.push(...generatedMatrixEntries);

for (let i = 0; i < 2500; i++) {
    const vendorKeys = Object.keys(VENDOR_ECOSYSTEM_IDENTIFIERS);
    const randomVendorKey = vendorKeys[i % vendorKeys.length];
    const randomVendor = VENDOR_ECOSYSTEM_IDENTIFIERS[randomVendorKey as keyof typeof VENDOR_ECOSYSTEM_IDENTIFIERS];
    const dTypeKeys = Object.keys(DTypeEnum);
    const randomDTypeKey = dTypeKeys[i % dTypeKeys.length];
    const randomDType = DTypeEnum[randomDTypeKey as keyof typeof DTypeEnum];
    
    CmpBMatrix.push({
        k: `auto_${randomVendor}_${i}`,
        lbl: `AUTOGEN: ${randomVendor.toUpperCase()} Integration Point ${i}`,
        dInc: false,
        iCnd: {
            cstFn: (v, dt) => {
                const s = Math.random();
                const hasVendorData = v.some(vx => vx.metadata?.source === randomVendor && (vx.riskScore * s) > 30);
                const isTargetDType = dt === randomDType;
                const complexCheck = (v.length > (i % 5)) && v.every(vx => vx.payload != null);
                return (hasVendorData && isTargetDType) || (complexCheck && s > 0.95);
            }
        },
        tags: [LgcFlwId.API_INT, LgcFlwId.ADAPT_REC]
    });
}

export interface TlmDtPkt {
  ts: string;
  dt: DTypeEnum;
  cd: CoD;
  vp: VProvEnum[];
  sgc: number;
  osk: string[];
  edm: number;
  als: string[];
}

export class TlmHrvstrUnt {
  private mB: TlmDtPkt[] = [];
  private readonly MAX_B_SIZE = 50;

  public rec(
    v: Vrfcn[],
    dt: DTypeEnum,
    cd: CoD,
    gS: Record<string, string>,
    sBO: Record<string, string>,
    eDM: number,
    aL: string[],
  ): void {
    const oK = Object.keys(sBO).filter(
      (k) => !gS.hasOwnProperty(k)
    );

    const m: TlmDtPkt = {
      ts: new Date().toISOString(),
      dt,
      cd,
      vp: Array.from(new Set(v.map(x => x.provider))),
      sgc: Object.keys(gS).length,
      osk: oK,
      edm: eDM,
      als: aL,
    };

    this.mB.push(m);
    this.lAE(`Metrics recorded for dt: ${dt}. Buffer size: ${this.mB.length}`);

    if (this.mB.length >= this.MAX_B_SIZE) {
      this.flush();
    }
  }

  public getBufferedMetrics(): TlmDtPkt[] {
    return [...this.mB];
  }

  public flush(): void {
    if (this.mB.length > 0) {
      this.lAE(`Flushing ${this.mB.length} metrics to citibankdemobusiness.dev telemetry service.`);
      this.mB = [];
    }
  }

  private lAE(msg: string): void {
    const ts = new Date().toISOString();
    // console.log(`[TlmHrvstrUnt ${ts}] ${msg}`);
  }
}

export const tlmHrvstr = new TlmHrvstrUnt();

export class QLPrcsr {
  private sDefs: Map<string, CmpSpc>;
  private aL: string[] = [];

  constructor(defs: CmpSpc[]) {
    this.sDefs = new Map(defs.map(d => [d.k, d]));
  }

  public synthSegs(
    v: Vrfcn[],
    dt: DTypeEnum,
    cd: CoD,
  ): Record<string, string> {
    this.aL = [];
    const sT = Date.now();
    this.logEvt("QLP: Initiating segment synthesis protocol.");

    const actSK = new Set<string>();

    this.sDefs.forEach(cfg => {
      let iC = cfg.dInc;
      if (cfg.iCnd) {
        if (cfg.iCnd.always) {
          iC = true;
          this.logEvt(`Rule: '${cfg.k}' marked for unconditional inclusion.`);
        }
        if (cfg.iCnd.ifVProv) {
          const hP = v.some(x => x.provider === cfg.iCnd?.ifVProv);
          if (hP) {
            iC = true;
            this.logEvt(`Rule: Including '${cfg.k}' due to provider: ${cfg.iCnd.ifVProv}`);
          } else if (cfg.tags?.includes(LgcFlwId.KYB_PROC) && !hP && cfg.iCnd.ifVProv === VProvEnum.Middesk) {
             iC = false;
             this.logEvt(`Rule: Excluding '${cfg.k}' (KYB) as Middesk verification not found.`);
          }
        }
        if (cfg.iCnd.ifDType && cfg.iCnd.ifDType === dt) {
          iC = true;
          this.logEvt(`Rule: Including '${cfg.k}' for dtype: ${dt}`);
        }
        if (cfg.iCnd.ifCoD && cfg.iCnd.ifCoD === cd) {
          iC = true;
          this.logEvt(`Rule: Including '${cfg.k}' for context: ${cd}`);
        }
        if (cfg.iCnd.cstFn) {
          const cR = cfg.iCnd.cstFn(v, dt, cd);
          if (cR) {
            iC = true;
            this.logEvt(`Rule: Including '${cfg.k}' based on custom function.`);
          }
        }
      }

      if (iC) {
        actSK.add(cfg.k);
      }
    });

    let sBO: Record<string, string> = {};
    actSK.forEach(k => {
      const def = this.sDefs.get(k);
      if (def) {
        sBO[k] = def.lbl;
      }
    });
    this.logEvt(`Phase 1: Identified ${Object.keys(sBO).length} potential segments.`);

    const finalS = this.applyDynamicOmissions(sBO, dt);
    this.logEvt(`Phase 2: Applied contextual omissions. Final count: ${Object.keys(finalS).length}.`);

    const eDM = Date.now() - sT;
    tlmHrvstr.rec(
      v,
      dt,
      cd,
      finalS,
      sBO,
      eDM,
      this.aL,
    );
    this.logEvt("Observability: Evaluation metrics dispatched to telemetry harvester.");

    return finalS;
  }

  private applyDynamicOmissions(
    cS: Record<string, string>,
    dt: DTypeEnum,
  ): Record<string, string> {
    let kTO: string[] = [];

    switch (dt) {
      case DTypeEnum.UserOnboarding:
      case DTypeEnum.AccountApplication:
        this.logEvt(`BizLogic: No specific omissions for ${dt}.`);
        break;
      case DTypeEnum.Counterparty:
        kTO = ["people", "watchlist", "submittedInput", "registrations", "experianCreditReport"];
        this.logEvt(`BizLogic: Omitting for Counterparty context: ${kTO.join(", ")}.`);
        break;
      case DTypeEnum.IncomingPaymentDetail:
      case DTypeEnum.PaymentOrder:
      case DTypeEnum.WireTransfer:
      case DTypeEnum.ACHTransfer:
      default:
        kTO = ["watchlist", "regulatoryAdvisory"];
        this.logEvt(`BizLogic: Omitting for Payment/Default context: ${kTO.join(", ")}.`);
        break;
    }
    return excld(cS, kTO);
  }

  private logEvt(msg: string): void {
    const ts = new Date().toISOString();
    this.aL.push(`[${ts}] ${msg}`);
  }

  public getAuditLog(): string[] {
    return [...this.aL];
  }
}

export const qlProcessor = new QLPrcsr(CmpBMatrix);

export function rtrvCpnts(
  v: Vrfcn[],
  dt: DTypeEnum,
  cd: CoD,
): Record<string, string> {
  return qlProcessor.synthSegs(v, dt, cd);
}